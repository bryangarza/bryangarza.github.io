<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>Clojure Cookbook</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Clojure Cookbook</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph"><p>The primary goal of this book is to provide mid-length examples of
Clojure code that go beyond the basics, with a focus on real-world,
everyday applications (as opposed to more conceptual or academic
issues).</p></div>
<div class="paragraph"><p>Unlike many of the other books on Clojure written to date, the
organizing theme of this book is not the language itself, or its
features and capabilities. Instead, it focuses on specific <em>tasks</em>
that developers face (regardless of what language they&#8217;re using) and
shows an example of how to use Clojure to solve each of those specific
problems.</p></div>
<div class="paragraph"><p>As such, this book is not and cannot be truly comprehensive; there are
infinite possible example problems. However, we do hope we&#8217;ve
documented some of the more common ones that most programmers
encounter frequently, and that by induction readers will be able to
learn some common patterns, approaches, and techniques that will serve
them well as they design solutions for their own unique problems.</p></div>
<div class="sect2">
<h3 id="_how_this_book_was_written">How This Book Was Written</h3>
<div class="paragraph"><p>An important thing you should understand about this book is
that it is, first and foremost, a group effort. It is not authored by
one or two people. It isn&#8217;t even the work of a single, well-defined
group. Instead, it is the collaborative product of more than 60 of the
best Clojurists from all over the world, from all backgrounds. These
authors use Clojure every day on real applications, ranging from
aerospace to social media, banking to robotics, AI research to
e-commerce.</p></div>
<div class="paragraph"><p>As such, you will see a lot of diversity in the recipes
presented. Some are quick and to the point.  Others are more deliberate, presenting digestible yet
penetrating insights into the philosophy and implementation of certain
aspects of Clojure.</p></div>
<div class="paragraph"><p>We hope that there is something in this book for readers of diverse
interests. We believe that it will be useful not only as a reference
for looking up solutions to specific problems, but also as a worthwhile survey of the
variety and expressivity that Clojure is capable of. As we edited
submissions, we were astonished by the number of concepts and
techniques that were new to us, and will hopefully be new to our
readers as well.</p></div>
<div class="paragraph"><p>Something else that we discovered while writing and editing was how
difficult it was to draw a circumference around what we wanted to
cover. Every single recipe is a beautiful, endless fractal, touching
multiple topics, each of which deserves a recipe, a chapter, or a book
of its own. But each recipe also needs to stand on its own. Each one
should provide some useful nugget of information that readers can
understand and take away with them.</p></div>
<div class="paragraph"><p>We sincerely hope that we have balanced these goals appropriately, and
that you find this book useful without being tedious, and insightful
without being pedantic.</p></div>
</div>
<div class="sect2">
<h3 id="_audience">Audience</h3>
<div class="paragraph"><p>Anyone who uses Clojure will, we hope, be able to get something out of
this book. There are a lot of recipes on truly basic things that
beginners will find useful, but there are also many recipes on
more specialized topics that advanced users should find useful for
getting a head start on implementation.</p></div>
<div class="paragraph"><p>That said, if you&#8217;re completely new to Clojure, this probably isn&#8217;t
the book to start with&#8212;at least, not by itself. It covers a great
many useful topics, but not as methodically or as thoroughly as a good
introductory text. See the following section for a list
of general Clojure books you may find useful as prior or supplemental
texts.</p></div>
</div>
<div class="sect2">
<h3 id="_other_resources">Other Resources</h3>
<div class="paragraph"><p>One thing that this book is not, and could never be, is
complete. There is too much to cover, and by presenting information in
a task-oriented recipe format we have inherently precluded ourselves
from methodical, narrative explanation of the features and
capabilities of the whole language.</p></div>
<div class="paragraph"><p>For a more linear, thorough explanation of Clojure and its features,
we recommend one of the following books:</p></div>
<div class="ulist"><ul>
<li>
<p>
<emphasis><ulink role="orm:hideurl" url="http://shop.oreilly.com/product/0636920013754.do">Clojure Programming</ulink></emphasis> (O&#8217;Reilly, 2012), by Chas Emerick, Brian Carper,
  and Christophe Grand. A good, comprehensive, general-purpose Clojure
  book focusing on the language and common tasks, oriented toward
  beginner Clojure programmers.
</p>
</li>
<li>
<p>
<em>Programming Clojure</em>, 2nd ed. (Pragmatic Bookshelf, 2012), by Stuart
  Halloway and Aaron Bedra. The first book on Clojure, this is a
  clear, comprehensive introductory tutorial on the Clojure language.
</p>
</li>
<li>
<p>
<em>Practical Clojure</em> (Apress, 2010), by Luke VanderHart and Stuart
  Sierra. This is a terse, no-nonsense explanation of what Clojure is
  and what its features do.
</p>
</li>
<li>
<p>
<em>The Joy of Clojure</em> (Manning, 2011), by Michael Fogus and Chris
  Houser. This is a slightly more advanced text that really digs into the
  themes and philosophies of Clojure.
</p>
</li>
<li>
<p>
<emphasis><ulink role="orm:hideurl" url="http://shop.oreilly.com/product/0636920025139.do">ClojureScript: Up and Running</ulink></emphasis> (O&#8217;Reilly, 2012), by Stuart Sierra
  and Luke VanderHart. While <em>Clojure Cookbook</em> and the other
  Clojure books listed here focus mainly or entirely on Clojure
  itself, ClojureScript (a dialect of Clojure that compiles to
  JavaScript) has gained considerable uptake. This book introduces
  ClojureScript and how to get started with it, and covers the
  similarities and differences between ClojureScript and Clojure.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Finally, you should look at the source code for this book itself,
which is freely available on <a href="http://bit.ly/clj-ckbk">GitHub</a>. The selection
of recipes available online is larger than that in the print version,
and we are still accepting pull requests for new recipes that might
someday make it into a future edition of this book.</p></div>
</div>
<div class="sect2">
<h3 id="_structure">Structure</h3>
<div class="paragraph"><p>The chapters in this book are for the most part groupings of recipes
by theme, rather than strictly categorical. It is entirely possible for
a recipe to be applicable to more than one chapter&#8212;in these cases,
we have simply tried to place it where we think the majority of
readers will likely look first.</p></div>
<div class="paragraph"><p>A <em>recipe</em> consists of three primary parts and one secondary: problem,
solution, discussion, and "see also." A recipe&#8217;s problem statement lays out a task or obstacle to be overcome. Its solution tackles the problem
head-on, illustrating a particular technique or library that
effectively accomplishes the task. The discussion rounds everything
out, exploring the solution and any caveats that may come with it.
Finally, we tie off each recipe with a "see also" section, pointing
you, the reader, to any additional resources or recipes that will
assist you in enacting the described solution.</p></div>
<div class="sect3">
<h4 id="_chapter_listing">Chapter Listing</h4>
<div class="paragraph"><p>The book is composed of the following chapters:</p></div>
<remark>
Cross reference links like ch_primitive_data used to
include a descriptive title like "Primitive Data Chapter on Pg. X",
but now they just say "Chapter 1" or "Recipe 1.2".

We really need to get this descriptive text back, or we will need to
do a pass over the book adding our own.
</remark>
<div class="ulist"><ul>
<li>
<p>
<a href="#ch_primitive_data">[ch_primitive_data]</a>, and <a href="#ch_composite_data">[ch_composite_data]</a>, cover Clojure&#8217;s
built-in primitive and composite data structures, and explain many
common (and less common) ways one might want to use them.
</p>
</li>
<li>
<p>
<a href="#ch_general_computing">[ch_general_computing]</a>, is a grab bag of useful topics that are
generally applicable in many different application areas and project
domains, from Clojure features such as Protocols to alternate
programming paradigms such as logic programming with <span class="monospaced">core.logic</span> or
asynchronous coordination with <span class="monospaced">core.async</span>.
</p>
</li>
<li>
<p>
<a href="#ch_local_io">[ch_local_io]</a>, deals with all the ways in which your program can
interact with the local computer upon which it is running. This
includes reading fromand writing to standard input and output streams,
creating and manipulating files, serializing and deserializing files,
etc.
</p>
</li>
<li>
<p>
<a href="#ch_network_io">[ch_network_io]</a>, contains recipes with similar themes to
<a href="#ch_local_io">[ch_local_io]</a>, but instead deals with <em>remote</em> communication over a
network. It includes recipes on a variety of network communication
protocols and libraries.
</p>
</li>
<li>
<p>
<a href="#ch_databases">[ch_databases]</a>, demonstrates techniques and tools for connecting to
and using a variety of databases. Special attention is given to
Datomic, a datastore that shares and extends much of Clojure&#8217;s
underlying philosophy of value, state, and identity to persistent
storage.
</p>
</li>
<li>
<p>
<a href="#ch_webapps">[ch_webapps]</a>, dives in-depth into one of the most common applications
for Clojure: building and maintaining dynamic websites. It provides
comprehensive treatment of Ring (the most popular HTTP server library
for Clojure), as well as tools for HTML templating and rendering.
</p>
</li>
<li>
<p>
<a href="#ch_deployment_and_distribution">[ch_deployment_and_distribution]</a>, explains what to do with a Clojure
program once you have one, going over common patterns for packaging,
distributing, profiling, logging, and associated ongoing tasks over
the lifetime of an application.
</p>
</li>
<li>
<p>
<a href="#ch_distributed">[ch_distributed]</a>, focuses on cloud computing and
using Clojure for heavyweight distributed data crunching. Special
attention is given to Cascalog, a declarative Clojure interface to the
Hadoop MapReduce framework.
</p>
</li>
<li>
<p>
Last but not least, <a href="#ch_testing">[ch_testing]</a>, covers a variety of techniques for
ensuring the integrity and correctness of your code and data, ranging
from traditional unit and integration tests to more comprehensive
generative and simulation testing, and even optional compile-time
validations using static typing with <span class="monospaced">core.typed</span>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_software_prerequisites">Software Prerequisites</h3>
<div class="paragraph"><p>To follow along with the recipes in this book you will need valid
installations of the Java Development Kit (JDK) and Clojure&#8217;s de facto
build tool, Leiningen. We recommend version 7 of the JDK, but a
minimum of 6 will do. For Leiningen, you should have at least
version 2.2.</p></div>
<div class="paragraph"><p>If you don&#8217;t have Java installed (or would like to upgrade), visit
<a href="http://bit.ly/java-download">the Java Download Page</a> for
instructions on downloading and installing the Java JDK.</p></div>
<div class="paragraph"><p>To install Leiningen, follow the installation instructions on <a href="http://leiningen.org/">Leiningen&#8217;s website</a>. If you already have
Leiningen installed, get the latest version by executing the command
<strong><span class="monospaced">lein upgrade</span></strong>. If you aren&#8217;t familiar with Leiningen, visit the
<a href="http://bit.ly/lein-tutorial">tutorial</a>
to learn more.</p></div>
<div class="paragraph"><p>The one thing you <em>won&#8217;t</em> need to manually install is Clojure itself;
Leiningen will do this for you on an ad hoc basis. To verify your
installation, run <strong><span class="monospaced">lein repl</span></strong> and check your Clojure version:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein repl
<span style="font-style: italic"><span style="color: #9A1900"># ...</span></span>
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">*</span>clojure-version<span style="color: #990000">*</span>
{<span style="color: #990000">:</span>major <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>minor <span style="color: #993399">5</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>incremental <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>qualifier nil}</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Some recipes have accompanying online materials available on GitHub.
If you do not have Git installed on your system, follow <a href="https://help.github.com/articles/set-up-git">the setup instructions</a> to
enable you to check out a GitHub repository locally.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Some recipes&#8212;such as the database recipes&#8212;require further software
installations. Where this is the case, recipes will include additional
information on installing those tools.</p></div>
</div>
<div class="sect2">
<h3 id="_conventions_used_in_this_book">Conventions Used in This Book</h3>
<div class="paragraph"><p>Being a book full of solutions, you&#8217;ll find no shortage of Clojure
source code in this book. Clojure source code appears in a monospace
font, like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add
  <span style="color: #990000">[</span>x y<span style="color: #990000">]</span>
  <span style="color: #990000">(+</span> x y<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>When a Clojure expression is evaluated for a return value, that value
is denoted with a comment followed by an arrow, much like it would
appear on the command line:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(add</span></span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span></tt></pre></div></div>
<div class="paragraph"><p>Where appropriate, code samples may omit or ellipsize return value
comments. The two most common places you&#8217;ll see this are when defining
a function/var or shortening lengthy output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; This would return #'user/one, but do you really care?</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> one <span style="color: #993399">1</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">1</span> <span style="color: #993399">20</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 2 ... 19]</span></span></tt></pre></div></div>
<div class="paragraph"><p>When an expression produces output to <span class="monospaced">STDOUT</span> or <span class="monospaced">STDERR</span>, it is
denoted by a comment (<span class="monospaced">*out*</span> or <span class="monospaced">*error*</span>, respectively), followed
by a comment with each line of output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(do</span></span> <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Hello!"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Goodbye!"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Hello!</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Goodbye!</span></span></tt></pre></div></div>
<div class="sect3">
<h4 id="_repl_sessions">REPL Sessions</h4>
<div class="paragraph"><p>Seeing that <em>REPL-driven development</em> is in vogue at present, it
follows that this be a REPL-driven book. REPLs (read-eval-print loops)
are interactive prompts that evaluate expressions and print their
results. The Bash prompt, <span class="monospaced">irb</span>, and the <span class="monospaced">python</span> prompt are examples
of REPLs. Nearly every recipe in this book is designed to be run at a
Clojure REPL.</p></div>
<div class="paragraph"><p>While Clojure REPLs are traditionally displayed as <span class="monospaced">user=&gt; ...</span>, this
book aims for readers to be able to copy and paste all of the examples in
a recipe and see the indicated results. As such, samples omit <span class="monospaced">user=&gt;</span>
and comment out any output to make things easier. This is especially
helpful if you&#8217;re following along on a computer: you can blindly
copy and paste code samples without worrying about trying to run noncode.</p></div>
<div class="paragraph"><p>When an example is <em>only</em> relevant in the context of a REPL, we will
retain the traditional REPL style (with <span class="monospaced">user=&gt;</span>). What follows is an
example of each, a REPL-only sample and its simplified version.</p></div>
<div class="listingblock">
<div class="title"><em>REPL-only</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(+</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="color: #993399">3</span>
user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>println "Hello<span style="color: #990000">!</span>"<span style="color: #990000">)</span>
Hello<span style="color: #990000">!</span>
nil</tt></pre></div></div>
<div class="listingblock">
<div class="title"><em>Simplified</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(+</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span>

<span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Hello!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Hello!</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_console_terminal_sessions">Console/Terminal Sessions</h4>
<div class="paragraph"><p>Console sessions (e.g., shell commands) are denoted by monospace font,
with lines beginning with a dollar sign (<span class="monospaced">$</span>) indicating a shell
prompt. Output is printed without a leading <span class="monospaced">$</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein version
Leiningen <span style="color: #993399">2.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-preview<span style="color: #993399">10</span> on Java <span style="color: #993399">1.6</span><span style="color: #990000">.</span>0_29 Java HotSpot<span style="color: #990000">(</span>TM<span style="color: #990000">)</span> <span style="color: #993399">64</span>-Bit Server VM</tt></pre></div></div>
<div class="paragraph"><p>A backslash (<span class="monospaced">\</span>) at the end of a command indicates to the console that the
command continues on the next line.</p></div>
<div class="sidebarblock" id="sec_lein_try">
<div class="content">
<div class="title">Our Golden Boy, lein-try</div>
<div class="paragraph"><p>Clojure is not known for its extensive standard library. Unlike
languages like Perl or Ruby, Clojure&#8217;s standard library is
comparatively small; Clojure chose <em>simplicity</em> and <em>power</em> instead.
As such, Clojure is a language full of libraries, not built-ins (well,
except for Java).</p></div>
<div class="paragraph"><p>Since so many of the solutions in this book rely on third-party
libraries, we developed
<a href="https://github.com/rkneufeld/lein-try"><span class="monospaced">lein-try</span></a>. <span class="monospaced">lein-try</span> is a small
plug-in for <a href="http://leiningen.org/">Leiningen</a>, Clojure&#8217;s de facto
project tool, that lets you quickly and easily try out various Clojure
libraries.</p></div>
<div class="paragraph"><p>To use <span class="monospaced">lein-try</span>, ensure you have Leiningen installed, then edit your
user profile (<em>~/.lein/profiles.clj</em>) as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>user {<span style="color: #990000">:</span>plugins <span style="color: #990000">[[</span>lein<span style="color: #990000">-</span>try <span style="color: #FF0000">"0.4.1"</span><span style="color: #990000">]]</span>}}</tt></pre></div></div>
<div class="paragraph"><p>Now, inside of a project or out, you can use the <strong><span class="monospaced">lein try</span></strong> command
to launch a REPL with access to whichever library you please:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time
<span style="font-style: italic"><span style="color: #9A1900">#...</span></span>
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Long story short: where possible, you&#8217;ll see instructions on which
<span class="monospaced">lein-try</span> command to execute above recipes that use third-party
libraries. You&#8217;ll find an example of trying recipes with <span class="monospaced">lein-try</span> in
<a href="#sec_try_library">[sec_try_library]</a>.</p></div>
<div class="paragraph"><p>If a recipe <em>cannot</em> be run via <span class="monospaced">lein-try</span>, we have made efforts to
include adequate instructions on how to run that recipe on your local
machine.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_typesetting_conventions">Typesetting Conventions</h4>
<div class="paragraph"><p>The following typographic conventions are used in this book:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Italic</em>
</dt>
<dd>
<p>
  Used for URLs, filenames, pathnames, and file extensions. New terms are also
  italicized when they first appear in the text, and italics are used for emphasis.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">Constant width</span>
</dt>
<dd>
<p>
  Used for function and method names and their arguments; for data types, classes, and namespaces; in
  examples to show both input and output; and in regular text to show
  literal code.
</p>
</dd>
<dt class="hdlist1">
<strong><span class="monospaced">Constant width bold</span></strong>
</dt>
<dd>
<p>
  Used to indicate commands that you should enter literally at the
  command line.
</p>
</dd>
<dt class="hdlist1">
&lt;replaceable-value&gt;
</dt>
<dd>
<p>
Elements of pathnames, commands, function names, etc. that should be replaced with user-supplied values are shown in angle brackets.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The names of libraries follow one of two conventions: libraries with proper
names are displayed in plain text (e.g., "Hiccup" or "Swing"), while
libraries with names meant to mimic code symbols are displayed in constant-width text (e.g., <span class="monospaced">core.async</span> or <span class="monospaced">clj-commons-exec</span>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This element signifies a tip or suggestion.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This element signifies a general note.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This element indicates a warning or caution.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_code_examples">Using Code Examples</h3>
<div class="paragraph"><p>Supplemental material (code examples, exercises, etc.) is available
for download at
<a href="http://bit.ly/clj-ckbk">http://bit.ly/clj-ckbk</a>.</p></div>
<div class="paragraph"><p>This book is here to help you get your job done. In general, if
example code is offered with this book, you may use it in your
programs and documentation. You do not need to contact us for
permission unless you’re reproducing a significant portion of the
code. For example, writing a program that uses several chunks of code
from this book does not require permission. Selling or distributing a
CD-ROM of examples from O’Reilly books does require permission.
Answering a question by citing this book and quoting example code does
not require permission. Incorporating a significant amount of example
code from this book into your product’s documentation does require
permission.</p></div>
<div class="paragraph"><p>We appreciate, but do not require, attribution. An attribution usually
includes the title, author, publisher, and ISBN. For example:
“<em>Clojure Cookbook</em> by Luke VanderHart and Ryan Neufeld (O’Reilly).
Copyright 2014 Cognitect, Inc., 978-1-449-36617-9.”</p></div>
<div class="paragraph"><p>If you feel your use of code examples falls outside fair use or the
permission given above, feel free to contact us at
<email>permissions@oreilly.com</email>.</p></div>
</div>
<div class="sect2">
<h3 id="_safari_books_online">Safari® Books Online</h3>
<div class="admonitionblock safarienabled">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><ulink role="orm:hideurl:ital"
url="http://my.safaribooksonline.com/?portal=oreilly">Safari Books
Online</ulink> is an on-demand digital library that delivers expert
<ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/content">content</ulink> in
both book and video form from the world&#8217;s leading authors in
technology and business.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Technology professionals, software developers, web designers, and
business and creative professionals use Safari Books Online as their
primary resource for research, problem solving, learning, and
certification training.</p></div>
<div class="paragraph"><p>Safari Books Online offers a range of <ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/subscriptions">product
mixes</ulink> and pricing programs for <ulink
role="orm:hideurl"
url="http://www.safaribooksonline.com/organizations-teams">organizations</ulink>,
<ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/government">government
agencies</ulink>, and <ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/individuals">individuals</ulink>.
Subscribers have access to thousands of books, training videos, and
prepublication manuscripts in one fully searchable database from
publishers like O’Reilly Media, Prentice Hall Professional,
Addison-Wesley Professional, Microsoft Press, Sams, Que, Peachpit
Press, Focal Press, Cisco Press, John Wiley &amp; Sons, Syngress, Morgan
Kaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning,
New Riders, McGraw-Hill, Jones &amp; Bartlett, Course Technology, and
dozens <ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/publishers">more</ulink>. For
more information about Safari Books Online, please visit us
<ulink role="orm:hideurl"
url="http://www.safaribooksonline.com/">online</ulink>.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_contact_us">How to Contact Us</h3>
<div class="paragraph"><p>Please address comments and questions concerning this book to the publisher:</p></div>
<simplelist>
<member>O’Reilly Media, Inc.</member>
<member>1005 Gravenstein Highway North</member>
<member>Sebastopol, CA 95472</member>
<member>800-998-9938 (in the United States or Canada)</member>
<member>707-829-0515 (international or local)</member>
<member>707-829-0104 (fax)</member>
</simplelist>
<div class="paragraph"><p>We have a web page for this book, where we list errata, examples, and
any additional information. You can access this page at
<a href="http://oreil.ly/clojure-ckbk">http://oreil.ly/clojure-ckbk</a>.</p></div>
<remark>Don't forget to update the link above.</remark>
<div class="paragraph"><p>To comment or ask technical questions about this book, send email to
<email>bookquestions@oreilly.com</email>.</p></div>
<div class="paragraph"><p>For more information about our books, courses, conferences, and news,
see our website at <a href="http://www.oreilly.com">http://www.oreilly.com</a>.</p></div>
<div class="paragraph"><p>Find us on Facebook: <a href="http://facebook.com/oreilly">http://facebook.com/oreilly</a></p></div>
<div class="paragraph"><p>Follow us on Twitter: <a href="http://twitter.com/oreillymedia">http://twitter.com/oreillymedia</a> or <a href="https://twitter.com/clojurecookbook">https://twitter.com/clojurecookbook</a></p></div>
<div class="paragraph"><p>Watch us on YouTube: <a href="http://www.youtube.com/oreillymedia">http://www.youtube.com/oreillymedia</a></p></div>
</div>
<div class="sect2">
<h3 id="_acknowledgments">Acknowledgments</h3>
<div class="paragraph"><p>This book would not have been possible without the
selfless contributions of many within the Clojure community. Over 65
Clojurists rose to the occasion, submitting recipes, proofreading, and
offering their input on the direction of the book. Ultimately, this is
the community&#8217;s book&#8212;we&#8217;re just honored to have been able to help put
it together. Those contributors are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Adam Bard, <a href="https://github.com/adambard">adambard</a> on GitHub
</p>
</li>
<li>
<p>
Alan Busby, <a href="https://github.com/thebusby">thebusby</a> on GitHub
</p>
</li>
<li>
<p>
Alex Miller, <a href="https://github.com/puredanger">puredanger</a> on GitHub
</p>
</li>
<li>
<p>
Alex Petrov, <a href="https://github.com/ifesdjeen">ifesdjeen</a> on GitHub
</p>
</li>
<li>
<p>
Alex Robbins, <a href="https://github.com/alexrobbins">alexrobbins</a> on GitHub
</p>
</li>
<li>
<p>
Alex Vzorov, <a href="https://github.com/0rca">0rca</a> on GitHub
</p>
</li>
<li>
<p>
Ambrose Bonnaire-Sergeant, <a href="https://github.com/frenchy64">frenchy64</a> on GitHub
</p>
</li>
<li>
<p>
<a href="https://github.com/arosequist">arosequist</a>
</p>
</li>
<li>
<p>
Chris Allen, <a href="https://github.com/bitemyapp">bitemyapp</a> on GitHub
</p>
</li>
<li>
<p>
Chris Ford, <a href="https://github.com/ctford">ctford</a> on GitHub
</p>
</li>
<li>
<p>
Chris Frisz, <a href="https://github.com/cjfrisz">cjfrisz</a> on GitHub
</p>
</li>
<li>
<p>
Clinton Begin, <a href="https://github.com/cbegin">cbegin</a> on GitHub
</p>
</li>
<li>
<p>
Clinton Dreisbach, <a href="https://github.com/cndreisbach">cndreisbach</a> on GitHub
</p>
</li>
<li>
<p>
Colin Jones, <a href="https://github.com/trptcolin">trptcolin</a> on GitHub
</p>
</li>
<li>
<p>
Craig McDaniel, <a href="https://github.com/cpmcdaniel">cpmcdaniel</a> on GitHub
</p>
</li>
<li>
<p>
Daemian Mack, <a href="https://github.com/daemianmack">daemianmack</a> on GitHub
</p>
</li>
<li>
<p>
Dan Allen, <a href="https://github.com/mojavelinux">mojavelinux</a> on GitHub
</p>
</li>
<li>
<p>
Daniel Gregoire, <a href="https://github.com/semperos">semperos</a> on GitHub
</p>
</li>
<li>
<p>
David McNeil, <a href="https://github.com/david-mcneil">david-mcneil</a> on GitHub
</p>
</li>
<li>
<p>
Dmitri Sotnikov, <a href="https://github.com/yogthos">yogthos</a> on GitHub
</p>
</li>
<li>
<p>
Edmund Jackson, <a href="https://github.com/ejackson">ejackson</a> on GitHub
</p>
</li>
<li>
<p>
Eric Normand, <a href="https://github.com/ericnormand">ericnormand</a> on GitHub
</p>
</li>
<li>
<p>
Federico Ramirez, <a href="https://github.com/gosukiwi">gosukiwi</a> on GitHub
</p>
</li>
<li>
<p>
Filippo Diotalevi, <a href="https://github.com/fdiotalevi">fdiotalevi</a> on GitHub
</p>
</li>
<li>
<p>
<a href="https://github.com/fredericksgary">fredericksgary</a>
</p>
</li>
<li>
<p>
Gabriel Horner, <a href="https://github.com/cldwalker">cldwalker</a> on GitHub
</p>
</li>
<li>
<p>
Gerrit, <a href="https://github.com/gerritjvv">gerritjvv</a> on GitHub
</p>
</li>
<li>
<p>
Guewen Baconnier, <a href="https://github.com/guewen">guewen</a> on GitHub
</p>
</li>
<li>
<p>
Hoàng Minh Thắng, <a href="https://github.com/myguidingstar">myguidingstar</a> on GitHub
</p>
</li>
<li>
<p>
Jason Webb, <a href="https://github.com/bigjason">bigjason</a> on GitHub
</p>
</li>
<li>
<p>
Jason Wolfe, <a href="https://github.com/w01fe">w01fe</a> on GitHub
</p>
</li>
<li>
<p>
Jean Niklas L&#8217;orange, <a href="https://github.com/hyPiRion">hyPiRion</a> on GitHub
</p>
</li>
<li>
<p>
Joey Yang, <a href="https://github.com/joeyyang">joeyyang</a> on GitHub
</p>
</li>
<li>
<p>
John Cromartie, <a href="https://github.com/jcromartie">jcromartie</a> on GitHub
</p>
</li>
<li>
<p>
John Jacobsen, <a href="https://github.com/eigenhombre">eigenhombre</a> on GitHub
</p>
</li>
<li>
<p>
John Touron, <a href="https://github.com/jwtouron">jwtouron</a> on GitHub
</p>
</li>
<li>
<p>
Joseph Wilk, <a href="https://github.com/josephwilk">josephwilk</a> on GitHub
</p>
</li>
<li>
<p>
<a href="https://github.com/jungziege">jungziege</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/jwhitlark">jwhitlark</a>
</p>
</li>
<li>
<p>
Kevin Burnett, <a href="https://github.com/burnettk">burnettk</a> on GitHub
</p>
</li>
<li>
<p>
Kevin Lynagh, <a href="https://github.com/lynaghk">lynaghk</a> on GitHub
</p>
</li>
<li>
<p>
Lake Denman, <a href="https://github.com/ldenman">ldenman</a> on GitHub
</p>
</li>
<li>
<p>
Leonardo Borges, <a href="https://github.com/leonardoborges">leonardoborges</a> on GitHub
</p>
</li>
<li>
<p>
Mark Whelan, <a href="https://github.com/mrwhelan">mrwhelan</a> on GitHub
</p>
</li>
<li>
<p>
Martin Janiczek, <a href="https://github.com/Janiczek">Janiczek</a> on GitHub
</p>
</li>
<li>
<p>
Matthew Maravillas, <a href="https://github.com/maravillas">maravillas</a> on GitHub
</p>
</li>
<li>
<p>
Michael Fogus, <a href="https://github.com/fogus">fogus</a> on GitHub
</p>
</li>
<li>
<p>
Michael Klishin, <a href="https://github.com/michaelklishin">michaelklishin</a> on GitHub
</p>
</li>
<li>
<p>
Michael Mullis, <a href="https://github.com/mmullis">mmullis</a> on GitHub
</p>
</li>
<li>
<p>
Michael O&#8217;Church, <a href="https://github.com/michaelochurch">michaelochurch</a> on <phrase role='keep-together'>GitHub</phrase>
</p>
</li>
<li>
<p>
Mosciatti S., <a href="https://github.com/siscia">siscia</a> on GitHub
</p>
</li>
<li>
<p>
<a href="https://github.com/nbessi">nbessi</a>
</p>
</li>
<li>
<p>
Neil Laurance, <a href="https://github.com/toolkit">toolkit</a> on GitHub
</p>
</li>
<li>
<p>
Nurullah Akkaya, <a href="https://github.com/nakkaya">nakkaya</a> on GitHub
</p>
</li>
<li>
<p>
Osbert Feng, <a href="https://github.com/osbert">osbert</a> on GitHub
</p>
</li>
<li>
<p>
Prathamesh Sonpatki, <a href="https://github.com/prathamesh">prathamesh-sonpatki</a> on GitHub
</p>
</li>
<li>
<p>
R.T. Lechow, <a href="https://github.com/rtlechow">rtlechow</a> on GitHub
</p>
</li>
<li>
<p>
Ravindra R. Jaju, <a href="https://github.com/jaju">jaju</a> on GitHub
</p>
</li>
<li>
<p>
Robert Stuttaford, <a href="https://github.com/robert-stuttaford">robert-stuttaford</a> on <phrase role='keep-together'>GitHub</phrase>
</p>
</li>
<li>
<p>
Russ Olsen, <a href="https://github.com/russolsen">russolsen</a> on GitHub
</p>
</li>
<li>
<p>
Ryan Senior, <a href="https://github.com/senior">senior</a> on GitHub
</p>
</li>
<li>
<p>
Sam Umbach, <a href="https://github.com/sumbach">sumbach</a> on GitHub
</p>
</li>
<li>
<p>
Sandeep Nangia, <a href="https://github.com/nangia">nangia</a> on GitHub
</p>
</li>
<li>
<p>
Steve Miner, <a href="https://github.com/miner">miner</a> on GitHub
</p>
</li>
<li>
<p>
Steven Proctor, <a href="https://github.com/stevenproctor">stevenproctor</a> on GitHub
</p>
</li>
<li>
<p>
<a href="https://github.com/temacube">temacube</a>
</p>
</li>
<li>
<p>
Tobias Bayer, <a href="https://github.com/codebrickie">codebrickie</a> on GitHub
</p>
</li>
<li>
<p>
Tom White, <a href="https://github.com/dribnet">dribnet</a> on GitHub
</p>
</li>
<li>
<p>
Travis Vachon, <a href="https://github.com/travis">travis</a> on GitHub
</p>
</li>
<li>
<p>
Stefan Karlsson, <a href="https://github.com/zclj">zclj</a> on GitHub
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our biggest contributors also deserve special thanks: Adam
Bard, Alan Busby, Alex Robbins, Ambrose Bonnaire-Sergeant, Dmitri Sotnikov,
John Cromartie, John Jacobsen, Robert Stuttaford, Stefan Karlsson, and
Tom Hicks. All together, these outstanding individuals contributed
almost a third of the book&#8217;s recipes.</p></div>
<div class="paragraph"><p>Thanks also to our technical reviewers, Alex Robbins, Travis Vachon, and
Thomas Hicks. These fine gentlemen scoured the book for technical
errors in record time, in the 11th hour no less. Where a regular
technical reviewer would merely submit textual descriptions of
problems, these folks went above and beyond, often submitting pull
requests <em>fixing</em> the very errors they were reporting. All in all,
they were a pleasure to work with and the book is much better because
of their involvement.</p></div>
<div class="paragraph"><p>Finally, thanks to our employer, Cognitect, for giving us time to work
on the book, and to all of our colleagues who offered advice, feedback,
and best of all, more recipes!</p></div>
<div class="sect3">
<h4 id="_ryan_neufeld">Ryan Neufeld</h4>
<div class="paragraph"><p>First, a huge thanks to Luke. It was Luke who originally pitched the
idea for the book, and I&#8217;m very grateful that he extended an
invitation for me to join him in authoring it. They say the best way
to learn something is to write a book on it&#8212;this couldn&#8217;t be any
closer to the truth. Working on the book has really rounded out my
Clojure skills and taken them to the next level.</p></div>
<div class="paragraph"><p>And, most importantly, I have to thank my family for putting up with me
through the process of writing the book. Getting this thing off the
ground has been a Herculean task and I couldn&#8217;t have done it without
the love and support of my wife Jackie and daughter Elody. If it
hadn&#8217;t been for the hundreds upon hundreds of hours of evenings,
weekends, and vacation time I usurped from them, I wouldn&#8217;t have been
able to write this book.</p></div>
</div>
<div class="sect3">
<h4 id="_luke_vanderhart">Luke VanderHart</h4>
<div class="paragraph"><p>Most of all, I&#8217;d like to thank my coauthor Ryan, who worked incredibly
hard to make the book happen.</p></div>
<div class="paragraph"><p>Also, all of my coworkers at Cognitect provided lots of thoughts and
ideas, and most importantly were a sounding board for the many
questions that arose during the writing and editing process. Many
thanks for that, as well as for providing the opportunity to write
code in Clojure all day, every day.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_primitive_data">Primitive Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph"><p>Clojure is a fantastic language for tackling hard problems. Its
<em>simple</em> tools let us software developers build up layer upon layer of
abstractions until we&#8217;ve tackled some of the world&#8217;s most difficult
problems with ease. Like chemistry, every great Clojure program boils
down to simple atoms&#8212;these are our primitives.</p></div>
<div class="paragraph"><p>Standing on the shoulders of the Java giants from days of yore,
Clojure leverages a fantastic array of battle-hardened types present
in the Java Virtual Machine (JVM):<span class="footnote"><br>[The JVM is
where Java bytecode is executed. The Clojure compiler targets the JVM by emitting bytecode
to be run there; thus, you have all of the native Java types at your
disposal.]<br></span> strings, numeric types, dates, Universally Unique Identifiers (UUIDs)&#x2014;you name it, Clojure
has it all. This chapter dives into the primitives of Clojure and how
to accomplish common tasks.</p></div>
<div class="sect3">
<h4 id="_strings">Strings</h4>
<div class="paragraph"><p>Almost every programming language knows how to work with and deal in
strings. Clojure is no exception, and despite a few differences,
Clojure provides the same general capabilities as most other
languages. Here are a few key differences we think you should know
about.</p></div>
<div class="paragraph"><p>First, Clojure strings are backed by Java&#8217;s UTF-16 strings. You don&#8217;t
need to add comments to files to indicate string encoding or worry
about losing characters in translation. Your Clojure programs are
ready to communicate in the world beyond A&#x2013;Z.</p></div>
<div class="paragraph"><p>Second, unlike languages like Perl or Ruby that have extensive string
libraries, Clojure has a rather Spartan built-in string
manipulation library. This may seem odd at first, but Clojure prefers
simple and composable tools; all of the plethora of collection-modifying functions in Clojure are perfectly capable of accepting
strings&#8212;they&#8217;re collections too! For this reason, Clojure&#8217;s string
library is unexpectedly small. You&#8217;ll find that small set of very
string-specific functions in the <span class="monospaced">clojure.string</span> namespace.</p></div>
<div class="paragraph"><p>Clojure also embraces its host platform (the JVM) and does not
duplicate functionality already adequately performed by Java&#8217;s
<span class="monospaced">java.lang.String</span> class. Using Java interop in Clojure is not a
failure&#8212;the language is designed to make it straightforward, and
using the built-in string methods is usually just as easy as invoking
a Clojure function.</p></div>
<div class="paragraph"><p>We suggest you "require as" the <span class="monospaced">clojure.string</span> namespace when you
need it. Blindly <span class="monospaced">:use</span>-ing a namespace is always annoying,<span class="footnote"><br>[By using <span class="monospaced">use</span>, you introduce numerous new symbols into your
project&#8217;s namespaces without leaving any clues as to where they came
from. This is often confusing and frustrating for maintainers of the
code base. We highly suggest you avoid <span class="monospaced">use</span>.]<br></span> and often results in
collisions/confusion. Prefixing everything with <span class="monospaced">clojure.string</span> is
kind of odd, so we prefer to alias it to <span class="monospaced">str</span> or <span class="monospaced">s</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>string <span style="color: #990000">:</span>as str<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(str</span></span><span style="color: #990000">/</span>blank<span style="color: #990000">?</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_numeric_types">Numeric Types</h4>
<div class="paragraph"><p>The veneer between Clojure and Java is a little thicker over the
numeric types. This isn&#8217;t necessarily a bad thing, though. While
Java&#8217;s numeric types can be extremely fast or arbitrarily precise,
numerics overall don&#8217;t have the prettiest set of interfaces to work
with. Clojure unifies the various numeric types of Java into one
coherent package, with clear escape hatches at every turn.</p></div>
<div class="paragraph"><p>The recipes on numeric types in this chapter will show you how to work with
these hatches, showing you how to be as fast or precise or expressive
as you desire.</p></div>
</div>
<div class="sect3">
<h4 id="_dates">Dates</h4>
<div class="paragraph"><p>Dates and times have a long and varied history in the Java
ecosystem. Do you want a <span class="monospaced">Date</span>, <span class="monospaced">Time</span>, <span class="monospaced">DateTime</span>, or <span class="monospaced">Calendar</span>?
Who knows. And why are these APIs all so wonky? The recipes in this
chapter should hopefully illuminate how and when to use the
appropriate built-in types and when to look to an external library
when built-ins aren&#8217;t sufficient (or are just too darned difficult to
use).</p></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_changing_the_capitalization_of_a_string">Changing the Capitalization of a String</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem">Problem</h4>
<div class="paragraph"><p>You need to change the capitalization of a string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">clojure.string/capitalize</span> to capitalize the first character in a string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>capitalize <span style="color: #FF0000">"this is a proper sentence."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "This is a proper sentence."</span></span></tt></pre></div></div>
<div class="paragraph"><p>When you need to change the case of all characters in a string, use
<span class="monospaced">clojure.string/lower-case</span> or <span class="monospaced">clojure.string/upper-case</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>upper<span style="color: #990000">-</span>case <span style="color: #FF0000">"loud noises!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "LOUD NOISES!"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>lower<span style="color: #990000">-</span>case <span style="color: #FF0000">"COLUMN_HEADER_ONE"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "column_header_one"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion">Discussion</h4>
<div class="paragraph"><p>Capitalization functions only affect letters. While the functions
<span class="monospaced">capitalize</span>, <span class="monospaced">lower-case</span>, and <span class="monospaced">upper-case</span> may modify letters,
characters like punctuation marks or digits will remain
untouched:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>lower<span style="color: #990000">-</span>case <span style="color: #FF0000">"!&amp;$#@#%^[]"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "!&amp;$#@#%^[]"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Clojure uses UTF-16 for all strings, and as such its definition of what
a letter is is liberal enough to include accented characters. Take the phrase "Hurry up, computer!" which includes the letter
<em>e</em> with both acute (<em>é</em>) and circumflex (<em>ê</em>) accents when translated
to French. Since these special characters are considered letters, it is
possible for capitalization functions to change case appropriately:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>upper<span style="color: #990000">-</span>case <span style="color: #FF0000">"Dépêchez-vous, l'ordinateur!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "DÉPÊCHEZ-VOUS, L'ORDINATEUR!"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.string</span> namespace
  <a href="http://bit.ly/clj-string-api">API documentation</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">java.lang.String</span>
  <a href="http://bit.ly/javadoc-string">API
  documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_cleaning_up_whitespace_in_a_string">Cleaning Up Whitespace in a String</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_2">Problem</h4>
<div class="paragraph"><p>You need to clean up the whitespace in a string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_2">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.string/trim</span> function to remove all of the whitespace
at the beginning and end of a string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>trim <span style="color: #FF0000">" </span><span style="color: #CC33CC">\t</span><span style="color: #FF0000">Bacon ipsum dolor sit.</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Bacon ipsum dolor sit."</span></span></tt></pre></div></div>
<div class="paragraph"><p>To manage whitespace <em>inside</em> a string, you need to get more creative. Use
<phrase role='keep-together'><literal>clojure.string/replace</literal></phrase> to fix whitespace inside a string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Collapse whitespace into a single space</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace <span style="color: #FF0000">"Who</span><span style="color: #CC33CC">\t\n</span><span style="color: #FF0000">put  all this</span><span style="color: #CC33CC">\f</span><span style="color: #FF0000">whitespace here?"</span> #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\s</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">" "</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Who put all this whitespace here?"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Replace Windows-style line endings with Unix-style newlines</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace <span style="color: #FF0000">"Line 1</span><span style="color: #CC33CC">\r\n</span><span style="color: #FF0000">Line 2"</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\r\n</span><span style="color: #FF0000">"</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Line 1\nLine 2"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_2">Discussion</h4>
<div class="paragraph"><p>What constitutes whitespace in Clojure? The answer depends on the
function: some are more liberal than others, but you can safely assume
that a space ( ), tab (<span class="monospaced">\t</span>), newline/linefeed (<span class="monospaced">\n</span>), carriage return (<span class="monospaced">\r</span>),
form feed (<span class="monospaced">\f</span>), and vertical tab (<span class="monospaced">\x0B</span>) will be treated as whitespace.
This set of characters is the set matched by <span class="monospaced">\s</span> in Java&#8217;s regular
expression implementation.</p></div>
<div class="paragraph"><p>Unlike Ruby and other languages that include string manipulation
functions in the core namespace, Clojure excludes its <span class="monospaced">clojure.string</span>
namespace from <span class="monospaced">clojure.core</span>, making it unavailable for naked use. A
common technique is to require <span class="monospaced">clojure.string</span> as a shorthand like
<span class="monospaced">str</span> or <span class="monospaced">string</span> to make code more terse:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>string <span style="color: #990000">:</span>as str<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(str</span></span><span style="color: #990000">/</span>replace <span style="color: #FF0000">"Look Ma, no hands"</span> <span style="color: #FF0000">"hands"</span> <span style="color: #FF0000">"long namespace prefixes"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Look Ma, no long namespace prefixes"</span></span></tt></pre></div></div>
<div class="paragraph"><p>You might not always want to remove whitespace from both ends of a
string. For cases where you want to remove whitespace from just the left-
or righthand side of a string, use <span class="monospaced">clojure.string/triml</span> or
<span class="monospaced">clojure.string/trimr</span>, respectively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>triml <span style="color: #FF0000">" Column Header</span><span style="color: #CC33CC">\t</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Column Header\t"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>trimr <span style="color: #FF0000">"</span><span style="color: #CC33CC">\t\t</span><span style="color: #FF0000">* Second-level bullet.</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "\t\t* Second-level bullet."</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_2">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_building_strings_from_parts">[sec_primitives_building_strings_from_parts]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_building_strings_from_parts">Building a String from Parts</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_3">Problem</h4>
<div class="paragraph"><p>You have multiple strings, values, or collections that you need to
combine into one string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_3">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">str</span> function to concatenate strings and/or values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"John"</span> <span style="color: #FF0000">" "</span> <span style="color: #FF0000">"Doe"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "John Doe"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; str also works with vars, or any other values</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> first<span style="color: #990000">-</span>name <span style="color: #FF0000">"John"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Doe"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> age <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(str</span></span> last<span style="color: #990000">-</span>name <span style="color: #FF0000">", "</span> first<span style="color: #990000">-</span>name <span style="color: #FF0000">" - age: "</span> age<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Doe, John - age: 42"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">apply</span> with <span class="monospaced">str</span> to concatenate a collection of values into a
single string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; To collapse a sequence of characters back into a string</span></span>
<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="color: #FF0000">"ROT13: "</span> <span style="color: #990000">[\</span>W <span style="color: #990000">\</span>h <span style="color: #990000">\</span>y <span style="color: #990000">\</span>v <span style="color: #990000">\</span>h <span style="color: #990000">\</span>f <span style="color: #990000">\</span>  <span style="color: #990000">\</span>P <span style="color: #990000">\</span>n <span style="color: #990000">\</span>r <span style="color: #990000">\</span>f <span style="color: #990000">\</span>n <span style="color: #990000">\</span>e<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "ROT13: Whyvhf Pnrfne"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Or, to reconstitute a file from lines (if they already have newlines...)</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> lines <span style="color: #990000">[</span><span style="color: #FF0000">"#! /bin/bash</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span>
            <span style="color: #FF0000">"du -a ./ | sort -n -r</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str lines<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "#! /bin/bash\ndu -a ./ | sort -n -r\n"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_3">Discussion</h4>
<div class="paragraph"><p>Clojure&#8217;s <span class="monospaced">str</span> is like a good Unix tool: it has one job, and it does it
well. When provided with one or more arguments, <span class="monospaced">str</span> invokes Java&#8217;s
<span class="monospaced">.toString()</span> method on its argument, tacking each result onto
the next. When provided <span class="monospaced">nil</span> or invoked without arguments, <span class="monospaced">str</span> will
return the identity value for strings, the empty string.</p></div>
<div class="paragraph"><p>When it comes to string concatenation, Clojure takes a fairly hands-off
approach. There is nothing string-specific about <span class="monospaced">(apply str ...)</span>. It
is merely the higher-order function <span class="monospaced">apply</span> being used to emulate
calling <span class="monospaced">str</span> with a variable number of arguments.</p></div>
<div class="paragraph"><p>This <span class="monospaced">apply</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"b"</span> <span style="color: #FF0000">"c"</span><span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>is functionally equivalent to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"b"</span> <span style="color: #FF0000">"c"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Since Clojure injects little opinion into joining strings, you&#8217;re free
to inject your own with the plethora of manipulating functions
Clojure provides. For example, take constructing a comma-separated value (CSV) from a header and
a number of rows. This example is particularly well suited for <span class="monospaced">apply</span>,
as you can prefix the header without having to insert it onto the front
of your <span class="monospaced">rows</span> collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Constructing a CSV from a header string and vector of rows</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> header <span style="color: #FF0000">"first_name,last_name,employee_number</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> rows <span style="color: #990000">[</span><span style="color: #FF0000">"luke,vanderhart,1"</span>
           <span style="color: #FF0000">"ryan,neufeld,2"</span><span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str header <span style="font-weight: bold"><span style="color: #000000">(interpose</span></span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span> rows<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "first_name,last_name,employee_number\nluke,vanderhart,1\nryan,neufeld,2"</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">apply</span> and <span class="monospaced">interpose</span> can be a lot of ceremony when you&#8217;re not doing
anything too fancy. It is often easier to use the <span class="monospaced">clojure.string/join</span>
function for simple string joins. The <span class="monospaced">join</span> function takes a collection
and an optional separator. With a separator, <span class="monospaced">join</span> returns a string
with each item of the collection separated by the provided separator.
Without, it returns each item squashed together, similar to what
<span class="monospaced">(apply str coll)</span> would return:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> food<span style="color: #990000">-</span>items <span style="color: #990000">[</span><span style="color: #FF0000">"milk"</span> <span style="color: #FF0000">"butter"</span> <span style="color: #FF0000">"flour"</span> <span style="color: #FF0000">"eggs"</span><span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>join <span style="color: #FF0000">", "</span> food<span style="color: #990000">-</span>items<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "milk, butter, flour, eggs"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>join <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1234"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_3">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_strings_formatting_strings">[sec_primitives_strings_formatting_strings]</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">clojure.string</span> namespace
  <a href="http://bit.ly/clj-string-api">API documentation</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">java.lang.String</span>
  <a href="http://bit.ly/javadoc-string">API
  documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_strings_seq_of_chars">Treating a String as a Sequence of Characters</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_4">Problem</h4>
<div class="paragraph"><p>You need to work with the individual characters in a string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_4">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">seq</span> on a string to expose the sequence of characters representing it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="color: #FF0000">"Hello, world!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (\H \e \l \l \o \, \space \w \o \r \l \d \!)</span></span></tt></pre></div></div>
<div class="paragraph"><p>You don&#8217;t need to call <span class="monospaced">seq</span> every time you want to get at a string&#8217;s
characters, though. Any function taking a sequence will naturally
coerce a string into a sequence of characters:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Count the occurrences of each character in a string.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(frequencies</span></span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>lower<span style="color: #990000">-</span>case <span style="color: #FF0000">"An adult all about A's"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {\space 4, \a 5, \b 1, \d 1, \' 1, \l 3, \n 1, \o 1, \s 1, \t 2, \u 2}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Is every letter in a string capitalized?</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> yelling<span style="color: #990000">?</span> <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(every</span></span><span style="color: #990000">?</span> #<span style="font-weight: bold"><span style="color: #000000">(or</span></span> <span style="font-weight: bold"><span style="color: #000000">(not</span></span> <span style="font-weight: bold"><span style="color: #000000">(Character</span></span><span style="color: #990000">/</span>isLetter <span style="color: #990000">%))</span>
               <span style="font-weight: bold"><span style="color: #000000">(Character</span></span><span style="color: #990000">/</span>isUpperCase <span style="color: #990000">%))</span>
        s<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(yelling</span></span><span style="color: #990000">?</span> <span style="color: #FF0000">"LOUD NOISES!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(yelling</span></span><span style="color: #990000">?</span> <span style="color: #FF0000">"Take a DEEP breath."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_4">Discussion</h4>
<div class="paragraph"><p>In computer science, "string" means "sequence of characters,"
and Clojure treats strings exactly as such. Because Clojure strings
are sequences under the covers, you may substitute a string anywhere a
collection is expected. When you do so, the string will be interpreted
as a collection of characters. There&#8217;s nothing special about <span class="monospaced">(seq
string)</span>. The <span class="monospaced">seq</span> function is merely returning a seq of the
collection of characters that make up the string.</p></div>
<div class="paragraph"><p>More often than not, after you&#8217;ve done some work on the characters
within a string, you&#8217;ll want to transform that collection back into a
string. Use <span class="monospaced">apply</span> with <span class="monospaced">str</span> on a collection of characters to
collapse them into a string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="color: #990000">[\</span>H <span style="color: #990000">\</span>e <span style="color: #990000">\</span>l <span style="color: #990000">\</span>l <span style="color: #990000">\</span>o <span style="color: #990000">\,</span> <span style="color: #990000">\</span>space <span style="color: #990000">\</span>w <span style="color: #990000">\</span>o <span style="color: #990000">\</span>r <span style="color: #990000">\</span>l <span style="color: #990000">\</span>d <span style="color: #990000">\!])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Hello, world!"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_4">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_building_strings_from_parts">[sec_primitives_building_strings_from_parts]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_converting_characters_integers">[sec_primitives_converting_characters_integers]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_converting_characters_integers">Converting Between Characters and Integers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_5">Problem</h4>
<div class="paragraph"><p>You need to convert characters to their respective Unicode code points
(as integer values), or vice versa.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_5">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">int</span> function to convert a character to its integer value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #990000">\</span>a<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 97</span></span>

<span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #990000">\</span>ø<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 248</span></span>

<span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #990000">\</span>α<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; Greek letter alpha</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 945</span></span>

<span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #990000">\</span>u03B1<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; Greek letter alpha (by code point)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 945</span></span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #009900">int</span> <span style="color: #FF0000">"Hello, world!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (72 101 108 108 111 44 32 119 111 114 108 100 33)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use the <span class="monospaced">char</span> function to return a character corresponding to the
code point specified by the integer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(char</span></span> <span style="color: #993399">97</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; \a</span></span>

<span style="font-weight: bold"><span style="color: #000000">(char</span></span> <span style="color: #993399">125</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; \}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(char</span></span> <span style="color: #993399">945</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; \α</span></span>


<span style="font-weight: bold"><span style="color: #000000">(def</span></span> codes <span style="color: #990000">[</span><span style="color: #993399">115</span> <span style="color: #993399">101</span> <span style="color: #993399">99</span> <span style="color: #993399">114</span> <span style="color: #993399">101</span> <span style="color: #993399">116</span> <span style="color: #993399">32</span> <span style="color: #993399">109</span> <span style="color: #993399">101</span> <span style="color: #993399">115</span> <span style="color: #993399">115</span> <span style="color: #993399">97</span> <span style="color: #993399">103</span> <span style="color: #993399">101</span> <span style="color: #993399">115</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'user/codes</span></span>
<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #009900">char</span> codes<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "secret messages"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_5">Discussion</h4>
<div class="paragraph"><p>Clojure inherits the JVM&#8217;s robust Unicode support. All strings are
UTF-16 strings, and all characters are Unicode
characters. Conveniently, the first 256 Unicode code points are
identical to ASCII, which makes standard ASCII text easy to work
with. However, Clojure (like Java) does not actually privilege ASCII in
any way; the 1:1 correspondence between characters and integers
indicating code points continues all the way up through the Unicode space.</p></div>
<div class="paragraph"><p>For example, the expression <span class="monospaced">(map char (range 0x0410 0x042F))</span> prints
out all the Cyrillic capital letters, which happen to lie on that
range on the Unicode spectrum:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(\</span>А <span style="color: #990000">\</span>Б <span style="color: #990000">\</span>В <span style="color: #990000">\</span>Г <span style="color: #990000">\</span>Д <span style="color: #990000">\</span>Е <span style="color: #990000">\</span>Ж <span style="color: #990000">\</span>З <span style="color: #990000">\</span>И <span style="color: #990000">\</span>Й <span style="color: #990000">\</span>К <span style="color: #990000">\</span>Л <span style="color: #990000">\</span>М <span style="color: #990000">\</span>Н <span style="color: #990000">\</span>О <span style="color: #990000">\</span>П <span style="color: #990000">\</span>Р <span style="color: #990000">\</span>С <span style="color: #990000">\</span>Т <span style="color: #990000">\</span>У <span style="color: #990000">\</span>Ф
<span style="color: #990000">\</span>Х <span style="color: #990000">\</span>Ц <span style="color: #990000">\</span>Ч <span style="color: #990000">\</span>Ш <span style="color: #990000">\</span>Щ <span style="color: #990000">\</span>Ъ <span style="color: #990000">\</span>Ы <span style="color: #990000">\</span>Ь <span style="color: #990000">\</span>Э <span style="color: #990000">\</span>Ю<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">char</span> and <span class="monospaced">int</span> functions are useful primarily for coercing a
number into an instance of either <span class="monospaced">java.lang.Integer</span> or
<span class="monospaced">java.lang.Character</span>. Both <span class="monospaced">Integer</span>s and <span class="monospaced">Character</span>s are,
ultimately, encoded as numbers, although <span class="monospaced">Character</span>s support
additional text-related methods and cannot be used in mathematic
expressions without first being converted to a true numeric type.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_5">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://oreil.ly/unicode-explained"><em>Unicode Explained</em></a>, by Jukka K. Korpela (O&#8217;Reilly), for truly comprehensive coverage of how Unicode and internationalization works
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_seq_of_chars">[sec_primitives_strings_seq_of_chars]</a>, for details on working with the characters that constitute a string
</p>
</li>
<li>
<p>
<a href="#sec_primitives_numbers_parsing_numbers">[sec_primitives_numbers_parsing_numbers]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_strings_formatting_strings">Formatting Strings</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_6">Problem</h4>
<div class="paragraph"><p>You need to insert values into a string, formatting how those values appear in the string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_6">Solution</h4>
<div class="paragraph"><p>The quickest method for formatting values into a string is the <span class="monospaced">str</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> me {<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name <span style="color: #FF0000">"Ryan"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>favorite<span style="color: #990000">-</span>language <span style="color: #FF0000">"Clojure"</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"My name is "</span> <span style="color: #990000">(:</span>first<span style="color: #990000">-</span>name me<span style="color: #990000">)</span>
     <span style="color: #FF0000">", and I really like to program in "</span> <span style="color: #990000">(:</span>favorite<span style="color: #990000">-</span>language me<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "My name is Ryan, and I really like to program in Clojure"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(interpose</span></span> <span style="color: #FF0000">" "</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2.000</span> <span style="color: #990000">(/</span> <span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">(/</span> <span style="color: #993399">4</span> <span style="color: #993399">9</span><span style="color: #990000">)]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1 2.0 3 4/9"</span></span></tt></pre></div></div>
<div class="paragraph"><p>With <span class="monospaced">str</span>, however, values are inserted blindly, appearing in their
default <span class="monospaced">.toString()</span> appearance. Not only that, but it can sometimes be
difficult to look at a <span class="monospaced">str</span> form and interpret what the intended
output is.</p></div>
<div class="paragraph"><p>For greater control over how values are printed, use the <span class="monospaced">format</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Produce a filename with a zero-padded sortable index</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> filename <span style="color: #990000">[</span>name i<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"%03d-%s"</span> i name<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(filename</span></span> <span style="color: #FF0000">"my-awesome-file.txt"</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "042-my-awesome-file.txt"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create a table using justification</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> tableify <span style="color: #990000">[</span>row<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> format <span style="color: #FF0000">"%-20s | %-20s | %-20s"</span> row<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> header <span style="color: #990000">[</span><span style="color: #FF0000">"First Name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Last Name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Employee ID"</span><span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> employees <span style="color: #990000">[[</span><span style="color: #FF0000">"Ryan"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Neufeld"</span><span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">]</span>
                <span style="color: #990000">[</span><span style="color: #FF0000">"Luke"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Vanderhart"</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">]])</span>

<span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(concat</span></span> <span style="color: #990000">[</span>header<span style="color: #990000">]</span> employees<span style="color: #990000">)</span>
     <span style="font-weight: bold"><span style="color: #000000">(map</span></span> tableify<span style="color: #990000">)</span>
     <span style="font-weight: bold"><span style="color: #000000">(mapv</span></span> println<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; First Name           | Last Name            | Employee ID</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Ryan                 | Neufeld              | 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Luke                 | Vanderhart           | 1</span></span></tt></pre></div></div>
<?hard-pagebreak?>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">0</span> flag indicates to pad a digit (<span class="monospaced">d</span>) with zeros (three, in this case).
</p>
</li>
<li>
<p>
The <span class="monospaced">-</span> flag indicates to left justify the string (<span class="monospaced">s</span>), giving it a total minimum width of 20 characters.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_discussion_6">Discussion</h4>
<div class="paragraph"><p>When it comes to inserting values into a string, you have two very
different options. You can use <span class="monospaced">str</span>, which is great for a quick
fix but lacks control over how values are presented. Or you can
use <span class="monospaced">format</span>, which exposes fine-grained control over how values are
displayed but requires knowledge of C and Java-style formatting
strings. Ultimately, you should use only as much tooling/complexity
as is necessary for the task at hand: stick to <span class="monospaced">str</span> when the default
formatting for a value will suffice, and use <span class="monospaced">format</span> when you need
more control over how values display.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Format Strings</div>
<div class="paragraph"><p>The first argument passed to <span class="monospaced">format</span> is what is
called a <em>format string</em>. The syntax for these strings isn&#8217;t new or
unique to Clojure or even Java, but in fact comes from C&#8217;s <span class="monospaced">printf</span>
function. Clojure&#8217;s <span class="monospaced">format</span> function uses Java&#8217;s <span class="monospaced">String/format</span>,
which implements <span class="monospaced">printf</span>-style value substitution.</p></div>
<div class="paragraph"><p>A format string is a normal string with any number of embedded format
specifiers. A format specifier is a placeholder to be replaced by a
value later. In its simplest form, this is a <span class="monospaced">%</span> followed by
a type specifier character; for example, <span class="monospaced">%d</span> for an integer (<em>d</em> is for digit) or <span class="monospaced">%f</span>
for a float. Beyond specifiers for strings, integers, and floats, there are specifiers for characters, dates, and numbers of different bases (octal and hexadecimal), to name a few.</p></div>
<div class="paragraph"><p>What makes these format specifiers special is that you may indicate
any number of flags and options between the percent sign and the
specifier character. For instance, "<span class="monospaced">%-10s</span>" indicates the
provided string (<span class="monospaced">s</span>) should be left justified (<span class="monospaced">-</span>) with a total
minimum width of 10. "<span class="monospaced">%07.3f</span>" would turn a number into a zero-padded
number that was seven characters wide and included three decimal
places (just like the numbers used in the Dewey Decimal system):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"%07.3f"</span> <span style="color: #993399">0.005</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "000.005" ;; The Dewey Decimal subclass for books on "Computer</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;              ;; programming, programs &amp; data"</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>Visit the API documentation for <a href="http://bit.ly/javadoc-formatter"><span class="monospaced">java.util.Formatter</span></a> to learn more about formatting strings.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_6">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_building_strings_from_parts">[sec_primitives_building_strings_from_parts]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_formatting_dates">[sec_primitives_dates_formatting_dates]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_strings_re_find">Searching a String by Pattern</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_7">Problem</h4>
<div class="paragraph"><p>You need to test a string to see if parts of it match a pattern.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_7">Solution</h4>
<div class="paragraph"><p>To check for the presence of a pattern inside a string, invoke
<span class="monospaced">re-find</span> with a desired pattern and the string to test. Express the
desired pattern using a regular expression literal (like <span class="monospaced">"foo"</span> or
<span class="monospaced">"\d+"</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Any contiguous groups of numbers</span></span>
<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>find #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">"I've just finished reading Fahrenheit 451"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "451"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>find #<span style="color: #FF0000">"Bees"</span> <span style="color: #FF0000">"Beads aren't cheap."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_7">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">re-find</span> is quite handy for quickly testing a string for the presence
of a pattern. It takes a regular expression pattern and a string, then
returns either the first match of that pattern or <span class="monospaced">nil</span>.</p></div>
<div class="paragraph"><p>If your criterion is more stringent and you require that the <em>entire</em>
string match a pattern, use <span class="monospaced">re-matches</span>. Unlike <span class="monospaced">re-find</span>,
which matches any portion of a string, <span class="monospaced">re-matches</span> matches if and
only if the <em>entire</em> string matches the pattern:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; In re-find, #"\w+" is any contiguous word characters</span></span>
<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>find #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">"my-param"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "my"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; But in re-matches, #"\w+" means "all word characters"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>matches #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">"my-param"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>matches #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">"justLetters"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "justLetters"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_7">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The
  <a href="http://bit.ly/javadoc-pattern">API
  documentation</a> for <span class="monospaced">java.lang.Pattern</span>, which defines the exact
  regex syntax supported by Java (and Clojure&#8217;s regular expression literals)
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_re_matches">[sec_primitives_strings_re_matches]</a>, for information on extracting
  values from a string using regular expressions
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_find_replace">[sec_primitives_strings_find_replace]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_strings_re_matches">Pulling Values Out of a String Using Regular Expressions</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_8">Problem</h4>
<div class="paragraph"><p>You need to extract portions of a string matching a given pattern.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_8">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">re-seq</span> with a regular expression pattern and a string to retrieve
a sequence of successive matches:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Extract simple words from a sentence</span></span>
<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>seq #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+"</span> <span style="color: #FF0000">"My Favorite Things"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("My" "Favorite" "Things")</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Extract simple 7-digit phone numbers</span></span>
<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>seq #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">{3}-</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">{4}"</span> <span style="color: #FF0000">"My phone number is 555-1234."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("555-1234")</span></span></tt></pre></div></div>
<div class="paragraph"><p>Regular expressions with matching groups (parentheses) will return a
vector for each total match:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Extract all of the Twitter usernames and hashtags in a tweet</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mentions <span style="color: #990000">[</span>tweet<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>seq #<span style="color: #FF0000">"(@|#)(</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+)"</span> tweet<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(mentions</span></span> <span style="color: #FF0000">"So long, @earth, and thanks for all the #fish. #goodbyes"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["@earth" "@" "earth"] ["#fish" "#" "fish"] ["#goodbyes" "#" "goodbyes"])</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_8">Discussion</h4>
<div class="paragraph"><p>Provided a simple pattern (one without matching groups), <span class="monospaced">re-seq</span>
will return a flat sequence of matches. Fully expressing the power of Clojure, this is a
lazy sequence. Calling <span class="monospaced">re-seq</span> on a gigantic string will not scan the
entire string right away; you&#8217;re free to consume those values
incrementally, or defer evaluation to some other constituent part of your
application further down the road.</p></div>
<div class="paragraph"><p>When given a regular expression containing matching groups, <span class="monospaced">re-seq</span> will do
something a little different. Don&#8217;t worry, the resulting sequence is
still lazy&#8212;but instead of flat strings, its values will be vectors.
The first value of the vector will always be the whole match, grouped
or not; subsequent values will be the strings captured by matching
group parentheses. These captured values will appear in the order in which their
opening parentheses appeared, despite any nesting. Take a look at this
example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Using re to capture and decompose a phone number and its title</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> re<span style="color: #990000">-</span>phone<span style="color: #990000">-</span>number #<span style="color: #FF0000">"(</span><span style="color: #CC33CC">\w</span><span style="color: #FF0000">+): </span><span style="color: #CC33CC">\(</span><span style="color: #FF0000">(</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">{3})</span><span style="color: #CC33CC">\)</span><span style="color: #FF0000"> (</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">{3}-</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">{4})"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>seq re<span style="color: #990000">-</span>phone<span style="color: #990000">-</span>number <span style="color: #FF0000">"Home: (919) 555-1234, Work: (191) 555-1234"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["Home: (919) 555-1234" "Home" "919" "555-1234"]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ["Work: (191) 555-1234" "Work" "191" "555-1234"])</span></span></tt></pre></div></div>
<div class="paragraph"><p>If all you&#8217;re looking for is a single match from a string, then use
<span class="monospaced">re-find</span>. It behaves almost identically to <span class="monospaced">re-seq</span>, but returns only
the first match as a singular value, instead of a sequence of match values.</p></div>
<div class="paragraph"><p>Apart from <span class="monospaced">re-seq</span>, there is another way to iterate over the matches
in a string. You <em>could</em> do this by repeatedly calling <span class="monospaced">re-find</span> on a
<span class="monospaced">re-matcher</span>, but we don&#8217;t suggest this approach. Why? Because it
isn&#8217;t very idiomatic Clojure. Mutating a <span class="monospaced">re-matcher</span> object with
repeated calls to <span class="monospaced">re-find</span> is just wrong; it completely violates the
principle of pure functions. We highly suggest you prefer <span class="monospaced">re-seq</span>
over <span class="monospaced">re-matcher</span> and <span class="monospaced">re-find</span> unless you have a really good reason
not to.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_8">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_strings_re_find">[sec_primitives_strings_re_find]</a>, for testing a string for the
  presence of a pattern
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_find_replace">[sec_primitives_strings_find_replace]</a>, for information on using
  regular expressions to find and replace portions of a string
</p>
</li>
<li>
<p>
The
  <a href="http://bit.ly/javadoc-pattern">API
  documentation</a> for <span class="monospaced">java.lang.Pattern</span>, which defines the exact
  regex syntax supported by Java (and Clojure&#8217;s regular expression literals)
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_strings_find_replace">Performing Find and Replace on Strings</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_9">Problem</h4>
<div class="paragraph"><p>You need to modify portions of a string that match some well-defined pattern.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_9">Solution</h4>
<div class="paragraph"><p>The versatile <span class="monospaced">clojure.string/replace</span> is the function you should
reach for when you need to selectively replace portions of a string.</p></div>
<div class="paragraph"><p>For simple patterns, use <span class="monospaced">replace</span> with a normal string as its matcher:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> about<span style="color: #990000">-</span>me <span style="color: #FF0000">"My favorite color is green!"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace about<span style="color: #990000">-</span>me <span style="color: #FF0000">"green"</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "My favorite color is red!"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> de<span style="color: #990000">-</span>canadianize <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace s <span style="color: #FF0000">"ou"</span> <span style="color: #FF0000">"o"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(de</span></span><span style="color: #990000">-</span>canadianize <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Those Canadian neighbours have coloured behaviour"</span>
                     <span style="color: #FF0000">" when it comes to word endings"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Those Canadian neighbors have colored behavior when it comes to word</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     endings"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Plain string replacement will only get you so far. When you need to
replace a pattern with some variability to it, you&#8217;ll need to reach for
the big guns: regular expressions. Use Clojure&#8217;s regular expression
literals (<literal>#"..."</literal>) to specify a pattern as a regular expression:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> linkify<span style="color: #990000">-</span>comment
  <span style="color: #FF0000">"Add Markdown-style links for any GitHub issue numbers present in comment"</span>
  <span style="color: #990000">[</span>repo comment<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace comment
                          #<span style="color: #FF0000">"#(</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">+)"</span>
                          <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"[#$1](https://github.com/"</span> repo <span style="color: #FF0000">"/issues/$1)"</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(linkify</span></span><span style="color: #990000">-</span>comment <span style="color: #FF0000">"next/big-thing"</span> <span style="color: #FF0000">"As soon as we fix #42 and #1337 we</span>
<span style="color: #FF0000">should be set to release!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "As soon as we fix</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [#42](https://github.com/next/big-thing/issues/42) and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [#1337](https://github.com/next/big-thing/issues/1337) we</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     should be set to release!"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_9">Discussion</h4>
<div class="paragraph"><p>As far as string functions go, <span class="monospaced">replace</span> is one of the more powerful and most complex ones. The majority of this complexity arises from the varying <span class="monospaced">match</span> and <span class="monospaced">replacement</span> types it can operate with.</p></div>
<div class="paragraph"><p>When passed a string <span class="monospaced">match</span>, <span class="monospaced">replace</span> expects a string <span class="monospaced">replacement</span>. Any occurrences of <span class="monospaced">match</span> in the supplied string will be replaced directly with <span class="monospaced">replacement</span>.</p></div>
<div class="paragraph"><p>When passed a character <span class="monospaced">match</span> (such as <span class="monospaced">\c</span> or <span class="monospaced">\n</span>), <span class="monospaced">replace</span> expects a character <span class="monospaced">replacement</span>. Like string/string, the character/character mode of <span class="monospaced">replace</span> replaces items directly.</p></div>
<div class="paragraph"><p>When passed a regular expression for a match, <span class="monospaced">replace</span> gets much more interesting. One possible <span class="monospaced">replacement</span> for a regex match is a string, like in the <span class="monospaced">linkify-comment</span> example; this string interprets special character combinations like <span class="monospaced">$1</span> or <span class="monospaced">$2</span> as variables to be replaced by matching groups in the match. In the <span class="monospaced">linkify-comment</span> example, any contiguous digits (<span class="monospaced">\d</span>+) following a number sign (<span class="monospaced">#</span>) are captured in parentheses and are available as <span class="monospaced">$1</span> in the replacement.</p></div>
<div class="paragraph"><p>When passing a regex <span class="monospaced">match</span>, you can also provide a function for replacement instead of a string. In Clojure, the world is your oyster when you can pass a function as an argument. You can capture your replacement in a reusable (and testable) function, pass in different functions depending on the circumstances, or even pass a map that dictates replacements:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; linkify-comment rewritten with linkification as a separate function</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> linkify <span style="color: #990000">[</span>repo <span style="color: #990000">[</span>full<span style="color: #990000">-</span>match id<span style="color: #990000">]]</span>
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"["</span> full<span style="color: #990000">-</span>match <span style="color: #FF0000">"](https://github.com/"</span> repo <span style="color: #FF0000">"/issues/"</span> id <span style="color: #FF0000">")"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> linkify<span style="color: #990000">-</span>comment <span style="color: #990000">[</span>repo comment<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>replace comment #<span style="color: #FF0000">"#(</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">+)"</span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> linkify repo<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;ve not used regular expressions before, then you&#8217;re in for a
treat. Regexes are a powerful tool for modifying strings with
unbounded flexibility. As with any powerful new tool, it&#8217;s easy to
overdo it. Because of their terse and compact syntax, it&#8217;s very easy
to produce regexes that are both difficult to interpret and at a high
risk of being incorrect. You should use regular expressions sparingly
and only if you fully understand their syntax.</p></div>
<div class="paragraph"><p>Jeffrey Friedl&#8217;s <a href="http://oreil.ly/Mastering_RegEx"><em>Mastering Regular Expressions</em>, 3rd ed.</a> (O&#8217;Reilly) is a fantastic book for learning and mastering regular expression syntax.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_9">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_strings_re_find">[sec_primitives_strings_re_find]</a>
</p>
</li>
<li>
<p>
<span class="monospaced">clojure.string/replace-first</span>, a function that operates nearly identically to <span class="monospaced">clojure.string/replace</span> but only replaces the first occurrence of <span class="monospaced">match</span>
</p>
</li>
<li>
<p>
The
  <a href="http://bit.ly/javadoc-pattern">API
  documentation</a> for <span class="monospaced">java.lang.Pattern</span>, which defines the exact
  regex syntax supported by Java (and Clojure&#8217;s regular-expression literals)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_splitting_a_string_into_parts">Splitting a String into Parts</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_10">Problem</h4>
<div class="paragraph"><p>You need to split a string into a number of parts.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_10">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">clojure.string/split</span> to tokenize a string into a vector of tokens. <span class="monospaced">split</span> takes two arguments, a string to tokenize and a regular expression to split on:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"HEADER1,HEADER2,HEADER3"</span> #<span style="color: #FF0000">","</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["HEADER1" "HEADER2" "HEADER3"]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"Spaces   Newlines</span><span style="color: #CC33CC">\n\n</span><span style="color: #FF0000">"</span> #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\s</span><span style="color: #FF0000">+"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["Spaces" "Newlines"]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_10">Discussion</h4>
<div class="paragraph"><p>In addition to just naively splitting on a regular expression, <span class="monospaced">split</span>
allows you to control how many (or how few) times to split the
provided string. You can control this with the optional <span class="monospaced">limit</span>
argument. The most obvious effect of <span class="monospaced">limit</span> is to limit the number of
values returned in the resulting collection. That said, <span class="monospaced">limit</span>
doesn&#8217;t always work like you would expect, and even the absence of
this argument carries a meaning.</p></div>
<div class="paragraph"><p>Without <span class="monospaced">limit</span>, the <span class="monospaced">split</span> function will return every possible
delimitation but exclude any trailing empty matches:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Splitting on whitespace without an explicit limit performs an implicit trim</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"field1    field2 field3   "</span> #<span style="color: #FF0000">"</span><span style="color: #CC33CC">\s</span><span style="color: #FF0000">+"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["field1" "field2" "field3"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you want absolutely every match, including trailing empty ones, then you can specify <span class="monospaced">-1</span> as the limit:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; In CSV parsing an empty match at the end of a line is still a meaningful one</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"ryan,neufeld,"</span> #<span style="color: #FF0000">","</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["ryan" "neufeld" ""]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Specifying some other positive number as a <span class="monospaced">limit</span> will cause <span class="monospaced">split</span> to return at maximum <span class="monospaced">limit</span> substrings:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> data<span style="color: #990000">-</span>delimiters #<span style="color: #FF0000">"[ :-]"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; No-limit split on any delimiter</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"2013-04-05 14:39"</span> data<span style="color: #990000">-</span>delimiters<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["2013" "04" "05" "14" "39"]</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Limit of 1 - functionally: return this string in a collection</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"2013-04-05 14:39"</span> data<span style="color: #990000">-</span>delimiters <span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["2013-04-05 14:39"]</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Limit of 2</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"2013-04-05 14:39"</span> data<span style="color: #990000">-</span>delimiters <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["2013" "04-05 14:39"]</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Limit of 100</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"2013-04-05 14:39"</span> data<span style="color: #990000">-</span>delimiters <span style="color: #993399">100</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["2013" "04" "05" "14" "39"]</span></span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_10">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.string</span> namespace
  <a href="http://bit.ly/clj-string-api">API documentation</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_re_find">[sec_primitives_strings_re_find]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_strings_re_matches">[sec_primitives_strings_re_matches]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_pluralizing_strings_based_on_a_quantity">Pluralizing Strings Based on a Quantity</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_11">Problem</h4>
<div class="paragraph"><p>You need to pluralize a word given some quantity, such as "0 eggs" or
"1 chicken."</p></div>
</div>
<div class="sect3">
<h4 id="_solution_11">Solution</h4>
<div class="paragraph"><p>When you need to perform Ruby on Rails&#x2013;style pluralization, use Roman Scherer&#8217;s
<a href="https://github.com/r0man/inflections-clj"><span class="monospaced">inflections</span></a> library.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:<span class="footnote"><br>[If
you haven&#8217;t already installed <span class="monospaced">lein-try</span>, follow the instructions in
<a href="#sec_lein_try">[sec_lein_try]</a>.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try inflections</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">inflections.core/pluralize</span> with a count to attempt to pluralize
that word if the count is not one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>inflections<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as inf<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>pluralize <span style="color: #993399">1</span> <span style="color: #FF0000">"monkey"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1 monkey"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>pluralize <span style="color: #993399">12</span> <span style="color: #FF0000">"monkey"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "12 monkeys"</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you have a special or nonstandard pluralization, you can provide
your own pluralization as an optional third argument to <span class="monospaced">pluralize</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>pluralize <span style="color: #993399">1</span> <span style="color: #FF0000">"box"</span> <span style="color: #FF0000">"boxen"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1 box"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>pluralize <span style="color: #993399">3</span> <span style="color: #FF0000">"box"</span> <span style="color: #FF0000">"boxen"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "3 boxen"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_11">Discussion</h4>
<div class="paragraph"><p>When it comes to user-facing text, inflection is key. Humanizing the
output of your programs or websites goes a long way to building a
trustworthy and professional image. <a href="http://rubyonrails.org">Ruby on
Rails</a> set the gold standard for friendly and humanized text with its
<span class="monospaced">ActiveSupport::Inflections</span> class. <span class="monospaced">Inflections#pluralize</span> is one
such inflection, but <span class="monospaced">Inflections</span> is chock-full of cutesy-sounding
methods ending in "ize" that change the inflection of strings.
<span class="monospaced">inflections</span> provides nearly all of these capabilities in a Clojure context.</p></div>
<div class="paragraph"><p>Two interesting functions in the <span class="monospaced">inflections</span> library are <span class="monospaced">plural</span> and
<span class="monospaced">singular</span>. These functions work a bit like the <span class="monospaced">upper-case</span> and
<span class="monospaced">lower-case</span> of pluralization; <span class="monospaced">plural</span> transforms words into their
plural form, and <span class="monospaced">singular</span> coerces words to their singular form. These
transformations are based on a number of rules in
<span class="monospaced">inflections.plural</span>.</p></div>
<div class="paragraph"><p>You can add your own rules for pluralization with <span class="monospaced">inflections.core/plural!</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>plural <span style="color: #FF0000">"box"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "boxes"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Words ending in 'ox' pluralize with 'en' (and not 'es')</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>plural<span style="color: #990000">!</span> #<span style="color: #FF0000">"(ox)(?i)$"</span> <span style="color: #FF0000">"$1en"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>plural <span style="color: #FF0000">"box"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "boxen"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; plural is also the basis for pluralize...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>pluralize <span style="color: #993399">2</span> <span style="color: #FF0000">"box"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "2 boxen"</span></span></tt></pre></div></div>
<div class="paragraph"><p>The library also has support for inflections like <span class="monospaced">camelize</span>,
<span class="monospaced">parameterize</span>, and <span class="monospaced">ordinalize</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Convert "snake_case" to "CamelCase"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>camelize <span style="color: #FF0000">"my_object"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "MyObject"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Clean strings for usage as URL parameters</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>parameterize <span style="color: #FF0000">"My most favorite URL!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "my-most-favorite-url"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Turn numbers into ordinal numbers</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inf</span></span><span style="color: #990000">/</span>ordinalize <span style="color: #993399">42</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "42nd"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_11">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/r0man/inflections-clj/"><span class="monospaced">inflections-clj</span> GitHub repository</a> for the most up-to-date listing of inflections available
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_converting_between_strings_symbols_and_keywords">Converting Between Strings, Symbols, and Keywords</h3>
<div class="paragraph byline"><p>by Colin Jones</p></div>
<div class="sect3">
<h4 id="_problem_12">Problem</h4>
<div class="paragraph"><p>You have a string, a symbol, or a keyword and you&#8217;d like to convert it into a
different one of these string-like data types.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_12">Solution</h4>
<div class="paragraph"><p>To convert from a string to a symbol, use the <span class="monospaced">symbol</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(symbol</span></span> <span style="color: #FF0000">"valid?"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; valid?</span></span></tt></pre></div></div>
<div class="paragraph"><p>To convert from a symbol to a string, use <span class="monospaced">str</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(str</span></span> 'valid<span style="color: #990000">?)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "valid?"</span></span></tt></pre></div></div>
<div class="paragraph"><p>When you have a keyword and want a string, you can use <span class="monospaced">name</span>, or <span class="monospaced">str</span> if you
want the leading colon:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(name</span></span> <span style="color: #990000">:</span>triumph<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "triumph"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Or, to include the leading colon:</span></span>
<span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #990000">:</span>triumph<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ":triumph"</span></span></tt></pre></div></div>
<div class="paragraph"><p>To convert from a symbol or string to a keyword, use <span class="monospaced">keyword</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(keyword</span></span> <span style="color: #FF0000">"fantastic"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :fantastic</span></span>

<span style="font-weight: bold"><span style="color: #000000">(keyword</span></span> 'fantastic<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :fantastic</span></span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll need an intermediate step, through <span class="monospaced">name</span>, to go from keyword to symbol:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(symbol</span></span> <span style="font-weight: bold"><span style="color: #000000">(name</span></span> <span style="color: #990000">:</span>wonderful<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; wonderful</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_12">Discussion</h4>
<div class="paragraph"><p>The primary conversion functions here are <span class="monospaced">str</span>, <span class="monospaced">keyword</span>, and <span class="monospaced">symbol</span>&#x2014;each
named for the data type it returns. One of these, <span class="monospaced">symbol</span>, is a bit more
strict in terms of the input it allows: it must take a string, which is why you
need the extra step in the keyword-to-symbol conversion.</p></div>
<div class="paragraph"><p>There is another class of differences among these types: namely, that keywords
and symbols may be namespaced, signified by a slash (/) in the middle. For these
kinds of keywords and symbols, the <span class="monospaced">name</span> function may or may not be
sufficient to convert to a string, depending on your use case:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; If you only want the name part of a keyword</span></span>
<span style="font-weight: bold"><span style="color: #000000">(name</span></span> <span style="color: #990000">:</span>user<span style="color: #990000">/</span>valid<span style="color: #990000">?)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "valid?"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; If you only want the namespace</span></span>
<span style="font-weight: bold"><span style="color: #000000">(namespace</span></span> <span style="color: #990000">:</span>user<span style="color: #990000">/</span>valid<span style="color: #990000">?)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "user"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Very often, you actually want both parts. You could collect them separately
and concatenate the strings with a <span class="monospaced">/</span> in the middle, but there&#8217;s an easier
way. Java has a rich set of performant methods for dealing with immutable
strings. You can take the leading-colon string and lop off the first
character with <span class="monospaced">java.lang.String.substring(int)</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #990000">:</span>user<span style="color: #990000">/</span>valid<span style="color: #990000">?)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ":user/valid?"</span></span>

<span style="color: #990000">(.</span>substring <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #990000">:</span>user<span style="color: #990000">/</span>valid<span style="color: #990000">?)</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "user/valid?"</span></span></tt></pre></div></div>
<div class="paragraph"><p>See the <a href="http://bit.ly/javadoc-string"><span class="monospaced">java.lang.String</span> API documentation</a> for more string methods.</p></div>
<div class="paragraph"><p>You can convert namespaced symbols to keywords just as easily as their
non-namespaced counterparts, but again, converting in the other direction
(keyword to symbol) takes an extra step:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(keyword</span></span> 'produce<span style="color: #990000">/</span>onions<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :produce/onions</span></span>

<span style="font-weight: bold"><span style="color: #000000">(symbol</span></span> <span style="color: #990000">(.</span>substring <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #990000">:</span>produce<span style="color: #990000">/</span>onions<span style="color: #990000">)</span> <span style="color: #993399">1</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; produce/onions</span></span></tt></pre></div></div>
<div class="paragraph"><p>And finally, both the <span class="monospaced">keyword</span> and <span class="monospaced">symbol</span> functions have two-argument versions
that allow you to pass in the namespace and name separately. Sometimes this is
nicer&#8212;for example, when you already have one or both of the values bound in a
<span class="monospaced">def</span>, <span class="monospaced">let</span>, or other binding:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> shopping<span style="color: #990000">-</span>area <span style="color: #FF0000">"bakery"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(keyword</span></span> shopping<span style="color: #990000">-</span>area <span style="color: #FF0000">"bagels"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :bakery/bagels</span></span>

<span style="font-weight: bold"><span style="color: #000000">(symbol</span></span> shopping<span style="color: #990000">-</span>area <span style="color: #FF0000">"cakes"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; bakery/cakes</span></span></tt></pre></div></div>
<div class="paragraph"><p>These three string-like data types are all great for different situations, and
how to choose among them is another topic. But it&#8217;s quite common to need to
convert among them, so <span class="monospaced">keyword</span>, <span class="monospaced">symbol</span>, <span class="monospaced">str</span>, <span class="monospaced">namespace</span>, and <span class="monospaced">name</span> are
handy to have in your tool belt.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_12">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_converting_characters_integers">[sec_primitives_converting_characters_integers]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_math_arbitrary_precision">Maintaining Accuracy with Extremely Large/Small Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_13">Problem</h4>
<div class="paragraph"><p>You need to work precisely with numbers, especially those that are
very large or very small, without the imprecision implied by using
floating-point representations such as <span class="monospaced">double</span> values.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_13">Solution</h4>
<div class="paragraph"><p>First, know that Clojure supports exponents as literal numbers, allowing you to succinctly express large/small numbers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Avogadro's number</span></span>
<span style="color: #993399">6.0221413e23</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 6.0221413E23</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; 1 Angstrom in meters</span></span>
<span style="color: #993399">1e-10</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1.0E-10</span></span></tt></pre></div></div>
<div class="paragraph"><p>Integer values passing the upper bound of a size-bounded type (like <span class="monospaced">long</span>) will raise an integer overflow error.
Use the "quote" versions of numeric operations like <span class="monospaced">-</span> or <span class="monospaced">*</span> to allow promotion to <span class="monospaced">Big</span> types:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(*</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; ArithmeticException integer overflow  clojure.lang.Numbers.throwIntOverflow</span></span>

<span style="color: #990000">(*</span>' <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span> <span style="color: #993399">9999</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 99950009999000049999N</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_13">Discussion</h4>
<div class="paragraph"><p>Clojure has a number of numeric types: integer and <span class="monospaced">long</span>, <span class="monospaced">double</span>, and
<span class="monospaced">BigInteger</span> and <span class="monospaced">BigDecimal</span>. The bounded types (<span class="monospaced">int</span>, <span class="monospaced">long</span>, and
<span class="monospaced">double</span>) all seamlessly transition as needed while inside the <em>total</em>
bounds of those types. Exceeding those bounds causes one of two things
to happen. For integers, an integer overflow error is raised. For
floating-point numbers, the result will become <span class="monospaced">Infinity</span>. With
integers, you can avoid this error by using quote versions of <span class="monospaced">+</span>,
<span class="monospaced">-</span>, <span class="monospaced">*</span>, and <span class="monospaced">/</span>. These operations support arbitrary precision and
will promote integers to <span class="monospaced">BigInteger</span> if necessary.</p></div>
<div class="paragraph"><p>Floating-point values are a little more tricky. The quote versions
of numeric operations won&#8217;t help here; you&#8217;ll need to infect your
operations with the <span class="monospaced">BigDecimal</span> type. In Clojure, the <span class="monospaced">BigInteger</span>
and <span class="monospaced">BigDecimal</span> types are what you would call "contagious." Once a
"big" number is introduced to an operation, it infects all of the
follow-on results. You <em>could</em> do something like multiplying a number
by a <span class="monospaced">BigDecimal</span> 1, but it&#8217;s much easier to use the <span class="monospaced">bigdec</span> or
<span class="monospaced">bigint</span> functions to promote a value manually:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(*</span> <span style="color: #993399">2</span> Double<span style="color: #990000">/</span>MAX_VALUE<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; Double/POSITIVE_INFINITY</span></span>

<span style="color: #990000">(*</span> <span style="color: #993399">2</span> <span style="font-weight: bold"><span style="color: #000000">(bigdec</span></span> Double<span style="color: #990000">/</span>MAX_VALUE<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.5953862697246314E+308M</span></span></tt></pre></div></div>
<div class="paragraph"><p>Contagion doesn&#8217;t only occur with <span class="monospaced">Big</span> types; it also pops up in the
integer-to&#x2013;floating-point boundary. Floating-point numbers are
contagious to integers. Arithmetic involving <em>any</em> floating-point
values will always return a floating-point value.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_13">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_rational_numbers">[sec_primitives_rational_numbers]</a>, for information on maintaining accuracy when using rational numbers
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_rational_numbers">Working with Rational Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_14">Problem</h4>
<div class="paragraph"><p>You need to manipulate fractional numbers with absolute precision.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_14">Solution</h4>
<div class="paragraph"><p>When manipulating integers (or other rationals), you can expect to maintain precision, including recurring fractions like 1/3 (0.333&#8230;):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1/3</span></span>

<span style="font-weight: bold"><span style="color: #000000">(type</span></span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; clojure.lang.Ratio</span></span>

<span style="color: #990000">(*</span> <span style="color: #993399">3</span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1N</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">rationalize</span> on <literal>double</literal>s to coerce them to rationals to avoid losing precision:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(+</span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">)</span> <span style="color: #993399">0.3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.6333333333333333</span></span>

<span style="font-weight: bold"><span style="color: #000000">(rationalize</span></span> <span style="color: #993399">0.3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3/10</span></span>

<span style="color: #990000">(+</span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(rationalize</span></span> <span style="color: #993399">0.3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 19/30</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_14">Discussion</h4>
<div class="paragraph"><p>Clojure does its best to help you retain accuracy when working with
numbers, especially integers. When dividing integers, Clojure maintains
accuracy by expressing the quotient as an accurate ratio
of integers instead of a lossy <span class="monospaced">double</span>. This accuracy isn&#8217;t without a
cost, though; operations on rational numbers are much slower than
operations on simpler types. As is discussed in
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>, accuracy is always a
trade-off for performance, and is something you need to consider given
the problem at hand.</p></div>
<div class="paragraph"><p>When operating on both <literal>double</literal>s and rationals at the same time, care is
advised; on account of the way type contagion works in Clojure,
performing an operation over both types will cause the rational number
to be coerced to a <span class="monospaced">double</span>. This transition isn&#8217;t necessarily inaccurate
for a single operation, but the change in type introduces the
possibility for inaccuracy to creep in.</p></div>
<div class="paragraph"><p>To maintain accuracy when working with <literal>double</literal>s, use the <span class="monospaced">rationalize</span>
function. This function returns the rational value of any number. Calling <span class="monospaced">rationalize</span> on any values that might possibly be <literal>double</literal>s will allow you to maintain absolute accuracy (at the cost of performance).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_14">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_numbers_parsing_numbers">Parsing Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_15">Problem</h4>
<div class="paragraph"><p>You need to parse numbers out of strings.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_15">Solution</h4>
<div class="paragraph"><p>For "normal&#8221;-sized large or precise numbers, use <span class="monospaced">Integer/parseInt</span> or
<span class="monospaced">Double/parseDouble</span> to parse them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>parseInt <span style="color: #FF0000">"-42"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -42</span></span>

<span style="font-weight: bold"><span style="color: #000000">(Double</span></span><span style="color: #990000">/</span>parseDouble <span style="color: #FF0000">"3.14"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.14</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_15">Discussion</h4>
<div class="paragraph"><p>What is a "normal&#8221;-sized number? For <span class="monospaced">Integer/parseInt</span>, normal is anything below
<span class="monospaced">Integer/MAX_VALUE</span> (2147483647); and for <span class="monospaced">Double/parseDouble</span>, it&#8217;s anything below
<phrase role='keep-together'><literal>Double/MAX_VALUE</literal></phrase> (around 1.79 &#x00D7; 10^308).functions</p></div>
<div class="paragraph"><p>When the numbers you are parsing are either abnormally large or
abnormally precise, you&#8217;ll need to parse them with <span class="monospaced">BigInteger</span>
or <span class="monospaced">BigDecimal</span> to avoid losing precision. The versatile <span class="monospaced">bigint</span> and
<span class="monospaced">bigdec</span> functions can coerce strings (or any other numerical types, for
that matter) into infinite-precision containers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(bigdec</span></span> <span style="color: #FF0000">"3.141592653589793238462643383279502884197"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.141592653589793238462643383279502884197M</span></span>

<span style="font-weight: bold"><span style="color: #000000">(bigint</span></span> <span style="color: #FF0000">"122333444455555666666777777788888888999999999"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 122333444455555666666777777788888888999999999N</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_15">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The API documentation for <a href="http://bit.ly/javadoc-parseInt"><span class="monospaced">Integer/parseInt</span></a> and <a href="http://bit.ly/javadoc-parseDouble"><span class="monospaced">Double/parseDouble</span></a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_numbers_truncating_rounding">Truncating and Rounding Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_16">Problem</h4>
<div class="paragraph"><p>You need to truncate or round a decimal number to a lower-precision number.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_16">Solution</h4>
<div class="paragraph"><p>If the integer portion of a number is all you are concerned with, use
<span class="monospaced">int</span> to coerce the number to an integer. Of course, this completely
discards any decimal places without performing any rounding:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">2.0001</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>

<span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">2.999999999</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you still value some level of precision, then rounding is probably
what you&#8217;re after. You can use <span class="monospaced">Math/round</span> to perform simple
rounding:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>round <span style="color: #993399">2.0001</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>

<span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>round <span style="color: #993399">2.999</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; This is equivalent to:</span></span>
<span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #990000">(+</span> <span style="color: #993399">2.99</span> <span style="color: #993399">0.5</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you want to perform an unbalanced rounding, such as unconditionally
"rounding up" or "rounding down," then you should use <span class="monospaced">Math/ceil</span> or
<span class="monospaced">Math/floor</span>, respectively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>ceil <span style="color: #993399">2.0001</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>floor <span style="color: #993399">2.999</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2.0</span></span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll notice these functions return decimal numbers. Wrap calls to
<span class="monospaced">ceil</span> or <span class="monospaced">floor</span> in <span class="monospaced">int</span> to return an integer.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_16">Discussion</h4>
<div class="paragraph"><p><?dbhtml orphans="4"?>One of the simplest ways to "round" numbers is truncation. <span class="monospaced">int</span> will
do this for you, coercing floating-point numbers to integers by simply
chopping off any trailing decimal places. This isn&#8217;t necessarily
mathematically correct, but it is certainly convenient if it is
accurate enough for the problem at hand.</p></div>
<div class="paragraph"><p><span class="monospaced">Math/round</span> is the next step up in rounding technology. As with many
other primitive manipulation functions in Clojure, the language prefers
<em>not</em> to reinvent the wheel. <span class="monospaced">Math/round</span> is a Java function that
rounds by adding 1/2 to a number before dropping decimal places
similarly to <span class="monospaced">int</span>.</p></div>
<div class="paragraph"><p>For more advanced rounding, such as controlling the number of decimal
places or complex rounding modes, you may need to resort to using the
<span class="monospaced">with-precision</span> function. You likely already know <span class="monospaced">BigDecimal</span>
numbers are backed by Java classes, but you might not have known that
Java exposes a number of knobs for tweaking <span class="monospaced">BigDecimal</span> calculations;
<span class="monospaced">with-precision</span> exposes these knobs.</p></div>
<div class="paragraph"><p><span class="monospaced">with-precision</span> is a macro that accepts a <span class="monospaced">BigDecimal</span> precision
mode and any number of expressions, executing those expressions in a
<span class="monospaced">BigDecimal</span> context tuned to that precision. So what does precision
look like? Well, it&#8217;s a little strange. The most basic precision is
simply a positive integer "scale" value. This value specifies the
number of decimal places to work with. More complex precisions involve a
<span class="monospaced">:rounding</span> value, specified as a key/value pair like <span class="monospaced">:rounding FLOOR</span> (this <em>is</em> a macro
of course, so why not?). When not specified, the default rounding mode
is <span class="monospaced">HALF_UP</span>, but any of the values <span class="monospaced">CEILING</span>, <span class="monospaced">FLOOR</span>, <span class="monospaced">HALF_UP</span>,
<span class="monospaced">HALF_DOWN</span>, <span class="monospaced">HALF_EVEN</span>, <span class="monospaced">UP</span>, <span class="monospaced">DOWN</span>, or <span class="monospaced">UNNECESSARY</span> are allowed (see the
<a href="http://bit.ly/javadoc-rounding-mode"><span class="monospaced">RoundingMode</span> documentation</a>
for more detailed descriptions of each mode):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>precision <span style="color: #993399">3</span> <span style="color: #990000">(/</span> 7M <span style="color: #993399">9</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.778M</span></span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>precision <span style="color: #993399">1</span> <span style="color: #990000">(/</span> 7M <span style="color: #993399">9</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.8M</span></span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>precision <span style="color: #993399">1</span> <span style="color: #990000">:</span>rounding FLOOR <span style="color: #990000">(/</span> 7M <span style="color: #993399">9</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.7M</span></span></tt></pre></div></div>
<div class="paragraph"><p>One notable "gotcha" with <span class="monospaced">with-precision</span> is that it only changes the
behavior of <span class="monospaced">BigDecimal</span> arithmetic, leaving regular arithmetic
unchanged. You&#8217;ll have to introduce <span class="monospaced">BigDecimal</span> values into
your expressions with literal values (<span class="monospaced">3M</span>), or by means of the
<span class="monospaced">bigdec</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>precision <span style="color: #993399">3</span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1/3</span></span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>precision <span style="color: #993399">3</span> <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(bigdec</span></span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.333M</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_16">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>, for more information
  on <span class="monospaced">BigDecimal</span>, specifically type contagion
</p>
</li>
<li>
<p>
<a href="#sec_primitives_numbers_fuzzy_comparison">[sec_primitives_numbers_fuzzy_comparison]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_numbers_fuzzy_comparison">Performing Fuzzy Comparison</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_17">Problem</h4>
<div class="paragraph"><p>You need to test for equality with some tolerance for minute differences. This is especially a problem when comparing floating-point numbers, which are susceptible to "drift" through repeated operations.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_17">Solution</h4>
<div class="paragraph"><p>Clojure has no built-in functions for fault-tolerant equality, or "fuzzy
comparison," as it is often called. It&#8217;s trivial to implement your own
<span class="monospaced">fuzzy=</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> fuzzy<span style="color: #990000">=</span> <span style="color: #990000">[</span>tolerance x y<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>diff <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>abs <span style="color: #990000">(-</span> x y<span style="color: #990000">))]</span>
    <span style="color: #990000">(&lt;</span> diff tolerance<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(fuzzy</span></span><span style="color: #990000">=</span> <span style="color: #993399">0.01</span> <span style="color: #993399">10</span> <span style="color: #993399">10.000000000001</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(fuzzy</span></span><span style="color: #990000">=</span> <span style="color: #993399">0.01</span> <span style="color: #993399">10</span> <span style="color: #993399">10.1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_17">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">fuzzy=</span> works like most other fuzzy comparison algorithms do: first
it finds the absolute difference between the two operands; and second,
it tests whether that difference falls beneath the given tolerance.
Of course, there&#8217;s nothing dictating that the tolerance needs to be
some minute fractional number. If you were comparing large numbers and
wanted to ignore variations under a thousand, you could set the
tolerance to <span class="monospaced">1000</span>.</p></div>
<div class="paragraph"><p>Even with <span class="monospaced">fuzzy=</span>, you still need to take care when comparing
floating-point values, especially for values differing by numbers
<em>very close</em> to your tolerance. At differences bordering the supplied
tolerance, you may find the results a bit strange:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(-</span> <span style="color: #993399">0.22</span> <span style="color: #993399">0.23</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -0.010000000000000009</span></span>

<span style="color: #990000">(-</span> <span style="color: #993399">0.23</span> <span style="color: #993399">0.24</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -0.009999999999999981</span></span></tt></pre></div></div>
<div class="paragraph"><p>As odd as this is, this isn&#8217;t unexpected. The IEEE 754 specification
for floating-point values is a purposefully limited format, a trade-off
between accuracy and performance. If absolute precision is what you&#8217;re
after, then you should be using <span class="monospaced">BigDecimal</span> or <span class="monospaced">BigInt</span>. See
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>, for more information on those
two types.</p></div>
<div class="paragraph"><p>The <span class="monospaced">fuzzy=</span> function, as written, has a number of interesting side
effects. First and foremost, having tolerance as the first
argument makes it use <span class="monospaced">partial</span> to produce partially applied equals
functions tuned to a specific tolerance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> equal<span style="color: #990000">-</span>within<span style="color: #990000">-</span>ten<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> fuzzy<span style="color: #990000">=</span> <span style="color: #993399">10</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(equal</span></span><span style="color: #990000">-</span>within<span style="color: #990000">-</span>ten<span style="color: #990000">?</span> <span style="color: #993399">100</span> <span style="color: #993399">109</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(equal</span></span><span style="color: #990000">-</span>within<span style="color: #990000">-</span>ten<span style="color: #990000">?</span> <span style="color: #993399">100</span> <span style="color: #993399">110</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span></tt></pre></div></div>
<div class="paragraph"><p>What if you wanted to sort using fuzzy comparison? The <span class="monospaced">sort</span> function
takes as an optional argument a predicate or comparator. Let&#8217;s write a
function <span class="monospaced">fuzzy-comparator</span> that returns a comparator with a given tolerance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> fuzzy<span style="color: #990000">-</span>comparator <span style="color: #990000">[</span>tolerance<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>x y<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(fuzzy</span></span><span style="color: #990000">=</span> tolerance x y<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
      <span style="color: #993399">0</span>
      <span style="font-weight: bold"><span style="color: #000000">(compare</span></span> x y<span style="color: #990000">))))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="font-weight: bold"><span style="color: #000000">(fuzzy</span></span><span style="color: #990000">-</span>comparator <span style="color: #993399">10</span><span style="color: #990000">)</span> <span style="color: #990000">[</span><span style="color: #993399">100</span> <span style="color: #993399">11</span> <span style="color: #993399">150</span> <span style="color: #993399">10</span> <span style="color: #993399">9</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (11 10 9 100 150) ; 100 and 150 have moved, but not 11, 10, and 9</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
If the two values being compared are within <span class="monospaced">tolerance</span> of each
    other, return <span class="monospaced">0</span> to indicate they are equal.
</p>
</li>
<li>
<p>
Otherwise, fall back to normal <span class="monospaced">compare</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_see_also_17">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Wikipedia article on
  <a href="http://bit.ly/ieee-floating-point">IEEE floating
  point</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_numbers_truncating_rounding">[sec_primitives_numbers_truncating_rounding]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_performing_trigonometry">Performing Trigonometry</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_18">Problem</h4>
<div class="paragraph"><p>You need to implement mathematical functions that require trigonometry.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_18">Solution</h4>
<div class="paragraph"><p>All of the trigonometric functions are accessible via
<a href="http://bit.ly/javadoc-math"><span class="monospaced">java.lang.Math</span></a>,
which is available as <span class="monospaced">Math</span>. Use them like you would any other
namespaced function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Calculating sin(a + b). The formula for this is</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sin(a + b) = sin a * cos b + sin b cos a</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> sin<span style="color: #990000">-</span>plus <span style="color: #990000">[</span>a b<span style="color: #990000">]</span>
  <span style="color: #990000">(+</span> <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sin a<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>cos b<span style="color: #990000">))</span>
     <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sin b<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>cos a<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(sin</span></span><span style="color: #990000">-</span>plus <span style="color: #993399">0.1</span> <span style="color: #993399">0.3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.38941834230865047</span></span></tt></pre></div></div>
<div class="paragraph"><p>Trigonometric functions operate on values measured in radians. If you
have values measured in degrees, such as latitude or longitude, then
you&#8217;ll need to convert them to radians first. Use <span class="monospaced">Math/toRadians</span> to
convert degrees to radians:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Calculating the distance in kilometers between two points on Earth</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> earth<span style="color: #990000">-</span>radius <span style="color: #993399">6371.009</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> degrees<span style="color: #990000">-&gt;</span>radians <span style="color: #990000">[</span>point<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(mapv</span></span> #<span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>toRadians <span style="color: #990000">%)</span> point<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> distance<span style="color: #990000">-</span>between
  <span style="color: #FF0000">"Calculate the distance in km between two points on Earth. Each</span>
<span style="color: #FF0000">   point is a pair of degrees latitude and longitude, in that order."</span>
  <span style="color: #990000">([</span>p1 p2<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(distance</span></span><span style="color: #990000">-</span>between p1 p2 earth<span style="color: #990000">-</span>radius<span style="color: #990000">))</span>
  <span style="color: #990000">([</span>p1 p2 radius<span style="color: #990000">]</span>
     <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[[</span>lat1 long1<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(degrees</span></span><span style="color: #990000">-&gt;</span>radians p1<span style="color: #990000">)</span>
           <span style="color: #990000">[</span>lat2 long2<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(degrees</span></span><span style="color: #990000">-&gt;</span>radians p2<span style="color: #990000">)]</span>
       <span style="color: #990000">(*</span> radius
          <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>acos <span style="color: #990000">(+</span> <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sin lat1<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sin lat2<span style="color: #990000">))</span>
                        <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>cos lat1<span style="color: #990000">)</span>
                           <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>cos lat2<span style="color: #990000">)</span>
                           <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>cos <span style="color: #990000">(-</span> long1 long2<span style="color: #990000">)))))))))</span>

<span style="font-weight: bold"><span style="color: #000000">(distance</span></span><span style="color: #990000">-</span>between <span style="color: #990000">[</span><span style="color: #993399">49.2000</span> <span style="color: #990000">-</span><span style="color: #993399">98.1000</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">35.9939</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">78.8989</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2139.42827188432</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_18">Discussion</h4>
<div class="paragraph"><p>It may be surprising to some that Clojure doesn&#8217;t have its own internal
math namespace, but why reinvent the wheel? Despite its tainted
reputation, Java can perform, especially when it comes to math.
Clojure&#8217;s Java interop forms and typing sugar make doing math using
<span class="monospaced">java.lang.Math</span> almost pleasant.</p></div>
<div class="paragraph"><p><span class="monospaced">java.lang.Math</span> isn&#8217;t only for trigonometry. It also contains a
number of functions useful for dealing with exponentiation, logarithms,
and roots. A full list of methods is available in the
<a href="http://bit.ly/javadoc-math"><span class="monospaced">java.lang.Math</span>
javadoc</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_18">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_type_hinting">[sec_primitives_math_type_hinting]</a>, for tips on improving
  performance
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_inputting_and_outputting_integers_with_different_bases">Inputting and Outputting Integers with Different Bases</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_19">Problem</h4>
<div class="paragraph"><p>You need to enter numbers into a Clojure REPL or code in a different base (such as hexadecimal or binary).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_19">Solution</h4>
<div class="paragraph"><p>Specify the base or <em>radix</em> of a literal number by prefixing it with
the radix number (e.g., 2, 16, etc.) and the letter <span class="monospaced">r</span>. Any base from
2 to 36 is valid (there <em>are</em>, of course, 10 digits and 26 letters available):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>2r101010
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 42</span></span>

3r1120
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 42</span></span>

16r2A
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 42</span></span>

36rABUNCH
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 624567473</span></span></tt></pre></div></div>
<div class="paragraph"><p>To output integers, use the Java method <span class="monospaced">Integer/toString</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toString <span style="color: #993399">13</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1101"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toString <span style="color: #993399">42</span> <span style="color: #993399">16</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "2a"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toString <span style="color: #993399">35</span> <span style="color: #993399">36</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "z"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_19">Discussion</h4>
<div class="paragraph"><p>Unlike the
ordering of most Clojure functions, this method takes an integer
first and the optional base second, making it hard to partially
apply without wrapping it in another function. You can write a small
wrapper around <span class="monospaced">Integer/toString</span> to accomplish this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> to<span style="color: #990000">-</span>base <span style="color: #990000">[</span>radix n<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toString n radix<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> base<span style="color: #990000">-</span>two <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> to<span style="color: #990000">-</span>base <span style="color: #993399">2</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(base</span></span><span style="color: #990000">-</span>two <span style="color: #993399">9001</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "10001100101001"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_19">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_strings_formatting_strings">[sec_primitives_strings_formatting_strings]</a>, for information on
  <span class="monospaced">format</span> (the <span class="monospaced">o</span> and <span class="monospaced">x</span> specifiers print integers in octal and
  hexadecimal, respectively)
</p>
</li>
<li>
<p>
<a href="#sec_primitives_numbers_parsing_numbers">[sec_primitives_numbers_parsing_numbers]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_calculating_statistics_on_collections_of_numbers">Calculating Statistics on Collections of Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld and Jean Niklas L'&#8202;orange</p></div>
<div class="sect3">
<h4 id="_problem_20">Problem</h4>
<div class="paragraph"><p>You need to calculate simple statistics like mean, median, mode, and standard
deviation on a collection of numbers.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_20">Solution</h4>
<div class="paragraph"><p>Find the <em>mean</em> (average) of a collection by dividing its total by the <span class="monospaced">count</span> of the collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mean <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>sum <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> <span style="color: #990000">+</span> coll<span style="color: #990000">)</span>
        count <span style="font-weight: bold"><span style="color: #000000">(count</span></span> coll<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(pos</span></span><span style="color: #990000">?</span> count<span style="color: #990000">)</span>
      <span style="color: #990000">(/</span> sum count<span style="color: #990000">)</span>
      <span style="color: #993399">0</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(mean</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 5/2</span></span>

<span style="font-weight: bold"><span style="color: #000000">(mean</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">1.6</span> <span style="color: #993399">7.4</span> <span style="color: #993399">10</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 5.0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(mean</span></span> <span style="color: #990000">[])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span></tt></pre></div></div>
<div class="paragraph"><p>Find the <em>median</em> (middle value) of a collection by sorting its
values and getting its middle value. There are, of course, special
considerations for collections of even length. In these cases, the median is
considering the mean of the <em>two</em> middle values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> median <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>sorted <span style="font-weight: bold"><span style="color: #000000">(sort</span></span> coll<span style="color: #990000">)</span>
        cnt <span style="font-weight: bold"><span style="color: #000000">(count</span></span> sorted<span style="color: #990000">)</span>
        halfway <span style="font-weight: bold"><span style="color: #000000">(quot</span></span> cnt <span style="color: #993399">2</span><span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(odd</span></span><span style="color: #990000">?</span> cnt<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> sorted halfway<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
      <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>bottom <span style="font-weight: bold"><span style="color: #000000">(dec</span></span> halfway<span style="color: #990000">)</span>
            bottom<span style="color: #990000">-</span>val <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> sorted bottom<span style="color: #990000">)</span>
            top<span style="color: #990000">-</span>val <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> sorted halfway<span style="color: #990000">)]</span>
        <span style="font-weight: bold"><span style="color: #000000">(mean</span></span> <span style="color: #990000">[</span>bottom<span style="color: #990000">-</span>val top<span style="color: #990000">-</span>val<span style="color: #990000">])))))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(median</span></span> <span style="color: #990000">[</span><span style="color: #993399">5</span> <span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span>

<span style="font-weight: bold"><span style="color: #000000">(median</span></span> <span style="color: #990000">[</span><span style="color: #993399">7</span> <span style="color: #993399">0</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 5/2  ; The average of 2 and 3.</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
In the case that <span class="monospaced">coll</span> has an odd number of items, simply retrieve that item with <span class="monospaced">nth</span>.
</p>
</li>
<li>
<p>
When <span class="monospaced">coll</span> has an even number of items, find the index for the other central value (<span class="monospaced">bottom</span>), and take the mean of the top and bottom values.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Find the <em>mode</em> (most frequently occurring value) of a collection by
using <span class="monospaced">frequencies</span> to tally occurrences. Then massage that tally to
retrieve the discrete list of modes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mode <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>freqs <span style="font-weight: bold"><span style="color: #000000">(frequencies</span></span> coll<span style="color: #990000">)</span>
        occurrences <span style="font-weight: bold"><span style="color: #000000">(group</span></span><span style="color: #990000">-</span>by val freqs<span style="color: #990000">)</span>
        modes <span style="font-weight: bold"><span style="color: #000000">(last</span></span> <span style="font-weight: bold"><span style="color: #000000">(sort</span></span> occurrences<span style="color: #990000">))</span>
        modes <span style="color: #990000">(-&gt;&gt;</span> modes
                   val
                   <span style="font-weight: bold"><span style="color: #000000">(map</span></span> key<span style="color: #990000">))]</span>
     modes<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(mode</span></span> <span style="color: #990000">[:</span>alan <span style="color: #990000">:</span>bob <span style="color: #990000">:</span>alan <span style="color: #990000">:</span>greg<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (:alan)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(mode</span></span> <span style="color: #990000">[:</span>smith <span style="color: #990000">:</span>carpenter <span style="color: #990000">:</span>doe <span style="color: #990000">:</span>smith <span style="color: #990000">:</span>doe<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (:smith :doe)</span></span></tt></pre></div></div>
<div class="sect4">
<h5 id="_standard_deviation">Standard deviation</h5>
<div class="paragraph"><p>Find the sample <em>standard deviation</em> by completing the following steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
For each value in the collection, subtract the <span class="monospaced">mean</span> from the value and multiply that result by itself.
</p>
</li>
<li>
<p>
Then, sum up all those values.
</p>
</li>
<li>
<p>
Divide the result by the number of values <em>minus one</em>.
</p>
</li>
<li>
<p>
Finally, take the square root of the previous result:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> standard<span style="color: #990000">-</span>deviation <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>avg <span style="font-weight: bold"><span style="color: #000000">(mean</span></span> coll<span style="color: #990000">)</span>
        squares <span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[</span>x coll<span style="color: #990000">]</span>
                  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>x<span style="color: #990000">-</span>avg <span style="color: #990000">(-</span> x avg<span style="color: #990000">)]</span>
                    <span style="color: #990000">(*</span> x<span style="color: #990000">-</span>avg x<span style="color: #990000">-</span>avg<span style="color: #990000">)))</span>
        total <span style="font-weight: bold"><span style="color: #000000">(count</span></span> coll<span style="color: #990000">)]</span>
    <span style="color: #990000">(-&gt;</span> <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> <span style="color: #990000">+</span> squares<span style="color: #990000">)</span>
           <span style="color: #990000">(-</span> total <span style="color: #993399">1</span><span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sqrt<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(standard</span></span><span style="color: #990000">-</span>deviation <span style="color: #990000">[</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">2</span> <span style="color: #993399">9</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2.0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(standard</span></span><span style="color: #990000">-</span>deviation <span style="color: #990000">[</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">6</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1.4142135623730951</span></span></tt></pre></div></div>
</li>
</ol></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_20">Discussion</h4>
<div class="paragraph"><p>Both <span class="monospaced">mean</span> and <span class="monospaced">median</span> are fairly easy to reproduce in Clojure, but
<span class="monospaced">mode</span> requires a bit more effort. <span class="monospaced">mode</span> is a little different than
<span class="monospaced">mean</span> or <span class="monospaced">median</span> in that it generally only makes sense for
nonnumeric data. Calculating the modes of a collection is a little
more involved and ultimately requires a good deal of processing
compared to its numeric cousins.</p></div>
<div class="paragraph"><p>Here is a breakdown of how <span class="monospaced">mode</span> works:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mode <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>freqs <span style="font-weight: bold"><span style="color: #000000">(frequencies</span></span> coll<span style="color: #990000">)</span>            <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
        occurrences <span style="font-weight: bold"><span style="color: #000000">(group</span></span><span style="color: #990000">-</span>by val freqs<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
        modes <span style="font-weight: bold"><span style="color: #000000">(last</span></span> <span style="font-weight: bold"><span style="color: #000000">(sort</span></span> occurrences<span style="color: #990000">))</span>     <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
        modes <span style="color: #990000">(-&gt;&gt;</span> modes                    <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;4&gt;</b></span></span>
                   val
                   <span style="font-weight: bold"><span style="color: #000000">(map</span></span> key<span style="color: #990000">))]</span>
     modes<span style="color: #990000">))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">frequencies</span> returns a map that tallies the number of times
    each value in <span class="monospaced">coll</span> occurs. This would be something like <span class="monospaced">{:a 1 :b 2}</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">group-by</span> with <span class="monospaced">val</span> inverts the <span class="monospaced">freqs</span> map, turning keys
    into values and merging duplicates into groups. This would turn <span class="monospaced">{:a 1 :b
    1}</span> into <span class="monospaced">{1 [[:a 1] [:b 1]]}</span>.
</p>
</li>
<li>
<p>
The list of occurrences is now sortable. The last pair in the
    sorted list will be the modes, or most frequently occurring values.
</p>
</li>
<li>
<p>
The final step is processing the raw mode pairs into discrete
    values. Taking <span class="monospaced">val</span> turns <literal>[2 [[:alan 2]]]</literal> into <literal>[[:alan 2]]</literal>, and <span class="monospaced">(map key)</span> turns that into <span class="monospaced">(:alan)</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The standard deviation measures how much, on average, the individual values in a
population deviate from the mean: the higher the standard deviation is, the
farther away the individual values will be (on average).
<span class="monospaced">standard-deviation</span> is a bit more mathematical than <span class="monospaced">mean</span>, <span class="monospaced">median</span>, and
<span class="monospaced">mode</span>. Follow along the execution of this function step by step:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> standard<span style="color: #990000">-</span>deviation <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>avg <span style="font-weight: bold"><span style="color: #000000">(mean</span></span> coll<span style="color: #990000">)</span>                   <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
        squares <span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[</span>x coll<span style="color: #990000">]</span>             <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
                  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>x<span style="color: #990000">-</span>avg <span style="color: #990000">(-</span> x avg<span style="color: #990000">)]</span>
                    <span style="color: #990000">(*</span> x<span style="color: #990000">-</span>avg x<span style="color: #990000">-</span>avg<span style="color: #990000">)))</span>
        total <span style="font-weight: bold"><span style="color: #000000">(count</span></span> coll<span style="color: #990000">)]</span>
    <span style="color: #990000">(-&gt;</span> <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> <span style="color: #990000">+</span> squares<span style="color: #990000">)</span>              <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
           <span style="color: #990000">(-</span> total <span style="color: #993399">1</span><span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sqrt<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Calculate the mean of the collection.
</p>
</li>
<li>
<p>
For each value, calculate the square of the difference between the value
and the mean.
</p>
</li>
<li>
<p>
Finally, calculate the <em>sample</em> standard deviation by taking the square root of the sum of squares over population size minus one.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you have the complete population, you can compute the  <em>population</em>
standard deviation by dividing by <span class="monospaced">total</span> instead of <span class="monospaced">(- total 1)</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_20">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Wikipedia article on
<a href="http://bit.ly/wiki-std-dev">standard deviation</a> for more
information on standard deviation and what it can be used for
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_math_bitwise">Performing Bitwise Operations</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_21">Problem</h4>
<div class="paragraph"><p>You need to perform bitwise operations on numbers.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_21">Solution</h4>
<div class="paragraph"><p>Bitwise operations aren&#8217;t quite as commonly used in high-level
languages (like Clojure) as they are in systems languages like C or
C++, but the techniques learned in those systems languages can still
be useful. Clojure exposes a number of bitwise operations in its core
namespace, all prefixed with <span class="monospaced">bit-</span>. One place bitwise operations really shine is in compressing a large
number of binary flags into a single value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Modeling a subset of Unix filesystem flags in a single integer</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> fs<span style="color: #990000">-</span>flags <span style="color: #990000">[:</span>owner<span style="color: #990000">-</span>read <span style="color: #990000">:</span>owner<span style="color: #990000">-</span>write
               <span style="color: #990000">:</span>group<span style="color: #990000">-</span>read <span style="color: #990000">:</span>group<span style="color: #990000">-</span>write
               <span style="color: #990000">:</span>global<span style="color: #990000">-</span>read <span style="color: #990000">:</span>global<span style="color: #990000">-</span>write<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Fold flags into a map of flag-&gt;bit</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> bitmap <span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> fs<span style="color: #990000">-</span>flags
                    <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> bit<span style="color: #990000">-</span>shift<span style="color: #990000">-</span>left <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span><span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:owner-read 1, :owner-write 2, :group-read 4, ...}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> permissions<span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #990000">[&amp;</span> flags<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> bit<span style="color: #990000">-</span>or <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> bitmap flags<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> owner<span style="color: #990000">-</span>only <span style="font-weight: bold"><span style="color: #000000">(permissions</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #990000">:</span>owner<span style="color: #990000">-</span>read <span style="color: #990000">:</span>owner<span style="color: #990000">-</span>write<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toBinaryString owner<span style="color: #990000">-</span>only<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "11"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> read<span style="color: #990000">-</span>only <span style="font-weight: bold"><span style="color: #000000">(permissions</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #990000">:</span>owner<span style="color: #990000">-</span>read <span style="color: #990000">:</span>group<span style="color: #990000">-</span>read <span style="color: #990000">:</span>global<span style="color: #990000">-</span>read<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toBinaryString read<span style="color: #990000">-</span>only<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "10101"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> able<span style="color: #990000">-</span>to<span style="color: #990000">?</span> <span style="color: #990000">[</span>permissions flag<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(not</span></span><span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>and permissions <span style="font-weight: bold"><span style="color: #000000">(bitmap</span></span> flag<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(able</span></span><span style="color: #990000">-</span>to<span style="color: #990000">?</span> read<span style="color: #990000">-</span>only <span style="color: #990000">:</span>global<span style="color: #990000">-</span>read<span style="color: #990000">)</span>  <span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>
<span style="font-weight: bold"><span style="color: #000000">(able</span></span><span style="color: #990000">-</span>to<span style="color: #990000">?</span> read<span style="color: #990000">-</span>only <span style="color: #990000">:</span>global<span style="color: #990000">-</span>write<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_21">Discussion</h4>
<div class="paragraph"><p>Clojure provides a full complement of bitwise operations in its core
library. This includes the logic operations <em>and</em> and <em>or</em>, their negations, and shifts, to name a few.

When working with bitwise operations, it can often be necessary to view
the binary representation of an integer. Java&#8217;s
<span class="monospaced">Integer/toBinaryString</span> can conveniently print out a binary
representation of a number.</p></div>
<div class="paragraph"><p>Interestingly enough, core also includes a <span class="monospaced">bit-set</span> and a <span class="monospaced">bit-test</span>.
These two operations set or test an individual bit position in an
integer. Instead of working in multiples of two, as is necessary for
operations like <span class="monospaced">bit-and</span>, you can operate by the <em>index</em> of the flag
you&#8217;re interested in. This drastically simplifies the preceding example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Modeling a subset of Unix filesystem flags in a single integer</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> fs<span style="color: #990000">-</span>flags <span style="color: #990000">[:</span>owner<span style="color: #990000">-</span>read <span style="color: #990000">:</span>owner<span style="color: #990000">-</span>write
               <span style="color: #990000">:</span>group<span style="color: #990000">-</span>read <span style="color: #990000">:</span>group<span style="color: #990000">-</span>write
               <span style="color: #990000">:</span>global<span style="color: #990000">-</span>read <span style="color: #990000">:</span>global<span style="color: #990000">-</span>write<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> bitmap <span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> fs<span style="color: #990000">-</span>flags
                    <span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="color: #990000">(.</span>indexOf fs<span style="color: #990000">-</span>flags <span style="color: #990000">%)</span> fs<span style="color: #990000">-</span>flags<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> no<span style="color: #990000">-</span>permissions <span style="color: #993399">0</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> owner<span style="color: #990000">-</span>read <span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>set no<span style="color: #990000">-</span>permissions <span style="color: #990000">(:</span>owner<span style="color: #990000">-</span>read bitmap<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toBinaryString owner<span style="color: #990000">-</span>read<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Granting global permissions...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> anything <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> #<span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>set <span style="color: #990000">%</span><span style="color: #993399">1</span> <span style="font-weight: bold"><span style="color: #000000">(bitmap</span></span> <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">))</span> no<span style="color: #990000">-</span>permissions fs<span style="color: #990000">-</span>flags<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>toBinaryString anything<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "111111"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_21">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_deployment_primitive_arrays">[sec_deployment_primitive_arrays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_generating_random_numbers">Generating Random Numbers</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_22">Problem</h4>
<div class="paragraph"><p>You need to generate a random number.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_22">Solution</h4>
<div class="paragraph"><p>Clojure makes available a number of pseudorandom number generating functions for your disposal.</p></div>
<div class="paragraph"><p>For generating random floating-point numbers from <span class="monospaced">0.0</span> up to (but not including) <span class="monospaced">1.0</span>, use <span class="monospaced">rand</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.0249306187447903</span></span>

<span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0.9242089829055088</span></span></tt></pre></div></div>
<div class="paragraph"><p>For generating random integers, use <span class="monospaced">rand-int</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Emulating a six-sided die</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> roll<span style="color: #990000">-</span>d6 <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #993399">6</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(roll</span></span><span style="color: #990000">-</span>d6<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(roll</span></span><span style="color: #990000">-</span>d6<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_22">Discussion</h4>
<div class="paragraph"><p>In addition to generating a number from <span class="monospaced">0.0</span> to <span class="monospaced">1.0</span>, <span class="monospaced">rand</span> also
accepts an optional argument that specifies the exclusive maximum
value. For example, <span class="monospaced">(rand 5)</span> would return a floating-point number
ranging from <span class="monospaced">0.0</span> (inclusive) to <span class="monospaced">5.0</span> (exclusive).</p></div>
<div class="paragraph"><p><span class="monospaced">(rand-int 5)</span>, on the other hand, would return a random <em>integer</em> between <span class="monospaced">0</span>
(inclusive) and <span class="monospaced">5</span> (exclusive). At first blush, <span class="monospaced">rand-int</span> might seem like an
ideal way to select a random element from a vector or list. This is a lot of
ceremony, though. Use <span class="monospaced">rand-nth</span> instead to get a random element from any
sequential collection (i.e., the collection responds to <span class="monospaced">nth</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span>nth <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span>nth '<span style="color: #990000">(:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :c</span></span></tt></pre></div></div>
<div class="paragraph"><p>This won&#8217;t work for sets or hash maps, however. If you want to retrieve
a random element from a nonsequential collection like a set, use
<span class="monospaced">seq</span> to transform that collection into a sequence before calling
<span class="monospaced">rand-nth</span> on it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span>nth <span style="font-weight: bold"><span style="color: #000000">(seq</span></span> #{<span style="color: #990000">:</span>heads <span style="color: #990000">:</span>tails}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :heads</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;re trying to randomly sort a collection, use <span class="monospaced">shuffle</span> to
receive a random permutation of your collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(shuffle</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [3 1 4 5 2 6]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_22">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The
  <a href="http://bit.ly/javadoc-random">API
  documentation</a> for <span class="monospaced">java.util.Random</span>
</p>
</li>
<li>
<p>
<a href="#sec_testing_generative">[sec_testing_generative]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_currency">Working with Currency</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_23">Problem</h4>
<div class="paragraph"><p>You need to manipulate values that represent currency.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_23">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/clojurewerkz/money">Money</a> library for
representing, manipulating, and storing values in monetary units.</p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[clojurewerkz/money "1.4.0"]</span>
to your project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clojurewerkz/money</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">clojurewerkz.money.amounts</span> namespace contains functions for
creating, modifying, and comparing units of currency:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>money<span style="color: #990000">.</span>amounts    <span style="color: #990000">:</span>as ma<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>money<span style="color: #990000">.</span>currencies <span style="color: #990000">:</span>as mc<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; $2.00 in USD</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> two <span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>amount<span style="color: #990000">-</span>of mc<span style="color: #990000">/</span>USD <span style="color: #993399">2</span><span style="color: #990000">))</span>
two
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 2.00&gt;</span></span>


<span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>plus two two<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 4.00&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>minus two two<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 0.00&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/&lt;</span> two <span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>amount<span style="color: #990000">-</span>of mc<span style="color: #990000">/</span>USD <span style="color: #993399">2.01</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>total <span style="color: #990000">[</span>two two two two<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 8.00&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_23">Discussion</h4>
<div class="paragraph"><p>Working with currency is serious business. Never trust built-in
numerical types with handling currency, especially floating-point
values. These types are simply not meant to capture and manipulate
currency with the semantics and precision required. In particular,
floating-point values of the IEEE 754 standard carry a certain
imprecision by design:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(-</span> <span style="color: #993399">0.23</span> <span style="color: #993399">0.24</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -0.009999999999999981</span></span></tt></pre></div></div>
<div class="paragraph"><p>You should always use a library custom-tailored for dealing with
money. The Money library wraps the trusted and battle-tested Java
library Joda-Money. Money provides a large amount of functionality
beyond arithmetic, including rounding and currency conversion:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>round <span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>amount<span style="color: #990000">-</span>of mc<span style="color: #990000">/</span>USD <span style="color: #993399">3.14</span><span style="color: #990000">)</span> <span style="color: #993399">0</span> <span style="color: #990000">:</span>down<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 3.00&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>convert<span style="color: #990000">-</span>to <span style="font-weight: bold"><span style="color: #000000">(ma</span></span><span style="color: #990000">/</span>amount<span style="color: #990000">-</span>of mc<span style="color: #990000">/</span>CAD <span style="color: #993399">152.34</span><span style="color: #990000">)</span> mc<span style="color: #990000">/</span>USD <span style="color: #993399">1.01696</span> <span style="color: #990000">:</span>down<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Money USD 154.92&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">round</span> function takes three arguments: an amount of currency, a
scale factor, and a rounding mode. The scaling factor is a somewhat
peculiar argument. It might be familiar to you if you&#8217;ve ever done
scaling with <span class="monospaced">BigDecimal</span>, which shares identical factors. A scale of
<span class="monospaced">-1</span> scales to the tens place, <span class="monospaced">0</span> scales to the ones place, and so on and
so forth. Further details can be found in the javadoc for the
<a href="http://bit.ly/joda-money-rounded-src"><span class="monospaced">rounded</span></a>
method of Joda-Money&#8217;s <span class="monospaced">Money</span> class. The final argument is
a rounding mode, of which there are quite a few. <span class="monospaced">:ceiling</span> and <span class="monospaced">:floor</span> round toward positive or
negative infinity. <span class="monospaced">:up</span> and <span class="monospaced">:down</span> round toward or away from zero.
Finally <span class="monospaced">:half-up</span>, <span class="monospaced">:half-down</span>, and <span class="monospaced">:half-even</span> round toward the
nearest neighbor, preferring up, down, or the most even neighbor.</p></div>
<div class="paragraph"><p><span class="monospaced">clojurewerkz.money.amounts/convert-to</span> is a much less complicated
function. <span class="monospaced">convert-to</span> takes an amount of currency, a target currency, a
conversion factor, and a rounding mode. Money doesn&#8217;t provide its own
conversion factor, since conversion rates change so often, so you&#8217;ll need to seek out a reputable source for them. Unfortunately, we can&#8217;t
help you with this one.</p></div>
<div class="paragraph"><p>Money also provides support for a number of different persistence and
serialization mediums, including
<a href="https://github.com/dakrone/cheshire">Cheshire</a> for converting to/from
JSON and <a href="http://clojuremongodb.info/">Monger</a> for persisting currency
values to MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_23">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_arbitrary_precision">[sec_primitives_math_arbitrary_precision]</a>, and <a href="#sec_primitives_numbers_truncating_rounding">[sec_primitives_numbers_truncating_rounding]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_math_uuids">Generating Unique IDs</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_24">Problem</h4>
<div class="paragraph"><p>You need to generate a unique ID.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_24">Solution</h4>
<div class="paragraph"><p>Use Java&#8217;s <span class="monospaced">java.util.UUID/randomUUID</span> to generate a universally
unique ID (UUID):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">/</span>randomUUID<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #uuid "5358e6e3-7f81-40f0-84e5-750e29e6ee05"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">/</span>randomUUID<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #uuid "a6f92a6f-f736-468f-9e26-f392852825f4"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_24">Discussion</h4>
<div class="paragraph"><p>Oftentimes when building systems, you want to assign unique IDs to
objects and records. IDs are usually simple integers that
monotonically increase with time. This isn&#8217;t without its problems,
though.</p></div>
<div class="paragraph"><p>You can&#8217;t mingle IDs of objects from different origins; and
worse, they reveal information about the amount and input volume of
your data.</p></div>
<div class="paragraph"><p>This is where UUIDs come in. UUIDs, or universally unique identifiers, are
128-bit random numbers almost certainly unique across the entire
universe. A bold claim, of course&#8212;see
<a href="http://bit.ly/rfc4122">RFC 4122</a> for more detailed
information on UUIDs, how they&#8217;re generated, and the math behind them.</p></div>
<div class="paragraph"><p>You may have noticed Clojure prints UUIDs with a <span class="monospaced">#uuid</span> in front of
them. This is a reader literal tag. It acts as a shortcut for the
Clojure reader to read and initialize UUID objects. Reader literals
are a lot like string or number literals like <span class="monospaced">"Hi"</span> or <span class="monospaced">42</span>, but they
can capture more complex data types.</p></div>
<div class="paragraph"><p>This makes it possible for
formats like <a href="https://github.com/edn-format/edn">edn</a> (extensible data notation) to communicate in
a common lingo about things like UUIDs without resorting to string
interning and accompanying custom parsing logic.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Sequential IDs</div>
<div class="paragraph"><p>One thing you will lose with the move from sequential IDs to UUIDs is
the implicit sortability of a chronologically increasing number. What
if you could generate UUIDs that were both unique <em>and</em> sortable?
Datomic does something similar with its <span class="monospaced">datomic.api/squuid</span> function.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> squuid <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>uuid <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">/</span>randomUUID<span style="color: #990000">)</span>
        time <span style="font-weight: bold"><span style="color: #000000">(System</span></span><span style="color: #990000">/</span>currentTimeMillis<span style="color: #990000">)</span>
        secs <span style="font-weight: bold"><span style="color: #000000">(quot</span></span> time <span style="color: #993399">1000</span><span style="color: #990000">)</span>
        lsb <span style="color: #990000">(.</span>getLeastSignificantBits uuid<span style="color: #990000">)</span>
        msb <span style="color: #990000">(.</span>getMostSignificantBits uuid<span style="color: #990000">)</span>
        timed<span style="color: #990000">-</span>msb <span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>or <span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>shift<span style="color: #990000">-</span>left secs <span style="color: #993399">32</span><span style="color: #990000">)</span>
                          <span style="font-weight: bold"><span style="color: #000000">(bit</span></span><span style="color: #990000">-</span>and <span style="color: #993399">0x00000000ffffffff</span> msb<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">.</span> timed<span style="color: #990000">-</span>msb lsb<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This approximation of Datomic&#8217;s <span class="monospaced">squuid</span> splits and reassembles a
random UUID, using <span class="monospaced">bit-or</span> to merge the current time with the most
significant 32 bits of the UUID. The two halves of the UUID
are then reassembled using the <span class="monospaced">java.util.UUID.</span> constructor,
yielding UUIDs that increase sequentially over time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> u1 <span style="font-weight: bold"><span style="color: #000000">(squuid</span></span><span style="color: #990000">))</span>
u1
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #uuid "527bf210-dfae-4c73-8b7a-302d3b511f41"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> u2 <span style="font-weight: bold"><span style="color: #000000">(squuid</span></span><span style="color: #990000">))</span>
u2
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #uuid "527bf219-65f0-4241-a165-c5c541cb98ea"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> u3 <span style="font-weight: bold"><span style="color: #000000">(squuid</span></span><span style="color: #990000">))</span>
u3
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #uuid "527bf232-42b2-44bc-8dd7-ddae2abfcb87"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="color: #990000">[</span>u1 u2 u3<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#uuid "527bf210-dfae-4c73-8b7a-302d3b511f41"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #uuid "527bf219-65f0-4241-a165-c5c541cb98ea"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #uuid "527bf232-42b2-44bc-8dd7-ddae2abfcb87")</span></span></tt></pre></div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_24">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_bitwise">[sec_primitives_math_bitwise]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_reader_literal">[sec_primitives_dates_reader_literal]</a>, for information on <span class="monospaced">#inst</span>,
  another example of a reader literal, for dates
</p>
</li>
<li>
<p>
The <span class="monospaced">java.util.UUID</span> <a href="http://bit.ly/javadoc-uuid">API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_current_date">Obtaining the Current Date and Time</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_25">Problem</h4>
<div class="paragraph"><p>You need to obtain the current date or time.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_25">Solution</h4>
<div class="paragraph"><p>Use Java&#8217;s <a href="http://bit.ly/javadoc-date"><span class="monospaced">java.util.Date</span></a> constructor to create a <span class="monospaced">Date</span> instance
representing the present time and date:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> now <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">.))</span>

<span style="font-weight: bold"><span style="color: #000000">(now</span></span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "2013-04-06T14:33:45.740-00:00"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; A few seconds later...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(now</span></span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "2013-04-06T14:33:51.234-00:00"</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;re more interested in the current Unix timestamp, use
<span class="monospaced">System/currentTimeMillis</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(System</span></span><span style="color: #990000">/</span>currentTimeMillis<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1365260110635</span></span>

<span style="font-weight: bold"><span style="color: #000000">(System</span></span><span style="color: #990000">/</span>currentTimeMillis<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1365260157013</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_25">Discussion</h4>
<div class="paragraph"><p>It doesn&#8217;t make much sense for Clojure to reimplement or wrap the
JVM&#8217;s backing time and date functionality. As such, the norm is to use
Clojure&#8217;s Java interop forms to instantiate a <span class="monospaced">Date</span> object
representing "now."</p></div>
<div class="paragraph"><p><span class="monospaced">#inst "2013-04-06T14:33:51.234-00:00"</span> doesn&#8217;t look very much like
Java, does it? That&#8217;s because Clojure&#8217;s "instant" reader literal
uses <span class="monospaced">java.util.Date</span> as its backing implementation. You can learn
more about the <span class="monospaced">#inst</span> reader literal in <a href="#sec_primitives_dates_reader_literal">[sec_primitives_dates_reader_literal]</a>.</p></div>
<div class="paragraph"><p>Using <span class="monospaced">System/currentTimeMillis</span> can be useful for performing a
one-off benchmark, but given the high-quality tools out there that do
this already, <span class="monospaced">currentTimeMillis</span> is of limited utility; you may want
to try Hugo Duncan&#8217;s
<a href="https://github.com/hugoduncan/criterium">Criterium</a> library if
benchmarking is what you&#8217;re after. Additionally, you shouldn&#8217;t try to
use <span class="monospaced">currentTimeMillis</span> as some sort of unique value&#8212;UUIDs do
a much better job of this.</p></div>
<div class="paragraph"><p>If you decide you would rather use
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> to work with dates, it
provides the function <span class="monospaced">clj-time.core/now</span> to get the current <span class="monospaced">DateTime</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as timec<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(timec</span></span><span style="color: #990000">/</span>now<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-06T14:35:15.453Z&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">clj-time.local/local-now</span> to retrieve a <span class="monospaced">DateTime</span> instance for
the present scoped to your machine&#8217;s local time zone:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>local <span style="color: #990000">:</span>as timel<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(timel</span></span><span style="color: #990000">/</span>local<span style="color: #990000">-</span>now<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-06T09:35:20.141-05:00&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_25">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_uuids">[sec_primitives_math_uuids]</a>, to learn how to generate
  universally unique IDs
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_reader_literal">[sec_primitives_dates_reader_literal]</a>, for more information on the
  <span class="monospaced">#inst</span> reader literal
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_reader_literal">Representing Dates as Literals</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_26">Problem</h4>
<div class="paragraph"><p>You need to represent instances of time in a readable and serializable form.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_26">Solution</h4>
<div class="paragraph"><p>Use Clojure&#8217;s <span class="monospaced">#inst</span> literals in source to represent fixed points in
time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> ryans<span style="color: #990000">-</span>birthday #inst <span style="color: #FF0000">"1987-02-18T18:00:00.000-00:00"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(println</span></span> ryans<span style="color: #990000">-</span>birthday<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; #inst "1987-02-18T18:00:00.000-00:00"</span></span></tt></pre></div></div>
<div class="paragraph"><p>When communicating with other Clojure processes (or anything else that
speaks <a href="https://github.com/edn-format/edn">edn</a>), use <span class="monospaced">clojure.edn/read</span>
to reify instant literal strings into <span class="monospaced">Date</span> objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; A faux communication channel that "receives" edn strings</span></span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'clojure<span style="color: #990000">.</span>edn<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>io PushbackReader StringReader<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> remote<span style="color: #990000">-</span>server<span style="color: #990000">-</span>receive<span style="color: #990000">-</span>date <span style="color: #990000">[]</span>
  <span style="color: #990000">(-&gt;</span> <span style="color: #FF0000">"#inst </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">1987-02-18T18:00:00.000-00:00</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span>
      <span style="font-weight: bold"><span style="color: #000000">(StringReader</span></span><span style="color: #990000">.)</span>
      <span style="font-weight: bold"><span style="color: #000000">(PushbackReader</span></span><span style="color: #990000">.)))</span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read <span style="font-weight: bold"><span style="color: #000000">(remote</span></span><span style="color: #990000">-</span>server<span style="color: #990000">-</span>receive<span style="color: #990000">-</span>date<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "1987-02-18T18:00:00.000-00:00"</span></span></tt></pre></div></div>
<div class="paragraph"><p>In the preceding example, <span class="monospaced">remote-server-receive-date</span> emulates a
communication channel upon which you may receive edn data.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_26">Discussion</h4>
<div class="paragraph"><p>Since Clojure 1.4, instants in time have been represented via
the <span class="monospaced">#inst</span> reader literal. This means dates are no longer represented
by code that must be evaluated, but instead have a textual representation that is both
consistent and serializable. This standard allows any process capable
of communicating in extensible data notation to speak
clearly about instants of time. See the
<a href="http://bit.ly/edn-impls">edn
implementations list</a> for a list of languages that speak edn; the list
includes Clojure, Ruby, and JavaScript so far, with many more
implementations in the works.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">clojure.core/read Versus clojure.edn/read</div>
<div class="paragraph"><p>While it may <em>seem</em> convenient to read strings using Clojure&#8217;s
built-in reader (<span class="monospaced">clojure.core/read</span>), it is <em>never</em> safe to parse input
from an untrusted source using this reader. If you need to receive
simple Clojure data from an external source, it is best to use the edn
reader (<span class="monospaced">clojure.edn/read</span>).</p></div>
<div class="paragraph"><p><span class="monospaced">clojure.core/read</span> isn&#8217;t safe because it was only designed for
reading Clojure data and strings from trusted sources (such as the
source files you write). <span class="monospaced">clojure.edn/read</span> is designed specifically
for use as part of a communication channel, and as such is built with
security in mind.</p></div>
</div></div>
<div class="paragraph"><p>It&#8217;s also possible to vary how the reader evaluates <span class="monospaced">#inst</span> literals
by changing the binding of <literal>*data-readers*</literal>. By varying the binding of
<literal>*data-readers*</literal>, it is possible to read <span class="monospaced">#inst</span> literals as
<a href="http://bit.ly/javadoc-calendar"><span class="monospaced">java.util.Calendar</span></a> or <a href="http://bit.ly/javadoc-timestamp"><span class="monospaced">java.sql.Timestamp</span></a>, if you so desire:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> instant <span style="color: #FF0000">"#inst </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">1987-02-18T18:00:00.000-00:00</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>data<span style="color: #990000">-</span>readers<span style="color: #990000">*</span> {'inst clojure<span style="color: #990000">.</span>instant<span style="color: #990000">/</span>read<span style="color: #990000">-</span>instant<span style="color: #990000">-</span>calendar}<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(class</span></span> <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>string instant<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.util.GregorianCalendar</span></span>

<span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>data<span style="color: #990000">-</span>readers<span style="color: #990000">*</span> {'inst clojure<span style="color: #990000">.</span>instant<span style="color: #990000">/</span>read<span style="color: #990000">-</span>instant<span style="color: #990000">-</span>timestamp}<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(class</span></span> <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>string instant<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.sql.Timestamp</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_26">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_math_uuids">[sec_primitives_math_uuids]</a>, for another example of a reader
  literal included with Clojure
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_parsing_dates">Parsing Dates and Times Using clj-time</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_27">Problem</h4>
<div class="paragraph"><p>You need to parse dates from a string.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_27">Solution</h4>
<div class="paragraph"><p>Working directly with Java&#8217;s date and time classes is like pulling
teeth. We suggest using
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a>, a Clojure wrapper
over the excellent <a href="http://bit.ly/joda-time">Joda-Time library</a>.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-time "0.6.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">clj-time.format/formatter</span> to create custom date/time
representations capable of parsing candidate strings. Use the
<span class="monospaced">clj-time.format/parse</span> function with those formatters to parse
strings into <span class="monospaced">DateTime</span> objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>format <span style="color: #990000">:</span>as tf<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; To parse dates like "02/18/87"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> government<span style="color: #990000">-</span>forms<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatter <span style="color: #FF0000">"MM/dd/yy"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>parse government<span style="color: #990000">-</span>forms<span style="color: #990000">-</span>date <span style="color: #FF0000">"02/18/87"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 1987-02-18T00:00:00.000Z&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> wonky<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatter <span style="color: #FF0000">"HH:mm:ss:SS' on 'yyyy-MM-dd"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'user/wonky-format</span></span>

<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>parse wonky<span style="color: #990000">-</span>format <span style="color: #FF0000">"16:13:49:06 on 2013-04-06"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-06T16:13:49.060Z&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_27">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">formatter</span> function is a powerful little function that
takes a date/time format string and returns an object capable of
parsing date/time strings in that format. This format string can
include any number of symbols representing portions of a time or date.
Some example symbols include year ("yy" or "yyyy"), day ("dd"), or even
a literal string like <literal>"on"</literal>. The full list of these symbols is
available in the Joda-Time
<a href="http://bit.ly/joda-time-dtf-doc"><span class="monospaced">DateTimeFormat</span></a>
javadoc.</p></div>
<div class="paragraph"><p>More often than not, the dates and times you&#8217;re parsing may be strange,
but not so strange that no one has seen them before. For this, <span class="monospaced">clj-time</span>
includes a large number of built-in formatters. Use
<span class="monospaced">clj-time.format/show-formatters</span> to print out a list of built-in
formats and a sample date/time in each format. Once you&#8217;ve picked a
suitable format, use <span class="monospaced">clj-time.format/formatters</span> with its keyword to
receive the appropriate <span class="monospaced">DateTimeFormatter</span>.</p></div>
<div class="paragraph"><p>By default, <span class="monospaced">formatter</span> always parses strings into <span class="monospaced">DateTime</span> objects
with a UTC time zone. <span class="monospaced">formatter</span> optionally takes a time zone as its
second argument. You can use <span class="monospaced">clj-time.core/time-zone-for-offset</span> or
<span class="monospaced">clj-time.core/time-zone-for-id</span> to receive a <span class="monospaced">DateTimeZone</span> object to
pass to <span class="monospaced">formatter</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_27">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_formatting_dates">[sec_primitives_dates_formatting_dates]</a>, for information on how
  to use formatters to unparse strings
</p>
</li>
<li>
<p>
The official
  <a href="http://bit.ly/javadoc-simple-date-format">API
  documentation</a> for Java&#8217;s simple date formatter
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_formatting_dates">Formatting Dates Using clj-time</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_28">Problem</h4>
<div class="paragraph"><p>You need to print dates or times in a particular format.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_28">Solution</h4>
<div class="paragraph"><p>While it is possible to format Java date&#x2013;like instances (<span class="monospaced">Date</span>,
<span class="monospaced">Calendar</span>, and <span class="monospaced">Timestamp</span>) with <span class="monospaced">clojure.core/format</span>, you should
use <a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> to format dates.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-time "0.6.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time</tt></pre></div></div>
<div class="paragraph"><p>To output a date/time as a string, use <span class="monospaced">clj-time.format/unparse</span> with a
<span class="monospaced">DateTimeFormatter</span>. There are a number of built-in formatters available via
<span class="monospaced">clj-time.format/formatters</span>, or you can build your own with
<span class="monospaced">clj-time.format/formatter</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>format <span style="color: #990000">:</span>as tf<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>unparse <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatters <span style="color: #990000">:</span>date<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "2013-04-06"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> my<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatter <span style="color: #FF0000">"MMM d, yyyy 'at' hh:mm"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>unparse my<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Apr 6, 2013 at 04:54"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_28">Discussion</h4>
<div class="paragraph"><p>It is certainly possible to format pure Java dates and times; however, in our
experience, it isn&#8217;t worth the hassle&#8212;the syntax is ugly, and the workflow is verbose. <span class="monospaced">clj-time</span> and its backing library Joda-Time have a track
record for making it easy to work with dates and times on the JVM.</p></div>
<div class="paragraph"><p>The <span class="monospaced">formatter</span> function is quite the gem. Not only does it produce a
"format" capable of printing or <span class="monospaced">unparse</span>ing a date, but it is also
capable of parsing strings back into dates. In other words,
<span class="monospaced">DateTimeFormatter</span> is capable of round-tripping from string to <span class="monospaced">Date</span>
and back again. Much of how <span class="monospaced">formatter</span> and <span class="monospaced">formatters</span> work is
 covered in <a href="#sec_primitives_dates_parsing_dates">[sec_primitives_dates_parsing_dates]</a>.</p></div>
<div class="paragraph"><p>One format symbol used less frequently in parsing is the textual
day of the week (i.e., "Tuesday" or "Tue"). Use "<span class="monospaced">E</span>" in your format
string to output the abbreviated day of the week, and "<span class="monospaced">EEEE</span>" for the
full-length day of the week:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> abbr<span style="color: #990000">-</span>day <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatter <span style="color: #FF0000">"E"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> full<span style="color: #990000">-</span>day <span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>formatter <span style="color: #FF0000">"EEEE"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>unparse abbr<span style="color: #990000">-</span>day <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Mon"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(tf</span></span><span style="color: #990000">/</span>unparse full<span style="color: #990000">-</span>day <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Monday"</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you need to format native Java date/time instances, you can use the
functions in the <span class="monospaced">clj-time.coerce</span> namespace to coerce any number of
Java date/time instances into Joda-Time instances:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>coerce <span style="color: #990000">:</span>as tc<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(tc</span></span><span style="color: #990000">/</span>from<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">.))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-06T17:03:16.872Z&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Similarly, you can use <span class="monospaced">clj-time.coerce</span> to coerce instances from
Joda-Time instances into other formats:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(tc</span></span><span style="color: #990000">/</span>to<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "2013-04-06T17:03:57.239-00:00"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(tc</span></span><span style="color: #990000">/</span>to<span style="color: #990000">-</span><span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1365267761585</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_28">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clj-time</span> <a href="https://github.com/clj-time/clj-time">project page</a> on
  GitHub
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_parsing_dates">[sec_primitives_dates_parsing_dates]</a>, for more detailed
  information on <span class="monospaced">formatter</span> and <span class="monospaced">formatters</span>
</p>
</li>
<li>
<p>
The official
  <a href="http://bit.ly/javadoc-simple-date-format">API
  documentation</a> for Java&#8217;s simple date formatter
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_comparing">Comparing Dates</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_29">Problem</h4>
<div class="paragraph"><p>You need to compare one date to another, or you need to sort a sequence of dates.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_29">Solution</h4>
<div class="paragraph"><p>You can compare Java <literal>Date</literal>s using the <span class="monospaced">compare</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> now <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">.))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> one<span style="color: #990000">-</span>second<span style="color: #990000">-</span>ago <span style="font-weight: bold"><span style="color: #000000">(now</span></span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(Thread</span></span><span style="color: #990000">/</span>sleep <span style="color: #993399">1000</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Now is greater than (1) one second ago.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="font-weight: bold"><span style="color: #000000">(now</span></span><span style="color: #990000">)</span> one<span style="color: #990000">-</span>second<span style="color: #990000">-</span>ago<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; One second ago is less than (-1) now.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> one<span style="color: #990000">-</span>second<span style="color: #990000">-</span>ago <span style="font-weight: bold"><span style="color: #000000">(now</span></span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -1</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; "Equal" manifests as 0.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> one<span style="color: #990000">-</span>second<span style="color: #990000">-</span>ago one<span style="color: #990000">-</span>second<span style="color: #990000">-</span>ago<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_29">Discussion</h4>
<div class="paragraph"><p>Why not just compare dates using Clojure&#8217;s built-in comparison
operators (<span class="monospaced">&lt;=</span>, <span class="monospaced">&gt;</span>, etc.)? The problem with these operators is that
they utilize <span class="monospaced">clojure.lang.Numbers</span> and attempt to coerce their
arguments to numerical types.</p></div>
<div class="paragraph"><p>Since regular comparison won&#8217;t work, it&#8217;s necessary to use the
<span class="monospaced">compare</span> function. The <span class="monospaced">compare</span> function takes two arguments and
returns a number indicating that the first argument was either
less than (-1), equal to (0), or greater than (+1) the second argument.</p></div>
<div class="paragraph"><p>Clojure&#8217;s <span class="monospaced">sort</span> functions use <span class="monospaced">compare</span> under the hood, so no extra
work is required to sort a collection of dates:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> occurrences
  <span style="color: #990000">[</span>#inst <span style="color: #FF0000">"2013-04-06T17:40:57.688-00:00"</span>
   #inst <span style="color: #FF0000">"2002-12-25T00:40:57.688-00:00"</span>
   #inst <span style="color: #FF0000">"2025-12-25T11:23:31.123-00:00"</span><span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(sort</span></span> occurrences<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#inst "2002-12-25T00:40:57.688-00:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "2013-04-06T17:40:57.688-00:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "2025-12-25T11:23:31.123-00:00")</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;ve been doing more complex work with dates and times and have
Joda-Time objects in hand, then all of this still applies. If you wish
to compare Joda-Time objects to Java time objects, however, you will
have to coerce them to one uniform type using the functions in <span class="monospaced">clj-time.coerce</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_29">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_sorting">[sec_composite_sorting]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_time_between">Calculating the Length of a Time Interval</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_30">Problem</h4>
<div class="paragraph"><p>You need to calculate the difference between two points in time.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_30">Solution</h4>
<div class="paragraph"><p>Since Java date and time classes have poor support for time zones and
leap years, use the <a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a>
library for calculating the length of a time interval.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-time "0.6.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">interval</span> along with the numerous <span class="monospaced">in-&lt;unit&gt;</span> helper functions in
the <span class="monospaced">clj-time.core</span> namespace to calculate the difference between
times:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; The first step is to capture two dates as an interval</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> since<span style="color: #990000">-</span>april<span style="color: #990000">-</span>first
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>interval <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2013</span> <span style="color: #993399">04</span> <span style="color: #993399">01</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; dt is the interval between April Fools Day, 2013 and today</span></span>
since<span style="color: #990000">-</span>april<span style="color: #990000">-</span>first
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;Interval 2013-04-01T00:00:00.000Z/2013-04-06T20:06:30.507Z&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>in<span style="color: #990000">-</span>days since<span style="color: #990000">-</span>april<span style="color: #990000">-</span>first<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 5</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Years since the Moon landing</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>in<span style="color: #990000">-</span>years <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>interval <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">1969</span> <span style="color: #993399">07</span> <span style="color: #993399">20</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 43</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Days from Feb. 28 to March 1 in 2012 (a leap year)</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>in<span style="color: #990000">-</span>days <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>interval <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">02</span> <span style="color: #993399">28</span><span style="color: #990000">)</span>
                       <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">03</span> <span style="color: #993399">01</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; And in a non-leap year</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>in<span style="color: #990000">-</span>days <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>interval <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2013</span> <span style="color: #993399">02</span> <span style="color: #993399">28</span><span style="color: #990000">)</span>
                       <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2013</span> <span style="color: #993399">03</span> <span style="color: #993399">01</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_30">Discussion</h4>
<div class="paragraph"><p>Calculating the length of an interval is one of the more
complex operations you can perform with times. Time on Earth is
a complex beast, complicated by constructs like leap time and time
zones; <a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> is the only
library we&#8217;re aware of that is capable of wrangling this complexity.</p></div>
<div class="paragraph"><p>The <span class="monospaced">clj-time.core/interval</span> function takes two dates and returns a
representation of that discrete interval of time. From there, the
<span class="monospaced">clj-time.core</span> namespace includes a myriad of <span class="monospaced">in-&lt;unit&gt;</span> functions
that can present that time interval in different units. These helpers
run the gamut in scale from <span class="monospaced">in-msecs</span> to <span class="monospaced">in-years</span>, covering nearly
every scale useful for nonspecialized applications.</p></div>
<div class="paragraph"><p>One area <span class="monospaced">clj-time</span> lacks support is for leap seconds. Joda-Time&#8217;s
<a href="http://bit.ly/joda-time-faq">official FAQ</a> explains why
the feature is missing. We&#8217;re not aware of any
Clojure library that <em>can</em> reason about time at this granularity. If this
concerns you, then you&#8217;re likely one of few people even capable of
doing it right. Good luck to you.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_30">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_comparing">[sec_primitives_dates_comparing]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_ranges">[sec_primitives_dates_ranges]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_relative">[sec_primitives_dates_relative]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_ranges">Generating Ranges of Dates and Times</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_31">Problem</h4>
<div class="paragraph"><p>You need to generate a lazy sequence covering a range of dates and/or times.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_31">Solution</h4>
<div class="paragraph"><p>This problem has no easy solution in Java, nor does it have one in
Clojure&#8212;third-party libraries included. It is possible to use
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> to get close, though.
By composing <span class="monospaced">clj-time</span>'s <span class="monospaced">Interval</span> and <span class="monospaced">periodic-seq</span> functionality,
you can create a function <span class="monospaced">time-range</span> that mimics <span class="monospaced">range</span>'s
capabilities, but for <literal>DateTime</literal>s:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as time<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>periodic <span style="color: #990000">:</span>as time<span style="color: #990000">-</span>period<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> time<span style="color: #990000">-</span>range
  <span style="color: #FF0000">"Return a lazy sequence of DateTimes from start to end, incremented</span>
<span style="color: #FF0000">  by 'step' units of time."</span>
  <span style="color: #990000">[</span>start end step<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>inf<span style="color: #990000">-</span>range <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">-</span>period<span style="color: #990000">/</span>periodic<span style="color: #990000">-</span>seq start step<span style="color: #990000">)</span>
        below<span style="color: #990000">-</span>end<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>t<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>within<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>interval start end<span style="color: #990000">)</span>
                                         t<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(take</span></span><span style="color: #990000">-</span>while below<span style="color: #990000">-</span>end<span style="color: #990000">?</span> inf<span style="color: #990000">-</span>range<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This is how you can use the <span class="monospaced">time-range</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> months<span style="color: #990000">-</span>of<span style="color: #990000">-</span>the<span style="color: #990000">-</span>year <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">-</span>range <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">01</span><span style="color: #990000">)</span>
                                    <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2013</span> <span style="color: #993399">01</span><span style="color: #990000">)</span>
                                    <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>months <span style="color: #993399">1</span><span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; months-of-the-year is an unrealized lazy sequence</span></span>
<span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> months<span style="color: #990000">-</span>of<span style="color: #990000">-</span>the<span style="color: #990000">-</span>year<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>

<span style="font-weight: bold"><span style="color: #000000">(count</span></span> months<span style="color: #990000">-</span>of<span style="color: #990000">-</span>the<span style="color: #990000">-</span>year<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 12</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; now realized</span></span>
<span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> months<span style="color: #990000">-</span>of<span style="color: #990000">-</span>the<span style="color: #990000">-</span>year<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_31">Discussion</h4>
<div class="paragraph"><p><?dbhtml orphans="4"?>While there is no ready-made, out-of-the-box <span class="monospaced">time-range</span> solution in
Clojure, it is trivial to construct such a function with purely lazy
semantics. The basis for our lazy <span class="monospaced">time-range</span> function is an infinite sequence of values
with a fixed starting time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> time<span style="color: #990000">-</span>range
  <span style="color: #FF0000">"Return a lazy sequence of DateTimes from start to end, incremented</span>
<span style="color: #FF0000">  by 'step' units of time."</span>
  <span style="color: #990000">[</span>start end step<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>inf<span style="color: #990000">-</span>range <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">-</span>period<span style="color: #990000">/</span>periodic<span style="color: #990000">-</span>seq start step<span style="color: #990000">)</span>            <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
        below<span style="color: #990000">-</span>end<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>t<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>within<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(time</span></span><span style="color: #990000">/</span>interval start end<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
                                         t<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(take</span></span><span style="color: #990000">-</span>while below<span style="color: #990000">-</span>end<span style="color: #990000">?</span> inf<span style="color: #990000">-</span>range<span style="color: #990000">)))</span>                            <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Acquire a lazy infinite sequence.
</p>
</li>
<li>
<p>
Create a predicate to terminate the sequence.
</p>
</li>
<li>
<p>
Modify the infinite sequence to terminate when <span class="monospaced">below-end?</span> fails (lazily, of course).
</p>
</li>
</ol></div>
<div class="paragraph"><p>Invoking <span class="monospaced">periodic-seq</span> with <span class="monospaced">start</span> and <span class="monospaced">step</span> returns an infinite lazy
sequence of values beginning at <span class="monospaced">start</span>, each subsequent value one <span class="monospaced">step</span>
later than the last.</p></div>
<div class="paragraph"><p>Having a lazy infinite sequence is one thing, but we need a lazy way to
<em>stop</em> acquiring values when <span class="monospaced">end</span> is reached.
The <span class="monospaced">below-end?</span> function
created in <span class="monospaced">let</span> uses <span class="monospaced">clj-time.core/interval</span> to construct an interval from
<span class="monospaced">start</span> to <span class="monospaced">end</span> and <span class="monospaced">clj-time.core/within?</span> to test if a time <span class="monospaced">t</span> falls within
that interval. This function is passed as the predicate to <span class="monospaced">take-while</span>, which
will lazily consume values until <span class="monospaced">below-end?</span> fails.</p></div>
<div class="paragraph"><p>All together, <span class="monospaced">time-range</span> returns a lazy
sequence of <span class="monospaced">DateTime</span> objects that stretches from a start time to an end time,
stepped appropriately by the provided <span class="monospaced">step</span> value.</p></div>
<div class="paragraph"><p>Imagine trying to build something similar in a language
without first-class laziness.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_31">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_comparing">[sec_primitives_dates_comparing]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_time_between">[sec_primitives_dates_time_between]</a>
</p>
</li>
<li>
<p>
<a href="#sec_date_range_native_types">[sec_date_range_native_types]</a>, for an alternative that uses only native types
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_relative">[sec_primitives_dates_relative]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_date_range_native_types">Generating Ranges of Dates and Times Using Native Java Types</h3>
<div class="paragraph byline"><p>by Tom Hicks</p></div>
<div class="sect3">
<h4 id="_problem_32">Problem</h4>
<div class="paragraph"><p>You would like to generate a lazy sequence of dates (or times)
beginning with a specific date and time. Further, unlike in
<a href="#sec_primitives_dates_ranges">[sec_primitives_dates_ranges]</a>, you would like to do this using only
built-in types.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_32">Solution</h4>
<remark>A number of fixed-width function names like "repeatedly" are
being split across lines. Is there any way we can force monospaced
text to not wrap?</remark>
<div class="paragraph"><p>You can use Java&#8217;s <a href="http://bit.ly/javadoc-gregorian"><span class="monospaced">java.util.GregorianCalendar</span></a> class coupled with
Clojure&#8217;s <span class="monospaced">repeatedly</span> function to generate a lazy sequence of Gregorian
calendar dates. You can then use <a href="http://bit.ly/javadoc-simple-date-format"><span class="monospaced">java.text.SimpleDateFormat</span></a> to format the
dates, with a huge variety of output formats available.</p></div>
<div class="paragraph"><p>This example creates an infinite lazy sequence of Gregorian calendar
dates,<span class="footnote"><br>["Gregorian" is the formal name for the style of
calendar we all know and love. Read more on
<a href="http://bit.ly/gregorian-calendar">Wikipedia</a>.]<br></span> beginning
on January 1, 1970 and each spanning a single day. The core <span class="monospaced">take</span> and
<span class="monospaced">drop</span> functions are then used to select the last two days of
February (be careful not to evaluate the infinite sequence itself in
the REPL):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> daily<span style="color: #990000">-</span>from<span style="color: #990000">-</span>epoch
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>start<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>GregorianCalendar<span style="color: #990000">.</span> <span style="color: #993399">1970</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[]</span>
        <span style="color: #990000">(.</span>add start<span style="color: #990000">-</span>date java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Calendar<span style="color: #990000">/</span>DAY_OF_YEAR <span style="color: #993399">1</span><span style="color: #990000">)</span>
        <span style="color: #990000">(.</span>clone start<span style="color: #990000">-</span>date<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">2</span> <span style="font-weight: bold"><span style="color: #000000">(drop</span></span> <span style="color: #993399">57</span> daily<span style="color: #990000">-</span>from<span style="color: #990000">-</span>epoch<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#inst "1970-02-27T00:00:00.000-07:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "1970-02-28T00:00:00.000-07:00")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_32">Discussion</h4>
<div class="paragraph"><p>Clojure has no date type of its own; by default, it relies on its
ability to easily interoperate with Java (but see the <span class="monospaced">clj-time</span> library
for alternatives to Java&#8217;s date, time, and calendar classes).</p></div>
<div class="paragraph"><p>This solution is based on the core <span class="monospaced">repeatedly</span> function, which creates a lazy
sequence by repeatedly calling the argument function it is given and returning
a sequence of the function&#8217;s results. Because you do not provide the optional,
limiting argument to <span class="monospaced">repeatedly</span>, the result sequences produced are
infinite. Consequently, in the REPL environment, you must be careful to evaluate
your result sequences in contexts (such as <span class="monospaced">take</span> and <span class="monospaced">drop</span>) that
limit the values produced.</p></div>
<div class="paragraph"><p>Since the function given to <span class="monospaced">repeatedly</span> is a function of no arguments, it is
presumed to achieve its goals by side effects (making it an impure function).
Here, the impurity occurs as the argument function creates a Gregorian calendar
date and repeatedly increments it by a single <a href="http://bit.ly/javadoc-calendar"><span class="monospaced">java.util.Calendar</span></a> day
unit. For each call of the function, it returns a copy of the Gregorian calendar
object (to avoid mysterious and unintended side effects, it is advisable to
avoid returning the mutated object directly).</p></div>
<div class="paragraph"><p>The date values in the result sequence are of type
<span class="monospaced">java.util.GregorianCalendar</span>, but the <span class="monospaced">print</span> function of the REPL displays
them as an <span class="monospaced">#inst</span> reader literal. You can verify that the sequence elements
are Gregorian calendar objects by mapping the <span class="monospaced">class</span> (or <span class="monospaced">type</span>) function onto the
sequence:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> end<span style="color: #990000">-</span>of<span style="color: #990000">-</span>feb <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">2</span> <span style="font-weight: bold"><span style="color: #000000">(drop</span></span> <span style="color: #993399">57</span> daily<span style="color: #990000">-</span>from<span style="color: #990000">-</span>epoch<span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(map</span></span> class end<span style="color: #990000">-</span>of<span style="color: #990000">-</span>feb<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (java.util.GregorianCalendar java.util.GregorianCalendar)</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can generalize the solution to a function that takes a starting year
argument but defaults to some convenient year if the argument is not provided:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> daily<span style="color: #990000">-</span>from<span style="color: #990000">-</span>year <span style="color: #990000">[&amp;</span> <span style="color: #990000">[</span>start<span style="color: #990000">-</span>year<span style="color: #990000">]]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>start<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>GregorianCalendar<span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(or</span></span> start<span style="color: #990000">-</span>year <span style="color: #993399">1970</span><span style="color: #990000">)</span>
                                                 <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[]</span>
        <span style="color: #990000">(.</span>add start<span style="color: #990000">-</span>date java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Calendar<span style="color: #990000">/</span>DAY_OF_YEAR <span style="color: #993399">1</span><span style="color: #990000">)</span>
        <span style="color: #990000">(.</span>clone start<span style="color: #990000">-</span>date<span style="color: #990000">)</span> <span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">3</span> <span style="font-weight: bold"><span style="color: #000000">(daily</span></span><span style="color: #990000">-</span>from<span style="color: #990000">-</span>year <span style="color: #993399">1999</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#inst "1999-01-01T00:00:00.000-07:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "1999-01-02T00:00:00.000-07:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "1999-01-03T00:00:00.000-07:00")</span></span>

<span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">2</span> <span style="font-weight: bold"><span style="color: #000000">(daily</span></span><span style="color: #990000">-</span>from<span style="color: #990000">-</span>year<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#inst "1970-01-01T00:00:00.000-07:00"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #inst "1970-01-02T00:00:00.000-07:00")</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using the <span class="monospaced">java.text.SimpleDateFormat</span> class, you can then format the dates in a
wide variety of different formats:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> end<span style="color: #990000">-</span>of<span style="color: #990000">-</span>days <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">3</span> <span style="font-weight: bold"><span style="color: #000000">(drop</span></span> <span style="color: #993399">353</span> <span style="font-weight: bold"><span style="color: #000000">(daily</span></span><span style="color: #990000">-</span>from<span style="color: #990000">-</span>year <span style="color: #993399">2012</span><span style="color: #990000">))))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> cal<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>text<span style="color: #990000">.</span>SimpleDateFormat<span style="color: #990000">.</span> <span style="color: #FF0000">"EEE M/d/yyyy"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> iso8601<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>text<span style="color: #990000">.</span>SimpleDateFormat<span style="color: #990000">.</span> <span style="color: #FF0000">"yyyy-MM-dd'T'HH:mm:ss'Z'"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="color: #990000">(.</span>format cal<span style="color: #990000">-</span>format <span style="color: #990000">(.</span>getTime <span style="color: #990000">%))</span> end<span style="color: #990000">-</span>of<span style="color: #990000">-</span>days<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Wed 12/19/2012" "Thu 12/20/2012" "Fri 12/21/2012")</span></span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="color: #990000">(.</span>format iso8601<span style="color: #990000">-</span>format <span style="color: #990000">(.</span>getTime <span style="color: #990000">%))</span> end<span style="color: #990000">-</span>of<span style="color: #990000">-</span>days<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("2012-12-19T00:00:00Z" "2012-12-20T00:00:00Z" "2012-12-21T00:00:00Z")</span></span></tt></pre></div></div>
<div class="paragraph"><p>To put it all together, create a function that generates an
infinite lazy sequence of formatted Gregorian date strings. For convenience,
the function takes optional starting year and date format string arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> gregorian<span style="color: #990000">-</span>day<span style="color: #990000">-</span>seq
  <span style="color: #FF0000">"Return an infinite sequence of formatted Gregorian day strings</span>
<span style="color: #FF0000">  starting on January 1st of the given year (default 1970)"</span>
  <span style="color: #990000">[&amp;</span> <span style="color: #990000">[</span>start<span style="color: #990000">-</span>year date<span style="color: #990000">-</span>format<span style="color: #990000">]]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>gd<span style="color: #990000">-</span>format <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>text<span style="color: #990000">.</span>SimpleDateFormat<span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(or</span></span> date<span style="color: #990000">-</span>format <span style="color: #FF0000">"EEE M/d/yyyy"</span><span style="color: #990000">))</span>
        start<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>GregorianCalendar<span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(or</span></span> start<span style="color: #990000">-</span>year <span style="color: #993399">1970</span><span style="color: #990000">)</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[]</span>
        <span style="color: #990000">(.</span>add start<span style="color: #990000">-</span>date java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Calendar<span style="color: #990000">/</span>DAY_OF_YEAR <span style="color: #993399">1</span><span style="color: #990000">)</span>
        <span style="color: #990000">(.</span>format gd<span style="color: #990000">-</span>format <span style="color: #990000">(.</span>getTime start<span style="color: #990000">-</span>date<span style="color: #990000">))</span> <span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>To test the function, select the last Sunday of the year by finding all of the
Sundays in a year:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> y2k <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">366</span> <span style="font-weight: bold"><span style="color: #000000">(gregorian</span></span><span style="color: #990000">-</span>day<span style="color: #990000">-</span>seq <span style="color: #993399">2000</span><span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(last</span></span> <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #<span style="color: #990000">(.</span>startsWith <span style="color: #990000">%</span> <span style="color: #FF0000">"Sun"</span><span style="color: #990000">)</span> y2k<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Sun 12/31/2000"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_32">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_current_date">[sec_primitives_dates_current_date]</a>, for information on using
  <span class="monospaced">java.util.Date</span> from Clojure
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_reader_literal">[sec_primitives_dates_reader_literal]</a>, to learn about Clojure&#8217;s <span class="monospaced">#inst</span>
  reader literal for date/times
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_ranges">[sec_primitives_dates_ranges]</a>, for an alternative that utilizes
  <span class="monospaced">clj-time</span>/Joda-Time
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_dates_relative">Retrieving Dates Relative to One Another</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_33">Problem</h4>
<div class="paragraph"><p>You need to calculate a time relative to some other time, à la
<a href="http://rubyonrails.org/">Ruby on Rails'</a> <span class="monospaced">2.days.from_now</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_33">Solution</h4>
<div class="paragraph"><p>Because relative time is such a complex beast, we suggest using
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> for calculating
relative dates and times.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-time "0.6.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time</tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;ve used the Ruby on Rails framework, then you&#8217;re likely
accustomed to statements like <span class="monospaced">1.day.from_now</span>, <span class="monospaced">3.days.ago</span>, or
<span class="monospaced">some_date - 2.years</span>. You&#8217;ll be pleased to know that <span class="monospaced">clj-time</span> exposes
similar functionality:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; 1.day.from_now (it's April 6 at the time of this writing)</span></span>
<span style="color: #990000">(-&gt;</span> <span style="color: #993399">1</span>
    t<span style="color: #990000">/</span>days
    t<span style="color: #990000">/</span>from<span style="color: #990000">-</span>now<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-07T20:36:52.012Z&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; 3.days.ago</span></span>
<span style="color: #990000">(-&gt;</span> <span style="color: #993399">3</span>
    t<span style="color: #990000">/</span>days
    t<span style="color: #990000">/</span>ago<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-03T20:37:06.844Z&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">clj-time.core</span> functions <span class="monospaced">from-now</span> and <span class="monospaced">ago</span> are just syntactic sugar
over <span class="monospaced">plus</span> and <span class="monospaced">minus</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; 1.year.from_now</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>plus <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>now<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>years <span style="color: #993399">1</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2014-04-06T20:41:43.638Z&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; some_date - 2.years</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> some<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2053</span> <span style="color: #993399">12</span> <span style="color: #993399">25</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>minus some<span style="color: #990000">-</span>date <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>years <span style="color: #993399">2</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2051-12-25T00:00:00.000Z&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_33">Discussion</h4>
<div class="paragraph"><p>Despite how difficult dates and times can sometimes be in Java,
<span class="monospaced">clj-time</span> manages to expose a joyful syntax for adding to and
subtracting from dates.</p></div>
<div class="paragraph"><p>The functions <span class="monospaced">plus</span>, <span class="monospaced">minus</span>, <span class="monospaced">from-now</span>, and <span class="monospaced">ago</span> all take a period
of time and adjust a <span class="monospaced">DateTime</span> by that amount (be that time "now," as
in <span class="monospaced">from-now</span> or <span class="monospaced">ago</span>, or some provided time).</p></div>
<div class="paragraph"><p><span class="monospaced">clj-time.core</span>
includes a number of useful period helpers ranging from <span class="monospaced">millis</span> to
<span class="monospaced">years</span> that produce a time period at a given scale.</p></div>
<div class="paragraph"><p>Depending on your use case, it&#8217;s even possible to arrange operation,
time period, and time in such a manner that they almost read like a
sentence.</p></div>
<div class="paragraph"><p>Take <span class="monospaced">(-&gt; 1 t/years t/from-now)</span>, for example. In this case,
the threading macro <span class="monospaced">-&gt;</span> threads each value as an argument to the next,
producing <span class="monospaced">(t/from-now (t/years 1))</span>.</p></div>
<div class="paragraph"><p>It&#8217;s up to you to arrange your
function calls as you see fit, but know that it is quite possible to
produce readable deep-nested calls like this.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_33">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_comparing">[sec_primitives_dates_comparing]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_ranges">[sec_primitives_dates_ranges]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_time_zones">Working with Time Zones</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_34">Problem</h4>
<div class="paragraph"><p>You need to gracefully handle times and dates in a number of time zones.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_34">Solution</h4>
<div class="paragraph"><p>The JVM&#8217;s built-in time and date classes don&#8217;t work well with the notion
of time zones. For one, <span class="monospaced">Date</span> treats every value as UTC, and <span class="monospaced">Calendar</span> is
cumbersome to work with in Clojure (or Java, for that matter). Use
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> to properly deal with
time zones.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-time "0.6.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; My birth-time, in the correct time zone</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> bday <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>from<span style="color: #990000">-</span>time<span style="color: #990000">-</span>zone <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">02</span> <span style="color: #993399">18</span> <span style="color: #993399">18</span><span style="color: #990000">)</span>
                            <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>time<span style="color: #990000">-</span>zone<span style="color: #990000">-</span>for<span style="color: #990000">-</span>offset <span style="color: #990000">-</span><span style="color: #993399">6</span><span style="color: #990000">)))</span>

bday
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2012-02-18T18:00:00.000-06:00&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; What time was it in Brisbane when I was born?</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> australia<span style="color: #990000">-</span>bday
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to<span style="color: #990000">-</span>time<span style="color: #990000">-</span>zone bday <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>time<span style="color: #990000">-</span>zone<span style="color: #990000">-</span>for<span style="color: #990000">-</span>id <span style="color: #FF0000">"Australia/Brisbane"</span><span style="color: #990000">)))</span>

australia<span style="color: #990000">-</span>bday
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2012-02-19T10:00:00.000+10:00&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Yet they are the same instant in time.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> bday australia<span style="color: #990000">-</span>bday<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_34">Discussion</h4>
<div class="paragraph"><p>Unlike Java built-ins, <span class="monospaced">clj-time</span> knows a lot about time zones.
<a href="http://bit.ly/joda-time">Joda-Time</a>, the library <span class="monospaced">clj-time</span>
wraps, bundles the internationally recognized
<a href="http://bit.ly/tz-info"><span class="monospaced">tz</span> database</a>. This database
captures the IDs and time offsets for nearly every location on the
planet.</p></div>
<div class="paragraph"><p>The <span class="monospaced">tz</span> database also captures information about daylight saving time.
For example, Los Angeles is UTC-08:00 in the winter and UTC-07:00
during the summer. This is accurately reflected when using <span class="monospaced">clj-time</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> la<span style="color: #990000">-</span>tz <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>time<span style="color: #990000">-</span>zone<span style="color: #990000">-</span>for<span style="color: #990000">-</span>id <span style="color: #FF0000">"America/Los_Angeles"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; LA is UTC-08:00 in winter</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>from<span style="color: #990000">-</span>time<span style="color: #990000">-</span>zone <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">01</span> <span style="color: #993399">01</span><span style="color: #990000">)</span> la<span style="color: #990000">-</span>tz<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2012-01-01T00:00:00.000-08:00&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; ... and UTC-07:00 in summer</span></span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>from<span style="color: #990000">-</span>time<span style="color: #990000">-</span>zone <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2012</span> <span style="color: #993399">06</span> <span style="color: #993399">01</span><span style="color: #990000">)</span> la<span style="color: #990000">-</span>tz<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2012-06-01T00:00:00.000-07:00&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">clj-time.core/from-time-zone</span> function takes any <span class="monospaced">DateTime</span> and
modifies its time zone to the desired time zone. This is useful
in cases where you receive a date, time, and time zone separately
and want to combine them into an accurate <span class="monospaced">DateTime</span> instance.</p></div>
<div class="paragraph"><p>The <span class="monospaced">clj-time.core/to-time-zone</span> function has the same signature as
<span class="monospaced">from-time-zone</span>; it returns a <span class="monospaced">DateTime</span> for the exact same point in
time, but from the perspective of another time zone. This is useful
for presenting time and date information from disparate sources to a
user in her preferred time zone.</p></div>
<div class="paragraph"><p>Sometimes you may only want to deal with machine-local time. The
<span class="monospaced">clj-time.local</span> namespace provides a number of functions to that end,
including <span class="monospaced">local-now</span>, for getting a time in the local time zone, and
<span class="monospaced">to-local-date-time</span>, which shifts the perspective of a time to the
local time zone.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_34">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_time_between">[sec_primitives_dates_time_between]</a>, and <a href="#sec_primitives_dates_relative">[sec_primitives_dates_relative]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_date_from_unix_timestamp">Converting a Unix Timestamp to a Date</h3>
<div class="paragraph byline"><p>by Steven Proctor</p></div>
<div class="sect3">
<h4 id="_problem_35">Problem</h4>
<div class="paragraph"><p>You need to get a <span class="monospaced">Date</span> object from a Unix timestamp.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_35">Solution</h4>
<div class="paragraph"><p>When dealing with data from outside systems, you&#8217;ll find that many systems
express timestamps in Unix time format.  You may
encounter this when dealing with certain datastores, parsing out data
from timestamps in log files, or working with any number of other systems that
have to deal with dates and times across multiple different time zones
and cultures.</p></div>
<div class="paragraph"><p>Fortunately, with Clojure&#8217;s ability for nice interoperability with Java,
you have an easy solution at hand:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> from<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time
  <span style="color: #FF0000">"Return a Java Date object from a Unix time representation expressed</span>
<span style="color: #FF0000">  in whole seconds."</span>
  <span style="color: #990000">[</span>unix<span style="color: #990000">-</span>time<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">.</span> unix<span style="color: #990000">-</span>time<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>This is how you can use the <span class="monospaced">from-unix-time</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(from</span></span><span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time <span style="color: #993399">1366127520000</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "2013-04-16T15:52:00.000-00:00"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_35">Discussion</h4>
<div class="paragraph"><p>To get a Java <span class="monospaced">Date</span> object from a Unix time object, all you need to
do is construct a new
<a href="http://bit.ly/javadoc-date"><span class="monospaced">java.util.Date</span></a>
object using Clojure&#8217;s Java interop functionality.</p></div>
<div class="paragraph"><p>If you are already using or wish to use the
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> library, you can use <span class="monospaced">clj-time</span>
to obtain a <span class="monospaced">DateTime</span> object from a Unix timestamp:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>coerce <span style="color: #990000">:</span>as timec<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> datetime<span style="color: #990000">-</span>from<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time
  <span style="color: #FF0000">"Return a DateTime object from a Unix time representation expressed</span>
<span style="color: #FF0000">  in whole seconds."</span>
  <span style="color: #990000">[</span>unix<span style="color: #990000">-</span>time<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(timec</span></span><span style="color: #990000">/</span>from<span style="color: #990000">-</span><span style="color: #009900">long</span> unix<span style="color: #990000">-</span>time<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>And using the <span class="monospaced">datetime-from-unix-time</span> function, you can see you get a
<span class="monospaced">DateTime</span> object back with the correct time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(datetime</span></span><span style="color: #990000">-</span>from<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time <span style="color: #993399">1366127520000</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;DateTime 2013-04-16T15:52:00.000Z&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>You may not need to worry about dates and times being expressed as seconds
very often, but when you do, isn&#8217;t it nice to know how easy it can be to
get those timestamps into a date format used by the rest of the system?</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_35">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_current_date">[sec_primitives_dates_current_date]</a>
</p>
</li>
<li>
<p>
<a href="#sec_date_to_unix_timestamp">[sec_date_to_unix_timestamp]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_date_to_unix_timestamp">Converting a Date to a Unix Timestamp</h3>
<div class="paragraph byline"><p>by Steven Proctor</p></div>
<div class="sect3">
<h4 id="_problem_36">Problem</h4>
<div class="paragraph"><p>You need to get a Unix timestamp representation for a <span class="monospaced">Date</span> object.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_36">Solution</h4>
<div class="paragraph"><p>Many systems express timestamps in Unix time format, and when
you have to interact with these systems, you have to give them date
and time information in the format they desire.</p></div>
<div class="paragraph"><p>Fortunately, with Clojure&#8217;s ability for nice interoperability with Java,
you have an easy solution at hand:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> to<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time
  <span style="color: #FF0000">"Returns a Unix time representation expressed in whole seconds</span>
<span style="color: #FF0000">   given a java.util.Date."</span>
  <span style="color: #990000">[</span>date<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>getTime date<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>This is how you can use the <span class="monospaced">to-unix-time</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> date <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>string <span style="color: #FF0000">"#inst </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">2013-04-16T15:52:00.000-00:00</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'user/date</span></span>

<span style="font-weight: bold"><span style="color: #000000">(to</span></span><span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time date<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1366127520000</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_36">Discussion</h4>
<div class="paragraph"><p>When you have a <a href="http://bit.ly/javadoc-date"><span class="monospaced">java.util.Date</span></a> object, you can use the Java interop
provided by Clojure as an easy way to get the time represented as a Unix
time.  Java&#8217;s <span class="monospaced">Date</span> objects have a method called <span class="monospaced">getTime</span> that returns the
date as a Unix time.</p></div>
<div class="paragraph"><p>If you are already using or wish to use the
<a href="https://github.com/clj-time/clj-time"><span class="monospaced">clj-time</span></a> library, you can use <span class="monospaced">clj-time</span>
to obtain a Unix time&#x2013;formatted <span class="monospaced">DateTime</span> object if you have a <span class="monospaced">DateTime</span> object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>time<span style="color: #990000">.</span>coerce <span style="color: #990000">:</span>as timec<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> datetime<span style="color: #990000">-</span>to<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time
  <span style="color: #FF0000">"Returns a Unix time representation expressed in whole seconds</span>
<span style="color: #FF0000">   given a DateTime."</span>
  <span style="color: #990000">[</span>datetime<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(timec</span></span><span style="color: #990000">/</span>to<span style="color: #990000">-</span><span style="color: #009900">long</span> datetime<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>And using the <span class="monospaced">datetime-to-unix-time</span> function, you can see you get a
Unix time format for a <span class="monospaced">DateTime</span> object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> datetime <span style="font-weight: bold"><span style="color: #000000">(clj</span></span><span style="color: #990000">-</span>time<span style="color: #990000">.</span>core<span style="color: #990000">/</span>date<span style="color: #990000">-</span>time <span style="color: #993399">2013</span> <span style="color: #993399">04</span> <span style="color: #993399">16</span> <span style="color: #993399">15</span> <span style="color: #993399">52</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; #'user/datetime</span></span>

<span style="font-weight: bold"><span style="color: #000000">(datetime</span></span><span style="color: #990000">-</span>to<span style="color: #990000">-</span>unix<span style="color: #990000">-</span>time datetime<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; 1366127520000</span></span></tt></pre></div></div>
<div class="paragraph"><p>Thanks to <span class="monospaced">clj-time.coerce</span>, all that is needed is to use the function
<span class="monospaced">to-long</span> to get a Joda-Time <span class="monospaced">DateTime</span> object into a Unix time format.</p></div>
<div class="paragraph"><p>Your system may never need to interact with other systems that expect
timestamps expressed in Unix time, but if you are designing a system
that does, Clojure makes it very easy to express a <span class="monospaced">Date</span> or <span class="monospaced">DateTime</span> in
Unix time format.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_36">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_current_date">[sec_primitives_dates_current_date]</a>
</p>
</li>
<li>
<p>
<a href="#sec_date_from_unix_timestamp">[sec_date_from_unix_timestamp]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_composite_data">Composite Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2">Introduction</h3>
<div class="paragraph"><p>Now that we&#8217;ve got primitives out of the way, we need to start doing
something with them. Single atomic values are great and all, but
things get much more interesting when we start globbing them all
together. As you&#8217;ll see soon enough, data manipulation is one of
Clojure&#8217;s strong suits.</p></div>
<div class="paragraph"><p>What makes Clojure so good at manipulating collections? It comes down
to three things: <em>immutability</em>, <em>persistence</em>, and the <em>sequence
abstraction</em>. Every one of Clojure&#8217;s built-in collection types has these
properties and is thus unified in its API&#8217;s appearance and
behavior.</p></div>
<div class="paragraph"><p>As the great Alan J. Perlis (an early computer science pioneer) put it:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>It is better to have 100 functions operate on one data structure than
to have 10 functions operate on 10 data structures.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>This chapter introduces Clojure collections and where/how to use them.
Finally, we wrap things up by showing you how to build your own
feature-complete types that look and behave just like the rest of
Clojure&#8217;s collections by leveraging Clojure&#8217;s capacity for interface
polymorphism.</p></div>
<div class="sect3">
<h4 id="_immutability">Immutability</h4>
<div class="paragraph"><p>Immutability means that a Clojure data structure, once created, can
never change. You can only "modify" an immutable data structure by
creating a <em>new</em> data structure that is a copy of the old, with the
desired changes in place.</p></div>
<div class="paragraph"><p>Immutability also means that Clojure data structures, however deeply
nested, are simple <em>values</em>, just like the number <span class="monospaced">3</span> or the character
<span class="monospaced">\z</span>. It doesn&#8217;t make sense to speak of "changing" the value of <span class="monospaced">3</span>&#x2014;
it just is. If you "change" it by, say, incrementing it, you don&#8217;t
modify <span class="monospaced">3</span> itself. Instead, you end up with an entirely new and
different value, <span class="monospaced">4</span>. Clojure extends this notion of value to all data
structures. In Clojure, any action that in another language would
perform any kind of update on a data structure will instead return an
entirely new one. You can continue to pass around and use both the old
and the new versions with confidence, knowing that nothing you can do
will cause any unintended changes elsewhere in your program.</p></div>
<div class="paragraph"><p>This feature is extremely important in concurrent and parallel
programming, where unexpected mutation is the source of a large class
of bugs. With immutable data, any number of threads can read from the
same data without any worrying about locks or race conditions&#8212;it&#8217;s
always safe to read something that can&#8217;t change. "Clone" operations
are not only free, but unnecessary.</p></div>
</div>
<div class="sect3">
<h4 id="_persistence">Persistence</h4>
<div class="paragraph"><p>But, you may ask, how can that possibly be efficient? Surely it is
impractical to do a full copy of an object every time you need to add
something?</p></div>
<div class="paragraph"><p>Yes, it would be, except for the feature of persistence. Persistence
means that Clojure&#8217;s data structures, although logically immutable,
can still share pieces of their internal structure for efficiency in
both time and space. Essentially, updated versions of immutable data
only need to store the deltas from pervious versions, rather than
doing a full deep copy.</p></div>
<div class="paragraph"><p>To make it performant, all of this uses some extremely clever
algorithms, of course. See the book <em>Purely Functional Data
Structures</em> by Chris Okasaki (Cambridge University Press) for a detailed description of how they
work.</p></div>
</div>
<div class="sect3">
<h4 id="_the_sequence_abstraction">The Sequence Abstraction</h4>
<div class="paragraph"><p>From vectors, maps, sets, and lists to strings and streams, every last
one of Clojure&#8217;s collections behaves in a similar, predictable fashion. They are simple tools for a more civilized age. This is on account of Clojure&#8217;s
sequence abstraction.</p></div>
<div class="paragraph"><p>The array of collection-manipulating functions in Clojure are all
implemented in terms of one simple abstraction: every collection can
be treated as a sequence of values. By implementing <span class="monospaced">first</span>, <span class="monospaced">rest</span>,
and <span class="monospaced">cons</span>, any data structure&#8212;even ones you build yourself&#8212;can
participate in the <span class="monospaced">ISeq</span> interface.</p></div>
<div class="paragraph"><p>Then, you can use Clojure&#8217;s huge library of functions that can operate
on sequences, with <em>any</em> of the data structures. All of functional
programming&#8217;s most beloved functions (<span class="monospaced">map</span>, <span class="monospaced">reduce</span>, <span class="monospaced">filter</span>, etc.)
will work interchangeably on any data structure. In essence, the
sequence abstraction allows all the expressiveness of traditional
list-based LISP programming without forcing you to actually use lists. Instead, use whatever type is most efficient for the task, knowing
that you can consume them all in the same way when it makes sense to
do so.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_creating_a_list">Creating a List</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_37">Problem</h4>
<div class="paragraph"><p>You want to create a list data structure in your source code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_37">Solution</h4>
<div class="paragraph"><p>There are two basic ways to specifically construct a list (a
<span class="monospaced">clojure.lang.PersistentList</span>).</p></div>
<div class="paragraph"><p>You can use parentheses in combination with a single quote to indicate that
the list should only be read as a data structure, not immediately
evaluated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>'<span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 :2 "3")</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or, more commonly, you can use the <span class="monospaced">list</span> function, which takes a
variadic number of arguments and constructs a list from them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 :2 "3")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_37">Discussion</h4>
<div class="paragraph"><p>Typically, between these two approaches, using the <span class="monospaced">list</span> function is
the better choice. The problem with constructing quoted lists is that
the quote also prevents evaluation of everything <em>inside</em> the list,
which means that symbols will be returned as literal symbols, instead
of resolving variables or calling functions. <span class="monospaced">list</span>, however, will evaluate its
arguments in the normal way before constructing the list and is
usually what is desired for nonmacro code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> x <span style="color: #993399">2</span><span style="color: #990000">)</span>

'<span style="color: #990000">(</span><span style="color: #993399">1</span> x<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 x)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> x<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 2)</span></span></tt></pre></div></div>
<div class="paragraph"><p>That said, <span class="monospaced">'()</span> is the idiomatic way to create an empty list&#8212;it is
more terse, and the concern about evaluating its contents is
irrelevant when it&#8217;s empty.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lists Versus Vectors</div>
<div class="paragraph"><p>Clojure includes both list and vector types. Both are sequential data
structures. However, for most purposes, vectors are a better fit and
are more commonly used in idiomatic Clojure.</p></div>
<div class="paragraph"><p>There are a couple of reasons for this. Vectors have a cleaner literal
syntax than lists and are just as space-efficient and performant. In
addition, vectors support near-constant lookup time by index
(<em>O</em>(log<sub>32</sub> <em>n</em>)), as opposed to lists, which require linear time
(<em>O</em>(<em>n</em>)).</p></div>
<div class="paragraph"><p>In general, the only reason to explicitly choose a list over a vector is
if you need a data structure that supports efficient insertions at
the beginning, which lists do; vectors are most efficient when
appending items to the end.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_37">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_creating_a_list_from_existing">[sec_creating_a_list_from_existing]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_creating_a_vector">[sec_composite_creating_a_vector]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_creating_a_list_from_existing">Creating a List from an Existing Data Structure</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_38">Problem</h4>
<div class="paragraph"><p>You have an existing sequential data structure that you would like to
convert into a list as its concrete data type.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_38">Solution</h4>
<div class="paragraph"><p>The easiest solution is: don&#8217;t. Having a concrete list provides little
or no advantage over simply using the sequence abstraction directly on
your existing data, and for large data structures, conversion can be
expensive.</p></div>
<div class="paragraph"><p>If you do know that you need an explicit conversion of the concrete
data structure, there are two ways to do it.</p></div>
<div class="paragraph"><p>First, you could use the <span class="monospaced">apply</span> function to call the <span class="monospaced">list</span> function,
passing it your existing data structure as its arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(apply</span></span> list <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 2 3 4 5)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Alternatively, you could use the <span class="monospaced">into</span> function to repeatedly conjoin
elements from your original data onto a list. Note, however, that
this approach has the effect of reversing the order of the original
collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(into</span></span> '<span style="color: #990000">()</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (5 4 3 2 1)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_38">Discussion</h4>
<div class="paragraph"><p>These two approaches are both viable choices. However, what actually
happens in each case is very different.</p></div>
<div class="paragraph"><p>When using <span class="monospaced">apply</span>, you are actually invoking the <span class="monospaced">list</span> function with
however many arguments are in the data structure. This may sound
strange, particularly if the data structure contains millions of
items. What does it mean to invoke a function with a million
arguments? How does that even work, given that the JVM limits methods
to 255 arguments (see the <a href="http://bit.ly/jvm-class-file-format">JVM
class file specification</a>)?</p></div>
<div class="paragraph"><p>As it turns out, functions with variadic arguments (such as <span class="monospaced">list</span>)
are handled in a somewhat special way: the argument list is passed in
as a sequence. <span class="monospaced">apply</span> knows this and passes this sequence view of the
original structure directly through to the receiving function. This is
why it works; there is never actually a JVM method invocation with a
million arguments.</p></div>
<div class="paragraph"><p><span class="monospaced">into</span> works quite differently: it takes two arguments, the first
being a data structure and the second being a sequence. It then
repeatedly conjoins items from the sequence onto the data structure
provided using the <span class="monospaced">conj</span> function (discussed in greater detail
elsewhere). This is why the sequence is reversed; items are always
pulled from the front of the sequence, but <span class="monospaced">conj</span> on a list <em>prepends</em>
the element being added. Therefore, the first element in the input
sequence will end up being the last item in the list, and so on.</p></div>
<div class="paragraph"><p>So why ever choose <span class="monospaced">into</span> over <span class="monospaced">apply</span>, given that it reverses the
order? Speed. <span class="monospaced">into</span> utilizes Clojure <em>transients</em>, which provide a
considerable performance improvement. On the author&#8217;s machine,
converting a million-item vector to a list using <span class="monospaced">apply</span> took an
average of 750 milliseconds, while using <span class="monospaced">into</span> took about half that
time, for an average of 350 milliseconds. Of course, the list was in
reverse order, and reversing either the input or the output negates
the speed advantage. In the end, <span class="monospaced">into</span> is only advantageous in
situations where a reversed order is acceptable.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_38">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_creating_a_list">[sec_creating_a_list]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_adding_to_a_list">"Adding" an Item to a List</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_39">Problem</h4>
<div class="paragraph"><p>You want to add an item to a list; or, putting it in functional terms,
you want to derive from an existing list a new list that contains an
additional item.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_39">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">conj</span> function. <span class="monospaced">conj</span> is used to add an item or items to a
logical collection and is polymorphic, meaning it works on multiple
concrete data types, including lists:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(conj</span></span> <span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (4 1 2 3)</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can also add multiple items at once:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(conj</span></span> <span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (5 4 1 2 3)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_39">Discussion</h4>
<div class="paragraph"><p>The behavior of <span class="monospaced">conj</span> may vary slightly depending on the concrete
type. It always "adds" an item to an immutable collection by returning
a new collection containing the new item, but may add the item to
different places in the collection depending on what is most efficient
for the particular type.</p></div>
<div class="paragraph"><p>In the case of lists, <span class="monospaced">conj</span> will always add the item at the
<em>beginning</em> of the list, since a linked list data structure supports
constant-time insertion only at the beginning.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">conj Versus cons</div>
<div class="paragraph"><p>If you are familiar with Common Lisp or Scheme, you were probably
expecting to see the <span class="monospaced">cons</span> function used, instead of <span class="monospaced">conj</span>. Clojure
does have a <span class="monospaced">cons</span> function, but it has a slightly different purpose.</p></div>
<div class="paragraph"><p>While <span class="monospaced">conj</span> will return a new concrete <span class="monospaced">clojure.lang.PersistentList</span>
(when used on a list), <span class="monospaced">cons</span> will always construct a new <em>sequence</em>,
where the item added is the <em>first</em> and the collection is the <em>rest</em>.</p></div>
<div class="paragraph"><p>This distinction is subtle, especially since a
<span class="monospaced">clojure.lang.PersistentList</span> and a sequence constructed using <span class="monospaced">cons</span>
are both types of persistent linked lists, algorithmically speaking.</p></div>
<div class="paragraph"><p>The best way to think about it is that <span class="monospaced">conj</span> is a concrete <em>data
structure</em> operation, which will not change the concrete type of the
data structure it is applied to, while <span class="monospaced">cons</span> is a <em>sequence</em>
operation and only guarantees that it will return a sequence: in fact,
it returns a cons cell (<span class="monospaced">clojure.lang.Cons</span>) that implements the
sequence interface, no matter what type of <em>seq</em>-able collection you
gave it to start with.</p></div>
<div class="paragraph"><p>Unlike <span class="monospaced">conj</span>, <span class="monospaced">cons</span> is also guaranteed to return a sequence with the
item prepended to the beginning no matter what the collection type is.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_39">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_adding_to_a_vector">[sec_adding_to_a_vector]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_removing_an_item_list">"Removing" an Item from a List</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_40">Problem</h4>
<div class="paragraph"><p>You want to obtain a list without a particular item in it, removing
an item from the original list.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_40">Solution</h4>
<div class="paragraph"><p>Removing the first item from a list is easily accomplished using one
of two functions, <span class="monospaced">rest</span> or <span class="monospaced">pop</span>. Both work identically when used on
a nonempty list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(pop</span></span> '<span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (2 3)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(rest</span></span> '<span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (2 3)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_40">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">rest</span> is actually a sequence function, used to obtain the tail of a
sequence. Since Clojure lists implement the sequence interface
directly, using <span class="monospaced">rest</span> on a list will always return another (possibly
empty) list.</p></div>
<div class="paragraph"><p><span class="monospaced">pop</span> is similar to <span class="monospaced">conj</span> in that it operates on concrete data
structures rather than the sequence interface. Like <span class="monospaced">conj</span>, it is
polymorphic; also like <span class="monospaced">conj</span>, the position it removes the item
from depends on what&#8217;s most efficient for the concrete type.</p></div>
<div class="paragraph"><p>When used on an empty list, the behavior does differ; <span class="monospaced">pop</span> will throw
an exception, while <span class="monospaced">rest</span> will return an empty list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(pop</span></span> '<span style="color: #990000">())</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; IllegalStateException Can't pop empty list ...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(rest</span></span> '<span style="color: #990000">())</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ()</span></span></tt></pre></div></div>
<div class="paragraph"><p>Lists do not support removing items except at the first position. If
you need to remove an item in the middle or at the end of a list,
you&#8217;ll have to do so using the sequence manipulation functions, then
convert the result back into a concrete list (if you absolutely need
it to be a list, for some reason).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_40">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_removing_an_item_from_vector">[sec_composite_removing_an_item_from_vector]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_for_a_list">Testing for a List</h3>
<div class="paragraph byline"><p>by Steve Miner</p></div>
<div class="sect3">
<h4 id="_problem_41">Problem</h4>
<div class="paragraph"><p>You want to test if a value is a list.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_41">Solution</h4>
<div class="paragraph"><p>The <span class="monospaced">list?</span> function may seem like the obvious choice, but in most
cases, it&#8217;s better to use the more general <span class="monospaced">seq?</span> function as your
test.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_41">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">list?</span> function specifically tests if the argument implements
<span class="monospaced">clojure.lang.IPersistentList</span>, but in most cases, you really want to
know if the value is a <em>seq</em> (implements <span class="monospaced">clojure.lang.ISeq</span>), which
is a more general abstraction than a list.</p></div>
<div class="paragraph"><p>Not everything that prints as a <em>list</em> (in parentheses) actually
satisfies the <span class="monospaced">list?</span> test. In practice, you&#8217;ll often receive <span class="monospaced">Cons</span>
and <span class="monospaced">LazySeq</span> values when manipulating lists. By focusing on the
fundamental <em>seq</em> abstraction, you don&#8217;t need to worry about the
details of those concrete implementations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; A list constructed via list satisfies both list? and seq?</span></span>
<span style="font-weight: bold"><span style="color: #000000">(list</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>
<span style="font-weight: bold"><span style="color: #000000">(seq</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(list</span></span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; cons, however *looks* like a list, but is actually a Cons</span></span>
<span style="font-weight: bold"><span style="color: #000000">(list</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(cons</span></span> <span style="color: #993399">1</span> '<span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-weight: bold"><span style="color: #000000">(type</span></span> <span style="font-weight: bold"><span style="color: #000000">(cons</span></span> <span style="color: #993399">1</span> '<span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; clojure.lang.Cons</span></span>
<span style="font-weight: bold"><span style="color: #000000">(seq</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(cons</span></span> <span style="color: #993399">1</span> '<span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; range's lazy return value is a seq, but not a list</span></span>
<span style="font-weight: bold"><span style="color: #000000">(list</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-weight: bold"><span style="color: #000000">(seq</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>
<span style="font-weight: bold"><span style="color: #000000">(type</span></span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; clojure.lang.LazySeq</span></span></tt></pre></div></div>
<div class="paragraph"><p>It&#8217;s almost always better to use <span class="monospaced">seq?</span> instead of <span class="monospaced">list?</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_41">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_creating_a_list">[sec_creating_a_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_adding_to_a_list">[sec_adding_to_a_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_test_collection_with_set">[sec_test_collection_with_set]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_creating_a_vector">Creating a Vector</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_42">Problem</h4>
<div class="paragraph"><p>You want to create a vector data structure, either as a literal or
from an existing data structure.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_42">Solution</h4>
<div class="paragraph"><p>By far, the easiest way to create a vector is using the literal vector
notation of square brackets. However, it is also possible to use the
<span class="monospaced">vector</span> function, which creates a vector of its arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">]</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 :2 "3"]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(vector</span></span> <span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 :2 "3"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>To construct a vector from an existing data structure, you can use the
<span class="monospaced">vec</span> function, which takes any collection and returns a vector
containing the same items:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(vec</span></span> '<span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 :2 "3"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Alternatively, you can use the <span class="monospaced">into</span> function, which takes two
collections and repeatedly invokes <span class="monospaced">conj</span> on the first with items from
the second:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">[]</span> '<span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 :2 "3"]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_42">Discussion</h4>
<div class="paragraph"><p>There is rarely any reason to use the <span class="monospaced">vector</span> function over the
literal vector syntax. Unlike lists, vectors are not evaluated as
function calls (or anything else) in Clojure, so quoting is not a
concern as it is with list literals.</p></div>
<div class="paragraph"><p>Oddly enough, when constructing a vector from an existing collection,
using the <span class="monospaced">into</span> approach is currently about 30% more performant on
large collections compared to <span class="monospaced">vec</span> due to its use of transients to
speed things up. If you&#8217;re converting large collections and speed
matters, consider using <span class="monospaced">into</span>. Otherwise, <span class="monospaced">vec</span> is usually more
readable.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_42">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_creating_a_list">[sec_creating_a_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_creating_a_list_from_existing">[sec_creating_a_list_from_existing]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_adding_to_a_vector">"Adding" an Item to a Vector</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_43">Problem</h4>
<div class="paragraph"><p>You want to add an item to a vector, yielding a new vector containing
the item.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_43">Solution</h4>
<div class="paragraph"><p>When used on a vector, the <span class="monospaced">conj</span> function returns a vector with one
or more items appended to the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(conj</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 2 3 4]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(conj</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 2 3 4 5]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_43">Discussion</h4>
<div class="paragraph"><p>Vectors do not support adding new items anywhere aside from the end. If you need to insert
an item in the middle, you will have to use a sequence manipulation function and convert back
to a vector (if necessary) when you&#8217;re done.</p></div>
<div class="paragraph"><p>Since vectors are associative (mapping integer indexes to values), you
can also use the <span class="monospaced">assoc</span> function with an index equal to the current length of the vector
(one greater than the maximum index) to append an item:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">3</span> <span style="color: #990000">:</span>x<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:a :b :c :x]</span></span></tt></pre></div></div>
<div class="paragraph"><p>However, this approach is somewhat more fragile than <span class="monospaced">conj</span>. If the
index you provide is too small, you might simply "overwrite" an
earlier value in the vector; and if it&#8217;s greater than the vector&#8217;s
current length, it will throw an <span class="monospaced">IndexOutOfBoundsException</span>.</p></div>
<div class="paragraph"><p>Still, this technique is worth remembering. If you have code that is
<span class="monospaced">assoc</span>-ing to a vector already, you can use this technique to produce
new vectors with updated values.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_43">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_adding_to_a_list">[sec_adding_to_a_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_creating_a_vector">[sec_composite_creating_a_vector]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_removing_an_item_from_vector">"Removing" an Item from a Vector</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_44">Problem</h4>
<div class="paragraph"><p>You want to remove an item from a vector, obtaining a new vector
without the item.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_44">Solution</h4>
<div class="paragraph"><p>To efficiently remove an item from the end of a vector, use the <span class="monospaced">pop</span>
function, which takes a vector and returns a new vector without the
last item:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(pop</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 2 3]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_44">Discussion</h4>
<div class="paragraph"><p>Although there is no operation designed specifically to remove items
from the beginning of a vector, as <span class="monospaced">pop</span> does from the end, there <em>is</em>
a function, <span class="monospaced">subvec</span>, that can be used to efficiently <em>remove</em> any
number of items from the beginning or end of a vector. Given a vector,
a start index, and an (optional) end index, it will return a vector
from the start (inclusive) to end (exclusive) indexes.</p></div>
<div class="paragraph"><p>The following example drops a single item from the beginning of a
vector. You can use <span class="monospaced">subvec</span> like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(subvec</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">:</span>d<span style="color: #990000">]</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:b :c :d]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or, to remove items from the beginning and the end of a vector, pass
an end index to <span class="monospaced">subvec</span> as well:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(subvec</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">:</span>d<span style="color: #990000">]</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:b :c]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Because <span class="monospaced">subvec</span> exploits the internal representation of a vector to
create a subvector that shares the internal structure of the original,
it is extremely efficient and runs in constant time. It is the only
way to efficiently <em>remove</em> items from the beginning of a vector.</p></div>
<div class="paragraph"><p>While it is certainly also possible to use a function like <span class="monospaced">rest</span> or
<span class="monospaced">drop</span> on a vector, these are technically <em>sequence</em> operations, not
<em>vector</em> operations. The value they return is only guaranteed to be a
sequence, not a concrete vector, and as such will not support the same
features or performance guarantees that vectors do.</p></div>
<div class="paragraph"><p>Of course, you can convert any sequence back into a concrete vector
using <span class="monospaced">vec</span> or <span class="monospaced">into []</span>, but this can be an expensive operation for
large vectors.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_44">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_removing_an_item_list">[sec_removing_an_item_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_creating_a_vector">[sec_composite_creating_a_vector]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_value_at_an_index">Getting the Value at an Index</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_45">Problem</h4>
<div class="paragraph"><p>You have a vector, and you want to retrieve the value the vector
contains at a particular location (index).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_45">Solution</h4>
<div class="paragraph"><p>There are several ways to do this.</p></div>
<div class="sect4">
<h5 id="_using_nth">Using nth</h5>
<div class="paragraph"><p>The <span class="monospaced">nth</span> function, which works on all sequences, is special-cased to
provide constant-time performance when used with indexed collections
such as vectors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(nth</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">:</span>d<span style="color: #990000">]</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :c</span></span></tt></pre></div></div>
<div class="paragraph"><p>If given an index greater than the size of the vector, <span class="monospaced">nth</span> will
throw an exception unless you pass it an optional third argument,
which will be returned if the provided index is out of bounds:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(nth</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; IndexOutOfBoundsException</span></span>

<span style="font-weight: bold"><span style="color: #000000">(nth</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">4</span> <span style="color: #990000">:</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :not-found</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_using_vectors_as_functions_of_their_indexes">Using vectors as functions of their indexes</h5>
<div class="paragraph"><p>Vectors are themselves functions that when called with an integer
argument, will return the value at that index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> v <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(v</span></span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :c</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using an out-of-range index when invoking a vector as a function will
result in an <span class="monospaced">IndexOutOfBoundsException</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_using_get">Using get</h5>
<div class="paragraph"><p>Because vectors support the associative interface with integer indexes
as keys, you can also use the <span class="monospaced">get</span> function to retrieve values by
index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :c</span></span></tt></pre></div></div>
<div class="paragraph"><p>Unlike <span class="monospaced">nth</span>, when you pass an out-of-range index to <span class="monospaced">get</span> it will
return <span class="monospaced">nil</span>, not throw an exception&#8212;unless, that is, you provide a
default value to be returned if the key (the index, in this case) is
not found:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">5</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #993399">5</span> <span style="color: #990000">:</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :not-found</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_45">Discussion</h4>
<div class="paragraph"><p>Which technique should you use? All work equally well, but the choice
does emphasize the way in which you&#8217;re looking at your vector. <span class="monospaced">nth</span>
focuses on its sequential nature, whereas <span class="monospaced">get</span> emphasizes its
indexed, associative quality. Using the vector as a function is also
consistent with the way all associative collections in Clojure act as
functions of their keys.</p></div>
<div class="paragraph"><p>Ultimately, when making a choice like this, you should consider:</p></div>
<div class="ulist"><ul>
<li>
<p>
What would make the code most evident?
</p>
</li>
<li>
<p>
What is the nature of the data in this case? For example, is it most
  fundamentally a sequence and only coincidentally a vector (implying
  <span class="monospaced">nth</span>), or fundamentally a correlation of values to indexes
  (implying <span class="monospaced">get</span>)?
</p>
</li>
<li>
<p>
What is the failure mode of the proposed technique? For example,
  would a <span class="monospaced">nil</span> return value or an exception be preferable?
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_45">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_value_at_an_index">Setting the Value at an Index</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_46">Problem</h4>
<div class="paragraph"><p>Given a vector, you would like to obtain a new vector with a different
value at a particular index.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_46">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">assoc</span> to set the value at a particular index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">]</span> <span style="color: #993399">1</span> <span style="color: #990000">:</span>x<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:a :x :c]</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">assoc</span> can also be used to set multiple indexes at the same time, by
providing additional index/value pairs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">]</span> <span style="color: #993399">1</span> <span style="color: #990000">:</span>x <span style="color: #993399">2</span> <span style="color: #990000">:</span>y<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:a :x :y]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_46">Discussion</h4>
<div class="paragraph"><p>As you may have noticed, <span class="monospaced">assoc</span> is the same function used to set the
values of keys in a map. This is because vectors, like maps, are
associative and implement the same interface
(<span class="monospaced">clojure.lang.Associative</span>), which is what <span class="monospaced">assoc</span> uses under the
hood.</p></div>
<div class="paragraph"><p>Unlike with maps, however, the keys used when using <span class="monospaced">assoc</span> on a vector
must be integer indexes within the range of the vector. Attempting to
use a noninteger key will cause an <span class="monospaced">IllegalArgumentException</span>, and
attempting to <span class="monospaced">assoc</span> an index greater than the size of the vector will throw
an <span class="monospaced">IndexOutOfBoundsException</span>.</p></div>
<div class="paragraph"><p>Note that it <em>is</em> possible to <span class="monospaced">assoc</span> to an index equal to the current size
of the vector (one greater than the maximum index). This will have
the result of appending the item to the end.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_46">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_adding_to_a_vector">[sec_adding_to_a_vector]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_data_maps_setting_keys">[sec_composite_data_maps_setting_keys]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_creating_sets">Creating a Set</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_47">Problem</h4>
<div class="paragraph"><p>You want to create an unordered collection of <em>distinct</em> objects,
which can be tested for membership quickly.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_47">Solution</h4>
<div class="paragraph"><p>Use a set literal to create a set of objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>#{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c}
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c :b}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Duplicate elements in set literals are an error</span></span>
#{<span style="color: #990000">:</span>x <span style="color: #990000">:</span>y <span style="color: #990000">:</span>z <span style="color: #990000">:</span>z <span style="color: #990000">:</span>z}
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; IllegalArgumentException Duplicate key: :y :z ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">hash-set</span> to create a set from arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(hash</span></span><span style="color: #990000">-</span>set <span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c :b}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(apply</span></span> hash<span style="color: #990000">-</span>set <span style="color: #990000">:</span>a <span style="color: #990000">[:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c :b}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">set</span> to create a set from another collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(set</span></span> <span style="color: #FF0000">"hello"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{\e \h \l \o}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Alternatively, use <span class="monospaced">into</span> with a set to create a new set:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(into</span></span> #{} <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">:</span>a<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :b :c}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(into</span></span> #{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b} <span style="color: #990000">[:</span>b <span style="color: #990000">:</span>c <span style="color: #990000">:</span>d<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :b :c :d}</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Set construction performance</div>
<div class="paragraph"><p>At the time of writing, the <span class="monospaced">into</span> technique is about three times
faster than <span class="monospaced">set</span> for large collections of objects. Use it whenever
you&#8217;re working with large sets where performance is a concern:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> largeseq <span style="font-weight: bold"><span style="color: #000000">(doall</span></span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">1e5</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(time</span></span> <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">100</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(set</span></span> largeseq<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; "Elapsed time: 5594.961 msecs"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(time</span></span> <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">100</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(into</span></span> #{} largeseq<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; "Elapsed time: 1329.66 msecs"</span></span></tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Create a sorted set with <span class="monospaced">sorted-set</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>set <span style="color: #993399">99</span> <span style="color: #993399">4</span> <span style="color: #993399">32</span> <span style="color: #993399">7</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{4 7 32 99}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>set<span style="color: #990000">)</span> <span style="color: #FF0000">"the quick brown fox jumps over the lazy dog"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{\space \a \b \c \d \e \f \g \h \i \j \k \l \m \n \o \p</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      \q \r \s \t \u \v \w \x \y \z}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_47">Discussion</h4>
<div class="paragraph"><p>Sets are very useful data structures. They are commonly used when you
have a collection of values but you are only concerned with the
distinct values. Lookup of an element in a set is typically O(1).</p></div>
<div class="paragraph"><p>The techniques just shown all construct <em>hash sets</em>&#x2014;sets that are
unordered and use a hash table as their internal representation.</p></div>
<div class="paragraph"><p>Clojure also supports creating <em>sorted sets</em>, which maintain the order
of their elements. Sets created with <span class="monospaced">sorted-set</span> keep their elements
in ascending order using <span class="monospaced">compare</span>. This is useful when treating the
set as a seq:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> alphabet <span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>set<span style="color: #990000">)</span> <span style="color: #FF0000">"qwertyuiopasdfghjklzxcvbnm"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(last</span></span> alphabet<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; \z</span></span>
<span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(disj</span></span> alphabet <span style="color: #990000">\</span>b<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; \c</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">All of the elements in a sorted set must be comparable
against one another (e.g., you cannot have a sorted set that contains
both strings and numbers). Attempting to add an uncomparable value will
result in a runtime error.</td>
</tr></table>
</div>
<div class="paragraph"><p>Adding or removing objects in a sorted set will always return another
sorted set.</p></div>
<div class="paragraph"><p>If the values you want to store don&#8217;t have a natural sort order (or
you don&#8217;t want to use their natural ordering), you can specify a
custom comparator using <span class="monospaced">sorted-set-by</span>. The comparator used to create
the set is preserved when adding or removing objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> descending<span style="color: #990000">-</span>set <span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>set<span style="color: #990000">-</span>by <span style="color: #990000">&gt;</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(into</span></span> descending<span style="color: #990000">-</span>set <span style="color: #990000">[-</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{4 3 2 1 -1}</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are some performance trade-offs to consider when choosing between
hash sets and sorted sets. Hash sets are based on hash tables, which
offer constant time insert and lookup in most cases. However, they do
require some degree of memory overhead. Sorted sets, based on a
balanced red-black binary tree, are more memory-efficient but slower
for lookup and insertion.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_47">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_creating_a_vector">[sec_composite_creating_a_vector]</a>
</p>
</li>
<li>
<p>
<a href="#sec_adding_removing_from_sets">[sec_adding_removing_from_sets]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_adding_removing_from_sets">Adding and Removing Items from Sets</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_48">Problem</h4>
<div class="paragraph"><p>You want to obtain a new set with items added or removed.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_48">Solution</h4>
<div class="paragraph"><p>The <span class="monospaced">conj</span> function supports sets, just as it does lists, vectors, and
maps. Use it to add an item or items to a set: just pass it the set
and any number of items to add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(conj</span></span> #{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c} <span style="color: #990000">:</span>d<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c :b :d}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(conj</span></span> #{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c} <span style="color: #990000">:</span>d <span style="color: #990000">:</span>e<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c :b :d :e}</span></span></tt></pre></div></div>
<div class="paragraph"><p>To remove one or more items, use the <span class="monospaced">disj</span> function, which is
specific to sets. It takes a set and one or more keys to remove:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(disj</span></span> #{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c} <span style="color: #990000">:</span>b<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :c}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(disj</span></span> #{<span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c} <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_48">Discussion</h4>
<div class="paragraph"><p>Since sets are unordered, there is no concept of "where" items are
added or removed; either a set contains an item, or it doesn&#8217;t.</p></div>
<div class="paragraph"><p>Note that both <span class="monospaced">conj</span> and <span class="monospaced">disj</span> return a set of the same concrete
type as the original. A hash set will remain a hash set, and a sorted set
will remain a sorted set.</p></div>
<div class="paragraph"><p>Also worth noting is that these operations are simply no-ops if the
set already does or does not contain the item being added or
removed. <span class="monospaced">conj</span> returns the same set if it already contains the item,
just as <span class="monospaced">disj</span> does if the specified item was already absent.</p></div>
<div class="paragraph"><p>If you&#8217;re adding or removing large numbers of items to or from sets, you
should also consider using the dedicated set manipulation functions
from the <span class="monospaced">clojure.set</span> namespace: particularly <span class="monospaced">clojure.set/union</span>,
which can be used to add the items of multiple sets together, and
<span class="monospaced">clojure.set/difference</span>, which can be used to obtain a set of items
<em>not</em> contained in another set. These are typically a far more natural
expression of set operations than issuing many calls to <span class="monospaced">conj</span> or <span class="monospaced">disj</span>, or
invoking them with large numbers of arguments.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_48">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_adding_to_a_list">[sec_adding_to_a_list]</a>
</p>
</li>
<li>
<p>
<a href="#sec_adding_to_a_vector">[sec_adding_to_a_vector]</a>
</p>
</li>
<li>
<p>
<a href="#sec_set_operations">[sec_set_operations]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_testing_set_membership">Testing Set Membership</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_49">Problem</h4>
<div class="paragraph"><p>You want to check if an item is a member of a set.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_49">Solution</h4>
<div class="paragraph"><p>The easiest way to check a single item is with the <span class="monospaced">contains?</span>
function, which takes a set and an item and returns <span class="monospaced">true</span> if the item
is a member of the set:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> my<span style="color: #990000">-</span>set #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white <span style="color: #990000">:</span>green}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(contains</span></span><span style="color: #990000">?</span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>blue<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>

<span style="font-weight: bold"><span style="color: #000000">(contains</span></span><span style="color: #990000">?</span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>green<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">get</span> function also works with sets and does basically the same
thing, except instead of returning <span class="monospaced">true</span> or <span class="monospaced">false</span>, it returns the
value itself if it is a member, or <span class="monospaced">nil</span> if it is not:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>blue<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>green<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :green</span></span></tt></pre></div></div>
<div class="paragraph"><p>If desired, you can also pass a third argument to be used as the default return value instead
of <span class="monospaced">nil</span> if a set doesn&#8217;t contain the value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>blue <span style="color: #990000">:</span>no<span style="color: #990000">-</span>such<span style="color: #990000">-</span>luck<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :no-such-luck</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span> my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>green <span style="color: #990000">:</span>no<span style="color: #990000">-</span>such<span style="color: #990000">-</span>luck<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :green</span></span></tt></pre></div></div>
<div class="paragraph"><p>Finally, sets are also functions. When you invoke them with a single
argument, they work just like <span class="monospaced">get</span>, returning the argument if it is a
member, and <span class="monospaced">nil</span> otherwise:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>set <span style="color: #990000">:</span>blue<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>set <span style="color: #990000">:</span>green<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :green</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note as well that keywords behave in the same manner for sets as they
do with maps. Thus, the following is equivalent to having used <span class="monospaced">get</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(:</span>blue my<span style="color: #990000">-</span>set<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="color: #990000">(:</span>green my<span style="color: #990000">-</span>set<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :green</span></span></tt></pre></div></div>
<div class="paragraph"><p>When using a set as a function, one cannot specify a second argument
as a default value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>set <span style="color: #990000">:</span>blue <span style="color: #990000">:</span>no<span style="color: #990000">-</span>such<span style="color: #990000">-</span>luck<span style="color: #990000">)</span>
ArityException Wrong number of args <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">)</span> passed to<span style="color: #990000">:</span> PersistentHashSet  clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>AFn<span style="color: #990000">.</span>throwArity <span style="font-weight: bold"><span style="color: #000000">(AFn</span></span><span style="color: #990000">.</span>java<span style="color: #990000">:</span><span style="color: #993399">429</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>However, you can add a default value when using a keyword as a function with a set as the first argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(:</span>blue my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>no<span style="color: #990000">-</span>such<span style="color: #990000">-</span>luck<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :no-such-luck</span></span>

<span style="color: #990000">(:</span>green my<span style="color: #990000">-</span>set <span style="color: #990000">:</span>no<span style="color: #990000">-</span>such<span style="color: #990000">-</span>luck<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :green</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_49">Discussion</h4>
<div class="paragraph"><p>The choice between <span class="monospaced">contains?</span> and <span class="monospaced">get</span> is mainly an aesthetic one.
However, if your set might contain <span class="monospaced">nil</span> as an actual value you care
about, you&#8217;ll definitely need to use <span class="monospaced">contains?</span>, since a <span class="monospaced">nil</span> return
from <span class="monospaced">get</span> wouldn&#8217;t tell you anything in that case.</p></div>
<div class="paragraph"><p>The ability to use a set as a function is interesting, but it&#8217;s
especially useful when you want to use it as a predicate function on a
sequence operation. For example, it&#8217;s fairly common to want to filter
a sequence to only contain items in a set. In this case, using the set
itself is both easy and idiomatic:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">10</span>
  <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #{<span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span>}
          <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span> #<span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #993399">10</span><span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (2 1 2 3 2 2 1 2 2 1)</span></span></tt></pre></div></div>
<div class="paragraph"><p>This snippet first creates an infinite lazy sequence consisting of
random integers between 0 (inclusive) and 10 (exclusive), using <span class="monospaced">repeatedly</span> to call
<span class="monospaced">rand-int</span> (wrapped in an anonymous function) over and over. Then it
feeds this sequence through a filter, with a set of the numbers 1&#x2013;3
as the filter predicate.</p></div>
<div class="paragraph"><p>The result is another infinite lazy sequence, but containing only
members of the predicate set.</p></div>
<div class="paragraph"><p>This example is contrived. However, using sets as predicate functions
is an extremely useful technique that that pops up quite frequently in Clojure projects.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_49">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_set_operations">[sec_set_operations]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_set_operations">Using Set Operations</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_50">Problem</h4>
<div class="paragraph"><p>You want to perform common operations on sets, such as taking the union,
intersection, or difference of two sets, or you want to test if one set is a subset or superset of another.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_50">Solution</h4>
<div class="paragraph"><p>All these functions are available in the <span class="monospaced">clojure.set</span> namespace,
which is built into Clojure.</p></div>
<div class="paragraph"><p><span class="monospaced">union</span> takes any number of sets as arguments and returns a set
containing their union (i.e., a set containing all the elements from all the
sets):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>set<span style="color: #990000">/</span>union #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white} #{<span style="color: #990000">:</span>white <span style="color: #990000">:</span>blue} #{<span style="color: #990000">:</span>blue <span style="color: #990000">:</span>green}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:white :red :blue :green}</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">intersection</span> also takes any number of sets as args and returns
their intersection (a set consisting only of the items shared by all
the argument sets):</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>set<span style="color: #990000">/</span>intersection #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white <span style="color: #990000">:</span>blue}
                          #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>blue <span style="color: #990000">:</span>green}
                          #{<span style="color: #990000">:</span>yellow <span style="color: #990000">:</span>blue <span style="color: #990000">:</span>red}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:red :blue}</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">difference</span> takes a set as its first argument and returns it without
elements from the sets given in the additional arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>set<span style="color: #990000">/</span>difference #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white <span style="color: #990000">:</span>blue <span style="color: #990000">:</span>yellow}
                        #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>blue}
                        #{<span style="color: #990000">:</span>white}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:yellow}</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">subset?</span> returns <span class="monospaced">true</span> if and only if the first argument is a subset
of the second (that is, if every member of the first set is also a
member of the second):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>set<span style="color: #990000">/</span>subset<span style="color: #990000">?</span> #{<span style="color: #990000">:</span>blue <span style="color: #990000">:</span>white}
                     #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white <span style="color: #990000">:</span>blue}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>set<span style="color: #990000">/</span>subset<span style="color: #990000">?</span> #{<span style="color: #990000">:</span>blue <span style="color: #990000">:</span>black}
                     #{<span style="color: #990000">:</span>red <span style="color: #990000">:</span>white <span style="color: #990000">:</span>blue}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">superset?</span> works the same way, except it returns <span class="monospaced">true</span> only if the
first set is a <em>superset</em> of the second.</p></div>
<div class="paragraph"><p>As you may have noticed, <span class="monospaced">superset?</span> is actually identical to
<span class="monospaced">subset?</span>, only with the order of the arguments reversed.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_50">Discussion</h4>
<div class="paragraph"><p>In general, you should try to use these set manipulation functions
wherever they are applicable. Sets represent a sizable portion of the
data most developers work with day to day, whether they are recognized
and explicitly modeled as sets or not.</p></div>
<div class="paragraph"><p>There are a large number of bugs that can be caused by assumptions
regarding the behaviors of collections. In programming, the type of
data structure used for a given purpose is actually a <em>communication</em>,
from the initial writer of the code to future programmers, that tells a number of things about the nature of the collection. Sets are
<em>unordered, unique</em> collections&#8212;they emphasize that the important
fact is whether an item is a member of the set, not the order or
number of occurrences.</p></div>
<div class="paragraph"><p>If your data does represent a logical set, then model it using set
data structures, and try to think about manipulating it in terms of
set operations. In many cases, you will find that this makes your
program substantially easier to reason about, and makes it more
self-documenting regarding the source and intended use of the data it
contains.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_50">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_testing_set_membership">[sec_testing_set_membership]</a>
</p>
</li>
<li>
<p>
<a href="#sec_test_collection_with_set">[sec_test_collection_with_set]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_map">Creating a Map</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_51">Problem</h4>
<div class="paragraph"><p>You want to create an association that maps keys to values. You
possibly want to maintain a specific ordering of keys.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_51">Solution</h4>
<div class="paragraph"><p>Use map literals (curly braces) with alternating keys and values to
create simple maps:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>name <span style="color: #FF0000">""</span>
 <span style="color: #990000">:</span>class <span style="color: #990000">:</span>barbarian
 <span style="color: #990000">:</span>race <span style="color: #990000">:</span>half<span style="color: #990000">-</span>orc
 <span style="color: #990000">:</span>level <span style="color: #993399">20</span>
 <span style="color: #990000">:</span>skills <span style="color: #990000">[:</span>bashing <span style="color: #990000">:</span>hacking <span style="color: #990000">:</span>smashing<span style="color: #990000">]</span>}</tt></pre></div></div>
<div class="paragraph"><p>Keys and values can be any type. Commas may be used to delimit
key/value pairs where the structure would be hard to discern at a
glance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #993399">8</span> <span style="color: #993399">64</span><span style="color: #990000">,</span> <span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #993399">9</span> <span style="color: #993399">81</span>}</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">In Clojure, commas are whitespace, which means that they can be
used <em>anywhere</em> in a form with no effect on the value; it is just one
way to make your code easier to read.</td>
</tr></table>
</div>
<div class="paragraph"><p>Create an empty, unsorted map with a pair of braces: <span class="monospaced">{}</span>.</p></div>
<div class="paragraph"><p>Create specific types of maps with map constructor
functions. <span class="monospaced">array-map</span>, <span class="monospaced">hash-map</span>, and <span class="monospaced">sorted-map</span> each return a map
of the corresponding type:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(array</span></span><span style="color: #990000">-</span>map<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>map <span style="color: #990000">:</span>key1 <span style="color: #FF0000">"val1"</span> <span style="color: #990000">:</span>key2 <span style="color: #FF0000">"val2"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:key1 "val1" :key2 "val2"}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If a key occurs multiple times in the argument list, the last value
will be that used in the final return map.</p></div>
<div class="paragraph"><p>Use <span class="monospaced">sorted-map-by</span> to create a sorted map using a custom comparator:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>map<span style="color: #990000">-</span>by #<span style="color: #990000">(&lt;</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="color: #990000">%</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">))</span>
               <span style="color: #FF0000">"pigs"</span> <span style="color: #993399">14</span>
               <span style="color: #FF0000">"horses"</span> <span style="color: #993399">2</span>
               <span style="color: #FF0000">"elephants"</span> <span style="color: #993399">1</span>
               <span style="color: #FF0000">"manatees"</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {"pigs" 14, "horses" 2, "manatees" 3, "elephants" 1}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_51">Discussion</h4>
<div class="paragraph"><p>Clojure maps can have one of three distinct concrete implementations:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Array maps, <span class="monospaced">clojure.lang.PersistentArrayMap</span>
</dt>
<dd>
<p>
These are backed by a simple array. They are efficient for very small maps, but not for larger sizes.
</p>
</dd>
<dt class="hdlist1">
Hash maps, <span class="monospaced">clojure.lang.PersistentHashMap</span>
</dt>
<dd>
<p>
These are backed by a hash table data structure. Hash tables support near constant-time lookup and insertion, but also require a certain amount of overhead space, using up slightly more heap space.
</p>
</dd>
<dt class="hdlist1">
Sorted maps, <span class="monospaced">clojure.lang.PersistentTreeMap</span>
</dt>
<dd>
<p>
These are backed by a balanced red-black binary tree. They are more space-efficient than hash maps, but have slower insertion and access times.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Array maps are the default implementation for small maps (under 10
entries at the time of writing), and hash maps are the default for
larger ones. Sorted maps can only be created by explicitly invoking
the <span class="monospaced">sorted-map</span> or <span class="monospaced">sorted-map-by</span> functions.</p></div>
<div class="paragraph"><p>Using <span class="monospaced">assoc</span> or <span class="monospaced">conj</span> on a sorted map will always yield another
sorted map. However, <span class="monospaced">assoc</span>-ing onto an array map will yield a hash
map once it reaches a certain size. The inverse is not true; using
<span class="monospaced">dissoc</span> on a hash map will not yield an array map, even if it becomes
very small.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_51">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_primitives_dates_comparing">[sec_primitives_dates_comparing]</a>, and <a href="#sec_primitives_numbers_fuzzy_comparison">[sec_primitives_numbers_fuzzy_comparison]</a>, to see more uses for <span class="monospaced">compare</span>
</p>
</li>
<li>
<p>
<a href="#sec_composite_creating_sets">[sec_composite_creating_sets]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_data_maps_setting_keys">[sec_composite_data_maps_setting_keys]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_sorting">[sec_composite_sorting]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_retrieving_keys_map">Retrieving Values from a Map</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_52">Problem</h4>
<div class="paragraph"><p>You want to retrieve the value stored at a particular key in a map.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_52">Solution</h4>
<div class="paragraph"><p>As with sets, there are several ways to retrieve the value of a key.</p></div>
<div class="paragraph"><p>The most straightforward way is to use the <span class="monospaced">get</span> function, which, given
a map and a key, returns the value stored at the key or <span class="monospaced">nil</span> if the
map does not contain the key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>} <span style="color: #990000">:</span>name<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Kvothe"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>} <span style="color: #990000">:</span>race<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>If desired, you can also pass a third argument to be used as the
default return value instead of <span class="monospaced">nil</span> if a map doesn&#8217;t contain the key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>} <span style="color: #990000">:</span>race <span style="color: #FF0000">"Human"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Human"</span></span></tt></pre></div></div>
<div class="paragraph"><p>If your map uses keywords as keys, you can use the keyword itself as a
function. Keywords implement the <span class="monospaced">IFn</span> interface, and when invoked
with a map as an argument, they will look themselves up in the map,
returning the value if it is present or <span class="monospaced">nil</span> if not. You can also
pass a second argument that will be used as a default return value in
the case of a missing key, just as you can with <span class="monospaced">get</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(:</span>name {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Paladin"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Marcus"</span></span>

<span style="color: #990000">(:</span>race {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Paladin"</span>} <span style="color: #FF0000">"Human"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Human"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Finally, the third basic way to look up a value in a map is to use
the map itself as a function, passing the key to be retrieved as the
argument. As with <span class="monospaced">get</span> and keyword functions, it is also possible to
pass a second argument for use as a default value if the key is not
found; otherwise, <span class="monospaced">nil</span> is returned:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> character {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Brock"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Barbarian"</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(character</span></span> <span style="color: #990000">:</span>name<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Brock"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(character</span></span> <span style="color: #990000">:</span>race<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(character</span></span> <span style="color: #990000">:</span>race <span style="color: #FF0000">"Human"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Human"</span></span></tt></pre></div></div>
<div class="paragraph"><p>There is a convenience function for looking up items in nested maps:
<span class="monospaced">get-in</span>. Instead of passing a single key, you can pass a sequence of
keys, and they will be successively looked up in a nested structure,
as if repeatedly calling <span class="monospaced">get</span> on each level of the nested data
structure. <span class="monospaced">nil</span> is returned if any key is missing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span> <span style="color: #990000">:</span>weapon {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>greatsword <span style="color: #990000">:</span>damage <span style="color: #FF0000">"2d6"</span>}}
        <span style="color: #990000">[:</span>weapon <span style="color: #990000">:</span>damage<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "2d6"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span>}
        <span style="color: #990000">[:</span>weapon <span style="color: #990000">:</span>damage<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">get-in</span> also takes an optional default value, which will be returned
if <em>any</em> key in the nested hierarchy is missing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span>}
        <span style="color: #990000">[:</span>weapon <span style="color: #990000">:</span>damage<span style="color: #990000">]</span>
        <span style="color: #FF0000">"1d2 (fists)"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "1d2 (fists)"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">get-in</span> works with <em>any</em> associative data structure, not
just maps. This means that it can be combined to work with, for
example, indexes of vectors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in <span style="color: #990000">[</span>{<span style="color: #990000">:</span>name <span style="color: #FF0000">"Marcus"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Paladin"</span>}
         {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>}
         {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Felter"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Druid"</span>}<span style="color: #990000">]</span>
        <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #990000">:</span>class<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Bard"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_52">Discussion</h4>
<div class="paragraph"><p>Which technique of the three discussed is the best to use? All
have identical semantics, but in idiomatic Clojure, they convey
different implications about the scenario in which they are used.</p></div>
<div class="paragraph"><p>Typically, keyword-as-a-function lookup is used when maps are being
used as "objects" and the keys as "fields"; where the map contains a
relatively small, well-known set of keys; and when there is a
reasonable expectation that the key will actually be present.</p></div>
<div class="paragraph"><p>The <span class="monospaced">get</span> function and map-as-a-function lookup techniques, on the
other hand, are more frequently used with large maps where the set of
possible keys is more open-ended. There is less motivation for
choosing between these two; the only difference to be aware of is that
when the map provided is <span class="monospaced">nil</span> for some reason, using it in function
position will throw an exception, while applying <span class="monospaced">get</span> to <span class="monospaced">nil</span> will
simply return <span class="monospaced">nil</span>.</p></div>
<div class="paragraph"><p>It is interesting to note, as well, that the ability to use a map
itself as a function is not just an arbitrary convenience. In the
technical sense of the word "function," maps <em>are</em> functions of keys
to values. Consider the following function definition and map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> square <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="color: #990000">(*</span> x x<span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> square {<span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #993399">3</span> <span style="color: #993399">9</span><span style="color: #990000">,</span> <span style="color: #993399">4</span> <span style="color: #993399">16</span><span style="color: #990000">,</span> <span style="color: #993399">5</span> <span style="color: #993399">25</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Using an invocation of the form <span class="monospaced">(square 3)</span>, the caller can actually
be <em>agnostic</em> as to whether <span class="monospaced">square</span> is a "real" function or a map. Of
course, the normally defined function has a number of advantages in
this case. For one, it has an unlimited domain instead of just the
keys enumerated. And the multiplication function is fairly fast, so
precomputing results is not a win. But in some cases, for functions
that do have a more naturally constrained domain and are more
expensive to compute, being able to use a map implementation of a
function can be a real boon to performance.</p></div>
<div class="paragraph"><p>Because all of the different techniques for retrieving values from a
map return <span class="monospaced">nil</span> if the key is not present, special handling is
required if you need to differentiate the case in which a key <em>does</em>
exist in a map with a value of <span class="monospaced">nil</span> from the case in which the key does
not exist at all.</p></div>
<div class="paragraph"><p>The easiest way to do this is to always provide a default value to be
returned in the case of a missing key. To be absolutely sure that you
can differentiate the default value from any possible value the map
might contain, you can use a namespace-qualified keyword
(e.g., <span class="monospaced">::not-found</span>).</p></div>
<div class="paragraph"><p>It is also possible to use the <span class="monospaced">contains?</span> function, which takes a
collection and a key, and returns <span class="monospaced">true</span> if and only if the collection
has a specific entry for that key (even if the value is <span class="monospaced">nil</span>).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Meaning of contains?</div>
<div class="paragraph"><p>The exact behavior of the <span class="monospaced">contains?</span> function often causes confusion, especially since many other languages have a function
with a similar name that does something different.</p></div>
<div class="paragraph"><p>In Clojure, <span class="monospaced">contains?</span> is <em>not</em> a search function&#8212;it does not
inspect a collection to see if the item is present. Rather, it is a
<em>lookup</em> function, and only works on associative or indexed
collections. In other languages, it is often named <span class="monospaced">containsKey</span>
or similar.</p></div>
<div class="paragraph"><p>This means it works as one would expect on maps and sets, returning
<span class="monospaced">true</span> if the specified key is a valid key or member in the
collection. But for vectors, it will return <span class="monospaced">true</span> only if passed an
integer between zero and the maximum index of the vector. And it will
throw an exception if used at all with a list or a sequence.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_52">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_retrieving_multiple_keys">[sec_retrieving_multiple_keys]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_data_maps_setting_keys">[sec_composite_data_maps_setting_keys]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_maps_as_seqs">[sec_composite_maps_as_seqs]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_retrieving_multiple_keys">Retrieving Multiple Keys from a Map Simultaneously</h3>
<div class="paragraph byline"><p>by Leonardo Borges</p></div>
<div class="sect3">
<h4 id="_problem_53">Problem</h4>
<div class="paragraph"><p>You want to retrieve multiple values from a map at one time.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_53">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">vals</span> and <span class="monospaced">select-keys</span> when the order of returned values is not
important:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; How many red and green beans are there?</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> beans {<span style="color: #990000">:</span>red <span style="color: #993399">10</span>
            <span style="color: #990000">:</span>blue <span style="color: #993399">3</span>
            <span style="color: #990000">:</span>green <span style="color: #993399">1</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">(vals</span></span> <span style="font-weight: bold"><span style="color: #000000">(select</span></span><span style="color: #990000">-</span>keys beans <span style="color: #990000">[:</span>red <span style="color: #990000">:</span>green<span style="color: #990000">])))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 11</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">juxt</span> when order matters:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; What are the red and green bean totals?</span></span>
<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(juxt</span></span> <span style="color: #990000">:</span>red <span style="color: #990000">:</span>green<span style="color: #990000">)</span> beans<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [10 1]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_53">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">juxt</span> and the combination of <span class="monospaced">vals</span> and <span class="monospaced">select-keys</span> are both apt
tools for retrieving multiple keys from a map. There are subtleties to
their behavior that are important to understand, though.</p></div>
<div class="paragraph"><p>At first glance, the <span class="monospaced">juxt</span> approach seems to be the clear winner of
the two. However, it only goes so far: the approach falls
apart when any of the keys you wish to retrieve is not a keyword (more
specifically, not a <em>function</em>). This is because <span class="monospaced">juxt</span> merely
<em>juxtaposes</em> the return values of multiple functions. Since keywords
are functions, it&#8217;s possible to <span class="monospaced">juxt</span> them and retrieve a
strongly ordered list of values.</p></div>
<div class="paragraph"><p>If the keys in the <span class="monospaced">beans</span> map were strings, it would not be possible
to retrieve their values with <span class="monospaced">juxt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(juxt</span></span> <span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"b"</span><span style="color: #990000">)</span> beans<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ClassCastException java.lang.String cannot be cast to clojure.lang.IFn ...</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">select-keys</span>, on the other hand, <em>is</em> capable of pulling values for
any number of arbitrary keys. The <span class="monospaced">select-keys</span> function takes a map
and a sequence of keys and returns a new map populated with <em>only</em> those
keys:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> weird<span style="color: #990000">-</span>map {<span style="color: #FF0000">"a"</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> {<span style="color: #990000">:</span>foo <span style="color: #990000">:</span>bar} <span style="color: #990000">:</span>baz<span style="color: #990000">,</span> <span style="color: #993399">13</span> <span style="color: #993399">31</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(select</span></span><span style="color: #990000">-</span>keys weird<span style="color: #990000">-</span>map
             <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span> {<span style="color: #990000">:</span>foo <span style="color: #990000">:</span>bar}<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {{:foo :bar} :baz, "a" 1}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(vals</span></span> {{<span style="color: #990000">:</span>foo <span style="color: #990000">:</span>bar} <span style="color: #990000">:</span>baz<span style="color: #990000">,</span> <span style="color: #FF0000">"a"</span> <span style="color: #993399">1</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 :baz)</span></span></tt></pre></div></div>
<div class="paragraph"><p>In cases where you&#8217;re pulling multiple values from nonkeyword maps, it is probably
easiest to wrap that interaction up via <span class="monospaced">juxt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> a<span style="color: #990000">-</span>str<span style="color: #990000">-</span>then<span style="color: #990000">-</span>foo<span style="color: #990000">-</span>bar<span style="color: #990000">-</span>map
  <span style="font-weight: bold"><span style="color: #000000">(juxt</span></span> #<span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">%</span> <span style="color: #FF0000">"a"</span><span style="color: #990000">)</span>
        #<span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">%</span> {<span style="color: #990000">:</span>foo <span style="color: #990000">:</span>bar}<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(a</span></span><span style="color: #990000">-</span>str<span style="color: #990000">-</span>then<span style="color: #990000">-</span>foo<span style="color: #990000">-</span>bar<span style="color: #990000">-</span>map weird<span style="color: #990000">-</span>map<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [1 :baz]</span></span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll avoid weird maps now, won&#8217;t you?</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_53">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composites_as_keys">[sec_composites_as_keys]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_data_maps_setting_keys">Setting Keys in a Map</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_54">Problem</h4>
<div class="paragraph"><p>You want to "change" a map by adding, setting, or removing keys.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_54">Solution</h4>
<div class="paragraph"><p>The most basic way to change a map is using the <span class="monospaced">assoc</span> function.
Given a map and any number of additional key/value pairs as arguments,
it will return an updated map containing the respective keys and
values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> villain {<span style="color: #990000">:</span>honorific <span style="color: #FF0000">"Dr."</span> <span style="color: #990000">:</span>name <span style="color: #FF0000">"Mayhem"</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> villain <span style="color: #990000">:</span>occupation <span style="color: #FF0000">"Mad Scientist"</span> <span style="color: #990000">:</span>status <span style="color: #990000">:</span>at<span style="color: #990000">-</span>large<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:honorific "Dr.", :name "Mayhem",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :occupation "Mad Scientist", :status :at-large}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If used on a map that already contains a key, the <span class="monospaced">assoc</span> function
will return an updated map with the newly specified value for the key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> villain {<span style="color: #990000">:</span>honorific <span style="color: #FF0000">"Dr."</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>name <span style="color: #FF0000">"Mayhem"</span><span style="color: #990000">,</span>
              <span style="color: #990000">:</span>occupation <span style="color: #FF0000">"Mad Scientist"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">:</span>at<span style="color: #990000">-</span>large}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> villain <span style="color: #990000">:</span>status <span style="color: #990000">:</span>deceased<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:honorific "Dr.", :name "Mayhem",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :occupation "Mad Scientist", :status :deceased}</span></span></tt></pre></div></div>
<div class="paragraph"><p>To remove keys, use the <span class="monospaced">dissoc</span> function. Given a map and any
number of keys, it returns a map minus those keys:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> villain {<span style="color: #990000">:</span>honorific <span style="color: #FF0000">"Dr."</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>name <span style="color: #FF0000">"Mayhem"</span><span style="color: #990000">,</span>
              <span style="color: #990000">:</span>occupation <span style="color: #FF0000">"Mad Scientist"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">:</span>deceased}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(dissoc</span></span> villain <span style="color: #990000">:</span>occupation <span style="color: #990000">:</span>honorific<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:name "Mayhem", :status :deceased}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_54">Discussion</h4>
<div class="paragraph"><p>It&#8217;s fairly common to have maps contained in other maps. If it is
necessary to update a deeply nested value, nested calls to <span class="monospaced">assoc</span>
quickly become inconvenient, especially since they need to be
"inside-out." Consider the following data structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> book {<span style="color: #990000">:</span>title <span style="color: #FF0000">"Clojure Cookbook"</span>
           <span style="color: #990000">:</span>author {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Ryan Neufeld"</span>
                    <span style="color: #990000">:</span>residence {<span style="color: #990000">:</span>country <span style="color: #FF0000">"USA"</span>}}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>If Ryan were to move back to his native land of Canada, fully updating
the map representing this book using only <span class="monospaced">assoc</span> would look something
like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> book <span style="color: #990000">:</span>author
  <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> <span style="color: #990000">(:</span>author book<span style="color: #990000">)</span> <span style="color: #990000">:</span>residence
    <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> <span style="color: #990000">(:</span>residence <span style="color: #990000">(:</span>author book<span style="color: #990000">))</span> <span style="color: #990000">:</span>country <span style="color: #FF0000">"Canada"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Obviously, this is inconvenient and difficult to read.</p></div>
<div class="paragraph"><p>The <span class="monospaced">assoc-in</span> function removes this inconvenience, allowing you to
specify a <em>key path</em> instead of a sole key. Instead of changing a
value one key deep, a <em>key path</em> lists a sequence of keys, applied
recursively to change a deeply nested value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(assoc</span></span><span style="color: #990000">-</span>in book
          <span style="color: #990000">[:</span>author <span style="color: #990000">:</span>residence <span style="color: #990000">:</span>country<span style="color: #990000">]</span>
          <span style="color: #FF0000">"Canada"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:author {:name "Ryan Neufeld"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;              :residence {:country "Canada"}}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;              :title "Clojure Cookbook"}</span></span></tt></pre></div></div>
<div class="paragraph"><p>The preceding sample first looks up the map associated with the
<span class="monospaced">:residence</span> key in the nested data structure, then associates
<span class="monospaced">"Canada"</span> with the <span class="monospaced">:country</span> key. Finally, the entire data structure
is returned.</p></div>
<div class="paragraph"><p>What if you needed to <em>update</em> a value based on its previous value,
instead of just changing it?</p></div>
<div class="paragraph"><p>Fortunately, Clojure provides <span class="monospaced">update-in</span> expressly for this purpose.
Instead of taking a new value, <span class="monospaced">update-in</span> takes an <em>update function</em>.
This function is invoked with the value retrieved at <em>key path</em> and
any trailing arguments passed to <span class="monospaced">update-in</span>. It&#8217;s a peculiar
function to wrap your head around at first. Perhaps it is best to
illustrate with an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> website {<span style="color: #990000">:</span>clojure<span style="color: #990000">-</span>cookbook {<span style="color: #990000">:</span>hits <span style="color: #993399">1236</span>}}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Register 101 new hits to the Cookbook website</span></span>
<span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in website                   <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
           <span style="color: #990000">[:</span>clojure<span style="color: #990000">-</span>cookbook <span style="color: #990000">:</span>hits<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
           <span style="color: #990000">+</span>                         <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
           <span style="color: #993399">101</span><span style="color: #990000">)</span>                      <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;4&gt;</b></span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:clojure-cookbook {:hits 1337}}</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The map
</p>
</li>
<li>
<p>
The key path
</p>
</li>
<li>
<p>
The update function, <span class="monospaced">+</span>
</p>
</li>
<li>
<p>
Additional arguments to <span class="monospaced">+</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p><span class="monospaced">update-in</span> will also actually create maps for any of the keys in the
vector that don&#8217;t exist. This means it can be used to create structure
as well as to update values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in {} <span style="color: #990000">[:</span>author <span style="color: #990000">:</span>residence<span style="color: #990000">]</span> assoc <span style="color: #990000">:</span>country <span style="color: #FF0000">"USA"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:author {:residence {:country "USA"}}}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Even though the starting map is empty, two empty maps are created for
the values of the <span class="monospaced">:author</span> and <span class="monospaced">:residence</span> keys, meaning the <span class="monospaced">assoc</span>
will be applied to a new, empty map.</p></div>
<?hard-pagebreak?>
<div class="sidebarblock">
<div class="content">
<div class="title">Treating Clojure&#8217;s State Constructs Like Maps</div>
<div class="paragraph"><p>One other common use case for maps is as the values of one of
Clojure&#8217;s state constructs: <em>atoms</em>, <em>refs</em>, or <em>agents</em>. Clojure maps
themselves are immutable values. In a very literal sense, if you "add"
a key to a map, it is no longer the same value any more. But
sometimes, it is necessary to preserve a logical <em>identity</em> for
different values across time. That&#8217;s when to use one of the state
management tools.</p></div>
<div class="paragraph"><p>To update the value of a piece of state (ref, atom, or agent), you
invoke its specific state transition function (<span class="monospaced">alter</span>, <span class="monospaced">swap!</span>, or
<span class="monospaced">send</span>, respectively). State transition functions share a common form:
they take the reference as the first argument, the function to apply
to the value as the second argument, and any arguments to the function
as additional arguments.</p></div>
<div class="paragraph"><p>So, for example, to deeply update an item contained in a map
referenced by an atom, you can invoke the <span class="monospaced">swap!</span> function (the state
transition function for atoms), passing it your atom and the
<span class="monospaced">update-in</span> function, along with the list of keys and the function to
use to update the value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> retail<span style="color: #990000">-</span>data <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> {<span style="color: #990000">:</span>customers <span style="color: #990000">[</span>{<span style="color: #990000">:</span>id <span style="color: #993399">123</span> <span style="color: #990000">:</span>name <span style="color: #FF0000">"Luke"</span>}
                                    {<span style="color: #990000">:</span>id <span style="color: #993399">321</span> <span style="color: #990000">:</span>name <span style="color: #FF0000">"Ryan"</span>}<span style="color: #990000">]</span>
                        <span style="color: #990000">:</span>orders <span style="color: #990000">[</span>{<span style="color: #990000">:</span>sku <span style="color: #FF0000">"Q2M9"</span> <span style="color: #990000">:</span>customer <span style="color: #993399">123</span> <span style="color: #990000">:</span>qty <span style="color: #993399">4</span>}
                                 {<span style="color: #990000">:</span>sku <span style="color: #FF0000">"43XP"</span> <span style="color: #990000">:</span>customer <span style="color: #993399">321</span> <span style="color: #990000">:</span>qty <span style="color: #993399">1</span>}<span style="color: #990000">]</span>}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> retail<span style="color: #990000">-</span>data update<span style="color: #990000">-</span>in <span style="color: #990000">[:</span>orders<span style="color: #990000">]</span> conj
       {<span style="color: #990000">:</span>sku <span style="color: #FF0000">"9QED"</span> <span style="color: #990000">:</span>customer <span style="color: #993399">321</span> <span style="color: #990000">:</span>qty <span style="color: #993399">2</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This will add a new order map to the list of orders contained in the
map contained in the <span class="monospaced">retail-data</span> atom.</p></div>
<div class="paragraph"><p>Although such triple combos are not terribly common, they illustrate
the general consistency of functions that take other functions and
arguments, and how they can be combined arbitrarily deeply. In this
case, what starts with a single call to <span class="monospaced">swap!</span> ends up also updating
a map and conjoining to a vector in the same form.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_54">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_maps_as_seqs">[sec_composite_maps_as_seqs]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_data_maps_multiple_values">[sec_composite_data_maps_multiple_values]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_combining_maps">[sec_composite_combining_maps]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composites_as_keys">Using Composite Values as Map Keys</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_55">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to use a value that isn&#8217;t a simple primitive type as a
lookup key in a map. For example:</p></div>
<div class="ulist"><ul>
<li>
<p>
You&#8217;d like to use geographic or Cartesian coordinates as map keys.
</p>
</li>
<li>
<p>
You&#8217;d like to associate values with functions.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_solution_55">Solution</h4>
<div class="paragraph"><p>Because of its robust identity semantics on composite values, Clojure
fully supports using any immutable value as a map key. More
importantly, doing so is reasonably efficient.</p></div>
<div class="paragraph"><p>For example, consider the data structure to represent a chessboard,
an 8 &#x00D7; 8 grid where each position can have one of six possible types of
piece. Rows are represented by the numbers 1&#x2013;8, and columns by the
letters <em>a&#x2013;h</em>.</p></div>
<div class="paragraph"><p>In Clojure, you can represent this directly as a map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> chessboard {<span style="color: #990000">[:</span>a <span style="color: #993399">5</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>white <span style="color: #990000">:</span>king<span style="color: #990000">]</span>
                 <span style="color: #990000">[:</span>a <span style="color: #993399">4</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>white <span style="color: #990000">:</span>pawn<span style="color: #990000">]</span>
                 <span style="color: #990000">[:</span>d <span style="color: #993399">4</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>black <span style="color: #990000">:</span>king<span style="color: #990000">]</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Moving a piece then requires two operations, <literal>dissoc</literal>-ing the old
position for a piece and <literal>assoc</literal>-ing the new position:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> move
  <span style="color: #FF0000">"Given a map representing a chessboard, move the piece at src</span>
<span style="color: #FF0000">  to dest"</span>
  <span style="color: #990000">[</span>board source dest<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;</span> board
      <span style="font-weight: bold"><span style="color: #000000">(dissoc</span></span> source<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> dest <span style="font-weight: bold"><span style="color: #000000">(board</span></span> source<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(move</span></span> chessboard <span style="color: #990000">[:</span>a <span style="color: #993399">5</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>a <span style="color: #993399">4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {[:d 4] [:black :king]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [:a 4] [:white :king]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>As another example of nontraditional map keys, consider the
situation where you have a set of functions, and you want to be able
to assign them each a "weighting" and multiply the return value by the
corresponding weight whenever the function is called.</p></div>
<div class="paragraph"><p>An easy way to do this is to store the functions and weights in a map,
with the functions as keys:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> plus<span style="color: #990000">-</span>two <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">+</span> <span style="color: #993399">2</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> plus<span style="color: #990000">-</span>three <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">+</span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> weight<span style="color: #990000">-</span>map {plus<span style="color: #990000">-</span>two <span style="color: #993399">1.0</span>
                 plus<span style="color: #990000">-</span>three <span style="color: #993399">0.8</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Then you can use a simple wrapper function to apply the functions
with the weights applied:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> apply<span style="color: #990000">-</span>weighted
  <span style="color: #FF0000">"Given a weight map, a function, and args, applies the function</span>
<span style="color: #FF0000">  to the args, multiplying the result by the weighting for the</span>
<span style="color: #FF0000">  function. If the weight map does not specify a weight for the</span>
<span style="color: #FF0000">  function, a default of 1.0 is used."</span>
  <span style="color: #990000">[</span>weight<span style="color: #990000">-</span>map f <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span>
  <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(get</span></span> weight<span style="color: #990000">-</span>map f <span style="color: #993399">1.0</span><span style="color: #990000">)</span>
     <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> f args<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(apply</span></span><span style="color: #990000">-</span>weighted weight<span style="color: #990000">-</span>map plus<span style="color: #990000">-</span>two <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 4.0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(apply</span></span><span style="color: #990000">-</span>weighted weight<span style="color: #990000">-</span>map plus<span style="color: #990000">-</span>three <span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.2</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_55">Discussion</h4>
<div class="paragraph"><p>A more traditional way to model the chess game would be with a
two-dimensional array, or, in Clojure&#8217;s case, with a vector of
vectors.</p></div>
<div class="paragraph"><p>This is certainly a reasonable thing to do, and is (possibly) slightly
more performant. However, it is a less clean model of the actual
problem domain. It requires a translation, for example, from chess&#8217;s
row/column numbers and letters to zero-indexed indexes. Using a map
lets you store the positions directly, in native chess terminology.</p></div>
<div class="paragraph"><p>Similarly, there are alternative implementations for the
function-weighting example. It could be implemented using a <span class="monospaced">cond</span>
statement with all the functions and weights enumerated, or by
replacing the functions altogether with a protocol method that could
then have varying implementations with different weights.</p></div>
<div class="paragraph"><p>However, storing the functions and weights in a map has the benefit of
making it obvious at a glance what the weightings for particular
functions are. More importantly, it is possible to store multiple
different sets of weights, and switch between different weight schemes
dynamically at runtime.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_55">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>, and <a href="#sec_composite_data_maps_setting_keys">[sec_composite_data_maps_setting_keys]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_maps_as_seqs">Treating Maps as Sequences (and Vice Versa)</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_56">Problem</h4>
<div class="paragraph"><p>You want to treat the contents of a map as a sequence of entries.
Alternatively, you want to convert a sequence of entries back into
a map.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_56">Solution</h4>
<div class="paragraph"><p>To obtain a sequence view of a map, simply call <span class="monospaced">seq</span> on it. Note that
most sequence-processing functions call <span class="monospaced">seq</span> on their arguments
themselves, so it&#8217;s usually not necessary to do this explicitly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(seq</span></span> {<span style="color: #990000">:</span>a <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>c <span style="color: #993399">3</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>d <span style="color: #993399">4</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([:a 1] [:c 3] [:b 2] [:d 4])</span></span></tt></pre></div></div>
<div class="paragraph"><p>This creates a sequence of key/value pairs, which you can then process
as you would any sequence.</p></div>
<div class="paragraph"><p>To create a map <em>from</em> a sequence, you can exploit the fact that
<span class="monospaced">conj</span>, when applied to a map, can take a two-element vector as a
key/value pair and use it to add the respective key and value on to
the map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> m {<span style="color: #990000">:</span>a <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(conj</span></span> m <span style="color: #990000">[:</span>c <span style="color: #993399">3</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:a 1, :b 2, :c 3}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Because the <span class="monospaced">into</span> function uses repeated applications of <span class="monospaced">conj</span> to
add items from one sequence onto a collection, this means it can be
used to transform a sequence of pairs into a single map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(into</span></span> {} <span style="color: #990000">[[:</span>a <span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>b <span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>c <span style="color: #993399">3</span><span style="color: #990000">]])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:a 1, :b 2, :c 3}</span></span></tt></pre></div></div>
<div class="paragraph"><p>It is also possible to construct a map from <em>two</em> sequences: one
containing keys and one containing values. This is the purpose of the
<span class="monospaced">zipmap</span> function. Given two sequences, it will return a single map
with keys from the first argument sequence and values from the second:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:c 3, :b 2, :a 1}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If one of the sequences passed to <span class="monospaced">zipmap</span> is shorter than the other,
the extra values will be ignored, and the output map will only contain
entries up to the length of the shortest sequence.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_56">Discussion</h4>
<div class="paragraph"><p>When obtaining a sequence view of a <em>hash map</em>, the map entries will
be returned in an arbitrary or undefined order. Conveniently, this
order (although arbitrary) <em>is</em> guaranteed to be consistent if the
same map is turned into a sequence multiple times.</p></div>
<div class="paragraph"><p>When using a <em>sorted map</em>, the entries will be returned according to
their sort order in the map. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="font-weight: bold"><span style="color: #000000">(hash</span></span><span style="color: #990000">-</span>map <span style="color: #990000">:</span>a <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>c <span style="color: #993399">3</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>d <span style="color: #993399">4</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([:a 1] [:c 3] [:b 2] [:d 4])</span></span>

<span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="font-weight: bold"><span style="color: #000000">(sorted</span></span><span style="color: #990000">-</span>map <span style="color: #990000">:</span>a <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>c <span style="color: #993399">3</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>d <span style="color: #993399">4</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([:a 1] [:b 2] [:c 3] [:d 4])</span></span></tt></pre></div></div>
<div class="paragraph"><p>It&#8217;s also possible to retrieve the map entry for a particular key.
Use the <span class="monospaced">find</span> function, which is similar to <span class="monospaced">get</span> except two facts:
first, it returns map entries; second, it does&#8217;nt accept an optional
default return value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(find</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>} <span style="color: #990000">:</span>name<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:name "Kvothe"]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(find</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Kvothe"</span> <span style="color: #990000">:</span>class <span style="color: #FF0000">"Bard"</span>} <span style="color: #990000">:</span>race<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>There is another interesting fact about the entry values in this
sequence. They are printed as vectors, and they <em>are</em> vectors insofar
as they implement the full vector interface. However, their concrete
type is not actually <span class="monospaced">clojure.lang.PersistentVector</span>; rather, they are
a different kind of vector called a <em>map entry</em>, which not only is a
vector but also supports the <span class="monospaced">clojure.lang.MapEntry</span> interface.</p></div>
<div class="paragraph"><p>The <span class="monospaced">MapEntry</span> interface provides <span class="monospaced">key</span> and <span class="monospaced">val</span> functions that can
be used to retrieve the key and value of an entry:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> entry <span style="font-weight: bold"><span style="color: #000000">(find</span></span> {<span style="color: #990000">:</span>a <span style="color: #993399">1</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span>} <span style="color: #990000">:</span>a<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(class</span></span> entry<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; clojure.lang.MapEntry</span></span>

<span style="font-weight: bold"><span style="color: #000000">(key</span></span> entry<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :a</span></span>

<span style="font-weight: bold"><span style="color: #000000">(val</span></span> entry<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span></tt></pre></div></div>
<div class="paragraph"><p>These functions should be preferred to using the <span class="monospaced">first</span> and <span class="monospaced">second</span>
functions on map entries when processing maps as sequences, since they
preserve the semantic of key/value pairs, making the code easier to
read.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_56">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composites_applying_fns_to_maps">[sec_composites_applying_fns_to_maps]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composites_applying_fns_to_maps">Applying Functions to Maps</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_57">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to apply a transformation function to the keys or the
values of a map.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_57">Solution</h4>
<div class="paragraph"><p>Use one of these simple general-purpose functions, modified to suit
any needs you have:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>keys
  <span style="color: #FF0000">"Given a map and a function, returns the map resulting from applying</span>
<span style="color: #FF0000">  the function to each key."</span>
  <span style="color: #990000">[</span>m f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> f <span style="font-weight: bold"><span style="color: #000000">(keys</span></span> m<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(vals</span></span> m<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">-</span>keys {<span style="color: #FF0000">"a"</span> <span style="color: #993399">1</span> <span style="color: #FF0000">"b"</span> <span style="color: #993399">2</span>} keyword<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:b 2, :a 1}</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>vals
  <span style="color: #FF0000">"Given a map and a function, returns the map resulting from applying</span>
<span style="color: #FF0000">  the function to each value."</span>
  <span style="color: #990000">[</span>m f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> <span style="font-weight: bold"><span style="color: #000000">(keys</span></span> m<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> f <span style="font-weight: bold"><span style="color: #000000">(vals</span></span> m<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">-</span>vals {<span style="color: #990000">:</span>a <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>b <span style="color: #993399">1</span>} inc<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:b 2, :a 2}</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>kv
  <span style="color: #FF0000">"Given a map and a function of two arguments, returns the map</span>
<span style="color: #FF0000">  resulting from applying the function to each of its entries. The</span>
<span style="color: #FF0000">  provided function must return a pair (a two-element sequence.)"</span>
  <span style="color: #990000">[</span>m f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(into</span></span> {} <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[[</span>k v<span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #000000">(f</span></span> k v<span style="color: #990000">))</span> m<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">-</span>kv {<span style="color: #FF0000">"a"</span> <span style="color: #993399">1</span> <span style="color: #FF0000">"b"</span> <span style="color: #993399">1</span>} <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>k v<span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(keyword</span></span> k<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> v<span style="color: #990000">)]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:a 2, :b 2}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_57">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">map-keys</span> and <span class="monospaced">map-vals</span> are extremely straightforward. They each
start by breaking the map, <span class="monospaced">m</span>, down into a sequence of keys and a
sequence of values using the <span class="monospaced">keys</span> and <span class="monospaced">vals</span> functions, which return
a sequence of the keys or values of a map, respectively. Then, they
use the <span class="monospaced">map</span> function to transform either the sequence of keys or the
sequence of vals. Finally, the <span class="monospaced">zipmap</span> function is used to recombine
the key and value sequences into a single map, with the updates in
place.</p></div>
<div class="paragraph"><p><span class="monospaced">map-kv</span> works a bit differently. It starts by converting the map into
a sequence of map entries, then uses <span class="monospaced">map</span> to apply them to an
anonymous function that destructures the key and value, and then
passes the key and value to the caller-provided function. Finally, it
uses <span class="monospaced">into</span> to repeatedly conjoin the resulting pairs onto an empty
map, returning a new map consisting of the transformed keys and values.</p></div>
<div class="paragraph"><p>The following example is identical, but does not use destructuring, so
the high-level structure is a bit more clear:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>kv
  <span style="color: #990000">[</span>m f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(into</span></span> {} <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>entry<span style="color: #990000">]</span>
                  <span style="font-weight: bold"><span style="color: #000000">(f</span></span> <span style="font-weight: bold"><span style="color: #000000">(key</span></span> entry<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(val</span></span> entry<span style="color: #990000">)))</span>
                m<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>It is easy to see that these three functions are all riffs on the
standard <span class="monospaced">map</span> function, applied to map data structures. What about
the other staple of functional programming, <span class="monospaced">reduce</span>?</p></div>
<div class="paragraph"><p>Clojure already has a <span class="monospaced">reduce-kv</span> function built in, which was added in version 1.4.</p></div>
<div class="paragraph"><p><span class="monospaced">reduce-kv</span> takes three arguments: a function, an initial value, and
an associative collection. The provided function must also take three
arguments. <span class="monospaced">reduce-kv</span> reduces the provided collection by first
applying the function to the initial value, the first key, and its
corresponding value from the map. The resulting value is then
reapplied along with the second key and value, the resulting value
with the third key and value, and so on.</p></div>
<div class="paragraph"><p>The following example uses <span class="monospaced">reduce-kv</span> to obtain the sum of all the
values in a map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(reduce</span></span><span style="color: #990000">-</span>kv <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>agg _ val<span style="color: #990000">]</span>
             <span style="color: #990000">(+</span> agg val<span style="color: #990000">))</span>
           <span style="color: #993399">0</span>
           {<span style="color: #990000">:</span>a <span style="color: #993399">1</span> <span style="color: #990000">:</span>b <span style="color: #993399">2</span> <span style="color: #990000">:</span>c <span style="color: #993399">3</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 6</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that an underscore (<span class="monospaced">_</span>) is used instead of <span class="monospaced">key</span> in the function
argument declaration. This is idiomatic in Clojure to name any argument
that isn&#8217;t actually used in the body.</p></div>
<div class="paragraph"><p>It&#8217;s also possible to define <span class="monospaced">map-kv</span> using <span class="monospaced">reduce-kv</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>kv
    <span style="color: #990000">[</span>m f<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span><span style="color: #990000">-</span>kv <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>agg k v<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(conj</span></span> agg <span style="font-weight: bold"><span style="color: #000000">(f</span></span> k v<span style="color: #990000">)))</span> {} m<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>which could be used in this example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">-</span>kv {<span style="color: #990000">:</span>one <span style="color: #993399">1</span> <span style="color: #990000">:</span>two <span style="color: #993399">2</span> <span style="color: #990000">:</span>three <span style="color: #993399">3</span>}
        #<span style="font-weight: bold"><span style="color: #000000">(vector</span></span> <span style="color: #990000">(-&gt;</span> <span style="color: #990000">%</span><span style="color: #993399">1</span> str <span style="font-weight: bold"><span style="color: #000000">(subs</span></span> <span style="color: #993399">1</span><span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {"one" 2, "three" 4, "two" 3}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_57">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_maps_as_seqs">[sec_composite_maps_as_seqs]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_data_maps_multiple_values">Keeping Multiple Values for a Key</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_58">Problem</h4>
<div class="paragraph"><p>Normally, maps are strictly one value per key: if you <span class="monospaced">assoc</span> an
existing key, the old value is replaced. However, sometimes it would
be useful to have a map-like interface (a "multimap") capable
of storing <em>multiple values</em> for the same key.</p></div>
<div class="paragraph"><p>You would like to create a map-like data structure that implements a
multimap-like interface in Clojure.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_58">Solution</h4>
<div class="paragraph"><p>To introduce such a capability on top of normal maps, create and
extend a protocol <span class="monospaced">MultiAssociative</span> that defines this behavior:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defprotocol</span></span> MultiAssociative
  <span style="color: #FF0000">"An associative structure that can contain multiple values for a key"</span>
  <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="color: #990000">[</span>m key value<span style="color: #990000">]</span> <span style="color: #FF0000">"Insert a value into a MultiAssociative"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> <span style="color: #990000">[</span>m key value<span style="color: #990000">]</span> <span style="color: #FF0000">"Remove a value from a MultiAssociative"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>all <span style="color: #990000">[</span>m key<span style="color: #990000">]</span> <span style="color: #FF0000">"Returns a set of all values stored at key in a</span>
<span style="color: #FF0000">                    MultiAssociative. Returns the empty set if there</span>
<span style="color: #FF0000">                    are no values."</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span> value<span style="color: #990000">-</span>set<span style="color: #990000">?</span>
  <span style="color: #FF0000">"Helper predicate that returns true if the value is a set that</span>
<span style="color: #FF0000">  represents multiple values in a MultiAssociative"</span>
  <span style="color: #990000">[</span>v<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(and</span></span> <span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">?</span> v<span style="color: #990000">)</span> <span style="color: #990000">(::</span>multi<span style="color: #990000">-</span>value <span style="font-weight: bold"><span style="color: #000000">(meta</span></span> v<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> value<span style="color: #990000">-</span>set
  <span style="color: #FF0000">"Given any number of items as arguments, returns a set representing</span>
<span style="color: #FF0000">  multiple values in a MultiAssociative. If there is only one item,</span>
<span style="color: #FF0000">  simply returns the item."</span>
  <span style="color: #990000">[&amp;</span> items<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(=</span> <span style="color: #993399">1</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> items<span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(first</span></span> items<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>meta <span style="font-weight: bold"><span style="color: #000000">(set</span></span> items<span style="color: #990000">)</span> {<span style="color: #990000">::</span>multi<span style="color: #990000">-</span>value true}<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(extend</span></span><span style="color: #990000">-</span>protocol MultiAssociative
  clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Associative
  <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="color: #990000">[</span>this key value<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>v <span style="font-weight: bold"><span style="color: #000000">(get</span></span> this key<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> this key <span style="font-weight: bold"><span style="color: #000000">(cond</span></span>
                       <span style="font-weight: bold"><span style="color: #000000">(nil</span></span><span style="color: #990000">?</span> v<span style="color: #990000">)</span> value
                       <span style="font-weight: bold"><span style="color: #000000">(value</span></span><span style="color: #990000">-</span>set<span style="color: #990000">?</span> v<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(conj</span></span> v value<span style="color: #990000">)</span>
                       <span style="color: #990000">:</span>else <span style="font-weight: bold"><span style="color: #000000">(value</span></span><span style="color: #990000">-</span>set v value<span style="color: #990000">)))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> <span style="color: #990000">[</span>this key value<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>v <span style="font-weight: bold"><span style="color: #000000">(get</span></span> this key<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(value</span></span><span style="color: #990000">-</span>set<span style="color: #990000">?</span> v<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> this key <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> value<span style="color: #990000">-</span>set <span style="font-weight: bold"><span style="color: #000000">(disj</span></span> v value<span style="color: #990000">)))</span>
        <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(=</span> v value<span style="color: #990000">)</span>
          <span style="font-weight: bold"><span style="color: #000000">(dissoc</span></span> this key<span style="color: #990000">)</span>
          this<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>all <span style="color: #990000">[</span>this key<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>v <span style="font-weight: bold"><span style="color: #000000">(get</span></span> this key<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(cond</span></span>
       <span style="font-weight: bold"><span style="color: #000000">(value</span></span><span style="color: #990000">-</span>set<span style="color: #990000">?</span> v<span style="color: #990000">)</span> v
       <span style="font-weight: bold"><span style="color: #000000">(nil</span></span><span style="color: #990000">?</span> v<span style="color: #990000">)</span> #{}
       <span style="color: #990000">:</span>else #{v}<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>and, of course, corresponding unit tests (using <span class="monospaced">clojure.test</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>test <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> test<span style="color: #990000">-</span>insert
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"inserting to a new key"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"inserting to an existing key (single existing item)"</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>m <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k #{<span style="color: #990000">:</span>v1 <span style="color: #990000">:</span>v2}}
             <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> m <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"inserting to an existing key (multiple existing items)"</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>m <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1<span style="color: #990000">)</span> <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k #{<span style="color: #990000">:</span>v1 <span style="color: #990000">:</span>v2 <span style="color: #990000">:</span>v3}}
             <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> m <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v3<span style="color: #990000">))))))</span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> test<span style="color: #990000">-</span>delete
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"deleting a non-present key"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="color: #990000">:</span>nosuch <span style="color: #990000">:</span>nada<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"deleting a non-present value"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>nada<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"deleting a single value"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {} <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"deleting one of two values"</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>m <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1<span style="color: #990000">)</span> <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1} <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> m <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"deleting one of several values"</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>m <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1<span style="color: #990000">)</span> <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)</span> <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v3<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> {<span style="color: #990000">:</span>k #{<span style="color: #990000">:</span>v1 <span style="color: #990000">:</span>v2}} <span style="font-weight: bold"><span style="color: #000000">(delete</span></span> m <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v3<span style="color: #990000">))))))</span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> test<span style="color: #990000">-</span>get<span style="color: #990000">-</span>all
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"get a non-present key"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> #{} <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>all {} <span style="color: #990000">:</span>nosuch<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"get a single value"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> #{<span style="color: #990000">:</span>v} <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>all {<span style="color: #990000">:</span>k <span style="color: #990000">:</span>v} <span style="color: #990000">:</span>k<span style="color: #990000">))))</span>
  <span style="font-weight: bold"><span style="color: #000000">(testing</span></span> <span style="color: #FF0000">"get multiple values"</span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> #{<span style="color: #990000">:</span>v1 <span style="color: #990000">:</span>v2} <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>all <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> {} <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v1<span style="color: #990000">)</span> <span style="color: #990000">:</span>k <span style="color: #990000">:</span>v2<span style="color: #990000">)</span> <span style="color: #990000">:</span>k<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(run</span></span><span style="color: #990000">-</span>tests<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:type :summary, :pass 11, :test 3, :error 0, :fail 0}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_58">Discussion</h4>
<div class="paragraph"><p>First, this code defines a protocol to implement the set of functions
that comprises the multimap behavior. A protocol is a great choice in
this situation: it ties together several methods that perform related
operations on the same object, and it allows for multiple concrete
implementations.</p></div>
<div class="paragraph"><p>In this case, there are three methods required to implement the
desired functionality. Note that the protocol implementation does <em>not</em> override or
reimplement any of the core map methods (<span class="monospaced">assoc</span>, <span class="monospaced">dissoc</span>, etc.). It is only the
semantics of the new behavior that differ from those of regular maps. Clojure defines very strong semantics around core
functions. Breaking or overriding these expectations is always a bad
idea, especially when using a distinct set of functions makes it clear
when multimap functionality is being used.</p></div>
<div class="paragraph"><p>The concrete implementation of <span class="monospaced">MultiAssociative</span> extends the protocol
to the <span class="monospaced">clojure.lang.Associative</span> interface. It would certainly be
possible to implement it on something more targeted, such as
<span class="monospaced">IPersistentSet</span>, but since it only <em>requires</em> something associative
for the implementation, it&#8217;s best not to be too specific. Coding
against <span class="monospaced">clojure.lang.Associative</span> also gives several additional
capabilities for free. For example, there is now automatically a
"multivector" that can store multiple values at each index
(provided they are added using <span class="monospaced">insert</span>).</p></div>
<div class="paragraph"><p>Reading the code, you&#8217;ll notice that a good deal of the actual logic is
devoted to making sure that single values are stored plainly, while
multiple values are wrapped in a set. This is maintained both when
inserting and when deleting items, requiring the functions to run a
check on what type the value is and wrap or unwrap
accordingly. Similarly, <span class="monospaced">get-all</span> needs to wrap single values in a set
before returning, since it specifies that it must return a set.</p></div>
<div class="paragraph"><p>This is a design decision that has several benefits and trade-offs. The
alternative would be to always wrap the values in a set, even single
values. This would make the code a bit simpler and would eliminate
most of the type checking as well as the wrapping and unwrapping of
forms.</p></div>
<div class="paragraph"><p>However, the simplicity would come with a price. If values (even
single values) were <em>always</em> wrapped in a set, the map being used as a
multimap would not be easily usable via the normal map functions. It
would contain a lot of odd-looking single-item sets, and if anything
were added to it using <span class="monospaced">assoc</span>, it would be incompatible with future
uses of <span class="monospaced">insert</span> on that key.</p></div>
<div class="paragraph"><p>In essence, the wrapping and unwrapping is to allow any map to be
usable via both the standard <span class="monospaced">Associative</span> <em>and</em> the
<span class="monospaced">MultiAssociative</span> interfaces, without requiring the user to keep
track of which "kind" of a map it is. Values inserted using <span class="monospaced">assoc</span>
can be read with <span class="monospaced">get-all</span>, and values inserted using <span class="monospaced">insert</span> can be
removed with <span class="monospaced">dissoc</span>. All expectations regarding normal maps should
hold. In the case of a normal <span class="monospaced">get</span> on a key with multiple values, a
set containing multiple items will be returned. This is probably what
the user would expect upon inspecting the data.</p></div>
<div class="paragraph"><p>There is one more feature of this code that deserves commentary: the
use of <span class="monospaced">::multi-value</span> metadata on the sets used to store multiple
values, applied and tested using the <span class="monospaced">value-set</span> and <span class="monospaced">value-set?</span>
functions.</p></div>
<div class="paragraph"><p>This is to handle the edge case where the intended <em>value</em> for a key
is itself a set. The code needs a way to disambiguate between sets
it creates in order to manage multiple keys for a value and sets that
are simply values provided by users.</p></div>
<div class="paragraph"><p>This is accomplished by placing metadata on sets created to contain
values. A namespace-scoped keyword is used to ensure that it will not
collide with any possible existing metadata on values provided by the
user. Then, all the code has to do is check if a set has the
<span class="monospaced">::multi-value</span> metadata to know whether it&#8217;s a set containing values,
or is itself a value.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_58">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#extend_built_in">[extend_built_in]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_combining_maps">Combining Maps</h3>
<div class="paragraph byline"><p>by Tom Hicks</p></div>
<div class="sect3">
<h4 id="_problem_59">Problem</h4>
<div class="paragraph"><p>You have two or more maps you wish to combine to produce a single map.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_59">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">merge</span> to combine two or more maps with no keys in common:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> arizona<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts {<span style="color: #990000">:</span>cactus<span style="color: #990000">-</span>wren <span style="color: #993399">8</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> florida<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts {<span style="color: #990000">:</span>gull <span style="color: #993399">20</span> <span style="color: #990000">:</span>pelican <span style="color: #993399">14</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(merge</span></span> florida<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts arizona<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:pelican 14, :cactus-wren 8, :gull 20}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">merge-with</span> when you want more explicit control of the merge
strategy for keys that exist in more than one map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> florida<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts    {<span style="color: #990000">:</span>gull <span style="color: #993399">20</span> <span style="color: #990000">:</span>pelican <span style="color: #993399">1</span> <span style="color: #990000">:</span>egret <span style="color: #993399">4</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> california<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts {<span style="color: #990000">:</span>gull <span style="color: #993399">12</span> <span style="color: #990000">:</span>pelican <span style="color: #993399">4</span> <span style="color: #990000">:</span>jay <span style="color: #993399">3</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Merge values with + to get their totals</span></span>
<span style="font-weight: bold"><span style="color: #000000">(merge</span></span><span style="color: #990000">-</span>with <span style="color: #990000">+</span> california<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts florida<span style="color: #990000">-</span>bird<span style="color: #990000">-</span>counts<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:pelican 5, :egret 4, :gull 32, :jay 3}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_59">Discussion</h4>
<div class="paragraph"><p>In both <span class="monospaced">merge</span> and <span class="monospaced">merge-with</span>, maps are combined from left to
right, returning a new immutable map as a result. This functions much
like a "left fold." <span class="monospaced">merge</span> is the simpler function of the pair,
always returning the last value it sees for every key.</p></div>
<div class="paragraph"><p>When mappings for the same key exist in more than one map, the latter
mapping is used in the result. This can be useful, for example, when
you receive new totals throughout the day, but only for values that
have changed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Favorite ice cream flavor votes throughout the day</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> votes<span style="color: #990000">-</span>am {<span style="color: #990000">:</span>vanilla <span style="color: #993399">3</span> <span style="color: #990000">:</span>chocolate <span style="color: #993399">5</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> votes<span style="color: #990000">-</span>pm {<span style="color: #990000">:</span>vanilla <span style="color: #993399">4</span> <span style="color: #990000">:</span>neapoliton <span style="color: #993399">2</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(merge</span></span> votes<span style="color: #990000">-</span>am votes<span style="color: #990000">-</span>pm<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:vanilla 4, :chocolate 5, :neapoliton 2}</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">merge-with</span> facilitates powerful recipes for map combination by
allowing you to control <em>how</em> values are merged. You can imagine
<span class="monospaced">merge-with</span> as <span class="monospaced">reduce</span> for maps with common keys. The first argument
to <span class="monospaced">merge-with</span> is a merge function that will be invoked for each pair
of duplicated values.</p></div>
<div class="paragraph"><p>With careful choice of map value types, <span class="monospaced">merge-with</span> provides some
concise solutions to common problems. For example, by merging with
<span class="monospaced">clojure.set/intersection</span>, you can find the intersection of "like" and
"dislike" sets in a team of programmers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> Alice {<span style="color: #990000">:</span>loves #{<span style="color: #990000">:</span>clojure <span style="color: #990000">:</span>lisp <span style="color: #990000">:</span>scheme} <span style="color: #990000">:</span>hates #{<span style="color: #990000">:</span>fortran <span style="color: #990000">:</span>c <span style="color: #990000">:</span>c<span style="color: #990000">++</span>}}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> Bob   {<span style="color: #990000">:</span>loves #{<span style="color: #990000">:</span>clojure <span style="color: #990000">:</span>scheme}       <span style="color: #990000">:</span>hates #{<span style="color: #990000">:</span>c <span style="color: #990000">:</span>c<span style="color: #990000">++</span> <span style="color: #990000">:</span>algol}}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> Ted   {<span style="color: #990000">:</span>loves #{<span style="color: #990000">:</span>clojure <span style="color: #990000">:</span>lisp <span style="color: #990000">:</span>scheme} <span style="color: #990000">:</span>hates #{<span style="color: #990000">:</span>algol <span style="color: #990000">:</span>basic <span style="color: #990000">:</span>c
                                                      <span style="color: #990000">:</span>c<span style="color: #990000">++</span> <span style="color: #990000">:</span>fortran}}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(merge</span></span><span style="color: #990000">-</span>with clojure<span style="color: #990000">.</span>set<span style="color: #990000">/</span>intersection Alice Bob Ted<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:loves #{:scheme :clojure}, :hates #{:c :c++}}</span></span></tt></pre></div></div>
<div class="paragraph"><p>It is also possible to merge nested maps by creating a recursive merge
function.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Copied verbatim from the defunct clojure-contrib (http://bit.ly/deep-merge-with)</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> deep<span style="color: #990000">-</span>merge<span style="color: #990000">-</span>with <span style="color: #990000">[</span>f <span style="color: #990000">&amp;</span> maps<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(apply</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> m <span style="color: #990000">[&amp;</span> maps<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(every</span></span><span style="color: #990000">?</span> map<span style="color: #990000">?</span> maps<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> merge<span style="color: #990000">-</span>with m maps<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> f maps<span style="color: #990000">)))</span>
    maps<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(deep</span></span><span style="color: #990000">-</span>merge<span style="color: #990000">-</span>with <span style="color: #990000">+</span> {<span style="color: #990000">:</span>foo {<span style="color: #990000">:</span>bar {<span style="color: #990000">:</span>baz <span style="color: #993399">1</span>}}}
                   {<span style="color: #990000">:</span>foo {<span style="color: #990000">:</span>bar {<span style="color: #990000">:</span>baz <span style="color: #993399">6</span> <span style="color: #990000">:</span>qux <span style="color: #993399">42</span>}}}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:foo {:bar {:qux 42, :baz 7}}}</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you saw in the previous examples, <span class="monospaced">merge-with</span> is a versatile tool: we
used <span class="monospaced">+</span> to add values of the same key, <span class="monospaced">clojure.set/intersection</span> to
find shared values of multiple sets, and a recursive function
<span class="monospaced">deep-merge</span> to recursively merge nested maps. <span class="monospaced">merge-with</span> is a
very powerful function, indeed.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_59">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_data_maps_setting_keys">[sec_composite_data_maps_setting_keys]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_data_maps_multiple_values">[sec_composite_data_maps_multiple_values]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_composite_sorting">Comparing and Sorting Values</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_60">Problem</h4>
<div class="paragraph"><p>You want to compare two values according to some comparison
function, or you want to sort a collection by comparing all the items
in it.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_60">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.core/compare</span> function to compare two items. They must be
comparable with respect to each other. For example, a <span class="monospaced">double</span> can be
compared to a ratio because they&#8217;re both numbers, but a string can&#8217;t
be compared to a vector.</p></div>
<div class="paragraph"><p><span class="monospaced">compare</span> returns a negative number if the first argument is less than
the second, zero if it is logically equal, and a positive number if it
is greater:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #993399">5</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #993399">0.5</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #993399">0.25</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #FF0000">"brewer"</span> <span style="color: #FF0000">"aardvark"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span></tt></pre></div></div>
<div class="paragraph"><p>To sort an entire collection, pass it to the <span class="monospaced">clojure.core/sort</span>
function. <span class="monospaced">sort</span> applies <span class="monospaced">compare</span> as needed and returns a sorted
sequence.</p></div>
<div class="paragraph"><p>For example, the following code breaks down a string into a sequence
of characters (<span class="monospaced">sort</span> calls <span class="monospaced">seq</span> on its argument), then sorts
them. The result is concatenated back to a string, for better
readability:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="color: #FF0000">"The quick brown fox jumped over the lazy dog"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "        Tabcddeeeefghhijklmnoooopqrrtuuvwxyz"</span></span></tt></pre></div></div>
<div class="paragraph"><p>As seen previously, many of Clojure&#8217;s data types have a <em>natural</em>
comparison order, which is what <span class="monospaced">compare</span> uses. For example, numbers,
dates, and strings all sort as one would expect, from low to high,
based on the well-understood and accepted inherent ordering between
them.</p></div>
<div class="paragraph"><p>If you want to sort a data type that does not have a natural ordering,
or if you want to override the natural sort (such as sorting a set
from high to low), you are not limited to using the built-in
comparator function. <span class="monospaced">sort</span> allows you to specify a custom comparison
function that can perform any operation you like to determine the
relative ordering between two items. This function must take two
arguments. It can return values like <span class="monospaced">compare</span> does (that is, a
positive integer, a negative integer, or zero). Alternatively, it can
return a Boolean value (i.e., a <em>predicate</em> function). The predicate
function should return <span class="monospaced">true</span> if and only if the first argument should be sorted before the second argument.</p></div>
<div class="paragraph"><p>This means that you can pass regular Clojure predicates to <span class="monospaced">sort</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="color: #990000">&gt;</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (4 3 2 1)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="color: #990000">&lt;</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 2 3 4)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or, you can write your own arbitrary comparator. For example, the
custom comparator used in the next example cares only about the length
of a string, not the contents of it; strings will be sorted as equal
if they have the same number of characters, whatever those characters
are:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sort</span></span> #<span style="color: #990000">(&lt;</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="color: #990000">%</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">))</span> <span style="color: #990000">[</span><span style="color: #FF0000">"z"</span> <span style="color: #FF0000">"yy"</span> <span style="color: #FF0000">"zzz"</span> <span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"bb"</span> <span style="color: #FF0000">"ccc"</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("z" "a" "yy" "bb" "zzz" "ccc")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_60">Discussion</h4>
<div class="paragraph"><p>Under the hood, Clojure uses Java&#8217;s built-in sort mechanism. Java uses
a slightly modified merge sort algorithm that is highly performant for
the vast majority of cases. It requires <em>n</em> log(<em>n</em>) comparisons in the
worst case and performs at near <em>O</em>(<em>n</em>) when the input is largely
sorted already.</p></div>
<div class="paragraph"><p>The sort is also <em>stable</em>, meaning that if two items are equal in
terms of the comparator function being used, their relative ordering
will remain unchanged after sorting.</p></div>
<div class="paragraph"><p>Although you can use any predicate as a comparison function or write
your own comparison function that returns a positive/negative/zero
integer, the actual function must behave properly in order to
work. Specifically, it must:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Have a consistent total order for all the members being sorted
</dt>
<dd>
<p>
If <span class="monospaced">x</span> is sorted before <span class="monospaced">y</span>, and <span class="monospaced">y</span> is sorted before <span class="monospaced">z</span>, then <span class="monospaced">x</span>
  must <em>always</em> be sorted before <span class="monospaced">z</span>. In other words, there must
  always be a single fully deterministic sort order for a given
  collection and comparator, without any contradictions or
  inconsistencies caused by the comparison function.
</p>
</dd>
<dt class="hdlist1">
Be consistent with the .equals method and Clojure&#8217;s <span class="monospaced">=</span> function
</dt>
<dd>
<p>
If two items are logically equal, then that must be
  reflected in the comparison function. When using the integer return
  values, the function ought to return <span class="monospaced">0</span>. When using a
  predicate function, <span class="monospaced">(pred x y)</span> and <span class="monospaced">(pred y x)</span> should return the
  same thing in the case where <span class="monospaced">x</span> and <span class="monospaced">y</span> are equal.
</p>
</dd>
<dt class="hdlist1">
Have no side effects
</dt>
<dd>
<p>
The comparison function may be called an arbitrary number of times as the sort is evaluated.
</p>
</dd>
</dl></div>
<div class="sect4">
<h5 id="_comparators_and_the_jvm">Comparators and the JVM</h5>
<div class="paragraph"><p>Clojure fully participates in Java&#8217;s comparison and sorting
mechanisms. All Clojure objects that have a natural order implement
<a href="http://bit.ly/javadoc-comparable"><span class="monospaced">java.lang.Comparable</span></a>
and implement the <span class="monospaced">compareTo</span> method.</p></div>
<div class="paragraph"><p>More importantly, every Clojure function actually implements the
<a href="http://bit.ly/javadoc-comparator"><span class="monospaced">java.util.Comparator</span></a>
interface. This means that you can pass a Clojure function to any Java
method that requires an instance of <span class="monospaced">java.util.Comparator</span>, and it
will invoke the function with two arguments. This is what allows you
to pass arbitrary Clojure functions as the comparator to <span class="monospaced">sort</span>. The
function object itself is actually being used as a Java comparator,
and invoking the Java <span class="monospaced">.compare</span> method on a Clojure function will
actually call it, passing it the two values being compared as two
arguments.</p></div>
<div class="paragraph"><p>Because predicate functions (those returning a Boolean value) do not
map exactly to the positive/negative/zero integer return values
expected from a <span class="monospaced">java.util.Comparator</span>, Clojure itself handles the
logical mapping between them. If a function used as a comparator (that
is, <span class="monospaced">(pred x y)</span>) returns <span class="monospaced">true</span>, the implementation will return <span class="monospaced">-1</span>,
indicating that <span class="monospaced">x</span> is less than <span class="monospaced">y</span> in the given sort. If not, it will
invoke the function again with the arguments reversed. If <span class="monospaced">(pred x y)</span>
and <span class="monospaced">(pred y x)</span> are both <span class="monospaced">false</span>, it is assumed that the objects are
equal, and the implementation returns <span class="monospaced">0</span>. Otherwise, it presumes <span class="monospaced">x</span> is greater than <span class="monospaced">y</span>
and returns <span class="monospaced">1</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_sort_by">sort-by</h5>
<div class="paragraph"><p>Sometimes, you want to sort a collection not by the values themselves,
but by some derivative function of the values. For example, say you
have the following data, and you&#8217;d like to sort alphabetically by
name. Unfortunately, maps don&#8217;t have a natural sort, so you&#8217;ll need to
tell Clojure how to sort the data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> people <span style="color: #990000">[</span>{<span style="color: #990000">:</span>name <span style="color: #FF0000">"Luke"</span>   <span style="color: #990000">:</span>role <span style="color: #990000">:</span>author}
             {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Ryan"</span>   <span style="color: #990000">:</span>role <span style="color: #990000">:</span>author}
             {<span style="color: #990000">:</span>name <span style="color: #FF0000">"John"</span>   <span style="color: #990000">:</span>role <span style="color: #990000">:</span>reviewer}
             {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Travis"</span> <span style="color: #990000">:</span>role <span style="color: #990000">:</span>reviewer}
             {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Tom"</span>    <span style="color: #990000">:</span>role <span style="color: #990000">:</span>reviewer}
             {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Meghan"</span> <span style="color: #990000">:</span>role <span style="color: #990000">:</span>editor}<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>One option would be to use a custom comparator, which extracts the
<span class="monospaced">:name</span> key and then invokes <span class="monospaced">compare</span> on it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sort</span></span> #<span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #990000">(:</span>name <span style="color: #990000">%</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">(:</span>name <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">))</span> people<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "John", :role :reviewer}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Luke", :role :author}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Meghan", :role :editor}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Ryan", :role :author}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Tom", :role :reviewer}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Travis", :role :reviewer})</span></span></tt></pre></div></div>
<div class="paragraph"><p>However, there&#8217;s an easier way. The <span class="monospaced">sort-by</span> function works the same
as <span class="monospaced">sort</span>, but takes an additional function <span class="monospaced">keyfn</span> as an argument to
apply to the elements before sorting them. Instead of sorting on the
elements themselves, it sorts the result of applying <span class="monospaced">keyfn</span> to the
elements.</p></div>
<div class="paragraph"><p>So, passing in <span class="monospaced">:name</span> as the <span class="monospaced">keyfn</span> (as discussed in <a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>, keywords are
functions that look themselves up in a map), you can call:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sort</span></span><span style="color: #990000">-</span>by <span style="color: #990000">:</span>name people<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;;-&gt;  ({:name "John", :role :reviewer}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Luke", :role :author}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Meghan", :role :editor}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Ryan", :role :author}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Tom", :role :reviewer}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Travis", :role :reviewer})</span></span></tt></pre></div></div>
<div class="paragraph"><p>Like <span class="monospaced">sort</span>, <span class="monospaced">sort-by</span> also takes an optional comparator function
that it will use to compare the values extracted by the <span class="monospaced">keyfn</span>.</p></div>
<div class="paragraph"><p>For another example, the following expression uses the <span class="monospaced">str</span> function
as a <span class="monospaced">keyfn</span> to sort the numbers from 1 to 20 not on their numeric
value, but lexographically as strings (meaning that "2" is greater
than "10," etc.). It also demonstrates using a custom comparator to
specify the results in <em>descending</em> order:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Descending lexographic order</span></span>
<span style="font-weight: bold"><span style="color: #000000">(sort</span></span><span style="color: #990000">-</span>by str #<span style="color: #990000">(*</span> <span style="color: #990000">-</span><span style="color: #993399">1</span> <span style="font-weight: bold"><span style="color: #000000">(compare</span></span> <span style="color: #990000">%</span><span style="color: #993399">1</span> <span style="color: #990000">%</span><span style="color: #993399">2</span><span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">1</span> <span style="color: #993399">20</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (9 8 7 6 5 4 3 2 19 18 17 16 15 14 13 12 11 10 1)</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_natural_sort_of_data_structures">Natural sort of data structures</h5>
<div class="paragraph"><p>Some compositive data structures can also be compared if they
implement <span class="monospaced">Comparable</span>, are of the same type, and contain comparable
values. The comparison order is implementation dependent. For example,
by default, vectors are compared first by their length, then by the
result of applying <span class="monospaced">compare</span> to their first value, then to their second
value if the first is equal, etc.:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sort</span></span> <span style="color: #990000">[[</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([1] [2] [1 2] [2 1] [1 1 1])</span></span></tt></pre></div></div>
<div class="paragraph"><p>Some data structures are not comparable. For example,
the fact that a set is defined to be unordered means that a meaningful
greater-than/less-than comparison is not possible in the general case,
so no comparison is provided.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_60">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The API documentation for <a href="http://bit.ly/javadoc-comparable"><span class="monospaced">java.lang.Comparable</span></a>
</p>
</li>
<li>
<p>
The API documentation for <a href="http://bit.ly/javadoc-comparator"><span class="monospaced">java.util.Comparator</span></a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_numbers_fuzzy_comparison">[sec_primitives_numbers_fuzzy_comparison]</a>
</p>
</li>
<li>
<p>
<a href="#sec_primitives_dates_comparing">[sec_primitives_dates_comparing]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_removing_duplicate_elements_from_a_collection">Removing Duplicate Elements from a Collection</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_61">Problem</h4>
<div class="paragraph"><p>You have a sequence of elements and you want to remove any duplicates,
while possibly preserving the order of elements.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_61">Solution</h4>
<div class="paragraph"><p>When the sequence of elements you&#8217;re working with is of a bounded,
reasonable size, use <span class="monospaced">set</span> to coerce the collection into a hash set
containing only distinct values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(set</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>a <span style="color: #990000">:</span>g <span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>g<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{:a :b :g}</span></span></tt></pre></div></div>
<div class="paragraph"><p>When the sequence is infinite, or you wish to maintain ordering, use
<span class="monospaced">distinct</span> to return a lazy sequence of unique values in a collection
in the order they appear:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(distinct</span></span> <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>a <span style="color: #990000">:</span>g <span style="color: #990000">:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>g<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (:a :g :b)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_61">Discussion</h4>
<div class="paragraph"><p>There are a number of trade-offs between these two approaches. For
starters, <span class="monospaced">set</span> consumes the entire sequence to produce a new set
collection. Because of this, <span class="monospaced">set</span> cannot be used to filter an
infinite sequence. <span class="monospaced">distinct</span>, on the other hand, is designed for
consuming lazy sequences. The value of <span class="monospaced">distinct</span> is a lazy view or
projection over another sequence, yielding new values the first time
they appear:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> rand<span style="color: #990000">-</span><span style="color: #009900">int</span><span style="color: #990000">-</span>seq
  <span style="color: #FF0000">"Returns an infinite sequence of ints from [0, n)"</span>
  <span style="color: #990000">[</span>n<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span> #<span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span> n<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Taking the set of an infinite sequence will *never* return:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (set (rand-int-seq 10)) ; don't do it!</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; However, if you limit the seq, set will work</span></span>
<span style="font-weight: bold"><span style="color: #000000">(set</span></span> <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">10</span> <span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span><span style="color: #990000">-</span>seq <span style="color: #993399">10</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{0 1 2 3 4 7 8 9}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; distinct works no matter what</span></span>
<span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">10</span> <span style="font-weight: bold"><span style="color: #000000">(distinct</span></span> <span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span><span style="color: #009900">int</span><span style="color: #990000">-</span>seq <span style="color: #993399">10</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (8 3 4 6 0 5 9 7 1 2)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Since <span class="monospaced">distinct</span> produces new values as it sees them, it <em>does</em>
maintain ordering. <span class="monospaced">set</span>, on the other hand, returns an unordered set.</p></div>
<div class="paragraph"><p>If <span class="monospaced">distinct</span> is both ordered and lazy over sequences of any length,
what is the advantage of <span class="monospaced">set</span>? Speed. Using <span class="monospaced">distinct</span> is by far the
slowest option; simply calling <span class="monospaced">set</span> is about two times faster.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_61">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_composite_creating_sets">[sec_composite_creating_sets]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_test_collection_with_set">Determining if a Collection Holds One of Several Values</h3>
<div class="paragraph byline"><p>by John Touron</p></div>
<div class="sect3">
<h4 id="_problem_62">Problem</h4>
<div class="paragraph"><p>You have a collection and you want to determine if it holds one of several
possible values.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_62">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">some</span>, along with a set:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(some</span></span> #{<span style="color: #993399">1</span> <span style="color: #993399">2</span>} <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">10</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(some</span></span> #{<span style="color: #993399">10</span>} <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">10</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_62">Discussion</h4>
<div class="paragraph"><p>Since sets can act like functions, they can be used as predicates to test whether the argument is a member of the set. This idiom will
test each item in a collection, returning either the first match or
<span class="monospaced">nil</span> if a match couldn&#8217;t be found. However, a problem arises when <span class="monospaced">nil</span> or <span class="monospaced">false</span> is a member of the set
you&#8217;re using to test a collection with. Consider the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(some</span></span> #{nil} <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> nil <span style="color: #993399">3</span><span style="color: #990000">])</span>
  <span style="color: #990000">::</span>found
  <span style="color: #990000">::</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :user/not-found</span></span>

<span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(some</span></span> #{false} <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> false <span style="color: #993399">3</span><span style="color: #990000">])</span>
  <span style="color: #990000">::</span>found
  <span style="color: #990000">::</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :user/not-found</span></span></tt></pre></div></div>
<div class="paragraph"><p>Because the <span class="monospaced">some</span> function returns the <em>value</em> returned from the
predicate function when it&#8217;s logically true, not just <span class="monospaced">true</span> or <span class="monospaced">false</span>, using it with sets
that contain <span class="monospaced">nil</span> or <span class="monospaced">false</span> probably isn&#8217;t what you want&#8212;it will
return <span class="monospaced">nil</span> if the item actually <em>is</em> in the set. The simplest solution is to test for <span class="monospaced">nil</span> or <span class="monospaced">false</span> separately,
using the <span class="monospaced">nil?</span> or <span class="monospaced">false?</span> predicate functions built into Clojure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(some</span></span> nil<span style="color: #990000">?</span> <span style="color: #990000">[</span>nil false<span style="color: #990000">])</span>
  <span style="color: #990000">::</span>found
  <span style="color: #990000">::</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :user/found</span></span>

<span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(some</span></span> false<span style="color: #990000">?</span> <span style="color: #990000">[</span>nil false<span style="color: #990000">])</span>
  <span style="color: #990000">::</span>found
  <span style="color: #990000">::</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :user/found</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or, to test both at once:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(some</span></span> #<span style="font-weight: bold"><span style="color: #000000">(or</span></span> <span style="font-weight: bold"><span style="color: #000000">(false</span></span><span style="color: #990000">?</span> <span style="color: #990000">%)</span>
               <span style="font-weight: bold"><span style="color: #000000">(nil</span></span><span style="color: #990000">?</span> <span style="color: #990000">%))</span>
      <span style="color: #990000">[</span>nil false<span style="color: #990000">])</span>
  <span style="color: #990000">::</span>found
  <span style="color: #990000">::</span>not<span style="color: #990000">-</span>found<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; :user/found</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_62">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_testing_set_membership">[sec_testing_set_membership]</a>
</p>
</li>
<li>
<p>
<a href="#sec_composite_retrieving_keys_map">[sec_composite_retrieving_keys_map]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_red_black_part_i">Implementing Custom Data Structures: Red-Black Trees&#8212;Part I</h3>
<div class="paragraph byline"><p>by Leonardo Borges</p></div>
<div class="sect3">
<h4 id="_problem_63">Problem</h4>
<div class="paragraph"><p>You want to implement a data structure in Clojure with very specific
performance characteristics.</p></div>
<div class="paragraph"><p>For example, you need fast, efficient in-memory searches across a
large, random, and ever-changing dataset.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_63">Solution</h4>
<div class="paragraph"><p>After identifying that Clojure&#8217;s core data structures are not
appropriate for your domain, your first step is to determine what data
structure <em>is</em> appropriate.</p></div>
<div class="paragraph"><p>For the purpose of this recipe, assume you are trying to choose and
implement a data structure appropriate for fast in-memory search of a
large, random, and ever-changing dataset. At first, a binary search
tree (BST) seems like a good solution. A BST is most efficient over a
sorted dataset, however. Adding and removing large amounts of data
may unbalance a BST and degenerate its performance to that of a linked
list.</p></div>
<div class="paragraph"><p>Red-black trees (RBTs) are similar to BSTs, but are self-balancing. This
would be an appropriate data structure for the dataset in question.</p></div>
<div class="paragraph"><p>The next step is to implement the data structure itself. The
implementation of RBTs relies on pattern matching. Use
<a href="https://github.com/clojure/core.match"><span class="monospaced">core.match</span></a> to simplify the
implementation of an RBT. Add <span class="monospaced">[org.clojure/core.match "0.2.0"]</span> to your project&#8217;s
dependencies, or start a REPL with <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>match</tt></pre></div></div>
<div class="paragraph"><p>First, implement the core of an RBT, the <span class="monospaced">balance</span> and <span class="monospaced">insert-val</span>
functions. By using <span class="monospaced">core.match</span>, it is possible to succinctly express
the required behaviors based on the shape of the tree:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>match <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>match<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> balance
  <span style="color: #FF0000">"Ensures the given subtree stays balanced by rearranging black nodes</span>
<span style="color: #FF0000">  that have at least one red child and one red grandchild"</span>
  <span style="color: #990000">[</span>tree<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(match</span></span> <span style="color: #990000">[</span>tree<span style="color: #990000">]</span>
         <span style="color: #990000">[(:</span>or <span style="font-style: italic"><span style="color: #9A1900">;; Left child red with left red grandchild</span></span>
               <span style="color: #990000">[:</span>black <span style="color: #990000">[:</span>red <span style="color: #990000">[:</span>red a x b<span style="color: #990000">]</span> y c<span style="color: #990000">]</span> z d<span style="color: #990000">]</span>
               <span style="font-style: italic"><span style="color: #9A1900">;; Left child red with right red grandchild</span></span>
               <span style="color: #990000">[:</span>black <span style="color: #990000">[:</span>red a x <span style="color: #990000">[:</span>red b y c<span style="color: #990000">]]</span> z d<span style="color: #990000">]</span>
               <span style="font-style: italic"><span style="color: #9A1900">;; Right child red with left red grandchild</span></span>
               <span style="color: #990000">[:</span>black a x <span style="color: #990000">[:</span>red <span style="color: #990000">[:</span>red b y c<span style="color: #990000">]</span> z d<span style="color: #990000">]]</span>
               <span style="font-style: italic"><span style="color: #9A1900">;; Right child red with right red grandchild</span></span>
               <span style="color: #990000">[:</span>black a x <span style="color: #990000">[:</span>red b y <span style="color: #990000">[:</span>red c z d<span style="color: #990000">]]])]</span> <span style="color: #990000">[:</span>red <span style="color: #990000">[:</span>black a x b<span style="color: #990000">]</span>
                                                            y
                                                            <span style="color: #990000">[:</span>black c z d<span style="color: #990000">]]</span>
               <span style="color: #990000">:</span>else tree<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> insert<span style="color: #990000">-</span>val
  <span style="color: #FF0000">"Inserts x in tree.</span>
<span style="color: #FF0000">  Returns a node with x and no children if tree is nil.</span>

<span style="color: #FF0000">  Returned tree is balanced. See also `balance`"</span>
  <span style="color: #990000">[</span>tree x<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>ins <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> ins <span style="color: #990000">[</span>tree<span style="color: #990000">]</span>
              <span style="font-weight: bold"><span style="color: #000000">(match</span></span> tree
                     nil <span style="color: #990000">[:</span>red nil x nil<span style="color: #990000">]</span>
                     <span style="color: #990000">[</span>color a y b<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(cond</span></span>
                                    <span style="color: #990000">(&lt;</span> x y<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(balance</span></span> <span style="color: #990000">[</span>color <span style="font-weight: bold"><span style="color: #000000">(ins</span></span> a<span style="color: #990000">)</span> y b<span style="color: #990000">])</span>
                                    <span style="color: #990000">(&gt;</span> x y<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(balance</span></span> <span style="color: #990000">[</span>color a y <span style="font-weight: bold"><span style="color: #000000">(ins</span></span> b<span style="color: #990000">)])</span>
                                    <span style="color: #990000">:</span>else tree<span style="color: #990000">)))</span>
        <span style="color: #990000">[</span>_ a y b<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(ins</span></span> tree<span style="color: #990000">)]</span>
    <span style="color: #990000">[:</span>black a y b<span style="color: #990000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>With insertion and balance out of the way, the only remaining
function to implement is a <span class="monospaced">find-val</span> function for testing if a value
is present in an RBT. The easiest way to do this is by breaking down
individual tree nodes with <span class="monospaced">match</span> and recursively scanning for the
desired value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> find<span style="color: #990000">-</span>val
  <span style="color: #FF0000">"Finds value x in tree"</span>
  <span style="color: #990000">[</span>tree x<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(match</span></span> tree
         nil nil
         <span style="color: #990000">[</span>_ a y b<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(cond</span></span>
                    <span style="color: #990000">(&lt;</span> x y<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(recur</span></span> a x<span style="color: #990000">)</span>
                    <span style="color: #990000">(&gt;</span> x y<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(recur</span></span> b x<span style="color: #990000">)</span>
                    <span style="color: #990000">:</span>else x<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>With all of this in place, it is now possible to create and query an
RBT:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> rb<span style="color: #990000">-</span>tree <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> insert<span style="color: #990000">-</span>val nil <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">4</span><span style="color: #990000">)))</span>

rb<span style="color: #990000">-</span>tree
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:black [:black nil 0 nil] 1 [:black nil 2 [:red nil 3 nil]]]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(find</span></span><span style="color: #990000">-</span>val rb<span style="color: #990000">-</span>tree <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>

<span style="font-weight: bold"><span style="color: #000000">(find</span></span><span style="color: #990000">-</span>val rb<span style="color: #990000">-</span>tree <span style="color: #993399">100</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_63">Discussion</h4>
<div class="paragraph"><p>For anyone who has ever had to implement a red-black tree&#8212;or at
least attended a class in computer science where the algorithm was
taught&#8212;the implementation of <span class="monospaced">balance</span> might seem extremely short.
The reason for this is threefold:</p></div>
<div class="ulist"><ul>
<li>
<p>
Our red-black tree is persistent: operations on it, such as insert
  and balance, are not destructive.
</p>
</li>
<li>
<p>
<span class="monospaced">balance</span> and <span class="monospaced">find-val</span> use <span class="monospaced">core.match</span> to codify logic as patterns
  to match.
</p>
</li>
<li>
<p>
Nodes are represented as vectors.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The two latter points are related, as you&#8217;ll see shortly.</p></div>
<div class="paragraph"><p>Conveniently enough, <span class="monospaced">core.match</span> allows us to match on the shape and
values of a data structure and perform structural binding at
the same time. For example, the following tries to match <span class="monospaced">a-vector</span>
against two clauses:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> a<span style="color: #990000">-</span>vector <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(match</span></span> a<span style="color: #990000">-</span>vector
       <span style="color: #990000">[</span>_ y<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Got y: "</span> y<span style="color: #990000">)</span>
       <span style="color: #990000">[</span>_ _ z<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Got z: "</span> z<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Got z: 3"</span></span></tt></pre></div></div>
<div class="paragraph"><p>The first clause matches a two-element vector, whereas the second
matches a three-element vector. Given that <span class="monospaced">a-vector</span> has exactly three
elements, it matches the second clause. In the expression that
follows, named values (such as <span class="monospaced">z</span>) are bound to the positions they
match.</p></div>
<div class="paragraph"><p>This is why it was convenient to represent nodes as vectors&#8212;it makes
pattern matching against them a breeze:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> rb<span style="color: #990000">-</span>node <span style="color: #990000">[:</span>red nil <span style="color: #993399">3</span> <span style="color: #990000">[:</span>black nil <span style="color: #993399">4</span> nil<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(match</span></span> rb<span style="color: #990000">-</span>node
       <span style="color: #990000">[:</span>red left value right<span style="color: #990000">]</span>   <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Red node with value: "</span> value<span style="color: #990000">)</span>
       <span style="color: #990000">[:</span>black left value right<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Black node with value: "</span> value<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Red node with value: 3"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Assuming this new custom data structure meets your performance
criteria, what is left? (You are benchmarking all of your custom data
structures, right?) Unlike built-in data structures, this custom data
structure doesn&#8217;t work with core functions such as <span class="monospaced">map</span> and
<span class="monospaced">filter</span>.</p></div>
<div class="paragraph"><p>In the second part of this recipe, <a href="#sec_red_black_part_ii">[sec_red_black_part_ii]</a>, we&#8217;ll
rectify this situation by participating in the core sequence abstraction.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_63">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The second part of this recipe, <a href="#sec_red_black_part_ii">[sec_red_black_part_ii]</a>, where we
  add sequence functionality to our RBT.
</p>
</li>
<li>
<p>
<a href="http://bit.ly/wiki-rbt">Red-black
  trees on Wikipedia</a> for a more traditional take on this interesting
  data structure.
</p>
</li>
<li>
<p>
For the functional approach used in this recipe, the book
  <a href="http://bit.ly/pure-fds"><em>Purely
  Functional Data Structures</em></a> by Chris Okasaki (Cambridge University Press) is an excellent source. It deals with
  how to efficiently implement data structures in a functional
  setting. The author chose to use ML and Haskell, but the concepts are
  transferable to Clojure, as demonstrated previously.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_red_black_part_ii">Implementing Custom Data Structures: Red-Black Trees&#8212;Part II</h3>
<div class="paragraph byline"><p>by Ryan Neufeld; originally submitted by Leonardo Borges</p></div>
<div class="sect3">
<h4 id="_problem_64">Problem</h4>
<div class="paragraph"><p>You want to use Clojure&#8217;s core sequence functions (<span class="monospaced">conj</span>, <span class="monospaced">map</span>,
<span class="monospaced">filter</span>, etc.) with your custom data structure.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_64">Solution</h4>
<div class="paragraph"><p>In part one of this recipe (<a href="#sec_red_black_part_i">[sec_red_black_part_i]</a>), you implemented
all the functions necessary for creating an efficient red-black tree. What&#8217;s missing is participation in Clojure&#8217;s sequence abstraction.</p></div>
<div class="paragraph"><p>The most important part of participating in sequence abstraction
is the ability to expose values of a data structure sequentially. The
built-in <span class="monospaced">tree-seq</span> is well suited for this task. One extra step is
needed, however; <span class="monospaced">tree-seq</span> returns a sequence of nodes, not values.</p></div>
<div class="paragraph"><p>Here&#8217;s the final <span class="monospaced">rb-tree-&gt;seq</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span> rb<span style="color: #990000">-</span>tree<span style="color: #990000">-&gt;</span>tree<span style="color: #990000">-</span>seq
  <span style="color: #FF0000">"Return a seq of all nodes in an red-black tree."</span>
  <span style="color: #990000">[</span>rb<span style="color: #990000">-</span>tree<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(tree</span></span><span style="color: #990000">-</span>seq sequential<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[[</span>_ left _ right<span style="color: #990000">]]</span>
                          <span style="font-weight: bold"><span style="color: #000000">(remove</span></span> nil<span style="color: #990000">?</span> <span style="color: #990000">[</span>left right<span style="color: #990000">]))</span>
            rb<span style="color: #990000">-</span>tree<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> rb<span style="color: #990000">-</span>tree<span style="color: #990000">-&gt;</span>seq
  <span style="color: #FF0000">"Convert a red-black tree to a seq of its values."</span>
  <span style="color: #990000">[</span>rb<span style="color: #990000">-</span>tree<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[[</span>_ _ val _<span style="color: #990000">]]</span> val<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(rb</span></span><span style="color: #990000">-</span>tree<span style="color: #990000">-&gt;</span>tree<span style="color: #990000">-</span>seq rb<span style="color: #990000">-</span>tree<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(rb</span></span><span style="color: #990000">-</span>tree<span style="color: #990000">-&gt;</span>seq <span style="color: #990000">(-&gt;</span> nil
                  <span style="font-weight: bold"><span style="color: #000000">(insert</span></span><span style="color: #990000">-</span>val <span style="color: #993399">5</span><span style="color: #990000">)</span>
                  <span style="font-weight: bold"><span style="color: #000000">(insert</span></span><span style="color: #990000">-</span>val <span style="color: #993399">2</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (5 2)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Since RBTs most closely resemble sets, they should adhere well to the
<span class="monospaced">IPersistentSet</span> interface. Extend the <span class="monospaced">IPersistentSet</span> and <span class="monospaced">IFn</span>
protocols to a new <span class="monospaced">RedBlackTree</span> type, implementing all of the
necessary functions. It&#8217;s also wise to implement the multimethod
<span class="monospaced">print-method</span> for <span class="monospaced">RedBlackTree</span>, as the default implementation will
fail for <span class="monospaced">RedBlackTree</span> as implemented:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(deftype</span></span> RedBlackTree <span style="color: #990000">[</span>tree<span style="color: #990000">]</span>
  clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>IPersistentSet
  <span style="font-weight: bold"><span style="color: #000000">(cons</span></span> <span style="color: #990000">[</span>self v<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(RedBlackTree</span></span><span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(insert</span></span><span style="color: #990000">-</span>val tree v<span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #000000">(empty</span></span> <span style="color: #990000">[</span>self<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(RedBlackTree</span></span><span style="color: #990000">.</span> nil<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(equiv</span></span> <span style="color: #990000">[</span>self o<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(instance</span></span><span style="color: #990000">?</span> RedBlackTree o<span style="color: #990000">)</span>
                    <span style="color: #990000">(=</span> tree <span style="color: #990000">(.</span>tree o<span style="color: #990000">))</span>
                    false<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(if</span></span> tree <span style="font-weight: bold"><span style="color: #000000">(rb</span></span><span style="color: #990000">-</span>tree<span style="color: #990000">-&gt;</span>seq tree<span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">[</span>this n<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(find</span></span><span style="color: #990000">-</span>val tree n<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(contains</span></span> <span style="color: #990000">[</span>this n<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(boolean</span></span> <span style="font-weight: bold"><span style="color: #000000">(get</span></span> this n<span style="color: #990000">)))</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; (disjoin [this n] ...) ;; Omitted due to complexity</span></span>
  clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>IFn
  <span style="font-weight: bold"><span style="color: #000000">(invoke</span></span> <span style="color: #990000">[</span>this n<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(get</span></span> this n<span style="color: #990000">))</span>
  Object
  <span style="font-weight: bold"><span style="color: #000000">(toString</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str this<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> print<span style="color: #990000">-</span>method RedBlackTree <span style="color: #990000">[</span>o <span style="color: #990000">^</span>java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>Writer w<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>write w <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"#rbt "</span> <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str <span style="color: #990000">(.</span>tree o<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><span class="monospaced">disjoin</span> and the corresponding <span class="monospaced">remove-val</span> functions are left as
exercises for the reader.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is now possible to use a <span class="monospaced">RedBlackTree</span> instance like any other
collection&#8212;in particular, instances act like sets:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">(-&gt;</span>RedBlackTree nil<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">2</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #rbt [:black nil 0 [:red nil 1 nil]]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> to<span style="color: #990000">-</span>ten <span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">(-&gt;</span>RedBlackTree nil<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">10</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(seq</span></span> to<span style="color: #990000">-</span>ten<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (3 1 0 2 5 4 7 6 8 9)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span> to<span style="color: #990000">-</span>ten <span style="color: #993399">9</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 9</span></span>

<span style="font-weight: bold"><span style="color: #000000">(contains</span></span><span style="color: #990000">?</span> to<span style="color: #990000">-</span>ten <span style="color: #993399">9</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(to</span></span><span style="color: #990000">-</span>ten <span style="color: #993399">9</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 9</span></span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span> inc to<span style="color: #990000">-</span>ten<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (4 2 1 3 6 5 8 7 9 10)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_64">Discussion</h4>
<div class="paragraph"><p>In the end, it doesn&#8217;t take a lot to participate in the sequence
abstraction. By implementing a small handful of interface functions, the
red-black tree implementation from <a href="#sec_red_black_part_i">[sec_red_black_part_i]</a>, can
participate in an array of sequence-oriented functions: <span class="monospaced">map</span>,
<span class="monospaced">filter</span>, <span class="monospaced">reduce</span>, you name it.</p></div>
<div class="paragraph"><p>At its essence, <span class="monospaced">clojure.lang.IPersistentSet</span> is an abstraction of what it
means to represent a mathematical set structure; this matches a tree data
structure well. A set isn&#8217;t a list or sequence, though. So how is <span class="monospaced">RedBlackTree</span>
then said to be participating in the sequence abstraction?</p></div>
<div class="paragraph"><p>In Clojure, types extending the <span class="monospaced">clojure.lang.ISeq</span> interface are true
<em>sequences</em>, represented as a logical list of head and tail. While
<span class="monospaced">IPersistentSet</span> does not inherit from <span class="monospaced">ISeq</span>, it does share a common
ancestry with it. Both interfaces extend
<span class="monospaced">clojure.lang.IPersistentCollection</span> and its parent
<span class="monospaced">clojure.lang.Seqable</span>. As luck would have it,<span class="footnote"><br>[Actually, as
design would have it.]<br></span> sequence functions rely on collections being
<span class="monospaced">Seqable</span>, not <span class="monospaced">ISeq</span>. Since <span class="monospaced">RedBlackTree</span> can be read as a
sequence, it is <span class="monospaced">Seqable</span> and can be operated on by all of the
sequence functions you know and love.</p></div>
<div class="paragraph"><p>Most of the functions in the <span class="monospaced">IPersistentSet</span> interface are self-explanatory, but some deserve further explanation. The function <span class="monospaced">cons</span>
is a historical name for constructing a new list by appending a value
to an existing list. <span class="monospaced">seq</span> is intended to produce a sequence from a
collection, or <span class="monospaced">nil</span> if empty:</p></div>
<div class="listingblock">
<div class="title"><em>IPersistentSet.java</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IPersistentSet</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> IPersistentCollection<span style="color: #990000">,</span> Counted <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">IPersistentSet</span> <span style="font-weight: bold"><span style="color: #000000">disjoin</span></span><span style="color: #990000">(</span><span style="color: #008080">Object</span> key<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">boolean</span> <span style="font-weight: bold"><span style="color: #000000">contains</span></span><span style="color: #990000">(</span><span style="color: #008080">Object</span> key<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">Object</span> <span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #008080">Object</span> key<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><em>IPersistentCollection.java</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IPersistentCollection</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Seqable <span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">count</span></span><span style="color: #990000">();</span>
  <span style="color: #008080">IPersistentCollection</span> <span style="font-weight: bold"><span style="color: #000000">cons</span></span><span style="color: #990000">(</span><span style="color: #008080">Object</span> o<span style="color: #990000">);</span>
  <span style="color: #008080">IPersistentCollection</span> <span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">();</span>
  <span style="color: #009900">boolean</span> <span style="font-weight: bold"><span style="color: #000000">equiv</span></span><span style="color: #990000">(</span><span style="color: #008080">Object</span> o<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><em>Seqable.java</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">Seqable</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">ISeq</span> <span style="font-weight: bold"><span style="color: #000000">seq</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The most challenging part of any <span class="monospaced">Seqable</span> implementation is actually
making a sequence out of the underlying data structure. This would be
particularly challenging if you needed to write your own lazy
tree-traversal algorithms, but luckily Clojure has a built-in function,
<span class="monospaced">tree-seq</span>, that does precisely this. By leveraging <span class="monospaced">tree-seq</span> to
produce a sequence of nodes, it is trivial to write an <span class="monospaced">rb-tree-&gt;seq</span> conversion function that lazily traverses a <span class="monospaced">RedBlackTree</span>, yielding
node values as it goes.</p></div>
<div class="paragraph"><p><span class="monospaced">tree-seq</span> accepts three arguments:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">branch?</span>
</dt>
<dd>
<p>
A conditional that returns <span class="monospaced">true</span> if a node is a branch (not a leaf node). For <span class="monospaced">RedBlackTree</span>, <span class="monospaced">sequential?</span> is an adequate check, as every node is a vector.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">children</span>
</dt>
<dd>
<p>
A function that returns all of the children for a given node.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">root</span>
</dt>
<dd>
<p>
The node to begin traversal on.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><span class="monospaced">tree-seq</span> performs a depth-first traversal of trees. Given how
red-black trees are represented, this will <em>not</em> be an ordered
traversal.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>With a sequence conversion function in hand, it is easy enough to
write the <span class="monospaced">seq</span> function. Similarly, <span class="monospaced">cons</span> and <span class="monospaced">empty</span> are a breeze&#8212;simply utilize the existing tree functions. Equality testing can be a
bit more difficult, however.</p></div>
<div class="paragraph"><p>For the sake of simplicity, we chose to implement equality (<span class="monospaced">equiv</span>)
between <em>only</em> <span class="monospaced">RedBlackTree</span> instances. Further, the implementation
compares a sorted sequence of their elements. In this case, <span class="monospaced">equiv</span> is
answering the question, "Do these trees have the same values?" and not
the question, "Are these the same trees?" It&#8217;s an important
distinction, one you&#8217;ll need to consider carefully when implementing
your own data structures.</p></div>
<div class="paragraph"><p>As discussed in <a href="#sec_test_collection_with_set">[sec_test_collection_with_set]</a>, one of the big
bonuses of sets is their ability to be invoked just like any other
function. It&#8217;s easy enough to provide this ability to
<span class="monospaced">RedBlackTree</span>s too. By implementing the single-arity <span class="monospaced">invoke</span>
function of the <span class="monospaced">clojure.lang.IFn</span> interface, <span class="monospaced">RedBlackTree</span>s can be
invoked like any other function (or set, for that matter):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(some</span></span> <span style="font-weight: bold"><span style="color: #000000">(rbt</span></span> <span style="color: #990000">[</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span><span style="color: #990000">])</span> <span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(rbt</span></span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">10</span><span style="color: #990000">))</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3</span></span></tt></pre></div></div>
<div class="paragraph"><p>Even with the full <span class="monospaced">IPersistentSet</span> interface implemented, there are
still a number of conveniences <span class="monospaced">RedBlackTree</span> is lacking. For one, you
need to use the kludgy <span class="monospaced">/&#8594;RedBlackTree</span> or <span class="monospaced">RedBlackTree.</span> functions
to create a new <span class="monospaced">RedBlackTree</span> and add values to it manually. By
convention, many built-in collections provide convenience functions
for populating them (aside from literal tags like <span class="monospaced">[]</span> or <span class="monospaced">{}</span>, of
course).</p></div>
<div class="paragraph"><p>It&#8217;s easy enough to mirror <span class="monospaced">vec</span> and <span class="monospaced">vector</span> for <span class="monospaced">RedBlackTree</span>s:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> rbt
 <span style="color: #FF0000">"Create a new RedBlackTree with the contents of coll."</span>
 <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
 <span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">(-&gt;</span>RedBlackTree nil<span style="color: #990000">)</span> coll<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> red<span style="color: #990000">-</span>black<span style="color: #990000">-</span>tree
  <span style="color: #FF0000">"Creates a new RedBlackTree containing the args."</span>
  <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(rbt</span></span> args<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(rbt</span></span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #rbt [:black [:black nil 0 nil] 1 [:black nil 2 nil]]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(red</span></span><span style="color: #990000">-</span>black<span style="color: #990000">-</span>tree <span style="color: #993399">7</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #rbt [:black nil 7 [:red nil 42 nil]]</span></span></tt></pre></div></div>
<div class="paragraph"><p>You may also have noticed printing is not a concern of the sequence
abstraction, although it is certainly an important consideration to
make for developing developer- and machine-friendly data structures.
There are two types of printing in Clojure: <span class="monospaced">toString</span> and <span class="monospaced">pr</span>-based
printing. The <span class="monospaced">toString</span> function is intended for printing
human-readable values at the REPL, while the <span class="monospaced">pr</span> family of functions
are meant (more or less) to be readable by the Clojure reader.</p></div>
<div class="paragraph"><p>To provide our own readable representation of RBT, we must implement
<span class="monospaced">print-method</span> (the heart of <span class="monospaced">pr</span>) for the <span class="monospaced">RedBlackTree</span> type. By
writing in a "tagged literal" format (e.g., <span class="monospaced">#rbt</span>), it is possible to
configure the reader to ingest and hydrate written values as
first-class objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Recall ...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> print<span style="color: #990000">-</span>method RedBlackTree <span style="color: #990000">[</span>o <span style="color: #990000">^</span>java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>Writer w<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>write w <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"#rbt "</span> <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str <span style="color: #990000">(.</span>tree o<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> rbt<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str <span style="font-weight: bold"><span style="color: #000000">(rbt</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span><span style="color: #990000">])))</span>
rbt<span style="color: #990000">-</span>string
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "#rbt [:black [:black nil 1 nil] 2 [:black nil 4 nil]]"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string rbt<span style="color: #990000">-</span>string<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; RuntimeException No reader function for tag rbt ...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string {<span style="color: #990000">:</span>readers {'rbt <span style="color: #990000">-&gt;</span>RedBlackTree}}
                 rbt<span style="color: #990000">-</span>string<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #rbt [:black [:black nil 1 nil] 2 [:black nil 4 nil]]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_64">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The first part of this recipe, <a href="#sec_red_black_part_i">[sec_red_black_part_i]</a>, where we define the initial
  red-black tree implementation
</p>
</li>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>, and
  <a href="#sec_default_data_reader">[sec_default_data_reader]</a>, for more information on reading Clojure
  data
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_general_computing">General Computing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_3">Introduction</h3>
<div class="paragraph"><p>There&#8217;s a saying in business that no organization operates in a
vacuum. The same applies to Clojure. For all the cool tools and
techniques Clojure offers, there are still a number of activities and
techniques that for whatever reason aren&#8217;t always on the direct path
to shipping software. Some might call them academic, or incidental
complexity, but for the time being, we call them life.</p></div>
<div class="paragraph"><p>This chapter covers some of the topics about Clojure development that
don&#8217;t quite fill chapters on their own. Topics like:</p></div>
<div class="ulist"><ul>
<li>
<p>
How do I use Clojure&#8217;s development ecosystem?
</p>
</li>
<li>
<p>
How do abstract concepts (such as polymorphism) apply to Clojure?
</p>
</li>
<li>
<p>
What is logic programming, and when might I want to use it?
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_running_a_minimal_clojure_repl">Running a Minimal Clojure REPL</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_65">Problem</h4>
<div class="paragraph"><p>You want to play with a Clojure REPL but you don&#8217;t want to install
additional tools.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_65">Solution</h4>
<div class="paragraph"><p>Obtain the Clojure Java archive (JAR) file by downloading and unzipping a release
from <a href="http://clojure.org/downloads">http://clojure.org/downloads</a>. Using a terminal, navigate to
where you extracted the JAR, and start a Clojure REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -cp <span style="color: #FF0000">"clojure-1.5.1.jar"</span> clojure<span style="color: #990000">.</span>main</tt></pre></div></div>
<div class="paragraph"><p>You are now running an interactive Clojure REPL (read-eval-print
loop). Type an expression and hit Enter to evaluate it. Press
Ctrl-D to exit.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_65">Discussion</h4>
<div class="paragraph"><p>The fact that Clojure on the JVM is encapsulated in a simple JAR file
has some great benefits. For one, it means that Clojure is never
really installed. It&#8217;s just a dependency, like any other Java
library. You can easily swap out one version of Clojure for another by
replacing a single file.</p></div>
<div class="paragraph"><p>Let&#8217;s dissect the <span class="monospaced">java</span> invocation here a bit. First, we set the Java classpath to include  Clojure (and only Clojure, in this example):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-cp "clojure-1.5.1.jar"</pre>
</div></div>
<div class="paragraph"><p>A full explanation of the classpath is beyond the scope
of this recipe, but suffice it to say that it is a list of places where Java
should look to load classes. A full discussion of classpaths on the
JVM can be found at <a href="http://bit.ly/docs-classpaths">http://bit.ly/docs-classpaths</a>. In the final part of the invocation, we specify the class that Java should load and execute the <span class="monospaced">main</span> method:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>clojure.main</pre>
</div></div>
<div class="paragraph"><p>Yes, <span class="monospaced">clojure.main</span> is really a Java class. The
reason this doesn&#8217;t <em>look</em> like a typical Java invocation is because
Clojure namespaces, which are compiled to classes, do not
conventionally use capitalized names like Java classes do.</p></div>
<div class="paragraph"><p>This is the absolute bare-minimum Clojure environment and is all you
need to run Clojure code on any system with Java installed. Of course,
for regular use and development, you will most certainly want a more
feature-rich solution like Leiningen.</p></div>
<div class="paragraph"><p>In some cases, however, hand-tuning a Java invocation may be the best
way to integrate Clojure into your environment. This is particularly
useful on servers where deploying a simple JAR file is trivial
compared to installing more complex packages.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_65">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://leiningen.org/">Leiningen</a> website
</p>
</li>
<li>
<p>
<a href="#sec_command_line_applications">[sec_command_line_applications]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_interactive_docs">Interactive Documentation</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_66">Problem</h4>
<div class="paragraph"><p>From a REPL, you want to read documentation for a function.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_66">Solution</h4>
<div class="paragraph"><p>Print the documentation for a function at the REPL with the <span class="monospaced">doc</span> macro:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>doc conj<span style="color: #990000">)</span>
 <span style="color: #990000">-------------------------</span>
clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>conj
<span style="color: #990000">([</span>coll x<span style="color: #990000">]</span> <span style="color: #990000">[</span>coll x <span style="color: #990000">&amp;</span> xs<span style="color: #990000">])</span>
  conj<span style="color: #990000">[</span>oin<span style="color: #990000">].</span> Returns a new collection with the xs
    'added'<span style="color: #990000">.</span> <span style="color: #990000">(</span>conj nil item<span style="color: #990000">)</span> returns <span style="color: #990000">(</span>item<span style="color: #990000">).</span>  The 'addition' may
    happen at different 'places' depending on the concrete type<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Print the source code for a function at the REPL with the <span class="monospaced">source</span> macro:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>source reverse<span style="color: #990000">)</span>
<span style="color: #990000">(</span>defn reverse
  "Returns a seq of the items in coll in reverse order<span style="color: #990000">.</span> Not lazy<span style="color: #990000">.</span>"
  <span style="color: #FF0000">{</span><span style="color: #990000">:</span>added "<span style="color: #993399">1.0</span>"
   <span style="color: #990000">:</span>static true<span style="color: #FF0000">}</span>
  <span style="color: #990000">[</span>coll<span style="color: #990000">]</span>
    <span style="color: #990000">(</span>reduce1 conj <span style="color: #990000">()</span> coll<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Find functions with documentation matching a given regular expression using <span class="monospaced">find-doc</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>find<span style="color: #990000">-</span>doc #"defmacro"<span style="color: #990000">)</span>
 <span style="color: #990000">-------------------------</span>
clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>definline
<span style="color: #990000">([</span>name <span style="color: #990000">&amp;</span> decl<span style="color: #990000">])</span>
Macro
  Experimental <span style="color: #990000">-</span> like defmacro<span style="color: #990000">,</span> except defines a named function whose
  body is the expansion<span style="color: #990000">,</span> calls to which may be expanded inline as if
  it were a macro<span style="color: #990000">.</span> Cannot be used with variadic <span style="color: #990000">(&amp;)</span> args<span style="color: #990000">.</span>
 <span style="color: #990000">-------------------------</span>
clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>defmacro
<span style="color: #990000">([</span>name doc<span style="color: #990000">-</span>string<span style="color: #990000">?</span> attr<span style="color: #990000">-</span>map<span style="color: #990000">?</span> <span style="color: #990000">[</span>params<span style="color: #990000">*]</span> body<span style="color: #990000">]</span>
 <span style="color: #990000">[</span>name doc<span style="color: #990000">-</span>string<span style="color: #990000">?</span> attr<span style="color: #990000">-</span>map<span style="color: #990000">?</span> <span style="color: #990000">([</span>params<span style="color: #990000">*]</span> body<span style="color: #990000">)</span> <span style="color: #990000">+</span> attr<span style="color: #990000">-</span>map<span style="color: #990000">?])</span>
Macro
  Like defn<span style="color: #990000">,</span> but the resulting function name is declared as a
  macro and will be used as a macro by the compiler when it is
  called<span style="color: #990000">.</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_66">Discussion</h4>
<div class="paragraph"><p>Clojure supports inline documentation of functions (more about that
later), along with other metadata, which allows you to introspect
things like documentation any time you want. The <span class="monospaced">doc</span> and <span class="monospaced">source</span>
macros are just convenience functions for the REPL.</p></div>
<div class="paragraph"><p>You can peek under the hood at almost everything in Clojure at any
time. The next example may be a bit mind-expanding if you&#8217;re not used
to this level of introspection at runtime:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>source source<span style="color: #990000">)</span>
<span style="color: #990000">(</span>defmacro source
  "Prints the source code for the given symbol<span style="color: #990000">,</span> if it can find it<span style="color: #990000">.</span>
  This requires that the symbol resolve to a Var defined in a
  namespace for which the <span style="color: #990000">.</span>clj is in the classpath<span style="color: #990000">.</span>

  Example<span style="color: #990000">:</span> <span style="color: #990000">(</span>source filter<span style="color: #990000">)</span>"
  <span style="color: #990000">[</span>n<span style="color: #990000">]</span>
  `<span style="color: #990000">(</span>println <span style="color: #990000">(</span>or <span style="color: #990000">(</span>source<span style="color: #990000">-</span>fn '<span style="color: #990000">~</span>n<span style="color: #990000">)</span> <span style="color: #990000">(</span>str "Source not found"<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>Keeping in mind that <span class="monospaced">source</span> was defined in the <span class="monospaced">clojure.repl</span>
namespace, we can peek at how exactly it retrieves the source by
evaluating <span class="monospaced">(source clojure.repl/source-fn)</span>.</p></div>
<div class="paragraph"><p>In most REPL implementations, <span class="monospaced">clojure.repl</span> macros like <span class="monospaced">source</span> and <span class="monospaced">doc</span> are
only referred into the <span class="monospaced">user</span> namespace. This means as soon as you switch into
another namespace, the unqualified <span class="monospaced">clojure.repl</span> macros will no longer be
available.  You can get around this by namespacing the macros
(<span class="monospaced">clojure.repl/doc</span> instead of <span class="monospaced">doc</span>,) or, for extended use, by <literal>use</literal>-ing the
namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>ns foo<span style="color: #990000">)</span>
foo<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>doc <span style="color: #990000">+)</span>
CompilerException java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>RuntimeException<span style="color: #990000">:</span> Unable to resolve symbol<span style="color: #990000">:</span> doc
in this context<span style="color: #990000">,</span> compiling<span style="color: #990000">:(</span>NO_SOURCE_PATH<span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">)</span>

foo<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>use 'clojure<span style="color: #990000">.</span>repl<span style="color: #990000">)</span>
nil

foo<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>doc <span style="color: #990000">+)</span>
 <span style="color: #990000">-------------------------</span>
clojure<span style="color: #990000">.</span>core<span style="color: #990000">/+</span>
<span style="color: #990000">([]</span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="color: #990000">[</span>x y<span style="color: #990000">]</span> <span style="color: #990000">[</span>x y <span style="color: #990000">&amp;</span> more<span style="color: #990000">])</span>
  Returns the sum of nums<span style="color: #990000">.</span> <span style="color: #990000">(+)</span> returns <span style="color: #993399">0</span><span style="color: #990000">.</span> Does not auto<span style="color: #990000">-</span>promote
  longs<span style="color: #990000">,</span> will throw on overflow<span style="color: #990000">.</span> See also<span style="color: #990000">:</span> <span style="color: #990000">+</span>'</tt></pre></div></div>
<div class="paragraph"><p>Exploring Clojure in this way is a great way to learn about core
functions and advanced Clojure programming techniques. The
<span class="monospaced">clojure.core</span> namespace is chock-full of high-quality and
high-performance code at your fingertips.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_66">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.repl</span> <a href="http://bit.ly/clj-repl-doc">API documentation</a>
</p>
</li>
<li>
<p>
<a href="#sec_exploring_namespaces">[sec_exploring_namespaces]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_exploring_namespaces">Exploring Namespaces</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_67">Problem</h4>
<div class="paragraph"><p>You want to know what namespaces are loaded and what public vars are available inside them.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_67">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">loaded-libs</span> to obtain the set of currently loaded namespaces. For example, from a REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>pprint <span style="color: #990000">(</span>loaded<span style="color: #990000">-</span>libs<span style="color: #990000">))</span>
#<span style="color: #FF0000">{</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>protocols clojure<span style="color: #990000">.</span>instant clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>browse
  clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>javadoc clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>shell clojure<span style="color: #990000">.</span>main
  clojure<span style="color: #990000">.</span>pprint clojure<span style="color: #990000">.</span>repl clojure<span style="color: #990000">.</span>string clojure<span style="color: #990000">.</span>uuid clojure<span style="color: #990000">.</span>walk<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">dir</span> from a REPL to print the public vars in a namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>dir clojure<span style="color: #990000">.</span>instant<span style="color: #990000">)</span>
parse<span style="color: #990000">-</span>timestamp
read<span style="color: #990000">-</span>instant<span style="color: #990000">-</span>calendar
read<span style="color: #990000">-</span>instant<span style="color: #990000">-</span>date
read<span style="color: #990000">-</span>instant<span style="color: #990000">-</span>timestamp
validated</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">ns-publics</span> to obtain a mapping of symbols to public vars in a namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span><span style="color: #990000">-</span>publics 'clojure<span style="color: #990000">.</span>instant<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {read-instant-calendar #'clojure.instant/read-instant-calendar,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     read-instant-timestamp #'clojure.instant/read-instant-timestamp,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     validated #'clojure.instant/validated,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     read-instant-date #'clojure.instant/read-instant-date,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     parse-timestamp #'clojure.instant/parse-timestamp}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_67">Discussion</h4>
<div class="paragraph"><p>Namespaces in Clojure are dynamic mappings of symbols to vars. A
namespace is not available until it is required by something else;
for example, when starting a REPL or as a dependency in an <span class="monospaced">ns</span>
declaration. Nothing is known about available Clojure libraries and
namespaces until runtime, which is in contrast to typical Java
development (where most everything about a package is known at compile
time).</p></div>
<div class="paragraph"><p>The downside of this dynamic nature is that you need to at least know
which namespaces to load in order to explore them.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_67">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.repl</span> <a href="http://bit.ly/clj-repl-doc">API documentation</a>
</p>
</li>
<li>
<p>
<a href="#sec_interactive_docs">[sec_interactive_docs]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_try_library">Trying a Library Without Explicit Dependencies</h3>
<div class="paragraph byline"><p>by Mark Whelan</p></div>
<div class="sect3">
<h4 id="_problem_68">Problem</h4>
<div class="paragraph"><p>You want to try a library in the REPL without having to modify your
project&#8217;s dependencies or create a new project.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_68">Solution</h4>
<div class="paragraph"><p>Use Ryan Neufeld&#8217;s <span class="monospaced">lein-try</span> to launch the REPL. Library dependencies
will be met automatically.</p></div>
<div class="paragraph"><p>To gain this capability, first make sure you are using Leiningen 2.1.3 or later. Then edit your <em>~/.lein/profiles.clj</em> file, adding <span class="monospaced">[lein-try "0.4.1"]</span>
to the <span class="monospaced">:plugins</span> vector of the <span class="monospaced">:user</span> profile:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>user {<span style="color: #990000">:</span>plugins <span style="color: #990000">[[</span>lein<span style="color: #990000">-</span>try <span style="color: #FF0000">"0.4.1"</span><span style="color: #990000">]]</span>}}</tt></pre></div></div>
<div class="paragraph"><p>Now you can experience nearly instant gratification with the library
of your choice:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time
Retrieving clj-time/clj-time<span style="color: #990000">/</span><span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span>/clj-time-<span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">.</span>pom from clojars
Retrieving clj-time/clj-time<span style="color: #990000">/</span><span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span>/clj-time-<span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">.</span>jar from clojars
nREPL server started on port <span style="color: #993399">58981</span> on host <span style="color: #993399">127.0</span><span style="color: #990000">.</span><span style="color: #993399">0.1</span>
REPL-y <span style="color: #993399">0.2</span><span style="color: #990000">.</span><span style="color: #993399">1</span>
Clojure <span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span>
    Docs<span style="color: #990000">:</span> <span style="color: #990000">(</span>doc function-name-here<span style="color: #990000">)</span>
          <span style="color: #990000">(</span>find-doc <span style="color: #FF0000">"part-of-name-here"</span><span style="color: #990000">)</span>
  Source<span style="color: #990000">:</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">source</span></span> function-name-here<span style="color: #990000">)</span>
 Javadoc<span style="color: #990000">:</span> <span style="color: #990000">(</span>javadoc java-object-or-class-here<span style="color: #990000">)</span>
    Exit<span style="color: #990000">:</span> Control<span style="color: #990000">+</span>D or <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">exit</span></span><span style="color: #990000">)</span> or <span style="color: #990000">(</span>quit<span style="color: #990000">)</span>

<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_68">Discussion</h4>
<div class="paragraph"><p>Notice that we did not have to give a version number for the library
in the example. <span class="monospaced">lein-try</span> will automatically grab the most recent
released version.</p></div>
<div class="paragraph"><p>Of course, you can specify a library version if you like. Just add the
version number after the library name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-time <span style="color: #993399">0.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span>
<span style="font-style: italic"><span style="color: #9A1900">#...</span></span>
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>For a quick view of usage options, invoke <strong><span class="monospaced">lein help try</span></strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein <span style="font-weight: bold"><span style="color: #0000FF">help</span></span> try
Launch REPL with specified dependencies available<span style="color: #990000">.</span>

  Usage<span style="color: #990000">:</span>

    lein try <span style="color: #990000">[</span>io<span style="color: #990000">.</span>rkn/conformity <span style="color: #FF0000">"0.2.1"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span>com<span style="color: #990000">.</span>datomic/datomic-free <span style="color: #FF0000">"0.8.4020.26"</span><span style="color: #990000">]</span>
    lein try io<span style="color: #990000">.</span>rkn/conformity <span style="color: #993399">0.2</span><span style="color: #990000">.</span><span style="color: #993399">1</span>
    lein try io<span style="color: #990000">.</span>rkn/conformity <span style="font-style: italic"><span style="color: #9A1900"># This uses the most recent version</span></span>

  NOTE<span style="color: #990000">:</span> lein-try does not require <span style="color: #990000">[]</span>

Arguments<span style="color: #990000">:</span> <span style="color: #990000">([&amp;</span> args<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>As befits a Clojure tool, <span class="monospaced">lein-try</span> is an elegant way to make a task
less laborious. Use it to summon powerful libraries from the Net at
your whim, without having to set them up, and enjoy a wizardly
satisfaction from the sudden confluence of new abilities.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_68">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The official list of Leiningen <a href="http://bit.ly/lein-plugins">plug-ins</a>
</p>
</li>
<li>
<p>
<a href="#sec_lein_try">[sec_lein_try]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_running_programs">Running Clojure Programs</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_69">Problem</h4>
<div class="paragraph"><p>You want to run a program with a single entry point from Clojure
source code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_69">Solution</h4>
<div class="paragraph"><p>Run a file full of Clojure expressions by passing the filename as an
argument to <span class="monospaced">clojure.main</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>To follow along with this recipe, you can download a version of
<em>clojure.jar</em> at <a href="http://clojure.org/downloads">http://clojure.org/downloads</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For example, given a file <em>my_clojure_program.clj</em> with the contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Hi."</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>invoke the <span class="monospaced">java</span> command with <em>my_clojure_program.clj</em> as the final argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -cp clojure<span style="color: #990000">.</span>jar clojure<span style="color: #990000">.</span>main my_clojure_program<span style="color: #990000">.</span>clj
Hi<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>In a more structured project, you&#8217;ll probably have files organized in a <em>src/</em> folder. For example, given a file <em>src/com/example/my_program.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>my<span style="color: #990000">-</span>program<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Hey!"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>to load and run the <span class="monospaced">-main</span> function, specify the desired namespace
with the <span class="monospaced">-m</span>/<span class="monospaced">--main</span> option and add <em>src</em> to the classpath list (via
<span class="monospaced">-cp</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -cp clojure<span style="color: #990000">.</span>jar<span style="color: #990000">:</span>src clojure<span style="color: #990000">.</span>main --main com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>my-program
Hey<span style="color: #990000">!</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_69">Discussion</h4>
<div class="paragraph"><p>Although you will spend most of your time evaluating Clojure code in a
REPL, it is sometimes useful to be able to either run a simple "script" full of
Clojure expressions or run a more structured Clojure application
with a <span class="monospaced">-main</span> entry point.</p></div>
<div class="paragraph"><p>In either case, you have access to any extra command-line arguments
passed after the script name or the main namespace name.</p></div>
<div class="paragraph"><p>For example, let&#8217;s say you have written the following program, in a
file called <em>hello.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> greet
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Hello, "</span> name <span style="color: #FF0000">"!"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>name <span style="color: #990000">*</span>command<span style="color: #990000">-</span>line<span style="color: #990000">-</span>args<span style="color: #990000">*]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(greet</span></span> name<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Invoking this Clojure program directly will yield predictable output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -cp clojure<span style="color: #990000">.</span>jar clojure<span style="color: #990000">.</span>main hello<span style="color: #990000">.</span>clj Alice Bob
Hello<span style="color: #990000">,</span> Alice<span style="color: #990000">!</span>
Hello<span style="color: #990000">,</span> Bob<span style="color: #990000">!</span></tt></pre></div></div>
<div class="paragraph"><p>This simple script has the side effect of printing output when it is
loaded. Most Clojure code is not organized this way.</p></div>
<div class="paragraph"><p>As you will typically want to keep your code in well-organized
namespaces, you can provide an entry point through a namespace with a
<span class="monospaced">-main</span> function. This allows you to avoid side effects while loading,
and you can even tweak and invoke your <span class="monospaced">-main</span> function from the REPL
just like any other function during interactive development.</p></div>
<div class="paragraph"><p>Let&#8217;s say you&#8217;ve moved your <span class="monospaced">greet</span> function into a <span class="monospaced">foo.util</span>
namespace, and your project is structured something like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>./src/foo/util.clj
./src/foo.clj</pre>
</div></div>
<div class="paragraph"><p>Your <span class="monospaced">foo</span> namespace requires the <span class="monospaced">foo.util</span> namespace and
provides a <span class="monospaced">-main</span> function, like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> foo
  <span style="color: #990000">(:</span>require foo<span style="color: #990000">.</span>util<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main
  <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>name args<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(foo</span></span><span style="color: #990000">.</span>util<span style="color: #990000">/</span>greet name<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>When you invoke Clojure with <span class="monospaced">foo</span> as the "main" namespace, it
calls the <span class="monospaced">-main</span> function with the provided command-line arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -cp clojure<span style="color: #990000">.</span>jar<span style="color: #990000">:</span>src clojure<span style="color: #990000">.</span>main --main foo Alice Bob
Hello<span style="color: #990000">,</span> Alice<span style="color: #990000">!</span>
Hello<span style="color: #990000">,</span> Bob<span style="color: #990000">!</span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll also note the addition of <span class="monospaced">:src</span> to the <span class="monospaced">-cp</span> option. This
indicates to Java that the classpath for execution not only includes
<em>clojure.jar</em>, but also the contents of the <em>src/</em> directory on disk.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_69">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_command_line_applications">[sec_command_line_applications]</a>, to learn how to run Leiningen projects
  from the command line
</p>
</li>
<li>
<p>
<a href="#sec_parse_command_line_arguments">[sec_parse_command_line_arguments]</a>, to learn how to cleanly
  expose multiple options and flags in your command-line
  applications
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_command_line_applications">Running Programs from the Command Line</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_70">Problem</h4>
<div class="paragraph"><p>You want to invoke your Clojure application from the command line.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_70">Solution</h4>
<div class="paragraph"><p>In any Leiningen project, use the <strong><span class="monospaced">lein run</span></strong> command to invoke your
application from the command line. To follow along with this recipe, create a new Leiningen project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new my-cli</tt></pre></div></div>
<div class="paragraph"><p>Configure which namespace will be the entry point to your application
by adding a <span class="monospaced">:main</span> key to the project&#8217;s <em>project.clj</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> my<span style="color: #990000">-</span>cli <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]]</span>
  <span style="color: #990000">:</span>main my<span style="color: #990000">-</span>cli<span style="color: #990000">.</span>core<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, add a <span class="monospaced">-main</span> function to the namespace configured in
<em>project.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> my<span style="color: #990000">-</span>cli<span style="color: #990000">.</span>core<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"My CLI received arguments:"</span> args<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Now, invoke <strong><span class="monospaced">lein run</span></strong> to run your application:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run
My CLI received arguments<span style="color: #990000">:</span> nil

$ lein run <span style="color: #993399">1</span> <span style="color: #990000">:</span>foo <span style="color: #FF0000">"bar"</span>
My CLI received arguments<span style="color: #990000">:</span> <span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">:</span>foo bar<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_70">Discussion</h4>
<div class="paragraph"><p>As it turns out, invoking your application from the command line
couldn&#8217;t be easier. Leiningen&#8217;s <span class="monospaced">run</span> command quickly and easily
connects your application to the command line with little fuss. In its base form, <span class="monospaced">lein run</span> will invoke the <span class="monospaced">-main</span> function of
whatever namespace you have specified as <span class="monospaced">:main</span> in your project&#8217;s
<em>project.clj</em> file. For example, setting <span class="monospaced">:main my-cli.core</span> will
invoke <span class="monospaced">my-cli.core/-main</span>. Alternatively, you may omit implementing
<span class="monospaced">-main</span> and provide <span class="monospaced">:main</span> with the fully qualified name of a
function (e.g., <span class="monospaced">my-cli.core/alt-main</span>); this function will be invoked
instead of <span class="monospaced">-main</span>.</p></div>
<div class="paragraph"><p>While the printed arguments in the preceding solution <em>look</em> like Clojure
data, they are in fact regular strings. For simple arguments, you may
choose to parse these strings yourself; otherwise, we suggest using the
<a href="https://github.com/clojure/tools.cli"><span class="monospaced">tools.cli</span></a> library. See
<a href="#sec_parse_command_line_arguments">[sec_parse_command_line_arguments]</a>, for more information on
<span class="monospaced">tools.cli</span>.</p></div>
<div class="paragraph"><p>Although a project can only have one default <span class="monospaced">:main</span> entry point, you
can invoke other functions from the command line by setting the <span class="monospaced">-m</span>
option to a namespace or function. If you set <span class="monospaced">-m</span> to a namespace
(e.g., <span class="monospaced">my-cli.core</span>), the <span class="monospaced">-main</span> function of that namespace will be
invoked. If you provide <span class="monospaced">-m</span> with the fully qualified name of a function
(e.g., <span class="monospaced">my-cli.core/alt-main</span>), that function will be invoked. There&#8217;s
no requirement that this function be prefixed with a <span class="monospaced">-</span> (indicating it is
a Java method); it simply must accept a variable number of arguments
(as <span class="monospaced">-main</span> normally does).</p></div>
<div class="paragraph"><p>For example, you can add a function <span class="monospaced">add-main</span> to <span class="monospaced">my-cli.core</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> my<span style="color: #990000">-</span>cli<span style="color: #990000">.</span>core<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"My CLI received arguments:"</span> args<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add<span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>parseInt <span style="color: #990000">%)</span> args<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"The sum is:"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>then invoke it from the command line with the command <strong><span class="monospaced">lein run -m
my-cli.core/add-main</span></strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run -m my-cli<span style="color: #990000">.</span>core/add-main <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span>
The sum is<span style="color: #990000">:</span> <span style="color: #993399">6</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_70">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_running_programs">[sec_running_programs]</a>, to learn how to run plain Clojure files with <strong><span class="monospaced">java</span></strong>
</p>
</li>
<li>
<p>
<a href="#sec_parse_command_line_arguments">[sec_parse_command_line_arguments]</a>, to learn how to parse
  command-line arguments using <span class="monospaced">tools.cli</span>
</p>
</li>
<li>
<p>
<a href="#sec_packaging_jars">[sec_packaging_jars]</a>, to learn how to package an application as an
  executable JAR
</p>
</li>
<li>
<p>
<a href="#sec_daemons">[sec_daemons]</a>, to learn how to daemonize applications
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_parse_command_line_arguments">Parsing Command-Line Arguments</h3>
<div class="paragraph byline"><p>by Ryan Neufeld; originally submitted by Nicolas Bessi</p></div>
<div class="sect3">
<h4 id="_problem_71">Problem</h4>
<div class="paragraph"><p>You want to write command-line tools in Clojure that can parse input
arguments.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_71">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/clojure/tools.cli"><span class="monospaced">tools.cli</span></a>
library.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojure/tools.cli "0.2.4"]</span> to your project&#8217;s
dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/tools<span style="color: #990000">.</span>cli</tt></pre></div></div>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.tools.cli/cli</span> function in your project&#8217;s <span class="monospaced">-main</span>
function entry point to parse command-line arguments:<span class="footnote"><br>[Since
<span class="monospaced">tools.cli</span> is so cool, this example can run entirely at the REPL.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>tools<span style="color: #990000">.</span>cli <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>cli<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[[</span>opts args banner<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(cli</span></span> args
                                <span style="color: #990000">[</span><span style="color: #FF0000">"-h"</span> <span style="color: #FF0000">"--help"</span> <span style="color: #FF0000">"Print this help"</span>
                                 <span style="color: #990000">:</span>default false <span style="color: #990000">:</span>flag true<span style="color: #990000">])]</span>
    <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="color: #990000">(:</span>help opts<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(println</span></span> banner<span style="color: #990000">))))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Simulate entry into -main at the command line</span></span>
<span style="color: #990000">(-</span>main <span style="color: #FF0000">"-h"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Usage:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;  Switches                 Default  Desc</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;  --------                 -------  ----</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;  -h, --no-help, --help    false    Print this help</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_71">Discussion</h4>
<div class="paragraph"><p>Clojure&#8217;s <span class="monospaced">tools.cli</span> is a simple library, with only one function,
<span class="monospaced">cli</span>, and a slim data-oriented API for specifying how arguments
should be parsed. Handily enough, there isn&#8217;t much special about this
function: an arguments vector and specifications go in, and a map of parsed
options, variadic arguments, and a help banner come out. It&#8217;s really the
epitome of good, composable functional programming.</p></div>
<div class="paragraph"><p>To configure how options are parsed, pass any number of spec vectors
after the <span class="monospaced">args</span> list. To specify a <span class="monospaced">:port</span> parameter, for example,
you would provide the spec <span class="monospaced">["-p" "--port"]</span>. The <span class="monospaced">"-p"</span> isn&#8217;t
strictly necessary, but it is customary to provide a single-letter
shortcut for command-line options (especially long ones). In the
returned <span class="monospaced">opts</span> map, the text of the last option name will be interned
to a keyword (less the <span class="monospaced">--</span>). For example, <span class="monospaced">"--port"</span> would become
<span class="monospaced">:port</span>, and <span class="monospaced">"--super-long-option"</span> would become <span class="monospaced">:super-long-option</span>.</p></div>
<div class="paragraph"><p>If you&#8217;re a polite command-line application developer, you&#8217;ll also
include a description for each of your options. Specify this as an
optional string following the final argument name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span><span style="color: #FF0000">"-p"</span> <span style="color: #FF0000">"--port"</span> <span style="color: #FF0000">"The incoming port the application will listen on."</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Everything after the argument name and description will be interpreted
as options in key/value pairs. <span class="monospaced">tools.cli</span> provides the following
options:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:default</span>
</dt>
<dd>
<p>
The default value returned in the absence of user input.
  Without specifying, the default of <span class="monospaced">:default</span> is <span class="monospaced">nil</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:flag</span>
</dt>
<dd>
<p>
If truthy (not <span class="monospaced">false</span> or <span class="monospaced">nil</span>), indicates an argument
  behaves like a flag or switch. This argument will <em>not</em> take any
  value as its input.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:parse-fn</span>
</dt>
<dd>
<p>
The function used to parse an argument&#8217;s value. This can
  be used to turn string values into integers, floats, or other
  data types.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:assoc-fn</span>
</dt>
<dd>
<p>
The function used to combine multiple values for a
  single argument.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Here&#8217;s a complete example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> assoc<span style="color: #990000">-</span>max
  <span style="color: #FF0000">"Associate a numeric value into a map. If a value already exists for the</span>
<span style="color: #FF0000">  desired key, keep the max of the new &amp; old values."</span>
  <span style="color: #990000">[</span>m k v<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(contains</span></span><span style="color: #990000">?</span> m k<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in m <span style="color: #990000">[</span>k<span style="color: #990000">]</span> max v<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> m k v<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> app<span style="color: #990000">-</span>specs <span style="color: #990000">[[</span><span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"--count"</span> <span style="color: #990000">:</span>default <span style="color: #993399">5</span>
                                <span style="color: #990000">:</span>parse<span style="color: #990000">-</span>fn #<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">.</span> <span style="color: #990000">%)</span>
                                <span style="color: #990000">:</span>assoc<span style="color: #990000">-</span>fn assoc<span style="color: #990000">-</span>max<span style="color: #990000">]</span>
                <span style="color: #990000">[</span><span style="color: #FF0000">"-v"</span> <span style="color: #FF0000">"--verbose"</span> <span style="color: #990000">:</span>flag true
                                  <span style="color: #990000">:</span>default true<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(first</span></span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> cli <span style="color: #990000">[</span><span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"2"</span> <span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"50"</span><span style="color: #990000">]</span> app<span style="color: #990000">-</span>specs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:count 50, :verbose true}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(first</span></span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> cli <span style="color: #990000">[</span><span style="color: #FF0000">"--no-verbose"</span><span style="color: #990000">]</span> app<span style="color: #990000">-</span>specs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:count 5, :verbose false}</span></span></tt></pre></div></div>
<div class="paragraph"><p>When writing flag options, a useful shortcut is to omit the <span class="monospaced">:flag</span>
option and add a "<span class="monospaced">[no-]</span>" prefix to the argument&#8217;s name. <span class="monospaced">cli</span> will
interpret this argument spec as including <span class="monospaced">:flag true</span> without you having
to specify it as such:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span><span style="color: #FF0000">"-v"</span> <span style="color: #FF0000">"--[no-]verbose"</span> <span style="color: #990000">:</span>default true<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>One thing the <span class="monospaced">tools.cli</span> library <em>doesn&#8217;t</em> provide is a hook into the
application container&#8217;s launch life cycle. It is your responsibility to
add a <span class="monospaced">cli</span> call to your <span class="monospaced">-main</span> function and know when to print the
help banner. A general pattern for use is to capture the results of
<span class="monospaced">cli</span> in a <span class="monospaced">let</span> block and determine if help needs to be printed. This
is also useful for ensuring the validity of arguments (especially since
there is no <span class="monospaced">:required</span> option):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> required<span style="color: #990000">-</span>opts #{<span style="color: #990000">:</span>port}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> missing<span style="color: #990000">-</span>required<span style="color: #990000">?</span>
  <span style="color: #FF0000">"Returns true if opts is missing any of the required-opts"</span>
  <span style="color: #990000">[</span>opts<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(not</span></span><span style="color: #990000">-</span>every<span style="color: #990000">?</span> opts required<span style="color: #990000">-</span>opts<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[[</span>opts args banner<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(cli</span></span> args
                                <span style="color: #990000">[</span><span style="color: #FF0000">"-h"</span> <span style="color: #FF0000">"--help"</span> <span style="color: #FF0000">"Print this help"</span>
                                 <span style="color: #990000">:</span>default false <span style="color: #990000">:</span>flag true<span style="color: #990000">]</span>
                                <span style="color: #990000">[</span><span style="color: #FF0000">"-p"</span> <span style="color: #FF0000">"--port"</span> <span style="color: #990000">:</span>parse<span style="color: #990000">-</span>fn #<span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">.</span> <span style="color: #990000">%)])]</span>
    <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="font-weight: bold"><span style="color: #000000">(or</span></span> <span style="color: #990000">(:</span>help opts<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(missing</span></span><span style="color: #990000">-</span>required<span style="color: #990000">?</span> opts<span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #000000">(println</span></span> banner<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>As with many applications, you may want to accept a variable number of
arguments; for example, a list of filenames.
In most cases, you don&#8217;t need to do anything special to capture these
arguments&#8212;just supply them after any other options. These variadic
arguments will be returned as the second item in <span class="monospaced">cli</span>'s returned vector:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> cli <span style="color: #990000">[</span><span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"5"</span> <span style="color: #FF0000">"foo.txt"</span> <span style="color: #FF0000">"bar.txt"</span><span style="color: #990000">]</span> app<span style="color: #990000">-</span>specs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["foo.txt" "bar.txt"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>If your variadic arguments look like flags, however, you&#8217;ll need
another trick. Use <span class="monospaced">--</span> as an argument to indicate to <span class="monospaced">cli</span> that
everything that follows is a variadic argument. This is useful if
you&#8217;re invoking another program with the options originally passed to
your program:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> cli <span style="color: #990000">[</span><span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"5"</span> <span style="color: #FF0000">"--port"</span> <span style="color: #FF0000">"80"</span><span style="color: #990000">]</span> app<span style="color: #990000">-</span>specs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; Exception '--port' is not a valid argument ...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> cli <span style="color: #990000">[</span><span style="color: #FF0000">"-n"</span> <span style="color: #FF0000">"5"</span> <span style="color: #FF0000">"--"</span> <span style="color: #FF0000">"--port"</span> <span style="color: #FF0000">"80"</span><span style="color: #990000">]</span> app<span style="color: #990000">-</span>specs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["--port" "80"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Once you&#8217;ve finished toying with your application&#8217;s option parsing at
the REPL, you&#8217;ll probably want to try invoking options via <strong><span class="monospaced">lein run</span></strong>.
Just like your application needs to use <span class="monospaced">--</span> to indicate arguments to
pass on to subsequent programs, so too must you use <span class="monospaced">--</span> to indicate to
<strong><span class="monospaced">lein run</span></strong> which arguments are for your program and which are for it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># If app-specs were rigged up to a project...</span></span>
$ lein run -- -n <span style="color: #993399">5</span> --no-verbose</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_71">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_command_line_applications">[sec_command_line_applications]</a>, to learn more about invoking
  applications from the command line
</p>
</li>
<li>
<p>
<a href="#sec_local_io_writing_to_stdout_and_stderr">[sec_local_io_writing_to_stdout_and_stderr]</a>, to learn about input and output streams
</p>
</li>
<li>
<p>
<a href="#sec_packaging_jars">[sec_packaging_jars]</a>, to learn how to package an application as
  an executable JAR file
</p>
</li>
<li>
<p>
For building <em>ncurses</em>-style applications, see
  <a href="http://bit.ly/clj-lanterna"><span class="monospaced">clojure-lanterna</span></a>, a wrapper
  around the Lanterna terminal output library
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_custom_project_templates">Creating Custom Project Templates</h3>
<div class="paragraph byline"><p>by Travis Vachon</p></div>
<div class="sect3">
<h4 id="_problem_72">Problem</h4>
<div class="paragraph"><p>You regularly create new, similar projects and want an easy way to
generate customized boilerplate. Or, you work on an open source
project and want to give users an easy way to get started with your
software.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_72">Solution</h4>
<div class="paragraph"><p>Leiningen templates give Clojure programmers an easy way to
automatically generate customized project boilerplate with a single
shell command. We&#8217;ll explore them by creating a template for a simple
web service.</p></div>
<div class="paragraph"><p>First, generate a new template with <strong><span class="monospaced">lein new template
cookbook-sample-template-&lt;github_user&gt;</span></strong>. Replace <span class="monospaced">&lt;github_user&gt;</span> with
your own GitHub username&#8212;you&#8217;ll be publishing this
template to Clojars, and it will need a unique name. In the examples,
we&#8217;ll use <span class="monospaced">clojure-cookbook</span> as our GitHub username:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new template cookbook-sample-template-clojure-cookbook
Generating fresh <span style="color: #FF0000">'lein new'</span> template project<span style="color: #990000">.</span>

$ cd cookbook-sample-template-clojure-cookbook</tt></pre></div></div>
<div class="paragraph"><p>Create a new project file template with the following contents in
<em>src/leiningen/new/&lt;project-name&gt;/project.clj</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> {{ns<span style="color: #990000">-</span>name}} <span style="color: #FF0000">"0.1.0"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]])</span></tt></pre></div></div>
<div class="paragraph"><p>Since you are creating a template for a web service and you&#8217;ll want
Clojure&#8217;s <span class="monospaced">ring</span> and <span class="monospaced">ring-jetty-adapter</span> to be available by default,
add them to the <span class="monospaced">:dependencies</span> section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>ring <span style="color: #FF0000">"1.1.8"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>ring<span style="color: #990000">/</span>ring<span style="color: #990000">-</span>jetty<span style="color: #990000">-</span>adapter <span style="color: #FF0000">"1.2.0"</span><span style="color: #990000">]]</span></tt></pre></div></div>
<div class="paragraph"><p>Next, open the template definition
(<em>src/leiningen/new/&lt;project-name&gt;.clj</em>) and add <span class="monospaced">project.clj</span> to the
list of files to be generated. Add <span class="monospaced">sanitize-ns</span> to the namespace&#8217;s
<span class="monospaced">:require</span> directive to expose a sanitized namespace string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> leiningen<span style="color: #990000">.</span>new<span style="color: #990000">.</span>cookbook<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>template<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>cookbook
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>leiningen<span style="color: #990000">.</span>new<span style="color: #990000">.</span>templates <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>renderer
                                             name<span style="color: #990000">-</span>to<span style="color: #990000">-</span>path
                                             <span style="color: #990000">-&gt;</span>files
                                             sanitize<span style="color: #990000">-</span>ns<span style="color: #990000">]]</span>
            <span style="color: #990000">[</span>leiningen<span style="color: #990000">.</span>core<span style="color: #990000">.</span>main <span style="color: #990000">:</span>as main<span style="color: #990000">]))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> render <span style="font-weight: bold"><span style="color: #000000">(renderer</span></span> <span style="color: #FF0000">"cookbook-sample-template-clojure-cookbook"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> cookbook<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>template<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>cookbook
  <span style="color: #FF0000">"FIXME: write documentation"</span>
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>data {<span style="color: #990000">:</span>name name
              <span style="color: #990000">:</span>ns<span style="color: #990000">-</span>name <span style="font-weight: bold"><span style="color: #000000">(sanitize</span></span><span style="color: #990000">-</span>ns name<span style="color: #990000">)</span>                       <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
              <span style="color: #990000">:</span>sanitized <span style="font-weight: bold"><span style="color: #000000">(name</span></span><span style="color: #990000">-</span>to<span style="color: #990000">-</span>path name<span style="color: #990000">)</span>}<span style="color: #990000">]</span>
    <span style="color: #990000">(-&gt;</span>files data
             <span style="color: #990000">[</span><span style="color: #FF0000">"project.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"project.clj"</span> data<span style="color: #990000">)]</span>        <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
             <span style="color: #990000">[</span><span style="color: #FF0000">"src/{{sanitized}}/foo.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"foo.clj"</span> data<span style="color: #990000">)])))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Add <span class="monospaced">sanitize-ns</span> to the <span class="monospaced">:require</span> declaration.
</p>
</li>
<li>
<p>
Expose <span class="monospaced">:ns-name</span> as the sanitized <span class="monospaced">name</span>.
</p>
</li>
<li>
<p>
Add <em>project.clj</em> to the list of files in the template.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A good template gives users a basic skeleton on which to build. Create
a new file at <em>src/leiningen/new/&lt;project-name&gt;/site.clj</em> with some
bare-bones web server logic:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> {{ns<span style="color: #990000">-</span>name}}<span style="color: #990000">.</span>site
    <span style="color: #FF0000">"My website! It will rock!"</span>
    <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>run<span style="color: #990000">-</span>jetty<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler <span style="color: #990000">[</span>request<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>status <span style="color: #993399">200</span>
   <span style="color: #990000">:</span>headers {<span style="color: #FF0000">"Content-Type"</span> <span style="color: #FF0000">"text/html"</span>}
   <span style="color: #990000">:</span>body <span style="color: #FF0000">"Hello World"</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(run</span></span><span style="color: #990000">-</span>jetty handler {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Back in the template&#8217;s <em>project.clj</em> file, add a key/value for the
<span class="monospaced">:main</span> option to indicate <span class="monospaced">my-website.site</span> is the core runnable
namespace for the project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">:</span>main {{ns<span style="color: #990000">-</span>name}}<span style="color: #990000">.</span>site</tt></pre></div></div>
<div class="paragraph"><p>Go back to your template definition (<em>&lt;project-name&gt;.clj</em>) and change
both <span class="monospaced">foo.clj</span> references to <span class="monospaced">site.clj</span>. Delete the
<em>src/leiningen/new/&lt;project-name&gt;/foo.clj</em> file as well:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
<span style="color: #990000">[</span><span style="color: #FF0000">"src/{{sanitized}}/site.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"site.clj"</span> data<span style="color: #990000">)])))</span></tt></pre></div></div>
<div class="paragraph"><p>To test the template locally, change directories to the root of your template
project and run:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein install
$ lein new cookbook-sample-template-clojure-cookbook my-first-website --snapshot
$ cd my-first-website
$ lein run
<span style="font-style: italic"><span style="color: #9A1900"># ... Leiningen noisily fetching dependencies ...</span></span>
<span style="color: #993399">2013</span>-<span style="color: #993399">08</span>-<span style="color: #993399">22</span> <span style="color: #993399">16</span><span style="color: #990000">:</span><span style="color: #993399">41</span><span style="color: #990000">:</span><span style="color: #993399">43.337</span><span style="color: #990000">:</span>INFO<span style="color: #990000">:</span>oejs<span style="color: #990000">.</span>Server<span style="color: #990000">:</span>jetty-<span style="color: #993399">7.6</span><span style="color: #990000">.</span><span style="color: #993399">8</span><span style="color: #990000">.</span>v20121106
<span style="color: #993399">2013</span>-<span style="color: #993399">08</span>-<span style="color: #993399">22</span> <span style="color: #993399">16</span><span style="color: #990000">:</span><span style="color: #993399">41</span><span style="color: #990000">:</span><span style="color: #993399">43.379</span><span style="color: #990000">:</span>
  INFO<span style="color: #990000">:</span>oejs<span style="color: #990000">.</span>AbstractConnector<span style="color: #990000">:</span>Started SelectChannelConnector@<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0.0</span><span style="color: #990000">:</span><span style="color: #993399">3000</span></tt></pre></div></div>
<div class="paragraph"><p>If <span class="monospaced">lein</span> prints an error about not being able to find your template, you should
make sure you&#8217;re using the latest version with <strong><span class="monospaced">lein upgrade</span></strong>.</p></div>
<div class="paragraph"><p>To make the template available to other users, you&#8217;ll need to publish it
to Clojars. First, open up the template project&#8217;s <em>project.clj</em> and change
the version to a release version&#8212;by default <span class="monospaced">lein</span> will only use non-SNAPSHOT
templates:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> cookbook<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>template<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>cookbook<span style="color: #990000">/</span>lein<span style="color: #990000">-</span>template <span style="color: #FF0000">"0.1.0"</span>
<span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>Next, visit <a href="http://clojars.org">clojars.org</a> to create a
Clojars account and then deploy from the template project root:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein deploy clojars</tt></pre></div></div>
<div class="paragraph"><p>Other users can now create projects using your template name as the
first argument to <strong><span class="monospaced">lein new</span></strong>. Leiningen will automatically fetch your
project template from Clojars:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new cookbook-sample-template-clojure-cookbook my-second-website</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_72">Discussion</h4>
<div class="paragraph"><p>Leiningen uses Clojars as a well-known source of templates. When you
pass a template name to <span class="monospaced">lein new</span>, it first looks for that template by
name in the local Maven repository. If it doesn&#8217;t find it there, it
will look for an appropriately named template on <a href="http://clojars.org">http://clojars.org</a>. If it
finds one, it will download the template and use it to create the new
project. The result is an almost magic-seeming project creation
interface that lends itself extremely well to getting Clojure
programmers going with new technology very quickly.</p></div>
<div class="paragraph"><p>Once a project template has been downloaded, Leiningen will use
<em>src/leiningen/new/&lt;project-name&gt;.clj</em> to create a new project.
This file can be customized extensively to create sophisticated
templates that match your needs. We&#8217;ll review this file and talk about
some of the tools available to the template developer.</p></div>
<div class="paragraph"><p>We first declare a namespace that matches the template name and
require some useful functions provided by Leiningen for template
development: <span class="monospaced">leiningen.new.templates</span> contains a variety of other
functions you may find useful and is worth reviewing before you
develop your own templates&#8212;problems you encounter during development
may already be solved by the library. In this case, <span class="monospaced">name-to-path</span> and
<span class="monospaced">sanitize-ns</span> will help us create strings that we&#8217;ll substitute into
file templates in a number of places:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> leiningen<span style="color: #990000">.</span>new<span style="color: #990000">.</span>cookbook<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>template<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>cookbook
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>leiningen<span style="color: #990000">.</span>new<span style="color: #990000">.</span>templates <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>renderer
                                            name<span style="color: #990000">-</span>to<span style="color: #990000">-</span>path
                                            <span style="color: #990000">-&gt;</span>files
                                            sanitize<span style="color: #990000">-</span>ns<span style="color: #990000">]]))</span></tt></pre></div></div>
<div class="paragraph"><p>A new project is generated by loading a set of
<a href="http://mustache.github.io/">mustache</a> template files and rendering them
in the context of a named set of strings. The <span class="monospaced">renderer</span> function
creates a function that looks for mustache templates in a place
determined by the name of your template. In this case it will look for
templates in
<em>src/leiningen/new/cookbook_sample_template_clojure_cookbook/</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> render <span style="font-weight: bold"><span style="color: #000000">(renderer</span></span> <span style="color: #FF0000">"cookbook-sample-template-clojure-cookbook"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Continuing the spirit of convention over configuration, Leiningen
will search this namespace for a function with the same name as your
template. You may execute arbitrary Clojure code in this function,
which means you can make project generation arbitrarily sophisticated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> cookbook<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>template<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>cookbook
  <span style="color: #FF0000">"FIXME: write documentation"</span>
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>This is the data our renderer will use to create your new project
files from the templates your provide. In this case, we give our
templates access to the project name, the namespace that will result
from that name, and a sanitized path based on that name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>data {<span style="color: #990000">:</span>name name
              <span style="color: #990000">:</span>ns<span style="color: #990000">-</span>name <span style="font-weight: bold"><span style="color: #000000">(sanitize</span></span><span style="color: #990000">-</span>ns name<span style="color: #990000">)</span>
              <span style="color: #990000">:</span>sanitized <span style="font-weight: bold"><span style="color: #000000">(name</span></span><span style="color: #990000">-</span>to<span style="color: #990000">-</span>path name<span style="color: #990000">)</span>}<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, we pass the <span class="monospaced">-&gt;files</span> (pronounced "to files") function a list
of filename/content tuples. The filename determines where in the new
project a file will end up. Content is generated using the <span class="monospaced">render</span>
function we defined earlier. <span class="monospaced">render</span> accepts a relative path to the
template file and the key/value map we created:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #990000">(-&gt;</span>files data
             <span style="color: #990000">[</span><span style="color: #FF0000">"project.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"project.clj"</span> data<span style="color: #990000">)]</span>
             <span style="color: #990000">[</span><span style="color: #FF0000">"src/{{sanitized}}/site.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"site.clj"</span> data<span style="color: #990000">)])))</span></tt></pre></div></div>
<div class="paragraph"><p>Mustache templates are very simple, implementing nothing more than
simple key substitution. For example, the following snippet is used to
generate the <span class="monospaced">ns</span> statement for our new project&#8217;s main file,
<em>site.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> {{ns<span style="color: #990000">-</span>name}}<span style="color: #990000">.</span>site
    <span style="color: #FF0000">"My website! It will rock!"</span>
    <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>run<span style="color: #990000">-</span>jetty<span style="color: #990000">]]))</span></tt></pre></div></div>
<div class="paragraph"><p>Leiningen templates are a powerful tool for saving Clojure developers
from the drudgery of project setup. More importantly, they are an
invaluable tool for open source developers to showcase their projects
and make it incredibly easy for potential users to get started with an
unfamiliar piece of software. If you&#8217;ve been developing Clojure for a
while, or even if you&#8217;ve just started, it&#8217;s well worth your time to
take templates for a spin today!"</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_72">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://bit.ly/lein-templates">Leiningen template documentation</a>
</p>
</li>
<li>
<p>
The source of the <a href="http://bit.ly/lein-templates-clj"><span class="monospaced">leiningen.new.templates</span></a> namespace
</p>
</li>
<li>
<p>
<a href="http://mustache.github.io/"><span class="monospaced">mustache</span> templates</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="polymorphism_with_protocols">Building Functions with Polymorphic Behavior</h3>
<div class="paragraph byline"><p>by Ryan Neufeld; originally submitted by David McNeil</p></div>
<div class="sect3">
<h4 id="_problem_73">Problem</h4>
<div class="paragraph"><p>You want to create functions whose behavior varies based upon the
arguments passed to them. For example, you want to develop a set of flexible geometry functions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_73">Solution</h4>
<div class="paragraph"><p>The easiest way to implement runtime polymorphism is via hand-rolled,
map-based dispatch using functions like <span class="monospaced">cond</span> or <span class="monospaced">condp</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> area
  <span style="color: #FF0000">"Calculate the area of a shape"</span>
  <span style="color: #990000">[</span>shape<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(condp</span></span> <span style="color: #990000">=</span> <span style="color: #990000">(:</span>type shape<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>triangle  <span style="color: #990000">(*</span> <span style="color: #990000">(:</span>base shape<span style="color: #990000">)</span> <span style="color: #990000">(:</span>height shape<span style="color: #990000">)</span> <span style="color: #990000">(/</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">))</span>
    <span style="color: #990000">:</span>rectangle <span style="color: #990000">(*</span> <span style="color: #990000">(:</span>length shape<span style="color: #990000">)</span> <span style="color: #990000">(:</span>width shape<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(area</span></span> {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>triangle <span style="color: #990000">:</span>base <span style="color: #993399">2</span> <span style="color: #990000">:</span>height <span style="color: #993399">4</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 4N</span></span>

<span style="font-weight: bold"><span style="color: #000000">(area</span></span> {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>rectangle <span style="color: #990000">:</span>length <span style="color: #993399">2</span> <span style="color: #990000">:</span>width <span style="color: #993399">4</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 8</span></span></tt></pre></div></div>
<div class="paragraph"><p>This approach is a little raw, though: <span class="monospaced">area</span> ties together dispatch
and multiple shapes' area implementations, all under one function. Use
the <span class="monospaced">defmulti</span> and <span class="monospaced">defmethod</span> macros to define a multimethod, which will separate dispatch from implementation and introduce a measure
of extensibility:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmulti</span></span> area
  <span style="color: #FF0000">"Calculate the area of a shape"</span>
  <span style="color: #990000">:</span>type<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> area <span style="color: #990000">:</span>rectangle <span style="color: #990000">[</span>shape<span style="color: #990000">]</span>
  <span style="color: #990000">(*</span> <span style="color: #990000">(:</span>length shape<span style="color: #990000">)</span> <span style="color: #990000">(:</span>width shape<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(area</span></span> {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>rectangle <span style="color: #990000">:</span>length <span style="color: #993399">2</span> <span style="color: #990000">:</span>width <span style="color: #993399">4</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 8</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Trying to get the area of a new shape...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(area</span></span> {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>circle <span style="color: #990000">:</span>radius <span style="color: #993399">1</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; IllegalArgumentException No method in multimethod 'area' for</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    dispatch value: :circle ...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> area <span style="color: #990000">:</span>circle <span style="color: #990000">[</span>shape<span style="color: #990000">]</span>
  <span style="color: #990000">(*</span> <span style="color: #990000">(.</span> Math PI<span style="color: #990000">)</span> <span style="color: #990000">(:</span>radius shape<span style="color: #990000">)</span> <span style="color: #990000">(:</span>radius shape<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(area</span></span> {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>circle <span style="color: #990000">:</span>radius <span style="color: #993399">1</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 3.141592653589793</span></span></tt></pre></div></div>
<div class="paragraph"><p>Better, but things start to fall apart if you want to add new
geometric functions like <span class="monospaced">perimeter</span>. With multimethods you&#8217;ll need to
repeat dispatch logic for each function and write a combinatorial
explosion of implementations to suit. It would be better if these
functions and their implementations could be grouped and written
together.</p></div>
<div class="paragraph"><p>Use Clojure&#8217;s <em>protocol</em> facilities to define a protocol interface and
extend it with concrete implementations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Define the "shape" of a Shape object</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defprotocol</span></span> Shape
  <span style="font-weight: bold"><span style="color: #000000">(area</span></span> <span style="color: #990000">[</span>s<span style="color: #990000">]</span> <span style="color: #FF0000">"Calculate the area of a shape"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(perimeter</span></span> <span style="color: #990000">[</span>s<span style="color: #990000">]</span> <span style="color: #FF0000">"Calculate the perimeter of a shape"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Define a concrete Shape, the Rectangle</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defrecord</span></span> Rectangle <span style="color: #990000">[</span>length width<span style="color: #990000">]</span>
  Shape
  <span style="font-weight: bold"><span style="color: #000000">(area</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(*</span> length width<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(perimeter</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(+</span> <span style="color: #990000">(*</span> <span style="color: #993399">2</span> length<span style="color: #990000">)</span>
                       <span style="color: #990000">(*</span> <span style="color: #993399">2</span> width<span style="color: #990000">))))</span>

<span style="color: #990000">(-&gt;</span>Rectangle <span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #user.Rectangle{:length 2, :width 4}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(area</span></span> <span style="color: #990000">(-&gt;</span>Rectangle <span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 8</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_73">Discussion</h4>
<div class="paragraph"><p>As you&#8217;ve seen in this recipe, there are a multitude of different ways
to implement polymorphism in Clojure. While the preceding example
settled on protocols as a method for implementing polymorphism, there
are no hard and fast rules about which technique to use. Each
approach has its own unique set of trade-offs that need to be
considered when introducing polymorphism.</p></div>
<div class="paragraph"><p>The first approach considered was simple map-based polymorphism using
<span class="monospaced">condp</span>. In retrospect, it&#8217;s not the right choice for building a
geometry library in Clojure, but that is not to say it is without its
uses. This approach is best used <a href="http://bit.ly/wiki-its">in the small</a>: you could use <span class="monospaced">cond</span> to
prototype early iterations of a protocol at the REPL, or in places
where you aren&#8217;t defining new types.</p></div>
<div class="paragraph"><p>It&#8217;s important to note that there are techniques beyond <span class="monospaced">cond</span> for
implementing map-based dispatch. One such technique is a dispatch
map, generally implemented as a map of keys to functions.</p></div>
<div class="paragraph"><p>Next up are multimethods. Unlike <span class="monospaced">cond</span>-based polymorphism,
multimethods separate dispatch from implementation. On account of
this, they can be extended after their creation. Multimethods are
defined using the <span class="monospaced">defmulti</span> macro, which behaves similarly to <span class="monospaced">defn</span>
but specifies a dispatch function instead of an implementation.</p></div>
<div class="paragraph"><p>Let&#8217;s break down the <span class="monospaced">defmulti</span> declaration for a rather simple
multimethod, the <span class="monospaced">area</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmulti</span></span> area <span style="font-style: italic"><span style="color: #9A1900">;                    <b>&lt;1&gt;</b></span></span>
  <span style="color: #FF0000">"Calculate the area of a shape"</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
  <span style="color: #990000">:</span>type<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">;                          <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The function name for this multimethod
</p>
</li>
<li>
<p>
A docstring describing the function
</p>
</li>
<li>
<p>
The dispatch function
</p>
</li>
</ol></div>
<div class="paragraph"><p>Using the keyword <span class="monospaced">:type</span> as a dispatch function doesn&#8217;t do justice to
the flexibility of multimethods: they&#8217;re capable of much more.
Multimethods allow you to perform arbitrarily complex introspection of
the arguments they are invoked with.</p></div>
<div class="paragraph"><p>When choosing a map lookup like <span class="monospaced">:type</span> for a dispatch function, you
also imply the <em>arity</em> of the function (the number of arguments it accepts).
Since keywords act as a function on one argument (a map), <span class="monospaced">area</span> is a
single-arity function. Other functions will imply different arities. A
common pattern with multimethods is to use an anonymous function to
make the intended arity of a multimethod more explicit:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmulti</span></span> ingest<span style="color: #990000">-</span>message
  <span style="color: #FF0000">"Ingest a message into an application"</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>app message<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">;      <b>&lt;1&gt;</b></span></span>
    <span style="color: #990000">(:</span>priority message<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
  <span style="color: #990000">:</span>default <span style="color: #990000">:</span>low<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">;         <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">ingest-messages</span> accepts two arguments, an app and a message.
</p>
</li>
<li>
<p>
<span class="monospaced">message</span> will be processed differently depending on its priority.
</p>
</li>
<li>
<p>
In the absence of a <span class="monospaced">:priority</span> key on <span class="monospaced">message</span>, the default
    priority will be <span class="monospaced">:low</span>. Without specifying, the default dispatch
    value is <span class="monospaced">:default</span>.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> ingest<span style="color: #990000">-</span>message <span style="color: #990000">:</span>low <span style="color: #990000">[</span>app message<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Ingesting message "</span> message <span style="color: #FF0000">", eventually..."</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> ingest<span style="color: #990000">-</span>message <span style="color: #990000">:</span>high <span style="color: #990000">[</span>app message<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Ingesting message "</span> message <span style="color: #FF0000">", now."</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(ingest</span></span><span style="color: #990000">-</span>message {} {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>stats <span style="color: #990000">:</span>value <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Ingesting message {:type :stats :value [1 2 3]}, eventually...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(ingest</span></span><span style="color: #990000">-</span>message {} {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>heartbeat <span style="color: #990000">:</span>priority <span style="color: #990000">:</span>high}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Ingesting message {:type :heartbeat, :priority :high}, now.</span></span></tt></pre></div></div>
<div class="paragraph"><p>In all of the examples so far, we&#8217;ve always dispatched on a single
value. Multimethods also support something called <em>multiple dispatch</em>,
whereby a function can be dispatched upon any number of factors.</p></div>
<div class="paragraph"><p>By
returning a vector rather than a single value in our dispatch, we can
make more dynamic decisions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmulti</span></span> convert
  <span style="color: #FF0000">"Convert a thing from one type to another"</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>request thing<span style="color: #990000">]</span>
    <span style="color: #990000">[(:</span>input<span style="color: #990000">-</span>format request<span style="color: #990000">)</span> <span style="color: #990000">(:</span>output<span style="color: #990000">-</span>format request<span style="color: #990000">)]))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>

<span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'clojure<span style="color: #990000">.</span>edn<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> convert <span style="color: #990000">[:</span>edn<span style="color: #990000">-</span>string <span style="color: #990000">:</span>clojure<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">;                <b>&lt;2&gt;</b></span></span>
  <span style="color: #990000">[</span>_ str<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string str<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'clojure<span style="color: #990000">.</span>data<span style="color: #990000">.</span>json<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> convert <span style="color: #990000">[:</span>clojure <span style="color: #990000">:</span>json<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">;                      <b>&lt;3&gt;</b></span></span>
  <span style="color: #990000">[</span>_ thing<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>data<span style="color: #990000">.</span>json<span style="color: #990000">/</span>write<span style="color: #990000">-</span>str thing<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(convert</span></span> {<span style="color: #990000">:</span>input<span style="color: #990000">-</span>format <span style="color: #990000">:</span>edn<span style="color: #990000">-</span>string
          <span style="color: #990000">:</span>output<span style="color: #990000">-</span>format <span style="color: #990000">:</span>clojure}
         <span style="color: #FF0000">"{:foo :bar}"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:foo :bar}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(convert</span></span> {<span style="color: #990000">:</span>input<span style="color: #990000">-</span>format <span style="color: #990000">:</span>clojure
          <span style="color: #990000">:</span>output<span style="color: #990000">-</span>format <span style="color: #990000">:</span>json}
         {<span style="color: #990000">:</span>foo <span style="color: #990000">[:</span>bar <span style="color: #990000">:</span>baz<span style="color: #990000">]</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "{\"foo\":[\"bar\",\"baz\"]}"</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">convert</span> multimethod dispatches on input <em>and</em> output format.
</p>
</li>
<li>
<p>
An implementation of <span class="monospaced">convert</span> that converts from edn strings to
    Clojure data.
</p>
</li>
<li>
<p>
Similarly, an implementation that converts from Clojure data to
    JSON.
</p>
</li>
</ol></div>
<div class="paragraph"><p>All this power comes at a cost, however; because multimethods are so
dynamic, they can be quite slow. Further, there is no good way to
group sets of related multimethods into an all-or-nothing package.<span class="footnote"><br>[That is to say, you cannot force a multimethod to implement all of the required methods when extending behavior to its own type.]<br></span> If speed or implementing a complete interface is
among your chief concerns, then you will likely be better served by
protocols.</p></div>
<div class="paragraph"><p>Clojure&#8217;s protocol feature provides extensible polymorphism with fast
dispatch akin to Java&#8217;s interfaces, with one notable difference from
multimethods: protocols can only perform single dispatch (based on type).</p></div>
<div class="paragraph"><p>Protocols are defined using the <span class="monospaced">defprotocol</span> macro, which accepts a name,
an optional docstring, and any number of named method signatures. A
method signature is made up of a few parts: the name, at least one
type signature, and an optional docstring. The first argument of any
type signature is always the object itself&#8212;Clojure dispatches on the
type of this argument. Perhaps an example would be the easiest way to
dig into <span class="monospaced">defprotocol</span>'s syntax:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defprotocol</span></span> Frobnozzle
  <span style="color: #FF0000">"Basic methods for any Frobnozzle"</span>
  <span style="font-weight: bold"><span style="color: #000000">(blint</span></span> <span style="color: #990000">[</span>this x<span style="color: #990000">]</span> <span style="color: #FF0000">"Blint the frobnozzle with x"</span><span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">;                     <b>&lt;1&gt;</b></span></span>
  <span style="font-weight: bold"><span style="color: #000000">(crand</span></span> <span style="color: #990000">[</span>this f<span style="color: #990000">]</span> <span style="color: #990000">[</span>this f x<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Crand a frobnozzle with another "</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
                                  <span style="color: #FF0000">"optionally incorporating x"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A function, <span class="monospaced">blint</span>, with a single additional argument, <span class="monospaced">x</span>
</p>
</li>
<li>
<p>
A multi-arity function, <span class="monospaced">crand</span>, that takes an optional <span class="monospaced">x</span> argument
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once a protocol is defined, there are numerous ways to provide an
implementation for it. <span class="monospaced">deftype</span>, <span class="monospaced">defrecord</span>, and <span class="monospaced">reify</span> all define a
protocol implementation while creating an object. The <span class="monospaced">deftype</span> and
<span class="monospaced">defrecord</span> forms create new named types, while <span class="monospaced">reify</span> creates an
anonymous type. Each form is used by indicating the protocol being
extended, followed by concrete implementations of each of that
protocol&#8217;s methods:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; deftype has a similar syntax, but is not really applicable for an</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; immutable shape</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defrecord</span></span> Square <span style="color: #990000">[</span>length<span style="color: #990000">]</span>
  Shape <span style="font-style: italic"><span style="color: #9A1900">;                           <b>&lt;1&gt;</b></span></span>
  <span style="font-weight: bold"><span style="color: #000000">(area</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(*</span> length length<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
  <span style="font-weight: bold"><span style="color: #000000">(perimeter</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(*</span> <span style="color: #993399">4</span> length<span style="color: #990000">))</span>
  <span style="font-style: italic"><span style="color: #9A1900">;                                 <b>&lt;3&gt;</b></span></span>
  <span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(perimeter</span></span> <span style="color: #990000">(-&gt;</span>Square <span style="color: #993399">1</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 4</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Calculate the area of a rectangle without defining a record</span></span>
<span style="font-weight: bold"><span style="color: #000000">(area</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>b <span style="color: #993399">2</span>
        h <span style="color: #993399">3</span><span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(reify</span></span> Shape
      <span style="font-weight: bold"><span style="color: #000000">(area</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(*</span> b h<span style="color: #990000">))</span>
      <span style="font-weight: bold"><span style="color: #000000">(perimeter</span></span> <span style="color: #990000">[</span>this<span style="color: #990000">]</span> <span style="color: #990000">(*</span> <span style="color: #993399">2</span> <span style="color: #990000">(+</span> b h<span style="color: #990000">))))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 6</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Indicate the protocol being implemented.
</p>
</li>
<li>
<p>
Implement all of its methods.
</p>
</li>
<li>
<p>
Repeat steps one and two for any remaining protocols you wish to
    implement.
</p>
</li>
</ol></div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Difference Between a Type and a Record</div>
<div class="paragraph"><p>Types and records share a very similar syntax, so it can be
hard to understand how each should be used.</p></div>
<div class="paragraph"><p>Chas Emerick explained it best in an appendix to <emphasis><ulink role="orm:hideurl" url="http://www.clojurebook.com/">Clojure Programming</ulink></emphasis> (O&#8217;Reilly):</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Is your class modeling a domain value&#8212;thus benefiting from hash
map&#x2013;like functionality and semantics? Use <span class="monospaced">defrecord</span>.</p></div>
<div class="paragraph"><p>Do you need to define mutable fields? Use <span class="monospaced">deftype</span>.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>There you have it.</p></div>
</div></div>
<div class="paragraph"><p>For implementing protocols on existing types, you will want to use the
<span class="monospaced">extend</span> family of built-in functions (<span class="monospaced">extend</span>, <span class="monospaced">extend-type</span>, and
<span class="monospaced">extend-protocol</span>). Instead of creating a new type, these functions
define implementations for existing types.</p></div>
<?hard-pagebreak?>
</div>
<div class="sect3">
<h4 id="_see_also_73">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The official documentation for
  <a href="http://clojure.org/multimethods">multimethods and hierarchies</a>, which
  covers multimethods in depth. This document also covers hierarchies
  as they relate to multimethods, a feature not covered in this
  recipe.
</p>
</li>
<li>
<p>
The official documentation for
  <a href="http://clojure.org/protocols">protocols</a>, which covers protocols in
  depth, including information on how protocols relate to interfaces.
</p>
</li>
<li>
<p>
<a href="#sec_red_black_part_ii">[sec_red_black_part_ii]</a>, for a concrete example of implementing a protocol.
</p>
</li>
<li>
<p>
<a href="#extend_built_in">[extend_built_in]</a>, for examples of using <span class="monospaced">extend</span> and its
  convenience macros <span class="monospaced">extend-type</span> and <span class="monospaced">extend-protocol</span>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="extend_built_in">Extending a Built-In Type</h3>
<div class="paragraph byline"><p>by David McNeil</p></div>
<div class="sect3">
<h4 id="_problem_74">Problem</h4>
<div class="paragraph"><p>You need to extend one of the built-in types with your own functions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_74">Solution</h4>
<div class="paragraph"><p>Suppose you would like to add domain-specific functions to
the core <span class="monospaced">java.lang.String</span> type. In this example, you will add a
<span class="monospaced">first-name</span> and a <span class="monospaced">last-name</span> function to <span class="monospaced">String</span>.</p></div>
<div class="paragraph"><p>Define a protocol with the functions you need. The protocol declares
the signature of the functions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defprotocol</span></span> Person
  <span style="color: #FF0000">"Represents the name of a person."</span>
  <span style="font-weight: bold"><span style="color: #000000">(first</span></span><span style="color: #990000">-</span>name <span style="color: #990000">[</span>person<span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #000000">(last</span></span><span style="color: #990000">-</span>name <span style="color: #990000">[</span>person<span style="color: #990000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>Extend the type to the <span class="monospaced">java.lang.String</span> class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(extend</span></span><span style="color: #990000">-</span>type String
  Person
  <span style="font-weight: bold"><span style="color: #000000">(first</span></span><span style="color: #990000">-</span>name <span style="color: #990000">[</span>s<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(first</span></span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split s #<span style="color: #FF0000">" "</span><span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #000000">(last</span></span><span style="color: #990000">-</span>name <span style="color: #990000">[</span>s<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split s #<span style="color: #FF0000">" "</span><span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>Now you can invoke your functions on strings:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(first</span></span><span style="color: #990000">-</span>name <span style="color: #FF0000">"john"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "john"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(last</span></span><span style="color: #990000">-</span>name <span style="color: #FF0000">"john smith"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "smith"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_74">Discussion</h4>
<div class="paragraph"><p>Why use protocols when multimethods already exist? For one, speed:
protocols dispatch only on the type of their first parameter. Further,
protocols allow you to group and name an extension. This makes it much
easier to reason about what a group of functions confer about a type
and ensures a proper, full implementation.</p></div>
<div class="paragraph"><p>It is good practice to only extend a protocol to a type if you are the
author of either the protocol or the type. This will avoid cases where
you violate the assumptions of the original author(s).</p></div>
<div class="paragraph"><p>If you already had functions to use, then it would make sense to use
<span class="monospaced">extend</span> instead of the <span class="monospaced">extend-type</span> form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> first<span style="color: #990000">-</span>word <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(first</span></span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split s #<span style="color: #FF0000">" "</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> second<span style="color: #990000">-</span>word <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(second</span></span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split s #<span style="color: #FF0000">" "</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(extend</span></span> String
  Person
  {<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name first<span style="color: #990000">-</span>word
   <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name second<span style="color: #990000">-</span>word}<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_74">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
An excellent <a href="http://bit.ly/protocols-explanation">explanation</a> of why
  protocols exist as it relates to the "Expression Problem" by Jörg W Mittag on StackOverflow
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_general_core_async">Decoupling Consumers and Producers with core.async</h3>
<div class="paragraph byline"><p>by Daemian Mack</p></div>
<div class="sect3">
<h4 id="_problem_75">Problem</h4>
<div class="paragraph"><p>You want to decouple your program&#8217;s consumers and producers by
introducing explicit queues between them.</p></div>
<div class="paragraph"><p>For example, if you are building a web dashboard that fetches Twitter
messages, this application must both persist these events to a database and
publish them via server-sent events (SSE) to a browser.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_75">Solution</h4>
<div class="paragraph"><p>Introducing explicit queues between components allows them to
communicate asynchronously, making them simpler to manage independently
and freeing up computational resources.</p></div>
<div class="paragraph"><p>Use the <a href="https://github.com/clojure/core.async"><span class="monospaced">core.async</span></a>
library to introduce and coordinate asynchronous channels.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>async</tt></pre></div></div>
<div class="paragraph"><p>Consider the following passage illustrating a synchronous approach:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> database<span style="color: #990000">-</span>consumer
  <span style="color: #FF0000">"Accept messages and persist them to a database."</span>
  <span style="color: #990000">[</span>msg<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"database-consumer received message %s"</span> msg<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> sse<span style="color: #990000">-</span>consumer
  <span style="color: #FF0000">"Accept messages and pass them to web browsers via SSE."</span>
  <span style="color: #990000">[</span>msg<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"sse-consumer received message %s"</span> msg<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> messages
  <span style="color: #FF0000">"Fetch messages from Twitter."</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">4</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> message<span style="color: #990000">-</span>producer
  <span style="color: #FF0000">"Produce messages and deliver them to consumers."</span>
  <span style="color: #990000">[&amp;</span> consumers<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>msg <span style="font-weight: bold"><span style="color: #000000">(messages</span></span><span style="color: #990000">)</span>
          consumer consumers<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(consumer</span></span> msg<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(message</span></span><span style="color: #990000">-</span>producer database<span style="color: #990000">-</span>consumer sse<span style="color: #990000">-</span>consumer<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received message 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received message 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received message 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received message 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received message 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received message 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received message 3</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received message 3</span></span></tt></pre></div></div>
<div class="paragraph"><p>Each message received is passed directly to each consumer of
<span class="monospaced">message-producer</span>. As implemented, this approach is rather brittle;
any slow consumer could cause the entire pipeline to grind to a halt.</p></div>
<div class="paragraph"><p>To make processing asynchronous, introduce explicit queues with
<span class="monospaced">clojure.core.async/chan</span>. Perform work asynchronously by wrapping
it in one of <span class="monospaced">core.async</span>'s <span class="monospaced">clojure.core.async/go</span> forms:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>async <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>chan sliding<span style="color: #990000">-</span>buffer go
                                      go<span style="color: #990000">-</span>loop timeout <span style="color: #990000">&gt;!</span> <span style="color: #990000">&lt;!]])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> database<span style="color: #990000">-</span>consumer
  <span style="color: #FF0000">"Accept messages and persist them to a database."</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(go</span></span><span style="color: #990000">-</span>loop <span style="color: #990000">[</span>data <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">)]</span>
             <span style="font-weight: bold"><span style="color: #000000">(when</span></span> data
               <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"database-consumer received data %s"</span> data<span style="color: #990000">))</span>
               <span style="font-weight: bold"><span style="color: #000000">(recur</span></span> <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">))))</span>
    in<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> sse<span style="color: #990000">-</span>consumer
  <span style="color: #FF0000">"Accept messages and pass them to web browsers via SSE."</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(go</span></span><span style="color: #990000">-</span>loop <span style="color: #990000">[</span>data <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">)]</span>
             <span style="font-weight: bold"><span style="color: #000000">(when</span></span> data
               <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"sse-consumer received data %s"</span> data<span style="color: #990000">))</span>
               <span style="font-weight: bold"><span style="color: #000000">(recur</span></span> <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">))))</span>
    in<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> messages
  <span style="color: #FF0000">"Fetch messages from Twitter."</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">4</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> producer
  <span style="color: #FF0000">"Produce messages and deliver them to consumers."</span>
  <span style="color: #990000">[&amp;</span> channels<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(go</span></span>
   <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>msg <span style="font-weight: bold"><span style="color: #000000">(messages</span></span><span style="color: #990000">)</span>
           out  channels<span style="color: #990000">]</span>
     <span style="color: #990000">(&lt;!</span> <span style="font-weight: bold"><span style="color: #000000">(timeout</span></span> <span style="color: #993399">100</span><span style="color: #990000">))</span>
     <span style="color: #990000">(&gt;!</span> out msg<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(producer</span></span> <span style="font-weight: bold"><span style="color: #000000">(database</span></span><span style="color: #990000">-</span>consumer<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(sse</span></span><span style="color: #990000">-</span>consumer<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received data 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received data 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received data 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received data 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received data 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received data 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; database-consumer received data 3</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; sse-consumer received data 3</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_75">Discussion</h4>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>There comes a time in all good programs when components or subsystems
must stop communicating directly with one another.</p></div>
</div>
<div class="attribution">
<em>Clojure core.async Channels</em><br>
&#8212; Rich Hickey
</div></div>
<div class="paragraph"><p>This code is larger than the original implementation. What has this
afforded us?</p></div>
<div class="paragraph"><p>The original approach was rigid. It offered no control over consumer
latency and was therefore extremely vulnerable to lag. By buffering
communication over channels and doing work asynchronously, we&#8217;ve
created service boundaries around producers and consumers, allowing
them to operate as independently as possible.</p></div>
<div class="paragraph"><p>Let&#8217;s examine one of the new consumers in depth to understand how it
has changed.</p></div>
<div class="paragraph"><p>Instead of receiving messages via function invocation,
consumers now draw messages from a buffered channel. Where a consumer
(e.g., <span class="monospaced">database-consumer</span>) used to consume a single message at a time,
it now uses a <span class="monospaced">go-loop</span> to continuously consume messages from its
producer.</p></div>
<div class="paragraph"><p>In traditional callback-oriented code, accomplishing something like
this would require splitting logic out across numerous functions,
introducing "callback hell." One of the benefits of <span class="monospaced">core.async</span> is
that it lets you write code inline, in a more straightforward style:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> database<span style="color: #990000">-</span>consumer
  <span style="color: #FF0000">"Accept messages and persist them to a database."</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">))]</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
    <span style="font-weight: bold"><span style="color: #000000">(go</span></span><span style="color: #990000">-</span>loop <span style="color: #990000">[</span>data <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">)]</span>            <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
             <span style="font-weight: bold"><span style="color: #000000">(when</span></span> data                <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
               <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"database-consumer received data %s"</span> data<span style="color: #990000">))</span>
               <span style="font-weight: bold"><span style="color: #000000">(recur</span></span> <span style="color: #990000">(&lt;!</span> in<span style="color: #990000">))))</span>       <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;4&gt;</b></span></span>
    in<span style="color: #990000">))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Here the channel is given a buffer of size 64. The
    <span class="monospaced">sliding-buffer</span> variant dictates that if this channel
    accumulates more than 64 unread values, older values will start
    "falling off" the end, trading off historical completeness in
    favor of recency. Using <span class="monospaced">dropping-buffer</span> instead would optimize
    in the opposite direction.
</p>
</li>
<li>
<p>
<span class="monospaced">go-loop</span> is the <span class="monospaced">core.async</span> equivalent to looping via something
    like <span class="monospaced">while true</span>. This <span class="monospaced">go-loop</span> reads its initial value by
    "taking" (<span class="monospaced">&lt;!</span>) from the input channel (<span class="monospaced">in</span>).
</p>
</li>
<li>
<p>
Because channels return <span class="monospaced">nil</span> when closed, as long as we can read
    <span class="monospaced">data</span> from them, we know we have work to do.
</p>
</li>
<li>
<p>
To <span class="monospaced">recur</span> the <span class="monospaced">go-loop</span> to the beginning, take the next value
    from the channel and invoke <span class="monospaced">recur</span> with it.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Because the <span class="monospaced">go-loop</span> block is asynchronous, the take call (<span class="monospaced">&lt;!</span>)
parks until a value is placed on the channel. The remainder of the
<span class="monospaced">go-loop</span> block&#8212;here, the <span class="monospaced">println</span> call&#8212;is pending. Since the
channel is returned as the <span class="monospaced">database-consumer</span> function&#8217;s value, other
parts of the system&#8212;namely, the producer&#8212;are free to write to
the channel while the take waits. The first value written to the
channel will satisfy that read call, allowing the rest of the
<span class="monospaced">go-loop</span> block to continue.</p></div>
<div class="paragraph"><p>This consumer is now asynchronous, reading values until the channel
closes. Since the channel is buffered, we now have some measure of
control over the system&#8217;s resiliency. For example, buffers allow a
consumer to lag behind a producer by a specified amount.</p></div>
<div class="paragraph"><p>Fewer changes are required to make <span class="monospaced">producer</span> asynchronous:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> producer
  <span style="color: #990000">[&amp;</span> channels<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(go</span></span>
   <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>msg <span style="font-weight: bold"><span style="color: #000000">(messages</span></span><span style="color: #990000">)</span>
           out  channels<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
     <span style="color: #990000">(&lt;!</span> <span style="font-weight: bold"><span style="color: #000000">(timeout</span></span> <span style="color: #993399">100</span><span style="color: #990000">))</span>   <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
     <span style="color: #990000">(&gt;!</span> out msg<span style="color: #990000">))))</span>     <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
For each message and channel&#8230;
</p>
</li>
<li>
<p>
Take from a <span class="monospaced">timeout</span> channel to simulate a short pause for effect&#8230;
</p>
</li>
<li>
<p>
And put a message onto the channel with <span class="monospaced">&gt;!</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Although the operations are asynchronous, they still occur serially.
Using unbuffered consumer channels would mean that if one of the consumers
took from the channel too slowly, the pipeline would stall; the
producer would not be able to put further values onto the channels.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_75">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">core.async</span> has more advanced facilities for layout and coordination
  of channels. For more details, see the
  <a href="http://bit.ly/core-async-doc"><span class="monospaced">core.async</span> overview</a>.
</p>
</li>
<li>
<p>
<a href="#sec_concurrent_zmq">[sec_concurrent_zmq]</a>, to see how to use <span class="monospaced">core.async</span> to communicate
  over ZeroMQ.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_core_match_parser">Making a Parser for Clojure Expressions Using core.match</h3>
<div class="paragraph byline"><p>by Chris Frisz</p></div>
<div class="sect3">
<h4 id="_problem_76">Problem</h4>
<div class="paragraph"><p>You want to parse Clojure expressions, say, from the input to a macro,
into a different representation (like maps).</p></div>
<div class="paragraph"><p>For this example, consider a heavily simplified version of Clojure
that consists of the following expression types:</p></div>
<div class="ulist"><ul>
<li>
<p>
A variable represented by a valid Clojure symbol
</p>
</li>
<li>
<p>
An <span class="monospaced">fn</span> expression that accepts a single argument and whose body is
    also a valid expression
</p>
</li>
<li>
<p>
An application of a valid expression in the language to another valid
    expression
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can represent this language by the following grammar:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Expr <span style="color: #990000">=</span> var
     <span style="color: #990000">|</span> <span style="color: #990000">(</span>fn <span style="color: #990000">[</span>var<span style="color: #990000">]</span> Expr<span style="color: #990000">)</span>
     <span style="color: #990000">|</span> <span style="color: #990000">(</span>Expr Expr<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_solution_76">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">core.match</span> to pattern match over the input and return the
expression represented as maps of maps.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojure/core.match "0.2.0"]</span> to your
project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>match</tt></pre></div></div>
<div class="paragraph"><p>Now, codify the language&#8217;s grammar using <span class="monospaced">clojure.core.match/match</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>match <span style="color: #990000">:</span>refer <span style="font-weight: bold"><span style="color: #000000">(match</span></span><span style="color: #990000">)])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> simple<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser
  <span style="color: #990000">[</span>expr<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(match</span></span> <span style="color: #990000">[</span>expr<span style="color: #990000">]</span>
    <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(var</span></span> <span style="color: #990000">:</span>guard symbol<span style="color: #990000">?)]</span> {<span style="color: #990000">:</span>variable var}
    <span style="color: #990000">[([</span>'fn <span style="color: #990000">[</span>arg<span style="color: #990000">]</span> body<span style="color: #990000">]</span> <span style="color: #990000">:</span>seq<span style="color: #990000">)]</span> {<span style="color: #990000">:</span>closure
                               {<span style="color: #990000">:</span>arg arg
                                <span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser body<span style="color: #990000">)</span>}}
    <span style="color: #990000">[([</span>operator operand<span style="color: #990000">]</span> <span style="color: #990000">:</span>seq<span style="color: #990000">)]</span> {<span style="color: #990000">:</span>application
                                 {<span style="color: #990000">:</span>operator <span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser operator<span style="color: #990000">)</span>
                                  <span style="color: #990000">:</span>operand <span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser operand<span style="color: #990000">)</span>}}
    <span style="color: #990000">:</span>else <span style="font-weight: bold"><span style="color: #000000">(throw</span></span> <span style="font-weight: bold"><span style="color: #000000">(Exception</span></span><span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"invalid expression: "</span> expr<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser 'a<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:variable a}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser '<span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span> x<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:closure {:arg x, :body {:variable x}}}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser '<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span> x<span style="color: #990000">)</span> a<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:application</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:operator {:closure {:arg x, :body {:variable x}}}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :operand {:variable a}}}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; fn expression can only have one argument!</span></span>
<span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser '<span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>x y<span style="color: #990000">]</span> x<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; Exception invalid expression: (fn [x y] x) ...</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_76">Discussion</h4>
<div class="paragraph"><p>A <span class="monospaced">match</span> statement in <span class="monospaced">core.match</span> is made up of two basic parts. The
first part is a vector of vars to be matched. In our example, this
is <span class="monospaced">[expr]</span>. This vector isn&#8217;t limited to a single entry&#8212;it can
contain as many items to match as you would like. The next part is a
variable list of question/answer pairs. A <em>question</em> is a vector
representing the <em>shape</em> the vars vector must take. As with <span class="monospaced">cond</span>, an
<em>answer</em> is what will be returned should a var satisfy a question.</p></div>
<div class="paragraph"><p>Questions take a variety of forms in <span class="monospaced">core.match</span>. Here are explanations
of the preceding samples:</p></div>
<div class="ulist"><ul>
<li>
<p>
The first match pattern, <span class="monospaced">[(var :guard symbol?)]</span>, matches the
variable case of our syntax, binding the matched expression to <span class="monospaced">var</span>.
The special <span class="monospaced">:guard</span> form applies the predicate <span class="monospaced">symbol?</span> to <span class="monospaced">var</span>,
only returning the answer if <span class="monospaced">symbol?</span> returns <span class="monospaced">true</span>.
</p>
</li>
<li>
<p>
The second pattern, <span class="monospaced">[(['fn [arg] body] :seq)]</span>, matches the <span class="monospaced">fn</span> case.<span class="footnote"><br>[The match pattern for <span class="monospaced">fn</span> could (and should) include a guard on the <span class="monospaced">arg</span> to ensure that it&#8217;s a symbol, but that&#8217;s elided here for brevity.]<br></span> Note the special <span class="monospaced">([...] :seq)</span> syntax for matching
over lists, used here to represent an <span class="monospaced">fn</span> expression. Also notice
that to match on the literal <span class="monospaced">fn</span>, it had to be quoted in the match
pattern.  Interestingly, since the <span class="monospaced">body</span> expression should also be
accepted by this parser, it makes a self-recursive call,
<span class="monospaced">(simple-clojure-parser body)</span>, in the righthand side of the match
pattern.
</p>
</li>
<li>
<p>
For the third <span class="monospaced">:application</span> pattern, the parser again
matches on a list using the <span class="monospaced">([...] :seq)</span> syntax. As in the body of the
<span class="monospaced">fn</span> expression, both the <span class="monospaced">operator</span> and <span class="monospaced">operand</span> expressions should
be accepted by the parser, so it makes a recursive call for each one.
</p>
<div class="paragraph"><p>Finally, the parser throws an exception if the given expression doesn&#8217;t
match any of the three accepted patterns. This gives a somewhat more
helpful error message if you accidentally hand the parser a malformed
expression.</p></div>
</li>
</ul></div>
<div class="paragraph"><p>Writing your parser this way gives you succinct code that closely
resembles the target input. Alternatively, you could write it
using conditional expressions (<span class="monospaced">if</span> or <span class="monospaced">cond</span>) and explicitly
destructure the input. To illustrate the difference in length and
clarity of the code, consider this function that only parses the <span class="monospaced">fn</span>
expressions of the Clojure subset:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> parse<span style="color: #990000">-</span>fn
  <span style="color: #990000">[</span>expr<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(and</span></span> <span style="font-weight: bold"><span style="color: #000000">(list</span></span><span style="color: #990000">?</span> expr<span style="color: #990000">)</span>
           <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> expr<span style="color: #990000">)</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
           <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> expr <span style="color: #993399">0</span><span style="color: #990000">)</span> 'fn<span style="color: #990000">)</span>
           <span style="font-weight: bold"><span style="color: #000000">(vector</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> expr <span style="color: #993399">1</span><span style="color: #990000">))</span>
           <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> expr <span style="color: #993399">1</span><span style="color: #990000">))</span> <span style="color: #993399">1</span><span style="color: #990000">))</span>
    {<span style="color: #990000">:</span>closure {<span style="color: #990000">:</span>arg <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> expr <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
               <span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(simple</span></span><span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>parser <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> expr <span style="color: #993399">2</span><span style="color: #990000">))</span>}}
    <span style="font-weight: bold"><span style="color: #000000">(throw</span></span> <span style="font-weight: bold"><span style="color: #000000">(Exception</span></span><span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"unexpected non-fn expression: "</span> expr<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>Notice how much more code this version needed in order to express the
same properties about an <span class="monospaced">fn</span> expression? Not only did the non-<span class="monospaced">match</span>
version require more code, but the <span class="monospaced">if</span> test doesn&#8217;t resemble the
structure of the expression the way the <span class="monospaced">match</span> pattern does. Further,
<span class="monospaced">match</span> binds the matched input to the variable names in the match
pattern automatically, saving you from having to <span class="monospaced">let</span>-bind them
yourself or repeatedly write the same list access code (as shown with
<span class="monospaced">(nth expr)</span> in <span class="monospaced">parse-fn</span> above). Needless to say, the <span class="monospaced">match</span> is
much easier to read and maintain.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_76">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">core.match</span> wiki&#8217;s
  <a href="http://bit.ly/clj-core-match">Overview page</a> for a
  broader view over all of the library&#8217;s capabilities
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_querying_hierarchical_graphs_with_core_logic">Querying Hierarchical Graphs with core.logic</h3>
<div class="paragraph byline"><p>by Ryan Senior</p></div>
<div class="sect3">
<h4 id="_problem_77">Problem</h4>
<div class="paragraph"><p>You have a graph-like hierarchical data structure, serialized as a
flat list of nodes, that you want to query. For example, you have a
graph of movie metadata represented as entity-attribute-value triples.
Writing this code with the standard <span class="monospaced">seq</span> functions has proven to be too
tedious and error prone.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_77">Solution</h4>
<div class="paragraph"><p>The <span class="monospaced">core.logic</span> library is a Clojure implementation of the
miniKanren domain-specific language (DSL) for logic programming. Its
declarative style is well suited for querying flattened hierarchical
data.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>logic</tt></pre></div></div>
<div class="paragraph"><p>The first thing you need is a dataset to query. Consider, for example,
that you have represented a graph of movie metadata as a list of tuples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> movie<span style="color: #990000">-</span>graph
  <span style="color: #990000">[</span><span style="font-style: italic"><span style="color: #9A1900">;; The "Newmarket Films" studio</span></span>
   <span style="color: #990000">[:</span>a1 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmStudio<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a1 <span style="color: #990000">:</span>name <span style="color: #FF0000">"Newmarket Films"</span><span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a1 <span style="color: #990000">:</span>filmsCollection <span style="color: #990000">:</span>a2<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; Collection of films made by Newmarket Films</span></span>
   <span style="color: #990000">[:</span>a2 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCollection<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a2 <span style="color: #990000">:</span>film <span style="color: #990000">:</span>a3<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a2 <span style="color: #990000">:</span>film <span style="color: #990000">:</span>a6<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; The movie "Memento"</span></span>
   <span style="color: #990000">[:</span>a3 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Film<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a3 <span style="color: #990000">:</span>name <span style="color: #FF0000">"Memento"</span><span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a3 <span style="color: #990000">:</span>cast <span style="color: #990000">:</span>a4<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; Connects the film to its cast (actors/director/producer etc.)</span></span>
   <span style="color: #990000">[:</span>a4 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCast<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a4 <span style="color: #990000">:</span>director <span style="color: #990000">:</span>a5<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; The director of "Memento"</span></span>
   <span style="color: #990000">[:</span>a5 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Person<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a5 <span style="color: #990000">:</span>name <span style="color: #FF0000">"Christopher Nolan"</span><span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; The movie "The Usual Suspects"</span></span>
   <span style="color: #990000">[:</span>a6 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Film<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a6 <span style="color: #990000">:</span>filmName <span style="color: #FF0000">"The Usual Suspects"</span><span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a6 <span style="color: #990000">:</span>cast <span style="color: #990000">:</span>a7<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; Connects the film to its cast (actors/director/producer etc.)</span></span>
   <span style="color: #990000">[:</span>a7 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCast<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a7 <span style="color: #990000">:</span>director <span style="color: #990000">:</span>a8<span style="color: #990000">]</span>

   <span style="font-style: italic"><span style="color: #9A1900">;; The director of "The Usual Suspects"</span></span>
   <span style="color: #990000">[:</span>a8 <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Person<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>a8 <span style="color: #990000">:</span>name <span style="color: #FF0000">"Bryan Singer"</span><span style="color: #990000">]])</span></tt></pre></div></div>
<div class="paragraph"><p>With all of this data in hand, how would you go about querying it? In
an imperative model, you would likely arduously "connect the dots"
from node to node using filters, maps, and conditionals.<span class="footnote"><br>[Oh
my!]<br></span> With <span class="monospaced">core.logic</span>, however, it is possible to connect these dots
using declarative logic statements.</p></div>
<div class="paragraph"><p>For example, to answer the question, "Which directors have made movies
at a given studio?" create a number of dots (<em>logic variables</em>) using
<span class="monospaced">clojure.core.logic/fresh</span> and connect (<em>ground</em>) them using
<span class="monospaced">clojure.core.logic/membero</span>. Finally, invoke
<span class="monospaced">clojure.core.logic/run*</span> to obtain all of the possible solutions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>logic <span style="color: #990000">:</span>as cl<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> directors<span style="color: #990000">-</span>at
  <span style="color: #FF0000">"Find all of the directors that have directed at a given studio"</span>
  <span style="color: #990000">[</span>graph studio<span style="color: #990000">-</span>name<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run<span style="color: #990000">*</span> <span style="color: #990000">[</span>director<span style="color: #990000">-</span>name<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>fresh <span style="color: #990000">[</span>studio film<span style="color: #990000">-</span>coll film cast director<span style="color: #990000">]</span>
      <span style="font-style: italic"><span style="color: #9A1900">;; Relate the original studio-name to a film collection</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>name studio<span style="color: #990000">-</span>name<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmStudio<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>filmsCollection film<span style="color: #990000">-</span>coll<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-style: italic"><span style="color: #9A1900">;; Relate any film collections to their individual films</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCollection<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>film film<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-style: italic"><span style="color: #9A1900">;; Then from film to cast members</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Film<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>cast cast<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-style: italic"><span style="color: #9A1900">;; Grounding to cast members of type :director</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCast<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>director director<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-style: italic"><span style="color: #9A1900">;; Finally, attach to the director-name</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Person<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>name director<span style="color: #990000">-</span>name<span style="color: #990000">]</span> graph<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(directors</span></span><span style="color: #990000">-</span>at movie<span style="color: #990000">-</span>graph <span style="color: #FF0000">"Newmarket Films"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Christopher Nolan" "Bryan Singer")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_77">Discussion</h4>
<div class="paragraph"><p>miniKanren is a domain-specific language written in Scheme, intended
to give many of the benefits of a logic programming language (such as
Prolog) from within Scheme. David Nolen created an implementation of miniKanren for Clojure, with a focus on performance. One
of the benefits of logic programming languages is their very
declarative style. By using <span class="monospaced">core.logic</span>, we are able to say <em>what</em> we
are looking for in the graph without saying <em>how</em> <span class="monospaced">core.logic</span> should go
about finding it.</p></div>
<div class="paragraph"><p>In general, all <span class="monospaced">core.logic</span> queries begin with one of the library&#8217;s
<span class="monospaced">run</span> macros, with <span class="monospaced">clojure.core.logic/run</span> returning a finite number of
solutions and <span class="monospaced">clojure.core.logic/run*</span> returning <em>all</em> of the
solutions.</p></div>
<div class="paragraph"><p>The first argument to the <span class="monospaced">run</span> macro is the <em>goal</em>, a variable used
to store the result of the query. In the preceding solution, this was the
<span class="monospaced">director-name</span> variable. The rest is the body of the <span class="monospaced">core.logic</span>
program. A program is made up of <em>logic variables</em> (created using
<span class="monospaced">clojure.core.logic/fresh</span>) grounded to values or constrained by logic
statements.</p></div>
<div class="paragraph"><p><span class="monospaced">run</span> is a clue that our programming paradigm is changing to logic
programming. In a <span class="monospaced">core.logic</span> program, <em>unification</em> is used rather
than traditional variable assignment and seqential expression
evaluation. Unification uses substitution of values for variables in
an attempt to make two expressions syntactically identical. Statements
in a <span class="monospaced">core.logic</span> program can appear in any order. For example, you can use
<span class="monospaced">clojure.core.logic/==</span> to unify <span class="monospaced">1</span> and <span class="monospaced">q</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> <span style="color: #993399">1</span> q<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> q <span style="color: #993399">1</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1)</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">core.logic</span> is also able to unify the contents of lists and vectors,
finding the right substitution to make both expressions the same:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span>
         <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> q<span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (3)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> <span style="color: #990000">[</span><span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">"bar"</span> <span style="color: #FF0000">"baz"</span><span style="color: #990000">]</span>
         <span style="color: #990000">[</span>q     <span style="color: #FF0000">"bar"</span> <span style="color: #FF0000">"baz"</span><span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("foo")</span></span></tt></pre></div></div>
<div class="paragraph"><p>Technically speaking, unification is a relation, relating the first
form with the second form. This is a kind of puzzle for <span class="monospaced">core.logic</span> to
solve. In the previous example, <span class="monospaced">q</span> is a logic variable, and <span class="monospaced">core.logic</span> is
charged with binding a value to <span class="monospaced">q</span> such that the left and the right
sides of the unification (the <span class="monospaced">clojure.core.logic/==</span> relation) are
syntactically identical. When there is no binding that satisfies the
puzzle, no solution exists:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; There is no way a single value is both 1 AND 2</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> <span style="color: #993399">1</span> q<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> <span style="color: #993399">2</span> q<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ()</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">fresh</span> is one way to create more logic variables:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>fresh <span style="color: #990000">[</span>x y z<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> x <span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> y <span style="color: #993399">2</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> z <span style="color: #993399">3</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> q <span style="color: #990000">[</span>x y z<span style="color: #990000">])))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([1 2 3])</span></span></tt></pre></div></div>
<div class="paragraph"><p>Just as <span class="monospaced">clojure.core.logic/==</span> is a relation between two forms,
<span class="monospaced">clojure.core.logic/membero</span> is a relation between an element in a
list and the list itself:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero q <span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #993399">1</span> q<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ((1 . _0))</span></span></tt></pre></div></div>
<div class="paragraph"><p>The first example is asking for any member of the list <span class="monospaced">[1]</span>, which
happens to only be <span class="monospaced">1</span>. The second example is the opposite, asking for any list
where <span class="monospaced">1</span> is a member. The dot notation indicates an improper tail
with <span class="monospaced">_0</span> in it. This means <span class="monospaced">1</span> could be in a list by itself, or it
could be followed by any other sequence of numbers, strings, lists, etc.
<span class="monospaced">_0</span> is an unbound variable, since there was no further restriction on
the list other than <span class="monospaced">1</span> being an element.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p><span class="monospaced">clojure.core.logic/run*</span> is a macro that asks for all possible
solutions. Asking for all of the lists that contain a <span class="monospaced">1</span> will not
terminate.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Unification can peek inside structures with
<span class="monospaced">clojure.core.logic/membero</span> as well:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span><span style="color: #993399">1</span> q <span style="color: #993399">3</span><span style="color: #990000">]</span> <span style="color: #990000">[[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #990000">]]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (2)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Logic variables live for the duration of the program, making it
possible to use the same logic variable in multiple statements:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>seq<span style="color: #990000">-</span>a <span style="color: #990000">[[</span><span style="color: #FF0000">"foo"</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"bar"</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"baz"</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #990000">]]</span>
      seq<span style="color: #990000">-</span>b <span style="color: #990000">[[</span><span style="color: #FF0000">"foo"</span> <span style="color: #993399">9</span> <span style="color: #993399">8</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"bar"</span> <span style="color: #993399">7</span> <span style="color: #993399">6</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"baz"</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span><span style="color: #990000">]]]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>q<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>fresh <span style="color: #990000">[</span>first<span style="color: #990000">-</span>item middle<span style="color: #990000">-</span>item last<span style="color: #990000">-</span>a last<span style="color: #990000">-</span>b<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>first<span style="color: #990000">-</span>item middle<span style="color: #990000">-</span>item last<span style="color: #990000">-</span>a<span style="color: #990000">]</span> seq<span style="color: #990000">-</span>a<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>first<span style="color: #990000">-</span>item middle<span style="color: #990000">-</span>item last<span style="color: #990000">-</span>b<span style="color: #990000">]</span> seq<span style="color: #990000">-</span>b<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/==</span> q <span style="color: #990000">[</span>last<span style="color: #990000">-</span>a last<span style="color: #990000">-</span>b<span style="color: #990000">]))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([6 4])</span></span></tt></pre></div></div>
<div class="paragraph"><p>The previous example does not specify <span class="monospaced">first-item</span>, only that it should
be the same for <span class="monospaced">seq-a</span> and <span class="monospaced">seq-b</span>. <span class="monospaced">core.logic</span> uses the data provided
to bind values to the variable that satisfy the constraints. The same
is true with <span class="monospaced">middle-item</span>.</p></div>
<div class="paragraph"><p>Building up from this, we can traverse the graph described in the
solution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>director<span style="color: #990000">-</span>name<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>fresh <span style="color: #990000">[</span>studio film<span style="color: #990000">-</span>coll film cast director<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>name <span style="color: #FF0000">"Newmarket Films"</span><span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmStudio<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>filmsCollection film<span style="color: #990000">-</span>coll<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCollection<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>film film<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Film<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>cast cast<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCast<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>director director<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Person<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>name director<span style="color: #990000">-</span>name<span style="color: #990000">]</span> movie<span style="color: #990000">-</span>graph<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Christopher Nolan")</span></span></tt></pre></div></div>
<div class="paragraph"><p>There is one minor difference between the preceding code and the original
solution: rather than using <span class="monospaced">clojure.core.logic/run*</span>, asking for all
solutions, <span class="monospaced">clojure.core.logic/run 1</span> was used. The program has
multiple answers to the query for a director at Newmarket Films.
Asking for more answers will return more with no other code change.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Slight modifications to the preceding query can significantly change the
results. Swapping <span class="monospaced">"Newmarket Films"</span> for a new fresh variable will
return all directors, for all studios. A macro could also be created
to reduce some of the code duplication if desired.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>One benefit of the relational solution to this problem is being able
to generate a graph from the values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(first</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>run <span style="color: #993399">1</span> <span style="color: #990000">[</span>graph<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>fresh <span style="color: #990000">[</span>studio film<span style="color: #990000">-</span>coll film cast director<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>name <span style="color: #FF0000">"Newmarket Films"</span><span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmStudio<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>studio <span style="color: #990000">:</span>filmsCollection film<span style="color: #990000">-</span>coll<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCollection<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film<span style="color: #990000">-</span>coll <span style="color: #990000">:</span>film film<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Film<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>film <span style="color: #990000">:</span>cast cast<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>type <span style="color: #990000">:</span>FilmCast<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>cast <span style="color: #990000">:</span>director director<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>type <span style="color: #990000">:</span>Person<span style="color: #990000">]</span> graph<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(cl</span></span><span style="color: #990000">/</span>membero <span style="color: #990000">[</span>director <span style="color: #990000">:</span>name <span style="color: #FF0000">"Baz"</span><span style="color: #990000">]</span> graph<span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([_0 :name "Newmarket Films"]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [_0 :type :FilmStudio]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [_0 :filmsCollection _1]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ...)</span></span></tt></pre></div></div>
<div class="paragraph"><p>For small graphs, <span class="monospaced">membero</span> is fast enough. Larger graphs will
experience performance problems as <span class="monospaced">core.logic</span> will traverse the list
many times to find the elements. Using <span class="monospaced">clojure.core.logic/to-stream</span>
with some basic indexing can greatly improve the query performance.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_77">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>The Reasoned Schemer</em>, by Daniel P. Friedman, William E. Byrd, and Oleg Kiselyov (MIT Press)
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/core-logic-wiki"><span class="monospaced">core.logic</span> wiki</a>
</p>
</li>
<li>
<p>
The <a href="http://minikanren.org/">miniKanren website</a>
</p>
</li>
<li>
<p>
The <a href="https://github.com/clojure/core.logic"><span class="monospaced">core.logic</span> repository</a> for examples of using <span class="monospaced">clojure.core.logic/to-stream</span>
</p>
</li>
<li>
<p>
<a href="https://github.com/clojure/core.match"><span class="monospaced">core.match</span></a>, a (nonunification) matching library with some similar ideas, described briefly in <a href="#sec_core_match_parser">[sec_core_match_parser]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_playing_a_nursery_rhyme">Playing a Nursery Rhyme</h3>
<div class="paragraph byline"><p>by Chris Ford</p></div>
<div class="sect3">
<h4 id="_problem_78">Problem</h4>
<div class="paragraph"><p>You want to code a nursery rhyme to inspire your children to take up
programming.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_78">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/overtone/overtone">Overtone</a> to bring the song
to life.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[overtone "0.8.1"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:<span class="footnote"><br>[There are some
additional installation concerns if you are running Overtone on Linux.
See <a href="http://bit.ly/overtone-install">the Overtone wiki</a> for more
detailed installation instructions.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try overtone</tt></pre></div></div>
<div class="paragraph"><p>To start, define the melody for an old children&#8217;s song:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>overtone<span style="color: #990000">.</span>live <span style="color: #990000">:</span>as overtone<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> note <span style="color: #990000">[</span>timing pitch<span style="color: #990000">]</span> {<span style="color: #990000">:</span>time timing <span style="color: #990000">:</span>pitch pitch}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> melody
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>pitches
         <span style="color: #990000">[</span><span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span>
          <span style="font-style: italic"><span style="color: #9A1900">; Row, row, row your boat,</span></span>
          <span style="color: #993399">2</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span>
          <span style="font-style: italic"><span style="color: #9A1900">; Gently down the stream,</span></span>
          <span style="color: #993399">7</span> <span style="color: #993399">7</span> <span style="color: #993399">7</span> <span style="color: #993399">4</span> <span style="color: #993399">4</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span>
          <span style="font-style: italic"><span style="color: #9A1900">; (take 4 (repeat "merrily"))</span></span>
          <span style="color: #993399">4</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span> <span style="color: #993399">0</span><span style="color: #990000">]</span>
          <span style="font-style: italic"><span style="color: #9A1900">; Life is but a dream!</span></span>
        durations
         <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span>
          <span style="color: #993399">2</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">2</span>
          <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span>
          <span style="color: #993399">2</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #990000">]</span>
        times <span style="font-weight: bold"><span style="color: #000000">(reductions</span></span> <span style="color: #990000">+</span> <span style="color: #993399">0</span> durations<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(map</span></span> note times pitches<span style="color: #990000">)))</span>

melody
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:time 0, :pitch 0}   ; Row,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 1, :pitch 0}   ; row,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 2, :pitch 0}   ; row</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 8/3, :pitch 1} ; your</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 3N, :pitch 2}  ; boat</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ...)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Convert the piece into a specific key by transforming each note&#8217;s pitch
using a function that represents the key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> where <span style="color: #990000">[</span>k f notes<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in <span style="color: #990000">%</span> <span style="color: #990000">[</span>k<span style="color: #990000">]</span> f<span style="color: #990000">)</span> notes<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> scale <span style="color: #990000">[</span>intervals<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>degree<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">(take</span></span> degree intervals<span style="color: #990000">))))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> major <span style="font-weight: bold"><span style="color: #000000">(scale</span></span> <span style="color: #990000">[</span><span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> from <span style="color: #990000">[</span>n<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">+</span> n<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> A <span style="font-weight: bold"><span style="color: #000000">(from</span></span> <span style="color: #993399">69</span><span style="color: #990000">))</span>

<span style="color: #990000">(-&gt;&gt;</span> melody
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>pitch <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> A major<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:time 0, :pitch 69} ; Row,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 1, :pitch 69} ; row,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ...)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Convert the piece into a specific tempo by transforming each note&#8217;s
time using a function that represents the tempo:</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> bpm <span style="color: #990000">[</span>beats<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>beat<span style="color: #990000">]</span> <span style="color: #990000">(/</span> <span style="color: #990000">(*</span> beat <span style="color: #993399">60</span> <span style="color: #993399">1000</span><span style="color: #990000">)</span> beats<span style="color: #990000">)))</span>

<span style="color: #990000">(-&gt;&gt;</span> melody
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>time <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> <span style="font-weight: bold"><span style="color: #000000">(from</span></span> <span style="font-weight: bold"><span style="color: #000000">(overtone</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(bpm</span></span> <span style="color: #993399">90</span><span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:time 1383316072169, :pitch 0}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:time 4149948218507/3, :pitch 0}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ...)</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>Now, define an instrument and use it to play the melody. The following example synthesized instrument is a simple sine wave,
whose amplitude and duration are controlled by an envelope:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>overtone<span style="color: #990000">.</span>live <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>definst line sin<span style="color: #990000">-</span>osc FREE midi<span style="color: #990000">-&gt;</span>hz at<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(definst</span></span> beep <span style="color: #990000">[</span>freq <span style="color: #993399">440</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>envelope <span style="font-weight: bold"><span style="color: #000000">(line</span></span> <span style="color: #993399">1</span> <span style="color: #993399">0</span> <span style="color: #993399">0.5</span> <span style="color: #990000">:</span>action FREE<span style="color: #990000">)]</span>
    <span style="color: #990000">(*</span> envelope <span style="font-weight: bold"><span style="color: #000000">(sin</span></span><span style="color: #990000">-</span>osc freq<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> play <span style="color: #990000">[</span>notes<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>{ms <span style="color: #990000">:</span>time midi <span style="color: #990000">:</span>pitch} notes<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(at</span></span> ms <span style="font-weight: bold"><span style="color: #000000">(beep</span></span> <span style="font-weight: bold"><span style="color: #000000">(midi</span></span><span style="color: #990000">-&gt;</span>hz midi<span style="color: #990000">)))))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Make sure your speakers are on...</span></span>
<span style="color: #990000">(-&gt;&gt;</span> melody
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>pitch <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> A major<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>time <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> <span style="font-weight: bold"><span style="color: #000000">(from</span></span> <span style="font-weight: bold"><span style="color: #000000">(overtone</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(bpm</span></span> <span style="color: #993399">90</span><span style="color: #990000">)))</span>
  play<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; &lt;music playing on your speakers&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>If your nursery rhyme is a round, like "Row, Row, Row Your Boat," you
can use it to accompany itself:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> round <span style="color: #990000">[</span>beats notes<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(concat</span></span> notes <span style="color: #990000">(-&gt;&gt;</span> notes <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>time <span style="font-weight: bold"><span style="color: #000000">(from</span></span> beats<span style="color: #990000">)))))</span>

<span style="color: #990000">(-&gt;&gt;</span> melody
  <span style="font-weight: bold"><span style="color: #000000">(round</span></span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>pitch <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> A major<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="color: #990000">:</span>time <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> <span style="font-weight: bold"><span style="color: #000000">(from</span></span> <span style="font-weight: bold"><span style="color: #000000">(overtone</span></span><span style="color: #990000">/</span>now<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">(bpm</span></span> <span style="color: #993399">90</span><span style="color: #990000">)))</span>
  play<span style="color: #990000">)</span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_78">Discussion</h4>
<div class="paragraph"><p>A <em>note</em> is a sound of a particular pitch that occurs at a particular
time. A <em>song</em> is a series of notes. We can therefore simply represent
music in Clojure as a sequence of time/pitch pairs.</p></div>
<div class="paragraph"><p>This representation is structurally very similar to Western music
notation, where each dot on a stave has a time and a pitch determined
by its horizontal and vertical position. But unlike traditional music
notation, the Clojure representation can be manipulated by functional
programming techniques.</p></div>
<div class="paragraph"><p>Pieces of Western music, like "Row, Row, Row Your Boat," aren&#8217;t
composed of arbitrary pitches. Within a given melody, the notes are
typically confined to a subset of all possible pitches called a
<em>scale</em>.</p></div>
<div class="paragraph"><p>The approach taken here is to express the pitches by integers
denoting where they appear in the scale, called <em>degrees</em>. So, for
example, degree <span class="monospaced">0</span> signifies the first pitch of the scale, and degree
<span class="monospaced">4</span> signifies the fifth pitch of the scale.</p></div>
<div class="paragraph"><p>This simplifies the description of the melody, because we don&#8217;t have
to worry about inadvertently specifying pitches that are outside our
chosen scale. It also allows us to vary our chosen scale without
having to rewrite the melody.</p></div>
<div class="paragraph"><p>To work with degrees, we need a function that translates a degree into
the actual pitch. Since "Row, Row, Row Your Boat" is in a major scale,
we need a function that represents such a scale.</p></div>
<div class="paragraph"><p>We use the observation that in a major scale, there is a regular
pattern of double and single spaces between adjacent pitches (known to
musicians as tones and semitones). We define a function called
<span class="monospaced">major</span> that accepts a degree and outputs the number of semitones it
represents.</p></div>
<div class="paragraph"><p>Our pitches still aren&#8217;t quite right, because they&#8217;re relative to the
lowest note of the piece. We need to establish a musical reference
point that we will use to interpret our degrees.</p></div>
<div class="paragraph"><p>Concert A is conventionally used as a reference point by orchestras,
so we&#8217;ll use it as our musical zero. In other words, we will put "Row, Row, Row Your Boat" into A major. Now a degree of <span class="monospaced">0</span> means A.</p></div>
<div class="paragraph"><p>Note that we can simply compose together our functions for major and
for A to arrive at a composite A major function.</p></div>
<div class="paragraph"><p>We need to do a similar transformation for time. Each note&#8217;s time is
expressed in <em>beats</em>, but we need it to be in milliseconds. We use the
current system time as our temporal reference point, meaning that the
piece will start from now (and not the start of the Unix epoch).</p></div>
<div class="paragraph"><p>"Row, Row, Row Your Boat" is a round, meaning it harmonizes if sung as
an accompaniment to itself, offset by a particular number of beats. As
an extra flourish, we produce a second version of the melody that
starts four beats after the first.</p></div>
<div class="paragraph"><p>We encourage you to experiment with the tune, perhaps by varying the
speed or using a different key (as a hint, a minor key has the following
pattern of tones and semitones: <span class="monospaced">[2 1 2 2 1 2 2]</span>).</p></div>
<div class="paragraph"><p>We also encourage you to think about how this approach to modeling a
series of events can be applied to other domains. The idea of
expressing a time series as a sequence and then applying
transformations across that series is a simple, flexible, and
composable way of describing a problem.</p></div>
<div class="paragraph"><p>Music is a wonderful and moving thing. It&#8217;s also incredibly
well suited to being modeled in a functional programming language. We
hope your children agree.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_78">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/overtone/overtone">Overtone</a>, a music environment for Clojure
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_local_io">Local I/O</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_4">Introduction</h3>
<div class="paragraph"><p>We&#8217;ve done a lot of work in the last few chapters, but clearly, the
rubber has to meet the road somewhere. How did we get all of this data
<em>into</em> our Clojure programs, and more importantly, how do we get it
<em>out</em>? This chapter is all about input and output to a local
computer&#8212;the primary place where most applications' data hits the
road, so to speak.</p></div>
<div class="paragraph"><p>There are a variety of modes and mediums for communicating with a
local machine. What do we communicate with, in what way, and in what
format? It&#8217;s a little like the classic board game Clue: was it
plain text, in the console, with command-line arguments; or Clojure
data, in a file, as configuration data? In this chapter we&#8217;ll explore
files, formats, and applications of both GUI and console flavors, to
name a few topics.</p></div>
<div class="paragraph"><p>While it isn&#8217;t possible for us to enumerate every possible
combination, it is our hope that this chapter will give you a strong
idea of what is possible. Handily enough, most good solutions in
Clojure <em>compose</em>; you should have little trouble sticking together
any number of recipes in this chapter to suit your needs.</p></div>
</div>
<div class="sect2">
<h3 id="sec_local_io_writing_to_stdout_and_stderr">Writing to STDOUT and STDERR</h3>
<div class="paragraph byline"><p>by Alan Busby</p></div>
<div class="sect3">
<h4 id="_problem_79">Problem</h4>
<div class="paragraph"><p>You want to write to <span class="monospaced">STDOUT</span> and <span class="monospaced">STDERR</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_79">Solution</h4>
<div class="paragraph"><p>By default, the <span class="monospaced">print</span> and <span class="monospaced">println</span> functions will print content
passed to them to <span class="monospaced">STDOUT</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"This text will be printed to STDOUT."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; This text will be printed to STDOUT.</span></span>

<span style="font-weight: bold"><span style="color: #000000">(do</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(print</span></span> <span style="color: #FF0000">"a"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(print</span></span> <span style="color: #FF0000">"b"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ab</span></span></tt></pre></div></div>
<div class="paragraph"><p>Change the binding of <span class="monospaced">*out*</span> to <span class="monospaced">*err*</span> to print to <span class="monospaced">STDERR</span> instead
of <span class="monospaced">STDOUT</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> <span style="color: #990000">*</span>err<span style="color: #990000">*]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Blew up!"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *err*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Blew up!\n</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_79">Discussion</h4>
<div class="paragraph"><p>In Clojure, the dynamic binding vars <span class="monospaced">*out*</span> and <span class="monospaced">*err*</span> are bound to your
application environment&#8217;s built-in <span class="monospaced">STDOUT</span> and <span class="monospaced">STDERR</span> streams,
respectively.</p></div>
<div class="paragraph"><p>All of the printing functions in Clojure, such as <span class="monospaced">print</span> and <span class="monospaced">println</span>,
utilize the <span class="monospaced">*out*</span> binding as the destination to write to.
Consequently, you can rebind that var to <span class="monospaced">*err*</span> (using <span class="monospaced">binding</span>) to
change the destination of print messages from <span class="monospaced">STDOUT</span> to <span class="monospaced">STDERR</span>.
Other printing functions include <span class="monospaced">pr</span>, <span class="monospaced">prn</span>, <span class="monospaced">printf</span>, and a handful
of others.</p></div>
<div class="paragraph"><p>The bound value of <span class="monospaced">*out*</span> is not restricted to operating system
streams; <span class="monospaced">*out*</span> can be <em>any</em> stream-like object. This makes print
functions powerful tools. They can be used to write to files, sockets,
or any other pipes you desire. The built-in function
<span class="monospaced">clojure.java.io/writer</span> is a versatile constructor for output streams:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Create a writer to file foo.txt and print to it.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> foo<span style="color: #990000">-</span>file <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"foo.txt"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> foo<span style="color: #990000">-</span>file<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Foo, bar."</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Nothing is printed to *out*.</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; And of course, close the file.</span></span>
<span style="color: #990000">(.</span>close foo<span style="color: #990000">-</span>file<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_79">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">pr</span>'s
  <a href="http://bit.ly/clojure-pr">documentation</a>
  and
  <a href="http://bit.ly/clojure-pr-source">source</a>
  to get a better idea of how <span class="monospaced">*out*</span>-based printing works
</p>
</li>
<li>
<p>
<span class="monospaced">clojure.java.io/writer</span>'s
  <a href="http://bit.ly/java-io-writer">documentation</a>
  for more information on creating writers
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_a_single_keystroke_from_the_console">Reading a Single Keystroke from the Console</h3>
<div class="paragraph byline"><p>by John Jacobsen</p></div>
<div class="sect3">
<h4 id="_problem_80">Problem</h4>
<div class="paragraph"><p>Console input via <span class="monospaced">stdin</span> is normally buffered by lines; you want to read a
single, unbuffered keystroke from the console.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_80">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ConsoleReader</span> from the <a href="https://github.com/jline/jline2">JLine library</a>, a Java library for handling console input.</p></div>
<div class="paragraph"><p>JLine is similar to BSD editline and GNU readline. To follow along with this
recipe, create a new library using the command <strong><span class="monospaced">lein new keystroke</span></strong>.  Inside
<em>project.clj</em>, add <span class="monospaced">[jline "2.11"]</span> to the <span class="monospaced">:dependencies</span> vector.</p></div>
<div class="paragraph"><p>Inside the <em>src/keystroke/core.clj</em> file, use <span class="monospaced">ConsoleReader</span> to read characters from the terminal:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> keystroke<span style="color: #990000">.</span>core
  <span style="color: #990000">(:</span>import <span style="color: #990000">[</span>jline<span style="color: #990000">.</span>console ConsoleReader<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>keystroke <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(print</span></span> <span style="color: #FF0000">"Enter a keystroke: "</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(flush</span></span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>cr <span style="font-weight: bold"><span style="color: #000000">(ConsoleReader</span></span><span style="color: #990000">.)</span>
        keyint <span style="color: #990000">(.</span>readCharacter cr<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"Got %d ('%c')!"</span> keyint <span style="font-weight: bold"><span style="color: #000000">(char</span></span> keyint<span style="color: #990000">)))))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_80">Discussion</h4>
<div class="paragraph"><p>As in most languages, console I/O in Java is buffered; <span class="monospaced">flush</span>
writes the initial prompt to the standard output stream. However,
input is buffered as well by default. The JLine library provides a
<span class="monospaced">ConsoleReader</span> object whose <span class="monospaced">readCharacter</span> method lets you avoid the
input buffering. Beware, however, of testing <span class="monospaced">show-keystroke</span> at the REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein repl
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>require <span style="color: #FF0000">'[keystroke.core :refer [show-keystroke]])</span>
<span style="color: #FF0000">user=&gt; (show-keystroke)</span>
<span style="color: #FF0000">Enter a keystroke:</span>
<span style="color: #FF0000">;; HANGS!</span></tt></pre></div></div>
<div class="paragraph"><p>In order to connect the console&#8217;s input correctly to the REPL, use
<strong><span class="monospaced">lein trampoline repl</span></strong> (the <span class="monospaced">&lt;r&gt;</span> here means the user types the letter <span class="monospaced">r</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein trampoline repl
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>require <span style="color: #FF0000">'[keystroke.core :refer [show-keystroke]])</span>
<span style="color: #FF0000">user=&gt; (show-keystroke)</span>
<span style="color: #FF0000">Enter a keystroke: &lt;r&gt;Got 114 ('</span>r<span style="color: #FF0000">')!</span>
<span style="color: #FF0000">nil</span>
<span style="color: #FF0000">user=&gt;</span>
</tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">lein trampoline</span> is necessary because, by default, a Leiningen REPL
actually runs the REPL and its associated console I/O in a separate
JVM process from your application code. Using the <span class="monospaced">trampoline</span> option
forces Leiningen to run your code in the same process as the REPL,
"trampolining" control back and forth. Normally this is invisible,
but it is a problem when running code that itself is attempting to use
the console directly.</p></div>
<div class="paragraph"><p>When running your program outside the REPL (as you typically would be,
with a command-line application written in Clojure), this is not an
issue.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_80">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
If you want a richer terminal-based interface similar to what
  the C <em>curses</em> library provides, the
  <a href="http://bit.ly/clj-lanterna"><span class="monospaced">clojure-lanterna</span></a> library
  may be a good place to start.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_executing_system_commands">Executing System Commands</h3>
<div class="paragraph byline"><p>by Mark Whelan and Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_81">Problem</h4>
<div class="paragraph"><p>You want to send a command to the underlying operating system and get
its output.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_81">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clj-commons-exec</span> library to run shell commands on your local
system.</p></div>
<div class="paragraph"><p>To follow along, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojars<span style="color: #990000">.</span>hozumi/clj-commons-exec <span style="color: #FF0000">"1.0.6"</span></tt></pre></div></div>
<div class="paragraph"><p>Invoking the <span class="monospaced">clj-commons-exec/exec</span> function with a command will
return a promise, eventually delivering a map of the command&#8217;s output,
exit status, and any errors that occurred (available via the <span class="monospaced">:out</span>, <span class="monospaced">:exit</span>,
and <span class="monospaced">:err</span> keys, respectively):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>commons<span style="color: #990000">-</span>exec <span style="color: #990000">:</span>as exec<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> p <span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"date"</span><span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(deref</span></span> p<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 0, :out "Sun Dec  1 19:43:49 EST 2013\n", :err nil}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If your command requires options or arguments, simply append them to
the command vector as strings:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"ls"</span> <span style="color: #FF0000">"-l"</span> <span style="color: #FF0000">"/etc/passwd"</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :out "-rw-r--r--  1 root  wheel  4962 May 27 07:54 /etc/passwd\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :err nil}</span></span>

@<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"ls"</span> <span style="color: #FF0000">"-l"</span> <span style="color: #FF0000">"nosuchfile"</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :out nil</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :err "ls: nosuchfile: No such file or directory\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :exception #&lt;ExecuteException ... Process exited with an error: 1 ...)&gt;}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_81">Discussion</h4>
<div class="paragraph"><p>Up until this point, we&#8217;ve neglected to mention that functionality
equivalent to <span class="monospaced">exec/sh</span> already exists in Clojure proper (as
<span class="monospaced">clojure.java.shell/sh</span>). Now that the cat is out of the bag, it must
be asked: why use a library over a built-in? Simple: <span class="monospaced">clj-commons-exec</span>
is a functional veneer over the excellent
<a href="http://bit.ly/commons-exec">Apache Commons Exec</a>
library, providing capabilities like <em>piping</em> not available in
<span class="monospaced">clojure.java.shell</span>.</p></div>
<div class="paragraph"><p>To pipe data through multiple commands, use the
<span class="monospaced">clj-commons-exec/sh-pipe</span> function. Just as with regular Unix pipes,
pairs of commands will have their <span class="monospaced">STDOUT</span> and <span class="monospaced">STDIN</span> streams bound to
each other. The API of <span class="monospaced">sh-pipe</span> is nearly identically to that of <span class="monospaced">sh</span>, the
only notable exception being that you will pass more than one command to
<span class="monospaced">sh-pipe</span>. The return value of <span class="monospaced">sh-pipe</span> is a list of promises that
fulfill as each subcommand completes execution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> results <span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh<span style="color: #990000">-</span>pipe <span style="color: #990000">[</span><span style="color: #FF0000">"cat"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"wc"</span> <span style="color: #FF0000">"-w"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>in <span style="color: #FF0000">"Hello, world!"</span>}<span style="color: #990000">))</span>

results
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#&lt;core$promise$reify__6310@71eed8d: {:exit 0, :out nil, :err nil}&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;core$promise$reify__6310@7f7dc7a1: {:exit 0,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;                                           :out "       2\n",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;                                           :err nil}&gt;)</span></span>

@<span style="font-weight: bold"><span style="color: #000000">(last</span></span> results<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 0, :out "       2\n", :err nil}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Like any reasonable shell-process library, <span class="monospaced">clj-commons-exec</span> allows you
to configure the environment in which your commands execute. To
control the execution environment of either <span class="monospaced">sh</span> or <span class="monospaced">sh-pipe</span>, specify
options in a map as the final argument to either function. The <span class="monospaced">:dir</span>
option controls the path on which a command executes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #990000">(:</span>out @<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"ls"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>dir <span style="color: #FF0000">"/"</span>}<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
Applications
Library
# <span style="color: #990000">...</span>
usr
var</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">:env</span> and <span class="monospaced">:add-env</span> options control the environment variables
available to the executing command. <span class="monospaced">:add-env</span> appends variables to the
existing set of environment variables, while <span class="monospaced">:env</span> replaces the
existing set with a completely new one. Each option is a map of
variable names to values, like <span class="monospaced">{"USER" "jeff"}</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"printenv"</span> <span style="color: #FF0000">"HOME"</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 0, :out "/Users/ryan\n", :err nil}</span></span>

@<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"printenv"</span> <span style="color: #FF0000">"HOME"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>env {}}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 1, :out nil, :err nil, :exception #&lt;ExecuteException ..)&gt;}</span></span>

@<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"printenv"</span> <span style="color: #FF0000">"HOME"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>env {<span style="color: #FF0000">"HOME"</span> <span style="color: #FF0000">"/Users/jeff"</span>}}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exit 0, :out "/Users/jeff\n", :err nil}</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are a number of other options available in <span class="monospaced">sh</span> and <span class="monospaced">sh-pipe</span>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:watchdog</span>
</dt>
<dd>
<p>
  The time in number of seconds to wait for a command to finish executing before terminating it
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:shutdown</span>
</dt>
<dd>
<p>
  A flag indicating that subprocesses should be destroyed when the VM exits
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:as-success</span> and <span class="monospaced">:as-successes</span>
</dt>
<dd>
<p>
  An integer or sequence of integers that will be considered successful exit codes, respectively
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:result-handler-fn</span>
</dt>
<dd>
<p>
  A custom function to be used to handle results
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>If you initiate long-running subprocesses inside of a <span class="monospaced">-main</span>
function, your application will hang until those processes complete.
If this isn&#8217;t desirable, forcibly terminate your application by invoking
<span class="monospaced">(System/exit)</span> directly at the end of your <span class="monospaced">-main</span> function.
Additionally, set the option <span class="monospaced">:shutdown</span> to <span class="monospaced">true</span> for any
subprocesses to ensure you leave your system tidy and free of rogue
processes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To check if a subprocess has returned without waiting for it to
finish, invoke the <span class="monospaced">realized?</span> function on the promise returned by
<span class="monospaced">sh</span> (this is especially useful for monitoring the progress of the
sequence of promises returned by <span class="monospaced">sh-pipe</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Any old long-running command</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> p <span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">/</span>sh <span style="color: #990000">[</span><span style="color: #FF0000">"sleep"</span> <span style="color: #FF0000">"5"</span><span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> p<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; A few seconds later...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> p<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_81">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
If you don&#8217;t need piping or <span class="monospaced">clj-common-execs</span> advanced features,
  consider using
  <a href="http://bit.ly/clj-java-shell-api"><span class="monospaced">clojure.java.shell</span></a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local_io_get_local_resource">Accessing Resource Files</h3>
<div class="paragraph byline"><p>by John Jacobsen, with help from John Cromartie and Alex Petrov</p></div>
<div class="sect3">
<h4 id="_problem_82">Problem</h4>
<div class="paragraph"><p>You want to include a resource file from the classpath in your
Clojure project.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_82">Solution</h4>
<div class="paragraph"><p>Place resource files in the <em>resources/</em> directory at the top level of
your Leiningen project. To follow along with this recipe, create a new project
with the command <strong><span class="monospaced">lein new people</span></strong>.</p></div>
<div class="paragraph"><p>For example, suppose you have a file <em>resources/people.edn</em> with the following contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span>{<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"McCarthy"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>language <span style="color: #FF0000">"Lisp"</span>}
 {<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name <span style="color: #FF0000">"Guido"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Van Rossum"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>language <span style="color: #FF0000">"Python"</span>}
 {<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name <span style="color: #FF0000">"Rich"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Hickey"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>language <span style="color: #FF0000">"Clojure"</span>}<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Pass the name of the file (relative to the <em>resources</em> directory) to
the <span class="monospaced">clojure.java.io/resource</span> function to obtain an instance of
<span class="monospaced">java.io.File</span>, which you can then read as you please (for example,
using the <span class="monospaced">slurp</span> function):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>as io<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">])</span>

<span style="color: #990000">(-&gt;&gt;</span> <span style="color: #FF0000">"people.edn"</span>
     io<span style="color: #990000">/</span>resource
     slurp
     edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string
     <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>language<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Lisp" "Python" "Clojure")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_82">Discussion</h4>
<div class="paragraph"><p>Resources are commonly used to store any kind of file that is
logically a part of your application, but is not code.</p></div>
<div class="paragraph"><p>Resources are loaded via the Java classpath, just like Clojure code
is. Leiningen puts the <em>resources/</em> directory on the classpath
automatically whenever it starts a Java process, and when packaged,
the contents of <em>resources/</em> are copied to the root of any emitted JAR
files.</p></div>
<div class="paragraph"><p>You can also specify an alternative (or additional) resource directory using the
<span class="monospaced">:resources-paths</span> key in your <em>project.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>resource<span style="color: #990000">-</span>paths <span style="color: #990000">[</span><span style="color: #FF0000">"my-resources"</span> <span style="color: #FF0000">"src/other-resources"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Using classpath-based resources is very convenient, but it does have
its drawbacks.</p></div>
<div class="paragraph"><p>Be aware that in the context of a web application, any change to
resources is likely to require a full redeployment, because they are
included wholesale in the JAR or WAR file that will be
deployed. Typically, this means it&#8217;s best to use resources only for
items that really are completely static. For example, though it&#8217;s
possible to place your application&#8217;s configuration files in the
<em>resources/</em> directory and load them from there, to do so is really to
make them part of your application&#8217;s source code, which rather defeats
the purpose. You may wish to load that kind of (relatively) frequently
changing resource in a known filesystem location and load from there
instead, rather than using the classpath.</p></div>
<div class="paragraph"><p>Also, there are sometimes additional reasons to <em>not</em> serve from the
classpath. For example, consider static images on a website. If you
place them in your web application&#8217;s classpath, then they will be
served by your application server container (Jetty, Tomcat, JBoss,
etc.). Typically, these applications are optimized for serving dynamic
HTML resources, not larger binary blobs. Serving larger static files
is often more suited to the <em>HTTP server</em> level of your architecture
than the <em>application server</em> level, and should be delegated to
Apache, Nginx, or whatever other HTTP server you&#8217;re using. Or, you
might even want to split them off and serve them via a separate
mechanism entirely, such as a content delivery network (CDN). In
either case, it is difficult to set up the HTTP server or CDN to
introspect resources <em>inside</em> of your application&#8217;s JAR file&#8212;it&#8217;s
usually better to store them elsewhere, from the start.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_82">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Leiningen
  <a href="http://bit.ly/lein-sample"><span class="monospaced">sample.project.clj</span></a>,
  which includes a more detailed description of how the <span class="monospaced">:resource-paths</span> option works
</p>
</li>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_copying_files">Copying Files</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_83">Problem</h4>
<div class="paragraph"><p>You need to copy a file on your local filesystem.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_83">Solution</h4>
<div class="paragraph"><p>Invoke <span class="monospaced">clojure.java.io/copy</span>, passing it the source and destination files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./file-to-copy.txt"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./my-new-copy.txt"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>If the input file is not found, a <span class="monospaced">java.io.FileNotFoundException</span> will be thrown:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./file-do-not-exist.txt"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./my-new-copy.txt"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.io.FileNotFoundException</span></span></tt></pre></div></div>
<div class="paragraph"><p>The input argument to <span class="monospaced">copy</span> doesn&#8217;t have to be a file; it can be an
<span class="monospaced">InputStream</span>, a <span class="monospaced">Reader</span>, a byte array, or a string. This makes it
easier to copy the data you are working with directly to the output
file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy <span style="color: #FF0000">"some text"</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./str-test.txt"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>If required, an encoding can be specified by the <span class="monospaced">:encoding</span> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy <span style="color: #FF0000">"some text"</span>
                      <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./str-test.txt"</span><span style="color: #990000">)</span>
                      <span style="color: #990000">:</span>encoding <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_83">Discussion</h4>
<div class="paragraph"><p>Note that if the file already exists, it will be overwritten. If that
is not what you want, you can put together a "safe" copy function that
will catch any exceptions and optionally overwrite:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> safe<span style="color: #990000">-</span>copy <span style="color: #990000">[</span>source<span style="color: #990000">-</span>path destination<span style="color: #990000">-</span>path <span style="color: #990000">&amp;</span> opts<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>source <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file source<span style="color: #990000">-</span>path<span style="color: #990000">)</span>
        destination <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file destination<span style="color: #990000">-</span>path<span style="color: #990000">)</span>
        options <span style="font-weight: bold"><span style="color: #000000">(merge</span></span> {<span style="color: #990000">:</span>overwrite false} <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> hash<span style="color: #990000">-</span>map opts<span style="color: #990000">))]</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(and</span></span> <span style="color: #990000">(.</span>exists source<span style="color: #990000">)</span>                                     <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
             <span style="font-weight: bold"><span style="color: #000000">(or</span></span> <span style="color: #990000">(:</span>overwrite options<span style="color: #990000">)</span>
                 <span style="color: #990000">(=</span> false <span style="color: #990000">(.</span>exists destination<span style="color: #990000">))))</span>
      <span style="font-weight: bold"><span style="color: #000000">(try</span></span>
        <span style="font-weight: bold"><span style="color: #000000">(nil</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy source destination<span style="color: #990000">))</span>          <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span>
        <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> Exception e <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"exception: "</span> <span style="color: #990000">(.</span>getMessage e<span style="color: #990000">))))</span>
      false<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>copy <span style="color: #FF0000">"./file-to-copy.txt"</span> <span style="color: #FF0000">"./my-new-copy.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>
<span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>copy <span style="color: #FF0000">"./file-to-copy.txt"</span> <span style="color: #FF0000">"./my-new-copy.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>copy <span style="color: #FF0000">"./file-to-copy.txt"</span> <span style="color: #FF0000">"./my-new-copy.txt"</span> <span style="color: #990000">:</span>overwrite true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">safe-copy</span> function takes the source and destination file paths to copy from and to. It also takes a number of key/value pairs as options.</p></div>
<div class="colist arabic"><ol>
<li>
<p>
These options are then merged with the default values. In this
    example, there is only one option, <span class="monospaced">:overwrite</span>, but with this
    structure for optional arguments, you can easily add your own (such
    as <span class="monospaced">:encoding</span> if needed).
</p>
</li>
<li>
<p>
After the options have been processed, the function checks whether the
    destination file exists, and if so, if it should be overwritten. If
    all is OK, it will then perform the <span class="monospaced">copy</span> inside a <span class="monospaced">try-catch</span>
    body.
</p>
</li>
<li>
<p>
Note the test for <span class="monospaced">nil?</span> when the file is copied.
    If you add this, you will always get a Boolean value from the
    function. This makes the function more convenient to use, since
    you can then conditionally check whether the operation succeed or not.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can also use <span class="monospaced">clojure.java.io/copy</span> with a <span class="monospaced">java.io.Reader</span> and a <span class="monospaced">java.io.Writer</span>, as well as with streams:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>reader <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader <span style="color: #FF0000">"file-to-copy.txt"</span><span style="color: #990000">)</span>
            writer <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"my-new-copy.txt"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>copy reader writer<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The same efficiency considerations that apply to reading and writing to a file in regard to selecting input and output sources from <span class="monospaced">File</span>, <span class="monospaced">Reader</span>, <span class="monospaced">Writer</span>, or streams should be applied to <span class="monospaced">copy</span>. See <a href="#sec_local-io_read_write_files">[sec_local-io_read_write_files]</a>, for more information.</p></div>
<div class="paragraph"><p>By default, a buffer size of 1,024 bytes is used when calling <span class="monospaced">copy</span>. That is the amount of data that will be read from the source and written to the destination in one pass. This is done until the complete source has been copied. The buffer size used can be changed with the <span class="monospaced">:buffer-size</span> option. Keeping this number low would cause more file access operations but would keep less data in memory. On the other hand, increasing the buffer size will lower the number of file accesses but will require more data to be loaded into memory.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_83">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">clojure.java.io</span>'s <a href="http://bit.ly/clj-java-io-api">API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_files_or_directories">Deleting Files or Directories</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_84">Problem</h4>
<div class="paragraph"><p>You need to delete a file from your local filesystem.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_84">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">clojure.java.io/delete-file</span> to delete the file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file <span style="color: #FF0000">"./file-to-delete.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;re trying to delete a file that does not exist, a <span class="monospaced">java.io.IOException</span>
will be thrown:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file <span style="color: #FF0000">"./file-that-does-not-exist.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.io.IOException: Couldn't delete</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you do not want <span class="monospaced">delete-file</span> to throw exceptions when the given
file could not be deleted for whatever reason, you can add the
<span class="monospaced">silently</span> flag set to <span class="monospaced">true</span> to the arguments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file <span style="color: #FF0000">"./file-that-does-not-exist.txt"</span> true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_84">Discussion</h4>
<div class="paragraph"><p>For times when you want to do some custom handling of the eventual
exceptions thrown, you should put the call to <span class="monospaced">delete-file</span> inside a
<span class="monospaced">try-catch</span> body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(try</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file <span style="color: #FF0000">"./file-that-does-not-exist.txt"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> Exception e <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"exception: "</span> <span style="color: #990000">(.</span>getMessage e<span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "exception: Couldn't delete ./file-that-does-not-exist.txt"</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">java.io.File</span> has an <span class="monospaced">.exists</span> property that simply gives you a
Boolean answer as to whether a file exists or not. You can put this property
together with a <span class="monospaced">try-catch</span> body to get a "safe" delete utility
function. This function will first check to see if the file with the
path from the argument exists before trying to delete it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> safe<span style="color: #990000">-</span>delete <span style="color: #990000">[</span>file<span style="color: #990000">-</span>path<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(.</span>exists <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file file<span style="color: #990000">-</span>path<span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(try</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file file<span style="color: #990000">-</span>path<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> Exception e <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"exception: "</span> <span style="color: #990000">(.</span>getMessage e<span style="color: #990000">))))</span>
    false<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>delete <span style="color: #FF0000">"./file-that-does-not-exist.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>delete <span style="color: #FF0000">"./file-to-delete.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">clojure.java.io/delete-file</span> function can also be used to delete
directories. Directories must be empty for the deletion to be
successful, so any utility function you make to delete a directory
must first delete all files in the given directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>delete<span style="color: #990000">-</span>file <span style="color: #FF0000">"./dir-to-delete"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> delete<span style="color: #990000">-</span>directory <span style="color: #990000">[</span>directory<span style="color: #990000">-</span>path<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>directory<span style="color: #990000">-</span>contents <span style="font-weight: bold"><span style="color: #000000">(file</span></span><span style="color: #990000">-</span>seq <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file directory<span style="color: #990000">-</span>path<span style="color: #990000">))</span>
        files<span style="color: #990000">-</span>to<span style="color: #990000">-</span>delete <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #<span style="color: #990000">(.</span>isFile <span style="color: #990000">%)</span> directory<span style="color: #990000">-</span>contents<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>file files<span style="color: #990000">-</span>to<span style="color: #990000">-</span>delete<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>delete <span style="color: #990000">(.</span>getPath file<span style="color: #990000">)))</span>
    <span style="font-weight: bold"><span style="color: #000000">(safe</span></span><span style="color: #990000">-</span>delete directory<span style="color: #990000">-</span>path<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(delete</span></span><span style="color: #990000">-</span>directory <span style="color: #FF0000">"./dir-to-delete"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">delete-directory</span> function will get a <span class="monospaced">file-seq</span> with the
contents of the given path. It will then filter to only get the files
of that directory. The next step is to delete all the files, and then
finish up by deleting the directory itself. Note the call to <span class="monospaced">doseq</span>.
If you do not call <span class="monospaced">doseq</span>, the deletion of the files would be lazy and
then the files would still exist when the call to delete the actual
directory was made, so that call would fail.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_84">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">clojure.java.io</span>'s <a href="http://bit.ly/clj-java-io-api">API documentation</a>
</p>
</li>
<li>
<p>
<a href="#sec_local-io_files_get_files_from_dir">[sec_local-io_files_get_files_from_dir]</a>, for more details on using a <span class="monospaced">file-seq</span> to get the files from a directory
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local-io_files_get_files_from_dir">Listing Files in a Directory</h3>
<div class="paragraph byline"><p>by Ryan Neufeld and Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_85">Problem</h4>
<div class="paragraph"><p>Given a directory, you want to access the files inside.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_85">Solution</h4>
<div class="paragraph"><p>Call the built-in <span class="monospaced">file-seq</span> function.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>To follow along with this recipe, create some sample files and folders
using these commands (on Linux or Mac):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ mkdir -p next-gen
$ touch next-gen/picard<span style="color: #990000">.</span>jpg next-gen/locutus<span style="color: #990000">.</span>bmp next-gen/data<span style="color: #990000">.</span>txt</tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><span class="monospaced">file-seq</span> returns a lazy sequence
of <span class="monospaced">java.io.File</span> objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> tng<span style="color: #990000">-</span>dir <span style="font-weight: bold"><span style="color: #000000">(file</span></span><span style="color: #990000">-</span>seq <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"./next-gen"</span><span style="color: #990000">)))</span>

tng<span style="color: #990000">-</span>dir
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#&lt;File ./next-gen&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;File ./next-gen/picard.jpg&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;File ./next-gen/locutus.bmp&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;File ./next-gen/data.txt&gt;)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_85">Discussion</h4>
<div class="paragraph"><p>Sequences are one of Clojure&#8217;s more powerful abstractions; treating a
directory hierarchy as a sequence allows you to leverage functions like
<span class="monospaced">map</span> and <span class="monospaced">filter</span> to manipulate files and directories.</p></div>
<div class="paragraph"><p>Consider, for example, the case where you would like to select only files in a
directory hierarchy (and not directories). You can define such a function
by taking a sequence of files and directories and filtering them by the
<span class="monospaced">.isFile</span> property of <span class="monospaced">java.io.File</span> objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> only<span style="color: #990000">-</span>files
  <span style="color: #FF0000">"Filter a sequence of files/directories by the .isFile property of</span>
<span style="color: #FF0000">  java.io.File"</span>
  <span style="color: #990000">[</span>file<span style="color: #990000">-</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #<span style="color: #990000">(.</span>isFile <span style="color: #990000">%)</span> file<span style="color: #990000">-</span>s<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(only</span></span><span style="color: #990000">-</span>files tng<span style="color: #990000">-</span>dir<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (#&lt;File ./next-gen/data.txt&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;File ./next-gen/locutus.bmp&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     #&lt;File ./next-gen/picard.jpg&gt;)</span></span></tt></pre></div></div>
<div class="paragraph"><p>What if you want to display the string names of all those files? Define
a <span class="monospaced">names</span> function to map the <span class="monospaced">.getName</span> property over a sequence of
files, combining <span class="monospaced">only-files</span> and <span class="monospaced">names</span> to get a list of filenames
in a directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> names
  <span style="color: #FF0000">"Return the .getName property of a sequence of files"</span>
  <span style="color: #990000">[</span>file<span style="color: #990000">-</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="color: #990000">(.</span>getName <span style="color: #990000">%)</span> file<span style="color: #990000">-</span>s<span style="color: #990000">))</span>

<span style="color: #990000">(-&gt;</span> tng<span style="color: #990000">-</span>dir
    only<span style="color: #990000">-</span>files
    names<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("data.txt" "locutus.bmp" "picard.jpg")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_85">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The documentation for the <a href="http://bit.ly/javadoc-file"><span class="monospaced">File</span> class</a> for a complete list of properties and methods available on <span class="monospaced">File</span> objects.
</p>
</li>
<li>
<p>
Combine these techniques with utility libraries like Google Guava&#8217;s <a href="http://bit.ly/guava-files"><span class="monospaced">Files</span> class</a> or Apache Commons <a href="http://bit.ly/commons-io-filename-utils"><span class="monospaced">FilenameUtils</span> class</a> to exert even greater leverage over the file sequence abstraction.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_memory_mapping_a_file">Memory Mapping a File</h3>
<div class="paragraph byline"><p>by Alan Busby</p></div>
<div class="sect3">
<h4 id="_problem_86">Problem</h4>
<div class="paragraph"><p>You want to use memory mapping to access a large file as though it
were fully loaded into memory, without actually loading the whole thing.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_86">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/thebusby/clj-mmap"><span class="monospaced">clj-mmap</span></a> library,
which wraps the memory-mapping functionality provided by Java&#8217;s NIO (New I/O) library.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-mmap "1.1.2"]</span> to your project’s dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-mmap</tt></pre></div></div>
<div class="paragraph"><p>To read the first and last <em>N</em> bytes of UTF-8 encoded text file, use the
<span class="monospaced">get-bytes</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>mmap <span style="color: #990000">:</span>as mmap<span style="color: #990000">])</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>file <span style="font-weight: bold"><span style="color: #000000">(mmap</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>mmap <span style="color: #FF0000">"/path/to/file/file.txt"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>n<span style="color: #990000">-</span>bytes       <span style="color: #993399">10</span>
        file<span style="color: #990000">-</span>size     <span style="color: #990000">(.</span>size file<span style="color: #990000">)</span>
        first<span style="color: #990000">-</span>n<span style="color: #990000">-</span>bytes <span style="font-weight: bold"><span style="color: #000000">(mmap</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>bytes file <span style="color: #993399">0</span> n<span style="color: #990000">-</span>bytes<span style="color: #990000">)</span>
        last<span style="color: #990000">-</span>n<span style="color: #990000">-</span>bytes  <span style="font-weight: bold"><span style="color: #000000">(mmap</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>bytes file <span style="color: #990000">(-</span> file<span style="color: #990000">-</span>size n<span style="color: #990000">-</span>bytes<span style="color: #990000">)</span> n<span style="color: #990000">-</span>bytes<span style="color: #990000">)]</span>
    <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> first<span style="color: #990000">-</span>n<span style="color: #990000">-</span>bytes <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span>
     <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> last<span style="color: #990000">-</span>n<span style="color: #990000">-</span>bytes  <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)]))</span></tt></pre></div></div>
<div class="paragraph"><p>To overwrite the first <em>N</em> bytes of a text file, call <span class="monospaced">put-bytes</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>file <span style="font-weight: bold"><span style="color: #000000">(mmap</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>mmap <span style="color: #FF0000">"/path/to/file/file.txt"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>bytes<span style="color: #990000">-</span>to<span style="color: #990000">-</span>write <span style="color: #990000">(.</span>getBytes <span style="color: #FF0000">"New text goes here"</span> <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span>
        file<span style="color: #990000">-</span>size      <span style="color: #990000">(.</span>size file<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(&gt;</span> file<span style="color: #990000">-</span>size
           <span style="font-weight: bold"><span style="color: #000000">(alength</span></span> bytes<span style="color: #990000">-</span>to<span style="color: #990000">-</span>write<span style="color: #990000">))</span>
      <span style="font-weight: bold"><span style="color: #000000">(mmap</span></span><span style="color: #990000">/</span>put<span style="color: #990000">-</span>bytes file bytes<span style="color: #990000">-</span>to<span style="color: #990000">-</span>write <span style="color: #993399">0</span><span style="color: #990000">))))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_86">Discussion</h4>
<div class="paragraph"><p>Memory mapping, or <em>mmap</em> per the POSIX standard, is a method of leveraging the operating system&#8217;s virtual memory to perform file I/O.
By mapping the file into the applications memory space, copying
between buffers is reduced, and I/O performance is increased.</p></div>
<div class="paragraph"><p>Memory-mapped files are especially useful when working with large files,
structured binary data, or text files where Java&#8217;s <span class="monospaced">String</span> overhead may be
unwelcome.</p></div>
<div class="paragraph"><p>While Clojure makes it simple to work with Java&#8217;s NIO primitives directly,
NIO makes working with files larger than 2 GB especially difficult. <span class="monospaced">clj-mmap</span>
wraps this complexity, but it doesn&#8217;t expose all the features
that NIO does. The NIO Java API is still available via interop, should it be needed.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_86">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://bit.ly/wiki-mmap"><span class="monospaced">mmap</span> Wikipedia article</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">clj-mmap</span> <a href="https://github.com/thebusby/clj-mmap">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local-io_read_write_files">Reading and Writing Text Files</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_87">Problem</h4>
<div class="paragraph"><p>You need to read or write a text file to the local filesystem.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_87">Solution</h4>
<div class="paragraph"><p>Write a string to a file with the built-in <span class="monospaced">spit</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"stuff.txt"</span> <span style="color: #FF0000">"all my stuff"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Read the contents of a file with the built-in <span class="monospaced">slurp</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="color: #FF0000">"stuff.txt"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "all my stuff"</span></span></tt></pre></div></div>
<div class="paragraph"><p>If required, an encoding can be specified with the <span class="monospaced">:encoding</span> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="color: #FF0000">"stuff.txt"</span> <span style="color: #990000">:</span>encoding <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "all my stuff"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Append data to an existing file using the <span class="monospaced">:append true</span> option to <span class="monospaced">spit</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"stuff.txt"</span> <span style="color: #FF0000">"even more stuff"</span> <span style="color: #990000">:</span>append true<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To read a file line by line, instead of loading the entire contents
into memory at once, use a <span class="monospaced">java.io.Reader</span> together with the <span class="monospaced">line-seq</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>r <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader <span style="color: #FF0000">"stuff.txt"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>line <span style="font-weight: bold"><span style="color: #000000">(line</span></span><span style="color: #990000">-</span>seq r<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> line<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>To write a large amount of data to a file without realizing it all as
a string, use a <span class="monospaced">java.io.Writer</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>w <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"stuff.txt"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>line some<span style="color: #990000">-</span>large<span style="color: #990000">-</span>seq<span style="color: #990000">-</span>of<span style="color: #990000">-</span>strings<span style="color: #990000">]</span>
    <span style="color: #990000">(.</span>write w line<span style="color: #990000">)</span>
    <span style="color: #990000">(.</span>newLine w<span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_87">Discussion</h4>
<div class="paragraph"><p>When using <span class="monospaced">:append</span>, text will be appended to the end of the
file. Use newlines at the end of each line by appending <span class="monospaced">"\n"</span> to the
string to be printed. All lines in a text file should end with a
newline, including the last one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> spitn
  <span style="color: #FF0000">"Append to file with newline"</span>
  <span style="color: #990000">[</span>path text<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(spit</span></span> path <span style="font-weight: bold"><span style="color: #000000">(str</span></span> text <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span> <span style="color: #990000">:</span>append true<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>When used with strings, <span class="monospaced">spit</span> and <span class="monospaced">slurp</span> deal with the entire
contents of a file at a time and close the file after reading or
writing. If you need to read or write a lot of data, it is more
efficient (in terms of both memory and time) to use a streaming API
such as <span class="monospaced">java.io.Reader</span> or <span class="monospaced">java.io.Writer</span>, since they do not
require realizing the contents of the file in memory.</p></div>
<div class="paragraph"><p>When using writers and streams, however, it is important to flush any
writes to the underlying stream in order to ensure your data is
actually written and resources are cleaned up. The <span class="monospaced">with-open</span> macro
flushes and closes the stream specified in its binding after executing
its body.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Be especially aware that any lazy sequences based on a stream
will throw an error if the underlying stream is closed before the
sequence is realized. Even when using <span class="monospaced">with-open</span>, it is possible to
return an unrealized lazy sequence; the <span class="monospaced">with-open</span> macro has no way
of knowing that the stream is still needed and so will close it
anyway, leaving a sequence that cannot be realized.</td>
</tr></table>
</div>
<div class="paragraph"><p>Generally, it is best to not let lazy sequences based on streams
escape the scope in which the stream is open. If you do, you must be
extremely careful to ensure that the resources required for the realization of a
lazy sequence are still open as long as the sequence has any
readers. Typically, the latter approach involves manually tracking
which streams are still open rather than relying on a <span class="monospaced">try/finally</span> or
<span class="monospaced">with-open</span> block.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_87">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>
</p>
</li>
<li>
<p>
The documentation for <a href="http://bit.ly/javadoc-reader"><span class="monospaced">java.io.Reader</span></a> and <a href="http://bit.ly/javadoc-writer"><span class="monospaced">java.io.Writer</span></a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_temporary_files">Using Temporary Files</h3>
<div class="paragraph byline"><p>by Alan Busby</p></div>
<div class="sect3">
<h4 id="_problem_88">Problem</h4>
<div class="paragraph"><p>You want to use a temporary file on the local filesystem.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_88">Solution</h4>
<div class="paragraph"><p>Use the static method <span class="monospaced">createTempFile</span> of Java&#8217;s built-in
<span class="monospaced">java.io.File</span> class to create a temporary file in the default
temporary-file directory of the JVM, with the provided prefix and
suffix:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> my<span style="color: #990000">-</span>temp<span style="color: #990000">-</span>file <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io<span style="color: #990000">.</span>File<span style="color: #990000">/</span>createTempFile <span style="color: #FF0000">"filename"</span> <span style="color: #FF0000">".txt"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>You can then write to the temporary file like you would to any other
instance of <span class="monospaced">java.io.File</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>file <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer my<span style="color: #990000">-</span>temp<span style="color: #990000">-</span>file<span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> file<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Example output."</span><span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_88">Discussion</h4>
<div class="paragraph"><p>Temporary files are often quite useful to interact with other programs
that prefer a file-based API. Using <span class="monospaced">createTempFile</span> is important to
ensure that temporary files are placed in an appropriate location on
the filesystem, which can differ based on the operating system being
used.</p></div>
<div class="paragraph"><p>To get the full path and filename for the created temporary file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>getAbsolutePath my<span style="color: #990000">-</span>temp<span style="color: #990000">-</span>file<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You can use the <span class="monospaced">File.deleteOnExit</span> method to mark the temporary file
to be deleted automatically when the JVM exits:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>deleteOnExit my<span style="color: #990000">-</span>temp<span style="color: #990000">-</span>file<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the file is not actually deleted until the JVM terminates
and may not be deleted if the process crashes or exits abnormally. It
is good practice to delete temporary files immediately when they are no
longer being used:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>delete my<span style="color: #990000">-</span>temp<span style="color: #990000">-</span>file<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_88">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">java.io.File</span> <a href="http://bit.ly/javadoc-file">API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local-random-access-files">Reading and Writing Files at Arbitrary Positions</h3>
<div class="paragraph byline"><p>by John Jacobsen</p></div>
<div class="sect3">
<h4 id="_problem_89">Problem</h4>
<div class="paragraph"><p>You want to read data from a file, or write data to it, at various
locations rather than sequentially.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_89">Solution</h4>
<div class="paragraph"><p>To open a (potentially very large) file for random access, use Java&#8217;s
<span class="monospaced">RandomAccessFile</span>. <span class="monospaced">seek</span> to the location you desire, then use
the various <span class="monospaced">write</span> methods to write data at that location.</p></div>
<div class="paragraph"><p>For example, to make a 1 GB file filled with zeros except the
integer 1,234 at the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>io RandomAccessFile<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(doto</span></span> <span style="font-weight: bold"><span style="color: #000000">(RandomAccessFile</span></span><span style="color: #990000">.</span> <span style="color: #FF0000">"/tmp/longfile"</span> <span style="color: #FF0000">"rw"</span><span style="color: #990000">)</span>
  <span style="color: #990000">(.</span>seek <span style="color: #990000">(*</span> <span style="color: #993399">1000</span> <span style="color: #993399">1000</span> <span style="color: #993399">1000</span><span style="color: #990000">))</span>
  <span style="color: #990000">(.</span>writeInt <span style="color: #993399">1234</span><span style="color: #990000">)</span>
  <span style="color: #990000">(.</span>close<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Getting the <span class="monospaced">length</span> of a "normal" Java file object shows that the file is
the correct size:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>file<span style="color: #990000">]])</span>
<span style="color: #990000">(.</span>length <span style="font-weight: bold"><span style="color: #000000">(file</span></span> <span style="color: #FF0000">"/tmp/longfile"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1000000004</span></span></tt></pre></div></div>
<div class="paragraph"><p>(You can also call <span class="monospaced">length</span> on a <span class="monospaced">RandomAccessFile</span> directly.)</p></div>
<div class="paragraph"><p>Reading a value back from the proper location in Clojure is quite
similar to writing. Again, <span class="monospaced">seek</span> a <span class="monospaced">RandomAccessFile</span>. Then use
the appropriate <span class="monospaced">read</span> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>raf <span style="font-weight: bold"><span style="color: #000000">(RandomAccessFile</span></span><span style="color: #990000">.</span> <span style="color: #FF0000">"/tmp/longfile"</span> <span style="color: #FF0000">"r"</span><span style="color: #990000">)</span>
      _ <span style="color: #990000">(.</span>seek raf <span style="color: #990000">(*</span> <span style="color: #993399">1000</span> <span style="color: #993399">1000</span> <span style="color: #993399">1000</span><span style="color: #990000">))</span>
      result <span style="color: #990000">(.</span>readInt raf<span style="color: #990000">)]</span>
  <span style="color: #990000">(.</span>close raf<span style="color: #990000">)</span>
  result<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1234</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_89">Discussion</h4>
<div class="paragraph"><p>Files written in this way are populated by zeros by default and may be
treated as "sparse files" by the JVM implementation and the underlying
operating system, leading to extra efficiency in reading and writing.</p></div>
<div class="paragraph"><p>Examining the file we created using the Unix <span class="monospaced">od</span> program to do a hex dump from the
command line shows that the file consists of zeros with our <span class="monospaced">1234</span> at
the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ od -Ad -tx<span style="color: #993399">4</span> /tmp/longfile
<span style="color: #993399">0000000</span>          <span style="color: #993399">00000000</span>        <span style="color: #993399">00000000</span>        <span style="color: #993399">00000000</span>        <span style="color: #993399">00000000</span>
<span style="color: #990000">*</span>
<span style="color: #993399">1000000000</span>          d2040000
<span style="color: #993399">1000000004</span></tt></pre></div></div>
<div class="paragraph"><p>At byte offset 1000000000 can be seen the value <span class="monospaced">d2040000</span>, which is
the hex representation of a big-endian integer with the value 1,234.
(Java integers are big-endian by default. This means that the highest-order bytes are stored at the lowest addresses.)</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_89">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>, for information on reading entire files
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/javadoc-raf"><span class="monospaced">java.io.RandomAccessFile</span></a> API documentation
</p>
</li>
<li>
<p>
The Unix <a href="http://bit.ly/wiki-od"><span class="monospaced">od</span></a> command
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_parallelizing_file_processing">Parallelizing File Processing</h3>
<div class="paragraph byline"><p>by Edmund Jackson</p></div>
<div class="sect3">
<h4 id="_problem_90">Problem</h4>
<div class="paragraph"><p>You want to transform a text file line by line, but using all cores and
without loading it into memory.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_90">Solution</h4>
<div class="paragraph"><p>A quick win using <span class="monospaced">pmap</span> over a sequence returned by <span class="monospaced">line-seq</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> <span style="color: #990000">[</span>'clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>as 'jio<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> pmap<span style="color: #990000">-</span>file
  <span style="color: #FF0000">"Process input-file in parallel, applying processing-fn to each row</span>
<span style="color: #FF0000">  outputting into output-file"</span>
  <span style="color: #990000">[</span>processing<span style="color: #990000">-</span>fn input<span style="color: #990000">-</span>file output<span style="color: #990000">-</span>file<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>rdr <span style="font-weight: bold"><span style="color: #000000">(jio</span></span><span style="color: #990000">/</span>reader input<span style="color: #990000">-</span>file<span style="color: #990000">)</span>
              wtr <span style="font-weight: bold"><span style="color: #000000">(jio</span></span><span style="color: #990000">/</span>writer output<span style="color: #990000">-</span>file<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>lines <span style="font-weight: bold"><span style="color: #000000">(line</span></span><span style="color: #990000">-</span>seq rdr<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(dorun</span></span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="color: #990000">(.</span>write wtr <span style="color: #990000">%)</span>
            <span style="font-weight: bold"><span style="color: #000000">(pmap</span></span> processing<span style="color: #990000">-</span>fn lines<span style="color: #990000">))))))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Example of calling this</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> accumulator <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> <span style="color: #993399">0</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span> example<span style="color: #990000">-</span>row<span style="color: #990000">-</span>fn
  <span style="color: #FF0000">"Trivial example"</span>
  <span style="color: #990000">[</span>row<span style="color: #990000">-</span>string<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span> row<span style="color: #990000">-</span>string <span style="color: #FF0000">","</span> <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> accumulator inc<span style="color: #990000">)</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Call it</span></span>
<span style="font-weight: bold"><span style="color: #000000">(pmap</span></span><span style="color: #990000">-</span>file example<span style="color: #990000">-</span>row<span style="color: #990000">-</span>fn <span style="color: #FF0000">"input.txt"</span> <span style="color: #FF0000">"output.txt"</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_90">Discussion</h4>
<div class="paragraph"><p>The key functions used in this example (beyond basic Clojure
constructs like <span class="monospaced">map</span> or <span class="monospaced">dorun</span>) are <span class="monospaced">line-seq</span> and <span class="monospaced">pmap</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">line-seq</span>, given an instance of <span class="monospaced">java.io.BufferedReader</span> (which
<span class="monospaced">clojure.java.io/reader</span> returns), will return a lazy sequence of
strings. Each string is a line in the input file. What constitutes a
newline for the purposes of line splitting is determined by the
<span class="monospaced">line.separator</span> JVM option, which will be set in a platform-specific
way. Specifically, it will be a carriage return character followed by
a line feed character in Windows, and a single newline character in
Unix-derived systems such as Linux or Mac OS X.</p></div>
<div class="paragraph"><p><span class="monospaced">pmap</span> functions identically to <span class="monospaced">map</span> and applies a function to each
item in a sequence, returning a lazy sequence of return values. The
difference is that as it applies the mapping function, it does so in a
separate thread for each item in the collection (up to a certain fixed
number of threads related to the number of CPUs on your system).
Threads realizing the sequence will block if the values are not ready
yet.</p></div>
<div class="paragraph"><p><span class="monospaced">pmap</span> can yield substantial performance improvements by distributing
work across multiple CPU cores and performing it concurrently, but it
isn&#8217;t a magic bullet. Specifically, it incurs a certain amount of
coordination overhead to schedule the multithreaded
operations. Typically, it gives the most benefit when performing very
heavyweight operations, where the mapping function is so
computationally expensive that it makes the coordination overhead
worth it. For simple functions that complete very quickly (such as
basic operations on primitives), the coordination overhead is likely
to be much larger than any performance gains, and <span class="monospaced">pmap</span> will actually
be much slower than <span class="monospaced">map</span> in that case.</p></div>
<div class="paragraph"><p>The idea is to use <span class="monospaced">pmap</span> to map over the sequence of file rows in
parallel. However, you then need to pass each processed row through
<literal>(map #(.write wtr %) ...)</literal> in order to ensure the rows are written
one at a time (put the <span class="monospaced">write</span> in the processing function to see what
happens otherwise). Finally, as these are lazy sequences, you need to
realize their side effects before exiting the <span class="monospaced">with-open</span> block or the
file will be closed by the time you wish to evaluate them. This is
accomplished by calling <span class="monospaced">dorun</span>.</p></div>
<div class="paragraph"><p>There are a couple of caveats here. Firstly, although the row ordering
of the output file will match that of the input, the execution order
is not guaranteed. Secondly, the process will become I/O-bound quite
quickly as all the writes happen on one thread, so you may not get the
speedup you expect unless the processing function is substantial.
Finally, <span class="monospaced">pmap</span> is not perfectly efficient at allocating work, so the
degree of speedup you see might not correspond exactly to the number
of processors on your system, as you might expect.</p></div>
<div class="paragraph"><p>Another drawback to the <span class="monospaced">pmap</span> approach is that the actual reading of
the file is serialized, using a single <span class="monospaced">java.io.Reader</span>. Considerable
gains can still be realized if the processing task is expensive
compared to reading, but in lightweight tasks the bottleneck is likely
to be reading the file itself, in which case parallelizing the
processing work will give little to no gains in terms of total
runtime (or even make it worse).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_90">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#rec_local_io_parallelizing_using_iota">[rec_local_io_parallelizing_using_iota]</a>, for a similar approach that parallelizes reading the file itself using
memory mapping (as well as using Clojure reducers for greater
efficiency)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="rec_local_io_parallelizing_using_iota">Parallelizing File Processing with Reducers</h3>
<div class="paragraph byline"><p>by Edmund Jackson</p></div>
<div class="sect3">
<h4 id="_problem_91">Problem</h4>
<div class="paragraph"><p>You want to use Clojure&#8217;s reducers on a file to realize parallel
processing without loading the file into memory.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_91">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/thebusby/iota">Iota</a> library in
conjunction with the <span class="monospaced">filter</span>, <span class="monospaced">map</span>, and <span class="monospaced">fold</span> functions from the
Clojure Reducers library in the <span class="monospaced">clojure.core.reducers</span> namespace. To follow along with this recipe, add <span class="monospaced">[iota "1.1.1"]</span> to your project&#8217;s dependencies, or start a REPL with <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try iota</tt></pre></div></div>
<div class="paragraph"><p>To count the words in a very large file, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>iota                  <span style="color: #990000">:</span>as io<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>reducers <span style="color: #990000">:</span>as r<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>string        <span style="color: #990000">:</span>as str<span style="color: #990000">])</span>


<span style="font-style: italic"><span style="color: #9A1900">;; Word-counting functions</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> count<span style="color: #990000">-</span>map
  <span style="color: #FF0000">"Returns a map of words to occurence count in the given string"</span>
  <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>m w<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in m <span style="color: #990000">[</span>w<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(fnil</span></span> inc <span style="color: #993399">0</span><span style="color: #990000">)))</span>
          {}
          <span style="font-weight: bold"><span style="color: #000000">(str</span></span><span style="color: #990000">/</span>split s #<span style="color: #FF0000">" "</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add<span style="color: #990000">-</span>maps
  <span style="color: #FF0000">"Returns a map where each key is the sum of vals of that key in m1 and m2."</span>
  <span style="color: #990000">([]</span> {}<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">;; Necessary base case for use as combiner in fold</span></span>
  <span style="color: #990000">([</span>m1 m2<span style="color: #990000">]</span>
     <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>m <span style="color: #990000">[</span>k v<span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in m <span style="color: #990000">[</span>k<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(fnil</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">+</span> v<span style="color: #990000">)</span> <span style="color: #993399">0</span><span style="color: #990000">)))</span> m1 m2<span style="color: #990000">)))</span>


<span style="font-style: italic"><span style="color: #9A1900">;; Main file processing</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> keyword<span style="color: #990000">-</span>count
  <span style="color: #FF0000">"Returns a map of the word counts"</span>
  <span style="color: #990000">[</span>filename<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(iota</span></span><span style="color: #990000">/</span>seq filename<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(r</span></span><span style="color: #990000">/</span>filter identity<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(r</span></span><span style="color: #990000">/</span>map count<span style="color: #990000">-</span>map<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(r</span></span><span style="color: #990000">/</span>fold add<span style="color: #990000">-</span>maps<span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_91">Discussion</h4>
<div class="paragraph"><p>The Iota library creates sequences from files on the local filesystem. Unlike the purely sequential lazy sequences produced from
something like <span class="monospaced">file-seq</span>, the sequences returned by Iota are
optimized for use with Clojure&#8217;s Reducers library, which uses the Java
Fork/Join work-stealing framework<span class="footnote"><br>[For more information, see
the Java
<a href="http://bit.ly/forkjoin-tut">tutorial</a>
on Fork/Join and work stealing.]<br></span> under the hood to provide efficient
parallel processing.</p></div>
<div class="paragraph"><p>The <span class="monospaced">keyword-count</span> function first creates a reducible sequence of
lines in the file and filters out blank lines (using the <span class="monospaced">identity</span>
function to eliminate <span class="monospaced">nil</span> values from the sequence). Then it applies
the <span class="monospaced">count-map</span> function in parallel, and finally aggregates the
results by folding with the <span class="monospaced">add-maps</span> function.</p></div>
<div class="paragraph"><p><span class="monospaced">r/filter</span> and <span class="monospaced">r/map</span> function exactly the same as their non-Reducer
counterparts; the only difference is one of performance, and how the
Reducers library is able to break down and combine operations. They
also return reducible sequences that can be utilized efficiently by
other operations from the Reducers library.</p></div>
<div class="paragraph"><p><span class="monospaced">r/fold</span> is the core function of the Reducers library, and in its
basic form it is functionally very similar to the built-in <span class="monospaced">reduce</span>
function. Given a function and a reducible collection, it returns a
value that is the result of applying the folding function to each item
in the collection and an accumulator value.</p></div>
<div class="paragraph"><p>Unlike with normal <span class="monospaced">reduce</span>, however, there is no guaranteed execution
order, which is why <span class="monospaced">fold</span> doesn&#8217;t take a single starting value as
an argument. It wouldn&#8217;t make sense, given that the computation can
"start" in several places at once, concurrently. This means that the
function passed to <span class="monospaced">fold</span> (when passed a single function) must also
be capable of taking <em>zero</em> arguments&#8212;the result of the no-arg
invocation of the provided function will be used as the seed value for each
branch of the computation.</p></div>
<div class="paragraph"><p>If you need more flexibility than this provides, <span class="monospaced">fold</span> allows you to
specify both a <span class="monospaced">reduce</span> function and a <span class="monospaced">combine</span> function, as separate
arguments. Exactly what these do is inextricably tied to how
Reducers themselves work, so a full explanation is beyond the scope of
this recipe. See the
<a href="http://bit.ly/reducers-fold-doc">API documentation
for the <span class="monospaced">fold</span> function</a> and the links on the
<a href="http://clojure.org/reducers">Reducers page</a> on Clojure&#8217;s website for
more information.</p></div>
<div class="sect4">
<h5 id="_about_reducers">About Reducers</h5>
<div class="paragraph"><p>Reducers is a parallel execution framework for extremely efficient
parallel processing. A full explanation of how reducers work is beyond the scope of this recipe (see <a href="http://bit.ly/reducers-post">the blog post</a> introducing reducers on the Clojure website for a comprehensive treatment).</p></div>
<div class="paragraph"><p>In short, however, reducers provide performance by two means:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
They can compose operations. Wherever logically possible, the
reducers framework will collapse composable operations into a single
operation. For example, the <phrase role='keep-together'>preceding</phrase> code performs a <span class="monospaced">filter</span> and then a
<span class="monospaced">map</span>. Clojure&#8217;s standard <span class="monospaced">filter</span> and <span class="monospaced">map</span> would realize an
intermediate sequence: <span class="monospaced">filter</span> would produce a sequence that would
then be fed to <span class="monospaced">map</span>. The reducer versions, however, can compose
themselves (if possible) to produce a single <span class="monospaced">map+filter</span> operation
that can be applied in one shot.
</p>
</li>
<li>
<p>
They exploit the internal tree-like data structures of the data
being reduced. Regular sequences are inherently sequential (no
surprise), and because their performant operation is to pull items
from the beginning one at a time, it&#8217;s difficult to efficiently
distribute work across their members. However, Reducers is aware of
the internal structure of Clojure&#8217;s persistent data structures and can
leverage that to efficiently distribute worker processes across the
data.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Under the hood, Iota uses the Java NIO libraries to provide a
<em>memory-mapped</em> view of the file being processed that provides
efficient random access. Iota is also aware of the Reducers framework,
and Iota sequences are structured in such a way that Reducers can
effectively distribute worker processes across them.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_91">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Iota <a href="https://github.com/thebusby/iota">GitHub repository</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/javadoc-nio">NIO&#8217;s documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local_io_clojure_data_to_disk">Reading and Writing Clojure Data</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_92">Problem</h4>
<div class="paragraph"><p>You need to store and retrieve Clojure data structures on disk.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_92">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">pr-str</span> and <span class="monospaced">spit</span> to serialize small amounts of data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"data.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">read-string</span> and <span class="monospaced">slurp</span> to read small amounts of data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="color: #FF0000">"data.clj"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:a :b :c]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">pr</span> to efficiently write large data structures to a stream:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>w <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"data.clj"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> w<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(pr</span></span> large<span style="color: #990000">-</span>data<span style="color: #990000">-</span>structure<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">read</span> to efficiently read large data structures from a stream:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>r <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io<span style="color: #990000">.</span>PushbackReader<span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader <span style="color: #FF0000">"data.clj"</span><span style="color: #990000">))]</span>
  <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>read<span style="color: #990000">-</span>eval<span style="color: #990000">*</span> false<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(read</span></span> r<span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_92">Discussion</h4>
<div class="paragraph"><p>The fact that code is data in Clojure and that you have runtime
access to the same reader the language uses to load source code from
files makes this a relatively simple task. However, while this is
often a good way to persist data to disk, you should be aware of a few
issues.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Reading, Security, and edn</div>
<div class="paragraph"><p>The <span class="monospaced">read</span> function is only appropriate for reading data from
<em>trusted</em> sources. This is because the Clojure reader is neither designed
nor guaranteed to be safe or free from side effects. Binding
<span class="monospaced">*read-eval*</span> to <span class="monospaced">false</span> is just a small safeguard. If you need to
read Clojure data structures from <em>untrusted</em> sources (i.e., anything
you did not write yourself), then see the <span class="monospaced">clojure.edn</span> library.</p></div>
<div class="paragraph"><p>edn (extensible data notation) is a specification of Clojure&#8217;s data
structure serialization format with multiple implementations, so it
can be used as a transport and persistence format and consumed from
programs written in any language, much like XML or JSON. The
<span class="monospaced">clojure.edn</span> library is edn&#8217;s implementation for Clojure.</p></div>
<div class="paragraph"><p>It works much the same as the Clojure reader and writer; however, it
provides additional security guarantees that the Clojure reader does
not, and should always be used for any external or untrusted input.</p></div>
</div></div>
<div class="paragraph"><p>The simple case of <span class="monospaced">slurp</span> and <span class="monospaced">spit</span> becomes unusable when the data
is very large, because it creates a very large string in memory all at
once. For instance, serializing one million random numbers (created
with <span class="monospaced">rand</span>) results in an 18 MB file and consumes much more memory
than that while reading or writing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"data.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span> <span style="color: #993399">1e6</span> rand<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; OutOfMemoryError Java heap space ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>But, if you know you are only dealing with a small amount of data,
this approach is perfectly suitable. It is a good way to load
configuration data and other types of simple structures.</p></div>
<div class="paragraph"><p>Reading and writing from streams is far more efficient because it
buffers input and output, dealing with data a few bytes at a time.<span class="footnote"><br>[See <a href="#sec_local-io_read_write_files">[sec_local-io_read_write_files]</a>, for notes on managing
streams.]<br></span></p></div>
<div class="paragraph"><p>In addition to reading and writing a single data structure in a file,
you can also append additional data structures to the same file and
read them back as a sequence later:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"data.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(prn</span></span><span style="color: #990000">-</span>str <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"data.clj"</span> <span style="font-weight: bold"><span style="color: #000000">(prn</span></span><span style="color: #990000">-</span>str <span style="color: #990000">[:</span>a <span style="color: #990000">:</span>b <span style="color: #990000">:</span>c<span style="color: #990000">])</span> <span style="color: #990000">:</span>append true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; data.clj now contains two serialized structures</span></span></tt></pre></div></div>
<div class="paragraph"><p>This is useful for appending small amounts of data to a file over
time, such as for an event or transaction log.</p></div>
<div class="paragraph"><p>However <span class="monospaced">read-string</span> will not suffice for reading multiple objects
from a single string. To read a series of objects from a stream, you
must continue to call <span class="monospaced">read</span> until it has reached the end:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span> read<span style="color: #990000">-</span>one
  <span style="color: #990000">[</span>r<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(try</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(read</span></span> r<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>RuntimeException e
      <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(=</span> <span style="color: #FF0000">"EOF while reading"</span> <span style="color: #990000">(.</span>getMessage e<span style="color: #990000">))</span>
        <span style="color: #990000">::</span>EOF
        <span style="font-weight: bold"><span style="color: #000000">(throw</span></span> e<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> read<span style="color: #990000">-</span>seq<span style="color: #990000">-</span>from<span style="color: #990000">-</span>file
  <span style="color: #FF0000">"Reads a sequence of top-level objects in file at path."</span>
  <span style="color: #990000">[</span>path<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>r <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io<span style="color: #990000">.</span>PushbackReader<span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader path<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>read<span style="color: #990000">-</span>eval<span style="color: #990000">*</span> false<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(doall</span></span> <span style="font-weight: bold"><span style="color: #000000">(take</span></span><span style="color: #990000">-</span>while #<span style="font-weight: bold"><span style="color: #000000">(not</span></span><span style="color: #990000">=</span> <span style="color: #990000">::</span>EOF <span style="color: #990000">%)</span> <span style="font-weight: bold"><span style="color: #000000">(repeatedly</span></span> #<span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>one r<span style="color: #990000">)))))))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_92">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_get_local_resource">[sec_local_io_get_local_resource]</a>
</p>
</li>
<li>
<p>
<a href="#sec_edn_configs">[sec_edn_configs]</a>
</p>
</li>
<li>
<p>
<a href="#sec_default_data_reader">[sec_default_data_reader]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_edn_configs">Using edn for Configuration Files</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_93">Problem</h4>
<div class="paragraph"><p>You want to configure your application using Clojure-like data literals.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_93">Solution</h4>
<div class="paragraph"><p>Use Clojure data structures stored in edn files to define a map that
contains configuration items you care about.</p></div>
<div class="paragraph"><p>For example, the edn configuration of an application that needs to
know its own hostname and connection info for a relational database
might look something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>hostname <span style="color: #FF0000">"localhost"</span>
 <span style="color: #990000">:</span>database {<span style="color: #990000">:</span>host <span style="color: #FF0000">"my.db.server"</span>
            <span style="color: #990000">:</span>port <span style="color: #993399">5432</span>
            <span style="color: #990000">:</span>name <span style="color: #FF0000">"my-app"</span>
            <span style="color: #990000">:</span>user <span style="color: #FF0000">"root"</span>
            <span style="color: #990000">:</span>password <span style="color: #FF0000">"s00p3rs3cr3t"</span>}}</tt></pre></div></div>
<div class="paragraph"><p>The basic function to read this data into a Clojure map is trivial
using the edn reader:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> load<span style="color: #990000">-</span>config
  <span style="color: #FF0000">"Given a filename, load &amp; return a config file"</span>
  <span style="color: #990000">[</span>filename<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> filename<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Invoking the newly defined <span class="monospaced">load-config</span> function will now return a
configuration map that you can pass around and use in your application
as you would any other map.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_93">Discussion</h4>
<div class="paragraph"><p>As can be seen from the preceding code, the basic process for obtaining a
map containing configuration data is extremely trivial. A more
interesting question is what to do with the config map once you have
it, and there are two general schools of thought regarding the answer.</p></div>
<div class="paragraph"><p>The first option prioritizes ease of development by making the
configuration map ambiently available throughout the entire
application. Usually this involves setting a global var to contain the
configuration.</p></div>
<div class="paragraph"><p>However, this is problematic for a number of reasons. First, it
becomes more difficult to override the default configuration file in
alternate contexts, such as tests, or when running two differently
configured systems in the same JVM. (This can be worked around by using
thread-local bindings, but this can lead to messy code fairly
rapidly.)</p></div>
<div class="paragraph"><p><?dbhtml orphans="4"?>More importantly, using a global configuration means that any function
that reads the config (most functions, in a sizable application)
<em>cannot be pure</em>. In Clojure, that is a lot to give up. One of the
main benefits of pure Clojure code is its local transparency; the
behavior of a function can be determined solely by looking at its
arguments and its code. If every function reads a global variable,
however, this becomes much more difficult.</p></div>
<div class="paragraph"><p>The alternative is to explicitly pass around the config everywhere it
is needed, like you would every other argument. Since a config file is
usually supplied at application start, the config is usually
established in the <span class="monospaced">-main</span> function and passed wherever else it is needed.</p></div>
<div class="paragraph"><p>This sounds painful, and indeed it can be somewhat annoying to pass an
extra argument to every function. Doing so, however, lends the code a
large degree of self-documentation; it becomes extremely evident what
parts of the application rely on the config and what parts do not. It
also makes it more straightforward to modify the config at runtime or
supply an alternative config in testing scenarios.</p></div>
<div class="sect4">
<h5 id="_using_multiple_config_files">Using multiple config files</h5>
<div class="paragraph"><p>A common pattern when configuring an application is to have a number
of different classes of configuration items. Some config fields are
more or less constants, and don&#8217;t vary between instances of the
application in the same environment. These are often committed to
source control along with the application&#8217;s source code.</p></div>
<div class="paragraph"><p>Other config items are fairly constant, but can&#8217;t be checked into
source control due to security concerns. Examples of this include
database passwords or secure API tokens, and ideally these are put
into a separate config file. Still other configuration fields (such as IP addresses) will often be
completely different for every instance of a deployed application, and
the desire is to specify those separately from the more constant
config fields.</p></div>
<div class="paragraph"><p>A useful technique to handle this heterogeneity is to use multiple
configuration files, each handling a different type of concern, and
then merge them into a single configuration map before passing it on
to the application. This typically uses a simple <span class="monospaced">deep-merge</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> deep<span style="color: #990000">-</span>merge
  <span style="color: #FF0000">"Deep merge two maps"</span>
  <span style="color: #990000">[&amp;</span> values<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(every</span></span><span style="color: #990000">?</span> map<span style="color: #990000">?</span> values<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> merge<span style="color: #990000">-</span>with deep<span style="color: #990000">-</span>merge values<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(last</span></span> values<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This will merge two maps, merging values as well if they are all
maps. If the values are not all maps, the second one "wins" and is used in
the resulting map.</p></div>
<div class="paragraph"><p>Then, you can rewrite the config loader to accept multiple config
files, and merge them together:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> load<span style="color: #990000">-</span>config
  <span style="color: #990000">[&amp;</span> filenames<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> deep<span style="color: #990000">-</span>merge <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(comp</span></span> edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string slurp<span style="color: #990000">)</span>
                          filenames<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Using this approach on two separate edn config files, <em>config-public.edn</em> and <em>config-private.edn</em>, yields a merged map.</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="title"><em>config-public.edn</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>hostname <span style="color: #FF0000">"localhost"</span>
 <span style="color: #990000">:</span>database {<span style="color: #990000">:</span>host <span style="color: #FF0000">"my.db.server"</span>
            <span style="color: #990000">:</span>port <span style="color: #993399">5432</span>
            <span style="color: #990000">:</span>name <span style="color: #FF0000">"my-app"</span>
            <span style="color: #990000">:</span>user <span style="color: #FF0000">"root"</span>}}</tt></pre></div></div>
<div class="listingblock">
<div class="title"><em>config-private.edn</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>database {<span style="color: #990000">:</span>password <span style="color: #FF0000">"s3cr3t"</span>}}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(load</span></span><span style="color: #990000">-</span>config <span style="color: #FF0000">"config-public.edn"</span> <span style="color: #FF0000">"config-private.edn"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:hostname "localhost", :database {:password "s3cr3t",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :host "my.db.server", :port 5432, :name "my-app", :user "root"}}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Be aware that any values present in both configuration files will be
overridden by the "rightmost" file passed to <span class="monospaced">load-config</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_different_configurations_for_different_environments">Different configurations for different environments</h5>
<div class="paragraph"><p>If your system runs in multiple environments, you may want to vary your
configuration based on the current running environment. For example,
you may want to connect to a local database while developing your system,
but a production database when running your system in production.</p></div>
<div class="paragraph"><p>You can use Leiningen&#8217;s <em>profiles</em> feature to achieve this end. By
providing different <span class="monospaced">:resource-paths</span> options for each profile in
your project&#8217;s configuration, you can vary which configuration file is
read per environment:<span class="footnote"><br>[To follow along, create your own
project with <strong><span class="monospaced">lein new my-great-app</span></strong>.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> my<span style="color: #990000">-</span>great<span style="color: #990000">-</span>app <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  {<span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>resource<span style="color: #990000">-</span>paths <span style="color: #990000">[</span><span style="color: #FF0000">"resources/dev"</span><span style="color: #990000">]</span>}
             <span style="color: #990000">:</span>prod {<span style="color: #990000">:</span>resource<span style="color: #990000">-</span>paths <span style="color: #990000">[</span><span style="color: #FF0000">"resources/prod"</span><span style="color: #990000">]</span>}}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>With a project configuration similar to the previous one, you can then
create two different configurations with the same base filename,
<em>resources/dev/config.edn</em> and <em>resources/prod/config.edn</em>:</p></div>
<div class="listingblock">
<div class="title"><em>resource/dev/config.edn</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>database<span style="color: #990000">-</span>host <span style="color: #FF0000">"localhost"</span>}</tt></pre></div></div>
<div class="listingblock">
<div class="title"><em>resources/prod/config.edn</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>database<span style="color: #990000">-</span>host <span style="color: #FF0000">"production.example.com"</span>}</tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;re following along on your own, add the <span class="monospaced">load-config</span> function
to one of your project&#8217;s namespaces:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> my<span style="color: #990000">-</span>great<span style="color: #990000">-</span>app<span style="color: #990000">.</span>core
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> load<span style="color: #990000">-</span>config
    <span style="color: #FF0000">"Given a filename, load &amp; return a config file"</span>
    <span style="color: #990000">[</span>filename<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string  <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> filename<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Now, the configuration your application loads will depend on which
profile your project is running in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># "dev" is one of Leiningen's default profiles</span></span>
$ lein repl
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>require <span style="color: #FF0000">'[my-great-app.core :refer [load-config]])</span>
<span style="color: #FF0000">user=&gt; (load-config (clojure.java.io/resource "config.edn"))</span>
<span style="color: #FF0000">{:database-host "localhost"}</span>
<span style="color: #FF0000">user=&gt; (exit)</span>

<span style="color: #FF0000">$ lein trampoline with-profile prod repl</span>
<span style="color: #FF0000">user=&gt; (require '</span><span style="color: #990000">[</span>my-great-app<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>load-config<span style="color: #990000">]])</span>
<span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>load-config <span style="color: #990000">(</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io/resource <span style="color: #FF0000">"config.edn"</span><span style="color: #990000">))</span>
{<span style="color: #990000">:</span>database-host <span style="color: #FF0000">"production.example.com"</span>}</tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_93">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_get_local_resource">[sec_local_io_get_local_resource]</a>
</p>
</li>
<li>
<p>
<a href="#sec_edn_record">[sec_edn_record]</a>
</p>
</li>
<li>
<p>
<a href="#sec_default_data_reader">[sec_default_data_reader]</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/lein-profiles-tut">Leiningen profiles tutorial</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_edn_record">Emitting Records as edn Values</h3>
<div class="paragraph byline"><p>by Steve Miner</p></div>
<div class="sect3">
<h4 id="_problem_94">Problem</h4>
<div class="paragraph"><p>You want to use Clojure records as edn values, but the edn
format doesn&#8217;t support records.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_94">Solution</h4>
<div class="paragraph"><p>You can use the <span class="monospaced">tagged</span> library to read and print records as
edn tagged literal values.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.velisco/tagged "0.3.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>velisco/tagged</tt></pre></div></div>
<div class="paragraph"><p>To extend Clojure&#8217;s built-in <span class="monospaced">print-method</span> multimethod to print
a record in a "tagged" format, extend <span class="monospaced">print-method</span> for that record
with the <span class="monospaced">miner.tagged/pr-tagged-record-on</span> helper function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>miner<span style="color: #990000">.</span>tagged <span style="color: #990000">:</span>as tag<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defrecord</span></span> SimpleRecord <span style="color: #990000">[</span>a<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> forty<span style="color: #990000">-</span>two <span style="color: #990000">(-&gt;</span>SimpleRecord <span style="color: #993399">42</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str forty<span style="color: #990000">-</span>two<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "#user.SimpleRecord{:a 42}" ;; Sadly, not a proper edn value</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> print<span style="color: #990000">-</span>method user<span style="color: #990000">.</span>SimpleRecord <span style="color: #990000">[</span>this w<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(tag</span></span><span style="color: #990000">/</span>pr<span style="color: #990000">-</span>tagged<span style="color: #990000">-</span>record<span style="color: #990000">-</span>on this w<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str forty<span style="color: #990000">-</span>two<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "#user/SimpleRecord {:a 42}"</span></span></tt></pre></div></div>
<div class="paragraph"><p>At this point, you can round-trip your records between <span class="monospaced">pr-str</span> and
<span class="monospaced">miner.tagged/read-string</span> using the edn tagged literal format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(tag</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str forty<span style="color: #990000">-</span>two<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #user/SimpleRecord {:a 42}</span></span>

<span style="color: #990000">(=</span> forty<span style="color: #990000">-</span>two
   <span style="font-weight: bold"><span style="color: #000000">(tag</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str forty<span style="color: #990000">-</span>two<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>The edn reader still doesn&#8217;t understand how to parse these tagged
values, though. To enable this behavior, use
<span class="monospaced">miner.tagged/tagged-default-reader</span> as the <span class="monospaced">:default</span> option when
reading values with <span class="monospaced">edn</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string {<span style="color: #990000">:</span>default tag<span style="color: #990000">/</span>tagged<span style="color: #990000">-</span>default<span style="color: #990000">-</span>reader}
                 <span style="font-weight: bold"><span style="color: #000000">(pr</span></span><span style="color: #990000">-</span>str {<span style="color: #990000">:</span>my<span style="color: #990000">-</span>record forty<span style="color: #990000">-</span>two}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:my-record #user/SimpleRecord {:a 42}}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_94">Discussion</h4>
<div class="paragraph"><p>The edn format is great&#8212;it covers a useful subset of the Clojure
data types and makes high-fidelity data transfer a breeze. Unfortunately, it doesn&#8217;t support records. This is easy enough to
rectify, however; edn is an extensible format by name. We just need to
provide tag-style printing (<span class="monospaced">#tag &lt;value&gt;</span>) and an appropriate reader.
The <span class="monospaced">tagged</span> library makes both of these tasks quite easy.</p></div>
<div class="paragraph"><p>As seen in the preceding samples, Clojure&#8217;s default printed value for
records is close to, but not quite the tagged format edn expects.</p></div>
<div class="paragraph"><p>Where Clojure prints <span class="monospaced">"#user.SimpleRecord{:a 42}"</span> for a
<span class="monospaced">SimpleRecord</span>, what is really needed for edn is a tag-style string
like <span class="monospaced">"#user/SimpleRecord {:a 42}"</span>. The
<span class="monospaced">miner.tagged/pr-tagged-record-on</span> function understands how to write
records in this format (to a <span class="monospaced">java.io.Writer</span>). By extending Clojure&#8217;s
<span class="monospaced">print-method</span> multimethod with this function, you ensure Clojure
always prints a record in a tagged format.</p></div>
<div class="paragraph"><p>For reading these values back in, you need to tell the edn reader how
to parse your new record tags. By design, the <span class="monospaced">tagged</span> library
provides a <span class="monospaced">miner.tagged/tagged-default-reader</span> function that can be
used to extend edn to read your record tags. When the edn reader
can&#8217;t parse a tag, it attempts to use a function specified by its
<span class="monospaced">:default</span> option to rehydrate tags. By providing <span class="monospaced">tagged-default-reader</span> as this <span class="monospaced">:default</span> option, you allow the edn
reader to properly interpret your tagged record values.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_94">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_default_data_reader">[sec_default_data_reader]</a>, for more information on the <span class="monospaced">:default</span> option
</p>
</li>
<li>
<p>
<a href="https://github.com/edn-format/edn">edn: extensible data notation</a> on GitHub
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_default_data_reader">Handling Unknown Tagged Literals When Reading Clojure Data</h3>
<div class="paragraph byline"><p>by Steve Miner</p></div>
<div class="sect3">
<h4 id="_problem_95">Problem</h4>
<div class="paragraph"><p>You want to read Clojure data (in an edn format) that may contain
unknown tagged literals.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_95">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">:default</span> option of either <span class="monospaced">clojure.edn/read</span> or
<span class="monospaced">clojure.edn/read-string</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'clojure<span style="color: #990000">.</span>edn<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defrecord</span></span> TaggedValue <span style="color: #990000">[</span>tag value<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> read<span style="color: #990000">-</span>preserving<span style="color: #990000">-</span>unknown<span style="color: #990000">-</span>tags <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string {<span style="color: #990000">:</span>default <span style="color: #990000">-&gt;</span>TaggedValue} s<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>preserving<span style="color: #990000">-</span>unknown<span style="color: #990000">-</span>tags <span style="color: #FF0000">"#my.example/unknown 42"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #user.TaggedValue{:tag my.example/unknown, :value 42}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_95">Discussion</h4>
<div class="paragraph"><p>The edn format defines a print representation for a significant
subset of Clojure data types and offers extensibility through tagged
literals. The best way to read edn data is to use <span class="monospaced">clojure.edn/read</span>
or <span class="monospaced">clojure.edn/read-string</span>. These functions consume edn-formatted
data from a stream or string, respectively, and return hydrated
Clojure data.</p></div>
<div class="paragraph"><p>Both functions take an <span class="monospaced">opts</span> map, which allows you to control several
options when reading. For tags you know about ahead of time, you can
define custom readers by supplying a <span class="monospaced">:readers</span> map. This map can also
be used to override the behavior of built-in types as defined by
<span class="monospaced">clojure.core/default-data-readers</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Creating a custom reader</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string {<span style="color: #990000">:</span>readers {'inc<span style="color: #990000">-</span>this inc}}
                         <span style="color: #FF0000">"#inc-this 1"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Overriding a built-in reader</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Before..</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="color: #FF0000">"#inst </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">2013-06-08T01:00:00Z</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #inst "2013-06-08T01:00:00.000-00:00"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; And after...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string {<span style="color: #990000">:</span>readers {'inst str}}
                         <span style="color: #FF0000">"#inst </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">2013-06-08T01:00:00Z</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "2013-06-08T01:00:00Z"</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">:default</span> option, as explored in the solution, is ideal for
handling unknown tags. Whenever an unknown tag and value are
encountered, the function you provide will be called with two
arguments, the tag and its value.</p></div>
<div class="paragraph"><p>When a <span class="monospaced">:default</span> is not provided to <span class="monospaced">read</span>, reading an unknown tag
will throw a <span class="monospaced">RuntimeException</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>edn<span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="color: #FF0000">"#blow-up boom"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; RuntimeException No reader function for tag blow-up ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>For most applications, reading an unknown tag <strong>is</strong> an error, so an
exception would be appropriate. However, it may sometimes be useful to
preserve the "unknowns," perhaps for another stage of processing.</p></div>
<div class="paragraph"><p>It&#8217;s trivial to leverage the factory function defined by <span class="monospaced">defrecord</span>
to capture the unknown reader literal. The order of the arguments for
the factory of <span class="monospaced">TaggedValue</span> conveniently matches the specification of
the <span class="monospaced">:default</span> data reader.</p></div>
<div class="paragraph"><p>The <span class="monospaced">TaggedValue</span> record preserves the essential information for
later use. Since all of the inbound information has been preserved,
you can even print the value again in the original tagged literal
format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmethod</span></span> print<span style="color: #990000">-</span>method TaggedValue <span style="color: #990000">[</span>this <span style="color: #990000">^</span>java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>Writer w<span style="color: #990000">]</span>
   <span style="color: #990000">(.</span>write w <span style="color: #FF0000">"#"</span><span style="color: #990000">)</span>
   <span style="font-weight: bold"><span style="color: #000000">(print</span></span><span style="color: #990000">-</span>method <span style="color: #990000">(:</span>tag this<span style="color: #990000">)</span> w<span style="color: #990000">)</span>
   <span style="color: #990000">(.</span>write w <span style="color: #FF0000">" "</span><span style="color: #990000">)</span>
   <span style="font-weight: bold"><span style="color: #000000">(print</span></span><span style="color: #990000">-</span>method <span style="color: #990000">(:</span>value this<span style="color: #990000">)</span> w<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Now, the TaggedValue will `pr` as the original tagged literal</span></span>
<span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>preserving<span style="color: #990000">-</span>unknown<span style="color: #990000">-</span>tags <span style="color: #FF0000">"#my.example/unknown 42"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #my.example/unknown 42</span></span></tt></pre></div></div>
<div class="paragraph"><p>Under the hood, <span class="monospaced">pr</span> delegates to the multimethod <span class="monospaced">print-method</span> to
write a string representation of a value. By providing our own
implementation of <span class="monospaced">print-method</span> for <span class="monospaced">TaggedValue</span>, the <span class="monospaced">pr</span> family of
functions are able to serialize values in such a manner that they are
recoverable later (as illustrated above).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">clojure.core/read</div>
<div class="paragraph"><p>The edn reader hasn&#8217;t always existed, you know. It used to be that
if you wanted to read Clojure data, you would use one of the two
built-in reader functions, <span class="monospaced">clojure.core/read</span> and
<span class="monospaced">clojure.core/read-string</span>. The purpose of these two functions is to
read code or data from <em>trusted sources</em>.</p></div>
<div class="paragraph"><p>Because these functions can execute code,<span class="footnote"><br>[This is actually a
feature&#8212;they&#8217;re functions used by the language to, well, execute
code.]<br></span> you should <em>never</em> (ever) use the <span class="monospaced">clojure.core</span> readers to
read from untrusted sources. This means user data, remote servers
(even your own), or pretty much anywhere else for that matter. (We&#8217;re
being a little extreme, of course, but we want you to be safe.)</p></div>
<div class="paragraph"><p>In the event that you <em>do</em> have a safe environment and absolutely need
to evaluate some code, then by all means use the <span class="monospaced">clojure.core</span>
readers. These readers do have a different interface for setting
options than <span class="monospaced">clojure.edn</span> readers, though; instead of passing an
<span class="monospaced">opts</span>, you&#8217;ll need to change various dynamic bindings to adjust the
reader&#8217;s behavior. For example, the <span class="monospaced">*default-data-reader-fn*</span>
determines how the core functions deal with unknown tags. See also
<a href="http://clojure.github.io/tools.reader/"><span class="monospaced">*data-readers*</span> and <span class="monospaced">*read-eval*</span></a> for more information. That said,
for reading data, it&#8217;s generally better to use the edn variants.<span class="footnote"><br>[The Clojure mailing list thread <a href="http://bit.ly/read-unsafe">"ANN: NEVER use clojure.core/read or read-string for reading untrusted data"</a> talks more about the vulnerabilities with <span class="monospaced">clojure.core</span> readers.]<br></span></p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_95">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/edn-format/edn">edn: extensible data notation</a> on GitHub
</p>
</li>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>, and <a href="#sec_edn_record">[sec_edn_record]</a>
</p>
</li>
<li>
<p>
The entry for
  <a href="https://clojuredocs.org/clojure.edn/read"><span class="monospaced">clojure.edn/read</span> on
  ClojureDocs</a> for a discussion about how the <span class="monospaced">clojure.core</span> and
  <span class="monospaced">clojure.edn</span> reader procedures differ with regard to
  <span class="monospaced">data_readers.clj</span>.
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_reading_properties_from_a_file">Reading Properties from a File</h3>
<div class="paragraph byline"><p>by Tobias Bayer</p></div>
<div class="sect3">
<h4 id="_problem_96">Problem</h4>
<div class="paragraph"><p>You need to read a property file and access its key/value pairs.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_96">Solution</h4>
<div class="paragraph"><p>The most straightforward way is to use the built-in
<a href="http://bit.ly/javadoc-properties"><span class="monospaced">java.util.Properties</span></a>
class via Java interop. <span class="monospaced">java.util.Properties</span> implements
<span class="monospaced">java.util.Map</span>, which can be easily consumed from Clojure, just like
any other map.</p></div>
<div class="paragraph"><p>Here is an example property file to load, <em>fruitcolors.properties</em>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>banana=yellow
grannysmith=green</pre>
</div></div>
<div class="paragraph"><p>Populating an instance of <span class="monospaced">Properties</span> from a file is straightforward,
using its <span class="monospaced">load</span> method and passing in an instance of <span class="monospaced">java.io.Reader</span>
obtained using the <span class="monospaced">clojure.java.io</span> namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>refer <span style="font-weight: bold"><span style="color: #000000">(reader</span></span><span style="color: #990000">)])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> props <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Properties<span style="color: #990000">.))</span>

<span style="color: #990000">(.</span>load props <span style="font-weight: bold"><span style="color: #000000">(reader</span></span> <span style="color: #FF0000">"fruitcolors.properties"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

props
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {"banana" "yellow", "grannysmith" "green"}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Instead of using the built-in <span class="monospaced">Properties</span> API via interop, you could
also use the <span class="monospaced">propertea</span> library for simpler, more idiomatic Clojure
access to property files.</p></div>
<div class="paragraph"><p>Include the <span class="monospaced">[propertea "1.2.3"]</span> dependency in your <em>project.clj</em>
file, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try propertea <span style="color: #993399">1.2</span><span style="color: #990000">.</span><span style="color: #993399">3</span></tt></pre></div></div>
<div class="paragraph"><p>Then read the property file and access its key/value pairs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>propertea<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>properties<span style="color: #990000">)])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> props <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>properties <span style="color: #FF0000">"fruitcolors.properties"</span><span style="color: #990000">))</span>

props
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:grannysmith "green", :banana "yellow"}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>banana<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "yellow"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_96">Discussion</h4>
<div class="paragraph"><p>Although using <span class="monospaced">java.util.Properties</span> directly is more straightforward
and doesn&#8217;t require the addition of a dependency, <span class="monospaced">propertea</span> does
provide some convenience. It returns an actual immutable Clojure map,
instead of just a <span class="monospaced">java.util.Map</span>. Although both are perfectly usable
from Clojure, an immutable map is probably preferable if you intend to
do any further manipulation or updates on it.</p></div>
<div class="paragraph"><p>More importantly, <span class="monospaced">propertea</span> converts all string keys into keywords,
which are more commonly used than strings as the keys of maps in
Clojure.</p></div>
<div class="paragraph"><p>Additionally, <span class="monospaced">propertea</span> has several other features, such as the
capability to parse values into numbers or Booleans, and providing
default values.</p></div>
<div class="paragraph"><p>By default, <span class="monospaced">propertea</span>'s <span class="monospaced">read-properties</span> function treats all
property values as strings. Consider a file <span class="monospaced">other.properties</span> with
an integer and Boolean key:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>intkey=42
booleankey=true</pre>
</div></div>
<div class="paragraph"><p>You can force these properties to be parsed into their respective
types by supplying lists for the <span class="monospaced">:parse-int</span> and <span class="monospaced">:parse-boolean</span>
options:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> props <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>properties <span style="color: #FF0000">"other.properties"</span>
                            <span style="color: #990000">:</span>parse<span style="color: #990000">-</span><span style="color: #009900">int</span> <span style="color: #990000">[:</span>intkey<span style="color: #990000">]</span>
                            <span style="color: #990000">:</span>parse<span style="color: #990000">-</span><span style="color: #009900">boolean</span> <span style="color: #990000">[:</span>booleankey<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>intkey<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 42</span></span>

<span style="font-weight: bold"><span style="color: #000000">(class</span></span> <span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>intkey<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.lang.Integer</span></span>

<span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>booleankey<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(class</span></span> <span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>booleankey<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.lang.Boolean</span></span></tt></pre></div></div>
<div class="paragraph"><p>Sometimes the property file might not contain a key/value pair, and you might want to set a reasonable default value in this case:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> props <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>properties <span style="color: #FF0000">"other.properties"</span> <span style="color: #990000">:</span>default <span style="color: #990000">[:</span>otherkey <span style="color: #FF0000">"awesome"</span><span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(props</span></span> <span style="color: #990000">:</span>otherkey<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "awesome"</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can also be strict on required properties. If an expected property is missing in your property file, you can throw an exception:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> props <span style="font-weight: bold"><span style="color: #000000">(read</span></span><span style="color: #990000">-</span>properties <span style="color: #FF0000">"other.properties"</span> <span style="color: #990000">:</span>required <span style="color: #990000">[:</span>otherkey<span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; java.lang.RuntimeException: (:otherkey) are required ...</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_96">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/jaycfields/propertea"><span class="monospaced">propertea</span> GitHub repository</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/javadoc-properties"><span class="monospaced">Properties</span> API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local-io_handle_binary_files">Reading and Writing Binary Files</h3>
<div class="paragraph byline"><p>by John Jacobsen</p></div>
<div class="sect3">
<h4 id="_problem_97">Problem</h4>
<div class="paragraph"><p>You need to read or write some binary data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_97">Solution</h4>
<div class="paragraph"><p>Use Java&#8217;s <span class="monospaced">BufferedInputStream</span>, <span class="monospaced">BufferedOutputStream</span>, and
<span class="monospaced">ByteBuffer</span> classes to work directly with binary data.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_97">Discussion</h4>
<div class="paragraph"><p>While reading and writing text files (e.g., via <span class="monospaced">slurp</span> and <span class="monospaced">spit</span>) is
easy in pure Clojure, writing binary data requires a little more Java interop.</p></div>
<div class="paragraph"><p>Clojure&#8217;s <span class="monospaced">output-stream</span> wraps the <span class="monospaced">BufferedOutputStream</span> Java
object. <span class="monospaced">BufferedOutputStream</span> has a <span class="monospaced">write</span> method that accepts Java byte
arrays. The following writes 1,000 zeros (bytes) to <em>/tmp/zeros</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>file output<span style="color: #990000">-</span>stream input<span style="color: #990000">-</span>stream<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>out <span style="font-weight: bold"><span style="color: #000000">(output</span></span><span style="color: #990000">-</span>stream <span style="font-weight: bold"><span style="color: #000000">(file</span></span> <span style="color: #FF0000">"/tmp/zeros"</span><span style="color: #990000">))]</span>
  <span style="color: #990000">(.</span>write out <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array <span style="color: #993399">1000</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>To read the bytes in again, use the corresponding <span class="monospaced">input-stream</span>
function, which wraps <span class="monospaced">BufferedInputStream</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(input</span></span><span style="color: #990000">-</span>stream <span style="font-weight: bold"><span style="color: #000000">(file</span></span> <span style="color: #FF0000">"/tmp/zeros"</span><span style="color: #990000">))]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>buf <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array <span style="color: #993399">1000</span><span style="color: #990000">)</span>
        n <span style="color: #990000">(.</span>read in buf<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Read"</span> n <span style="color: #FF0000">"bytes."</span><span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; Read 1000 bytes.</span></span></tt></pre></div></div>
<div class="paragraph"><p>Writing zeros and reading in fixed-length blocks is obviously not very
interesting. We want to prepare our byte array with some actual
content. A common way to prepare byte arrays is to use a <span class="monospaced">ByteBuffer</span>,
filling it with data from various types. Let&#8217;s assume we want to
write "strings" in the following format:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
A version number (byte; <span class="monospaced">66</span> in our example)
</p>
</li>
<li>
<p>
A string length (big-endian <span class="monospaced">int</span>)
</p>
</li>
<li>
<p>
The bytes for the string (in this case, "hello world")
</p>
</li>
</ol></div>
<div class="paragraph"><p>The following function will "pack" the bytes into an array
using an intermediate <span class="monospaced">ByteBuffer</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>nio ByteBuffer<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> prepare<span style="color: #990000">-</span>string <span style="color: #990000">[</span>strdata<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>strlen <span style="font-weight: bold"><span style="color: #000000">(count</span></span> strdata<span style="color: #990000">)</span>
        version <span style="color: #993399">66</span>
        buflen <span style="color: #990000">(+</span> <span style="color: #993399">1</span> <span style="color: #993399">4</span> strlen<span style="color: #990000">)</span>
        bb <span style="font-weight: bold"><span style="color: #000000">(ByteBuffer</span></span><span style="color: #990000">/</span>allocate buflen<span style="color: #990000">)</span>
        buf <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array buflen<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(doto</span></span> bb
      <span style="color: #990000">(.</span>put <span style="color: #990000">(.</span>byteValue version<span style="color: #990000">))</span>
      <span style="color: #990000">(.</span>putInt <span style="color: #990000">(.</span>intValue strlen<span style="color: #990000">))</span>
      <span style="color: #990000">(.</span>put <span style="color: #990000">(.</span>getBytes strdata<span style="color: #990000">))</span>
      <span style="color: #990000">(.</span>flip<span style="color: #990000">)</span>         <span style="font-style: italic"><span style="color: #9A1900">;; Prepare bb for reading</span></span>
      <span style="color: #990000">(.</span>get buf<span style="color: #990000">))</span>
    buf<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(prepare</span></span><span style="color: #990000">-</span>string <span style="color: #FF0000">"hello world"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; #&lt;byte[] [B@5ccab0e8&gt;</span></span>
<span style="font-weight: bold"><span style="color: #000000">(into</span></span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(prepare</span></span><span style="color: #990000">-</span>string <span style="color: #FF0000">"hello world"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; [66 0 0 0 11 104 101 108 108 111 32 119 111 114 108 100]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Writing data in this format is then as simple as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>out <span style="font-weight: bold"><span style="color: #000000">(output</span></span><span style="color: #990000">-</span>stream <span style="color: #FF0000">"/tmp/mystring"</span><span style="color: #990000">)]</span>
  <span style="color: #990000">(.</span>write out <span style="font-weight: bold"><span style="color: #000000">(prepare</span></span><span style="color: #990000">-</span>string <span style="color: #FF0000">"hello world"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>To get the data back, <span class="monospaced">ByteBuffer</span> provides a way of unpacking
multiple types out of a stream (array) of bytes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> unpack<span style="color: #990000">-</span>buf <span style="color: #990000">[</span>n buf<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>bb <span style="font-weight: bold"><span style="color: #000000">(ByteBuffer</span></span><span style="color: #990000">/</span>allocate n<span style="color: #990000">)]</span>
    <span style="color: #990000">(.</span>put bb buf <span style="color: #993399">0</span> n<span style="color: #990000">)</span>                     <span style="font-style: italic"><span style="color: #9A1900">;; Fill ByteBuffer with array contents</span></span>
    <span style="color: #990000">(.</span>flip bb<span style="color: #990000">)</span>                            <span style="font-style: italic"><span style="color: #9A1900">;; Prepare for reading</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>version <span style="color: #990000">(.</span>get bb <span style="color: #993399">0</span><span style="color: #990000">)]</span>
      <span style="color: #990000">(.</span>position bb <span style="color: #993399">1</span><span style="color: #990000">)</span>                    <span style="font-style: italic"><span style="color: #9A1900">;; Skip version byte</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>buflen <span style="color: #990000">(.</span>getInt bb<span style="color: #990000">)</span>
            strbytes <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array buflen<span style="color: #990000">)]</span> <span style="font-style: italic"><span style="color: #9A1900">;; Prepare buffer to hold string</span></span>
                                          <span style="font-style: italic"><span style="color: #9A1900">;; data...</span></span>
        <span style="color: #990000">(.</span>get bb strbytes<span style="color: #990000">)</span>                <span style="font-style: italic"><span style="color: #9A1900">;; ... and read it.</span></span>
        <span style="color: #990000">[</span>version buflen <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #009900">char</span> strbytes<span style="color: #990000">))]))))</span>


<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(input</span></span><span style="color: #990000">-</span>stream <span style="color: #FF0000">"/tmp/mystring"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>buf <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array <span style="color: #993399">1024</span><span style="color: #990000">)</span>
        n <span style="color: #990000">(.</span>read in buf<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(unpack</span></span><span style="color: #990000">-</span>buf n buf<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;=&gt; [66 11 "hello world"]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that for both writing and reading, the <span class="monospaced">flip</span> operation on the
<span class="monospaced">ByteBuffer</span> resets the position to the beginning of the buffer to
prepare it for reading and writing, respectively.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_97">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
For more details on <span class="monospaced">ByteBuffer</span>, which plays a key role in Java&#8217;s NIO
library, see the <a href="http://bit.ly/javadoc-nio">Java NIO documentation</a> or <emphasis><ulink role="orm:hideurl" url="http://shop.oreilly.com/product/9780596002886.do">Java NIO</ulink></emphasis> by Ron Hitchens (O&#8217;Reilly).
</p>
</li>
<li>
<p>
The Clojure library <a href="https://github.com/geoffsalmon/bytebuffer"><span class="monospaced">bytebuffer</span></a> provides a
thin, more idiomatic wrapper for <span class="monospaced">ByteBuffer</span> operations.
</p>
</li>
<li>
<p>
The more recent <a href="https://github.com/clojurewerkz/buffy">Buffy library</a> provides
a wrapper over the related Netty <literal>ByteBuffer</literal>s.
</p>
</li>
<li>
<p>
Finally, the <a href="https://github.com/ztellman/gloss">Gloss library</a> provides a DSL
for reading and writing binary streams of data (whether file-based or
network-based).
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_and_writing_csv_data">Reading and Writing CSV Data</h3>
<div class="paragraph byline"><p>by Jason Whitlark</p></div>
<div class="sect3">
<h4 id="_problem_98">Problem</h4>
<div class="paragraph"><p>You need to read or write CSV data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_98">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">clojure.data.csv/read-csv</span> to lazily read CSV data from a <span class="monospaced">String</span> or <span class="monospaced">java.io.Reader</span>.</p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[org.clojure/data.csv "0.1.2"]</span> to your project’s dependencies, or start a REPL with <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/data<span style="color: #990000">.</span>csv</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>data<span style="color: #990000">.</span>csv <span style="color: #990000">:</span>as csv<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>csv <span style="color: #FF0000">"this,is</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">a,test"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["this" "is"] ["a" "test"])</span></span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>in<span style="color: #990000">-</span>file <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader <span style="color: #FF0000">"in-file.csv"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doall</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>csv in<span style="color: #990000">-</span>file<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["this" "is"] ["a" "test"])</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">clojure.data.csv/write-csv</span> to write CSV data to a <span class="monospaced">java.io.Writer</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>out<span style="color: #990000">-</span>file <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"out.csv"</span><span style="color: #990000">)]</span>
            <span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>csv out<span style="color: #990000">-</span>file <span style="color: #990000">[[</span><span style="color: #FF0000">"this"</span> <span style="color: #FF0000">"is"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"test"</span><span style="color: #990000">]]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_98">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">clojure.data.csv</span> library makes it easy to work with CSV.  You need to remember that <span class="monospaced">read-csv</span> is lazy; if you want to force it to read data immediately, you&#8217;ll need to wrap the call to <span class="monospaced">read-csv</span> in <span class="monospaced">doall</span>.</p></div>
<div class="paragraph"><p>When reading, you can change the separator and quote delimiters, which default to <span class="monospaced">\,</span> and <span class="monospaced">\"</span>, respectively. You must specify the delimiters using chars, not strings, though:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>csv <span style="color: #FF0000">"this$-is $-</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">a$test"</span> <span style="color: #990000">:</span>separator <span style="color: #990000">\</span>$ <span style="color: #990000">:</span>quote <span style="color: #990000">\-)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["this" "is $"] ["a" "test"])</span></span></tt></pre></div></div>
<div class="paragraph"><p>When writing, as with <span class="monospaced">read-csv</span>, you can configure the separator, quote, and newline (between <span class="monospaced">:lf</span> (default) and <span class="monospaced">:cr+lf</span>), as well as the <span class="monospaced">quote?</span> predicate function, which takes a collection and returns <span class="monospaced">true</span> or <span class="monospaced">false</span> to indicate if the string representation needs to be quoted:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>out<span style="color: #990000">-</span>file <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"out.csv"</span><span style="color: #990000">)]</span>
            <span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>csv out<span style="color: #990000">-</span>file <span style="color: #990000">[[</span><span style="color: #FF0000">"this"</span> <span style="color: #FF0000">"is"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"test"</span><span style="color: #990000">]]</span>
                                        <span style="color: #990000">:</span>separator <span style="color: #990000">\</span>$ <span style="color: #990000">:</span>quote <span style="color: #990000">\-))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>To capture CSV output as a string, use <span class="monospaced">with-out-str</span> and write to <literal>*out*</literal>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>out<span style="color: #990000">-</span>str <span style="font-weight: bold"><span style="color: #000000">(csv</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>csv <span style="color: #990000">*</span>out<span style="color: #990000">*</span> <span style="color: #990000">[[</span><span style="color: #FF0000">"this"</span> <span style="color: #FF0000">"is"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span> <span style="color: #FF0000">"test"</span><span style="color: #990000">]]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "this,is\na,test\n"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_98">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.data.csv</span> <a href="https://github.com/clojure/data.csv">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_and_writing_compressed_files">Reading and Writing Compressed Files</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_99">Problem</h4>
<div class="paragraph"><p>You want to read or write a file compressed with gzip (i.e., a <em>.gz</em> file).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_99">Solution</h4>
<div class="paragraph"><p>Wrap a normal input stream with
<a href="http://bit.ly/javadoc-gzip-input"><span class="monospaced">java.util.zip.GZIPInputStream</span></a>
to get uncompressed data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>in <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>zip<span style="color: #990000">.</span>GZIPInputStream<span style="color: #990000">.</span>
                <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>input<span style="color: #990000">-</span>stream
                 <span style="color: #FF0000">"file.txt.gz"</span><span style="color: #990000">))]</span>
  <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> in<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Wrap a normal output stream with <a href="http://bit.ly/javadoc-gzip-output"><span class="monospaced">java.util.zip.GZIPOutputStream</span></a> to
compress data as it is written:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>w <span style="color: #990000">(-&gt;</span> <span style="color: #FF0000">"output.gz"</span>
                  clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>output<span style="color: #990000">-</span>stream
                  java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>zip<span style="color: #990000">.</span>GZIPOutputStream<span style="color: #990000">.</span>
                  clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer<span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> w<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"This will be compressed on disk."</span><span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_99">Discussion</h4>
<div class="paragraph"><p>gzip, based on the DEFLATE algorithm, is a common compression format
on Unix-like systems and is used extensively for compression on the
Web. It is a good choice for compressing text in particular and can
result in huge reductions for source code, or Clojure or JSON data.</p></div>
<div class="paragraph"><p>Many of Clojure&#8217;s I/O functions will accept any type of Java
stream. The <span class="monospaced">GZIPInputStream</span> simply wraps any other input stream
and attempts to decompress the original stream. The output variant
behaves similarly.</p></div>
<div class="paragraph"><p>By wrapping a normal input stream, as returned by
<span class="monospaced">clojure.java.io/input-stream</span>, you can pass it to <span class="monospaced">slurp</span> or
<span class="monospaced">line-seq</span> (or any other function that takes an input stream) and
easily read the entire decompressed contents.</p></div>
<div class="paragraph"><p>You can also leverage this technique to read a large compressed file
line by line, or to read back Clojure forms written with <span class="monospaced">pr</span> or
<span class="monospaced">pr-str</span>. You can also decompress data in a similar way from any other
kind of stream; for example, one backed by a network socket or a byte array.</p></div>
<div class="paragraph"><p>By binding an output stream to <span class="monospaced">*out*</span>, we can use <span class="monospaced">println</span>,
<span class="monospaced">pr</span>, etc. to output small amounts of data at a time to the stream,
which will be compressed on disk when the stream is closed.</p></div>
<div class="paragraph"><p>A nearly identical approach can be used for writing data in the ZIP
compression format, using the
<a href="http://bit.ly/javadoc-zip-input"><span class="monospaced">java.util.zip.ZipInputStream</span></a>
and
<a href="http://bit.ly/javadoc-zip-output"><span class="monospaced">java.util.zip.ZipOutputStream</span></a>
classes.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_99">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>, for information on reading
  Clojure data from files on disk
</p>
</li>
<li>
<p>
The <span class="monospaced">GZIPInputStream</span>
  <a href="http://bit.ly/javadoc-gzip-input">API
  documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_read_write_xml">Working with XML Data</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_100">Problem</h4>
<div class="paragraph"><p>You need to read or write XML data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_100">Solution</h4>
<div class="paragraph"><p>Pass a file to <span class="monospaced">clojure.xml/parse</span> to get a Clojure map representing the structure of an XML file.</p></div>
<div class="paragraph"><p>For example, to read the following file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;simple&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;item</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>First<span style="font-weight: bold"><span style="color: #0000FF">&lt;/item&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;item</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"2"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Second<span style="font-weight: bold"><span style="color: #0000FF">&lt;/item&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/simple&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>use <span class="monospaced">clojure.xml/parse</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'clojure<span style="color: #990000">.</span>xml<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>xml<span style="color: #990000">/</span>parse <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"simple.xml"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:tag :simple, :attrs nil, :content [</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    {:tag :item, :attrs {:id "1"}, :content ["First"]}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    {:tag :item, :attrs {:id "2"}, :content ["Second"]}]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you want to read an XML file as a sequence of nodes, pass the XML map to the <span class="monospaced">xml-seq</span>
function from the <span class="monospaced">clojure.core</span> namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(xml</span></span><span style="color: #990000">-</span>seq <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>xml<span style="color: #990000">/</span>parse <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>file <span style="color: #FF0000">"simple.xml"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">xml-seq</span> returns a tree sequence of nodes; that is, a sequence of
each node, starting at the root and then doing a depth-first walk of
the rest of the document.</p></div>
<div class="paragraph"><p>To write an XML file, pass an XML structure map to
<span class="monospaced">clojure.xml/emit</span>. <span class="monospaced">emit</span> <literal>spit</literal>s the XML to the currently bound output
stream (<literal>*out*</literal>), so to write to a file, either bind <literal>*out*</literal> to the
file&#8217;s output stream or capture the output stream to a string with the
<span class="monospaced">with-out-str</span> macro, which you can then <span class="monospaced">spit</span> to a file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(spit</span></span> <span style="color: #FF0000">"test.xml"</span> <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>out<span style="color: #990000">-</span>str <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>xml<span style="color: #990000">/</span>emit simple<span style="color: #990000">-</span>xml<span style="color: #990000">-</span>map<span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_100">Discussion</h4>
<div class="paragraph"><p>You can work with your XML data just as you would with any other map. Here is an
example of a function that, given an <span class="monospaced">id</span> and a file, will parse the
file for nodes with an attribute <span class="monospaced">id</span> that is equal to the argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> get<span style="color: #990000">-</span>with<span style="color: #990000">-</span>id <span style="color: #990000">[</span>id xml<span style="color: #990000">-</span>file<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[</span>node <span style="font-weight: bold"><span style="color: #000000">(xml</span></span><span style="color: #990000">-</span>seq <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>xml<span style="color: #990000">/</span>parse xml<span style="color: #990000">-</span>file<span style="color: #990000">))</span>
        <span style="color: #990000">:</span>when <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in node <span style="color: #990000">[:</span>attrs <span style="color: #990000">:</span>id<span style="color: #990000">])</span> id<span style="color: #990000">)]</span>
    <span style="color: #990000">(:</span>content node<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>with<span style="color: #990000">-</span>id <span style="color: #FF0000">"2"</span> simple<span style="color: #990000">-</span>xml<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["Second"])</span></span></tt></pre></div></div>
<div class="paragraph"><p>To modify XML, just use the normal map manipulation functions on the
Clojure data representation.</p></div>
<div class="paragraph"><p>If you are going to work a lot with your XML structure,
you might consider using a <em>zipper</em>. A zipper is a purely functional
data structure useful for navigating and modifying tree-like
structures (such as XML) in a convenient and efficient way.</p></div>
<div class="paragraph"><p>Zippers are a deep topic, and a full discussion is beyond the scope of
this recipe, but see the documentation for the <a href="http://clojure.github.io/data.zip/"><span class="monospaced">clojure.data.zip</span>
library</a> for explanation and examples of how to use them effectively
with XML.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_100">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local-io_read_write_files">[sec_local-io_read_write_files]</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/clj-zip-api"><span class="monospaced">clojure.zip</span></a> namespace API documentation
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local_io_json">Reading and Writing JSON Data</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_101">Problem</h4>
<div class="paragraph"><p>You need to read or write JSON data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_101">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.data.json/read-str</span> function to read a string of JSON
as Clojure data.</p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[org.clojure/data.json "0.2.6"]</span> to your project’s dependencies, or start a REPL with <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/data<span style="color: #990000">.</span>json</tt></pre></div></div>
<div class="paragraph"><p>First things first, require <span class="monospaced">clojure.data.json</span>, then you&#8217;re ready to start
parsing some JSON!</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>data<span style="color: #990000">.</span>json <span style="color: #990000">:</span>as json<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>str <span style="color: #FF0000">"[{</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">name</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">:</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">Stefan</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">,</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">age</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">:32}]"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{"name" "Stefan", "age" 32}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>To write data back to JSON, use the <span class="monospaced">clojure.data.json/write-str</span>
function with the original Clojure data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>str <span style="color: #990000">[</span>{<span style="color: #FF0000">"name"</span> <span style="color: #FF0000">"Stefan"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"age"</span> <span style="color: #993399">32</span>}<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "[{\"name\":\"Stefan\",\"age\":32}]"</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_101">Discussion</h4>
<div class="paragraph"><p>Beyond reading and writing strings, <span class="monospaced">clojure.data.json</span> also provides
the <span class="monospaced">read</span> and <span class="monospaced">write</span> functions to work with <span class="monospaced">java.io.Reader</span> and
<span class="monospaced">java.io.Writer</span> objects, respectively. With the exception of their
<span class="monospaced">reader</span>/<span class="monospaced">writer</span> parameters, these two functions share the
same parameters and options as their string brethren:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>writer <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"foo.json"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>write <span style="color: #990000">[</span>{<span style="color: #990000">:</span>foo <span style="color: #FF0000">"bar"</span>}<span style="color: #990000">]</span> writer<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>reader <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>reader <span style="color: #FF0000">"foo.json"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read reader<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{"foo" "bar"}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>By virtue of JavaScript&#8217;s simpler types, JSON notation has a much
lower fidelity than Clojure data. As such, you may find you want to tweak
the way keys or values are interpreted.</p></div>
<div class="paragraph"><p>One common example of this is converting JSON&#8217;s string-only keys to
proper Clojure keywords. You can apply a function to each processed
key by using the <span class="monospaced">:key-fn</span> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Modifying keys on read</span></span>

<span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>str <span style="color: #FF0000">"{</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">name</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">Stefan</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">}"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {"name" "Stefan"}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>str <span style="color: #FF0000">"{</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">name</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">Stefan</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">}"</span> <span style="color: #990000">:</span>key<span style="color: #990000">-</span>fn keyword<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:name "Stefan"}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Modifying keys on write</span></span>

<span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>str {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Stefan"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "{\"name\":\"Stefan\"}"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>write<span style="color: #990000">-</span>str {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Stefan"</span>} <span style="color: #990000">:</span>key<span style="color: #990000">-</span>fn str<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "{\":name\":\"Stefan\"}" ; Note the extra \:</span></span></tt></pre></div></div>
<div class="paragraph"><p>You may also want to control how values are interpreted. Use the
<span class="monospaced">:value-fn</span> option to specify how values are read/written. The function
you provide will be invoked with two arguments, a key and its value:</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Properly read UUID values</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> str<span style="color: #990000">-&gt;</span>uuid <span style="color: #990000">[</span>key value<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(=</span> key <span style="color: #990000">:</span>uuid<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">/</span>fromString value<span style="color: #990000">)</span>
    value<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>data<span style="color: #990000">.</span>json<span style="color: #990000">/</span>read<span style="color: #990000">-</span>str
  <span style="color: #FF0000">"{</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">name</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">Stefan</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">, </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">uuid</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">51674ca0-eadc-4a5b-b9fb-67b05d5a71b7</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">}"</span>
  <span style="color: #990000">:</span>key<span style="color: #990000">-</span>fn keyword
  <span style="color: #990000">:</span>value<span style="color: #990000">-</span>fn str<span style="color: #990000">-&gt;</span>uuid<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:name "Stefan", :uuid #uuid "51674ca0-eadc-4a5b-b9fb-67b05d5a71b7"}</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; And similarly, write UUID values</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> uuid<span style="color: #990000">-&gt;</span>str <span style="color: #990000">[</span>key value<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(=</span> key <span style="color: #990000">:</span>uuid<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(str</span></span> value<span style="color: #990000">)</span>
    value<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>data<span style="color: #990000">.</span>json<span style="color: #990000">/</span>write<span style="color: #990000">-</span>str
  {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Stefan"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>uuid #uuid <span style="color: #FF0000">"51674ca0-eadc-4a5b-b9fb-67b05d5a71b7"</span>}
        <span style="color: #990000">:</span>value<span style="color: #990000">-</span>fn uuid<span style="color: #990000">-&gt;</span>str<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "{\"name\":\"Stefan\",\"uuid\":\"51674ca0-eadc-4a5b-b9fb-67b05d5a71b7\"}"</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you may have inferred, when you provide both a <span class="monospaced">:key-fn</span> and
a <span class="monospaced">:value-fn</span>, the value function will always be called after the key
function.</p></div>
<div class="paragraph"><p>It might go without saying, but the <span class="monospaced">:key-fn</span> and <span class="monospaced">:value-fn</span> options
can also be used with the <span class="monospaced">write</span> and <span class="monospaced">read</span> functions.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_101">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_clojure_data_to_disk">[sec_local_io_clojure_data_to_disk]</a>, for information on
  reading/writing edn (Clojure) data.
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/data-json-doc">API documentation</a> for
  <span class="monospaced">clojure.data.json</span> for more information on reads/writes. Options
  not covered in this recipe include <span class="monospaced">:eof-error?</span>, <span class="monospaced">:eof-value</span>, and
  <span class="monospaced">:bigdec</span> on <span class="monospaced">read</span>, and  <span class="monospaced">:escape-unicode</span> and <span class="monospaced">:escape-slash</span> on <span class="monospaced">write</span>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_local_io_pdf">Generating PDF Files</h3>
<div class="paragraph byline"><p>by Dmitri Sotnikov</p></div>
<div class="sect3">
<h4 id="_problem_102">Problem</h4>
<div class="paragraph"><p>You need to generate a PDF from some data.</p></div>
<div class="paragraph"><p>For example, you have a sequence of maps, such as those returned by a
<span class="monospaced">clojure.java.jdbc</span> query, and you need to generate a PDF report.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_102">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clj-pdf</span> library to create the report.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[clj-pdf "1.11.6"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-pdf</tt></pre></div></div>
<div class="paragraph"><p>For the purpose of illustration, imagine we want to render a vector
containing the following employee records:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> employees
 <span style="color: #990000">[</span>{<span style="color: #990000">:</span>country <span style="color: #FF0000">"Germany"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>place <span style="color: #FF0000">"Nuremberg"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>occupation <span style="color: #FF0000">"Engineer"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>name <span style="color: #FF0000">"Neil Chetty"</span>}
  {<span style="color: #990000">:</span>country <span style="color: #FF0000">"Germany"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>place <span style="color: #FF0000">"Ulm"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>occupation <span style="color: #FF0000">"Engineer"</span><span style="color: #990000">,</span>
   <span style="color: #990000">:</span>name <span style="color: #FF0000">"Vera Ellison"</span>}<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Create a template for rendering each record using the
<span class="monospaced">clj-pdf.core/template</span> macro:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>pdf<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as pdf<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> employee<span style="color: #990000">-</span>template
 <span style="font-weight: bold"><span style="color: #000000">(pdf</span></span><span style="color: #990000">/</span>template
   <span style="color: #990000">[:</span>paragraph
    <span style="color: #990000">[:</span>heading <span style="color: #990000">(.</span>toUpperCase $name<span style="color: #990000">)]</span>
    <span style="color: #990000">[:</span>chunk {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold} <span style="color: #FF0000">"occupation: "</span><span style="color: #990000">]</span> $occupation <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span>
    <span style="color: #990000">[:</span>chunk {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold} <span style="color: #FF0000">"place: "</span><span style="color: #990000">]</span> $place <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span>
    <span style="color: #990000">[:</span>chunk {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold} <span style="color: #FF0000">"country: "</span><span style="color: #990000">]</span> $country
    <span style="color: #990000">[:</span>spacer<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(employee</span></span><span style="color: #990000">-</span>template employees<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([:paragraph [:heading "NEIL CHETTY"]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "occupation: "] "Engineer" "\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "place: "] "Nuremberg" "\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "country: "] "Germany" [:spacer]]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     [:paragraph [:heading "VERA ELLISON"]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "occupation: "] "Engineer" "\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "place: "] "Ulm" "\n"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:chunk {:style :bold} "country: "] "Germany"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:spacer]])</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">clj-pdf.core/pdf</span> to create the PDF using the template and data
from above:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(pdf</span></span><span style="color: #990000">/</span>pdf <span style="color: #990000">[</span>{<span style="color: #990000">:</span>title <span style="color: #FF0000">"Employee Table"</span>}
          <span style="font-weight: bold"><span style="color: #000000">(employee</span></span><span style="color: #990000">-</span>template employees<span style="color: #990000">)]</span>
         <span style="color: #FF0000">"employees.pdf"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll find an <em>employees.pdf</em> file in the directory where you ran your
project/REPL&#8212;it looks something like <a href="#fig_employees_pdf">[fig_employees_pdf]</a>.</p></div>
<div class="imageblock" id="fig_employees_pdf">
<div class="content">
<img src="images/clcb_0401.png" alt="Contents of the employees.pdf file">
</div>
<div class="title">Figure 1. <em>employees.pdf</em></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_102">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">clj-pdf</span> library is built on top of the iText and JFreeChart
libraries. The templating syntax is inspired by the popular Hiccup
HTML templating engine.</p></div>
<div class="paragraph"><p>In a template, <span class="monospaced">$</span> is used to indicate places where dynamic content
will be substituted. When populating a template from a map, each
substitution anchor (<span class="monospaced">$name</span>) is populated with the value of the
corresponding keyword key in the map (the value of the <span class="monospaced">:name</span> key).</p></div>
<div class="paragraph"><p>Beyond substituting simple values, it is also possible to perform
further processing on those values. The <span class="monospaced">:heading</span> portion of the
<span class="monospaced">employee-template</span> does precisely this by calling <span class="monospaced">(.toUpperCase
$name)</span>. In <span class="monospaced">clj-pdf</span>, a document is represented by a vector containing a map of
metadata followed by the content. The content can in turn consist of
strings, vectors, or collections of vectors.</p></div>
<div class="listingblock">
<div class="title">A <em>very</em> simple PDF:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(pdf</span></span><span style="color: #990000">/</span>pdf <span style="color: #990000">[</span>{<span style="color: #990000">:</span>title <span style="color: #FF0000">"Hello World"</span>} <span style="color: #FF0000">"Hello, World."</span><span style="color: #990000">]</span> <span style="color: #FF0000">"hello-world.pdf"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Under the hood, collections of content are automatically expanded:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; This *collection* of paragraphs...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(pdf</span></span><span style="color: #990000">/</span>pdf <span style="color: #990000">[</span>{} <span style="color: #990000">[[:</span>paragraph <span style="color: #FF0000">"foo"</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>paragraph <span style="color: #FF0000">"bar"</span><span style="color: #990000">]]]</span> <span style="color: #FF0000">"document.pdf"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; is equivalent to these *individual* paragraphs</span></span>
<span style="font-weight: bold"><span style="color: #000000">(pdf</span></span><span style="color: #990000">/</span>pdf <span style="color: #990000">[</span>{} <span style="color: #990000">[:</span>paragraph <span style="color: #FF0000">"foo"</span><span style="color: #990000">]</span> <span style="color: #990000">[:</span>paragraph <span style="color: #FF0000">"bar"</span><span style="color: #990000">]]</span> <span style="color: #FF0000">"document.pdf"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Apart from plain strings, each content element is represented as a
vector. The first element of this vector is a keyword type, and
everything that follows is the content itself. Some types <span class="monospaced">clj-pdf</span>
includes are <span class="monospaced">:paragraph</span>, <span class="monospaced">:phrase</span>, <span class="monospaced">:list</span>, and <span class="monospaced">:table</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[:</span>heading <span style="color: #FF0000">"Lorem Ipsum"</span><span style="color: #990000">]</span>
<span style="color: #990000">[:</span>line<span style="color: #990000">]</span>
<span style="color: #990000">[:</span>list <span style="color: #FF0000">"first item"</span>
      <span style="color: #FF0000">"second item"</span>
      <span style="color: #FF0000">"third item"</span><span style="color: #990000">]</span>
<span style="color: #990000">[:</span>paragraph <span style="color: #FF0000">"I'm a paragraph"</span><span style="color: #990000">]</span>
<span style="color: #990000">[:</span>phrase <span style="color: #FF0000">"some text here"</span><span style="color: #990000">]</span>
<span style="color: #990000">[:</span>table
   <span style="color: #990000">[</span><span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">"bar"</span> <span style="color: #FF0000">"baz"</span><span style="color: #990000">]</span>
   <span style="color: #990000">[</span><span style="color: #FF0000">"foo1"</span> <span style="color: #FF0000">"bar1"</span> <span style="color: #FF0000">"baz1"</span><span style="color: #990000">]</span>
   <span style="color: #990000">[</span><span style="color: #FF0000">"foo2"</span> <span style="color: #FF0000">"bar2"</span> <span style="color: #FF0000">"baz2"</span><span style="color: #990000">]]</span></tt></pre></div></div>
<div class="paragraph"><p>Some elements accept optional styling metadata. You can provide this
style information as a map immediately following the type parameter
(the second item in the vector):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[:</span>paragraph {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold} <span style="color: #FF0000">"this text is bold"</span><span style="color: #990000">]</span>

<span style="color: #990000">[:</span>chunk {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold
         <span style="color: #990000">:</span>size <span style="color: #993399">18</span>
         <span style="color: #990000">:</span>family <span style="color: #990000">:</span>helvetica
         <span style="color: #990000">:</span>color <span style="color: #990000">[</span><span style="color: #993399">0</span> <span style="color: #993399">234</span> <span style="color: #993399">123</span><span style="color: #990000">]</span>}
 <span style="color: #FF0000">"some large green text"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The contents of an element can consist of other elements (like an HTML
document), and any style applied to a parent element will be
inherited by the child elements:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[:</span>paragraph <span style="color: #FF0000">"some content"</span><span style="color: #990000">]</span>

<span style="color: #990000">[:</span>paragraph {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold}
 <span style="color: #FF0000">"Some bold text"</span>
 <span style="color: #990000">[:</span>phrase <span style="color: #990000">[:</span>chunk <span style="color: #FF0000">"even more"</span><span style="color: #990000">]</span> <span style="color: #FF0000">"bold text"</span><span style="color: #990000">]]</span></tt></pre></div></div>
<div class="paragraph"><p>As with Cascading Style Sheets (CSS), child elements can augment or override their parents' styles
by specifying their own styles:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[:</span>paragraph
 {<span style="color: #990000">:</span>style <span style="color: #990000">:</span>bold}
 <span style="color: #FF0000">"Bold words"</span>
 <span style="color: #990000">[:</span>phrase {<span style="color: #990000">:</span>color <span style="color: #990000">[</span><span style="color: #993399">0</span> <span style="color: #993399">255</span> <span style="color: #993399">221</span><span style="color: #990000">]</span>} <span style="color: #FF0000">"Bold AND teal!"</span><span style="color: #990000">]]</span></tt></pre></div></div>
<div class="paragraph"><p>Images can be embedded in the document using the <span class="monospaced">:image</span> element.
Image content can be one of <span class="monospaced">java.net.URL</span>, <span class="monospaced">java.awt.Image</span>, a byte
array, a Base64 string, or a string representing a URL or a file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[:</span>image <span style="color: #FF0000">"my-image.jpg"</span><span style="color: #990000">]</span>
<span style="color: #990000">[:</span>image <span style="color: #FF0000">"http://clojure.org/space/showimage/clojure-icon.gif"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Images
larger than the page margins will automatically be scaled to fit.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_102">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
For more information on using <span class="monospaced">clj-pdf</span>, including a complete list of
  element types and charting capabilities, see the <span class="monospaced">clj-pdf</span> <a href="https://github.com/yogthos/clj-pdf">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_making_a_gui_window_with_scrollable_text">Making a GUI Window with Scrollable Text</h3>
<div class="paragraph byline"><p>by John Jacobsen; originally submitted by John Walker</p></div>
<div class="sect3">
<h4 id="_problem_103">Problem</h4>
<div class="paragraph"><p>You want to create and display a GUI window.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_103">Solution</h4>
<div class="paragraph"><p>Though Java&#8217;s Swing library is the most common way to make Java GUIs
(at least on the desktop), the Seesaw library, which wraps Swing and
provides a more idiomatic and functional interface, is the best tool
for creating GUIs with Clojure.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try seesaw</tt></pre></div></div>
<div class="paragraph"><p>Swing implements a "programmable look and feel": the appearance of
various widgets and their behavior can be modified, though it is
common to set this to match the platform one is on, for the sake of
maximum usability. Setting the native look and feel is accomplished in
Seesaw with the <span class="monospaced">native!</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>seesaw<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>native<span style="color: #990000">!</span> frame show<span style="color: #990000">!</span> config<span style="color: #990000">!</span>
                               pack<span style="color: #990000">!</span> text scrollable<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(native</span></span><span style="color: #990000">!)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>To create your window object, use <span class="monospaced">frame</span> (which, under the covers, makes a
<span class="monospaced">JFrame</span> Swing object):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(frame</span></span> <span style="color: #990000">:</span>title <span style="color: #FF0000">"Lyrical Clojure"</span> <span style="color: #990000">:</span>content <span style="color: #FF0000">"Hello World"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 seesaw.core.proxy$javax.swing.JFrame$Tag$a79ba523</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    [frame0,0,22,0x0,invalid,hidden,layout=java.awt.BorderLayout,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    title=Lyrical Clojure,resizable,normal,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    defaultCloseOperation=HIDE_ON_CLOSE,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    rootPane=javax.swing.JRootPane[,0,0,0x0,invalid,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    layout=javax.swing.JRootPane$RootLayout,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    alignmentX=0.0,alignmentY=0.0,border=,flags=16777673,maximumSize=,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    minimumSize=,preferredSize=],rootPaneCheckingEnabled=true]&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Although a frame has been created, nothing appears. In order to
actually display the frame (as seen in <a href="#fig4-2">[fig4-2]</a>), use <span class="monospaced">show!</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> f <span style="font-weight: bold"><span style="color: #000000">(frame</span></span> <span style="color: #990000">:</span>title <span style="color: #FF0000">"Lyrical Clojure"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">!</span> f<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 [...]&gt;</span></span></tt></pre></div></div>
<div class="imageblock" id="fig4-2">
<div class="content">
<img src="images/clcb_0402.png" alt="images/clcb_0402.png">
</div>
<div class="title">Figure 2. A simple window</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_103">Discussion</h4>
<div class="paragraph"><p>Having created the window, you can set its size, add content, and add scroll bars, as follows.</p></div>
<div class="sect4">
<h5 id="_adding_content">Adding content</h5>
<div class="paragraph"><p>You can change properties of the frame using <span class="monospaced">config!</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(config</span></span><span style="color: #990000">!</span> f <span style="color: #990000">:</span>content <span style="color: #FF0000">"Actual content!"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 [...]&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The result is shown in <a href="#fig4-3">[fig4-3]</a>.</p></div>
<div class="imageblock" id="fig4-3">
<div class="content">
<img src="images/clcb_0403.png" alt="images/clcb_0403.png">
</div>
<div class="title">Figure 3. A window with basic content</div>
</div>
</div>
<div class="sect4">
<h5 id="_sizing_the_window">Sizing the window</h5>
<div class="paragraph"><p>You can specify the size of the window at the time of creation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> f <span style="font-weight: bold"><span style="color: #000000">(frame</span></span> <span style="color: #990000">:</span>title <span style="color: #FF0000">"Lyrical Clojure"</span> <span style="color: #990000">:</span>width <span style="color: #993399">300</span> <span style="color: #990000">:</span>height <span style="color: #993399">150</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 [...]&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>However, it is common to instead call <span class="monospaced">pack!</span> on the resulting frame
object; this assigns width and height properties according to its
content:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(-&gt;</span> f pack<span style="color: #990000">!</span> show<span style="color: #990000">!)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 [...]&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_adding_scrollable_content">Adding scrollable content</h5>
<div class="paragraph"><p>Now add some text, in the form of an excerpt from the sonnets of Shakespeare, to your window:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> sonnet<span style="color: #990000">-</span>text <span style="color: #990000">(-&gt;&gt;</span> <span style="color: #FF0000">"http://www.gutenberg.org/cache/epub/1041/pg1041.txt"</span>
                      slurp
                      <span style="font-weight: bold"><span style="color: #000000">(drop</span></span> <span style="color: #993399">20000</span><span style="color: #990000">)</span>
                      <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">4000</span><span style="color: #990000">)</span>
                      <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This content is too big to fit in the current window (see <a href="#fig4-4">[fig4-4]</a>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(config</span></span><span style="color: #990000">!</span> f <span style="color: #990000">:</span>content sonnet<span style="color: #990000">-</span>text<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;JFrame$Tag$a79ba523 [...]&gt;</span></span></tt></pre></div></div>
<div class="imageblock" id="fig4-4">
<div class="content">
<img src="images/clcb_0404.png" alt="images/clcb_0404.png">
</div>
<div class="title">Figure 4. A window with more text than space</div>
</div>
<div class="paragraph"><p>Normally, one would call <span class="monospaced">pack!</span> again to adjust the window size to
the new content. However, the content will not fit comfortably on most
screens, so set the size explicitly and add scroll bars, as seen in <a href="#fig4-5">[fig4-5]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>setSize f <span style="color: #993399">400</span> <span style="color: #993399">400</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(config</span></span><span style="color: #990000">!</span> f <span style="color: #990000">:</span>content <span style="font-weight: bold"><span style="color: #000000">(scrollable</span></span> <span style="font-weight: bold"><span style="color: #000000">(text</span></span> <span style="color: #990000">:</span>multi<span style="color: #990000">-</span>line<span style="color: #990000">?</span> true
                                      <span style="color: #990000">:</span>text sonnet<span style="color: #990000">-</span>text
                                      <span style="color: #990000">:</span>editable<span style="color: #990000">?</span> false<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="imageblock" id="fig4-5">
<div class="content">
<img src="images/clcb_0405.png" alt="images/clcb_0405.png">
</div>
<div class="title">Figure 5. A larger window with a scroll bar</div>
</div>
<div class="paragraph"><p>The <span class="monospaced">:multi-line?</span> option to the <span class="monospaced">text</span> function selects <span class="monospaced">JTextArea</span>
as the underlying object, rather than <span class="monospaced">JTextField</span> (<span class="monospaced">JTextArea</span> is
used for multiline text; <span class="monospaced">JTextField</span> is for single-line text fields).
<span class="monospaced">:editable?</span> specifies that you don&#8217;t want to allow users to edit the text
(since it is, perhaps, doubtful that they would improve upon
Shakespeare&#8217;s original).</p></div>
<div class="paragraph"><p>Like most of the Seesaw functions that create widgets, there are
several more options to <span class="monospaced">text</span>, which are best learned about by
studying the <a href="http://bit.ly/cc-seesaw">API documentation</a>.</p></div>
<div class="paragraph"><p><?dbhtml orphans="4"?>As is always the case in Clojure, the Seesaw library functions return
Java objects, which can be operated upon directly using Java methods;
for example, our use of the <span class="monospaced">.setSize</span> method of the <span class="monospaced">JFrame</span> object
returned by <span class="monospaced">frame</span>. This interoperability provides great power but
comes at the cost of a somewhat higher burden on programmers, who must
navigate not only the Seesaw API but, frequently, some aspects of the
underlying Swing API as well.</p></div>
<div class="paragraph"><p>Seesaw supports a wide variety of GUI tasks&#8212;creation of menus,
display of text and images, scroll bars, radio buttons, checkboxes,
multipaned windows, drag-and-drop, and much more. In addition to the
dozen or so books that have been written about Swing, one could easily
write an entire book on Seesaw. This recipe merely serves as a
starting point for further investigation of the Seesaw library.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_103">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Seesaw <a href="https://github.com/daveray/seesaw">GitHub repository</a>
</p>
</li>
<li>
<p>
<ulink role="orm:hideurl" url="http://shop.oreilly.com/product/9780596004088.do"><emphasis>Java Swing</emphasis>, 2nd ed.</ulink> (O&#8217;Reilly), by Marc Loy <em>et al</em>.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_network_io">Network I/O and Web Services</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_5">Introduction</h3>
<div class="paragraph"><p>More and more these days, it seems like every system we build has to
talk to something, somewhere.<span class="footnote"><br>[In fact, <a href="http://bit.ly/no-getting-around">"There&#8217;s Just No Getting
around It: You&#8217;re Building a Distributed System"</a>.]<br></span> We&#8217;d hardly be doing anything if we didn&#8217;t
actually talk with some other computers over some kind of network.</p></div>
<div class="paragraph"><p>This chapter covers all of the normal remote communication modes you would
expect&#8212;HTTP, TCP, UDP, and the like&#8212;as well as some relative newcomers<span class="footnote"><br>[As
Australian songwriter Peter Allen so aptly put it: "Everything old
is new again."]<br></span> like  message-oriented architectures.</p></div>
</div>
<div class="sect2">
<h3 id="sec_http_request">Making HTTP Requests</h3>
<div class="paragraph byline"><p>by John Cromartie</p></div>
<div class="sect3">
<h4 id="_problem_104">Problem</h4>
<div class="paragraph"><p>You want to make a simple HTTP GET or POST request.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_104">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">slurp</span> to make simple HTTP GET requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="color: #FF0000">"http://example.com"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "&lt;!doctype html&gt;\n&lt;html&gt;\n&lt;head&gt;\n    &lt;title&gt;Example Domain&lt;/title&gt; ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>Use the <span class="monospaced">clj-http</span> library to make GET, POST, and other requests with
specific parameters or headers, to handle redirects and other special
circumstances, or to get specific details about the response.</p></div>
<div class="paragraph"><p>To follow along, add <span class="monospaced">[clj-http "0.7.7"]</span> to your project&#8217;s
dependencies, or use <span class="monospaced">lein-try</span> to start a REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-http</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">clj-http.client/get</span> to make GET requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>http<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as http<span style="color: #990000">])</span>

<span style="color: #990000">(:</span>status <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://clojure.org"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 200</span></span>

<span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://clojure.org"</span><span style="color: #990000">)</span>
    <span style="color: #990000">:</span>headers
    <span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #FF0000">"server"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "nginx"</span></span>

<span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://www.amazon.com/"</span><span style="color: #990000">)</span>
    <span style="color: #990000">:</span>cookies
    keys<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("session-id" "session-id-time" "x-wl-uid" "skin")</span></span></tt></pre></div></div>
<div class="paragraph"><p>Parameters can be included in both GET and POST requests. Use
<span class="monospaced">clj-http.client/post</span> to make POST requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://google.com/"</span> {<span style="color: #990000">:</span>query<span style="color: #990000">-</span>params {<span style="color: #990000">:</span>q <span style="color: #FF0000">"clojure"</span>}}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:status 200 ...}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>post <span style="color: #FF0000">"http://example.com"</span> {<span style="color: #990000">:</span>form<span style="color: #990000">-</span>params {<span style="color: #990000">:</span>username <span style="color: #FF0000">"joecoder"</span>
                                               <span style="color: #990000">:</span>password <span style="color: #FF0000">"il0v3clojure"</span>}}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:status 200 ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can even use the <span class="monospaced">:multipart</span> option to upload files, as from an
HTML form via a web browser.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_104">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">slurp</span> works to make HTTP GET requests because its arguments are
passed to <span class="monospaced">clojure.java.io/reader</span>, which in turn correctly handles
opening URL strings. This is totally sufficient for issuing a quick
HTTP GET to a well-behaved URL. Unfortunately, this is where <span class="monospaced">slurp</span>'s
usefulness ends. Among other limitations, it will not behave correctly
for responses with HTTP redirects.</p></div>
<div class="paragraph"><p><span class="monospaced">clj-http</span> is an extremely flexible Clojure wrapper around the very
robust Apache <a href="https://hc.apache.org/">HttpComponents library</a>. Its features include convenient functions for other HTTP verbs like
PUT and DELETE; for reading and sending cookies, headers, and other
request metadata; for reading and writing data using streams, files, or
byte arrays; and lots more. Refer to the
<a href="https://github.com/dakrone/clj-http">GitHub repository</a> to learn about
the huge variety of options available and to see many more examples.</p></div>
<div class="paragraph"><p>If you&#8217;re building production systems that rely on external services,
you may want to consider wrapping HTTP calls in Netflix&#8217;s
<a href="https://github.com/Netflix/Hystrix">Hystrix</a> library to make your
application more fault-tolerant and resilient. Hystrix provides
<a href="http://bit.ly/hystrix-clj">Clojure
bindings</a> that you can use to wrap network calls and more easily
manage complex failure scenarios involving external services.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_104">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">clj-http</span>'s <a href="https://github.com/dakrone/clj-http">GitHub
  repository</a>.
</p>
</li>
<li>
<p>
For information on making asynchronous HTTP calls, see
  <a href="#sec_async_http">[sec_async_http]</a>.
</p>
</li>
<li>
<p>
When building production systems that interact with external
  services, consider <a href="https://github.com/Netflix/Hystrix">Hystrix</a> and
  its
  <a href="http://bit.ly/hystrix-clj">Clojure
  bindings</a> to wrangle complex failure scenarios.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_async_http">Performing Asynchronous HTTP Requests</h3>
<div class="paragraph byline"><p>by Alan Busby and Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_105">Problem</h4>
<div class="paragraph"><p>You want to perform asynchronous HTTP requests.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_105">Solution</h4>
<div class="paragraph"><p>Use <a href="http://http-kit.org/">HTTP Kit</a>, a highly performant, event-driven
HTTP client/server library.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[http-kit "2.1.12"]</span> to your project&#8217;s
dependencies, or follow along in a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try http-kit</tt></pre></div></div>
<div class="paragraph"><p>Use any of <span class="monospaced">org.httpkit.client</span>'s HTTP verb functions to perform
asynchronous HTTP requests. In their base form, these functions return
a promise that you can await with <span class="monospaced">deref</span> or the <span class="monospaced">@</span>
reader shorthand:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>org<span style="color: #990000">.</span>httpkit<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as http<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> response <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://example.com"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Some time later...</span></span>

<span style="color: #990000">(:</span>status @response<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 200</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Or, using deref to specify a timeout length in milliseconds and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; a value</span></span>
<span style="font-weight: bold"><span style="color: #000000">(deref</span></span> response <span style="color: #993399">2000</span> nil<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:opts {:url "http://example.com", :method :get}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :body "..."</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :headers {:content-type "text/html", :content-length "1270" ...}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :status 200}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_105">Discussion</h4>
<div class="paragraph"><p>The bulk of time spent performing HTTP requests is establishing the
connection and awaiting the server&#8217;s response. Asynchronous requests
enable your application to continue working while awaiting the
delivery of data.</p></div>
<div class="paragraph"><p>In this vein, HTTP Kit provides both a highly concurrent web server and a powerful HTTP client. It offers both callbacks and promises for
asynchronous requests, as well as persistent connections and alternate
SSL engines for dealing with unsigned SSL certificates.</p></div>
<div class="paragraph"><p>The <span class="monospaced">org.httpkit.client</span> namespace defines asynchronous versions of
numerous HTTP methods, including <span class="monospaced">get</span>, <span class="monospaced">delete</span>, <span class="monospaced">head</span>, <span class="monospaced">post</span>,
<span class="monospaced">put</span>, <span class="monospaced">options</span>, and <span class="monospaced">patch</span>. Each of these verbs derives from
<span class="monospaced">org.httpkit.client/request</span>, which defines a common interface. An
asynchronous request of a given method is made, and a promise is
returned. Upon completion of the request, the promise will be
fulfilled with the results/response.</p></div>
<div class="paragraph"><p>All <span class="monospaced">request</span> functions accept an optional map of options where you
can specify keys like <span class="monospaced">:query-params</span>, <span class="monospaced">:post-params</span>, or <span class="monospaced">:headers</span>.
Functions also allow specifying a callback function to be called upon
request completion:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://example.com"</span>
          {<span style="color: #990000">:</span>timeout <span style="color: #993399">1000</span>  <span style="font-style: italic"><span style="color: #9A1900">;; ms</span></span>
           <span style="color: #990000">:</span>query<span style="color: #990000">-</span>params {<span style="color: #990000">:</span>search <span style="color: #FF0000">"value"</span>}}
          <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>keys <span style="color: #990000">[</span>status headers body error<span style="color: #990000">]</span>}<span style="color: #990000">]</span>
            <span style="font-weight: bold"><span style="color: #000000">(if</span></span> error
              <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[*</span>out<span style="color: #990000">*</span> <span style="color: #990000">*</span>err<span style="color: #990000">*]</span>
                <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Failed with, "</span> error<span style="color: #990000">))</span>
              <span style="font-weight: bold"><span style="color: #000000">(println</span></span> body<span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;core$promise$reify__6310@582e6c93: :pending&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; &lt;html&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; &lt;head&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   &lt;title&gt;Example Domain&lt;/title&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_105">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
See <a href="#sec_http_request">[sec_http_request]</a>, for details on making normal, nonasynchronous HTTP requests.
</p>
</li>
<li>
<p>
HTTP Kit is heavily inspired by the API of
  <a href="https://github.com/dakrone/clj-http"><span class="monospaced">clj-http</span></a>; see
  <a href="#sec_http_request">[sec_http_request]</a>, for more information on the library.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_a_ping_request">Sending a Ping Request</h3>
<div class="paragraph byline"><p>by Jason Webb</p></div>
<div class="sect3">
<h4 id="_problem_106">Problem</h4>
<div class="paragraph"><p>You want to ping an IP address to check availability.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_106">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">java.net.InetAddress</span> class to test if the address <span class="monospaced">isReachable</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>isReachable <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>net<span style="color: #990000">.</span>InetAddress<span style="color: #990000">/</span>getByName <span style="color: #FF0000">"oreilly.com"</span><span style="color: #990000">)</span> <span style="color: #993399">5000</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_106">Discussion</h4>
<div class="paragraph"><p>Using <span class="monospaced">isReachable</span> works great if the correct permissions can be
obtained. On a typical Unix-like implementation, you will need to start
your Clojure instance with <span class="monospaced">sudo</span> to get an actual ICMP ping sent.
Otherwise, a standard connection will be attempted on port 7, which in
most cases will be blocked by a firewall. More information can be
found in the <a href="http://bit.ly/javadoc-isReachable">javadoc</a>.</p></div>
<div class="paragraph"><p>A common need when pinging another machine is to time the ping. You
can wrap an <span class="monospaced">.isReachable</span> invocation in a function <span class="monospaced">timed-ping</span> to
return timing values with every ping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> timed<span style="color: #990000">-</span>ping
  <span style="color: #FF0000">"Time an .isReachable ping to a given domain"</span>
  <span style="color: #990000">[</span>domain timeout<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>addr <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>net<span style="color: #990000">.</span>InetAddress<span style="color: #990000">/</span>getByName domain<span style="color: #990000">)</span>
        start <span style="color: #990000">(.</span> System <span style="font-weight: bold"><span style="color: #000000">(nanoTime</span></span><span style="color: #990000">))</span>
        result <span style="color: #990000">(.</span>isReachable addr timeout<span style="color: #990000">)</span>
        total <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(double</span></span> <span style="color: #990000">(-</span> <span style="color: #990000">(.</span> System <span style="font-weight: bold"><span style="color: #000000">(nanoTime</span></span><span style="color: #990000">))</span> start<span style="color: #990000">))</span> <span style="color: #993399">1000000.0</span><span style="color: #990000">)]</span>
    {<span style="color: #990000">:</span>time total
     <span style="color: #990000">:</span>result result}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(timed</span></span><span style="color: #990000">-</span>ping <span style="color: #FF0000">"oreilly.com"</span> <span style="color: #993399">5000</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:time 88.07, :result true}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="sec_sending_ping_see_also">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://bit.ly/javadoc-isReachable">InetAddress/isReachable
  documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_and_parsing_rss_data">Retrieving and Parsing RSS Data</h3>
<div class="paragraph byline"><p>by Osbert Feng</p></div>
<div class="sect3">
<h4 id="_problem_107">Problem</h4>
<div class="paragraph"><p>You need to parse RSS data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_107">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">feedparser-clj</span> library to parse RSS data.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojars.scsibug/feedparser-clj "0.4.0"]</span> to
your project&#8217;s dependencies, or follow along in a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojars<span style="color: #990000">.</span>scsibug/feedparser-clj</tt></pre></div></div>
<div class="paragraph"><p>Invoke <span class="monospaced">feedparser-clj.core/parse-feed</span> with the URI of an RSS feed to
retrieve that feed and parse it into Clojure data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>feedparser<span style="color: #990000">-</span>clj<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as rss<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(rss</span></span><span style="color: #990000">/</span>parse<span style="color: #990000">-</span>feed <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"https://github.com/clojure-cookbook/clojure-cookbook/"</span>
                     <span style="color: #FF0000">"commits/master.atom"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:authors [...]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :entries [{:link "LINK" :title "TITLE" :contents "CONTENT"} ...]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can also invoke <span class="monospaced">parse-feed</span> with a <span class="monospaced">java.io.InputStream</span> to read
from a file or other location:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>writer <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>writer <span style="color: #FF0000">"master.atom"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(spit</span></span> writer
        <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"https://github.com/clojure-cookbook/clojure-cookbook/"</span>
                    <span style="color: #FF0000">"commits/master.atom"</span><span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>stream <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>java<span style="color: #990000">.</span>io<span style="color: #990000">/</span>input<span style="color: #990000">-</span>stream <span style="color: #FF0000">"master.atom"</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(rss</span></span><span style="color: #990000">/</span>parse<span style="color: #990000">-</span>feed stream<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:authors [...]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :entries [{:link "LINK" :title "TITLE" :contents "CONTENT"} ...]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     ...}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_107">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">feedparser-clj</span> is a wrapper around the Java ROME library that is
capable of processing a variety formats of RSS and Atom feeds.
<span class="monospaced">feedparser-clj.core/parse-feed</span> returns a Clojure map that closely
mimics the underlying XML feed.</p></div>
<div class="paragraph"><p>Most of the time, what you care about will be under the <span class="monospaced">:entries</span>
key, which contains an array of maps corresponding to each RSS entry.</p></div>
<div class="paragraph"><p>Some RSS feeds will have <span class="monospaced">&lt;link rel="next"&gt;</span> elements that indicate
that the returned list is incomplete and more entries can be retrieved
by following the link. A lazy list of these RSS entries can be
generated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> next<span style="color: #990000">-</span>uri
  <span style="color: #FF0000">"Return the rel=next href in a feed."</span>
  <span style="color: #990000">[</span>feed<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;</span> feed
      <span style="color: #990000">:</span>entry<span style="color: #990000">-</span>links
      <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #<span style="color: #990000">(=</span> <span style="color: #990000">(:</span>rel <span style="color: #990000">%)</span> <span style="color: #FF0000">"next"</span><span style="color: #990000">)))</span>
      first
      <span style="color: #990000">:</span>href<span style="color: #990000">))</span>


<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> lazy<span style="color: #990000">-</span>stream
  <span style="color: #FF0000">"Return a lazy stream of RSS entries."</span>
  <span style="color: #990000">[</span>uri<span style="color: #990000">]</span>
   <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>raw<span style="color: #990000">-</span>response <span style="font-weight: bold"><span style="color: #000000">(rss</span></span><span style="color: #990000">/</span>parse<span style="color: #990000">-</span>feed uri<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(lazy</span></span><span style="color: #990000">-</span>cat <span style="color: #990000">(:</span>entries raw<span style="color: #990000">-</span>response<span style="color: #990000">)</span>
         <span style="font-weight: bold"><span style="color: #000000">(if</span></span><span style="color: #990000">-</span>let <span style="color: #990000">[</span>nxt <span style="font-weight: bold"><span style="color: #000000">(next</span></span><span style="color: #990000">-</span>uri raw<span style="color: #990000">-</span>response<span style="color: #990000">)]</span>
            <span style="font-weight: bold"><span style="color: #000000">(lazy</span></span><span style="color: #990000">-</span>stream nxt<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>To verify that lazy loading is happening, logging or tracing can be
added to <span class="monospaced">lazy-stream</span>, but it is also easy to confirm that you can
retrieve more entries than are present in a single fetch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> youtube<span style="color: #990000">-</span>feed <span style="color: #FF0000">"http://gdata.youtube.com/feeds/api/videos"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="font-weight: bold"><span style="color: #000000">(rss</span></span><span style="color: #990000">/</span>parse<span style="color: #990000">-</span>feed youtube<span style="color: #990000">-</span>feed<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 15</span></span>

<span style="font-weight: bold"><span style="color: #000000">(count</span></span> <span style="font-weight: bold"><span style="color: #000000">(take</span></span> <span style="color: #993399">50</span> <span style="font-weight: bold"><span style="color: #000000">(lazy</span></span><span style="color: #990000">-</span>stream youtube<span style="color: #990000">-</span>feed<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 50</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Be careful when evaluating a lazy sequence in a REPL, since it will attempt
to print the entire sequence. Use <span class="monospaced">take</span> to only realize part of
the sequence.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_106">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_read_write_xml">[sec_read_write_xml]</a>, for more information on reading and
  writing XML data like RSS feeds
</p>
</li>
<li>
<p>
<a href="#sec_http_request">[sec_http_request]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_email">Sending Email</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_108">Problem</h4>
<div class="paragraph"><p>You need to send emails from inside a Clojure application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_108">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">postal</span>, a thin wrapper over the JavaMail package, to send email
messages.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>draines/postal</tt></pre></div></div>
<div class="paragraph"><p>Send a message by invoking the <span class="monospaced">postal.core/send-message</span> function
with two maps, the first containing connection details and the second
containing message details. For example, to send an email message to
yourself via a Gmail account:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>postal<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>send<span style="color: #990000">-</span>message<span style="color: #990000">]])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Replace the following with your own credentials</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> email <span style="color: #FF0000">"&lt;&lt;your gmail address&gt;"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> pass <span style="color: #FF0000">"&lt;your gmail password&gt;"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> conn {<span style="color: #990000">:</span>host <span style="color: #FF0000">"smtp.gmail.com"</span>
           <span style="color: #990000">:</span>ssl true
           <span style="color: #990000">:</span>user email
           <span style="color: #990000">:</span>pass pass}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(send</span></span><span style="color: #990000">-</span>message conn {<span style="color: #990000">:</span>from email
                    <span style="color: #990000">:</span>to email
                    <span style="color: #990000">:</span>subject <span style="color: #FF0000">"A message, from the past"</span>
                    <span style="color: #990000">:</span>body <span style="color: #FF0000">"Hi there, me!"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:error :SUCCESS, :code 0, :message "messages sent"}</span></span></tt></pre></div></div>
<div class="paragraph"><p>If all is well, you should receive an email from yourself shortly
thereafter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>If you&#8217;ve set up two-factor authentication on your Gmail account,
<span class="monospaced">send-message</span> will fail with an <span class="monospaced">AuthenticationFailedException</span>.
To successfully authenticate, create an
<a href="http://bit.ly/gmail-app-specific">application-specific password</a> and use it as
the value for <span class="monospaced">pass</span> instead.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_108">Discussion</h4>
<div class="paragraph"><p><?dbhtml orphans="4"?>With the venerable JavaMail at its core, there isn&#8217;t much <span class="monospaced">postal</span>
leaves for you to worry about. Even Gmail&#8217;s oft-maligned
authentication setup can be tackled with a single <span class="monospaced">:ssl</span> key. While we
might normally suggest giving the native Java API a try for simple
email delivery, we prefer <span class="monospaced">postal</span> because it presents an API oriented
around data rather than objects.</p></div>
<div class="paragraph"><p>One of the places data orientation really shines is in specifying
connection details. The first argument to the <span class="monospaced">send-message</span> function
is a (versatile) map of connection details. Valid connection details
are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:host</span>
</dt>
<dd>
<p>
  Hostname of the desired SMTP server. Optional if running locally.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:port</span>
</dt>
<dd>
<p>
  Port of SMTP server. Numerous contextual defaults exist,
  including <span class="monospaced">465</span> when <span class="monospaced">:ssl</span> is set or <span class="monospaced">25</span> when <span class="monospaced">:tls</span> is set.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:user</span>
</dt>
<dd>
<p>
  Username to authenticate with (if authenticating).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:pass</span>
</dt>
<dd>
<p>
  Password to authenticate with (if authenticating).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:ssl</span>
</dt>
<dd>
<p>
  Enables SSL encryption if value is truthy.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:tls</span>
</dt>
<dd>
<p>
  Enables TLS encryption if value is truthy.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>When provided <em>no</em> connection details&#8212;either by omitting the first
argument or passing <literal>nil</literal>&#x2014;<literal>postal</literal> will attempt to route email
through a local <a href="http://bit.ly/wiki-sendmail">sendmail</a>
instance.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Since Amazon&#8217;s Simple Email Service (SES) can operate over SMTP,
it is possible to use <span class="monospaced">postal</span> to send email via Amazon&#8217;s
infrastructure.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Similar to connection details, messages themselves are represented as
simple maps of data. The full complement of standard headers are
supported as message keys:</p></div>
<div class="ulist"><ul>
<li>
<p>
Sender options
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">:from</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:reply-to</span>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Recipient options
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">:to</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:cc</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:bcc</span>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Content options
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">:subject</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:body</span>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Metadata options
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">:date</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:message-id</span>
</p>
</li>
<li>
<p>
<span class="monospaced">:user-agent</span>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Options specified beyond these will be attached to the message as
ancillary headers.</p></div>
<div class="paragraph"><p>When specifying recipients on the <span class="monospaced">:to</span>, <span class="monospaced">:cc</span>, or <span class="monospaced">:bcc</span> keys, values
may be either a single address or a sequence of addresses:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>to <span style="color: #FF0000">"joe@example.com"</span>
 <span style="color: #990000">:</span>cc <span style="color: #990000">[</span><span style="color: #FF0000">"joe@example.com"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"jim@example.com"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"jeff@example.com"</span><span style="color: #990000">]</span>
 <span style="color: #990000">:</span>bcc <span style="color: #FF0000">"archive@example.com"</span>}</tt></pre></div></div>
<div class="paragraph"><p>A message&#8217;s body can be specified as either a string or a sequence of
<em>part</em> maps. While the former delivers a simple plain-text email, the
latter will deliver a multipart <em>MIME</em> message. MIME (Multipurpose Internet Mail Extensions) is the standard
that allows email messages to contain attachments or other rich
content, such as HTML.</p></div>
<div class="paragraph"><p>A part map is made up of two values: <span class="monospaced">:type</span> and <span class="monospaced">:content</span>. For
message body parts, <span class="monospaced">:type</span> is the MIME type of the content, and
<span class="monospaced">:content</span> is the textual representation of said content. For example,
to create a message with both plain text and HTML representations of
the content:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>body <span style="color: #990000">[:</span>alternative
       {<span style="color: #990000">:</span>type <span style="color: #FF0000">"text/plain"</span>
        <span style="color: #990000">:</span>content <span style="color: #FF0000">"You just won the lottery!"</span>}
       {<span style="color: #990000">:</span>type <span style="color: #FF0000">"text/html"</span>
        <span style="color: #990000">:</span>content <span style="color: #FF0000">"&lt;html&gt;</span>
<span style="color: #FF0000">                    &lt;body&gt;</span>
<span style="color: #FF0000">                      &lt;p&gt;You just &lt;b&gt;won&lt;/b&gt; the lottery!&lt;/p&gt;</span>
<span style="color: #FF0000">                    &lt;/body&gt;</span>
<span style="color: #FF0000">                  &lt;/html&gt;"</span>}<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll notice the first "part" in the preceding body was not, in fact, a
part map, but the keyword <span class="monospaced">:alternative</span>. Messages are normally sent
in "mixed" mode, indicating to an email client that each part constitutes a
piece of the whole message. Messages of the <span class="monospaced">:alternative</span> type,
however, inform a client that each part represents the entire message,
albeit in differing formats.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you need to send complicated multipart messages and require a high
level of control over message creation, you should use the raw
JavaMail API to construct messages.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For attachments, the <span class="monospaced">:type</span> parameter behaves a little differently,
controlling whether the attachment resides inline (<span class="monospaced">:inline</span>) or as an
attachment (<span class="monospaced">:attachment</span>). The contents of an attachment are
specified by providing a <span class="monospaced">File</span> object for the <span class="monospaced">:content</span> key. An
attachment&#8217;s content type and name are generally inferred from the
<span class="monospaced">File</span> object, but they may be overridden via the <span class="monospaced">:content-type</span> and
<span class="monospaced">:file-name</span> keys, respectively.</p></div>
<div class="paragraph"><p>For example, forwarding all of your closest friends a picture of your
cat might look something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>body <span style="color: #990000">[</span>{<span style="color: #990000">:</span>type <span style="color: #FF0000">"text/plain"</span>
        <span style="color: #990000">:</span>content <span style="color: #FF0000">"Hey folks,</span><span style="color: #CC33CC">\n\n</span><span style="color: #FF0000">Check out these pictures of my cat!"</span>}
       {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>inline
        <span style="color: #990000">:</span>content <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> <span style="color: #FF0000">"/tmp/lester-flying-photoshop"</span><span style="color: #990000">)</span>
        <span style="color: #990000">:</span>content<span style="color: #990000">-</span>type <span style="color: #FF0000">"image/jpeg"</span>
        <span style="color: #990000">:</span>file<span style="color: #990000">-</span>name <span style="color: #FF0000">"lester-flying.jpeg"</span>}
       {<span style="color: #990000">:</span>type <span style="color: #990000">:</span>attachment
        <span style="color: #990000">:</span>content <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> <span style="color: #FF0000">"/tmp/lester-upside-down.jpeg"</span><span style="color: #990000">)</span>}<span style="color: #990000">]</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_107">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">postal</span>'s <a href="https://github.com/drewr/postal">GitHub repository</a>
</p>
</li>
<li>
<p>
JavaMail&#8217;s <a href="http://bit.ly/javamail-api-doc">API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_communicating_over_queues_using_rabbitmq">Communicating over Queues Using RabbitMQ</h3>
<div class="paragraph byline"><p>by Ryan Neufeld; originally submitted by Michael Klishin</p></div>
<div class="sect3">
<h4 id="_problem_109">Problem</h4>
<div class="paragraph"><p>You want to communicate between a number of applications using a
queueing broker such as <a href="http://rabbitmq.com">RabbitMQ</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_109">Solution</h4>
<div class="paragraph"><p>Use <a href="http://clojurerabbitmq.info">Langohr</a>, a small
RabbitMQ client, to communicate with RabbitMQ.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.novemberain/langohr "1.6.0"]</span> to your
project&#8217;s dependencies, or follow along in a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>novemberain/langohr</tt></pre></div></div>
<div class="paragraph"><p>In order to follow along with this recipe, you need to have RabbitMQ
<a href="http://bit.ly/rmq-download">installed and running</a>.</p></div>
<div class="paragraph"><p>Once installed, start a standalone RabbitMQ server with the command
<strong><span class="monospaced">rabbitmq-server</span></strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ rabbitmq-server</tt></pre></div></div>
<div class="paragraph"><p>Prior to performing any operations against RabbitMQ, you must connect
to a server and open a communication channel. A channel is the medium
over which you can produce and consume messages:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'langohr<span style="color: #990000">.</span>core
         'langohr<span style="color: #990000">.</span>channel<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect to local RabbitMQ cluster node on localhost:5672</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> conn <span style="font-weight: bold"><span style="color: #000000">(langohr</span></span><span style="color: #990000">.</span>core<span style="color: #990000">/</span>connect {<span style="color: #990000">:</span>hostname <span style="color: #FF0000">"localhost"</span>}<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Open a channel against the connection</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> ch <span style="font-weight: bold"><span style="color: #000000">(langohr</span></span><span style="color: #990000">.</span>channel<span style="color: #990000">/</span>open conn<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>In RabbitMQ, messages are published to <em>exchanges</em>, routed to <em>queues</em>
via a <em>binding</em>, then finally consumed by consumers. There are a
number of different exchange types that vary the semantics of
delivery; the most basic exchange type is <em>direct</em>, which routes
messages based on their <em>routing key</em>.</p></div>
<div class="paragraph"><p>To construct a pipeline between producer and consumer, start by
invoking <span class="monospaced">langohr.queue/declare</span> to create a queue with the desired
name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>langohr<span style="color: #990000">.</span>queue <span style="color: #990000">:</span>as lq<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> resize<span style="color: #990000">-</span>queue <span style="color: #FF0000">"imaging.resize"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(lq</span></span><span style="color: #990000">/</span>declare ch resize<span style="color: #990000">-</span>queue<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:queue "imaging.resize",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :consumer-count 0,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :message_count 0,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :consumer_count 0,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :message-count 0}</span></span></tt></pre></div></div>
<div class="paragraph"><p>By default, RabbitMQ creates a binding between the empty exchange (an
empty string) and each queue. You can now publish a message to the
<span class="monospaced">"imaging.resize"</span> queue by invoking <span class="monospaced">langohr.basic/publish</span> with the
channel, direct exchange, routing key (your queue name), and a message:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>langohr<span style="color: #990000">.</span>basic <span style="color: #990000">:</span>as lb<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>publish ch <span style="color: #FF0000">""</span> resize<span style="color: #990000">-</span>queue <span style="color: #FF0000">"hello.jpg"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To consume messages from a queue synchronously, invoke
<span class="monospaced">langohr.basic/get</span> with the channel and queue name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> hello<span style="color: #990000">-</span>msg <span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>get ch resize<span style="color: #990000">-</span>queue<span style="color: #990000">))</span>

hello<span style="color: #990000">-</span>msg
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{:routing-key "imaging.resize", :headers nil ...} #&lt;byte[] [B@2b195c88&gt;]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> <span style="font-weight: bold"><span style="color: #000000">(last</span></span> hello<span style="color: #990000">-</span>msg<span style="color: #990000">)</span> <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "hello.jpg"</span></span></tt></pre></div></div>
<div class="paragraph"><p>To consume messages asynchronously as they appear, use
<span class="monospaced">langohr.consumers/subscribe</span> to subscribe to a queue. The handler
function you provide to <span class="monospaced">subscribe</span> will be called for each message
published to the queue:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>langohr<span style="color: #990000">.</span>consumers <span style="color: #990000">:</span>as lc<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> resize<span style="color: #990000">-</span>image<span style="color: #990000">-</span>handler
  <span style="color: #FF0000">"Spawn a resize process for each resize message received"</span>
  <span style="color: #990000">[</span>ch metadata <span style="color: #990000">^</span>bytes payload<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>filename <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> payload <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"Resizing file %s"</span> filename<span style="color: #990000">))))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Subscribe to the queue with the handler function</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tag <span style="font-weight: bold"><span style="color: #000000">(lc</span></span><span style="color: #990000">/</span>subscribe ch resize<span style="color: #990000">-</span>queue resize<span style="color: #990000">-</span>image<span style="color: #990000">-</span>handler<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; The return value of subscribe is a subscription tag</span></span>
tag
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "amq.ctag-7hsNsSqLDEEoES5AkIC6XQ"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>publish ch <span style="color: #FF0000">""</span> resize<span style="color: #990000">-</span>queue <span style="color: #FF0000">"hello-again.jpg"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Resizing file hello-again.jpg</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Unsubscribe resize-image-handler via the tag value</span></span>
<span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>cancel ch tag<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_109">Discussion</h4>
<div class="paragraph"><p>At this point, you&#8217;ve round-tripped a few messages to RabbitMQ, but
you&#8217;ve barely scratched the surface of what Langohr and RabbitMQ are
capable of. Langohr is a small RabbitMQ client wrapping the Java
RabbitMQ library that supports AMQP 0-9-1 and RabbitMQ extensions of
AMQP, and provides an HTTP API client.</p></div>
<div class="paragraph"><p>AMQP 0-9-1, and by extension, Langohr, centers around a few main
concepts: <em>exchanges</em>, <em>queues</em>, and <em>bindings</em>.</p></div>
<div class="sect4">
<h5 id="_exchanges">Exchanges</h5>
<div class="paragraph"><p>An exchange is very much like a post office: when a message is
published to an exchange, the exchange will route the message to one
or more queues. How those messages are routed to queues is dependent
on both the exchange type and the bindings between the
exchange/queues.</p></div>
<div class="paragraph"><p>There are multiple exchange types, each with its own routing
semantics&#8212;see <a href="#tab_builtin_exchange_types">[tab_builtin_exchange_types]</a>.
Custom exchange types can be created to deal with sophisticated
routing scenarios (e.g., routing based on content or geolocation data)
or just for convenience.</p></div>
<table class="tableblock frame-all grid-all" id="tab_builtin_exchange_types"
style="
width:100%;
">
<caption class="title">Table 1. Built-in exchange types</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > Name </th>
<th class="tableblock halign-left valign-top" > Behavior </th>
<th class="tableblock halign-left valign-top" > Predeclared exchange</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Direct</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1:1, routed based on routing key</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">""</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Fanout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1:N, ignoring routing key</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">"amq.fanout"</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Topic</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1:N, taking routing key into consideration</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">"amq.topic"</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Headers</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1:1, taking into consideration any number of headers</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">"amq.match"</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>To declare one of the built-in exchanges, use one of
<span class="monospaced">langohr.exchange/fanout</span>, <span class="monospaced">langohr.exchange/topic</span>,
<span class="monospaced">langohr.exchange/direct</span>, or <span class="monospaced">langohr.exchange/headers</span>. Each of these
functions exposes the relevant options for that exchange type,
ultimately invoking <span class="monospaced">langohr.exchange/declare</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>langohr<span style="color: #990000">.</span>exchange <span style="color: #990000">:</span>as le<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create a fanout exchange for image processing completion</span></span>
<span style="font-weight: bold"><span style="color: #000000">(le</span></span><span style="color: #990000">/</span>fanout ch <span style="color: #FF0000">"imaging.complete"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Exchanges have several attributes associated with them:</p></div>
<div class="ulist"><ul>
<li>
<p>
Name
</p>
</li>
<li>
<p>
Type (direct, fanout, topic, headers, or some custom type)
</p>
</li>
<li>
<p>
Durability (should it survive broker restarts?)
</p>
</li>
<li>
<p>
Whether the exchange is autodeleted when no longer used
</p>
</li>
<li>
<p>
Custom metadata (sometimes known as <span class="monospaced">x-arguments</span>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Using <span class="monospaced">langohr.exchange/declare</span> directly, you can customize these
attributes to create your own types of exchanges.</p></div>
</div>
<div class="sect4">
<h5 id="_queues">Queues</h5>
<div class="paragraph"><p><?dbhtml orphans="4"?>A queue is like a mailbox in a post office. The
<span class="monospaced">langohr.queue/declare</span> function creates named queues. Apart from the
name, this function accepts a number of keyword arguments that vary
the characteristics of the queue, including whether it is <span class="monospaced">:durable</span>,
<span class="monospaced">:exclusive</span>, or <span class="monospaced">:auto-delete</span>. Other arguments can be specified in an
<span class="monospaced">:arguments</span> value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(lq</span></span><span style="color: #990000">/</span>declare ch <span style="color: #FF0000">"imaging.transcode"</span> <span style="color: #990000">:</span>durable true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:queue "imaging.transcode", ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Queues with unique names can be generated using the
<span class="monospaced">langohr.queue/declare-server-named</span> function. This functions
similarly to <span class="monospaced">langohr.queue/declare</span>, but without a name argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(lq</span></span><span style="color: #990000">/</span>declare<span style="color: #990000">-</span>server<span style="color: #990000">-</span>named ch<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "amq.gen-FcFv8JD9K8-4NuT8kC3jKA"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Unlike exchanges, queues in RabbitMQ are all of the same type.</p></div>
</div>
<div class="sect4">
<h5 id="_bindings">Bindings</h5>
<div class="paragraph"><p>As you saw in the solution, a direct exchange has an implicit
binding between the default exchange and every queue, by name. In the
wild, however, queues are usually bound to exchanges explicitly. You
can create your own bindings by invoking <span class="monospaced">langohr.queue/bind</span> with a
channel, queue name, and exchange name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Create a unique completion queue...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> completion<span style="color: #990000">-</span>queue <span style="font-weight: bold"><span style="color: #000000">(lq</span></span><span style="color: #990000">/</span>declare<span style="color: #990000">-</span>server<span style="color: #990000">-</span>named ch<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; and bind it to the imaging.complete fanout</span></span>
<span style="font-weight: bold"><span style="color: #000000">(lq</span></span><span style="color: #990000">/</span>bind ch completion<span style="color: #990000">-</span>queue <span style="color: #FF0000">"imaging.complete"</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_publishing">Publishing</h5>
<div class="paragraph"><p>Messages are published to an exchange using the
<span class="monospaced">langohr.basic/publish</span> function. This function takes three primary
arguments (beyond channel):</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
The name of an exchange
</dt>
<dd>
<p>
Either a user-made exchange such as <span class="monospaced">"imaging.complete"</span>, or a built-in like <span class="monospaced">"amq.fanout"</span> or <span class="monospaced">""</span>
</p>
</dd>
<dt class="hdlist1">
A routing key
</dt>
<dd>
<p>
Used by the exchange to perform type-specific routing of messages to queue(s)
</p>
</dd>
<dt class="hdlist1">
A message
</dt>
<dd>
<p>
A string body for the message to be delivered to the queue
</p>
</dd>
</dl></div>
<div class="paragraph"><p>As optional arguments, <span class="monospaced">publish</span> allows users to specify a plethora of
message headers as keyword arguments. For the full list, see the
docstring for the <span class="monospaced">publish</span> function.</p></div>
</div>
<div class="sect4">
<h5 id="_consuming">Consuming</h5>
<div class="paragraph"><p>Having declared a number of queues, there are two ways to consume
messages from them:</p></div>
<div class="ulist"><ul>
<li>
<p>
Pull, using <span class="monospaced">langohr.basic/get</span>
</p>
</li>
<li>
<p>
Push, using <span class="monospaced">langohr.consumers/subscribe</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the Pull API, you make a synchronous invocation of the <span class="monospaced">get</span> function
to retrieve a single message from a queue. The return value of <span class="monospaced">get</span>
is a tuple of metadata map and a body. The body payload, as returned,
is an array of bytes&#8212;for plain-text messages you can use the string
constructor (<span class="monospaced">String.</span>) to intern those bytes to a string. Since
<span class="monospaced">String</span> byte arrays are encoded using UTF-8, it is important to
invoke the <span class="monospaced">String</span> constructor with an encoding option of <span class="monospaced">"UTF-8"</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>publish ch <span style="color: #FF0000">""</span> resize<span style="color: #990000">-</span>queue <span style="color: #FF0000">"hello.jpg"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[[</span>_ body<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>get ch resize<span style="color: #990000">-</span>queue<span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> body <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "hello.jpg"</span></span></tt></pre></div></div>
<div class="paragraph"><p>When no messages are present on a queue, <span class="monospaced">get</span> will return <span class="monospaced">nil</span>.</p></div>
<div class="paragraph"><p>In the Push API, you subscribe to a queue using
<span class="monospaced">langohr.consumers/subscribe</span>, providing a message handler function that
will be invoked for each message the queue receives. This function
will be invoked with three arguments: a channel, metadata, and the body
bytes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; A run-of-the-mill handler function</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> resize<span style="color: #990000">-</span>image<span style="color: #990000">-</span>handler
  <span style="color: #FF0000">"Spawn a resize process for each resize message received"</span>
  <span style="color: #990000">[</span>ch metadata <span style="color: #990000">^</span>bytes payload<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>filename <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> payload <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(format</span></span> <span style="color: #FF0000">"Resizing file %s"</span> filename<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">subscribe</span> is a nonblocking call, and upon completion will return a
tag string that can be used to later cancel the subscription using
<span class="monospaced">langohr.consumers/cancel</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">subscribe</span> function also allows you to specify a large number of
queue life cycle functions, documented at length in the
<span class="monospaced">langohr.consumers/create-default</span> docstring.</p></div>
</div>
<div class="sect4">
<h5 id="_acknowledgment">Acknowledgment</h5>
<div class="paragraph"><p>Consumed messages need to be acknowledged. That can happen
automatically (RabbitMQ will consider a message acknowledged as soon
as it sends it to a consumer) or manually.</p></div>
<div class="paragraph"><p>When a message is acknowledged, it is removed from the queue. If a
channel closes unexpectedly before a delivery is acknowledged, it will
be automatically requeued by RabbitMQ. Note that these acknowledgments have application-specific semantics
and help ensure that messages are processed properly.</p></div>
<div class="paragraph"><p>With manual acknowledgment, it is application&#8217;s responsibility to
either acknowledge or reject a delivery. This is done with
<span class="monospaced">langohr.basic/ack</span> and <span class="monospaced">langohr.basic/nack</span>, respectively, each of which
takes a metadata attribute called <span class="monospaced">delivery-tag</span> (the delivery ID). To
enable manual acknowledgments, pass <span class="monospaced">:auto-ack false</span> to
<span class="monospaced">langohr.consumers/subscribe</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> manual<span style="color: #990000">-</span>ack<span style="color: #990000">-</span>handler
  <span style="color: #FF0000">"Spawn a resize process for each resize message received"</span>
  <span style="color: #990000">[</span>ch {<span style="color: #990000">:</span>keys <span style="color: #990000">[</span>delivery<span style="color: #990000">-</span>tag<span style="color: #990000">]</span>} <span style="color: #990000">^</span>bytes payload<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(try</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> payload <span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">)</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Do some work, then acknowledge the message</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>ack ch delivery<span style="color: #990000">-</span>tag<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> Throwable t
      <span style="font-style: italic"><span style="color: #9A1900">;; Reject message</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>nack ch delivery<span style="color: #990000">-</span>tag<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(lc</span></span><span style="color: #990000">/</span>subscribe ch resize<span style="color: #990000">-</span>queue manual<span style="color: #990000">-</span>ack<span style="color: #990000">-</span>handler <span style="color: #990000">:</span>auto<span style="color: #990000">-</span>ack false<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Note that if you requeue a message with just one consumer on it, it
will be redelivered immediately.</p></div>
<div class="paragraph"><p>It is also possible to control how many messages will be pushed to the
client before it must receive an ack for at least one of them. This is
known as the <em>prefetch setting</em> and is set using <span class="monospaced">langohr.basic/qos</span>.
This setting applies across an entire channel:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Prefetch a dozen messages</span></span>
<span style="font-weight: bold"><span style="color: #000000">(lb</span></span><span style="color: #990000">/</span>qos ch <span style="color: #993399">12</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>RabbitMQ queues can also be mirrored between cluster nodes for high
availability, have a bounded length or expiration period for messages,
and more. To learn more, see RabbitMQ and Langohr documentation sites.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_108">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://clojurerabbitmq.info">Langohr documentation</a>
</p>
</li>
<li>
<p>
Langohr&#8217;s <a href="http://bit.ly/langohr-docs">API reference</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/rmq-getting-started">RabbitMQ tutorials</a>
</p>
</li>
<li>
<p>
If you need low-level access to RabbitMQ, you may want to
  investigate using Clojure&#8217;s Java interop to interact with the
  <a href="http://bit.ly/rmq-java-client">RabbitMQ Java client</a>, the
  library upon which Langohr is based.
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_communicating_with_embedded_devices_via_mqtt">Communicating with Embedded Devices via MQTT</h3>
<div class="paragraph byline"><p>By Sandeep Nangia</p></div>
<div class="sect3">
<h4 id="_problem_110">Problem</h4>
<div class="paragraph"><p>You want to communicate with embedded devices (think "Internet of
things") using a publish/subscribe model.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_110">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/clojurewerkz/machine_head">Machine Head</a>, a
Clojure library that enables machine-to-machine (M2M) communication via the
<a href="http://mqtt.org/">MQTT</a> protocol. The protocol requires an existing
MQTT broker with which all devices (or machines) will communicate by
publishing messages or subscribing to messages on specific topics. You can use
the <a href="http://mosquitto.org/">Mosquitto</a> broker with its test installation at <em>tcp://test.mosquitto.org:1883</em> (of course, you
need a functional Internet connection on your machine).</p></div>
<div class="paragraph"><p>To follow along with this recipe, launch a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clojurewerkz/machine_head</tt></pre></div></div>
<div class="paragraph"><p>To start, create a simple <span class="monospaced">connect-and-subscribe</span> function that
listens to a topic and prints messages it receives:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>machine<span style="color: #990000">-</span>head<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as mh<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> message<span style="color: #990000">-</span>handler <span style="color: #990000">[</span>topic meta payload<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>p <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #009900">char</span> payload<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"received "</span> p <span style="color: #FF0000">"on topic "</span> topic<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> connect<span style="color: #990000">-</span>and<span style="color: #990000">-</span>subscribe <span style="color: #990000">[</span>broker<span style="color: #990000">-</span>addr topics subscriberid<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>qos<span style="color: #990000">-</span>levels <span style="font-weight: bold"><span style="color: #000000">(vec</span></span> <span style="font-weight: bold"><span style="color: #000000">(repeat</span></span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> topics<span style="color: #990000">)</span> <span style="color: #993399">2</span><span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; All at qos 2</span></span>
        topics<span style="color: #990000">-</span>and<span style="color: #990000">-</span>qos <span style="font-weight: bold"><span style="color: #000000">(zipmap</span></span> topics qos<span style="color: #990000">-</span>levels<span style="color: #990000">)</span>
        conn<span style="color: #990000">-</span>sub <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>connect broker<span style="color: #990000">-</span>addr subscriberid<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>connected<span style="color: #990000">?</span> conn<span style="color: #990000">-</span>sub<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(do</span></span>
        <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>subscribe conn<span style="color: #990000">-</span>sub topics<span style="color: #990000">-</span>and<span style="color: #990000">-</span>qos message<span style="color: #990000">-</span>handler<span style="color: #990000">)</span>
        conn<span style="color: #990000">-</span>sub<span style="color: #990000">))))</span> <span style="font-style: italic"><span style="color: #9A1900">;; Return conn-sub for later mh/disconnect...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> subscriberid <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>generate<span style="color: #990000">-</span>id<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; or use a unique id</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (def subscriberid "SNSubscriber01")</span></span>

<span style="font-weight: bold"><span style="color: #000000">(connect</span></span><span style="color: #990000">-</span>and<span style="color: #990000">-</span>subscribe <span style="color: #FF0000">"tcp://test.mosquitto.org:1883"</span>
                       <span style="color: #990000">[</span><span style="color: #FF0000">"SNControlNetwork/Florida/device1"</span><span style="color: #990000">]</span> subscriberid<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Open another terminal window and start a second <span class="monospaced">lein-try</span> REPL session.
Use the following code to publish messages to the broker. Note that
subscriber must be connected already so as not to lose incoming
messages:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>machine<span style="color: #990000">-</span>head<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as mh<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> connect<span style="color: #990000">-</span>and<span style="color: #990000">-</span>publish <span style="color: #990000">[</span>broker<span style="color: #990000">-</span>addr client<span style="color: #990000">-</span>id topic<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>qos <span style="color: #993399">2</span>
        retained false
        conn  <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>connect broker<span style="color: #990000">-</span>addr client<span style="color: #990000">-</span>id<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>connected<span style="color: #990000">?</span> conn<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(do</span></span> <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>n <span style="color: #993399">5</span><span style="color: #990000">]</span>
            <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>payload <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"msg"</span> n<span style="color: #990000">)]</span>
              <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>publish conn topic payload qos retained<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"published "</span> payload<span style="color: #990000">)))</span>
          <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>disconnect conn<span style="color: #990000">)))))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> pubclientid <span style="font-weight: bold"><span style="color: #000000">(mh</span></span><span style="color: #990000">/</span>generate<span style="color: #990000">-</span>id<span style="color: #990000">))</span>
pubclientid
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "ryan.1384135173618"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(connect</span></span><span style="color: #990000">-</span>and<span style="color: #990000">-</span>publish <span style="color: #FF0000">"tcp://test.mosquitto.org:1883"</span> pubclientid
                       <span style="color: #FF0000">"SNControlNetwork/Florida/device1"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out* of publish REPL</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; published  msg0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; published  msg1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; published  msg2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; published  msg3</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; published  msg4</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out* of client REPL</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; received  msg0 on topic  SNControlNetwork/Florida/device1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; received  msg1 on topic  SNControlNetwork/Florida/device1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; received  msg2 on topic  SNControlNetwork/Florida/device1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; received  msg3 on topic  SNControlNetwork/Florida/device1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; received  msg4 on topic  SNControlNetwork/Florida/device1</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_110">Discussion</h4>
<div class="paragraph"><p><a href="http://mqtt.org">MQTT</a> is an open, lightweight publish/subscribe
messaging protocol. It is useful for connections where bandwidth is at
a premium and/or connections are unreliable. While the AMQP protocol excels
at various scenarios for business messaging, MQTT is usually the
choice for smaller payloads and last-mile connectivity because it is simple
to implement in hardware. The MQTT protocol has the following properties
that make it good for constrained networks:</p></div>
<div class="ulist"><ul>
<li>
<p>
Designed for devices with limited resources, like
     battery-operated 8-bit controllers.
</p>
</li>
<li>
<p>
Internally compresses into bitwise headers and
     variable-length fields. The smallest possible packet size is a
     mere two bytes.
</p>
</li>
<li>
<p>
No polling required. Implements asynchronous bidirectional push delivery
     of messages.
</p>
</li>
<li>
<p>
Supports always-connected and sometimes-connected models.
</p>
</li>
<li>
<p>
Tested with low-bandwidth networks like VSAT and GPRS.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The protocol defines three possible Quality of Service (QoS) values: <span class="monospaced">0</span>, <span class="monospaced">1</span>, and <span class="monospaced">2</span>,
corresponding to fire-and-forget, at-least-once, and exactly-once
qualities of service. QoS parameters <span class="monospaced">1</span> and <span class="monospaced">2</span> require persistent
storage on the client so as to save the message until an acknowledgment
arrives. In the preceding recipe, the default persistence implementation
provided by the library is used.</p></div>
<div class="paragraph"><p>MQTT also has a concept of retention of messages. If you were to set
<span class="monospaced">retained</span> to <span class="monospaced">true</span> in the <span class="monospaced">connect-and-publish</span> function, the broker
would remember the last known retained message on the topic. When the
subscriber connects, it is given the last message (for which
<span class="monospaced">retained</span> was <span class="monospaced">true</span>) by the broker and does not have to wait to
receive the first message.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>WebSphere and <a href="http://bit.ly/rmq-mqtt">RabbitMQ</a> also
implement MQTT and can be used instead of Mosquitto. While the preceding
code used the Mosquitto test broker (<em>tcp://test.mosquitto.org:1883</em>), you can
install your own Mosquitto broker using the
<a href="http://bit.ly/mosquitto-broker">MQTT
installation instructions</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The topics are usually defined with the separator <span class="monospaced">/</span> defining
hierarchies. As an example, the sensor devices of a particular domain,
<span class="monospaced">SNControl</span>, might be publishing their values to
<span class="monospaced">SNControl/Florida/device1</span>, <span class="monospaced">SNControl/Florida/device2</span>, and so on.
Meanwhile, the devices in domain <span class="monospaced">RKNControl</span> might publish their values to
<span class="monospaced">RKNControl/Washington/device1</span>, for example. Naming the topics in this way
helps in subscribing to multiple topics based on wildcards.</p></div>
<div class="paragraph"><p>This is how wildcards are used:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">/</span>
</dt>
<dd>
<p>
Used as a separator.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">+</span>
</dt>
<dd>
<p>
The single-level wildcard and can appear anywhere in the string.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">#</span>
</dt>
<dd>
<p>
A multilevel wildcard and needs to appear at the end of the string.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>For example, these subscriptions are possible:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">SNControl/#</span>
</dt>
<dd>
<p>
Any device under <span class="monospaced">SNControl</span> (e.g., <span class="monospaced">SNControl/Florida/device1/sensor1</span>, <span class="monospaced">SNControl/Florida/device1/sensor2</span> and <span class="monospaced">SNControl/California/device1</span>) will match.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">SNControl/+/device1</span>
</dt>
<dd>
<p>
Any <span class="monospaced">device1</span> in states under domain <span class="monospaced">SNControl</span> will match(e.g., <span class="monospaced">SNControl/Florida/device1</span> and <span class="monospaced">SNControl/California/device1</span>).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">SNControl/+/+/sensor1</span>
</dt>
<dd>
<p>
Any <span class="monospaced">sensor1</span> in states under domain <span class="monospaced">SNControl</span> will match (e.g., <span class="monospaced">SNControl/Florida/device1/sensor1</span> and <span class="monospaced">SNControl/Florida/device2/sensor1</span>).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In the preceding code, the <span class="monospaced">connect-and-subscribe</span> method uses the
callback handler <span class="monospaced">message-handler</span> to process incoming messages
arriving from the broker. In the <span class="monospaced">connect-and-subscribe</span> method, the
<span class="monospaced">connect</span> method from the Machine Head library is invoked by providing it
the broker address and client ID (generated using <span class="monospaced">generate-id</span>, or
some other unique ID). Then it checks that the connection has been
established using the <span class="monospaced">connected?</span> method. The <span class="monospaced">subscribe</span> method is
invoked with the connection, a map of topics to subscribe to with their respective qos and a message
handler. The subscriber then waits for some time
and disconnects using the <span class="monospaced">disconnect</span> method.</p></div>
<div class="paragraph"><p>The <span class="monospaced">connect-and-publish</span> method calls the method <span class="monospaced">connect</span>, which
accepts the broker address and client ID and returns the connection
<span class="monospaced">conn</span>. Then it checks if the connection is successful with the
<span class="monospaced">connected?</span> method and invokes the <span class="monospaced">publish</span> method to publish
messages (a few times) to the broker. The <span class="monospaced">publish</span> method accepts as parameters the
connection, topic string, payload, QoS value, and <span class="monospaced">retained</span>. The QoS value of <span class="monospaced">2</span> corresponds to exactly-once delivery. The <span class="monospaced">retained</span> value of <span class="monospaced">false</span> instructs the broker not to retain messages.
Finally, the <span class="monospaced">disconnect</span> method disconnects from the broker.</p></div>
<div class="paragraph"><p>While the preceding code fragment just prints the incoming messages, you
could potentially use the messages in some other way (e.g., triggering
some actions based on an alarm that the code has received).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_109">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://mqtt.org/">MQTT protocol website</a>
</p>
</li>
<li>
<p>
The <a href="http://clojuremqtt.info/">documentation</a> of the
  <a href="https://github.com/clojurewerkz/machine_head">Machine Head</a> library
</p>
</li>
<li>
<p>
The <a href="http://www.eclipse.org/paho/">Eclipse Paho library</a>, the Java
  library that Machine Head uses under the hood to communicate using
  MQTT
</p>
</li>
<li>
<p>
<a href="http://mosquitto.org/">Mosquitto</a>, an open source message broker that implements the MQTT
  protocol
</p>
</li>
<li>
<p>
<a href="http://bit.ly/mqtt-paper"><em>Building Smarter
  Planet Solutions with MQTT and IBM WebSphere MQ Telemetry</em></a> (IBM
  Redbooks), by Valerie Lampkin <em>et al.</em>, for a more detailed explanation of MQTT
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/inno-begins-at-home">TED talk</a> by Andy
  Stanford-Clark, one of the inventors of MQTT&#8212;a humorous and informative session on how MQTT can be used
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_concurrent_zmq">Using ZeroMQ Concurrently</h3>
<div class="paragraph byline"><p>by Kevin J. Lynagh</p></div>
<div class="sect3">
<h4 id="_problem_111">Problem</h4>
<div class="paragraph"><p>You want to use ZeroMQ concurrently, but ZeroMQ sockets are not
thread-safe. You <em>could</em> manually set up mutual exclusion via locks or
other Java concurrency primitives, but you&#8217;d rather use a simpler
method.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_111">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/lynaghk/zmq-async"><span class="monospaced">zmq-async</span></a> library to
simplify concurrent usage of ZeroMQ via <span class="monospaced">core.async</span>.</p></div>
<div class="paragraph"><p>In order to follow along with this recipe, your system should have
ZeroMQ 3.2 installed.</p></div>
<div class="paragraph"><p>If you&#8217;re on a Mac and have the <a href="http://brew.sh">Homebrew</a> package
manager installed, use this command to install it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ brew install zeromq</tt></pre></div></div>
<div class="paragraph"><p>Or, if you are on Ubuntu:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ apt-get install libzmq3</tt></pre></div></div>
<div class="paragraph"><p>Otherwise, visit <a href="http://bit.ly/zmq-intro">ØMQ&#8217;s
downloads page</a>.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.keminglabs/zmq-async "0.1.0"]</span> to your
project&#8217;s dependencies, or follow along in a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>keminglabs/zmq-async</tt></pre></div></div>
<div class="paragraph"><p>Here&#8217;s a simple ping-pong between two asynchronous <span class="monospaced">go</span> blocks in
<span class="monospaced">core.async</span>, communicating via a ZeroMQ in-process socket:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>com<span style="color: #990000">.</span>keminglabs<span style="color: #990000">.</span>zmq<span style="color: #990000">-</span>async<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>register<span style="color: #990000">-</span>socket<span style="color: #990000">!]]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>async <span style="color: #990000">:</span>refer <span style="color: #990000">[&gt;!</span> <span style="color: #990000">&lt;!</span> go chan sliding<span style="color: #990000">-</span>buffer close<span style="color: #990000">!]])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> addr <span style="color: #FF0000">"inproc://ping-pong"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> server<span style="color: #990000">-</span>in  <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> server<span style="color: #990000">-</span>out <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> client<span style="color: #990000">-</span>in  <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> client<span style="color: #990000">-</span>out <span style="font-weight: bold"><span style="color: #000000">(chan</span></span> <span style="font-weight: bold"><span style="color: #000000">(sliding</span></span><span style="color: #990000">-</span>buffer <span style="color: #993399">64</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(register</span></span><span style="color: #990000">-</span>socket<span style="color: #990000">!</span> {<span style="color: #990000">:</span>in server<span style="color: #990000">-</span>in
                   <span style="color: #990000">:</span>out server<span style="color: #990000">-</span>out
                   <span style="color: #990000">:</span>socket<span style="color: #990000">-</span>type <span style="color: #990000">:</span>rep
                   <span style="color: #990000">:</span>configurator <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>socket<span style="color: #990000">]</span> <span style="color: #990000">(.</span>bind socket addr<span style="color: #990000">))</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(register</span></span><span style="color: #990000">-</span>socket<span style="color: #990000">!</span> {<span style="color: #990000">:</span>in client<span style="color: #990000">-</span>in
                   <span style="color: #990000">:</span>out client<span style="color: #990000">-</span>out
                    <span style="color: #990000">:</span>socket<span style="color: #990000">-</span>type <span style="color: #990000">:</span>req
                   <span style="color: #990000">:</span>configurator <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>socket<span style="color: #990000">]</span> <span style="color: #990000">(.</span>connect socket addr<span style="color: #990000">))</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(do</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;; A simple server worker that waits for incoming requests and</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;; responds with "pong"</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(go</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">3</span><span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> <span style="color: #990000">(&lt;!</span> server<span style="color: #990000">-</span>out<span style="color: #990000">)))</span>
      <span style="color: #990000">(&gt;!</span> server<span style="color: #990000">-</span>in <span style="color: #FF0000">"pong"</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(close</span></span><span style="color: #990000">!</span> server<span style="color: #990000">-</span>in<span style="color: #990000">))</span>

  <span style="font-style: italic"><span style="color: #9A1900">;; A simple client worker that sends a "ping" request and awaits</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;;  a response</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(go</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">3</span><span style="color: #990000">]</span>
      <span style="color: #990000">(&gt;!</span> client<span style="color: #990000">-</span>in <span style="color: #FF0000">"ping"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> <span style="color: #990000">(&lt;!</span> client<span style="color: #990000">-</span>out<span style="color: #990000">))))</span>
    <span style="font-weight: bold"><span style="color: #000000">(close</span></span><span style="color: #990000">!</span> client<span style="color: #990000">-</span>in<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ping</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; pong</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ping</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; pong</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ping</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; pong</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_111">Discussion</h4>
<div class="paragraph"><p>ZeroMQ is a message-oriented socket system that supports many
communication styles (request/reply, pub/sub, etc.) on top of many
transport layers (intra-process, inter-process, inter-machine via TCP,
etc.) with bindings to many languages. ZeroMQ sockets are a great
substrate upon which to build service-oriented architectures. ZeroMQ
sockets have less overhead than HTTP and are architecturally more
flexible, supporting publish/subscribe, fanout, and other
topologies in addition to request/reply.</p></div>
<div class="paragraph"><p>However, ZeroMQ sockets are not thread-safe&#8212;concurrent usage
typically requires explicit locking or dedicated threads and queues.
The <span class="monospaced">zmq-async</span> library handles all of that for you, creating ZeroMQ
sockets on your behalf and giving you access to them via thread-safe
<span class="monospaced">core.async</span> channels.</p></div>
<div class="paragraph"><p>The <span class="monospaced">zmq-async</span> library provides one function,
<span class="monospaced">com.keminglabs.zmq-async.core/register-socket!</span>, which associates a
ZeroMQ socket with either one or two <span class="monospaced">core.async</span> channels: <span class="monospaced">:in</span> (to which you can
write strings or byte arrays) and <span class="monospaced">:out</span> (from which you can read
byte arrays). Writing a Clojure collection of strings and/or byte
arrays to a channel using <span class="monospaced">&gt;!</span> sends a multipart message. Received
multipart messages are placed on <span class="monospaced">core.async</span> channels. Reading these
messages with <span class="monospaced">&lt;!</span> will yield a vector of byte arrays.</p></div>
<div class="paragraph"><p>To simulate two asynchronous processes interacting over ZeroMQ, the
preceding sample uses two <span class="monospaced">go</span> blocks that read from and write to the registered
channels. Each <span class="monospaced">go</span> block will begin executing immediately in
background threads. The "server" block will wait for and reply to
three requests (<span class="monospaced">&lt;!</span> blocks until it receives a value), replying with
"pong" each time. Concurrently, the "client" block will make three
"ping" requests, awaiting a reply before moving on to the next
request. Finally, after both blocks are done working, they each
close their channels using <span class="monospaced">close!</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">register-socket!</span> function can be given an already-created ZeroMQ
socket, but typically you would have the library create a socket for
you by passing the <span class="monospaced">:socket-type</span> and a <span class="monospaced">:configurator</span>. The
configurator is a function that is passed the raw ZeroMQ socket
object. This function is run on the socket after it is created in
order to connect/bind addresses, set pub/sub subscriptions, and
otherwise configure the socket.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The implicit context supporting <span class="monospaced">register-socket!</span> can only
handle one incoming/outgoing message at a time. If you need sockets to
work in parallel (i.e., you don&#8217;t want to miss a small control message
just because you&#8217;re slurping in a 10 GB message on another socket),
then you&#8217;ll need multiple <span class="monospaced">zmq-async</span> contexts.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_110">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Rich Hickey&#8217;s <a href="http://bit.ly/lang-of-system">"Language of the System" talk</a>, wherein he outlines the benefits of queues
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/zmq-guide">ZeroMQ guide</a> for architectural
  patterns and advice
</p>
</li>
<li>
<p>
<a href="#sec_general_core_async">[sec_general_core_async]</a>
</p>
</li>
<li>
<p>
The
  <a href="http://bit.ly/core-async-post">introductory
  blog post</a> for <span class="monospaced">core.async</span>, which provides a good overview
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_network_io_tcp_client">Creating a TCP Client</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_112">Problem</h4>
<div class="paragraph"><p>You want to open a TCP connection to a remote host, on a particular port.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_112">Solution</h4>
<div class="paragraph"><p>Use Java interop to create an instance of <span class="monospaced">java.net.Socket</span> and
connect to a remote host.</p></div>
<div class="paragraph"><p>For example, the following code uses a <span class="monospaced">Socket</span> to create a TCP
connection and send an HTTP GET request, returning the result as a
string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>as io<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>io StringWriter<span style="color: #990000">]</span>
        '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>net Socket<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> send<span style="color: #990000">-</span>request
  <span style="color: #FF0000">"Sends an HTTP GET request to the specified host, port, and path"</span>
  <span style="color: #990000">[</span>host port path<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>sock <span style="font-weight: bold"><span style="color: #000000">(Socket</span></span><span style="color: #990000">.</span> host port<span style="color: #990000">)</span>
              writer <span style="font-weight: bold"><span style="color: #000000">(io</span></span><span style="color: #990000">/</span>writer sock<span style="color: #990000">)</span>
              reader <span style="font-weight: bold"><span style="color: #000000">(io</span></span><span style="color: #990000">/</span>reader sock<span style="color: #990000">)</span>
              response <span style="font-weight: bold"><span style="color: #000000">(StringWriter</span></span><span style="color: #990000">.)]</span>
    <span style="color: #990000">(.</span>append writer <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"GET "</span> path <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">))</span>
    <span style="color: #990000">(.</span>flush writer<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(io</span></span><span style="color: #990000">/</span>copy reader response<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(str</span></span> response<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This function obtains instances of <span class="monospaced">java.io.Writer</span> and
<span class="monospaced">java.io.Reader</span> to send and receive data to and from the remote server. By
appending strings that conform to the HTTP specification to the
writer, it forms a rudimentary HTTP client and executes a GET
request to the specified endpoint. The results are then copied into an
instance of <span class="monospaced">java.io.StringWriter</span> using the <span class="monospaced">clojure.java.io/copy</span> utility
function, and returned as a string.</p></div>
<div class="paragraph"><p>Invoking <span class="monospaced">(send-request "google.com" 80 "/")</span> at the REPL should
return a very long string, consisting of the entire HTTP response that
is the Google home page.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_112">Discussion</h4>
<div class="paragraph"><p>This example uses the <span class="monospaced">clojure.java.io</span> namespace to obtain
instances of <span class="monospaced">java.io.Writer</span> and <span class="monospaced">java.io.Reader</span> to read and write
textual data to/from the network socket. In point of fact, <span class="monospaced">Socket</span> instances are
not actually limited to textual data, and it would be possible to
obtain raw binary input and output streams just as easily using
<span class="monospaced">clojure.java.io/input-stream</span> and <span class="monospaced">clojure.java.io/output-stream</span>,
respectively. Since HTTP is a textual protocol, however, it makes more
sense to use the higher-level features of <span class="monospaced">Reader</span> and <span class="monospaced">Writer</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph"><p>This example uses HTTP because it&#8217;s a protocol that many readers are
familiar with. In the real world, using a raw TCP socket for HTTP
requests is almost certainly a terrible idea. There are a plethora of
libraries that provide a much higher-level interface to HTTP requests
and responses, and encapsulate a lot of pesky details such as escaping,
encoding, and formatting.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Also note that the reader, the writer, and the socket itself are bound
within the context of a <span class="monospaced">with-open</span> macro. This guarantees that the
<span class="monospaced">close</span> method is called when they are finished, which releases the
TCP connection. If the connection is not released, it will continue to
consume resources on both the client and the server and may be subject to
termination on the remote side.</p></div>
<div class="paragraph"><p>When returning lazy sequences from a <span class="monospaced">with-open</span> context, it is
important to fully realize those sequences using <span class="monospaced">doall</span>. This is
because resources opened by <span class="monospaced">with-open</span> are <em>only</em> available inside
the <span class="monospaced">with-open</span> block. The <span class="monospaced">doall</span> function fully realizes a
collection, retaining its entire contents in memory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">100</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>

<span style="font-weight: bold"><span style="color: #000000">(realized</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(doall</span></span> <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">100</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span></tt></pre></div></div>
<div class="paragraph"><p>Depending on your application, you may prefer to use the <span class="monospaced">doseq</span>
macro. Instead of retaining the entire sequence, <span class="monospaced">doseq</span> executes its
body for each element of the sequence. This is useful if you need to
cause side effects for each element of a sequence, but need to
hang on to the entire thing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>n <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> n<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_111">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_network_io_tcp_server">[sec_network_io_tcp_server]</a>
</p>
</li>
<li>
<p>
Wikipedia on <a href="http://bit.ly/wiki-tcp">the TCP protocol</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_network_io_tcp_server">Creating a TCP Server</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_113">Problem</h4>
<div class="paragraph"><p>You want to open up a socket on a port to use as a low-level TCP server.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_113">Solution</h4>
<div class="paragraph"><p>Use Java interop on the <span class="monospaced">java.net.ServerSocket</span> class to create a TCP
listener. Use the functions in <span class="monospaced">clojure.java.io</span> to obtain input and
output streams (or readers and writers) to read and write data to the
socket:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>as io<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>net ServerSocket<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> receive
  <span style="color: #FF0000">"Read a line of textual data from the given socket"</span>
  <span style="color: #990000">[</span>socket<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>readLine <span style="font-weight: bold"><span style="color: #000000">(io</span></span><span style="color: #990000">/</span>reader socket<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> send
  <span style="color: #FF0000">"Send the given string message out over the given socket"</span>
  <span style="color: #990000">[</span>socket msg<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>writer <span style="font-weight: bold"><span style="color: #000000">(io</span></span><span style="color: #990000">/</span>writer socket<span style="color: #990000">)]</span>
      <span style="color: #990000">(.</span>write writer msg<span style="color: #990000">)</span>
      <span style="color: #990000">(.</span>flush writer<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> serve <span style="color: #990000">[</span>port handler<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>server<span style="color: #990000">-</span>sock <span style="font-weight: bold"><span style="color: #000000">(ServerSocket</span></span><span style="color: #990000">.</span> port<span style="color: #990000">)</span>
              sock <span style="color: #990000">(.</span>accept server<span style="color: #990000">-</span>sock<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>msg<span style="color: #990000">-</span>in <span style="font-weight: bold"><span style="color: #000000">(receive</span></span> sock<span style="color: #990000">)</span>
          msg<span style="color: #990000">-</span>out <span style="font-weight: bold"><span style="color: #000000">(handler</span></span> msg<span style="color: #990000">-</span>in<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(send</span></span> sock msg<span style="color: #990000">-</span>out<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>This code defines three functions. <span class="monospaced">receive</span> and <span class="monospaced">send</span> deal with
reading and writing string data from and to a socket, using the
<span class="monospaced">clojure.java.io/reader</span> and <span class="monospaced">clojure.java.io/writer</span> functions. Both
of these accept a <span class="monospaced">java.net.Socket</span> as an argument and will return a
<span class="monospaced">java.io.Reader</span> or <span class="monospaced">java.io.Writer</span> built from the socket&#8217;s input and
output streams.</p></div>
<div class="paragraph"><p>The <span class="monospaced">serve</span> function handles actually creating an instance of <span class="monospaced">ServerSocket</span> on a
particular port. It also takes a handler function, which will be used
to process the incoming request and determine a response message.</p></div>
<div class="paragraph"><p>After creating an instance of <span class="monospaced">ServerSocket</span>, <span class="monospaced">serve</span> immediately
calls its <span class="monospaced">accept</span> method, which blocks until a TCP connection is
established. When a client connects, it returns the session as an
instance of <span class="monospaced">java.net.Socket</span>.</p></div>
<div class="paragraph"><p>It then passes the socket to the <span class="monospaced">receive</span> function, which opens up a
reader on it and blocks until it receives a full line of input,
terminated by a newline character (<span class="monospaced">\n</span>). When it receives one, it
calls the handler function with the resulting value, and calls <span class="monospaced">send</span>
to send the response using a writer opened on the same socket. <span class="monospaced">send</span>
also calls the <span class="monospaced">flush</span> method on the writer to ensure that all the
data is actually sent back to the client, instead of being buffered in
the <span class="monospaced">Writer</span> instance.</p></div>
<div class="paragraph"><p>After sending the response, the <span class="monospaced">serve</span> function returns. Because it
used the <span class="monospaced">with-open</span> macro when creating the server socket and the TCP
session socket, it will invoke the <span class="monospaced">close</span> function on each before
returning, which disconnects the client and ends the session.</p></div>
<div class="paragraph"><p>To try it out, invoke the <span class="monospaced">serve</span> function in the REPL. For a simple
example, use <span class="monospaced">(serve 8888 #(.toUpperCase %))</span>. Note that it won&#8217;t return
right away; it blocks, waiting for a client to connect.</p></div>
<div class="paragraph"><p>To connect to the server you can use a <em>telnet</em> client, which is
installed by default on nearly every operating system. To use it, open
up a command-line window:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ telnet localhost <span style="color: #993399">8888</span>
Trying <span style="color: #990000">::</span><span style="color: #993399">1</span><span style="color: #990000">...</span>
Connected to localhost<span style="color: #990000">.</span>
Escape character is <span style="color: #FF0000">'^]'</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>At this point you can type anything you like (in the following example, the input is "Hello, World!"). When you finish, make
sure you type Enter or Return to send a newline character:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ telnet localhost <span style="color: #993399">8888</span>
Trying <span style="color: #990000">::</span><span style="color: #993399">1</span><span style="color: #990000">...</span>
Connected to localhost<span style="color: #990000">.</span>
Escape character is <span style="color: #FF0000">'^]'</span><span style="color: #990000">.</span>
Hello<span style="color: #990000">,</span> World<span style="color: #990000">!</span>
HELLO<span style="color: #990000">,</span> WORLD<span style="color: #990000">!</span>Connection closed by foreign host</tt></pre></div></div>
<div class="paragraph"><p>As you can see, as soon as you type a newline, the server responds
with the uppercase version of your input (as per the handler
function) and then immediately terminates the connection. In the REPL,
you will find that the <span class="monospaced">serve</span> function has finally returned.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_113">Discussion</h4>
<div class="paragraph"><p>This example uses readers and writers, which deal solely in textual
data, to make the concepts of working with sockets easier to
demonstrate. Of course, an actual socket is not limited to strings and
can send and receive any kind of binary data.</p></div>
<div class="paragraph"><p><?dbhtml orphans="4"?>To do this, simply use
the <span class="monospaced">clojure.java.io/input-stream</span> and <span class="monospaced">clojure.java.io/output-stream</span>
functions instead of the <span class="monospaced">clojure.java.io/reader</span> and
<span class="monospaced">clojure.java.io/writer</span> functions, respectively, which return
<span class="monospaced">java.io.InputStream</span> and <span class="monospaced">java.io.OutputStream</span> objects. These
provide APIs for reading and writing raw bytes, rather than just
strings and characters.</p></div>
<div class="paragraph"><p>One thing you may have noticed about the example is that, unlike a
traditional server, it doesn&#8217;t actually continue to accept incoming
connections after the <span class="monospaced">serve</span> function returns.  For ongoing use,
typically you&#8217;d like to be able to serve multiple incoming
connections.</p></div>
<div class="paragraph"><p>Fortunately, this is relatively straightforward to do given the
concurrency tools that Clojure provides. Modifying the <span class="monospaced">serve</span> function to
work as a persistent server requires three changes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Run the server on a separate thread so it doesn&#8217;t block the REPL.
</p>
</li>
<li>
<p>
Don&#8217;t close the server socket after handling the first request.
</p>
</li>
<li>
<p>
After handling a request, loop back to immediately handle another.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Also, because the server will be running on a non-REPL thread, it
would be good to provide a mechanism for terminating the server other
than killing the whole JVM.</p></div>
<div class="paragraph"><p>The modified code looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> serve<span style="color: #990000">-</span>persistent <span style="color: #990000">[</span>port handler<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>running <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> true<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(future</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>server<span style="color: #990000">-</span>sock <span style="font-weight: bold"><span style="color: #000000">(ServerSocket</span></span><span style="color: #990000">.</span> port<span style="color: #990000">)]</span>
        <span style="font-weight: bold"><span style="color: #000000">(while</span></span> @running
          <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>open <span style="color: #990000">[</span>sock <span style="color: #990000">(.</span>accept server<span style="color: #990000">-</span>sock<span style="color: #990000">)]</span>
            <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>msg<span style="color: #990000">-</span>in <span style="font-weight: bold"><span style="color: #000000">(receive</span></span> sock<span style="color: #990000">)</span>
                  msg<span style="color: #990000">-</span>out <span style="font-weight: bold"><span style="color: #000000">(handler</span></span> msg<span style="color: #990000">-</span>in<span style="color: #990000">)]</span>
              <span style="font-weight: bold"><span style="color: #000000">(send</span></span> sock msg<span style="color: #990000">-</span>out<span style="color: #990000">))))))</span>
    running<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p><?dbhtml orphans="4"?>The key feature of this code is that
it launches the server socket
asynchronously inside a future and calls the <span class="monospaced">accept</span> method inside
of a loop. It also creates an atom called <span class="monospaced">running</span> and returns it,
checking it each time it loops. To stop the server, reset the atom to
<span class="monospaced">false</span>, and the loop will break:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> a <span style="font-weight: bold"><span style="color: #000000">(serve</span></span><span style="color: #990000">-</span>persistent <span style="color: #993399">8888</span> #<span style="color: #990000">(.</span>toUpperCase <span style="color: #990000">%)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'my-server/a</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Server is running, will respond to multiple requests</span></span>

<span style="font-weight: bold"><span style="color: #000000">(reset</span></span><span style="color: #990000">!</span> a false<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Server is stopped, will stop serving requests after the next one</span></span></tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">When to Use Sockets</div>
<div class="paragraph"><p>As you can see from these examples, raw server sockets are a fairly
low-level networking construct. Using them effectively means either
creating your own data protocol or re-implementing an existing one,
and handling all the fiddly bits of connecting, flushing, and
disconnecting input and outputs streams yourself.</p></div>
<div class="paragraph"><p>If your communication needs can be met by some existing protocol or
communication technique (such as HTTP, SSH, or a message queue), you
should almost certainly use that instead. There are widely available
servers and libraries for these protocols that allow programming at a
much higher level of abstraction, with much better performance and
resiliency.</p></div>
<div class="paragraph"><p>Still, understanding how all these different techniques work on a low
level is valuable. At least as far as the JVM is concerned, most
networking code ultimately bottoms out in calls to the raw socket
mechanisms described in this recipe. Understanding how they work is key to understanding how higher-level networking tools (such as
HTTP requests or JMS queues) actually work.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_112">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The
  <a href="http://bit.ly/javadoc-server-socket">API
  documentation</a> for <span class="monospaced">ServerSocket</span> and <span class="monospaced">Socket</span> objects in Java
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/clj-java-io-api">API
  documentation</a> for the <span class="monospaced">clojure.java.io</span> namespace
</p>
</li>
<li>
<p>
<a href="#sec_network_io_tcp_client">[sec_network_io_tcp_client]</a>
</p>
</li>
<li>
<p>
Wikipedia on <a href="http://bit.ly/wiki-tcp">the TCP protocol</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_and_receiving_udp_packets">Sending and Receiving UDP Packets</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_114">Problem</h4>
<div class="paragraph"><p>You want to send asynchronous UDP packets from your
application, or receive them.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_114">Solution</h4>
<div class="paragraph"><p>Use Java interop with the <span class="monospaced">java.net.DatagramSocket</span> and
<span class="monospaced">java.net.DatagramPacket</span> classes to send and receive UDP messages.</p></div>
<div class="paragraph"><p>The following example demonstrates functions that send and receive
short strings encoded into UDP packets:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">.</span>net DatagramSocket
                   DatagramPacket
                   InetSocketAddress<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> send
  <span style="color: #FF0000">"Send a short textual message over a DatagramSocket to the specified</span>
<span style="color: #FF0000">  host and port. If the string is over 512 bytes long, it will be</span>
<span style="color: #FF0000">  truncated."</span>
  <span style="color: #990000">[^</span>DatagramSocket socket msg host port<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>payload <span style="color: #990000">(.</span>getBytes msg<span style="color: #990000">)</span>
        length <span style="font-weight: bold"><span style="color: #000000">(min</span></span> <span style="font-weight: bold"><span style="color: #000000">(alength</span></span> payload<span style="color: #990000">)</span> <span style="color: #993399">512</span><span style="color: #990000">)</span>
        address <span style="font-weight: bold"><span style="color: #000000">(InetSocketAddress</span></span><span style="color: #990000">.</span> host port<span style="color: #990000">)</span>
        packet <span style="font-weight: bold"><span style="color: #000000">(DatagramPacket</span></span><span style="color: #990000">.</span> payload length address<span style="color: #990000">)]</span>
    <span style="color: #990000">(.</span>send socket packet<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> receive
  <span style="color: #FF0000">"Block until a UDP message is received on the given DatagramSocket, and</span>
<span style="color: #FF0000">  return the payload message as a string."</span>
  <span style="color: #990000">[^</span>DatagramSocket socket<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>buffer <span style="font-weight: bold"><span style="color: #000000">(byte</span></span><span style="color: #990000">-</span>array <span style="color: #993399">512</span><span style="color: #990000">)</span>
        packet <span style="font-weight: bold"><span style="color: #000000">(DatagramPacket</span></span><span style="color: #990000">.</span> buffer <span style="color: #993399">512</span><span style="color: #990000">)]</span>
    <span style="color: #990000">(.</span>receive socket packet<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(String</span></span><span style="color: #990000">.</span> <span style="color: #990000">(.</span>getData packet<span style="color: #990000">)</span>
             <span style="color: #993399">0</span> <span style="color: #990000">(.</span>getLength packet<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> receive<span style="color: #990000">-</span>loop
  <span style="color: #FF0000">"Given a function and DatagramSocket, will (in another thread) wait</span>
<span style="color: #FF0000">  for the socket to receive a message, and whenever it does, will call</span>
<span style="color: #FF0000">  the provided function on the incoming message."</span>
  <span style="color: #990000">[</span>socket f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(future</span></span> <span style="font-weight: bold"><span style="color: #000000">(while</span></span> true <span style="font-weight: bold"><span style="color: #000000">(f</span></span> <span style="font-weight: bold"><span style="color: #000000">(receive</span></span> socket<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">send</span> function is fairly straightforward&#8212;most of its content is
devoted to constructing a byte array as a payload for the
<span class="monospaced">DatagramPacket</span> and invoking constructor forms. The most interesting
thing is its limitation of the payload size to 512 bytes, using the
<span class="monospaced">length</span> argument to the <span class="monospaced">DatagramPacket</span> constructor. This is because
it generally isn&#8217;t safe to attempt to send over 512 bytes of payload
in a single UDP packet; although some network infrastructures may
support it, others do not.</p></div>
<div class="paragraph"><p>The <span class="monospaced">receive</span> function creates an incoming byte array, adds it to a
mutable empty <span class="monospaced">DatagramPacket</span> instance, and invokes the <span class="monospaced">DatagramSocket.receive</span>
method on the socket. When incoming data is received, the <span class="monospaced">receive</span>
method will return after populating the instance of
<span class="monospaced">DatagramPacket</span>. The Clojure code then constructs and returns a new
<span class="monospaced">String</span> using the populated range of the byte array (that is, between
0 and the value reported by the <span class="monospaced">DatagramPacket.getLength</span> method).</p></div>
<div class="paragraph"><p>Because the <span class="monospaced">receive</span> function blocks and only returns a single value,
it isn&#8217;t particularly useful for accepting multiple messages or using
from the REPL. <span class="monospaced">receive-loop</span> wraps the <span class="monospaced">receive</span> function, calling it
repeatedly on a separate thread. Whenever it returns a value, it invokes
the supplied function, then loops back to wait for more
input.</p></div>
<div class="paragraph"><p>To execute this code, you&#8217;ll first need to create an instance of
<span class="monospaced">DatagramSocket</span>. At the REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> socket <span style="font-weight: bold"><span style="color: #000000">(DatagramSocket</span></span><span style="color: #990000">.</span> <span style="color: #993399">8888</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'udp/socket</span></span></tt></pre></div></div>
<div class="paragraph"><p>This creates a UDP socket on the specified port (in this case, 8888).</p></div>
<div class="paragraph"><p>Next, start up a listener using the <span class="monospaced">receive-loop</span> function. For this
example, simply pass it the <span class="monospaced">println</span> function so it will print out
all received values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(receive</span></span><span style="color: #990000">-</span>loop socket println<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;core$future_call$reify__6267@2783890e: :pending&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Then you can send a message! If you started the listener thread with
<span class="monospaced">receive-loop</span> properly, you should see it print out the incoming
message immediately:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(send</span></span> socket <span style="color: #FF0000">"hello, world!"</span> <span style="color: #FF0000">"localhost"</span> <span style="color: #993399">8888</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; hello, world!</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>In this case, sending to <em>localhost</em>, the message transmission happens
so quickly that the message is actually received before the <span class="monospaced">send</span>
function even returns.</p></div>
<div class="sect4">
<h5 id="_discussion_114">Discussion</h5>
<div class="paragraph"><p>Unlike TCP, UDP (the User Datagram Protocol) is an
<em>asynchronous</em> protocol that makes no guarantees regarding the order
in which messages arrive, whether their contents are correct, or even
if they arrive at all. In exchange, UDP typically has a lower
per-packet latency than protocols like TCP, since it does not need to
perform error checking or recovery.</p></div>
<div class="paragraph"><p>Before you decide to use UDP, make sure your application is
designed to continue working even if packets are dropped or corrupted.</p></div>
<div class="paragraph"><p>Because UDP uses asynchronous messages as its model, it is fairly easy
to use <span class="monospaced">core.async</span> to wrap the raw <span class="monospaced">DatagramSocket</span> instances. <span class="monospaced">core.async</span>
provides a very nice channel abstraction that lets you consume and
produce inherently asynchronous events (such as UDP messages) in a
clean, managed way.</p></div>
</div>
<div class="sect4">
<h5 id="_multicast_udp">Multicast UDP</h5>
<div class="paragraph"><p>UDP is also capable of sending the same datagram packet to multiple
destinations using a technique called <em>UDP multicast</em>. To use
multicast, create an instance of <span class="monospaced">java.net.MulticastSocket</span> instead of
<span class="monospaced">java.net.DatagramSocket</span>.</p></div>
<div class="paragraph"><p>A full explanation of how to use <span class="monospaced">MulticastSocket</span> is very well
documented on
<a href="http://bit.ly/javadoc-multicast-socket">Oracle&#8217;s website</a> and would be redundant to reproduce here, since it
is straightforward Java interop. After reading the preceding example,
extending it to <span class="monospaced">MulticastSocket</span> should be relatively
self-explanatory.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_113">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_general_core_async">[sec_general_core_async]</a>
</p>
</li>
<li>
<p>
<a href="#sec_network_io_tcp_client">[sec_network_io_tcp_client]</a>
</p>
</li>
<li>
<p>
<a href="#sec_network_io_tcp_server">[sec_network_io_tcp_server]</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">java.net.MulticastSocket</span> <a href="http://bit.ly/javadoc-multicast-socket">API documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_databases">Databases</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_6">Introduction</h3>
<div class="paragraph"><p>Storing data in a database is not an uncommon task for developers&#8212;in
this day and age, it&#8217;s practically a given. As with nearly every language
under the sun, there is a bevy of drivers and clients to interact
with databases from Clojure. What sets Clojure apart, however, is its
ability to <em>compose</em>.</p></div>
<div class="paragraph"><p>As we&#8217;ve said before in this book: in Clojure, data is king. You&#8217;ll
find many of the database client libraries do a little legwork to
connect you to the datastore, then promptly get out of your way.
Such libraries don&#8217;t do so out of laziness (at least, we
hope), but rather out of the principle of separation of concerns: <em>I&#8217;ll handle connecting
to the database; you handle the domain (your data)</em>. In fact, the best
APIs are built out of data, providing only one or two functions and
letting you manipulate queries and data to be inserted directly as
Clojure data structures.</p></div>
<div class="paragraph"><p>In this chapter, we&#8217;ll visit a wide number of databases and
techniques, including the SQLs, full-text search, Mongo, Redis, and
Datomic.</p></div>
<div class="paragraph"><p><a href="http://www.datomic.com/">Datomic</a> is one of the more interesting recent developments in the
database landscape. Invented and maintained by Rich Hickey (who
you will probably recognize as the same person who wrote Clojure
itself), it is a scalable, transactional, value-oriented, time-aware
database built around the same principles and philosophies as
Clojure. If you like Clojure, you should definitely give Datomic a
try, both as your application&#8217;s datastore and also as a learning
tool to further explore functional, data-oriented programming.</p></div>
<?hard-pagebreak?>
</div>
<div class="sect2">
<h3 id="sec_db_connecting_to_a_sql_database">Connecting to an SQL Database</h3>
<div class="paragraph byline"><p>by Tom Hicks; originally submitted by Simone Mosciatti</p></div>
<div class="sect3">
<h4 id="_problem_115">Problem</h4>
<div class="paragraph"><p>You want to connect your program to an SQL database.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_115">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.java.jdbc</span> library for JDBC-based access to SQL
databases.</p></div>
<div class="paragraph"><p>To follow along with this recipe, you&#8217;ll need a running SQL database
and an existing table to connect to. We suggest PostgreSQL.<span class="footnote"><br>[Mac
users: visit <a href="http://postgresapp.com/">http://postgresapp.com/</a> to download an
easy-to-install DMG. Everyone else: you&#8217;ll find a guide for your operating
system on the
<a href="http://bit.ly/postgres-install">PostgreSQL
wiki</a>.]<br></span></p></div>
<div class="paragraph"><p>After you have PostgreSQL running (presumably on <em>localhost:5432</em>), run the following
command to create a database for this recipe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># On Mac:</span></span>
$ /Applications/Postgres<span style="color: #993399">93</span><span style="color: #990000">.</span>app/Contents/MacOS/bin/createdb cookbook_experiments

<span style="font-style: italic"><span style="color: #9A1900"># Everyone else:</span></span>
$ createdb cookbook_experiments</tt></pre></div></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojure/java.jdbc "0.3.0"]</span> to your
project&#8217;s dependencies. You&#8217;ll also need a JDBC driver for the RDBMS
of your choice. If you&#8217;re following along with this sample, use
<span class="monospaced">[org.postgresql/postgresql "9.2-1003-jdbc4"]</span>. To start a REPL using
<span class="monospaced">lein-try</span>, enter the following Leiningen command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/java<span style="color: #990000">.</span>jdbc <span style="color: #FF0000">"0.3.0"</span> <span style="color: #990000">\</span>
           java-jdbc/dsl <span style="color: #FF0000">"0.1.0"</span> <span style="color: #990000">\</span>
           org<span style="color: #990000">.</span>postgresql/postgresql <span style="color: #FF0000">"9.2-1003-jdbc4"</span></tt></pre></div></div>
<div class="paragraph"><p>To interact with a database using <span class="monospaced">clojure.java.jdbc</span>, all you need is
a connection specification. This specification takes the form of a
plain Clojure map with values indicating the database driver type,
location, and authentication credentials:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec {<span style="color: #990000">:</span>classname <span style="color: #FF0000">"org.postgresql.Driver"</span>
              <span style="color: #990000">:</span>subprotocol <span style="color: #FF0000">"postgresql"</span>
              <span style="color: #990000">:</span>subname <span style="color: #FF0000">"//localhost:5432/cookbook_experiments"</span>
              <span style="font-style: italic"><span style="color: #9A1900">;; Not needed for a non-secure local database...</span></span>
              <span style="font-style: italic"><span style="color: #9A1900">;; :user "bilbo"</span></span>
              <span style="font-style: italic"><span style="color: #9A1900">;; :password "secret"</span></span>
              }<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Create a relation in the specified database by invoking the
<span class="monospaced">clojure.java.jdbc/create-table</span> function with the specification
and any number of column specifications:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>jdbc <span style="color: #990000">:</span>as jdbc<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>ddl <span style="color: #990000">:</span>as ddl<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>do<span style="color: #990000">-</span>commands db<span style="color: #990000">-</span>spec false
  <span style="font-weight: bold"><span style="color: #000000">(ddl</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table
     <span style="color: #990000">:</span>tags
     <span style="color: #990000">[:</span>id <span style="color: #990000">:</span>serial <span style="color: #FF0000">"PRIMARY KEY"</span><span style="color: #990000">]</span>
     <span style="color: #990000">[:</span>name <span style="color: #990000">:</span>varchar <span style="color: #FF0000">"NOT NULL"</span><span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (0)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Many other functions that query and manipulate a database, such as
<span class="monospaced">clojure.java.jdbc/insert!</span>, take a database specification directly as
their first argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>sql <span style="color: #990000">:</span>as sql<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> db<span style="color: #990000">-</span>spec <span style="color: #990000">:</span>tags
                      {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Clojure"</span>}
                      {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Java"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Clojure", :id 1} {:name "Java", :id 2})</span></span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">*</span> <span style="color: #990000">:</span>tags <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>where {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Clojure"</span>}<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Clojure", :id 1})</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_115">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">clojure.java.jdbc</span> library provides functions that wrap the
basic capabilities of the Java JDBC specification. The additional
<span class="monospaced">java-jdbc.sql</span> and <span class="monospaced">java-jdbc.ddl</span> namespaces from the
<span class="monospaced">java-jdbc/dsl</span> project implement small DSLs to generate basic SQL DML
and DDL statements.</p></div>
<div class="paragraph"><p>Because it relies upon Java JDBC, the <span class="monospaced">clojure.java.jdbc</span> library is usable
with many of the most popular SQL databases, including Apache Derby, HSQLDB,
Microsoft SQL Server, MySQL, PostgreSQL, and SQLite.</p></div>
<div class="paragraph"><p>The parameters necessary to set up and access a data source are called the
<em>database specification</em> (often abbreviated "db-spec") and are provided in a
simple Clojure map. The specification usually includes such parameters as the
driver class name, the subprotocol for a particular RDBMS type, the hostname,
the port number, the database name, and the username and password.</p></div>
<div class="paragraph"><p>The <span class="monospaced">clojure.java.jdbc</span> library also permits several other forms of data source
specification, including Java URIs, already-open connections, JNDI connections,
and plain strings. For example, a complete URI string may be provided under the
<span class="monospaced">:connection-uri</span> key:</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; As a spec string</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec
  <span style="color: #FF0000">"jdbc:postgresql://bilbo:secret@localhost:5432/cookbook_experiments"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; As a connection URI map...</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; with a username and password...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec
  {<span style="color: #990000">:</span>connection<span style="color: #990000">-</span>uri <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"jdbc:postgresql://localhost:5432/cookbook_experiments?"</span>
                       <span style="color: #FF0000">"user=bilbo&amp;password=secret"</span><span style="color: #990000">)</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; or without</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec
  {<span style="color: #990000">:</span>connection<span style="color: #990000">-</span>uri <span style="color: #FF0000">"jdbc:postgresql://localhost:5432/cookbook_experiments"</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Database records are represented as Clojure maps, with the table&#8217;s column names
used as keys. Retrieval of a set of database records produces a sequence of
maps that can then be processed with all the normal Clojure functions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">*</span> <span style="color: #990000">:</span>tags<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Clojure", :id 1}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;      {:name "Java", :id 2})</span></span>

<span style="font-weight: bold"><span style="color: #000000">(filter</span></span> #<span style="font-weight: bold"><span style="color: #000000">(not</span></span> <span style="color: #990000">(.</span>endsWith <span style="color: #990000">(:</span>name <span style="color: #990000">%)</span> <span style="color: #FF0000">"ure"</span><span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">*</span> <span style="color: #990000">:</span>tags<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Java", :id 2})</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are other Clojure libraries to access relational databases, and each
provides a different abstraction and DSL for the manipulation of SQL data and
expressions, such as Korma. The <span class="monospaced">clojure.java.jdbc</span> library, however, covers a large portion
of everyday database access needs.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_114">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
See <a href="#sec_db_connecting_with_a_connection_pooling">[sec_db_connecting_with_a_connection_pooling]</a>, to learn about
  pooling connections to an SQL database with <span class="monospaced">BoneCP</span> and
  <span class="monospaced">clojure.java.jdbc</span>.
</p>
</li>
<li>
<p>
See <a href="#sec_db_manipulating_a_sql_database">[sec_db_manipulating_a_sql_database]</a>, to learn about using
  <span class="monospaced">clojure.java.jdbc</span> to interact with an SQL database.
</p>
</li>
<li>
<p>
Visit the <span class="monospaced">clojure.java.jdbc</span>
  <a href="https://github.com/clojure/java.jdbc">GitHub repository</a> for more
  detailed information on the library.
</p>
</li>
<li>
<p>
Visit the <span class="monospaced">java-jdbc/dsl</span>
  <a href="https://github.com/seancorfield/jsql">GitHub repository</a> for more
  information on the SQL query generation capabilities it provides.
  Alternatively, investigate the <a href="https://github.com/jkk/honeysql">Honey
  SQL</a>, <a href="https://github.com/r0man/sqlingvo">SQLingvo</a>, or
  <a href="http://sqlkorma.com/">Korma</a> libraries for SQL query generation.
  Korma is covered in <a href="#sec_sql_korma">[sec_sql_korma]</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_db_connecting_with_a_connection_pooling">Connecting to an SQL Database with a Connection Pool</h3>
<div class="paragraph byline"><p>by Tom Hicks and Filippo Diotalevi</p></div>
<div class="sect3">
<h4 id="_problem_116">Problem</h4>
<div class="paragraph"><p>You would like to connect to an SQL database efficiently using a
connection pool.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_116">Solution</h4>
<div class="paragraph"><p>Use the BoneCP connection and statement pooling library to wrap your
JDBC-based drivers, creating a pooled data source. The pooled data
source is then usable by the <span class="monospaced">clojure.java.jdbc</span> library, as described
in <a href="#sec_db_connecting_to_a_sql_database">[sec_db_connecting_to_a_sql_database]</a>.</p></div>
<div class="paragraph"><p>To follow along with this recipe, you&#8217;ll need a running SQL database
and an existing table to connect to. We suggest PostgreSQL.<span class="footnote"><br>[Mac
users: visit <a href="http://postgresapp.com/">http://postgresapp.com/</a> to download an
easy-to-install DMG. Everyone else: you&#8217;ll find a guide for your operating
system on the
<a href="http://bit.ly/postgres-install">PostgreSQL
wiki</a>.]<br></span></p></div>
<div class="paragraph"><p>After you have PostgreSQL running (presumably on <em>localhost:5432</em>), run the following
command to create a database for this recipe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># On Mac:</span></span>
$ /Applications/Postgres<span style="color: #993399">93</span><span style="color: #990000">.</span>app/Contents/MacOS/bin/createdb cookbook_experiments

<span style="font-style: italic"><span style="color: #9A1900"># Everyone else:</span></span>
$ createdb cookbook_experiments</tt></pre></div></div>
<div class="paragraph"><p>Before starting, add the BoneCP dependency (<span class="monospaced">[com.jolbox/bonecp
"0.8.0.RELEASE"]</span>), as well as the appropriate JDBC libraries for your
RDBMS, to your project&#8217;s dependencies. You&#8217;ll also need a valid SLF4J
logger. Alternatively, you can follow along in a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>jolbox/bonecp <span style="color: #FF0000">"0.8.0.RELEASE"</span> <span style="color: #990000">\</span>
           org<span style="color: #990000">.</span>clojure/java<span style="color: #990000">.</span>jdbc <span style="color: #FF0000">"0.3.0"</span> <span style="color: #990000">\</span>
           java-jdbc/dsl <span style="color: #FF0000">"0.1.0"</span> <span style="color: #990000">\</span>
           org<span style="color: #990000">.</span>postgresql/postgresql <span style="color: #FF0000">"9.2-1003-jdbc4"</span> <span style="color: #990000">\</span>
           org<span style="color: #990000">.</span>slf4j/slf4j-nop  <span style="font-style: italic"><span style="color: #9A1900"># Just do not log anything</span></span></tt></pre></div></div>
<div class="paragraph"><p>First, create a database specification containing the parameters for
accessing the database. This includes keys for the initial and maximum
pool sizes, as well as the number of partitions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec {<span style="color: #990000">:</span>classname <span style="color: #FF0000">"org.postgresql.Driver"</span>
              <span style="color: #990000">:</span>subprotocol <span style="color: #FF0000">"postgresql"</span>
              <span style="color: #990000">:</span>subname <span style="color: #FF0000">"//localhost:5432/cookbook_experiments"</span>
              <span style="color: #990000">:</span>init<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size <span style="color: #993399">4</span>
              <span style="color: #990000">:</span>max<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size <span style="color: #993399">20</span>
              <span style="color: #990000">:</span>partitions <span style="color: #993399">2</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To create a pooled <span class="monospaced">BoneCPDataSource</span> object, define a function (for
convenience) that uses the parameters in the database
specification map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> 'com<span style="color: #990000">.</span>jolbox<span style="color: #990000">.</span>bonecp<span style="color: #990000">.</span>BoneCPDataSource<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> pooled<span style="color: #990000">-</span>datasource <span style="color: #990000">[</span>db<span style="color: #990000">-</span>spec<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>keys <span style="color: #990000">[</span>classname subprotocol subname user password
                init<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size max<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size idle<span style="color: #990000">-</span>time partitions<span style="color: #990000">]</span>} db<span style="color: #990000">-</span>spec
        min<span style="color: #990000">-</span>connections <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="font-weight: bold"><span style="color: #000000">(quot</span></span> init<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size partitions<span style="color: #990000">))</span>
        max<span style="color: #990000">-</span>connections <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="font-weight: bold"><span style="color: #000000">(quot</span></span> max<span style="color: #990000">-</span>pool<span style="color: #990000">-</span>size partitions<span style="color: #990000">))</span>
        cpds <span style="font-weight: bold"><span style="color: #000000">(doto</span></span> <span style="font-weight: bold"><span style="color: #000000">(BoneCPDataSource</span></span><span style="color: #990000">.)</span>
                   <span style="color: #990000">(.</span>setDriverClass classname<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setJdbcUrl <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"jdbc:"</span> subprotocol <span style="color: #FF0000">":"</span> subname<span style="color: #990000">))</span>
                   <span style="color: #990000">(.</span>setUsername user<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setPassword password<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setMinConnectionsPerPartition min<span style="color: #990000">-</span>connections<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setMaxConnectionsPerPartition max<span style="color: #990000">-</span>connections<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setPartitionCount partitions<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setStatisticsEnabled true<span style="color: #990000">)</span>
                   <span style="color: #990000">(.</span>setIdleMaxAgeInMinutes <span style="font-weight: bold"><span style="color: #000000">(or</span></span> idle<span style="color: #990000">-</span>time <span style="color: #993399">60</span><span style="color: #990000">)))]</span>
       {<span style="color: #990000">:</span>datasource cpds}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Use the convenience function to define a pooled data source for connecting to
your database:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(pooled</span></span><span style="color: #990000">-</span>datasource db<span style="color: #990000">-</span>spec<span style="color: #990000">))</span>

pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:datasource #&lt;BoneCPDataSource ...&gt;}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Pass the database specification as the first argument to any
<span class="monospaced">clojure.java.jdbc</span> functions that query or manipulate your database:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>jdbc <span style="color: #990000">:</span>as jdbc<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>ddl <span style="color: #990000">:</span>as ddl<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>sql <span style="color: #990000">:</span>as sql<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>do<span style="color: #990000">-</span>commands pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec false
  <span style="font-weight: bold"><span style="color: #000000">(ddl</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table
    <span style="color: #990000">:</span>blog_posts
    <span style="color: #990000">[:</span>id <span style="color: #990000">:</span>serial <span style="color: #FF0000">"PRIMARY KEY"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>title <span style="color: #FF0000">"varchar(255)"</span> <span style="color: #FF0000">"NOT NULL"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>body <span style="color: #990000">:</span>text<span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (0)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec
              <span style="color: #990000">:</span>blog_posts
              {<span style="color: #990000">:</span>title <span style="color: #FF0000">"My first post!"</span> <span style="color: #990000">:</span>body <span style="color: #FF0000">"This is going to be good!"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:body "This is going to be good!", :title "My first post!", :id 1})</span></span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec
            <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">*</span> <span style="color: #990000">:</span>blog_posts <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>where{<span style="color: #990000">:</span>title <span style="color: #FF0000">"My first post!"</span>}<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:body "This is going to be good!", :title "My first post!", :id 1})</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_116">Discussion</h4>
<div class="paragraph"><p>As shown in the solution, the <span class="monospaced">clojure.java.jdbc</span> library can create database
connections from JDBC data sources, which allows connections to be easily
pooled by the BoneCP or other pooling libraries.</p></div>
<div class="paragraph"><p>The BoneCP library wraps existing JDBC classes to allow the creation of
efficient data sources. It can adapt traditional unpooled drivers and
data sources by augmenting them with transparent pooling of <span class="monospaced">Connection</span>
and <span class="monospaced">PreparedStatement</span> instances.</p></div>
<div class="paragraph"><p>While the library offers several ways to create data sources,
most users will find the examples provided here to be the easiest.</p></div>
<div class="paragraph"><p>BoneCP offers several dozen configuration parameters that control
the operation of the data source and its connections. Luckily, most of these
configuration parameters have built-in defaults. Parameters may be specified
to control such facets as the min, max, and initial pool size; the number of
idle connections; the age of connections; transaction handling; the use of
<span class="monospaced">PreparedStatement</span> pooling; and if, when, and how pooled connections are
tested.</p></div>
<div class="paragraph"><p>Pooled data resources (threads and database connections) may be released by
calling the <span class="monospaced">close</span> method on the <span class="monospaced">BoneCPDataSource</span> class of the
library. Attempting to reuse the pooled data source after it is closed will result
in an SQL exception:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(.</span>close <span style="color: #990000">(:</span>datasource pooled<span style="color: #990000">-</span>db<span style="color: #990000">-</span>spec<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_115">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_db_connecting_to_a_sql_database">[sec_db_connecting_to_a_sql_database]</a>, to learn about basic database connections with <span class="monospaced">clojure.java.jdbc</span>
</p>
</li>
<li>
<p>
<a href="#sec_db_manipulating_a_sql_database">[sec_db_manipulating_a_sql_database]</a>, to learn about using <span class="monospaced">clojure.java.jdbc</span> to interact with an SQL database
</p>
</li>
<li>
<p>
The BoneCP <a href="http://bit.ly/bonecp-doc">documentation</a> and <a href="https://github.com/wwadge/bonecp">GitHub repository</a>
</p>
</li>
<li>
<p>
The <span class="monospaced">clojure.java.jdbc</span> <a href="https://github.com/clojure/java.jdbc">GitHub repository</a> for more detailed information on the library
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_db_manipulating_a_sql_database">Manipulating an SQL Database</h3>
<div class="paragraph byline"><p>by Tom Hicks</p></div>
<div class="sect3">
<h4 id="_problem_117">Problem</h4>
<div class="paragraph"><p>You want your Clojure program to manipulate tables and records in an SQL database.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_117">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">clojure.java.jdbc</span> library for JDBC-based access to SQL databases.</p></div>
<div class="paragraph"><p>To follow along with this recipe, you&#8217;ll need a running SQL database
and an existing table to connect to. We suggest PostgreSQL.<span class="footnote"><br>[Mac
users: visit <a href="http://postgresapp.com/">http://postgresapp.com/</a> to download an
easy-to-install DMG. Everyone else: you&#8217;ll find a guide for your operating
system on the
<a href="http://bit.ly/postgres-install">PostgreSQL
wiki</a>.]<br></span></p></div>
<div class="paragraph"><p>After you have PostgreSQL running (presumably on <em>localhost:5432</em>), run the following
command to create a database for this recipe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># On Mac:</span></span>
$ /Applications/Postgres<span style="color: #993399">93</span><span style="color: #990000">.</span>app/Contents/MacOS/bin/createdb cookbook_experiments

<span style="font-style: italic"><span style="color: #9A1900"># Everyone else:</span></span>
$ createdb cookbook_experiments</tt></pre></div></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojure/java.jdbc "0.3.0"]</span> and
<span class="monospaced">[java-jdbc/dsl "0.1.0"]</span> to your project&#8217;s dependencies. You&#8217;ll also
need a JDBC driver for the RDBMS of your choice. If you&#8217;re following
along with this sample, use <span class="monospaced">[org.postgresql/postgresql
"9.2-1003-jdbc4"]</span>. To start a REPL using <span class="monospaced">lein-try</span>, enter the
following Leiningen command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/java<span style="color: #990000">.</span>jdbc <span style="color: #FF0000">"0.3.0"</span> <span style="color: #990000">\</span>
           java-jdbc/dsl <span style="color: #FF0000">"0.1.0"</span> <span style="color: #990000">\</span>
           org<span style="color: #990000">.</span>postgresql/postgresql <span style="color: #FF0000">"9.2-1003-jdbc4"</span></tt></pre></div></div>
<div class="paragraph"><p>Then, define how the database should be accessed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>spec {<span style="color: #990000">:</span>classname <span style="color: #FF0000">"org.postgresql.Driver"</span>
              <span style="color: #990000">:</span>subprotocol <span style="color: #FF0000">"postgresql"</span>
              <span style="color: #990000">:</span>subname <span style="color: #FF0000">"//localhost:5432/cookbook_experiments"</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To create a new table, use the <span class="monospaced">java-jdbc.ddl/create-table</span>
function to generate the necessary DDL statement, and then pass the
statement to the <span class="monospaced">jdbc/db-do-commands</span> function to execute it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>jdbc <span style="color: #990000">:</span>as jdbc<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>ddl <span style="color: #990000">:</span>as ddl<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>do<span style="color: #990000">-</span>commands db<span style="color: #990000">-</span>spec
  <span style="font-weight: bold"><span style="color: #000000">(ddl</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table <span style="color: #990000">:</span>fruit
    <span style="color: #990000">[:</span>name <span style="color: #FF0000">"varchar(16)"</span> <span style="color: #FF0000">"PRIMARY KEY"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>appearance <span style="color: #FF0000">"varchar(32)"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>cost <span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #FF0000">"NOT NULL"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>unit <span style="color: #FF0000">"varchar(16)"</span><span style="color: #990000">]</span>
    <span style="color: #990000">[:</span>grade <span style="color: #990000">:</span>real<span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (0)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Insert complete records into a table using the
<span class="monospaced">clojure.java.jdbc/insert!</span> function, invoking it with a vector of the
column values for each row. Be sure to provide the column values in
the order in which the columns were declared in the table:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> db<span style="color: #990000">-</span>spec <span style="color: #990000">:</span>fruit
  nil <span style="font-style: italic"><span style="color: #9A1900">; column names omitted</span></span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Red Delicious"</span> <span style="color: #FF0000">"dark red"</span> <span style="color: #993399">20</span> <span style="color: #FF0000">"bushel"</span> <span style="color: #993399">8.2</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Plantain"</span> <span style="color: #FF0000">"mild spotting"</span> <span style="color: #993399">48</span> <span style="color: #FF0000">"stalk"</span> <span style="color: #993399">7.4</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Kiwifruit"</span> <span style="color: #FF0000">"fresh"</span>  <span style="color: #993399">35</span> <span style="color: #FF0000">"crate"</span> <span style="color: #993399">9.1</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Plum"</span> <span style="color: #FF0000">"ripe"</span> <span style="color: #993399">12</span> <span style="color: #FF0000">"carton"</span> <span style="color: #993399">8.4</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 1 1 1)</span></span></tt></pre></div></div>
<div class="paragraph"><p>To query the database, generate the SQL for the query with the
<span class="monospaced">java-jdbc.sql/select</span> function, then invoke <span class="monospaced">clojure.java.jdbc/query</span>
with the result:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>java<span style="color: #990000">-</span>jdbc<span style="color: #990000">.</span>sql <span style="color: #990000">:</span>as sql<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
  <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">*</span> <span style="color: #990000">:</span>fruit <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>where {<span style="color: #990000">:</span>appearance <span style="color: #FF0000">"ripe"</span>}<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:grade 8.4, :unit "carton", :cost 12, :appearance "ripe", :name "Plum"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you no longer need a particular table, invoke
<span class="monospaced">clojure.java.jdbc/db-do-commands</span> with the appropriate DDL statements
generated by <span class="monospaced">java-jdbc.ddl/drop-table</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>do<span style="color: #990000">-</span>commands db<span style="color: #990000">-</span>spec
  <span style="font-weight: bold"><span style="color: #000000">(ddl</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table <span style="color: #990000">:</span>delete_me
    <span style="color: #990000">[:</span>name <span style="color: #FF0000">"varchar(16)"</span> <span style="color: #FF0000">"PRIMARY KEY"</span><span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>do<span style="color: #990000">-</span>commands db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(ddl</span></span><span style="color: #990000">/</span>drop<span style="color: #990000">-</span>table <span style="color: #990000">:</span>delete_me<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (0)</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_117">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">clojure.java.jdbc</span> library provides functions that wrap the
basic capabilities of the Java JDBC specification. The <span class="monospaced">java-jdbc/dsl</span> project&#8217;s  <span class="monospaced">java-jdbc.sql</span>
and <span class="monospaced">java-jdbc.ddl</span> namespaces implement small DSLs to generate basic
SQL DML and DDL statements.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><span class="monospaced">java-jdbc/dsl</span> used to be a part of <span class="monospaced">clojure.java.jdbc</span>, but was
removed to keep the API of the core library as small as possible.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">java-dbc.ddl/create-table</span> function generates the DDL
needed to create a table. The arguments are a table name and a vector
for each column specification. At the time of this writing,
table-level specifications are not yet supported.</p></div>
<div class="sect4">
<h5 id="_inserting_and_updating_records">Inserting and updating records</h5>
<div class="paragraph"><p>Records may be inserted into a table in a variety of ways. In addition
to the vector method illustrated, the
<span class="monospaced">clojure.java.jdbc/insert!</span> function can accept one or more maps with
column names as keys:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> db<span style="color: #990000">-</span>spec <span style="color: #990000">:</span>fruit
  {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Banana"</span> <span style="color: #990000">:</span>appearance <span style="color: #FF0000">"spotting"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">35</span>}
  {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Tomato"</span> <span style="color: #990000">:</span>appearance <span style="color: #FF0000">"rotten"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">10</span> <span style="color: #990000">:</span>grade <span style="color: #993399">1.4</span>}
  {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Peach"</span> <span style="color: #990000">:</span>appearance <span style="color: #FF0000">"fresh"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">37</span> <span style="color: #990000">:</span>unit <span style="color: #FF0000">"pallet"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:grade nil, :unit nil, :cost 35, :appearance "spotting", :name "Banana"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:grade 1.4, :unit nil, :cost 10, :appearance "rotten", :name "Tomato"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:grade nil, :unit "pallet", :cost 37, :appearance "fresh",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :name "Peach"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you want to insert rows but only specify some columns' values, you
can invoke <span class="monospaced">clojure.java.jdbc/insert!</span> with a vector of column
names followed by one or more vectors containing values for those
columns:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> db<span style="color: #990000">-</span>spec <span style="color: #990000">:</span>fruit
  <span style="color: #990000">[:</span>name <span style="color: #990000">:</span>cost<span style="color: #990000">]</span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Mango"</span> <span style="color: #993399">84</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span><span style="color: #FF0000">"Kumquat"</span> <span style="color: #993399">77</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 1)</span></span></tt></pre></div></div>
<div class="paragraph"><p>To update existing records, invoke <span class="monospaced">clojure.java.jdbc/update!</span> with a
map of column names to new values. The optional
<span class="monospaced">java-jdbc.sql/where</span> clause controls which rows will be
updated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>update<span style="color: #990000">!</span> db<span style="color: #990000">-</span>spec <span style="color: #990000">:</span>fruit
  {<span style="color: #990000">:</span>grade <span style="color: #993399">7.0</span> <span style="color: #990000">:</span>appearance <span style="color: #FF0000">"spotting"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">75</span>}
  <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>where {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Mango"</span>}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1)</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_transactions">Transactions</h5>
<div class="paragraph"><p>Database transactions are available to ensure that multiple operations
are performed atomically (i.e., all or none). The
<span class="monospaced">clojure.java.jdbc/with-db-transaction</span> macro creates a transaction-aware
connection from the database specification. Use the transaction-aware
connection for the duration of the transaction:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Insert two new fruits atomically</span></span>
<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>db<span style="color: #990000">-</span>transaction <span style="color: #990000">[</span>trans<span style="color: #990000">-</span>conn db<span style="color: #990000">-</span>spec<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> trans<span style="color: #990000">-</span>conn <span style="color: #990000">:</span>fruit {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Fig"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">12</span>}<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> trans<span style="color: #990000">-</span>conn <span style="color: #990000">:</span>fruit {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Date"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">14</span>}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:grade nil, :unit nil, :cost 14, :appearance nil, :name "Date"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>If an exception is thrown, the transaction is rolled back:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Query how many items the table has now</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> fruit<span style="color: #990000">-</span>count
  <span style="color: #FF0000">"Query how many items are in the fruit table."</span>
  <span style="color: #990000">[</span>db<span style="color: #990000">-</span>spec<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>result <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"count(*)"</span> <span style="color: #990000">:</span>fruit<span style="color: #990000">))]</span>
    <span style="color: #990000">(:</span>count <span style="font-weight: bold"><span style="color: #000000">(first</span></span> result<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(fruit</span></span><span style="color: #990000">-</span>count db<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 11</span></span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>db<span style="color: #990000">-</span>transaction <span style="color: #990000">[</span>trans<span style="color: #990000">-</span>conn db<span style="color: #990000">-</span>spec<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> trans<span style="color: #990000">-</span>conn <span style="color: #990000">:</span>fruit
    <span style="color: #990000">[:</span>name <span style="color: #990000">:</span>cost<span style="color: #990000">]</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">"Grape"</span> <span style="color: #993399">86</span><span style="color: #990000">]</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">"Pear"</span> <span style="color: #993399">86</span><span style="color: #990000">])</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; At this point the insert! call is complete, but the transaction</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;; is not. An exception will cause the transaction to roll back,</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;; leaving the database unchanged.</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(throw</span></span> <span style="font-weight: bold"><span style="color: #000000">(Exception</span></span><span style="color: #990000">.</span> <span style="color: #FF0000">"sql-test-exception"</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; Exception sql-test-exception ...</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; The table still has the same number of items</span></span>
<span style="font-weight: bold"><span style="color: #000000">(fruit</span></span><span style="color: #990000">-</span>count db<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 11</span></span></tt></pre></div></div>
<div class="paragraph"><p>Transactions can be explicitly set to roll back with the
<span class="monospaced">clojure.java.jdbc/db-set-rollback-only!</span> function. This setting can
be unset with the <span class="monospaced">clojure.java.jdbc/db-unset-rollback-only!</span>
function and tested with the <span class="monospaced">clojure.java.jdbc/db-is-rollback-only</span>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(fruit</span></span><span style="color: #990000">-</span>count db<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 11</span></span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>db<span style="color: #990000">-</span>transaction <span style="color: #990000">[</span>trans<span style="color: #990000">-</span>conn db<span style="color: #990000">-</span>spec<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>db<span style="color: #990000">-</span>set<span style="color: #990000">-</span>rollback<span style="color: #990000">-</span>only<span style="color: #990000">!</span> trans<span style="color: #990000">-</span>conn<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">!</span> trans<span style="color: #990000">-</span>conn <span style="color: #990000">:</span>fruit {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Pear"</span> <span style="color: #990000">:</span>cost <span style="color: #993399">69</span>}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:grade nil, :unit nil, :cost 69, :appearance nil, :name "Pear"})</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; The table still has the same number of items</span></span>
<span style="font-weight: bold"><span style="color: #000000">(fruit</span></span><span style="color: #990000">-</span>count db<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 11</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_reading_and_processing_records">Reading and processing records</h5>
<div class="paragraph"><p>Database records are returned from queries as Clojure maps, with the
table&#8217;s column names used as keys. Retrieval of a set of database
records produces a sequence of maps that can then be processed with
all the normal Clojure functions. Here, we query all the records in
the fruit table, gathering the name and grade of any low-quality fruit:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"name, grade"</span> <span style="color: #990000">:</span>fruit<span style="color: #990000">))</span>
     <span style="font-style: italic"><span style="color: #9A1900">;; Filter all fruits by fruits with grade &lt; 3.0</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>keys <span style="color: #990000">[</span>grade<span style="color: #990000">]</span>}<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(and</span></span> grade <span style="color: #990000">(&lt;</span> grade <span style="color: #993399">3.0</span><span style="color: #990000">))))</span>
     <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(juxt</span></span> <span style="color: #990000">:</span>name <span style="color: #990000">:</span>grade<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (["Tomato" 1.4])</span></span></tt></pre></div></div>
<div class="paragraph"><p>The preceding example uses the SQL DSL provided by the
<span class="monospaced">java-jdbc.sql</span> namespace. The DSL implements a simple
abstraction over the generation of SQL statements. At present, it
provides some basic mechanisms for selects, joins, <span class="monospaced">where</span> clauses, and
<span class="monospaced">order-by</span> clauses:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> fresh<span style="color: #990000">-</span>fruit <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
    <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>select <span style="color: #990000">[:</span>f<span style="color: #990000">.</span>name<span style="color: #990000">]</span> {<span style="color: #990000">:</span>fruit <span style="color: #990000">:</span>f}
      <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>where {<span style="color: #990000">:</span>f<span style="color: #990000">.</span>appearance <span style="color: #FF0000">"fresh"</span>}<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(sql</span></span><span style="color: #990000">/</span>order<span style="color: #990000">-</span>by <span style="color: #990000">:</span>f<span style="color: #990000">.</span>name<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(fresh</span></span><span style="color: #990000">-</span>fruit<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Kiwifruit"} {:name "Peach"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>The use of the SQL DSL is entirely optional. For more direct control,
a vector containing an SQL query string and arguments can be passed to
the <span class="monospaced">query</span> function. The following function also finds low-quality
fruit but does it by passing a quality threshold value directly to
the SQL statement:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> find<span style="color: #990000">-</span>low<span style="color: #990000">-</span>quality <span style="color: #990000">[</span>acceptable<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
              <span style="color: #990000">[</span><span style="color: #FF0000">"select name, grade from fruit where grade &lt; ?"</span> acceptable<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(find</span></span><span style="color: #990000">-</span>low<span style="color: #990000">-</span>quality <span style="color: #993399">3.0</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:grade 1.4, :name "Tomato"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">jdbc/query</span> function has several optional keyword parameters that control
how it constructs the returned result set. The <span class="monospaced">:result-set-fn</span> parameter
specifies a function that is applied to the entire result set (a lazy
sequence) before it is returned. The default argument is the <span class="monospaced">doall</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> hi<span style="color: #990000">-</span>lo <span style="color: #990000">[</span>rs<span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(first</span></span> rs<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(last</span></span> rs<span style="color: #990000">)])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find the highest- and lowest-cost fruits</span></span>
<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
            <span style="color: #990000">[</span><span style="color: #FF0000">"select * from fruit order by cost desc"</span><span style="color: #990000">]</span>
            <span style="color: #990000">:</span>result<span style="color: #990000">-</span>set<span style="color: #990000">-</span>fn hi<span style="color: #990000">-</span>lo<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{:grade nil, :unit nil, :cost 77, :appearance nil, :name "Kumquat"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:grade 1.4, :unit nil, :cost 10, :appearance "rotten", :name "Tomato"}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">:row-fn</span> parameter specifies a function that is applied to each
result row as the result is constructed. The default argument is the
<span class="monospaced">identity</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add<span style="color: #990000">-</span>tax <span style="color: #990000">[</span>row<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> row <span style="color: #990000">:</span>tax <span style="color: #990000">(*</span> <span style="color: #993399">0.08</span> <span style="font-weight: bold"><span style="color: #000000">(row</span></span> <span style="color: #990000">:</span>cost<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
             <span style="color: #990000">[</span><span style="color: #FF0000">"select name,cost from fruit where cost = 12"</span><span style="color: #990000">]</span>
             <span style="color: #990000">:</span>row<span style="color: #990000">-</span>fn add<span style="color: #990000">-</span>tax<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:tax 0.96, :cost 12, :name "Plum"} {:tax 0.96, :cost 12, :name "Fig"})</span></span></tt></pre></div></div>
<div class="paragraph"><p>The Boolean <span class="monospaced">:as-arrays?</span> parameter indicates whether to return the
results as a set of vectors or not. The default argument value is
<span class="monospaced">false</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(jdbc</span></span><span style="color: #990000">/</span>query db<span style="color: #990000">-</span>spec
            <span style="color: #990000">[</span><span style="color: #FF0000">"select name,cost,grade from fruit where appearance = 'spotting'"</span><span style="color: #990000">]</span>
            <span style="color: #990000">:</span>as<span style="color: #990000">-</span>arrays<span style="color: #990000">?</span> true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ([:name :cost :grade] ["Banana" 35 nil] ["Mango" 75 7.0])</span></span></tt></pre></div></div>
<div class="paragraph"><p>Finally, the <span class="monospaced">:identifiers</span> parameter takes a function that is
applied to each column name in the result set. The default argument is
the <span class="monospaced">clojure.string/lower-case</span> function, which lowercases the table&#8217;s
column names before they are converted to keywords. If your
application needs to perform some different conversion of column
names, provide an alternate function using this keyword parameter.</p></div>
<div class="paragraph"><p>The <span class="monospaced">clojure.java.jdbc</span> library is a good choice for quick and easy
access to most popular relational databases. Its use of Clojure&#8217;s
vectors and maps to represent records blends well with Clojure&#8217;s
emphasis on data-oriented programming. Novice users of SQL can
conveniently utilize the provided DSLs while expert users can more
directly construct and execute complex SQL statements.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_116">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
See <a href="#sec_db_connecting_to_a_sql_database">[sec_db_connecting_to_a_sql_database]</a>, to learn about basic
  database connections with <span class="monospaced">clojure.java.jdbc</span>.
</p>
</li>
<li>
<p>
See <a href="#sec_db_connecting_with_a_connection_pooling">[sec_db_connecting_with_a_connection_pooling]</a>, to learn about
  pooling connections to an SQL database with BoneCP and
  <span class="monospaced">clojure.java.jdbc</span>.
</p>
</li>
<li>
<p>
Visit the <span class="monospaced">clojure.java.jdbc</span>
  <a href="https://github.com/clojure/java.jdbc">GitHub repository</a> for more
  detailed information on the library.
</p>
</li>
<li>
<p>
Visit the <span class="monospaced">java-jdbc/dsl</span>
  <a href="https://github.com/seancorfield/jsql">GitHub repository</a> for more
  information on the SQL query generation capabilities it provides.
  Alternatively, investigate the <a href="https://github.com/jkk/honeysql">Honey
  SQL</a>, <a href="https://github.com/r0man/sqlingvo">SQLingvo</a>, or
  <a href="http://sqlkorma.com/">Korma</a> libraries for SQL query generation.
  Korma is covered in <a href="#sec_sql_korma">[sec_sql_korma]</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_sql_korma">Simplifying SQL with Korma</h3>
<div class="paragraph byline"><p>by Dmitri Sotnikov and Chris Allen</p></div>
<div class="sect3">
<h4 id="_problem_118">Problem</h4>
<div class="paragraph"><p>You want to work with data stored in a relational database without
writing SQL by hand.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_118">Solution</h4>
<div class="paragraph"><p>Use Korma as a DSL for generating SQL queries and traversing
relationships.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[korma "0.3.0-RC6"]</span> and
<span class="monospaced">[org.postgresql/postgresql "9.2-1002-jdbc4"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try korma org<span style="color: #990000">.</span>postgresql/postgresql</tt></pre></div></div>
<div class="paragraph"><p>To follow along with this recipe, you&#8217;ll need a running SQL database
and an existing table to connect to. We suggest PostgreSQL.<span class="footnote"><br>[Mac
users: visit <a href="http://postgresapp.com/">http://postgresapp.com/</a> to download an
easy-to-install DMG. Everyone else: you&#8217;ll find a guide for your operating
system on the
<a href="http://bit.ly/postgres-install">PostgreSQL
wiki</a>.]<br></span></p></div>
<div class="paragraph"><p>After you have PostgreSQL running (presumably on <em>localhost:5432</em>), run the following
command to create a database for this recipe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># On Mac:</span></span>
$ /Applications/Postgres<span style="color: #990000">.</span>app/Contents/MacOS/bin/createdb learn_korma

<span style="font-style: italic"><span style="color: #9A1900"># Everyone else:</span></span>
$ createdb learn_korma</tt></pre></div></div>
<div class="paragraph"><p>To connect to the <span class="monospaced">learn_korma</span> database, use <span class="monospaced">defdb</span>
with the <span class="monospaced">postgres</span> helper. Because Korma is a rather large DSL, it is
acceptable to <span class="monospaced">:refer :all</span> its contents into model namespaces:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>korma<span style="color: #990000">.</span>db   <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>korma<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defdb</span></span> db
  <span style="font-weight: bold"><span style="color: #000000">(postgres</span></span> {<span style="color: #990000">:</span>db <span style="color: #FF0000">"learn_korma"</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>To interact with a table in your database, define and create what
Korma calls <em>entities</em>. Here you&#8217;ll define an entity for blog posts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defentity</span></span> posts
  <span style="font-weight: bold"><span style="color: #000000">(pk</span></span> <span style="color: #990000">:</span>id<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(table</span></span> <span style="color: #990000">:</span>posts<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; Table name</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(entity</span></span><span style="color: #990000">-</span>fields <span style="color: #990000">:</span>title <span style="color: #990000">:</span>content<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">; Default fields to SELECT</span></span></tt></pre></div></div>
<div class="paragraph"><p>Normally you&#8217;d use a proper migration library for your schema, but for
the sake of simplicity, we&#8217;ll create a table manually. Use the
<span class="monospaced">exec-raw</span> function to execute raw SQL statements against the
database. You should only do this where strictly necessary:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> create<span style="color: #990000">-</span>posts <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"CREATE TABLE posts "</span>
                       <span style="color: #FF0000">"(id serial, title text, content text,"</span>
                       <span style="color: #FF0000">"created_on timestamp default current_timestamp);"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">-</span>raw create<span style="color: #990000">-</span>posts<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now that the <span class="monospaced">posts</span> table exists, you can invoke <span class="monospaced">insert</span> against
<span class="monospaced">posts</span> with a map&#8217;s <span class="monospaced">values</span> to add records to the database.
Each record is represented by a map. The names of the keys in the map
must match the names of the columns in the database:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(insert</span></span> posts
        <span style="font-weight: bold"><span style="color: #000000">(values</span></span> {<span style="color: #990000">:</span>title <span style="color: #FF0000">"First post"</span> <span style="color: #990000">:</span>content <span style="color: #FF0000">"blah blah blah"</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>To retrieve values from the database, query using <span class="monospaced">select</span>. Successful
queries will return a sequence of maps, each containing keys
representing the column names:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(select</span></span> posts <span style="font-weight: bold"><span style="color: #000000">(limit</span></span> <span style="color: #993399">1</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{:created_on #inst "2013-11-01T19:21:10.652920000-00:00",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :content "blah blah blah",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :title "First post",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :id 1}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>To correct or change existing records, use the <span class="monospaced">update</span> macro. Invoke
<span class="monospaced">update</span> against <span class="monospaced">posts</span>, providing a <span class="monospaced">set-fields</span> declaration to
specify what should change and a <span class="monospaced">where</span> declaration narrowing what
records to make those changes to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(update</span></span> posts
        <span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">-</span>fields {<span style="color: #990000">:</span>title <span style="color: #FF0000">"Best Post"</span>}<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">(where</span></span> {<span style="color: #990000">:</span>title <span style="color: #FF0000">"First post"</span>}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:title "Best Post", :id 1 ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">delete</span> macro works similarly to <span class="monospaced">update</span>, but doesn&#8217;t take a
<span class="monospaced">set-fields</span> declaration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(delete</span></span> posts
        <span style="font-weight: bold"><span style="color: #000000">(where</span></span> {<span style="color: #990000">:</span>title <span style="color: #FF0000">"Best Post"</span>}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(select</span></span> posts<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; []</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_118">Discussion</h4>
<div class="paragraph"><p>Korma provides a simple and intuitive way to construct SQL queries
from Clojure. The advantage of using Korma is that the queries are
written as regular code instead of SQL strings. You can easily compose
queries and abstract common operations.</p></div>
<div class="paragraph"><p>Korma exposes these abilities through its entity system. Entities are
an abstraction over traditional SQL tables that mask the complexity of
SQL&#8217;s crufty and complicated DDL (data definition language). Via the
<span class="monospaced">defentity</span> macro, you have access to all of the power of traditional
SQL, packaged in a readable, Clojure-based DSL.</p></div>
<div class="paragraph"><p>When defining entities with <span class="monospaced">defentity</span>, you can pass in a number of
options. Some common options include <span class="monospaced">table</span> to specify a table name,
<span class="monospaced">pk</span> to specify the default ID field (primary key), <span class="monospaced">entity-fields</span> to
specify the default fields for SELECT statements, or even <span class="monospaced">db</span> to
specify which database the entity belongs in.</p></div>
<div class="paragraph"><p>Entities also simplify defining relations between tables. Entity
declaration statements such as <span class="monospaced">has-one</span>, <span class="monospaced">has-many</span>, <span class="monospaced">belongs-to</span>, and
<span class="monospaced">many-to-many</span> define relationships to other entities. Consider adding
an author to each of our blog posts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Create authors, assuming posts has an author_id</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defentity</span></span> authors
  <span style="font-style: italic"><span style="color: #9A1900">;; By default, foreign-key will be :authors_id, but that is a little</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">;; awkward</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(has</span></span><span style="color: #990000">-</span>many posts {<span style="color: #990000">:</span>fk <span style="color: #990000">:</span>author_id}<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Redefine posts such that it assumes it has an author_id</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defentity</span></span> posts
  <span style="font-weight: bold"><span style="color: #000000">(belongs</span></span><span style="color: #990000">-</span>to authors {<span style="color: #990000">:</span>fk <span style="color: #990000">:</span>author_id}<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create the authors table</span></span>
<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">-</span>raw <span style="color: #FF0000">"CREATE TABLE authors (id serial, name text);"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Add the authors_id field to posts</span></span>
<span style="font-weight: bold"><span style="color: #000000">(exec</span></span><span style="color: #990000">-</span>raw <span style="color: #FF0000">"ALTER TABLE posts ADD COLUMN author_id int;"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> ryan <span style="font-weight: bold"><span style="color: #000000">(insert</span></span> authors <span style="font-weight: bold"><span style="color: #000000">(values</span></span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Ryan"</span>}<span style="color: #990000">)))</span>
ryan
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:name "Ryan", :id 1}</span></span>

<span style="font-weight: bold"><span style="color: #000000">(insert</span></span> posts <span style="font-weight: bold"><span style="color: #000000">(values</span></span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>title <span style="color: #FF0000">"My first post!"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>author_id <span style="color: #990000">(:</span>id ryan<span style="color: #990000">)</span>}
                       {<span style="color: #990000">:</span>title <span style="color: #FF0000">"My second post."</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>author_id <span style="color: #990000">(:</span>id ryan<span style="color: #990000">)</span>}<span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #000000">(select</span></span> posts
        <span style="font-weight: bold"><span style="color: #000000">(where</span></span> {<span style="color: #990000">:</span>author_id <span style="color: #990000">(:</span>id ryan<span style="color: #990000">)</span>}<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{:author_id 1,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      ...</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :title "My first post!",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :id 4}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:author_id 1,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      ...</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :title "My second post.",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :id 5}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Stemming from its entity system, Korma provides DSL versions of common
SQL statements such as <span class="monospaced">select</span>, <span class="monospaced">update</span>, <span class="monospaced">insert</span>, and <span class="monospaced">delete</span>. One
of the most interesting query types is <span class="monospaced">select</span>, which provides
support for most every SELECT statement option, include simplified
table joins (via its relation helpers). Some notable helpers include
<span class="monospaced">aggregate</span>, <span class="monospaced">join</span>, <span class="monospaced">order</span>, <span class="monospaced">group</span>, and <span class="monospaced">having</span>. Chances are, if it
is an SQL statement feature, Korma has a helper for it.</p></div>
<div class="paragraph"><p>Korma&#8217;s DSL isn&#8217;t only convenient, it&#8217;s also composable. Using
<span class="monospaced">select*</span> instead of <span class="monospaced">select</span> returns a query as a value, instead of
an evaluated result. You can pipeline query values through regular
<span class="monospaced">select</span> helpers to build up or store partial queries. Finally, invoke
<span class="monospaced">select</span> on a query value to execute it and receive its result:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> authors<span style="color: #990000">-</span>posts
  <span style="color: #FF0000">"Retrieve all posts for a person with a given name"</span>
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(select</span></span><span style="color: #990000">*</span> posts<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(with</span></span> authors<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(where</span></span> {<span style="color: #990000">:</span>authors<span style="color: #990000">.</span>name name}<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find the title of all posts by the author named "Ryan"</span></span>
<span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(authors</span></span><span style="color: #990000">-</span>posts <span style="color: #FF0000">"Ryan"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(where</span></span> <span style="font-weight: bold"><span style="color: #000000">(like</span></span> <span style="color: #990000">:</span>title <span style="color: #FF0000">"%second%"</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(fields</span></span> <span style="color: #990000">:</span>title<span style="color: #990000">)</span>
    select<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [{:title "My second post."}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Another convenience Korma provides is default connections. You may
have noticed in the examples that we never referred to the <span class="monospaced">db</span> we defined.
When only a single connection is defined, it will be used by default
and you don&#8217;t have to pass it explicitly. If you like, you can define
multiple connections and wrap series of statements in a <span class="monospaced">with-db</span> call:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>db db
  <span style="font-weight: bold"><span style="color: #000000">(select</span></span> <span style="font-weight: bold"><span style="color: #000000">(authors</span></span><span style="color: #990000">-</span>posts <span style="color: #FF0000">"Ryan"</span><span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_117">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The official <a href="http://sqlkorma.com/docs">Korma
  project page</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_performing_full_text_search_with_lucene">Performing Full-Text Search with Lucene</h3>
<div class="paragraph byline"><p>by Osbert Feng</p></div>
<div class="sect3">
<h4 id="_problem_119">Problem</h4>
<div class="paragraph"><p>You want to support flexible full-text search over an unstructured or
semistructured dataset using Lucene. For example, you want to return all people
in the United States that have "Clojure" anywhere in their job descriptions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_119">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/weavejester/clucy">Clucy</a>, a Clojure wrapper for
Lucene. Clucy provides the tools to build and query indexes from
within a Clojure process.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a new project (<strong><span class="monospaced">lein new
text-search</span></strong>), add <span class="monospaced">[clucy "0.4.0"]</span> to its dependencies, and start a
REPL using <strong><span class="monospaced">lein repl</span></strong>.<span class="footnote"><br>[We would normally suggest using
<span class="monospaced">lein-try</span>, but the plug-in is currently incompatible with Clucy.]<br></span></p></div>
<div class="paragraph"><p>The following code creates and queries a simple in-memory index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clucy<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as clucy<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> index <span style="font-weight: bold"><span style="color: #000000">(clucy</span></span><span style="color: #990000">/</span>memory<span style="color: #990000">-</span>index<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #'user/index</span></span>


<span style="font-weight: bold"><span style="color: #000000">(clucy</span></span><span style="color: #990000">/</span>add index
   {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Alice"</span> <span style="color: #990000">:</span>description <span style="color: #FF0000">"Clojure expert"</span>
    <span style="color: #990000">:</span>location <span style="color: #FF0000">"North Carolina, United States"</span>}
   {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Bob"</span> <span style="color: #990000">:</span>description <span style="color: #FF0000">"Clojure novice"</span>
    <span style="color: #990000">:</span>location <span style="color: #FF0000">"Berlin, Germany"</span>}
   {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eve"</span> <span style="color: #990000">:</span>description <span style="color: #FF0000">"Eavesdropper"</span>
    <span style="color: #990000">:</span>location <span style="color: #FF0000">"Maryland, United States"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>

<span style="font-weight: bold"><span style="color: #000000">(clucy</span></span><span style="color: #990000">/</span>search index <span style="color: #FF0000">"description:clojure AND location:</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">united states</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span> <span style="color: #993399">10</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Alice",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :location "North Carolina, United States",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :description "Clojure expert"})</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_119">Discussion</h4>
<div class="paragraph"><p>Lucene is a Java library for information retrieval. To use Lucene, you
generate documents and index them for later retrieval. Documents
consist of fields and terms. In this example, the documents are quite
small, but Lucene is capable of efficiently indexing large numbers of
very large documents as well.</p></div>
<div class="paragraph"><p>Clucy wraps Lucene in a convenient manner for use in Clojure and is
capable of generating Lucene documents directly from simple Clojure
maps, where keys map to fields and values map to textual data to be
indexed.</p></div>
<div class="paragraph"><p><span class="monospaced">clucy.core/search</span> takes an index, a query string, and the number of
results to return as parameters. Lucene is able to efficiently query
in part because it is not necessary to return all matching documents,
just the top <span class="monospaced">n</span> best matches.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Clucy does not work as well out of the box with nested values in your
maps. Be sure to flatten out values into simple strings for proper
indexing and retrieval.</td>
</tr></table>
</div>
<div class="paragraph"><p>This example uses a <span class="monospaced">memory-index</span>, which stores the index in system
memory. In most real applications, you&#8217;ll want to persist the index to
disk, which allows it to grow larger than the available memory and
allows you to restart your process without re-indexing. Clucy lets
you construct a Lucene disk index via the <span class="monospaced">disk-index</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> index <span style="font-weight: bold"><span style="color: #000000">(clucy</span></span><span style="color: #990000">.</span>core<span style="color: #990000">/</span>disk<span style="color: #990000">-</span>index <span style="color: #FF0000">"/tmp/index"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>As part of the process for generating documents, Lucene calls an
analyzer on your strings to generate tokens for indexing. The default
<span class="monospaced">StandardAnalyzer</span> is sufficient for most purposes and can be
customized with a list of "stop words" to be ignored during token
generation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> 'org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>lucene<span style="color: #990000">.</span>analysis<span style="color: #990000">.</span>standard<span style="color: #990000">.</span>StandardAnalyzer<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; org.apache.lucene.analysis.standard.StandardAnalyzer</span></span>

<span style="font-weight: bold"><span style="color: #000000">(import</span></span> 'org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>lucene<span style="color: #990000">.</span>analysis<span style="color: #990000">.</span>util<span style="color: #990000">.</span>CharArraySet<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; org.apache.lucene.analysis.util.CharArraySet</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> stop<span style="color: #990000">-</span>words
  <span style="font-weight: bold"><span style="color: #000000">(doto</span></span> <span style="font-weight: bold"><span style="color: #000000">(CharArraySet</span></span><span style="color: #990000">.</span> clucy<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>version<span style="color: #990000">*</span> <span style="color: #993399">3</span> true<span style="color: #990000">)</span>
    <span style="color: #990000">(.</span>add <span style="color: #FF0000">"do"</span><span style="color: #990000">)</span>
    <span style="color: #990000">(.</span>add <span style="color: #FF0000">"not"</span><span style="color: #990000">)</span>
    <span style="color: #990000">(.</span>add <span style="color: #FF0000">"index"</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[</span>clucy<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>analyzer<span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">(StandardAnalyzer</span></span><span style="color: #990000">.</span>
                                 clucy<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>version<span style="color: #990000">*</span>
                                 stop<span style="color: #990000">-</span>words<span style="color: #990000">)]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Invoke index add and search forms here, within the binding</span></span>
  <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>However, in other situations you may need to use a different analyzer
or write your own. For example, the <span class="monospaced">EnglishAnalyzer</span> uses Porter stemming and
other techniques better suited to taking into account pluralization or
possessives:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(import</span></span> org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>lucene<span style="color: #990000">.</span>analysis<span style="color: #990000">.</span>en<span style="color: #990000">.</span>EnglishAnalyzer<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; org.apache.lucene.analysis.en.EnglishAnalyzer</span></span>

<span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[</span>clucy<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>analyzer<span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">(EnglishAnalyzer</span></span><span style="color: #990000">.</span> clucy<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>version<span style="color: #990000">*)]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Invoke index add and search forms here, within the binding</span></span>
  <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The basic search query syntax is <span class="monospaced">field:term</span>. By default, multiple
clauses will perform an <span class="monospaced">OR</span> search, so an explicit <span class="monospaced">AND</span> is required
if both clauses must be true.</p></div>
<div class="paragraph"><p>If no field is specified, there is an implicit field <span class="monospaced">_content</span> that
indexes all map values. Documents returned are ordered by Lucene&#8217;s
default relevance algorithm, which takes into account term frequency,
distance, and document length:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(clucy</span></span><span style="color: #990000">.</span>core<span style="color: #990000">/</span>search index <span style="color: #FF0000">"clojure united states"</span> <span style="color: #993399">10</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:name "Alice",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :location "North Carolina, United States",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :description "Clojure expert"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Eve",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :location "Maryland, United States",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :description "Eavesdropper"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:name "Bob",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :location "Berlin, Germany",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      :description "Clojure novice"})</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_118">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://lucene.apache.org/">Lucene project home page</a>
</p>
</li>
<li>
<p>
The Clucy <a href="https://github.com/weavejester/clucy">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_indexing_data_with_elasticsearch">Indexing Data with ElasticSearch</h3>
<div class="paragraph byline"><p>by Michael Klishin</p></div>
<div class="sect3">
<h4 id="_problem_120">Problem</h4>
<div class="paragraph"><p>You want to index data using the
<a href="http://elasticsearch.org">ElasticSearch</a> indexing and search engine.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_120">Solution</h4>
<div class="paragraph"><p>Use <a href="http://bit.ly/clj-elastisch">Elastisch</a>, a minimalistic
Clojure wrapper around the ElasticSearch Java APIs.</p></div>
<div class="paragraph"><p>In order to successfully work through the examples in this recipe, you
should have ElasticSearch installed and running on your local
system. You can find details on how to install it on
<a href="http://bit.ly/cc-es-setup">the
ElasticSearch website</a>.</p></div>
<div class="paragraph"><p>ElasticSearch supports multiple transports (e.g., HTTP, native
Netty-based transport, and Memcached). Elastisch supports HTTP and
native transports.  This recipe will use an HTTP transport client for
the examples and explain how to switch to the native transport in the
discussion section.</p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[clojurewerkz/elastisch "1.2.0"]</span> to your project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clojurewerkz/elastisch</tt></pre></div></div>
<div class="paragraph"><p>Before you can index and search with Elastisch, it is necessary to
tell Elastisch what ElasticSearch node to use. To use the HTTP
transport, you use the <span class="monospaced">clojurewerkz.elastisch.rest/connect!</span> function
that takes an endpoint as its sole argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>elastisch<span style="color: #990000">.</span>rest <span style="color: #990000">:</span>as esr<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(esr</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> <span style="color: #FF0000">"http://127.0.0.1:9200"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="sect4">
<h5 id="_indexing">Indexing</h5>
<div class="paragraph"><p>Before data can be searched over, it needs to be indexed. Indexing is
the process of scanning the text and building a list of search terms
and data structures called a <em>search index</em>. Search indexes allow
search engines such as ElasticSearch to efficiently retrieve relevant documents
for a query.</p></div>
<div class="paragraph"><p>The process of indexing involves a few steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create an index.
</p>
</li>
<li>
<p>
[Optional] Define mappings (how documents should be indexed).
</p>
</li>
<li>
<p>
Submit documents for indexing via HTTP or other APIs.
</p>
</li>
</ol></div>
<div class="paragraph"><p>To create an index, use the <span class="monospaced">clojurewerkz.elastisch.rest.index/create</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>elastisch<span style="color: #990000">.</span>rest<span style="color: #990000">.</span>index <span style="color: #990000">:</span>as esi<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(esr</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> <span style="color: #FF0000">"http://127.0.0.1:9200"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create an index with the given settings and no custom mapping types</span></span>
<span style="font-weight: bold"><span style="color: #000000">(esi</span></span><span style="color: #990000">/</span>create <span style="color: #FF0000">"test1"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create an index with custom settings</span></span>
<span style="font-weight: bold"><span style="color: #000000">(esi</span></span><span style="color: #990000">/</span>create <span style="color: #FF0000">"test2"</span> <span style="color: #990000">:</span>settings {<span style="color: #FF0000">"number_of_shards"</span> <span style="color: #993399">1</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>A full explanation of the available indexing settings is outside the
scope of this recipe. Please refer to the
<a href="http://bit.ly/clj-es-indexing">Elastisch
documentation on indexing</a> for full details.</p></div>
</div>
<div class="sect4">
<h5 id="_creating_mappings">Creating mappings</h5>
<div class="paragraph"><p><em>Mappings</em> define the fields in a document and what the indexing
characteristics are for each field. Mapping types are specified when
an index is created using the <span class="monospaced">:mapping</span> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(esr</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> <span style="color: #FF0000">"http://127.0.0.1:9200"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Mapping types map structure is the same as in the ElasticSearch API reference</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> mapping<span style="color: #990000">-</span>types {<span style="color: #FF0000">"person"</span>
                    {<span style="color: #990000">:</span>properties {<span style="color: #990000">:</span>username  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>store <span style="color: #FF0000">"yes"</span>}
                                 <span style="color: #990000">:</span>first<span style="color: #990000">-</span>name {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>store <span style="color: #FF0000">"yes"</span>}
                                 <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>}
                                 <span style="color: #990000">:</span>age        {<span style="color: #990000">:</span>type <span style="color: #FF0000">"integer"</span>}
                                 <span style="color: #990000">:</span>title      {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>
                                              <span style="color: #990000">:</span>analyzer <span style="color: #FF0000">"snowball"</span>}
                                 <span style="color: #990000">:</span>planet     {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>}
                                 <span style="color: #990000">:</span>biography  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>
                                              <span style="color: #990000">:</span>analyzer <span style="color: #FF0000">"snowball"</span>
                                              <span style="color: #990000">:</span>term_vector
                                              <span style="color: #FF0000">"with_positions_offsets"</span>}}}}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(esi</span></span><span style="color: #990000">/</span>create <span style="color: #FF0000">"test3"</span> <span style="color: #990000">:</span>mappings mapping<span style="color: #990000">-</span>types<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_indexing_documents">Indexing documents</h5>
<div class="paragraph"><p>To add a document to an index, use the
<span class="monospaced">clojurewerkz.elastisch.rest.document/create</span> function. This will
cause a document ID to be generated automatically:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>elastisch<span style="color: #990000">.</span>rest<span style="color: #990000">.</span>document <span style="color: #990000">:</span>as esd<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(esr</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> <span style="color: #FF0000">"http://127.0.0.1:9200"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> mapping<span style="color: #990000">-</span>types {<span style="color: #FF0000">"person"</span>
                    {<span style="color: #990000">:</span>properties {<span style="color: #990000">:</span>username  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>store <span style="color: #FF0000">"yes"</span>}
                                 <span style="color: #990000">:</span>first<span style="color: #990000">-</span>name {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>store <span style="color: #FF0000">"yes"</span>}
                                 <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>}
                                 <span style="color: #990000">:</span>age        {<span style="color: #990000">:</span>type <span style="color: #FF0000">"integer"</span>}
                                 <span style="color: #990000">:</span>title      {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>analyzer <span style="color: #FF0000">"snowball"</span>}
                                 <span style="color: #990000">:</span>planet     {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>}
                                 <span style="color: #990000">:</span>biography  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span>
                                              <span style="color: #990000">:</span>analyzer <span style="color: #FF0000">"snowball"</span>
                                              <span style="color: #990000">:</span>term_vector
                                              <span style="color: #FF0000">"with_positions_offsets"</span>}}}}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(esi</span></span><span style="color: #990000">/</span>create <span style="color: #FF0000">"test4"</span> <span style="color: #990000">:</span>mappings mapping<span style="color: #990000">-</span>types<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> doc1 {<span style="color: #990000">:</span>username <span style="color: #FF0000">"happyjoe"</span>
          <span style="color: #990000">:</span>first<span style="color: #990000">-</span>name <span style="color: #FF0000">"Joe"</span>
          <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Smith"</span>
          <span style="color: #990000">:</span>age <span style="color: #993399">30</span>
          <span style="color: #990000">:</span>title <span style="color: #FF0000">"The Boss"</span>
          <span style="color: #990000">:</span>planet <span style="color: #FF0000">"Earth"</span>
          <span style="color: #990000">:</span>biography <span style="color: #FF0000">"N/A"</span>}<span style="color: #990000">)</span>


<span style="font-weight: bold"><span style="color: #000000">(esd</span></span><span style="color: #990000">/</span>create <span style="color: #FF0000">"test4"</span> <span style="color: #FF0000">"person"</span> doc1<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; =&gt; {:created true, :_index "test4", :_type "person",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :_id "2vr8sP-LTRWhSKOxyWOi_Q", :_version 1}</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">clojurewerkz.elastisch.rest.document/put</span> will add a document to the index but expects a document ID to be provided:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(esd</span></span><span style="color: #990000">/</span>put <span style="color: #FF0000">"test4"</span> <span style="color: #FF0000">"person"</span> <span style="color: #FF0000">"happyjoe"</span> doc1<span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_120">Discussion</h4>
<div class="paragraph"><p>Whenever a document is added to the ElasticSearch index, it is first
analyzed.</p></div>
<div class="paragraph"><p><em>Analysis</em> is a process of several stages:</p></div>
<div class="ulist"><ul>
<li>
<p>
Tokenization (breaking field values into <em>tokens</em>)
</p>
</li>
<li>
<p>
Filtering or modifying tokens
</p>
</li>
<li>
<p>
Combining tokens with field names to produce <em>terms</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>How exactly a document was analyzed defines what search queries will
match (find) it. ElasticSearch is based on
<a href="http://lucene.apache.org">Apache Lucene</a> and offers several analyzers
developers can use to achieve the kind of search quality and
performance they need. For example, different languages
require different analyzers: English, Mandarin Chinese, Arabic, and
Russian cannot be analyzed the same way.</p></div>
<div class="paragraph"><p>It is possible to skip performing analysis for fields and specify whether
field values are stored in the index or not. Fields that are not
stored still can be searched over but will not be included into search
results.</p></div>
<div class="paragraph"><p>ElasticSearch allows users to define exactly how different kinds of
documents are indexed, analyzed, and stored.</p></div>
<div class="paragraph"><p>ElasticSearch has excellent support for <em>multitenancy</em>: an
ElasticSearch cluster can have a virtually unlimited number of indexes
and mapping types.  For example, you can use a separate index per user
account or organization in a SaaS (Software as a Service) product.</p></div>
<div class="paragraph"><p>There are two ways to index a document with ElasticSearch: you can submit a document
for indexing without an ID or update a document with a provided ID,
in which case if the document already exists, it will be updated (a
new version will be created).</p></div>
<div class="paragraph"><p>While it is fine and common to use automatically created indexes early
in development, manually creating indexes lets you configure a lot
about how ElasticSearch will index your data and, in turn, what kinds
of queries it will be possible to execute against it.</p></div>
<div class="paragraph"><p>How your data is indexed is primarily controlled by <em>mappings</em>. They
define which fields in documents are indexed, if/how they are
analyzed, and if they are stored. Each index in ElasticSearch may have
one or more <em>mapping types</em>. Mapping types can be thought of as tables
in a database (although this analogy does not always stand).  Mapping
types are the heart of indexing in ElasticSearch and provide access to
a lot of ElasticSearch functionality.</p></div>
<div class="paragraph"><p>For example, a blogging application may have types such as <em>article</em>,
<em>comment</em>, and <em>person</em>. Each has distinct <em>mapping settings</em> that
define a set of fields documents of the type have, how they are
supposed to be indexed (and, in turn, what kinds of queries will be
possible over them), what language each field is in, and so on. Getting
mapping types right for your application is the key to a good search
experience. It also takes time and experimentation.</p></div>
<div class="paragraph"><p>Mapping types define document fields and their core types
(e.g., string, integer, or date/time). Settings are provided to
ElasticSearch as a JSON document, and this is how they are documented
on the
<a href="http://bit.ly/cc-es-mapping">ElasticSearch
site</a>.</p></div>
<div class="paragraph"><p>With Elastisch, mapping settings are specified as Clojure maps with
the same structure (schema). A very minimalistic example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #FF0000">"tweet"</span> {<span style="color: #990000">:</span>properties {<span style="color: #990000">:</span>username  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>index <span style="color: #FF0000">"not_analyzed"</span>}}}}</tt></pre></div></div>
<div class="paragraph"><p>Here is a brief and very incomplete list of things that you can define
via mapping settings:</p></div>
<div class="ulist"><ul>
<li>
<p>
Document fields, their types, and whether they are analyzed
</p>
</li>
<li>
<p>
Document time to live (TTL)
</p>
</li>
<li>
<p>
Whether a document type is indexed
</p>
</li>
<li>
<p>
Special fields (<span class="monospaced">"_all"</span>, default field, etc.)
</p>
</li>
<li>
<p>
<a href="http://bit.ly/cc-es-boost-field">Document-level boosting</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/cc-es-timestamp-field">Timestamp field</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>When an index is created using the
<span class="monospaced">clojurewerkz.elastisch.rest.index/create</span> function, mapping settings
are passed with the <span class="monospaced">:mappings</span> option, as seen previously.</p></div>
<div class="paragraph"><p>When it is necessary to update mapping for an index, you can use the
<span class="monospaced">clojurewerkz.elastisch.rest.index/update-mapping</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(esi</span></span><span style="color: #990000">/</span>update<span style="color: #990000">-</span>mapping <span style="color: #FF0000">"myapp_development"</span> <span style="color: #FF0000">"person"</span>
                    <span style="color: #990000">:</span>mapping {<span style="color: #990000">:</span>properties
                              {<span style="color: #990000">:</span>first<span style="color: #990000">-</span>name {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>store <span style="color: #FF0000">"no"</span>}}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In a mapping configuration, settings are passed as maps where keys are
names (strings or keywords) and values are maps of the actual
settings. In this example, the only setting is <span class="monospaced">:properties</span>, which
defines a single field&#8212;a string that is not analyzed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #FF0000">"tweet"</span> {<span style="color: #990000">:</span>properties {<span style="color: #990000">:</span>username  {<span style="color: #990000">:</span>type <span style="color: #FF0000">"string"</span> <span style="color: #990000">:</span>index <span style="color: #FF0000">"not_analyzed"</span>}}}}</tt></pre></div></div>
<div class="paragraph"><p>There is much more to the indexing and mapping options, but that&#8217;s outside the scope of a
single recipe. See the Elastisch
<a href="http://bit.ly/clj-es-indexing">indexing
documentation</a> for an exhaustive list of the capabilities provided.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_119">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The official <a href="http://bit.ly/cc-es-guide">ElasticSearch guide</a>
</p>
</li>
<li>
<p>
The Elastisch <a href="http://bit.ly/clj-elastisch">home page</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_cassandra">Working with Cassandra</h3>
<div class="paragraph byline"><p>by Alex Petrov</p></div>
<div class="sect3">
<h4 id="_problem_121">Problem</h4>
<div class="paragraph"><p>You want to work with data stored in Cassandra.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_121">Solution</h4>
<div class="paragraph"><p>Use the <a href="http://clojurecassandra.info/">Cassaforte</a> library to connect to a Cassandra cluster and work with the records in the database.</p></div>
<div class="paragraph"><p>In order to successfully work through the examples in this recipe, you
should have Cassandra installed. You can find details on how to
install Cassandra on the <a href="http://wiki.apache.org/cassandra/GettingStarted">GettingStarted page of the wiki</a>.</p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[clojurewerkz/cassaforte "1.1.0"]</span> to your project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clojurewerkz/cassaforte</tt></pre></div></div>
<div class="paragraph"><p>In order to connect to your Cassandra cluster and create and use your first
keyspace, you will need the <span class="monospaced">clojurewerkz.cassaforte.client</span>,
<span class="monospaced">clojurewerkz.cassaforte.cql</span>, and <span class="monospaced">clojurewerkz.cassaforte.query</span>
namespaces.</p></div>
<div class="paragraph"><p><span class="monospaced">clojurewerkz.cassaforte.client</span> is responsible for
connection&#8212;the other two provide an easy interface to execute queries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>cassaforte<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as client<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>cassaforte<span style="color: #990000">.</span>cql <span style="color: #990000">:</span>as cql<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojurewerkz<span style="color: #990000">.</span>cassaforte<span style="color: #990000">.</span>query <span style="color: #990000">:</span>as q<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect to 2 nodes in a cluster</span></span>
<span style="font-weight: bold"><span style="color: #000000">(client</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> <span style="color: #990000">[</span><span style="color: #FF0000">"localhost"</span> <span style="color: #FF0000">"another.node.local"</span><span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Create a keyspace named `cassaforte_keyspace`, using</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; the Simple Replication Strategy and a replication factor of 2</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>keyspace <span style="color: #FF0000">"cassaforte_keyspace"</span>
                     <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>with {<span style="color: #990000">:</span>replication
                              {<span style="color: #990000">:</span>class <span style="color: #FF0000">"SimpleStrategy"</span>
                              <span style="color: #990000">:</span>replication_factor <span style="color: #993399">2</span> }}<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Switch to the keyspace</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>use<span style="color: #990000">-</span>keyspace <span style="color: #FF0000">"cassaforte_keyspace"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now, you can create tables and start inserting data into them. For that, invoke the <span class="monospaced">create-table</span> and <span class="monospaced">insert</span> functions of the <span class="monospaced">clojurewerkz.cassaforte.cql</span> namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table <span style="color: #FF0000">"users"</span>
                  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>column<span style="color: #990000">-</span>definitions {<span style="color: #990000">:</span>name <span style="color: #990000">:</span>varchar
                                         <span style="color: #990000">:</span>city <span style="color: #990000">:</span>varchar
                                         <span style="color: #990000">:</span>age  <span style="color: #990000">:</span><span style="color: #009900">int</span>
                                         <span style="color: #990000">:</span>primary<span style="color: #990000">-</span>key <span style="color: #990000">[:</span>name<span style="color: #990000">]</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Now, insert several users into the table:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span> <span style="color: #990000">:</span>city <span style="color: #FF0000">"Munich"</span> <span style="color: #990000">:</span>age <span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">26</span><span style="color: #990000">)</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Robert"</span> <span style="color: #990000">:</span>city <span style="color: #FF0000">"Brussels"</span> <span style="color: #990000">:</span>age <span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">30</span><span style="color: #990000">)</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You can access these records using a <span class="monospaced">select</span> query. For example, if you want to retrieve all the users from the table or use <span class="monospaced">limit</span> in your query, you can run:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Will retrieve all users</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"users"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Will retrieve top 10 users</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"users"</span> <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>limit <span style="color: #993399">10</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Alternatively, if you want to retrieve information about a single person by a given <span class="monospaced">name</span>, you can add a <span class="monospaced">where</span> clause to it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"users"</span> <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span><span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_121">Discussion</h4>
<div class="paragraph"><p>Cassandra is an open source implementation of many of the ideas in Amazon&#8217;s landmark <a href="http://bit.ly/dynamo-pdf">Dynamo Paper</a>. It&#8217;s a key/value datastore, and it&#8217;s not aware of any relationships between tables and data points. Cassandra is a distributed datastore and is designed to be highly available. For that, it replicates data within the cluster. The data is stored redundantly on multiple nodes. If one node fails, data is still available for retrieval from a different node or multiple nodes.</p></div>
<div class="paragraph"><p>Cassandra starts making sense when your data is rather big. Because it was built for distribution, you can scale your reads and writes, and fine-tune and manage your database&#8217;s consistency and availability. Cassandra handles network partitions well, so even if several of your nodes are unavailable for some time, you will still be able to read and write data until the network partition heals. If your dataset is rather small, you don&#8217;t expect it to grow significantly anytime soon, and you need to run many ad hoc queries against the dataset, then Cassandra may not make sense.</p></div>
<div class="paragraph"><p>Consistency and availability are tunable values. You can get better availability by sacrificing data consistency: due to network partitions, not all the nodes will hold the latest snapshot of data at all times, but you&#8217;ll be still able to respond to writes and receive reads. If you choose to have strong consistency, conversely, the latency will increase, since more nodes should respond successfully for reads and writes. Eventual consistency guarantees that, if no conflicting writes are made for the data point, eventually all nodes will hold the latest value.</p></div>
<div class="paragraph"><p>Like most datastores, Cassandra has concepts of separate databases (<em>keyspaces</em> in Cassandra terminology). Every keyspace holds tables (sometimes called <em>column families</em>). Tables hold rows, and rows consist of columns. Each column has a key (column name), value, write timestamp, and time to live.</p></div>
<div class="paragraph"><p>Cassandra uses two different communication protocols: an older binary protocol called Thrift, and CQL (Cassandra Query Language). All query operators in Cassaforte generate CQL code under the hood. Here are a couple of examples of how these operations translate to CQL internally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>select <span style="color: #FF0000">"users"</span> <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; SELECT * FROM users WHERE name='Alex';</span></span>

<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span> <span style="color: #990000">:</span>city <span style="color: #FF0000">"Munich"</span> <span style="color: #990000">:</span>age <span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">26</span><span style="color: #990000">)</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; INSERT INTO users (name, city) VALUES ('Munich', 26);</span></span></tt></pre></div></div>
<div class="paragraph"><p>There&#8217;s much more to Cassandra than just creating tables and inserting values. If you want to update records in your database, you can call the <span class="monospaced">update</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>update <span style="color: #FF0000">"users"</span>
             {<span style="color: #990000">:</span>city <span style="color: #FF0000">"Berlin"</span>}
             <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Deleting records from the database is just as easy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Will delete just one user</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>delete <span style="color: #990000">:</span>users <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Will delete all users whose names match within IN clause</span></span>
<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>delete <span style="color: #990000">:</span>users <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #990000">[:</span>in <span style="color: #990000">[</span><span style="color: #FF0000">"Alex"</span> <span style="color: #FF0000">"Robert"</span><span style="color: #990000">]]))</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;d like to execute some arbitrary CQL statements, outside of
Cassaforte&#8217;s macro-based DSL, you can pass a string to the
<span class="monospaced">client/execute</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(client</span></span><span style="color: #990000">/</span>execute
  <span style="color: #FF0000">"INSERT INTO users (name, city, age) VALUES ('Alex', 'Munich', 19);"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>For each issued write, you can specify an optional time to live to expire the data after a certain period of time. This is useful for caching and for data that you only want to hold for a certain period of time (like user sessions). For example, if you want the record to live for just 60 seconds, you can run:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span> <span style="color: #990000">:</span>city <span style="color: #FF0000">"Munich"</span> <span style="color: #990000">:</span>age <span style="font-weight: bold"><span style="color: #000000">(int</span></span> <span style="color: #993399">26</span><span style="color: #990000">)</span>}
                    <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>using <span style="color: #990000">:</span>ttl <span style="color: #993399">60</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Another concept that people like about Cassandra is distributed
counters. Counter columns provide an efficient way to count or sum
anything you need. This is achieved by using atomic increment/decrement
operations on values. In order to create a table with a counter from
Cassaforte, you can use the <span class="monospaced">:counter</span> column type:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>table <span style="color: #990000">:</span>scores
                  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>column<span style="color: #990000">-</span>definitions {<span style="color: #990000">:</span>username <span style="color: #990000">:</span>varchar
                                         <span style="color: #990000">:</span>score    <span style="color: #990000">:</span>counter
                                         <span style="color: #990000">:</span>primary<span style="color: #990000">-</span>key <span style="color: #990000">[:</span>username<span style="color: #990000">]</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>You can increment and decrement counters by using the <span class="monospaced">increment-by</span> and <span class="monospaced">decrement-by</span> queries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>update <span style="color: #990000">:</span>scores
            {<span style="color: #990000">:</span>score <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>increment<span style="color: #990000">-</span>by <span style="color: #993399">50</span><span style="color: #990000">)</span>}
            <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Alex"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(cql</span></span><span style="color: #990000">/</span>update <span style="color: #990000">:</span>scores
            {<span style="color: #990000">:</span>score <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>decrement<span style="color: #990000">-</span>by <span style="color: #993399">5</span><span style="color: #990000">)</span>}
            <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>where <span style="color: #990000">:</span>name <span style="color: #FF0000">"Robert"</span><span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_120">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://clojurecassandra.info">Cassaforte documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_mongodb">Working with MongoDB</h3>
<div class="paragraph byline"><p>by Clinton Dreisbach</p></div>
<div class="sect3">
<h4 id="_problem_122">Problem</h4>
<div class="paragraph"><p>You want to work with data stored in MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_122">Solution</h4>
<div class="paragraph"><p>Use <a href="http://clojuremongodb.info/">Monger</a> to connect to MongoDB and
search or manipulate the data. Monger is a Clojure wrapper around the
Java MongoDB driver.</p></div>
<div class="paragraph"><p>Before using Mongo from your Clojure code, you must have a running
instance of MongoDB to connect to. See MongoDB&#8217;s
<a href="http://bit.ly/mongodb-install">installation guide</a> for
instructions on how to install MongoDB on your local system.</p></div>
<div class="paragraph"><p>When you&#8217;re ready to write a Clojure MongoDB client, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>novemberain/monger</tt></pre></div></div>
<div class="paragraph"><p>To connect to MongoDB, use the <span class="monospaced">monger.core/connect!</span> function. This will store your connection in the <span class="monospaced">*mongodb-connection*</span> dynamic var. If you want to get a connection to use without storing it in a dynamic var, you can use <span class="monospaced">monger.core/connect</span> with the same options:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as mongo<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect to localhost</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> {<span style="color: #990000">:</span>host <span style="color: #FF0000">"127.0.0.1"</span> <span style="color: #990000">:</span>port <span style="color: #993399">27017</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Disconnect when you are done</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>disconnect<span style="color: #990000">!)</span></tt></pre></div></div>
<div class="paragraph"><p>Once you are connected, you can insert and query documents easily:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as mongo<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>collection <span style="color: #990000">:</span>as coll<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>org<span style="color: #990000">.</span>bson<span style="color: #990000">.</span>types ObjectId<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Set the database in the *mongodb-database* var</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>use<span style="color: #990000">-</span>db<span style="color: #990000">!</span> <span style="color: #FF0000">"mongo-time"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Insert one document</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Jeremiah Forthright"</span> <span style="color: #990000">:</span>state <span style="color: #FF0000">"TX"</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Insert a batch of documents</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>insert<span style="color: #990000">-</span>batch <span style="color: #FF0000">"users"</span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>name <span style="color: #FF0000">"Pete Killibrew"</span> <span style="color: #990000">:</span>state <span style="color: #FF0000">"KY"</span>}
                            {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Wendy Perkins"</span> <span style="color: #990000">:</span>state <span style="color: #FF0000">"OK"</span>}
                            {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Steel Whitaker"</span> <span style="color: #990000">:</span>state <span style="color: #FF0000">"OK"</span>}
                            {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Sarah LaRue"</span> <span style="color: #990000">:</span>state <span style="color: #FF0000">"WY"</span>}<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find all documents and return a com.mongodb.DBCursor</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find <span style="color: #FF0000">"users"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find all documents matching a query and return a DBCursor</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>state <span style="color: #FF0000">"OK"</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find documents and return them as Clojure maps</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find<span style="color: #990000">-</span>maps <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>state <span style="color: #FF0000">"OK"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ({:_id #&lt;ObjectId 520...&gt;, :state "OK", :name "Wendy Perkins"}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     {:_id #&lt;ObjectId 520...&gt;, :state "OK", :name "Steel Whitaker"})</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find one document and return a com.mongodb.DBObject</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find<span style="color: #990000">-</span>one <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Pete Killibrew"</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find one document and return it as a Clojure map</span></span>
<span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find<span style="color: #990000">-</span>one<span style="color: #990000">-</span>as<span style="color: #990000">-</span>map <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Sarah LaRue"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:_id #&lt;ObjectId 520...&gt;, :state "WY", :name "Sarah LaRue"}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_122">Discussion</h4>
<div class="paragraph"><p>MongoDB, especially with Monger, can be a natural choice for storing Clojure data. It stores data as BSON (binary JSON), which maps well to Clojure&#8217;s own vectors and maps.</p></div>
<div class="paragraph"><p>There are several ways to connect to Mongo, depending on how much you need to customize your connection and whether you have a map of options or a URI:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Connect to localhost, port 27017 by default</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect to another machine</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> {<span style="color: #990000">:</span>host <span style="color: #FF0000">"192.168.1.100"</span> <span style="color: #990000">:</span>port <span style="color: #993399">27017</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect using more complex options</span></span>
<span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>options <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>mongo<span style="color: #990000">-</span>options <span style="color: #990000">:</span>auto<span style="color: #990000">-</span>connect<span style="color: #990000">-</span>retry true
                                   <span style="color: #990000">:</span>connect<span style="color: #990000">-</span>timeout <span style="color: #993399">15</span>
                                   <span style="color: #990000">:</span>socket<span style="color: #990000">-</span>timeout <span style="color: #993399">15</span><span style="color: #990000">)</span>
      server <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>server<span style="color: #990000">-</span>address <span style="color: #FF0000">"192.168.1.100"</span> <span style="color: #993399">27017</span><span style="color: #990000">)]</span>
  <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!</span> server options<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Connect via a URI</span></span>
<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">-</span>via<span style="color: #990000">-</span>uri<span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">(System</span></span><span style="color: #990000">/</span>genenv <span style="color: #FF0000">"MONGOHQ_URL"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>When inserting data, giving each document an <span class="monospaced">_id</span> is optional. One will be created for you if you do not have one in your document. It often makes sense to add it yourself, however, if you need to reference the document afterward:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>collection <span style="color: #990000">:</span>as coll<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(import</span></span> '<span style="color: #990000">[</span>org<span style="color: #990000">.</span>bson<span style="color: #990000">.</span>types ObjectId<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>id <span style="font-weight: bold"><span style="color: #000000">(ObjectId</span></span><span style="color: #990000">.)</span>
      user {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Lola Morales"</span>}<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>insert <span style="color: #FF0000">"users"</span> <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> user <span style="color: #990000">:</span>_id id<span style="color: #990000">))</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Later, look up your user by id</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(coll</span></span><span style="color: #990000">/</span>find<span style="color: #990000">-</span>map<span style="color: #990000">-</span>by<span style="color: #990000">-</span>id <span style="color: #FF0000">"users"</span> id<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:_id #&lt;ObjectId 521...&gt;, :name "Lola Morales"}</span></span></tt></pre></div></div>
<div class="paragraph"><p>In its idiomatic usage, Monger is set up to work with one connection and one database, as <span class="monospaced">monger.core/connect!</span> and <span class="monospaced">monger.core/use-db!</span> set dynamic vars to hold their information.</p></div>
<div class="paragraph"><p>It is easy to work around this, though. You can use <span class="monospaced">binding</span> to set these explicitly around code. In addition, you can use the <span class="monospaced">monger.multi.collection</span> namespace instead of <span class="monospaced">monger.collection</span>. All functions in the <span class="monospaced">monger.multi.collection</span> namespace take a database as their first argument:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as mongo<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>multi<span style="color: #990000">.</span>collection <span style="color: #990000">:</span>as multi<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect<span style="color: #990000">!)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; use-db! takes a string for the database, as it is a convenience function,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; but for monger.multi.collection and other functions, we need to use</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; get-db to get the database</span></span>
<span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>stats<span style="color: #990000">-</span>server <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>connect <span style="color: #FF0000">"stats.example.org"</span><span style="color: #990000">)</span>
      app<span style="color: #990000">-</span>db <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>db <span style="color: #FF0000">"mongo-time"</span><span style="color: #990000">)</span>
      geo<span style="color: #990000">-</span>db <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>db <span style="color: #FF0000">"geography"</span><span style="color: #990000">)]</span>

  <span style="font-style: italic"><span style="color: #9A1900">;; Record data in our stats server</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(binding</span></span> <span style="color: #990000">[</span>mongo<span style="color: #990000">/*</span>mongodb<span style="color: #990000">-</span>connection<span style="color: #990000">*</span> stats<span style="color: #990000">-</span>server<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(multi</span></span><span style="color: #990000">/</span>insert <span style="font-weight: bold"><span style="color: #000000">(mongo</span></span><span style="color: #990000">/</span>get<span style="color: #990000">-</span>db <span style="color: #FF0000">"stats"</span><span style="color: #990000">)</span> <span style="color: #FF0000">"access"</span>
                  {<span style="color: #990000">:</span>ip <span style="color: #FF0000">"127.0.0.1"</span> <span style="color: #990000">:</span>time <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">.)</span>}<span style="color: #990000">))</span>

  <span style="font-style: italic"><span style="color: #9A1900">;; Find users in our application DB</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(multi</span></span><span style="color: #990000">/</span>find<span style="color: #990000">-</span>maps app<span style="color: #990000">-</span>db <span style="color: #FF0000">"users"</span> {<span style="color: #990000">:</span>state <span style="color: #FF0000">"WY"</span>}<span style="color: #990000">)</span>

  <span style="font-style: italic"><span style="color: #9A1900">;; Insert a square in our geography DB</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(multi</span></span><span style="color: #990000">/</span>insert geo<span style="color: #990000">-</span>db <span style="color: #FF0000">"shapes"</span>
                {<span style="color: #990000">:</span>name <span style="color: #FF0000">"square"</span> <span style="color: #990000">:</span>sides <span style="color: #993399">4</span>
                 <span style="color: #990000">:</span>parallel true <span style="color: #990000">:</span>equal true}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The basic find functions in <span class="monospaced">monger.collection</span> will work for simple queries, but you will soon find yourself needing to make more complex queries, which is where <span class="monospaced">monger.query</span> comes in. This is a domain-specific language for MongoDB queries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>monger<span style="color: #990000">.</span>query <span style="color: #990000">:</span>as q<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Find users, skipping the first two and getting the next three.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>collection <span style="color: #FF0000">"users"</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>find {}<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>skip <span style="color: #993399">2</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>limit <span style="color: #993399">3</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Get all the users from Oklahoma, sorted by name.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; You must use array-map with sort so you can keep keys in order.</span></span>
<span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>collection <span style="color: #FF0000">"users"</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>find {<span style="color: #990000">:</span>state <span style="color: #FF0000">"OK"</span>}<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>sort <span style="font-weight: bold"><span style="color: #000000">(array</span></span><span style="color: #990000">-</span>map <span style="color: #990000">:</span>name <span style="color: #993399">1</span><span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Get all users not from Oklahoma or with names that start with "S".</span></span>
<span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>with<span style="color: #990000">-</span>collection <span style="color: #FF0000">"users"</span>
  <span style="font-weight: bold"><span style="color: #000000">(q</span></span><span style="color: #990000">/</span>find {<span style="color: #FF0000">"$or"</span> <span style="color: #990000">[</span>{<span style="color: #990000">:</span>state {<span style="color: #FF0000">"$ne"</span> <span style="color: #FF0000">"OK"</span>}}
                  {<span style="color: #990000">:</span>name #<span style="color: #FF0000">"^S"</span>}<span style="color: #990000">]</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_121">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://clojuremongodb.info/">Monger documentation</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/aboekhoff/congomongo">CongoMongo</a>, another Clojure library for working with MongoDB that you might consider
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_redis">Working with Redis</h3>
<div class="paragraph byline"><p>by Jason Webb</p></div>
<div class="sect3">
<h4 id="_problem_123">Problem</h4>
<div class="paragraph"><p>You want to work with data in Redis.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_123">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/ptaoussanis/carmine">Carmine</a> to connect to and interact with Redis.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">To use this recipe, you should first install Redis and have it running locally. You can find
details on how to install  Redis at <a href="http://redis.io/download">the official Redis download page</a>.  If
you are on Windows, you will want to look at <a href="https://github.com/MSOpenTech/redis">the Microsoft Open
Tech GitHub Redis project</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[com.taoensso/carmine "2.2.0"]</span> to your project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>taoensso/carmine</tt></pre></div></div>
<div class="paragraph"><p>To use Carmine, you must first define a connection spec:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> server<span style="color: #990000">-</span>connection {<span style="color: #990000">:</span>pool {<span style="color: #990000">:</span>max<span style="color: #990000">-</span>active <span style="color: #993399">8</span>}
                        <span style="color: #990000">:</span>spec {<span style="color: #990000">:</span>host     <span style="color: #FF0000">"localhost"</span>
                               <span style="color: #990000">:</span>port     <span style="color: #993399">6379</span>
                               <span style="font-style: italic"><span style="color: #9A1900">;;:password ""</span></span>
                               <span style="color: #990000">:</span>timeout  <span style="color: #993399">4000</span>}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Carmine supports all of the Redis commands, and the names (for the most part) match the Redis documentation.
Use the <span class="monospaced">wcar</span> function and the connection specification <span class="monospaced">server-connection</span> to send all the Redis commands
you already know and love:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> `<span style="color: #990000">[</span>taoensso<span style="color: #990000">.</span>carmine <span style="color: #990000">:</span>as car <span style="color: #990000">:</span>refer <span style="font-weight: bold"><span style="color: #000000">(wcar</span></span><span style="color: #990000">)])</span>

<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>set <span style="color: #FF0000">"Nick"</span> <span style="color: #FF0000">"Nack"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "OK"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"Nick"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Nack"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>hset <span style="color: #FF0000">"founder"</span> <span style="color: #FF0000">"name"</span> <span style="color: #FF0000">"Tim"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span>
<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>hset <span style="color: #FF0000">"founder"</span> <span style="color: #FF0000">"age"</span> <span style="color: #993399">59</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span>
<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>hgetall <span style="color: #FF0000">"founder"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [name Tim age 59]</span></span></tt></pre></div></div>
<div class="paragraph"><p>Passing in multiple commands will pipeline them and return the results together as a vector:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> server<span style="color: #990000">-</span>connection <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>set <span style="color: #FF0000">"paddywhacks"</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
                        <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>incr <span style="color: #FF0000">"paddywhacks"</span><span style="color: #990000">)</span>
                        <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"paddywhacks"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ["OK" 1 "1"]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_123">Discussion</h4>
<div class="paragraph"><p>Redis describes itself as a <em>data structure server</em>.  With data structures similar to the core data
structures in Clojure, they make a natural pairing for a wide range of problems. Redis&#8217;s speed and
key/value storage make it especially useful for caching and memoization applications (more on that
later).</p></div>
<div class="paragraph"><p>You can remove some boilerplate by wrapping the call to <span class="monospaced">wcar</span> in a macro that passes the
connection specification for you:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmacro</span></span> wcar<span style="color: #990000">*</span> <span style="color: #990000">[&amp;</span> body<span style="color: #990000">]</span> `<span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>wcar server<span style="color: #990000">-</span>connection <span style="color: #990000">~</span>@body<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span><span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>set <span style="color: #FF0000">"Nick"</span> <span style="color: #FF0000">"Nack"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "OK"</span></span>
<span style="font-weight: bold"><span style="color: #000000">(wcar</span></span><span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"Nick"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Nack"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Serialization is handled automatically and for most cases just works.  Simply pass in the data you
want to store, and Carmine will automatically serialize/deserialize it for you:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(wcar</span></span><span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>set <span style="color: #FF0000">"some-key"</span> {<span style="color: #990000">:</span>event <span style="color: #FF0000">"An Event"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>timestamp <span style="font-weight: bold"><span style="color: #000000">(new</span></span> java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Date<span style="color: #990000">)</span>}<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"some-key"</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [OK {:event An Event, :timestamp #inst "2013-08-18T21:31:33.993-00:00"}]</span></span></tt></pre></div></div>
<div class="paragraph"><p>This works great as long as you stick to core Clojure data types. However, if you need to support
storing custom data types, you will need to deal with the underlying serialization library, called Nippy. For
more information, see <a href="https://github.com/ptaoussanis/nippy">the Nippy GitHub project</a>.</p></div>
<div class="paragraph"><p>Redis is great to use as a memoization storage backend.  Obviously,
there are some serious trade-offs to consider when weighing against an
in-memory solution, such as the <span class="monospaced">core.cache</span> library.  But for the
right situation, it can be an incredible boost.  Consider, for example,
memoizing a function that hits an external web service to fetch the
current weather.  With minimal effort, multiple servers can share the
latest data and even have stale data automatically expire and refresh.
The following is an example for just such a situation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> redis<span style="color: #990000">-</span>memoize
  <span style="color: #FF0000">"Convert a function to one that is memoized using Redis as storage."</span>
  <span style="color: #990000">[</span>key<span style="color: #990000">-</span>prefix ttl<span style="color: #990000">-</span>seconds connection<span style="color: #990000">-</span>spec f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>key<span style="color: #990000">-</span>name <span style="color: #990000">[</span>key<span style="color: #990000">-</span>prefix args<span style="color: #990000">]]</span>
      <span style="font-weight: bold"><span style="color: #000000">(if</span></span><span style="color: #990000">-</span>let <span style="color: #990000">[</span>found<span style="color: #990000">-</span>result <span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> connection<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>get key<span style="color: #990000">-</span>name<span style="color: #990000">))]</span>
        found<span style="color: #990000">-</span>result
        <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>new<span style="color: #990000">-</span>result <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> f args<span style="color: #990000">)]</span>
          <span style="font-weight: bold"><span style="color: #000000">(wcar</span></span> connection<span style="color: #990000">-</span>spec <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>set key<span style="color: #990000">-</span>name new<span style="color: #990000">-</span>result<span style="color: #990000">)</span>
                                <span style="font-weight: bold"><span style="color: #000000">(car</span></span><span style="color: #990000">/</span>expire key<span style="color: #990000">-</span>name ttl<span style="color: #990000">-</span>seconds<span style="color: #990000">))</span>
          new<span style="color: #990000">-</span>result<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>This makes a couple of assumptions worth noting.  First, it assumes that the arguments for the function
being memoized are supported by Nippy (see the earlier serialization example).  Second, it assumes that the
memoized data should be expired after a specified number of seconds.  To use <span class="monospaced">redis-memoize</span>, simply
pass in a function.  The following is a highly contrived example that uses the <span class="monospaced">server-connection</span>
defined previously:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> square <span style="color: #990000">[</span>x<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(printf</span></span> <span style="color: #FF0000">"Ran square for: %s</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span> x<span style="color: #990000">)</span>
  <span style="color: #990000">(*</span> x x<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> redis<span style="color: #990000">-</span>squared
  <span style="font-weight: bold"><span style="color: #000000">(redis</span></span><span style="color: #990000">-</span>memoize <span style="color: #FF0000">"squared"</span> <span style="color: #993399">10</span> server<span style="color: #990000">-</span>connection square<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(redis</span></span><span style="color: #990000">-</span>squared <span style="color: #993399">99</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; Ran square for: 99</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 9801</span></span>
<span style="font-weight: bold"><span style="color: #000000">(redis</span></span><span style="color: #990000">-</span>squared <span style="color: #993399">99</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 9801</span></span></tt></pre></div></div>
<div class="paragraph"><p>In addition to the features showcased earlier, Carmine includes (among
other things) a message queue, distributed locks, a
Ring session store, and even an implementation of DynamoDB (which is
in alpha at the time of writing).  These features are outside the
scope of this recipe, but they&#8217;re well documented and straightforward to
use.  Consult <a href="https://github.com/ptaoussanis/carmine">the Carmine
GitHub project</a> for more information.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_122">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/ptaoussanis/carmine">Carmine GitHub project</a> for more information about
  Carmine
</p>
</li>
<li>
<p>
The <a href="http://redis.io/commands">official Redis documentation</a> for a complete list of Redis
  commands
</p>
</li>
<li>
<p>
The <a href="https://github.com/ptaoussanis/nippy">Nippy GitHub project</a> for information about
  serialization
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/clj-memoize-doc">Clojure core documentation</a> for
  documentation of the <span class="monospaced">memoize</span> function
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_datomic_connect_to_datomic">Connecting to a Datomic Database</h3>
<div class="paragraph byline"><p>by Robert Stuttaford</p></div>
<div class="sect3">
<h4 id="_problem_124">Problem</h4>
<div class="paragraph"><p>You need to connect to a Datomic database.</p></div>
</div>
<div class="sect3">
<h4 id="sec_datomic_connect_to_datomic_solution">Solution</h4>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.datomic/datomic-free "0.8.4218"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>datomic/datomic-free</tt></pre></div></div>
<div class="paragraph"><p>To create and connect to an in-memory database, use
<span class="monospaced">datomic.api/create-database</span> and <span class="monospaced">datomic.api/connect</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> uri <span style="color: #FF0000">"datomic:mem://sample-database"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>create<span style="color: #990000">-</span>database uri<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; true</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> conn <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>connect uri<span style="color: #990000">))</span>

conn
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #&lt;LocalConnection datomic.peer.LocalConnection@49384d99&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Once you have a connection, you can use it to get a database <em>value</em>
with <span class="monospaced">datomic.api/db</span>. This value is used to query a database:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> db <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>connect uri<span style="color: #990000">)))</span>

db
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; datomic.db.Db@7b7fea26</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can also use the connection to transact data using
<span class="monospaced">datomic.api/transact</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Transact the schema for your Next Big Thing</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> my<span style="color: #990000">-</span>great<span style="color: #990000">-</span>schema <span style="color: #990000">[])</span> <span style="font-style: italic"><span style="color: #9A1900">; This vector intentionally left blank</span></span>
<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>connect uri<span style="color: #990000">)</span> my<span style="color: #990000">-</span>great<span style="color: #990000">-</span>schema<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_124">Discussion</h4>
<div class="paragraph"><p>You&#8217;ll notice in the solution that we not only connected to a database,
but we created it too. This pattern is common when using in-memory
databases, as no in-memory databases exist in a fresh JVM. It is not
strictly necessary to call <span class="monospaced">create-database</span> if the database already
exists, but it is safe to do so&#x2014;<literal>create-database</literal> is idempotent and
will return <span class="monospaced">false</span> if one already exists. When connecting to a database that isn&#8217;t in memory, it is necessary
for the relevant transactor and storage service to be running.</p></div>
<div class="paragraph"><p>The return value of <span class="monospaced">d/connect</span> is used when querying a database value
or when transacting data. It is also used when reading the transaction
log, when consuming the transaction report queue, or when performing
administrative tasks such as requesting an indexing job, garbage
collecting storage, and disposing of resources associated with the
connection.</p></div>
<div class="paragraph"><p>Connections are thread-safe and are cached by URI internally, so
there is no need to pool connections yourself. There is no performance
overhead for creating many connections to the same URI.</p></div>
<div class="sect4">
<h5 id="_storage_services">Storage services</h5>
<div class="paragraph"><p>Datomic transactor processes have a limit on the number of
concurrently connected peer processes. Datomic Free has a limit of two
peers per transactor. For nondistributed applications, this may well
be sufficient. If you&#8217;re building a larger service, then you may need
a Datomic Pro license for more peers.</p></div>
<div class="paragraph"><p>There are several options for storage services that back Datomic. Three are built-in, and the rest use external services. Datomic Free
includes access to the in-memory and <span class="monospaced">:free</span> storage backends. Datomic
Pro and Pro Starter Edition include access to all services.</p></div>
</div>
<div class="sect4">
<h5 id="_built_in_storage_options">Built-in storage options</h5>
<div class="paragraph"><p>The built-in storage options are:</p></div>
<div class="ulist"><ul>
<li>
<p>
In local memory: <span class="monospaced">"datomic:mem://[db-name]"</span>
</p>
</li>
<li>
<p>
Free, for use with Datomic Free, subject to a two-peer limit:
  <span class="monospaced">"datomic:free://host[:port]/[db-name]"</span>
</p>
</li>
<li>
<p>
Dev, for use with Datomic Pro, subject to the licensed peer limit:
  <span class="monospaced">"datomic:dev://host[:port]/[db-name]"</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Free and Dev can also be configured to use alternate ports for
storage: <span class="monospaced">"datomic:free://host[:port]/[db-name]?h2-port=[port]&amp;h2-web-port=[port]"</span>.</p></div>
<div class="paragraph"><p>By default, these ports will be one and two more than the transactor port,
respectively.</p></div>
</div>
<div class="sect4">
<h5 id="_external_storage_service_options">External storage service options</h5>
<div class="paragraph"><p>Several external storage options also exist. These include:</p></div>
<div class="ulist"><ul>
<li>
<p>
DynamoDB:  <span class="monospaced">"datomic:ddb://[aws-region]/[dynamodb-table]/[db-name]?aws_access_key_id=[XXX]&amp;aws_secret_key=[YYY]"</span>
</p>
</li>
<li>
<p>
Riak:
  <span class="monospaced">"datomic:riak://host[:port]/bucket/dbname[?interface=http|protobuf]"</span>
  (default is protobuf)
</p>
</li>
<li>
<p>
Couchbase: <span class="monospaced">"datomic:couchbase://host/bucket/dbname[?password=xxx]"</span>
</p>
</li>
<li>
<p>
Infinispan: <span class="monospaced">"datomic:inf://[cluster-member-host:port]/[db-name]"</span>
</p>
</li>
<li>
<p>
SQL: <span class="monospaced">"datomic:sql://[db-name][?jdbc-url]"</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>For SQL storage services, the map format can be used instead of the
string format. This is useful when specifying objects that can&#8217;t be
embedded in URI strings, like <literal>DataSource</literal>s. The format for the SQL map
is:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>protocol <span style="color: #990000">:</span>sql                         <span style="font-style: italic"><span style="color: #9A1900">;; keyword or string</span></span>
 <span style="color: #990000">:</span>db<span style="color: #990000">-</span>name <span style="color: #FF0000">"[db-name]"</span>                   <span style="font-style: italic"><span style="color: #9A1900">;; keyword or string</span></span>
 <span style="color: #990000">:</span>data<span style="color: #990000">-</span>source aDataSourceObject
  <span style="font-style: italic"><span style="color: #9A1900">;; OR</span></span>
 <span style="color: #990000">:</span>factory aCallableReturningConnection}</tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_123">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_datomic_schema">[sec_datomic_schema]</a>
</p>
</li>
<li>
<p>
<a href="#sec_datomic_transact_basics">[sec_datomic_transact_basics]</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/datatomic-starter">Datomic Pro Starter Edition</a>, for free access to all service storages and the Datomic Console
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_datomic_schema">Defining a Schema for a Datomic Database</h3>
<div class="paragraph byline"><p>by Robert Stuttaford</p></div>
<div class="sect3">
<h4 id="_problem_125">Problem</h4>
<div class="paragraph"><p>You need to define how your data will be modeled in Datomic. For
example, you need to model users and their user groups, relating
the two in some way.</p></div>
</div>
<div class="sect3">
<h4 id="sec_datomic_schema_solution">Solution</h4>
<div class="paragraph"><p>Datomic schemas are defined in terms of <em>attributes</em>. It&#8217;s probably
easiest to jump straight to an example.</p></div>
<div class="paragraph"><p>To follow along with this recipe, first complete the recipes for <a href="#sec_datomic_connect_to_datomic">[sec_datomic_connect_to_datomic]</a>. After doing this, you
should have an in-memory database and connection, <span class="monospaced">conn</span>, to work with.</p></div>
<div class="paragraph"><p>Consider the attributes a user might have:</p></div>
<div class="ulist"><ul>
<li>
<p>
One email address, which must be unique to the database
</p>
</li>
<li>
<p>
One name, which we index for fast search
</p>
</li>
<li>
<p>
Any number of roles (guest, author, and editor)
</p>
</li>
</ul></div>
<div class="paragraph"><p>To define this schema, create a vector with attribute maps for email,
name, and role, as well as insertions of the three static roles:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> user<span style="color: #990000">-</span>schema
  <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"User email address"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>string
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>one
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>unique <span style="color: #990000">:</span>db<span style="color: #990000">.</span>unique<span style="color: #990000">/</span>identity
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}

   {<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"User name"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>string
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>one
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>index true
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}

   {<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"User roles"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">/</span>roles
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>ref
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>many
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}

   <span style="color: #990000">[:</span>db<span style="color: #990000">/</span>add <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span> <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>guest<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>db<span style="color: #990000">/</span>add <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span> <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author<span style="color: #990000">]</span>
   <span style="color: #990000">[:</span>db<span style="color: #990000">/</span>add <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span> <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>editor<span style="color: #990000">]])</span></tt></pre></div></div>
<div class="paragraph"><p>We define a group as having:</p></div>
<div class="ulist"><ul>
<li>
<p>
One UUID, which must be unique to the database
</p>
</li>
<li>
<p>
One name, which we index for fast search
</p>
</li>
<li>
<p>
Any number of related users
</p>
</li>
</ul></div>
<?hard-pagebreak?>
<div class="paragraph"><p>Define the group as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> group<span style="color: #990000">-</span>schema
  <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"Group UUID"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>group<span style="color: #990000">/</span>uuid
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>uuid
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>one
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>unique <span style="color: #990000">:</span>db<span style="color: #990000">.</span>unique<span style="color: #990000">/</span>value
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}

   {<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"Group name"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>group<span style="color: #990000">/</span>name
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>string
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>one
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>index true
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}

   {<span style="color: #990000">:</span>db<span style="color: #990000">/</span>doc <span style="color: #FF0000">"Group users"</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident <span style="color: #990000">:</span>group<span style="color: #990000">/</span>users
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>valueType <span style="color: #990000">:</span>db<span style="color: #990000">.</span>type<span style="color: #990000">/</span>ref
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>cardinality <span style="color: #990000">:</span>db<span style="color: #990000">.</span>cardinality<span style="color: #990000">/</span>many
    <span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db<span style="color: #990000">)</span>
    <span style="color: #990000">:</span>db<span style="color: #990000">.</span>install<span style="color: #990000">/</span>_attribute <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>db}<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, <span class="monospaced">transact</span> both schema definitions into a database via a
connection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>connect <span style="color: #FF0000">"datomic:mem://sample-database"</span><span style="color: #990000">)</span>
             <span style="font-weight: bold"><span style="color: #000000">(concat</span></span> user<span style="color: #990000">-</span>schema group<span style="color: #990000">-</span>schema<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:db-before datomic.db.Db@25b48c7b,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :db-after datomic.db.Db@5d81650c,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :tx-data [#Datum{:e ... :a ... :v ... :tx  :added true}, ...],</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :tempids {-... ..., ...}}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_125">Discussion</h4>
<div class="paragraph"><p>A Datomic schema is represented as Clojure data and is added to the
database in a transaction, just like any other data we would store.
The <span class="monospaced">:db.install/_attribute :db.part/db</span> key/value pair is used by the
transactor to make the schema available to the rest of the system.</p></div>
<div class="paragraph"><p>The schema is placed in the <span class="monospaced">:db.part/db</span> database partition, a partition
reserved for schemas. All user data is placed in user partition(s)&#x2014;either the default of <span class="monospaced">:db.part/user</span> or a custom partition. Partitions
are useful for optimizing how indexes sort data, which is useful for
optimizing a query. Schema entities require that at least <span class="monospaced">:db/ident</span>, <span class="monospaced">:db/valueType</span>, and
<span class="monospaced">:db/cardinality</span> values are present.</p></div>
<div class="paragraph"><p>Aside from the schema, Datomic does not enforce how attributes are
combined for any given entity. Datomic only requires that a schema be
defined up front, enforcing type and uniqueness constraints at
runtime.</p></div>
<div class="paragraph"><p>Use namespaces in schema <span class="monospaced">:db/ident</span> values to help classify entities
(such as <span class="monospaced">user</span> in <span class="monospaced">:user/email</span>). Datomic doesn&#8217;t do anything
specific with namespaces, so using them is optional. There are several options for <span class="monospaced">:db/valueType</span>, listed in <a href="#table6-1">[table6-1]</a>.</p></div>
<table class="tableblock frame-all grid-all" id="table6-1"
style="
width:100%;
">
<caption class="title">Table 2. :db/valueType options</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/keyword</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/string</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/long</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/boolean</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/bigint</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/float</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/double</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/bigdec</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/instant</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/ref</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/uuid</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/uri</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:db.type/bytes</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>See <a href="http://docs.datomic.com/schema.html">the Datatomic schema documentation</a> for an exhaustive listing of their semantics.</p></div>
<div class="paragraph"><p>Attributes with <span class="monospaced">:db/valueType :db.type/ref</span> can only have other
entities as their value(s). You use this type to model relationships
between entities. Datomic does not enforce which entities are related
to on a given <span class="monospaced">:db/valueType :db.type/ref</span> attribute. Any other entity
can be related to&#8212;this means that entities can relate to themselves!</p></div>
<div class="paragraph"><p>You also use <span class="monospaced">:db/valueType :db.type/ref</span> and lone <span class="monospaced">:db/ident</span> values
to model enumerations, such as the user roles that you defined. These
enumerations are not actually attributes; they are normal entities with a
single attribute, <span class="monospaced">:db/ident</span>. An entity&#8217;s <span class="monospaced">:db/ident</span> value serves as
a shorthand for that entity; you may use this value in lieu of the
entity ID (the <span class="monospaced">:db/id</span> value) in transactions and queries.</p></div>
<div class="paragraph"><p>Attributes with <span class="monospaced">:db/valueType :db.type/ref</span> and <span class="monospaced">:db/unique</span> values
are implicitly indexed as though you had added <span class="monospaced">:db/index true</span> to
their definitions.</p></div>
<div class="paragraph"><p>It is also possible to use Lucene full-text indexing on string
attributes, using <span class="monospaced">:db/fulltext true</span> and the system-defined
<span class="monospaced">fulltext</span> function in Datalog.</p></div>
<div class="paragraph"><p>There are two options for specifying a uniqueness constraint at
<span class="monospaced">:db/unique</span>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:db.unique/value</span>
</dt>
<dd>
<p>
Disallows attempts to insert a duplicate value for a different entity ID.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:db.unique/identity</span>
</dt>
<dd>
<p>
Designates that the attribute value is unique to each entity
  and enables "upserts"; any attempts to insert a duplicate value for a
  temporary entity ID will cause all attributes associated with that
  temporary ID to be merged with the entity already in the database.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In the case where you are modeling entities with subentities that
only exist in the context of those entities, such as order items on an
order or variants for a product, you can use <span class="monospaced">:db/isComponent</span> to
simplify working with such subentities. It can only be used on
attributes of type <span class="monospaced">:db.type/ref</span>.</p></div>
<div class="paragraph"><p>When you use the <span class="monospaced">:db.fn/retractEntity</span> function in a transaction, any
entities on the value side of such attributes for the retracted entity
will also be retracted. Also, when you use <span class="monospaced">d/touch</span> to realize all
the lazy keys in an entity map, component entities will be
realized too. Both the retraction and realization behaviors are
recursive.</p></div>
<div class="paragraph"><p>By default, Datomic stores all past values of attributes. If you do
not wish to keep past values for a particular attribute, use
<span class="monospaced">:db/noHistory true</span> to have Datomic discard previous values. Using
this attribute is much like using a traditional update-in-place
database.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_124">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_datomic_transact_basics">[sec_datomic_transact_basics]</a>, for more information on
  transacting datoms (schemas!)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_datomic_transact_basics">Writing Data to Datomic</h3>
<div class="paragraph byline"><p>by Robert Stuttaford</p></div>
<div class="sect3">
<h4 id="_problem_126">Problem</h4>
<div class="paragraph"><p>You need to add data to your Datomic database.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_124">Solution</h4>
<div class="paragraph"><p>Use a Datomic connection to transact data.</p></div>
<div class="paragraph"><p>To follow along with this recipe, first complete the recipes for
<a href="#sec_datomic_connect_to_datomic">[sec_datomic_connect_to_datomic]</a>, and <a href="#sec_datomic_schema">[sec_datomic_schema]</a>.</p></div>
<div class="paragraph"><p>After doing this, you will have a
connection, <span class="monospaced">conn</span>, and a schema installed against which you can
insert data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>q db<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>data <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span>
               <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"fowler@acm.org"</span>
               <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Martin Fowler"</span>
               <span style="color: #990000">:</span>user<span style="color: #990000">/</span>roles <span style="color: #990000">[:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>editor<span style="color: #990000">]</span>}<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>result @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn tx<span style="color: #990000">-</span>data<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(q</span></span> '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>name
     <span style="color: #990000">:</span>where <span style="color: #990000">[?</span>e <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #990000">?</span>name<span style="color: #990000">]]</span>
   <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after tx<span style="color: #990000">-</span>result<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{["Martin Fowler"]}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_126">Discussion</h4>
<div class="paragraph"><p>This map-based syntax for representing the data expands to a series of
<span class="monospaced">:db/add</span> statements. This transaction is identical to the previous
one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> new<span style="color: #990000">-</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">))</span>
new<span style="color: #990000">-</span>id
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #db/id[:db.part/user -1000013]</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>data2 <span style="color: #990000">[[:</span>db<span style="color: #990000">/</span>add new<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"ryan@cognitect.com"</span><span style="color: #990000">]</span>
               <span style="color: #990000">[:</span>db<span style="color: #990000">/</span>add new<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Ryan Neufeld"</span><span style="color: #990000">]</span>
               <span style="color: #990000">[:</span>db<span style="color: #990000">/</span>add new<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>roles <span style="color: #990000">[:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author
                                            <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>editor<span style="color: #990000">]]])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>result @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn tx<span style="color: #990000">-</span>data2<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; Keep this for later...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(q</span></span> '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>name
     <span style="color: #990000">:</span>where <span style="color: #990000">[?</span>e <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #990000">?</span>name<span style="color: #990000">]]</span>
   <span style="font-weight: bold"><span style="color: #000000">(db</span></span> conn<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{["Ryan Neufeld"] ["Martin Fowler"]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Of course, you can use statements like these yourself, or you can use the map syntax shown in the solution. You can also mix the two. This is
how you would transact multiple entries (e.g., <span class="monospaced">(d/transact conn
[person1-map person2-map])</span>).</p></div>
<div class="paragraph"><p>One difference you&#8217;ll note between the map and the expanded form is
the lack of a <span class="monospaced">:db/add</span> statement for the <span class="monospaced">:db/id</span> key. In the
expanded form, this value comes immediately after the action
(<span class="monospaced">:db/add</span>) and <em>must</em> be identical between all statements to
correlate attributes to a single entity. When specifying an entity as
a map, you provide a single ID, which the transactor transparently
affixes to each attribute.</p></div>
<div class="paragraph"><p>What is an appropriate ID? Any new entities are assigned
temporary, negative ID values, which can be used to model
relationships within the transaction. Upon successfully completing a
transaction, all the temporary IDs are assigned in-storage positive ID
values. When working with code, the correct approach is to use the
<span class="monospaced">datomic.api/tempid</span> function to obtain a temporary ID. The
<span class="monospaced">datomic.api/tempid</span> function takes a partition keyword and an optional ID number as its
arguments; for most purposes, <span class="monospaced">:db.part/user</span> will suffice.</p></div>
<div class="paragraph"><p>When working with nonexecutable data, you&#8217;ll need to use the
data-literal form for temporary IDs. The literal <span class="monospaced">#db/id
[:db.part/user]</span> is equivalent to <span class="monospaced">(d/tempid :db.part/user)</span>. This
form is most useful when you store transaction data in an <em>.edn</em>
file, which is most often the case with schema definitions. Again, you
should use <span class="monospaced">d/tempid</span> in your code&#8212;the <span class="monospaced">#db/id</span> literal will
evaluate once at compile time, which means that any code that
expects the ID value to change from one execution to the next will
fail, because it&#8217;ll only ever have one value.</p></div>
<div class="listingblock">
<div class="title">Consider our example file, <em>user-bootstrap.edn</em>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id #db<span style="color: #990000">/</span>id <span style="color: #990000">[:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">]</span>
  <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"fowler@acm.org"</span>
  <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Martin Fowler"</span>
  <span style="color: #990000">:</span>user<span style="color: #990000">/</span>roles <span style="color: #990000">[:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>editor<span style="color: #990000">]</span>}<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>When a transaction completes, you&#8217;ll receive a completed future. If you
prefer to transact asynchronously, you can use <span class="monospaced">d/transact-async</span>
instead, which will return its future immediately. In this case, as
with all futures, when you dereference it, it will block until the
transaction completes. Either way, dereferencing the future returns a
map, with four keys:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:db-before</span>
</dt>
<dd>
<p>
The value of the database just before the transaction was committed
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:db-after</span>
</dt>
<dd>
<p>
The value of the database just after the transaction was committed
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:tx-data</span>
</dt>
<dd>
<p>
A vector of all the datoms that were transacted
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:tempids</span>
</dt>
<dd>
<p>
A mapping of the temporary IDs to the in-storage IDs, one per temporary ID in the transaction
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You can use the <span class="monospaced">:db-after</span> database to query the database directly
after the transaction:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>after<span style="color: #990000">-</span>tx <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after tx<span style="color: #990000">-</span>result<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(q</span></span> '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>name <span style="color: #990000">:</span>in $ <span style="color: #990000">?</span>email <span style="color: #990000">:</span>where
     <span style="color: #990000">[?</span>entity <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #990000">?</span>email<span style="color: #990000">]</span>
     <span style="color: #990000">[?</span>entity <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #990000">?</span>name<span style="color: #990000">]]</span>
   db<span style="color: #990000">-</span>after<span style="color: #990000">-</span>tx
   <span style="color: #FF0000">"fowler@acm.org"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{["Martin Fowler"]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can use the <span class="monospaced">:tempids</span> map to find the in-storage IDs for any new
entities you care about, much like you would when retrieving the last
insert ID in SQL databases. Invoke <span class="monospaced">datomic.api/resolve-tempid</span> with
the <span class="monospaced">:db-after</span> value, the <span class="monospaced">:tempids</span> value, and the original temporary ID
to retrieve the realized ID:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>resolve<span style="color: #990000">-</span>tempid db<span style="color: #990000">-</span>after<span style="color: #990000">-</span>tx <span style="color: #990000">(:</span>tempids tx<span style="color: #990000">-</span>result<span style="color: #990000">)</span> new<span style="color: #990000">-</span>id<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 17592186045421</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_125">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_datomic_schema">[sec_datomic_schema]</a>
</p>
</li>
<li>
<p>
<a href="#sec_retract_data">[sec_retract_data]</a>
</p>
</li>
<li>
<p>
<a href="#sec_datomic_dry_run">[sec_datomic_dry_run]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_retract_data">Removing Data from a Datomic Database</h3>
<div class="paragraph byline"><p>by Robert Stuttaford</p></div>
<div class="sect3">
<h4 id="_problem_127">Problem</h4>
<div class="paragraph"><p>You need to remove data from your Datomic database.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_125">Solution</h4>
<div class="paragraph"><p>To remove a value for an attribute, you should use the <span class="monospaced">:db/retract</span>
operation in transactions.</p></div>
<div class="paragraph"><p>To follow along with this recipe, first complete the recipes for <a href="#sec_datomic_connect_to_datomic">[sec_datomic_connect_to_datomic]</a>, and
<a href="#sec_datomic_schema">[sec_datomic_schema]</a>.</p></div>
<div class="paragraph"><p>To start things off, add a user, Barney Rubble, and verify that he has an email address:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> new<span style="color: #990000">-</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>result @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn
                            <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id new<span style="color: #990000">-</span>id
                              <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Barney Rubble"</span>
                              <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"barney@rubble.me"</span>}<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> after<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>db <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after tx<span style="color: #990000">-</span>result<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> barney<span style="color: #990000">-</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>resolve<span style="color: #990000">-</span>tempid after<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>db
                                 <span style="color: #990000">(:</span>tempids tx<span style="color: #990000">-</span>result<span style="color: #990000">)</span>
                                 new<span style="color: #990000">-</span>id<span style="color: #990000">))</span>

barney<span style="color: #990000">-</span>id
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 17592186045429</span></span>

<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>q '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>email <span style="color: #990000">:</span>in $ <span style="color: #990000">?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>where
       <span style="color: #990000">[?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #990000">?</span>email<span style="color: #990000">]]</span>
     after<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>db
     barney<span style="color: #990000">-</span>id<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{["barney@rubble.me"]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>To retract Barney&#8217;s email, transact a transaction with the
<span class="monospaced">:db/retract</span> operation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> retract<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>result @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn <span style="color: #990000">[[:</span>db<span style="color: #990000">/</span>retract barney<span style="color: #990000">-</span>id
                                           <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"barney@rubble.me"</span><span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> after<span style="color: #990000">-</span>retract<span style="color: #990000">-</span>db <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after retract<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>result<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>q '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>email <span style="color: #990000">:</span>in $ <span style="color: #990000">?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>where
       <span style="color: #990000">[?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #990000">?</span>email<span style="color: #990000">]]</span>
     after<span style="color: #990000">-</span>retract<span style="color: #990000">-</span>db
     barney<span style="color: #990000">-</span>id<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{}</span></span></tt></pre></div></div>
<div class="paragraph"><p>To retract entire entities, use the <span class="monospaced">:db.fn/retractEntity</span> built-in transactor function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> retract<span style="color: #990000">-</span>entity<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>result
  @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn <span style="color: #990000">[[:</span>db<span style="color: #990000">.</span>fn<span style="color: #990000">/</span>retractEntity barney<span style="color: #990000">-</span>id<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> after<span style="color: #990000">-</span>retract<span style="color: #990000">-</span>entity<span style="color: #990000">-</span>db <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after retract<span style="color: #990000">-</span>entity<span style="color: #990000">-</span>tx<span style="color: #990000">-</span>result<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>q '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>in $ <span style="color: #990000">?</span>name <span style="color: #990000">:</span>where
       <span style="color: #990000">[?</span>entity<span style="color: #990000">-</span>id <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #990000">?</span>name<span style="color: #990000">]]</span>
     after<span style="color: #990000">-</span>retract<span style="color: #990000">-</span>entity<span style="color: #990000">-</span>db
     <span style="color: #FF0000">"Barney Rubble"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #{}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_127">Discussion</h4>
<div class="paragraph"><p>When using <span class="monospaced">:db/retract</span>, you provide the value to retract so that in
the case of cardinality-many attributes, it&#8217;s clear which value to
retract from the set of values for that attribute. Regardless of the
cardinality, if you provide a value that isn&#8217;t in storage, nothing
will be retracted. This means that you have to know what value you
want to retract; you can&#8217;t simply retract everything for an attribute
by only providing the entity ID and the attribute.</p></div>
<div class="paragraph"><p>If you retract values for an attribute that does <em>not</em> use
<span class="monospaced">:db/noHistory</span>, you will be able to query past database values to
find past values for the attribute.</p></div>
<div class="paragraph"><p>If you retract values for an attribute that uses <span class="monospaced">:db/noHistory</span>, that
data will be <em>permanently deleted</em>.</p></div>
<div class="paragraph"><p>When using <span class="monospaced">:db.fn/retractEntity</span>, all attribute values for all the
attributes on that entity will be retracted, as will all <span class="monospaced">:db/ref</span>
attributes that have the entity as a value. Any component entities of
the entity being retracted will themselves be recursively
retracted.</p></div>
<div class="paragraph"><p>You&#8217;ll find that the actual entity ID itself is not retracted, but
that it will have no attributes associated with it. This is because
once an entity is created, it cannot be retracted. Removing all the
attributes and references to the entity has the same effect as if
it had been permanently removed, though!</p></div>
<div class="paragraph"><p>If you need to permanently remove data due to legal concerns or
because the data in question falls outside of your domain-specified
retention period, use
<a href="http://bit.ly/datomic-excision">excision</a> to remove the
data permanently.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_126">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://bit.ly/datomic-excision">The Datomic blog post</a> covering the excision feature
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_datomic_dry_run">Trying Datomic Transactions Without Committing Them</h3>
<div class="paragraph byline"><p>by Robert Stuttaford</p></div>
<div class="sect3">
<h4 id="_problem_128">Problem</h4>
<div class="paragraph"><p>You want to test a transaction prior to committing it using Datalog or
the entity API.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_126">Solution</h4>
<div class="paragraph"><p>Build your transaction as usual, but instead of calling <span class="monospaced">d/transact</span>
or <span class="monospaced">d/transact-async</span>, use <span class="monospaced">d/with</span> to produce an in-memory database
that includes the changes your transaction provides.</p></div>
<div class="paragraph"><p>To follow along with this recipe, first complete the recipes for <a href="#sec_datomic_connect_to_datomic">[sec_datomic_connect_to_datomic]</a>, and
<a href="#sec_datomic_schema">[sec_datomic_schema]</a>.</p></div>
<div class="paragraph"><p>First, add some data to the database about Fred Flintstone. As of
about 4000 BCE, Fred didn&#8217;t have an email, but we at least know his
name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> new<span style="color: #990000">-</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">))</span>


<span style="font-weight: bold"><span style="color: #000000">(def</span></span> tx<span style="color: #990000">-</span>result @<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn
                            <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id new<span style="color: #990000">-</span>id
                              <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Fred Flintstone"</span>}<span style="color: #990000">]))</span>
</tt></pre></div></div>
<div class="paragraph"><p>Fast-forward to today: Fred is thawed, after having been frozen in ice
for 6,000 years, and he gets his first email address. Prepare a
transaction to add an email to the Fred entity:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Grab Fred's ID from the original transaction</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> fred<span style="color: #990000">-</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>resolve<span style="color: #990000">-</span>tempid <span style="color: #990000">(:</span>db<span style="color: #990000">-</span>after tx<span style="color: #990000">-</span>result<span style="color: #990000">)</span>
                               <span style="color: #990000">(:</span>tempids tx<span style="color: #990000">-</span>result<span style="color: #990000">)</span>
                               new<span style="color: #990000">-</span>id<span style="color: #990000">))</span>

fred<span style="color: #990000">-</span>id
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 17592186045421</span></span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> add<span style="color: #990000">-</span>freds<span style="color: #990000">-</span>email<span style="color: #990000">-</span>tx <span style="color: #990000">[[:</span>db<span style="color: #990000">/</span>add fred<span style="color: #990000">-</span>id
                          <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"twinkletoes@example.com"</span><span style="color: #990000">]])</span></tt></pre></div></div>
<div class="paragraph"><p>Now, prepare an in-memory database with this new transaction applied.
First, get the current database value to use as a basis, then create
an in-memory database. Finally, grab the <span class="monospaced">:db-after</span> value so that
you can test that the email was properly added:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> db<span style="color: #990000">-</span>with
  <span style="color: #FF0000">"Return a new database with tx applied"</span>
  <span style="color: #990000">[</span>db tx<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>with db tx<span style="color: #990000">)</span>
      <span style="color: #990000">:</span>db<span style="color: #990000">-</span>after<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> db<span style="color: #990000">-</span>after <span style="font-weight: bold"><span style="color: #000000">(db</span></span><span style="color: #990000">-</span>with <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span> add<span style="color: #990000">-</span>freds<span style="color: #990000">-</span>email<span style="color: #990000">-</span>tx<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Compare the value of Fred&#8217;s email in the current database with
that of Fred&#8217;s email in the in-memory database:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> users<span style="color: #990000">-</span>email
  <span style="color: #FF0000">"Retrieve a user's email given the user's name."</span>
  <span style="color: #990000">[</span>db name<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>q '<span style="color: #990000">[:</span>find <span style="color: #990000">?</span>email
            <span style="color: #990000">:</span>in $ <span style="color: #990000">?</span>name
            <span style="color: #990000">:</span>where
            <span style="color: #990000">[?</span>entity <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #990000">?</span>name<span style="color: #990000">]</span>
            <span style="color: #990000">[?</span>entity <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #990000">?</span>email<span style="color: #990000">]]</span>
          db
          name<span style="color: #990000">)</span>
       ffirst<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(users</span></span><span style="color: #990000">-</span>email db<span style="color: #990000">-</span>after <span style="color: #FF0000">"Fred Flintstone"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "twinkletoes@example.com"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(users</span></span><span style="color: #990000">-</span>email <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span> <span style="color: #FF0000">"Fred Flintstone"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you can see, the current database remains unaffected by this
transaction, but the database at <span class="monospaced">db-after</span> now displays the new
value.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_128">Discussion</h4>
<div class="paragraph"><p>Databases produced by <span class="monospaced">d/with</span> can be used with any of the other API
functions that accept a database, including <span class="monospaced">d/with</span> itself. This
means that you can layer multiple transactions on top of one another
without first having to commit them to the transactor!</p></div>
<div class="paragraph"><p>One of the things that makes Datomic so powerful is its ability to
treat a database as a value. For this reason, the helper functions
we&#8217;ve written take a database as an argument, not a connection. Now
it is not only possible to query the current database, but other
values of the database as well.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_127">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_datomic_transact_basics">[sec_datomic_transact_basics]</a>, for more general information on
  transacting data
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_traversing_datomic_indexes">Traversing Datomic Indexes</h3>
<div class="paragraph byline"><p>by Alan Busby and Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_129">Problem</h4>
<div class="paragraph"><p>You want to execute simple Datomic queries with high performance.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_127">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">datomic.api/datoms</span> function to directly access the core
Datomic indexes in your database.</p></div>
<div class="paragraph"><p>To follow along with this recipe, first complete the recipes for <a href="#sec_datomic_connect_to_datomic">[sec_datomic_connect_to_datomic]</a>, and
<a href="#sec_datomic_schema">[sec_datomic_schema]</a>.</p></div>
<div class="paragraph"><p>For example, to quickly find the entities that have the provided attribute and
value set, invoke <span class="monospaced">datomic.api/datoms</span>, specifying the <span class="monospaced">:avet</span> index
(attribute, value, entity, transaction) and the desired attribute and
value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>datomic<span style="color: #990000">.</span>api <span style="color: #990000">:</span>as d<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span>
                   <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Barney Rubble"</span>
                   <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"barney@rubble.me"</span>}<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> entities<span style="color: #990000">-</span>with<span style="color: #990000">-</span>attr<span style="color: #990000">-</span>val
  <span style="color: #FF0000">"Return entities with a given attribute and value."</span>
  <span style="color: #990000">[</span>db attr val<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>datoms db <span style="color: #990000">:</span>avet attr val<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>e<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> d<span style="color: #990000">/</span>entity db<span style="color: #990000">))))</span>


<span style="font-weight: bold"><span style="color: #000000">(def</span></span> barney <span style="font-weight: bold"><span style="color: #000000">(first</span></span> <span style="font-weight: bold"><span style="color: #000000">(entities</span></span><span style="color: #990000">-</span>with<span style="color: #990000">-</span>attr<span style="color: #990000">-</span>val <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span>
                                           <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email
                                           <span style="color: #FF0000">"barney@rubble.me"</span><span style="color: #990000">)))</span>

<span style="color: #990000">(:</span>user<span style="color: #990000">/</span>email barney<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "barney@example.com"</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This will only work for attributes where <span class="monospaced">:db/index</span> is <span class="monospaced">true</span> or
<span class="monospaced">:db/unique</span> is not <span class="monospaced">nil</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To quickly determine all of the attributes an entity has, use the
<span class="monospaced">:eavt</span>-ordered index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> entities<span style="color: #990000">-</span>attrs
  <span style="color: #FF0000">"Return attrs of an entity"</span>
  <span style="color: #990000">[</span>db entity<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>datoms db <span style="color: #990000">:</span>eavt <span style="color: #990000">(:</span>db<span style="color: #990000">/</span>id entity<span style="color: #990000">))</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>a<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> d<span style="color: #990000">/</span>entity db<span style="color: #990000">))</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>db<span style="color: #990000">/</span>ident<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(entities</span></span><span style="color: #990000">-</span>attrs <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span> barney<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (:user/email :user/name)</span></span></tt></pre></div></div>
<div class="paragraph"><p>To quickly find entities that refer, via <span class="monospaced">:db.type/ref</span>, to a provided
entity, use the <span class="monospaced">:vaet</span>-ordered index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Add a person that refers to a :user.roles/author role</span></span>
<span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>transact conn <span style="color: #990000">[</span>{<span style="color: #990000">:</span>db<span style="color: #990000">/</span>id <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>tempid <span style="color: #990000">:</span>db<span style="color: #990000">.</span>part<span style="color: #990000">/</span>user<span style="color: #990000">)</span>
                   <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="color: #FF0000">"Ryan Neufeld"</span>
                   <span style="color: #990000">:</span>user<span style="color: #990000">/</span>email <span style="color: #FF0000">"ryan@rkn.io"</span>
                   <span style="color: #990000">:</span>user<span style="color: #990000">/</span>roles <span style="color: #990000">[:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>editor<span style="color: #990000">]</span>}<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> referring<span style="color: #990000">-</span>to
  <span style="color: #FF0000">"Find all entities referring to an entity as a certain attribute."</span>
  <span style="color: #990000">[</span>db entity<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>datoms db <span style="color: #990000">:</span>vaet <span style="color: #990000">(:</span>db<span style="color: #990000">/</span>id entity<span style="color: #990000">)</span> <span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>e<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> d<span style="color: #990000">/</span>entity db<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> author<span style="color: #990000">-</span>entity <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>entity <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span> <span style="color: #990000">:</span>user<span style="color: #990000">.</span>roles<span style="color: #990000">/</span>author<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; The names of all users with a :user.roles/author role</span></span>
<span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">:</span>user<span style="color: #990000">/</span>name <span style="font-weight: bold"><span style="color: #000000">(referring</span></span><span style="color: #990000">-</span>to <span style="font-weight: bold"><span style="color: #000000">(d</span></span><span style="color: #990000">/</span>db conn<span style="color: #990000">)</span> author<span style="color: #990000">-</span>entity<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Ryan Neufeld")</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_129">Discussion</h4>
<div class="paragraph"><p>For simple lookup queries, like "find by attribute" or "find by
value", nothing beats Datomic&#8217;s raw indexes in terms of performance.
The <span class="monospaced">datomic.api/datoms</span> interface provides access to all of Datomic&#8217;s
indexes and conveniently lets you dive in any number of levels,
"biting off" only the data you need.</p></div>
<div class="paragraph"><p>As with most Datomic functions, <span class="monospaced">datoms</span> takes a <span class="monospaced">db</span> as its first
argument. You&#8217;ll note that in our examples, and elsewhere in the book, we
too accept a database as a value, and not a connection&#8212;this idiom
allows API users to perform varying numbers of operations on the same
database value. You should always try to do this yourself.</p></div>
<div class="paragraph"><p>The second argument to <span class="monospaced">datoms</span> indicates the particular index you want to access.
Each value is a permutation of the letters <span class="monospaced">e</span> (entity), <span class="monospaced">a</span> (attribute), <span class="monospaced">v</span> (value),
and <span class="monospaced">t</span> (transaction). The order of the letters in an index indicates how it
is indexed. For example, <span class="monospaced">:eavt</span> should be traversed by entity, then
attribute, and so on and so forth. The four indexes and what they
include are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:eavt</span>
</dt>
<dd>
<p>
An entity-first index that includes all datoms. This
  index provides a view over your database very much like a
  traditional relational database.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:aevt</span>
</dt>
<dd>
<p>
An attribute-then-entity index that includes all datoms. This
  index provides columnar access to your database, much like a data
  warehouse.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:avet</span>
</dt>
<dd>
<p>
An attribute-value index that only includes attributes
  where <span class="monospaced">:db/index</span> is <span class="monospaced">true</span>. Incredibly useful as a lookup index
  (e.g., "I need the entity with an email of <emphasis>foo@example.com</emphasis>&#8221;).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:vaet</span>
</dt>
<dd>
<p>
A value-first index that only includes <span class="monospaced">:db.type/ref</span>
  values. This is a very interesting index that can be used to treat your data
  a bit like a graph database.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>After specifying an index ordering, you can optionally provide any
number of components to pre-traverse the index. This serves to reduce
the number of elements returned. For example, specifying just an
attribute component for AVET traversal will return any entity with
that attribute. Specifying an attribute and a value component, on the
other hand, will return only entities with that specific attribute and
value pair.</p></div>
<div class="paragraph"><p>What is returned by <span class="monospaced">datoms</span> is a stream of <span class="monospaced">Datum</span> objects. Each
datum responds to <span class="monospaced">:a</span>, <span class="monospaced">:e</span>, <span class="monospaced">:t</span>, <span class="monospaced">:v</span>, and <span class="monospaced">:added</span> as functions.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_128">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_datomic_transact_basics">[sec_datomic_transact_basics]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_webapps">Web Applications</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_7">Introduction</h3>
<div class="paragraph"><p>Web application development is the breadwinner for many languages
nowadays; Clojure is no exception. In the annual
<a href="http://bit.ly/clojure-survey-2013">2013
State of Clojure Survey</a>, web development ranked first for the
question, "In which domains are you applying Clojure and/or
ClojureScript?"</p></div>
<div class="paragraph"><p>Much of the Clojure web development community today centers around
<a href="https://github.com/ring-clojure/ring">Ring</a>, an HTTP server library very
much akin to Ruby&#8217;s <a href="http://rack.github.io/">Rack</a>. Starting with the
introduction to Ring in <a href="#sec_webapps_ring_introduction">[sec_webapps_ring_introduction]</a>, you&#8217;ll find
a full complement of recipes here that will get you up to speed in no time.</p></div>
<div class="paragraph"><p>Following Ring, the chapter takes a tour of the other Clojure web
development ecosystems available at the time of writing, covering a few
templating and HTML-manipulation libraries and a number of alternative
web frameworks.</p></div>
</div>
<div class="sect2">
<h3 id="sec_webapps_ring_introduction">Introduction to Ring</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_130">Problem</h4>
<div class="paragraph"><p>You need to write an HTTP service with Clojure.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_128">Solution</h4>
<div class="paragraph"><p>Clojure has no built-in HTTP server, but the de facto standard for
serving basic, synchronous HTTP requests is the Ring library.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
    clojure<span style="color: #990000">.</span>pprint<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Echo (with pretty-print) the request received</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler <span style="color: #990000">[</span>request<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>status <span style="color: #993399">200</span>
   <span style="color: #990000">:</span>headers {<span style="color: #FF0000">"content-type"</span> <span style="color: #FF0000">"text/clojure"</span>}
   <span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(with</span></span><span style="color: #990000">-</span>out<span style="color: #990000">-</span>str <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>pprint<span style="color: #990000">/</span>pprint request<span style="color: #990000">))</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty handler {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_130">Discussion</h4>
<div class="paragraph"><p><a href="https://github.com/ring-clojure/ring">Ring</a> is the basis for most web
applications in Clojure. It provides a low-level and straightforward request/response API, where requests and responses are plain old Clojure maps.</p></div>
<div class="paragraph"><p>Ring applications are architected around <em>handlers</em>: functions that accept
requests and return responses. The preceding example defines a single handler
that just echoes the response it receives.</p></div>
<div class="paragraph"><p>A basic response map consists of three keys: <span class="monospaced">:status</span>, the status code of
the response; <span class="monospaced">:headers</span>, an optional string-string map of the
response headers you want; and <span class="monospaced">:body</span>, the string you want as your
response body. Here, <span class="monospaced">:status</span> is <span class="monospaced">200</span> and <span class="monospaced">:body</span> is a pretty-printed
string of the request. Therefore, the following sample response from
hitting the URL <em>http://localhost:3000/test/path/?qs=1</em> on the author&#8217;s
machine demonstrates the structure of a request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>ssl<span style="color: #990000">-</span>client<span style="color: #990000">-</span>cert nil<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>remote<span style="color: #990000">-</span>addr <span style="color: #FF0000">"0:0:0:0:0:0:0:1"</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>scheme <span style="color: #990000">:</span>http<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>request<span style="color: #990000">-</span>method <span style="color: #990000">:</span>get<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>query<span style="color: #990000">-</span>string <span style="color: #FF0000">"qs=1"</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>content<span style="color: #990000">-</span>type nil<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>uri <span style="color: #FF0000">"/test/path/"</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>server<span style="color: #990000">-</span>name <span style="color: #FF0000">"localhost"</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>headers
 {<span style="color: #FF0000">"accept-encoding"</span> <span style="color: #FF0000">"gzip,deflate,sdch"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"connection"</span> <span style="color: #FF0000">"keep-alive"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"user-agent"</span>
  <span style="color: #FF0000">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36</span>
<span style="color: #FF0000">  (KHTML, like Gecko) Chrome/28.0.1500.71 Safari/537.36"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"accept-language"</span> <span style="color: #FF0000">"en-US,en;q=0.8"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"accept"</span>
  <span style="color: #FF0000">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"host"</span> <span style="color: #FF0000">"localhost:3000"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"cookie"</span> <span style="color: #FF0000">""</span>}<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>content<span style="color: #990000">-</span>length nil<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>server<span style="color: #990000">-</span>port <span style="color: #993399">3000</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>character<span style="color: #990000">-</span>encoding nil<span style="color: #990000">,</span>
 <span style="color: #990000">:</span>body #<span style="color: #990000">&lt;</span>HttpInput org<span style="color: #990000">.</span>eclipse<span style="color: #990000">.</span>jetty<span style="color: #990000">.</span>server<span style="color: #990000">.</span>HttpInput@43efe432<span style="color: #990000">&gt;</span>}</tt></pre></div></div>
<div class="paragraph"><p>You can see that this is comprehensive, but low level, with the
salient features of the request parsed into Clojure data structures
without additional abstraction. Typically, additional code or
libraries are used to extract meaningful information from this data
structure.</p></div>
<div class="paragraph"><p>The <span class="monospaced">jetty</span> adapter is used to run an embedded Jetty server. Ring also
comes with adapters to run as a servlet in any Java servlet container.</p></div>
<div class="paragraph"><p>Note that the call to <span class="monospaced">run-jetty</span> is synchronous and will not return
as long as the server is running. If you call it from the REPL, you
should wrap it in a future (or use some other concurrency mechanism)
so the server runs on another thread and your REPL does not become
unresponsive.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_129">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Ring&#8217;s <a href="https://github.com/ring-clojure/ring">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_ring_middleware">Using Ring Middleware</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_131">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to build a transformation to be automatically applied to Ring
requests or responses. For example, Ring gives you query strings, but
you&#8217;d really rather work with a parsed map.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_129">Solution</h4>
<div class="paragraph"><p>Since Ring works with regular Clojure data and functions, you can easily define
middlewares as functions returning functions. In this case, define a middleware that modifies
the request by adding a parsed version of the query string to the request
before passing it on to the handler.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
    <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>string <span style="color: #990000">:</span>as str<span style="color: #990000">]</span>
    clojure<span style="color: #990000">.</span>pprint<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> parse<span style="color: #990000">-</span>query<span style="color: #990000">-</span>string
  <span style="color: #FF0000">"Parse a query string to a hash-map"</span>
  <span style="color: #990000">[</span>qs<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="color: #990000">(&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> qs<span style="color: #990000">)</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; Don't operate on nils or empty strings</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> hash<span style="color: #990000">-</span>map <span style="font-weight: bold"><span style="color: #000000">(str</span></span><span style="color: #990000">/</span>split qs #<span style="color: #FF0000">"[&amp;=]"</span><span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> wrap<span style="color: #990000">-</span>query
  <span style="color: #FF0000">"Add a :query parameter to incoming requests that contains a parsed</span>
<span style="color: #FF0000">  version of the query string as a hash-map"</span>
  <span style="color: #990000">[</span>handler<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>parsed<span style="color: #990000">-</span>qs <span style="font-weight: bold"><span style="color: #000000">(parse</span></span><span style="color: #990000">-</span>query<span style="color: #990000">-</span>string <span style="color: #990000">(:</span>query<span style="color: #990000">-</span>string req<span style="color: #990000">))</span>
          new<span style="color: #990000">-</span>req <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> req <span style="color: #990000">:</span>query parsed<span style="color: #990000">-</span>qs<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(handler</span></span> new<span style="color: #990000">-</span>req<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>name <span style="font-weight: bold"><span style="color: #000000">(get</span></span> <span style="color: #990000">(:</span>query req<span style="color: #990000">)</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">)]</span>
    {<span style="color: #990000">:</span>status <span style="color: #993399">200</span>
     <span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Hello, "</span> <span style="font-weight: bold"><span style="color: #000000">(or</span></span> name <span style="color: #FF0000">"World"</span><span style="color: #990000">))</span>}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty <span style="font-weight: bold"><span style="color: #000000">(wrap</span></span><span style="color: #990000">-</span>query handler<span style="color: #990000">)</span> {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_131">Discussion</h4>
<div class="paragraph"><p>Since Ring handlers operate on regular Clojure maps, it&#8217;s very easy to write a middleware
that wraps a handler. Here, we write a middleware that modifies the request
before passing it to the handler. If the original request looked like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>query<span style="color: #990000">-</span>string <span style="color: #FF0000">"x=1&amp;y=2"</span>
 <span style="font-style: italic"><span style="color: #9A1900">; ... and the rest</span></span>
 }</tt></pre></div></div>
<div class="paragraph"><p>then the request received by the handler becomes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>query<span style="color: #990000">-</span>string <span style="color: #FF0000">"x=1&amp;y=2"</span>
 <span style="color: #990000">:</span>query {<span style="color: #FF0000">"x"</span> <span style="color: #FF0000">"1"</span> <span style="color: #FF0000">"y"</span> <span style="color: #FF0000">"2"</span>}
 <span style="font-style: italic"><span style="color: #9A1900">; ... and the rest</span></span>
 }</tt></pre></div></div>
<div class="paragraph"><p>However, you don&#8217;t need to write your own middleware for this. Ring provides
a number of middlewares to add to your apps, including one called <span class="monospaced">wrap-params</span> that
does the same as the middleware we just wrote, but better. From the <a href="http://bit.ly/clj-wrap-params">Ring documentation</a>:</p></div>
<?hard-pagebreak?>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p><strong>wrap-params</strong></p></div>
<div class="paragraph"><p>Middleware to parse urlencoded parameters from the query string and form
body (if the request is a urlencoded form). Adds the following keys to
the request map:</p></div>
<div class="paragraph"><p>:query-params - a map of parameters from the query string</p></div>
<div class="paragraph"><p>:form-params  - a map of parameters from the body</p></div>
<div class="paragraph"><p>:params       - a merged map of all types of parameter</p></div>
<div class="paragraph"><p>Takes an optional configuration map. Recognized keys are:</p></div>
<div class="paragraph"><p>:encoding - encoding to use for url-decoding. If not specified, uses the request character encoding, or "UTF-8" if no request character encoding is set.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>You are in no way limited to using one middleware.  Usually, you&#8217;ll at
least want to use the cookie, session, and parameter middleware.  One concise way to wrap your handler
with several middlewares is to use the <span class="monospaced">-&gt;</span> macro:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>session <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>session<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>cookies <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>cookies<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>params <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>params<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> wrapped<span style="color: #990000">-</span>handler
  <span style="color: #990000">(-&gt;</span> handler
    wrap<span style="color: #990000">-</span>cookies
    wrap<span style="color: #990000">-</span>params
    wrap<span style="color: #990000">-</span>session<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_130">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-middleware">middleware concepts documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_serving_static_files_with_ring">Serving Static Files with Ring</h3>
<div class="paragraph byline"><p>by Clinton Dreisbach</p></div>
<div class="sect3">
<h4 id="_problem_132">Problem</h4>
<div class="paragraph"><p>You want to serve static files through your Ring application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_130">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ring.middleware.file/wrap-file</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>file <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>file<span style="color: #990000">]])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Serve all files from your public directory</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> app
  <span style="font-weight: bold"><span style="color: #000000">(wrap</span></span><span style="color: #990000">-</span>file handler <span style="color: #FF0000">"/var/webapps/public"</span><span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_132">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">wrap-file</span> wraps another web request handler so that you will serve a static file if one exists in the specified directory, and call the handler if the requested file does not exist.</p></div>
<div class="paragraph"><p><span class="monospaced">wrap-file</span> is only one way to serve static files. If you only want to serve up a particular file, <span class="monospaced">ring.util.response/file-response</span> will return a handler that serves up that file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>util<span style="color: #990000">.</span>response <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>file<span style="color: #990000">-</span>response<span style="color: #990000">]])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Serve README.html</span></span>
<span style="font-weight: bold"><span style="color: #000000">(file</span></span><span style="color: #990000">-</span>response <span style="color: #FF0000">"README.html"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Serve README.html from the public/ directory</span></span>
<span style="font-weight: bold"><span style="color: #000000">(file</span></span><span style="color: #990000">-</span>response <span style="color: #FF0000">"README.html"</span> {<span style="color: #990000">:</span>root <span style="color: #FF0000">"public"</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Serve README.html through a symlink</span></span>
<span style="font-weight: bold"><span style="color: #000000">(file</span></span><span style="color: #990000">-</span>response <span style="color: #FF0000">"README.html"</span> {<span style="color: #990000">:</span>allow<span style="color: #990000">-</span>symlinks<span style="color: #990000">?</span> true}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Often, you will want to bundle your static files with your application. In that case, it makes more sense to serve files from your classpath rather than from a specific directory. For this, use <span class="monospaced">ring.middleware.resource/wrap-resource</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>resource <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>resource<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> app
  <span style="font-weight: bold"><span style="color: #000000">(wrap</span></span><span style="color: #990000">-</span>resource handler <span style="color: #FF0000">"static"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>This will serve all files under a directory called <em>static</em> in your classpath. You can put the <em>static</em> directory under <em>resources/</em> in a Leiningen project and have your static files packaged with JAR files you generate from that project.</p></div>
<div class="paragraph"><p>You may want to wrap any file responses with <span class="monospaced">ring.middleware.file-info/wrap-file-info</span>. This Ring middleware checks the modification date and the type of the file, setting the <span class="monospaced">Content-Type</span> and <span class="monospaced">Last-Modified</span> headers. <span class="monospaced">wrap-file-info</span> needs to wrap around <span class="monospaced">wrap-file</span> or <span class="monospaced">wrap-resource</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_131">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_local_io_get_local_resource">[sec_local_io_get_local_resource]</a>
</p>
</li>
<li>
<p>
<a href="#sec_webapps_compojure_compojure">[sec_webapps_compojure_compojure]</a>
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="_handling_form_data_with_ring">Handling Form Data with Ring</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_133">Problem</h4>
<div class="paragraph"><p>You want your app to accept user input using an HTML form.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_131">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ring.middleware.params/wrap-params</span> to add incoming HTTP form parameters to incoming request maps.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>params <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>params<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> greeting<span style="color: #990000">-</span>form
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span>
    <span style="color: #FF0000">"&lt;html&gt;"</span>
    <span style="color: #FF0000">"  &lt;form action='' method='post'&gt;"</span>
    <span style="color: #FF0000">"    Enter your name: &lt;input type='text' name='name'&gt;&lt;br/&gt;"</span>
    <span style="color: #FF0000">"    &lt;input type='submit' value='Say Hello'&gt;"</span>
    <span style="color: #FF0000">"  &lt;/form&gt;"</span>
    <span style="color: #FF0000">"&lt;/html&gt;"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>form <span style="color: #990000">[]</span>
  {<span style="color: #990000">:</span>body greeting<span style="color: #990000">-</span>form
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span> }<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>name
  <span style="color: #FF0000">"A response showing that we know the user's name"</span>
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Hello, "</span> name<span style="color: #990000">)</span>
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler
  <span style="color: #FF0000">"Show a form requesting the user's name, or greet them if they</span>
<span style="color: #FF0000">  submitted the form"</span>
  <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>name <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in req <span style="color: #990000">[:</span>form<span style="color: #990000">-</span>params <span style="color: #FF0000">"name"</span><span style="color: #990000">])]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> name
      <span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">-</span>name name<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">-</span>form<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty <span style="font-weight: bold"><span style="color: #000000">(wrap</span></span><span style="color: #990000">-</span>params handler<span style="color: #990000">)</span> {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_133">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">wrap-params</span> is a Ring middleware that handles the retrieval of query string
and form parameters from raw requests. It adds three keys to the request:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">:query-params</span>
</dt>
<dd>
<p>
Contains a map of the parsed query string parameters
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:form-params</span>
</dt>
<dd>
<p>
Contains a map of form body parameters
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">:params</span>
</dt>
<dd>
<p>
Contains the contents of both <span class="monospaced">:query-params</span> and <span class="monospaced">:form-params</span> merged together
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In the preceding example we used <span class="monospaced">:form-params</span>, so our handler will
only respond with a greeting on POST requests containing form-encoded
parameters. If we had used <span class="monospaced">:params</span>, we would have had the option of
also passing a URL query string with a <span class="monospaced">"name"</span> parameter. <span class="monospaced">:params</span>
works with any kind of parameter (form- or URL-encoded). <span class="monospaced">:form-params</span>
only works for form parameters.</p></div>
<div class="paragraph"><p>Note that the form keys are passed in as strings, not keywords.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_132">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_ring_middleware">[sec_ring_middleware]</a>
</p>
</li>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-parameters">parameters documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_cookies_with_ring">Handling Cookies with Ring</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_134">Problem</h4>
<div class="paragraph"><p>Your web application needs to read or set cookies on the user&#8217;s browser (for example, to remember a user&#8217;s name).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_132">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">ring.middleware.cookies/wrap-cookies</span> middleware to add cookies to your requests.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>cookies <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>cookies<span style="color: #990000">]]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>params <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>params<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> set<span style="color: #990000">-</span>name<span style="color: #990000">-</span>form
  <span style="color: #FF0000">"A response showing a form for the user to enter their name."</span>
  <span style="color: #990000">[]</span>
  {<span style="color: #990000">:</span>body <span style="color: #FF0000">"&lt;html&gt;</span>
<span style="color: #FF0000">            &lt;form action=''&gt;</span>
<span style="color: #FF0000">              Name: &lt;input type='text' name='name'&gt;</span>
<span style="color: #FF0000">              &lt;input type='submit'&gt;</span>
<span style="color: #FF0000">            &lt;/form&gt;</span>
<span style="color: #FF0000">          &lt;/html&gt;"</span>
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span>
   <span style="color: #990000">:</span>content<span style="color: #990000">-</span>type <span style="color: #FF0000">"text/html"</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>name
  <span style="color: #FF0000">"A response showing that we know the user's name"</span>
  <span style="color: #990000">[</span>name<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Hello, "</span> name<span style="color: #990000">)</span>
   <span style="color: #990000">:</span>cookies {<span style="color: #FF0000">"name"</span> {<span style="color: #990000">:</span>value name}} <span style="font-style: italic"><span style="color: #9A1900">; Preserve the cookies</span></span>
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span> }<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler
  <span style="color: #FF0000">"If we know the user's name, show it; else, show a form to get it."</span>
  <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>name <span style="font-weight: bold"><span style="color: #000000">(or</span></span>
              <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in req <span style="color: #990000">[:</span>cookies <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span>value<span style="color: #990000">])</span>
              <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in req <span style="color: #990000">[:</span>params <span style="color: #FF0000">"name"</span><span style="color: #990000">]))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> name
      <span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">-</span>name name<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">-</span>name<span style="color: #990000">-</span>form<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> wrapped<span style="color: #990000">-</span>handler
  <span style="color: #990000">(-&gt;</span> handler
      wrap<span style="color: #990000">-</span>cookies
      wrap<span style="color: #990000">-</span>params<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty wrapped<span style="color: #990000">-</span>handler {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_134">Discussion</h4>
<div class="paragraph"><p>This example uses the <span class="monospaced">wrap-cookies</span> and <span class="monospaced">wrap-params</span> middlewares
included with <span class="monospaced">ring-core</span>. The first time users visit a page, it
shows them a form to enter their names. Once entered, it stores the user&#8217;s name in a cookie and displays it instead, until the cookie is removed.</p></div>
<div class="paragraph"><p>The example uses <span class="monospaced">wrap-cookies</span> to retrieve the user&#8217;s stored name
from the cookie map, or, if it&#8217;s not there, <span class="monospaced">wrap-params</span> to retrieve
the user&#8217;s name from the request parameters.</p></div>
<div class="paragraph"><p>Ring&#8217;s cookie middleware simply adds an extra parameter, <span class="monospaced">:cookies</span>,
onto the incoming request map, and sets any cookies you pass out as the
<span class="monospaced">:cookies</span> parameter on the response. The <span class="monospaced">:cookies</span> parameter is a
map that looks something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #FF0000">"name"</span> {<span style="color: #990000">:</span>value <span style="color: #FF0000">"Some Guy"</span>}}</tt></pre></div></div>
<div class="paragraph"><p>You can add other optional parameters to each cookie, along with <span class="monospaced">:value</span>. From the
<a href="http://bit.ly/ring-cookies">Ring cookie documentation</a>:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>As well as setting the value of the cookie, you can also set additional attributes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">:domain</span>&#x2014;restrict the cookie to a specific domain
</p>
</li>
<li>
<p>
<span class="monospaced">:path</span>&#x2014;restrict the cookie to a specific path
</p>
</li>
<li>
<p>
<span class="monospaced">:secure</span>&#x2014;restrict the cookie to HTTPS URLs if true
</p>
</li>
<li>
<p>
<span class="monospaced">:http-only</span>&#x2014;restrict the cookie to HTTP if true (not accessible via e.g. JavaScript)
</p>
</li>
<li>
<p>
<span class="monospaced">:max-age</span>&#x2014;the number of seconds until the cookie expires
</p>
</li>
<li>
<p>
<span class="monospaced">:expires</span>&#x2014;a specific date and time the cookie expires
</p>
</li>
</ul></div>
</div>
<div class="attribution">
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_133">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_ring_middleware">[sec_ring_middleware]</a>
</p>
</li>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-cookies">cookies documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_storing_sessions_with_ring">Storing Sessions with Ring</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_135">Problem</h4>
<div class="paragraph"><p>You need to store secure data about a logged-in user as state on the
server.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_133">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ring.middleware.session/wrap-session</span> to add sessions to your
Ring application.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>session <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>session<span style="color: #990000">]]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>middleware<span style="color: #990000">.</span>params <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>wrap<span style="color: #990000">-</span>params<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> login<span style="color: #990000">-</span>form
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span>
    <span style="color: #FF0000">"&lt;html&gt;"</span>
    <span style="color: #FF0000">"  &lt;form action='' method='post'&gt;"</span>
    <span style="color: #FF0000">"    Username: &lt;input type='text' name='username'&gt;&lt;br/&gt;"</span>
    <span style="color: #FF0000">"    Password: &lt;input type='text' name='password'&gt;&lt;br/&gt;"</span>
    <span style="color: #FF0000">"    &lt;input type='submit' value='Log In'&gt;"</span>
    <span style="color: #FF0000">"  &lt;/form&gt;"</span>
    <span style="color: #FF0000">"&lt;/html&gt;"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>form <span style="color: #990000">[]</span>
  {<span style="color: #990000">:</span>body login<span style="color: #990000">-</span>form
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span> }<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> show<span style="color: #990000">-</span>name
  <span style="color: #FF0000">"A response showing that we know the user's name"</span>
  <span style="color: #990000">[</span>name session<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Hello, "</span> name<span style="color: #990000">)</span>
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span>
   <span style="color: #990000">:</span>session session }<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> do<span style="color: #990000">-</span>login
  <span style="color: #FF0000">"Check the submitted form data and update the session if necessary"</span>
  <span style="color: #990000">[</span>params session<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(and</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(params</span></span> <span style="color: #FF0000">"username"</span><span style="color: #990000">)</span> <span style="color: #FF0000">"jim"</span><span style="color: #990000">)</span>
           <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(params</span></span> <span style="color: #FF0000">"password"</span><span style="color: #990000">)</span> <span style="color: #FF0000">"password"</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(assoc</span></span> session <span style="color: #990000">:</span>user <span style="color: #FF0000">"jim"</span><span style="color: #990000">)</span>
    session<span style="color: #990000">))</span>


<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler
  <span style="color: #FF0000">"Log a user in, or not"</span>
  <span style="color: #990000">[</span>{session <span style="color: #990000">:</span>session params <span style="color: #990000">:</span>form<span style="color: #990000">-</span>params <span style="color: #990000">:</span>as req}<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>session <span style="font-weight: bold"><span style="color: #000000">(do</span></span><span style="color: #990000">-</span>login params session<span style="color: #990000">)</span>
        username <span style="color: #990000">(:</span>user session<span style="color: #990000">)]</span>

    <span style="font-weight: bold"><span style="color: #000000">(if</span></span> username
      <span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">-</span>name username session<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(show</span></span><span style="color: #990000">-</span>form<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> wrapped<span style="color: #990000">-</span>handler
  <span style="color: #990000">(-&gt;</span> handler
      wrap<span style="color: #990000">-</span>session
      wrap<span style="color: #990000">-</span>params<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty wrapped<span style="color: #990000">-</span>handler {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_135">Discussion</h4>
<div class="paragraph"><p><a href="http://bit.ly/ring-sessions">Ring&#8217;s session
middleware</a> has an API similar to the cookies API. You get session data from the
<span class="monospaced">:session</span> request map, and set it by including a <span class="monospaced">:session</span> key in
the response map. Whatever you pass to <span class="monospaced">:session</span> is up to you, but
usually you&#8217;ll want to use a map to store keys and values.</p></div>
<div class="paragraph"><p>Behind the scenes, Ring sets a cookie called <span class="monospaced">ring-session</span>, which contains a unique
ID identifying the session. When a request comes in, the session middleware gets the
session ID from the request, then reads the value of the session from some session store.</p></div>
<div class="paragraph"><p>Which session store the middleware uses is configurable. The default
is to use an in-memory session store, which is useful for development
but has the side effect of losing sessions whenever you restart the
app. Ring includes an encrypted cookie store as well, which <em>is</em>
persistent, and you can get third-party libraries for many popular
storages, including
<a href="http://bit.ly/ring-session-memcached">Memcached</a> and
<a href="https://github.com/wuzhe/clj-redis-session">Redis</a>. You can write your
own, too, to store your sessions in any database.</p></div>
<div class="paragraph"><p>You can set your store by passing an options map with a <span class="monospaced">:store</span>
parameter to <span class="monospaced">wrap-session</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(wrap</span></span><span style="color: #990000">-</span>session handler {<span style="color: #990000">:</span>store <span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>store<span style="color: #990000">)</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>To set the value of <span class="monospaced">:session</span>, just pass it along with your response. If you don&#8217;t
need the session changed,  leave <span class="monospaced">:session</span> out of your response. If you want to actually clear the
session, pass <span class="monospaced">nil</span> as the value of the <span class="monospaced">:session</span> key.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_134">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_ring_middleware">[sec_ring_middleware]</a>
</p>
</li>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-sessions">sessions documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_and_writing_request_and_response_headers_in_ring">Reading and Writing Request and Response Headers in Ring</h3>
<div class="paragraph byline"><p>by Luke VanderHart and Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_136">Problem</h4>
<div class="paragraph"><p>You need to read or write HTTP request or response headers.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_134">Solution</h4>
<div class="paragraph"><p>Read from the <span class="monospaced">:headers</span> key in a Ring request map, or <span class="monospaced">assoc</span> values
onto the response map before returning from a Ring handler function.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> user<span style="color: #990000">-</span>agent<span style="color: #990000">-</span>as<span style="color: #990000">-</span>json
  <span style="color: #FF0000">"A handler that returns the User-Agent header as a JSON</span>
<span style="color: #FF0000">   response with an appropriate Content-Type"</span>
  <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>body <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"{</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">user-agent</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span> <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in req <span style="color: #990000">[:</span>headers <span style="color: #FF0000">"user-agent"</span><span style="color: #990000">])</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">}"</span><span style="color: #990000">)</span>
   <span style="color: #990000">:</span>headers {<span style="color: #FF0000">"Content-Type"</span> <span style="color: #FF0000">"application/json"</span>}
   <span style="color: #990000">:</span>status <span style="color: #993399">200</span>}<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty user<span style="color: #990000">-</span>agent<span style="color: #990000">-</span>as<span style="color: #990000">-</span>json {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_136">Discussion</h4>
<div class="paragraph"><p>This example defines a Ring handler that returns the incoming
<span class="monospaced">User-Agent</span> header as a JSON response. It gets the <span class="monospaced">User-Agent</span> from
the request header map, and uses a <span class="monospaced">Content-Type</span> header in the response
to indicate to the client that it should be parsed as JSON.</p></div>
<div class="paragraph"><p>Ring passes request headers as a <span class="monospaced">:headers</span> parameter in the request
map, and accepts a <span class="monospaced">:headers</span> parameter in response maps as well. The
keys and values of the headers map should both be strings. Clojure
keywords are not supported.</p></div>
<div class="paragraph"><p>You can use Ring to set any header that is
<a href="http://bit.ly/http-header-fields">valid in
HTTP</a>.</p></div>
<div class="paragraph"><p>According to <a href="http://bit.ly/rfc2616">RFC-2616</a>, header
names are <em>not</em> case sensitive. To make it easier to consistently
<span class="monospaced">get</span> values from the request map, no matter what their case, Ring
passes in all header values as lowercase, regardless of what the
client sent. You may wish to <em>send</em> headers using the actual
capitalization used in the specification, though, just in case the
client you&#8217;re communicating with is not compliant (following the
classic robustness principle: "Be conservative in what you send; be
liberal in what you accept").</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_135">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-concepts">concepts documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_webapps_compojure_compojure">Routing Requests with Compojure</h3>
<div class="paragraph byline"><p>by Adam Bard</p></div>
<div class="sect3">
<h4 id="_problem_137">Problem</h4>
<div class="paragraph"><p>You want an easy way to route URLs to specific Ring handler functions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_135">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/weavejester/compojure">Compojure library</a> to add routing to your app.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
    <span style="color: #990000">[</span>compojure<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>defroutes GET<span style="color: #990000">]]</span>
    <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; View functions</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> view <span style="color: #990000">[</span>x<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"&lt;h1&gt;"</span> x <span style="color: #FF0000">"&lt;/h1&gt;"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> index <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(view</span></span> <span style="color: #FF0000">"Hello"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> index<span style="color: #990000">-</span>fr <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(view</span></span> <span style="color: #FF0000">"Bonjour"</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Routing</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defroutes</span></span> main<span style="color: #990000">-</span>routes
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/"</span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(index</span></span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/en/"</span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(index</span></span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/fr/"</span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">(index</span></span><span style="color: #990000">-</span>fr<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/:greeting/"</span> <span style="color: #990000">[</span>greeting<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(view</span></span> greeting<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Server</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
 <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty main<span style="color: #990000">-</span>routes {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_137">Discussion</h4>
<div class="paragraph"><p>Compojure is a routing library that lets you define routes for your app.
It does this via the <span class="monospaced">defroutes</span> macro, which produces a Ring handler function.</p></div>
<div class="paragraph"><p>Here, we define four routes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">/</span>
</dt>
<dd>
<p>
Displays "Hello"
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/en/</span>
</dt>
<dd>
<p>
Also displays "Hello"
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/fr/</span>
</dt>
<dd>
<p>
Displays "Bonjour"
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/:greeting/</span>
</dt>
<dd>
<p>
Echoes the greeting passed by the user
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The last view is an example of Compojure&#8217;s URL parameter syntax. The section
of the URL identified by <span class="monospaced">:greeting</span> is passed along to the view, which displays
it for the user. So, visiting <em>http://localhost:3000/Buenos%20Dias/</em> displays
"Buenos Dias" in response.</p></div>
<div class="paragraph"><p>One caveat to be aware of is that Compojure routes are sensitive to a
trailing slash: a route defined as <span class="monospaced">/users/:user/blog/</span> will not match
the URL <em>http://mysite.com/users/fred/blog</em>, but it <em>will</em> match
<em>http://mysite.com/users/fred/blog/</em>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">[]</span> in each route is actually syntactic sugar for intercepting these
parameters. You can also use <span class="monospaced">req</span> or any other symbol to get the whole request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defroutes</span></span> main<span style="color: #990000">-</span>routes<span style="color: #990000">-</span><span style="color: #993399">2</span>
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/"</span> req <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>view req<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>You can even use Clojure&#8217;s destructuring syntax<span class="footnote"><br>[If you&#8217;re
not familiar with Clojure&#8217;s destructuring syntax, we suggest reading Jay
Fields&#8217;s
<a href="http://bit.ly/destructuring">"Clojure:
Destructuring" blog post</a>. For a more extensive resource, pick up a
copy of <a href="http://www.clojurebook.com/"><em>Clojure Programming</em></a> (O&#8217;Reilly) by Chas Emerick, Brian Carper, and Christophe Grand, which covers
destructuring in depth.]<br></span> to extract parts of the request. For example,
if you&#8217;re using the <span class="monospaced">wrap-params</span> middleware, you can grab the parameters
and pass them to a function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defroutes</span></span> main<span style="color: #990000">-</span>routes<span style="color: #990000">-</span><span style="color: #993399">2</span>
  <span style="font-weight: bold"><span style="color: #000000">(GET</span></span> <span style="color: #FF0000">"/"</span> {params <span style="color: #990000">:</span>params} <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>other<span style="color: #990000">-</span>view params<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>It is important to realize that Compojure works on top of Ring. Your views
should still return Ring response maps (although Compojure will wrap strings
you return with a basic 200 response).</p></div>
<div class="paragraph"><p>You can also define routes for other types of HTTP requests by
specifying the route using the relevant Compojure directive:
<span class="monospaced">compojure.core/POST</span> and <span class="monospaced">compojure.core/PUT</span> are most commonly used,
in addition to <span class="monospaced">compojure.core/GET</span>.</p></div>
<div class="paragraph"><p>Compojure provides a few other helpful tools, such as
<a href="http://bit.ly/compojure-route"><span class="monospaced">compojure.route</span></a>,
which provides helpers for serving resources, files, and 404 responses; and
<a href="http://bit.ly/compojure-handler"><span class="monospaced">compojure.handler</span></a>,
which bundles a number of Ring middlewares into one convenient wrapper.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_136">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://compojure.org">Compojure website</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_performing_http_redirects_with_ring">Performing HTTP Redirects with Ring</h3>
<div class="paragraph byline"><p>by Craig McDaniel</p></div>
<div class="sect3">
<h4 id="_problem_138">Problem</h4>
<div class="paragraph"><p>In a Ring application, you need to return an HTTP response code that will redirect the browser to another URL.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_136">Solution</h4>
<div class="paragraph"><p>To redirect a Ring request, use the <span class="monospaced">redirect</span> function in the <span class="monospaced">ring.util.response</span> namespace.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the <a href="https://github.com/clojure-cookbook/ringtest">https://github.com/clojure-cookbook/ringtest</a> repository and overwrite <em>src/ringtest.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> ringtest
  <span style="color: #990000">(:</span>require
   <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
   <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>util<span style="color: #990000">.</span>response <span style="color: #990000">:</span>as response<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> redirect<span style="color: #990000">-</span>to<span style="color: #990000">-</span>github
  <span style="color: #FF0000">"A handler that redirects all requests"</span>
  <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(response</span></span><span style="color: #990000">/</span>redirect <span style="color: #FF0000">"http://github.com/"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; Run the server on port 3000</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty redirect<span style="color: #990000">-</span>to<span style="color: #990000">-</span>github {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_138">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">ring.util.response</span> namespace contains a function for redirecting to a URL. This URL can be generated dynamically from the request map (using parameters from <span class="monospaced">wrap-params</span>, headers, etc.). Underneath, this function simply creates a response map with a 302 <span class="monospaced">:status</span> value and a location header containing the URL to redirect to.</p></div>
<div class="paragraph"><p>According to the HTTP specification, if the response method is a POST, PUT, or DELETE, it should be assumed that the server received the request, and the client should issue a GET request to the URL in the location header. This is an important caveat when writing REST services. Fortunately, the specification provides a 307 status code, which should signal to clients that the request should be redirected to the new location using the original method and body. To do this, simply return a response map in the handler function like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> redirect<span style="color: #990000">-</span>to<span style="color: #990000">-</span>github
  <span style="color: #990000">[</span>req<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>status <span style="color: #993399">307</span>
   <span style="color: #990000">:</span>headers {<span style="color: #FF0000">"Location"</span> <span style="color: #FF0000">"http://github.com"</span>}
   <span style="color: #990000">:</span>body <span style="color: #FF0000">""</span>}<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_137">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Ring&#8217;s <a href="http://bit.ly/ring-concepts">concepts documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_restful_application_with_liberator">Building a RESTful Application with Liberator</h3>
<div class="paragraph byline"><p>by Eric Normand</p></div>
<div class="sect3">
<h4 id="_problem_139">Problem</h4>
<div class="paragraph"><p>You want to build a RESTful (RFC 2616&#x2013;compliant) web application on top of Ring and
Compojure at a higher level of abstraction, by defining resources.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_137">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/clojure-liberator/liberator">Liberator</a> to
create HTTP-compliant, RESTful web apps.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a new project using the command <strong><span class="monospaced">lein new app liberator-test</span></strong>.</p></div>
<div class="paragraph"><p>Inside your <em>project.clj</em>, add the following dependencies to your <span class="monospaced">:dependencies</span> key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span>compojure <span style="color: #FF0000">"1.0.2"</span><span style="color: #990000">]</span>
<span style="color: #990000">[</span>ring<span style="color: #990000">/</span>ring<span style="color: #990000">-</span>jetty<span style="color: #990000">-</span>adapter <span style="color: #FF0000">"1.1.0"</span><span style="color: #990000">]</span>
<span style="color: #990000">[</span>liberator <span style="color: #FF0000">"0.9.0"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Then, modify <em>src/liberator_test/core.clj</em> to match the following contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> liberator<span style="color: #990000">-</span>test<span style="color: #990000">.</span>core
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>compojure<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>defroutes ANY<span style="color: #990000">]]</span>
            <span style="color: #990000">[</span>ring<span style="color: #990000">.</span>adapter<span style="color: #990000">.</span>jetty <span style="color: #990000">:</span>as jetty<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>liberator<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>defresource<span style="color: #990000">]]))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Resources</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defresource</span></span> root
   <span style="color: #990000">:</span>available<span style="color: #990000">-</span>media<span style="color: #990000">-</span>types #{<span style="color: #FF0000">"text/plain"</span>}<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Routing</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defroutes</span></span> main<span style="color: #990000">-</span>routes
  <span style="font-weight: bold"><span style="color: #000000">(ANY</span></span> <span style="color: #FF0000">"/"</span> <span style="color: #990000">[]</span> root<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Server</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[]</span>
 <span style="font-weight: bold"><span style="color: #000000">(jetty</span></span><span style="color: #990000">/</span>run<span style="color: #990000">-</span>jetty main<span style="color: #990000">-</span>routes {<span style="color: #990000">:</span>port <span style="color: #993399">3000</span>}<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_139">Discussion</h4>
<div class="paragraph"><p><a href="https://github.com/clojure-liberator/liberator">Liberator</a> is a library
for developing HTTP-compliant web servers. It handles content
negotiation, status codes, and standard request methods on RESTful
resources. It decides what status to respond with using a decision tree,
which follows the HTTP spec.</p></div>
<div class="paragraph"><p>Liberator does not handle routing, so another library needs to be
used. In this recipe, Compojure was used. Since Liberator does a
better job of handling the request method (GET, PUT, POST, etc.), you
should use <span class="monospaced">ANY</span> in your Compojure routes. You could also use a
different routing library, such as
<a href="https://github.com/weavejester/clout">Clout</a>,
<a href="https://github.com/cgrand/moustache">Moustache</a>, or the
<a href="https://github.com/ericnormand/playnice">playnice</a> router.</p></div>
<div class="paragraph"><p>The <span class="monospaced">defresource</span> form defines a web resource, which is modeled as a
Ring handler. You can therefore pass the resource as the last argument
to Compojure routes.</p></div>
<div class="paragraph"><p>Liberator resources are set up with sensible defaults. The default for
the available media types is the empty set, so it needs to be set to
something; otherwise, Liberator will return a 406 "Not Acceptable"
response. In this recipe it is set to respond with <span class="monospaced">text/plain</span> as the
MIME type. The default response is "OK," which you will see if you run
the recipe and point a browser at <em>http://localhost:3000</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_138">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_webapps_ring_introduction">[sec_webapps_ring_introduction]</a>, for information on setting up
  Ring
</p>
</li>
<li>
<p>
<a href="#sec_webapps_compojure_compojure">[sec_webapps_compojure_compojure]</a>, for more information on
  Compojure routes
</p>
</li>
<li>
<p>
Liberator&#8217;s <a href="http://bit.ly/clj-liberator">home page</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_enlive">Templating HTML with Enlive</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_140">Problem</h4>
<div class="paragraph"><p>You want to create HTML dynamically based on a template, without using
traditional mixed code or DSL-style templating.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_138">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/cgrand/enlive">Enlive</a>, a Clojure library that takes a selector-based approach to
templating HTML. Unlike other template frameworks like PHP, ERB, and JSP, it doesn&#8217;t mix code and text. And unlike systems like Haml or
Hiccup, it doesn&#8217;t use specialized DSLs. Instead, templates are plain
old HTML files, and Enlive uses Clojure code to target specific areas
for replacement or duplication based on incoming data.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try enlive</tt></pre></div></div>
<div class="paragraph"><p>To begin, create a file <em>post.html</em> to serve as an Enlive template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;&lt;title&gt;</span></span>Page Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Page Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>By <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"author"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Mickey Mouse<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"post-body"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      Lorem ipsum etc...
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Place this file in the <em>resources/</em> directory, if you&#8217;re using Enlive in the context of a project.</td>
</tr></table>
</div>
<div class="paragraph"><p>The following Clojure code defines an Enlive template based on the contents of <em>post.html</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>net<span style="color: #990000">.</span>cgrand<span style="color: #990000">.</span>enlive<span style="color: #990000">-</span>html <span style="color: #990000">:</span>as html<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Define the template</span></span>
<span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>deftemplate post<span style="color: #990000">-</span>page <span style="color: #FF0000">"post.html"</span>
  <span style="color: #990000">[</span>post<span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>title<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>title post<span style="color: #990000">))</span>
  <span style="color: #990000">[:</span>h1<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>title post<span style="color: #990000">))</span>
  <span style="color: #990000">[:</span>span<span style="color: #990000">.</span>author<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>author post<span style="color: #990000">))</span>
  <span style="color: #990000">[:</span>div<span style="color: #990000">.</span>post<span style="color: #990000">-</span>body<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>body post<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Some sample data</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> sample<span style="color: #990000">-</span>post {<span style="color: #990000">:</span>author <span style="color: #FF0000">"Luke VanderHart"</span>
                  <span style="color: #990000">:</span>title <span style="color: #FF0000">"Why Clojure Rocks"</span>
                  <span style="color: #990000">:</span>body <span style="color: #FF0000">"Functional programming!"</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To apply the template to the data, invoke the function defined by
<span class="monospaced">deftemplate</span>. Since it returns a sequence of strings, in most
applications you&#8217;ll probably want to concatenate the results into a
single string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> str <span style="font-weight: bold"><span style="color: #000000">(post</span></span><span style="color: #990000">-</span>page sample<span style="color: #990000">-</span>post<span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Here&#8217;s the formatted output:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;&lt;title&gt;</span></span>Why Clojure Rocks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Why Clojure Rocks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>By <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"author"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Luke VanderHart<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"post-body"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Functional programming!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>See the following discussion section for a detailed explanation of the
<span class="monospaced">deftemplate</span> macro and what is actually happening in this code.</p></div>
<div class="sect4">
<h5 id="_repeating_elements">Repeating elements</h5>
<div class="paragraph"><p>The preceding code simply replaces the values of certain nodes in the
emitted HTML. In real scenarios, another common task is to <em>repeat</em>
certain items from input HTML, one repetition for each item in the
input data. For this task, Enlive provides <em>snippets</em>, which are selections
from an input HTML that can then be repeated as many times as desired
in the output of another template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> sample<span style="color: #990000">-</span>post<span style="color: #990000">-</span>list
  <span style="color: #990000">[</span>{<span style="color: #990000">:</span>author <span style="color: #FF0000">"Luke VanderHart"</span>
    <span style="color: #990000">:</span>title <span style="color: #FF0000">"Why Clojure Rocks"</span>
    <span style="color: #990000">:</span>body <span style="color: #FF0000">"Functional programming!"</span>}
   {<span style="color: #990000">:</span>author <span style="color: #FF0000">"Ryan Neufeld"</span>
    <span style="color: #990000">:</span>title <span style="color: #FF0000">"Clojure Community Management"</span>
    <span style="color: #990000">:</span>body <span style="color: #FF0000">"Programmers are like..."</span>}
   {<span style="color: #990000">:</span>author <span style="color: #FF0000">"Rich Hickey"</span>
    <span style="color: #990000">:</span>title <span style="color: #FF0000">"Programming"</span>
    <span style="color: #990000">:</span>body <span style="color: #FF0000">"You're doing it completely wrong."</span>}<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>defsnippet post<span style="color: #990000">-</span>snippet <span style="color: #FF0000">"post.html"</span>
  {<span style="color: #990000">[:</span>h1<span style="color: #990000">]</span> <span style="color: #990000">[[:</span>div<span style="color: #990000">.</span>post<span style="color: #990000">-</span>body <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>nth<span style="color: #990000">-</span>of<span style="color: #990000">-</span>type <span style="color: #993399">1</span><span style="color: #990000">)]]</span>}
  <span style="color: #990000">[</span>post<span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>h1<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>title post<span style="color: #990000">))</span>
  <span style="color: #990000">[:</span>span<span style="color: #990000">.</span>author<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>author post<span style="color: #990000">))</span>
  <span style="color: #990000">[:</span>div<span style="color: #990000">.</span>post<span style="color: #990000">-</span>body<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #990000">(:</span>body post<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>deftemplate all<span style="color: #990000">-</span>posts<span style="color: #990000">-</span>page <span style="color: #FF0000">"post.html"</span>
  <span style="color: #990000">[</span>post<span style="color: #990000">-</span>list<span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>title<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="color: #FF0000">"All Posts"</span><span style="color: #990000">)</span>
  <span style="color: #990000">[:</span>body<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>content <span style="font-weight: bold"><span style="color: #000000">(map</span></span> post<span style="color: #990000">-</span>snippet post<span style="color: #990000">-</span>list<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Invoking the defined <span class="monospaced">all-posts-page</span> function now returns an HTML
page populated with all three sample posts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> str <span style="font-weight: bold"><span style="color: #000000">(all</span></span><span style="color: #990000">-</span>posts<span style="color: #990000">-</span>page sample<span style="color: #990000">-</span>post<span style="color: #990000">-</span>list<span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Here&#8217;s the formatted output:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;&lt;title&gt;</span></span>All Posts<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Why Clojure Rocks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>By <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"author"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Luke VanderHart<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"post-body"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Functional programming!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Clojure Community Management<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>By <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"author"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Ryan Neufeld<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"post-body"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Programmers are like...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Programming<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>By <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"author"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Rich Hickey<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"post-body"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>You're doing it completely wrong.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In this example, the <span class="monospaced">defsnippet</span> macro defines a snippet over a range
of elements in the input HTML, from the <span class="monospaced">&lt;h1&gt;</span> element to the <span class="monospaced">&lt;div
class="post-body"&gt;</span>.</p></div>
<div class="paragraph"><p>Then, the <span class="monospaced">deftemplate</span> for <span class="monospaced">all-posts-page</span> uses the result of
mapping <span class="monospaced">post-snippet</span> over the content of the <span class="monospaced">body</span> element. Since
there are three posts in the sample input data, the snippet is
evaluated three times, and there are three posts output in the
resulting HTML.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_140">Discussion</h4>
<div class="paragraph"><p>Enlive can be slightly difficult to get the hang of, compared to some
other libraries. There are several contributing factors to
this:</p></div>
<div class="ulist"><ul>
<li>
<p>
It has a more novel conceptual approach than other templating systems
  (although it bears a lot of similarity to some other non-Clojure
  templating techniques, such as XSLT).
</p>
</li>
<li>
<p>
It utilizes functional programming techniques to the fullest,
  including liberal use of higher-order functions.
</p>
</li>
<li>
<p>
It&#8217;s a large library, capable of many things. The subset of features
  required to accomplish a particular task is not always evident.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In general, the best way to get past these issues and experience the
power and flexibility that Enlive can provide is to understand all the
different parts individually, and what they do. Then,
composing them into useful templating systems becomes more manageable.</p></div>
<div class="sect4">
<h5 id="_enlive_and_the_dom">Enlive and the DOM</h5>
<div class="paragraph"><p>First of all, it is important to understand that Enlive does not
operate on HTML text directly. Instead, it first parses the HTML into
a Clojure data structure representing the DOM (Document Object Model).
For example, the HTML fragment:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"foo"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"bar"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Hello!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>would be parsed into the Clojure data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>tag <span style="color: #990000">:</span>html<span style="color: #990000">,</span>
  <span style="color: #990000">:</span>attrs nil<span style="color: #990000">,</span>
  <span style="color: #990000">:</span>content
  <span style="color: #990000">(</span>{<span style="color: #990000">:</span>tag <span style="color: #990000">:</span>body<span style="color: #990000">,</span>
    <span style="color: #990000">:</span>attrs nil<span style="color: #990000">,</span>
    <span style="color: #990000">:</span>content
    <span style="color: #990000">(</span>{<span style="color: #990000">:</span>tag <span style="color: #990000">:</span>div<span style="color: #990000">,</span>
      <span style="color: #990000">:</span>attrs {<span style="color: #990000">:</span>id <span style="color: #FF0000">"foo"</span>}<span style="color: #990000">,</span>
      <span style="color: #990000">:</span>content
      <span style="color: #990000">(</span>{<span style="color: #990000">:</span>tag <span style="color: #990000">:</span>span<span style="color: #990000">,</span> <span style="color: #990000">:</span>attrs {<span style="color: #990000">:</span>id <span style="color: #FF0000">"bar"</span>}<span style="color: #990000">,</span> <span style="color: #990000">:</span>content <span style="color: #990000">(</span><span style="color: #FF0000">"Hello!"</span><span style="color: #990000">)</span>}<span style="color: #990000">)</span>}<span style="color: #990000">)</span>}<span style="color: #990000">)</span>}</tt></pre></div></div>
<div class="paragraph"><p>This is more verbose, but it is easier to manipulate from Clojure. You
won&#8217;t necessarily have to deal with these data structures directly,
but be aware that anywhere Enlive says it operates on an element or a
node, it means the Clojure data structure for the element, not the
HTML string.</p></div>
</div>
<div class="sect4">
<h5 id="_templates">Templates</h5>
<div class="paragraph"><p>The most important element of these examples is the <span class="monospaced">deftemplate</span>
macro. <span class="monospaced">deftemplate</span> takes a symbol as a name, a classpath-relative
path to an HTML file, an argument list, and a series of <em>selector</em> and
<em>transform function</em> pairs. It emits a function, bound to the same
name and of the specified arguments, which, when called, will return
the resulting HTML as a sequence of strings.</p></div>
<div class="paragraph"><p>An Enlive <em>selector</em> is a Clojure data structure that identifies a
specific node in the input HTML file. They are similar to CSS
selectors in operation, although somewhat more capable. In the
example in the solution, <span class="monospaced">[:title]</span> selects each <span class="monospaced">&lt;title&gt;</span> element, <span class="monospaced">[:span.author]</span>
each <span class="monospaced">&lt;span&gt;</span> with <span class="monospaced">class="author"</span>, etc. More selector forms are
described in the following subsection.</p></div>
<div class="paragraph"><p>A template <em>transform function</em> takes an Enlive node and returns a
modified node. Our example uses Enlive&#8217;s <span class="monospaced">content</span> utility function,
which returns a function that swaps the contents of a node with the
value given as its argument.</p></div>
<div class="paragraph"><p>The return value is not itself a string, but a sequence of strings,
each one a small fragment of HTML code. This allows the underlying
data structure to be transformed to a string representation
lazily. For simplicity, our example uses the string
concatenation function <span class="monospaced">str</span> to <span class="monospaced">reduce</span> the
result of <span class="monospaced">all-posts-page</span> , but this is actually
not optimally performant. To build a string most efficiently, use the
Java <span class="monospaced">StringBuilder</span> class, which uses mutable state to build up a
<span class="monospaced">String</span> object with the best possible performance. Alternatively,
forego the use of strings altogether and pipe the result seq of the
template function directly into an output <span class="monospaced">Writer</span>, which most web
application libraries (including Ring) can use as the body of an HTTP
response (the most common destination for templated HTML).</p></div>
</div>
<div class="sect4">
<h5 id="_selectors">Selectors</h5>
<div class="paragraph"><p>Enlive selectors are data structures that identify one or more HTML
nodes. They describe a <em>pattern</em> of data&#8212;if the pattern matches any
nodes in the HTML data structure, the selector will select those nodes. A selector may select one, many, or zero nodes from a
given HTML document, depending on how many matches the pattern has.</p></div>
<div class="paragraph"><p>The full reference for valid selector forms is quite complex, and
beyond the scope of this recipe. See the formal
selector <a href="http://bit.ly/enlive-syntax">specification</a> for
complete documentation.</p></div>
<div class="paragraph"><p>The following selector patterns should be sufficient to get
you started:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">[:div]</span>
</dt>
<dd>
<p>
Selects all <span class="monospaced">&lt;div&gt;</span> element nodes.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">[:div.sidebar]</span>
</dt>
<dd>
<p>
Selects all <span class="monospaced">&lt;div&gt;</span> element nodes with a CSS class
  of <span class="monospaced">"sidebar"</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">[:div#summary]</span>
</dt>
<dd>
<p>
Selects the <span class="monospaced">&lt;div&gt;</span> element with an HTML ID of
 <span class="monospaced">"summary"</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">[:p :span]</span>
</dt>
<dd>
<p>
Selects all <span class="monospaced">&lt;span&gt;</span> elements that are descendants of
  <span class="monospaced">&lt;p&gt;</span> elements.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">[:div.menu :ul :li :span]</span>
</dt>
<dd>
<p>
Selects only <span class="monospaced">&lt;span&gt;</span> elements inside an <span class="monospaced">&lt;li&gt;</span>
  element inside a <span class="monospaced">&lt;ul&gt;</span> element inside a <span class="monospaced">&lt;div&gt;</span> element with a CSS
  style of <span class="monospaced">"menu"</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">[[:div (nth-child 2)]]</span>
</dt>
<dd>
<p>
Selects all <span class="monospaced">&lt;div&gt;</span> elements that are the
  second children of their parent elements. The double square brackets are
  not a typo&#8212;the inner vector is used to denote a logical <em>and</em>
  condition. In this case, the matched element must be a <span class="monospaced">&lt;div&gt;</span>, <em>and</em> the
  <span class="monospaced">nth-child</span> predicate must hold true.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Other predicates besides <span class="monospaced">nth-child</span> are available, as well as the
ability to define custom predicates. See the Enlive documentation for
more details.</p></div>
<div class="paragraph"><p>Finally, there is a special type of selector called a <em>range</em> selector
that is not specified by a vector, but rather by a map literal (in curly
braces). The range selector contains two other selectors and
inclusively matches all the nodes between the two matched nodes, in
document order. The starting node is in key position in the map
literal and the ending node is in value position, so the selector
<span class="monospaced">{[:#foo] [:#bar]}</span> will match all nodes between nodes with a CSS ID of
"foo" and a CSS ID of "bar".</p></div>
<div class="paragraph"><p>The example in the solution uses a range selector in the <span class="monospaced">defsnippet</span>
form to select all the nodes that are part of the same logical blog
post, even though they aren&#8217;t wrapped in a common parent element.</p></div>
</div>
<div class="sect4">
<h5 id="_snippets">Snippets</h5>
<div class="paragraph"><p>A snippet is similar to a template, in that it produces a function
based on a base HTML file. However, snippets have two major differences
from templates:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Rather than always rendering the entire HTML file like a template
does, snippets render only a portion of the input HTML. The portion to
be rendered is specified by an Enlive selector passed as the third
argument to the <span class="monospaced">defsnippet</span> macro, right after the name and the path
to the HTML file.
</p>
</li>
<li>
<p>
The return values of the emitted functions are Enlive data
structures rather than HTML strings. This means that the results of
rendering a snippet can be returned directly from the transform
function of a template or another snippet. This is where Enlive starts
to show its power; snippets can be recycled and reused extensively
and in different combinations.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Other than these differences, the <span class="monospaced">defsnippet</span> form is identical to
<span class="monospaced">deftemplate</span>, and after the selector, the rest of the arguments are
the same&#8212;an argument vector and a series of selector and transform
function pairs.</p></div>
</div>
<div class="sect4">
<h5 id="_using_enlive_for_scraping">Using Enlive for scraping</h5>
<div class="paragraph"><p>Because of its emphasis on selectors and use of plain, unannotated
HTML files, Enlive is extremely useful not just for templating
and producing HTML, but also for parsing and scraping data from HTML from
any source.</p></div>
<div class="paragraph"><p>To use Enlive to extract data from HTML, you must first parse the HTML
file into an Enlive data structure. To do this, invoke the
<span class="monospaced">net.cgrand.enlive-html/html-resource</span> function on the HTML file. You
may specify the file as a <span class="monospaced">java.net.URL</span>, a <span class="monospaced">java.io.File</span>, or a
string indicating a classpath-relative path. The function will return
the parsed Enlive data structure representing the HTML DOM.</p></div>
<div class="paragraph"><p>Then, you can use the <span class="monospaced">net.cgrand.enlive-html/select</span> function to
apply a selector to the DOM and extract specific data. Given a node
and a selector, <span class="monospaced">select</span> will return only the matched nodes. You can
then use the <span class="monospaced">net.cgrand.enlive-html/text</span> function to retrieve the
text content of a node.</p></div>
<div class="paragraph"><p>For example, the following function will return a sequence of the most
recent <span class="monospaced">n</span> comic titles in the XKCD archives:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> comic<span style="color: #990000">-</span>titles
  <span style="color: #990000">[</span>n<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>dom <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>html<span style="color: #990000">-</span>resource
             <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>net<span style="color: #990000">.</span>URL<span style="color: #990000">.</span> <span style="color: #FF0000">"http://xkcd.com/archive"</span><span style="color: #990000">))</span>
        title<span style="color: #990000">-</span>nodes <span style="font-weight: bold"><span style="color: #000000">(html</span></span><span style="color: #990000">/</span>select dom <span style="color: #990000">[:</span>#middleContainer <span style="color: #990000">:</span>a<span style="color: #990000">])</span>
        titles <span style="font-weight: bold"><span style="color: #000000">(map</span></span> html<span style="color: #990000">/</span>text title<span style="color: #990000">-</span>nodes<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(take</span></span> n titles<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(comic</span></span><span style="color: #990000">-</span>titles <span style="color: #993399">5</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; ("Oort Cloud" "Git Commit" "New Study"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     "Telescope Names" "Job Interview")</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_when_to_use_enlive">When to use Enlive</h5>
<div class="paragraph"><p>As an HTML templating system, Enlive has two primary value
propositions over its alternatives in the Clojure ecosystem.</p></div>
<div class="paragraph"><p>First, the templates are pure HTML. This makes it much easier to work
with HTML designers: they can hand their HTML mockups directly to a
developer without having to deal with inline markup code, and
developers can use them directly without manually slicing them
(outside of code, that is). Furthermore, the templates themselves can
be viewed in a browser statically, meaning they can serve as their own
wireframes. This eliminates the burden of keeping a web project&#8217;s
visual prototypes in sync with the code.</p></div>
<div class="paragraph"><p>Secondly, because it uses real Clojure functions and data structures
instead of a custom DSL, Enlive exposes the full power of the Clojure
language. There are very few situations where you should feel limited
by Enlive&#8217;s capabilities, since it is always possible to extend it
using only standard Clojure functions and macros, operating on familiar
persistent, immutable data structures.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_139">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Enlive <a href="http://bit.ly/enlive-wiki">documentation</a>
</p>
</li>
<li>
<p>
David Nolen&#8217;s <a href="https://github.com/swannodette/enlive-tutorial">Enlive tutorial</a>
</p>
</li>
<li>
<p>
The Enlive <a href="http://bit.ly/enlive-group">mailing list</a>
</p>
</li>
<li>
<p>
Alternative templating libraries Selmer
  (<a href="#sec_webapps_templating_with_selmer">[sec_webapps_templating_with_selmer]</a>) and Hiccup (<a href="#sec_hiccup">[sec_hiccup]</a>)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_webapps_templating_with_selmer">Templating with Selmer</h3>
<div class="paragraph byline"><p>by Dmitri Sotnikov</p></div>
<div class="sect3">
<h4 id="_problem_141">Problem</h4>
<div class="paragraph"><p>You want to create server-side page templates using syntax similar to that of Django and Jinja. You want to be able
to insert dynamic content and use template inheritance to structure the templates.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_139">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/yogthos/Selmer">Selmer library</a> to
create your template and call it with a context map containing the
dynamic content.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try selmer</tt></pre></div></div>
<div class="paragraph"><p>A Selmer template is an HTML file with special tags that is populated with dynamic
content at runtime. A simple template (<em>base.html</em>) might look like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;header&gt;</span></span>

      <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{header}}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

      <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"navigation"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        {% for item in nav-items %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"{{item.link}}"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>{{item.name}}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
        {% endfor %}

      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/header&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The template can then be rendered by calling the <span class="monospaced">selmer.parser/render-file</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>selmer<span style="color: #990000">.</span>parser <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>render<span style="color: #990000">-</span>file render<span style="color: #990000">]])</span>

<span style="font-weight: bold"><span style="color: #000000">(println</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(render</span></span><span style="color: #990000">-</span>file <span style="color: #FF0000">"base.html"</span>
               {<span style="color: #990000">:</span>header <span style="color: #FF0000">"Hello Selmer"</span>
                <span style="color: #990000">:</span>nav<span style="color: #990000">-</span>items <span style="color: #990000">[</span>{<span style="color: #990000">:</span>name <span style="color: #FF0000">"Home"</span> <span style="color: #990000">:</span>link <span style="color: #FF0000">"/"</span>}
                            {<span style="color: #990000">:</span>name <span style="color: #FF0000">"About"</span> <span style="color: #990000">:</span>link <span style="color: #FF0000">"/about"</span>}<span style="color: #990000">]</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>When <span class="monospaced">render-file</span> runs, it will populate the tags with the content
provided. The value will be returned as a string, suitable for use as
the response body in a Ring application (for example). Here the result
is simply printed to standard output, for easy inspection.</p></div>
<div class="paragraph"><p>We can apply filters to variables for additional post-processing at runtime.
Here, we use the <span class="monospaced">upper</span> filter to convert our heading to uppercase:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{header|upper}}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>We can extract parts of the template into individual snippets using the <span class="monospaced">include</span> tag. For example, if we wanted to define the header in a separate file <em>header.html</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;header&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{header}}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"navigation"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

    {% for item in nav-items %}
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"{{item.link}}"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>{{item.name}}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
    {% endfor %}

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/header&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>we could then include it as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>

    {% include "header.html" %}

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">include</span> tag will simply be replaced by the contents of the file it points to when the template
is compiled.</p></div>
<div class="paragraph"><p>We can also extend our base template when we create individual pages.
To do that, we first define a block in our base template. This will serve as an anchor
for the child template to override:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>

    {% include "header.html" %}

    {% block content %}
    {% endblock %}

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The child template will reference the parent using the <span class="monospaced">extends</span> tag and define its own
content for the <span class="monospaced">content</span> block:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{% extends "base.html" %}

{% block content %}

<span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>This is the home page of the site<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>some exciting content follows<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

{% endblock %}</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_141">Discussion</h4>
<div class="paragraph"><p>Selmer provides a powerful and familiar templating tool with many tags and filters for easily accomplishing many common tasks.
It separates the view logic from presentation by design.</p></div>
<div class="paragraph"><p>Selmer is also performant because it compiles the templates and ensures that only the dynamic content needs to be
evaluated when serving a request.</p></div>
<div class="sect4">
<h5 id="_selmer_concepts">Selmer concepts</h5>
<div class="paragraph"><p>Selmer includes two types of elements, <em>variables</em> and <em>tags</em>.</p></div>
<div class="paragraph"><p>Variables are used to render values from the context map on the page.
The <span class="monospaced">{{</span> and <span class="monospaced">}}</span> are used to indicate the start and end of a variable.</p></div>
<div class="paragraph"><p>In many cases, you may wish to post-process the value of a variable. For example, you might want to convert it to uppercase,
pluralize it, or parse it as a date. Variable filters (described in the following subsection) are used for this purpose.</p></div>
<div class="paragraph"><p>Tags are used to add various functionality to the template, such as looping and conditions. We already saw examples of
the <span class="monospaced">for</span>, <span class="monospaced">include</span>, and <span class="monospaced">extends</span> tags. The tags use <span class="monospaced">{%</span> and <span class="monospaced">%}</span> to define their content.</p></div>
<div class="paragraph"><p>The default tag characters might conflict with client-side frameworks such as AngularJS.
In this case, we can specify custom tags by passing a map containing any of the following keys to the parser:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>tag<span style="color: #990000">-</span>open
<span style="color: #990000">:</span>tag<span style="color: #990000">-</span>close
<span style="color: #990000">:</span>filter<span style="color: #990000">-</span>open
<span style="color: #990000">:</span>filter<span style="color: #990000">-</span>close
<span style="color: #990000">:</span>tag<span style="color: #990000">-</span>second
<span style="color: #990000">:</span>custom<span style="color: #990000">-</span>tags
<span style="color: #990000">:</span>custom<span style="color: #990000">-</span>filters</tt></pre></div></div>
<div class="paragraph"><p>If we wanted to use <span class="monospaced">[</span> and <span class="monospaced">]</span> as our opening and closing tags, we could call the <span class="monospaced">render</span> function as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"[% for ele in foo %] "</span>
             <span style="color: #FF0000">"{{I'm not a tag, but the next one is}} [{ele}] [%endfor%]"</span><span style="color: #990000">)</span>
        {<span style="color: #990000">:</span>foo <span style="color: #990000">[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">]</span>}
        {<span style="color: #990000">:</span>tag<span style="color: #990000">-</span>open <span style="color: #990000">\[</span>
         <span style="color: #990000">:</span>tag<span style="color: #990000">-</span>close <span style="color: #990000">\]</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">render</span> function works just like <span class="monospaced">render-file</span>, except that it accepts the template content as a string.</p></div>
</div>
<div class="sect4">
<h5 id="_defining_filters">Defining filters</h5>
<div class="paragraph"><p>Selmer provides a rich set of filters that allow decorating of the dynamic content. Some of the filters include <span class="monospaced">capitalize</span>,
<span class="monospaced">pluralize</span>, <span class="monospaced">hash</span>, <span class="monospaced">length</span>, and <span class="monospaced">sort</span>.</p></div>
<div class="paragraph"><p>However, if you need a custom filter that&#8217;s not part of the library, you can trivially add one yourself.
For example, if we wanted to parse Markdown using the <a href="https://github.com/yogthos/markdown-clj"><span class="monospaced">markdown-clj</span> library</a>
and display it on the page, we could write the following filter:<span class="footnote"><br>[You&#8217;ll need to restart a new REPL with <span class="monospaced">lein-try</span> including <span class="monospaced">markdown-clj</span> to try this.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>markdown<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string<span style="color: #990000">]]</span>
         '<span style="color: #990000">[</span>selmer<span style="color: #990000">.</span>filters <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>add<span style="color: #990000">-</span>filter<span style="color: #990000">!]])</span>

<span style="font-weight: bold"><span style="color: #000000">(add</span></span><span style="color: #990000">-</span>filter<span style="color: #990000">!</span> <span style="color: #990000">:</span>markdown md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>We can now use this filter in our templates to render our Markdown content:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>h2<span style="color: #990000">&gt;</span>Blog Posts<span style="color: #990000">&lt;/</span>h2<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>ul<span style="color: #990000">&gt;</span>
  {<span style="color: #990000">%</span> for post in posts <span style="color: #990000">%</span>}
    <span style="color: #990000">&lt;</span>li<span style="color: #990000">&gt;</span>{{post<span style="color: #990000">.</span>title<span style="color: #990000">|</span>markdown<span style="color: #990000">|</span>safe}}<span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
{<span style="color: #990000">%</span> endfor <span style="color: #990000">%</span>}
<span style="color: #990000">&lt;/</span>ul<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Note that we had to chain the <span class="monospaced">markdown</span> filter with the <span class="monospaced">safe</span> filter. This is due to the fact that Selmer escapes
variable content by default. We can change our filter definition to indicate that its content does not need escaping as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(add</span></span><span style="color: #990000">-</span>filter<span style="color: #990000">!</span> <span style="color: #990000">:</span>markdown <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>s<span style="color: #990000">]</span> <span style="color: #990000">[:</span>safe <span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string s<span style="color: #990000">)]))</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_defining_tags">Defining tags</h5>
<div class="paragraph"><p>Again, we can define custom tags in addition to those already present in the library. This is done by calling the
<span class="monospaced">selmer.parser/add-tag!</span> function.</p></div>
<div class="paragraph"><p>Let&#8217;s say we wish to add a tag that will capitalize its contents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>selmer<span style="color: #990000">.</span>parser <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>add<span style="color: #990000">-</span>tag<span style="color: #990000">!]])</span>

<span style="font-weight: bold"><span style="color: #000000">(add</span></span><span style="color: #990000">-</span>tag<span style="color: #990000">!</span> <span style="color: #990000">:</span>uppercase
          <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>args context<span style="color: #990000">-</span>map content<span style="color: #990000">]</span>
            <span style="color: #990000">(.</span>toUpperCase <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>in content <span style="color: #990000">[:</span>uppercase <span style="color: #990000">:</span>content<span style="color: #990000">])))</span>
          <span style="color: #990000">:</span>enduppercase<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(render</span></span> <span style="color: #FF0000">"{% uppercase %}foo {{bar}} baz{% enduppercase %}"</span> {<span style="color: #990000">:</span>bar <span style="color: #FF0000">"injected"</span>}<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_inheritance">Inheritance</h5>
<div class="paragraph"><p>We already saw some examples of template inheritance. Each template can extend a single template and include
any number of templates in its content.</p></div>
<div class="paragraph"><p>The templates can extend templates that themselves extend other templates. In this case, the blocks found in the outermost
child will override any other blocks with the same name.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_140">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The Selmer <a href="https://github.com/yogthos/Selmer">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_hiccup">Templating with Hiccup</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_142">Problem</h4>
<div class="paragraph"><p>You want to create HTML dynamically based on a template, written in
pure Clojure data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_140">Solution</h4>
<div class="paragraph"><p>Use Hiccup, a library for representing and rendering HTML templates
made up of regular Clojure data structures.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try hiccup</tt></pre></div></div>
<div class="paragraph"><p>Hiccup represents HTML nodes as vectors. The first entry of the
vector is the element&#8217;s name; the second is an optional map of
the element&#8217;s attributes; and any remaining entries are the element&#8217;s
body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; &lt;h1 class="header"&gt;My Page Title&lt;/h1&gt; in Hiccup...</span></span>
<span style="color: #990000">[:</span>h1 {<span style="color: #990000">:</span>class <span style="color: #FF0000">"header"</span>} <span style="color: #FF0000">"My Page Title"</span><span style="color: #990000">]</span>

<span style="font-style: italic"><span style="color: #9A1900">;; &lt;ul&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   &lt;li&gt;lions&lt;/li&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   &lt;li&gt;tigers&lt;/li&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   &lt;li&gt;bears&lt;/li&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; &lt;/ul&gt; in Hiccup...</span></span>
<span style="color: #990000">[:</span>ul
  <span style="color: #990000">[:</span>li <span style="color: #FF0000">"lions"</span><span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>li <span style="color: #FF0000">"tigers"</span><span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>li <span style="color: #FF0000">"bears"</span><span style="color: #990000">]]</span> <span style="font-style: italic"><span style="color: #9A1900">;; oh my!</span></span></tt></pre></div></div>
<div class="paragraph"><p>Render any Hiccup data structure to HTML using the <span class="monospaced">hiccup.core/html</span>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>hiccup<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>html<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(html</span></span> <span style="color: #990000">[:</span>h1 {<span style="color: #990000">:</span>class <span style="color: #FF0000">"header"</span>} <span style="color: #FF0000">"My Page Title"</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "&lt;h1 class=\"header\"&gt;My Page Title&lt;/h1&gt;"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Since nodes are represented as regular Clojure data, you can leverage
any of Clojure&#8217;s built-in functions or techniques to yield
Hiccup-compliant vectors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> pi <span style="color: #993399">3.14</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(html</span></span> <span style="color: #990000">[:</span>p <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"Pi is approximately: "</span> pi<span style="color: #990000">)])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "&lt;p&gt;Pi is approximately: 3.14&lt;/p&gt;"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(html</span></span> <span style="color: #990000">[:</span>ul
        <span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[</span>animal <span style="color: #990000">[</span><span style="color: #FF0000">"lions"</span> <span style="color: #FF0000">"tigers"</span> <span style="color: #FF0000">"bears"</span><span style="color: #990000">]]</span>
          <span style="color: #990000">[:</span>li animal<span style="color: #990000">])])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "&lt;ul&gt;&lt;li&gt;lions&lt;/li&gt;&lt;li&gt;tigers&lt;/li&gt;&lt;li&gt;bears&lt;/li&gt;&lt;/ul&gt;"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using all of the preceding techniques, it&#8217;s possible to create a simple
function to dynamically populate the contents of a minimal blog page
using only Clojure functions and data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> blog<span style="color: #990000">-</span>index
  <span style="color: #FF0000">"Render a blog's index as Hiccup data"</span>
  <span style="color: #990000">[</span>title author posts<span style="color: #990000">]</span>
  <span style="color: #990000">[:</span>html
    <span style="color: #990000">[:</span>head
      <span style="color: #990000">[:</span>title title<span style="color: #990000">]]</span>
    <span style="color: #990000">[:</span>body
      <span style="color: #990000">[:</span>h1 title<span style="color: #990000">]</span>
      <span style="color: #990000">[:</span>h2 <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"By "</span> author<span style="color: #990000">)]</span>
      <span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[</span>post posts<span style="color: #990000">]</span>
        <span style="color: #990000">[:</span>article
          <span style="color: #990000">[:</span>h3 <span style="color: #990000">(:</span>title post<span style="color: #990000">)]</span>
          <span style="color: #990000">[:</span>p <span style="color: #990000">(:</span>content post<span style="color: #990000">)]])]])</span>

<span style="color: #990000">(-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(blog</span></span><span style="color: #990000">-</span>index <span style="color: #FF0000">"My First Blog"</span>
                <span style="color: #FF0000">"Ryan"</span>
                 <span style="color: #990000">[</span>{<span style="color: #990000">:</span>title <span style="color: #FF0000">"First post!"</span> <span style="color: #990000">:</span>content <span style="color: #FF0000">"I'm here!"</span>}
                  {<span style="color: #990000">:</span>title <span style="color: #FF0000">"Second post."</span> <span style="color: #990000">:</span>content <span style="color: #FF0000">"Yawn, bored."</span>}<span style="color: #990000">])</span>

    html<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Formatted output:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>My First Blog<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>My First Blog<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>By Ryan<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;article&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>First post!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>I'm here!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/article&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;article&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Second post.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Yawn, bored.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/article&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span>"</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_142">Discussion</h4>
<div class="paragraph"><p>Hiccup is an easy, "no muss, no fuss" way of templating and rendering
HTML from raw functions and data. This comes in particularly handy
when you don&#8217;t have the time to learn a new DSL or you prefer
to work exclusively with Clojure.</p></div>
<div class="paragraph"><p>An HTML node is represented in Hiccup as a vector of a few elements:</p></div>
<div class="ulist"><ul>
<li>
<p>
The node&#8217;s name, represented as a keyword (e.g., <span class="monospaced">:h1</span>, <span class="monospaced">:article</span>,
  or <span class="monospaced">:body</span>)
</p>
</li>
<li>
<p>
An optional map of the node&#8217;s attributes, with attribute names
  represented as keywords (e.g., <span class="monospaced">{:href "/posts/"}</span> or <span class="monospaced">{:id "post-1"
  :class "post"}</span>)
</p>
</li>
<li>
<p>
Any number of other nodes or string values constituting the node&#8217;s
  body
</p>
</li>
</ul></div>
<div class="paragraph"><p>Invoke <span class="monospaced">hiccup.core/html</span> with a single node, snippet, or entire page
to render its contents as HTML. For content with special
characters that should be escaped, wrap values in a <span class="monospaced">hiccup.core/h</span>
invocation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>hiccup<span style="color: #990000">.</span>core <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>h<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(html</span></span> <span style="color: #990000">[:</span>a {<span style="color: #990000">:</span>href <span style="font-weight: bold"><span style="color: #000000">(h</span></span> <span style="color: #FF0000">"/post/my&lt;crazy&gt;url"</span><span style="color: #990000">)</span>}<span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "&lt;a href=\"/post/my&amp;amp;lt;crazy&amp;amp;gt;url\"&gt;&lt;/a&gt;"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Hiccup also has basic support for rendering forms. Use
<span class="monospaced">form-to</span> and a bevy of other helpers in the <span class="monospaced">hiccup.form</span> namespace
to simplify rendering form tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>hiccup<span style="color: #990000">.</span>form <span style="color: #990000">:</span>as f<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">/</span>form<span style="color: #990000">-</span>to <span style="color: #990000">[:</span>post <span style="color: #FF0000">"/posts/new"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">/</span>hidden<span style="color: #990000">-</span>field <span style="color: #990000">:</span>user<span style="color: #990000">-</span>id <span style="color: #993399">42</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">/</span>text<span style="color: #990000">-</span>field <span style="color: #990000">:</span>title<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">/</span>text<span style="color: #990000">-</span>field <span style="color: #990000">:</span>content<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; [:form {:method "POST", :action #&lt;URI /posts/new&gt;}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:input {:type "hidden"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :name "user-id"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :id "user-id"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :value 42}]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:input {:type "text"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :name "title"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :id "title"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :value nil}]</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      [:input {:type "text"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :name "content"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :id "content"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;               :value nil}]]</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_141">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Hiccup&#8217;s <a href="https://github.com/weavejester/hiccup/">GitHub repository</a>,
  <a href="http://bit.ly/hiccup-docs">API documentation</a>, and
  <a href="http://bit.ly/hiccup-wiki">wiki</a>.
</p>
</li>
<li>
<p>
If you have more complicated needs from your templating engine&#8212;like
  consuming and populating existing HTML files&#8212;you&#8217;ll need sharper
  tools such as Enlive (<a href="#sec_enlive">[sec_enlive]</a>) or Selmer
  (<a href="#sec_webapps_templating_with_selmer">[sec_webapps_templating_with_selmer]</a>).
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_webapps__markdown">Rendering Markdown Documents</h3>
<div class="paragraph byline"><p>by Dmitri Sotnikov</p></div>
<div class="sect3">
<h4 id="_problem_143">Problem</h4>
<div class="paragraph"><p>You need to render a Markdown document.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_141">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/yogthos/markdown-clj"><span class="monospaced">markdown-clj</span> library</a> to render Markdown documents.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try markdown-clj</tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">markdown.core/md-to-html</span> to read a Markdown document and generate a string containing HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>markdown<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as md<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>java<span style="color: #990000">.</span>io <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>input<span style="color: #990000">-</span>stream output<span style="color: #990000">-</span>stream<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html <span style="color: #FF0000">"input.md"</span> <span style="color: #FF0000">"output.html"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html <span style="font-weight: bold"><span style="color: #000000">(input</span></span><span style="color: #990000">-</span>stream <span style="color: #FF0000">"input.md"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(output</span></span><span style="color: #990000">-</span>stream <span style="color: #FF0000">"test.txt"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Use <span class="monospaced">markdown.core/md-to-html-string</span> to convert a string
with Markdown content to its HTML representation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string
  <span style="color: #FF0000">"# This is a test</span><span style="color: #CC33CC">\n\n</span><span style="color: #FF0000">some code follows:</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">```</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">(defn foo [])</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">```"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span> This is a test<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;&lt;p&gt;</span></span>some code follows:<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;&lt;pre&gt;</span></span>
&amp;#40;defn foo &amp;#91;&amp;#93;&amp;#41;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/pre&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_143">Discussion</h4>
<div class="paragraph"><p>Markdown is a popular lightweight markup language that&#8217;s easy to read and write and
can be converted to structurally valid HTML.</p></div>
<div class="paragraph"><p>Since Markdown leaves many aspects of rendering the HTML open to interpretation, it&#8217;s
not guaranteed that different parsers will produce the same representation. This can be a problem if you render a Markdown preview on the client using one
parser and then later generate HTML on a server using a different parser. By virtue of compiling to both Clojure and ClojureScript, <span class="monospaced">markdown-clj</span> avoids this problem.
With it, you can use the same parser on both the server and the client and be guaranteed
that the documents will be rendered consistently.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at more examples of using the library. The code blocks can be annotated with language hints. In this case, the <span class="monospaced">pre</span> tags
will be decorated with a class compatible with the <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"# This is a test</span><span style="color: #CC33CC">\n\n</span><span style="color: #FF0000">some code follows:</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span>
                           <span style="color: #FF0000">"```clojure</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">(defn foo [])</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">```"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span> This is a test<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;&lt;p&gt;</span></span>some code follows:<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;&lt;pre</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"brush: clojure"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
&amp;#40;defn foo &amp;#91;&amp;#93;&amp;#41;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/pre&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">markdown-clj</span> supports all the standard Markdown tags, with the exception of reference-style links (because the parser uses a single pass to generate the document).</p></div>
<div class="paragraph"><p>The <span class="monospaced">markdown.core/md-to-html</span> processes the input line by line, and the entirety of the content
does not need to be stored in memory when processing. On the other hand, the <span class="monospaced">md-to-html-string</span>
function keeps the entire input and output in memory.</p></div>
<div class="paragraph"><p>The parser accepts additional formatting options. These include <span class="monospaced">:heading-anchors</span>, <span class="monospaced">:code-style</span>,
<span class="monospaced">:custom-transformers</span>, and <span class="monospaced">:replacement-transformers</span>.</p></div>
<div class="paragraph"><p>When the <span class="monospaced">:heading-anchors</span> key is set to <span class="monospaced">true</span>, an anchor will be generated for each heading tag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string <span style="color: #FF0000">"###foo bar BAz"</span> <span style="color: #990000">:</span>heading<span style="color: #990000">-</span>anchors true<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">\"heading\" class=\"anchor\" href=\"#foo&amp;#95;bar&amp;#95;baz\"&gt;&lt;/a&gt;</span>
<span style="color: #FF0000">  foo bar BAz</span>
<span style="color: #FF0000">&lt;/h3&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">:code-style</span> key allows overriding the default style hint for code blocks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string <span style="color: #FF0000">"```clojure</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">(defn foo [])</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">```"</span>
                      <span style="color: #990000">:</span>code<span style="color: #990000">-</span>style #<span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"class=</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;pre</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"clojure"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
&amp;#40;defn foo &amp;#91;&amp;#93;&amp;#41;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/pre&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>We can specify transformers for custom tags by using the <span class="monospaced">:custom-transformers</span> key. The
transformer function should accept the <span class="monospaced">text</span> parameter, which is the current line, and the
<span class="monospaced">state</span> parameter, which contains the current state of the parser. The state can be used to store
information such as what tags are active:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> capitalize <span style="color: #990000">[</span>text state<span style="color: #990000">]</span>
  <span style="color: #990000">[(.</span>toUpperCase text<span style="color: #990000">)</span> state<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string <span style="color: #FF0000">"#foo"</span> <span style="color: #990000">:</span>custom<span style="color: #990000">-</span>transformers <span style="color: #990000">[</span>capitalize<span style="color: #990000">])</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;H1&gt;</span></span>FOO<span style="font-weight: bold"><span style="color: #0000FF">&lt;/H1&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Finally, we can provide a custom set of transformers to replace the built-in ones using the
<span class="monospaced">:replacement-transformers</span> key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(md</span></span><span style="color: #990000">/</span>md<span style="color: #990000">-</span>to<span style="color: #990000">-</span>html<span style="color: #990000">-</span>string <span style="color: #FF0000">"#foo"</span> <span style="color: #990000">:</span>replacement<span style="color: #990000">-</span>transformers <span style="color: #990000">[</span>capitalize<span style="color: #990000">])</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_142">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">markdown-clj</span> <a href="https://github.com/yogthos/markdown-clj">GitHub repository</a> for more information on the library
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_webapps__luminus">Building Applications with Luminus</h3>
<div class="paragraph byline"><p>by Dmitri Sotnikov</p></div>
<div class="sect3">
<h4 id="_problem_144">Problem</h4>
<div class="paragraph"><p>You want to quickly create a typical Ring/Compojure web application structure to
get a fast start on a new web development project.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_142">Solution</h4>
<div class="paragraph"><p>Use the Luminus Leiningen template when creating a new project.</p></div>
<div class="paragraph"><p>At the command line, type:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new luminus myapp</tt></pre></div></div>
<div class="paragraph"><p>This will create a new Ring/Compojure application with a skeletal
namespace and resource directory structure that is ready to be
packaged as standalone Java Archive (JAR) or Web Archive (WAR) file that can be
deployed on an application server.</p></div>
<div class="paragraph"><p>You can start the application in development mode by running:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein ring server</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_144">Discussion</h4>
<div class="paragraph"><p>Luminus doesn&#8217;t do anything you couldn&#8217;t do yourself, but provides a
standardized set of libraries and boilerplate for creating common
Ring/Compojure applications.</p></div>
<div class="paragraph"><p>The template generates a standard directory structure within your
project, defines a main handler for your application, adds <span class="monospaced">lein-ring</span>
hooks for it in the <em>project.clj</em> file, provides a default logging
configuration, and sets up the default routes.</p></div>
<div class="paragraph"><p>When creating the application, you can add functionality by specifying profiles that extend the generated code to include
the relevant stubs. The following are some examples of initializing the
application with default configurations for different databases:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new luminus app1 <span style="color: #990000">+</span>h2

<span style="font-style: italic"><span style="color: #9A1900"># Or, with PostgreSQL:</span></span>
$ lein new luminus app2 <span style="color: #990000">+</span>postgres

<span style="font-style: italic"><span style="color: #9A1900"># Or ClojureScript!</span></span>
$ lein new luminus app3 <span style="color: #990000">+</span>cljs

<span style="font-style: italic"><span style="color: #9A1900"># You can also specify multiple profiles simultaneously:</span></span>
$ lein new luminus app4 <span style="color: #990000">+</span>cljs <span style="color: #990000">+</span>postgres</tt></pre></div></div>
<div class="paragraph"><p>The resulting application is structured using the following namespaces.</p></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;app-name&gt;.handler</span> namespace contains <span class="monospaced">init</span> and <span class="monospaced">destroy</span>
functions. These will be called when the application is starting up
and shutting down, respectively. It also contains the <span class="monospaced">app</span> handler
function that&#8217;s used by Ring to initialize the route handlers.</p></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;app-name&gt;.routes</span> namespace is used to house the core logic of the
application. Here is where you would define the application routes and
their handlers. The <span class="monospaced">&lt;app-name&gt;.routes.home</span> namespace contains the
routes for the default <em>/</em> and <em>/about</em> pages.</p></div>
<div class="paragraph"><p>The layout for the site is generated by the <span class="monospaced">render</span> function in the
<span class="monospaced">&lt;app-name&gt;.views.layout</span> namespace.  The HTML templates for the pages
can be found under <em>src/&lt;app-name&gt;/views/templates/</em>. Luminus uses
<a href="https://github.com/yogthos/Selmer">Selmer</a>, introduced in <a href="#sec_webapps_templating_with_selmer">[sec_webapps_templating_with_selmer]</a>, as its default templating
engine.</p></div>
<div class="paragraph"><p>Any miscellaneous helpers will be found under the
<span class="monospaced">&lt;app_name&gt;.views.util</span> namespace.</p></div>
<div class="paragraph"><p>When a database profile is selected, the <span class="monospaced">&lt;app_name&gt;.models.db</span> and
<span class="monospaced">&lt;app_name&gt;.models.schema</span> namespaces will be created. The <span class="monospaced">schema</span>
namespace is reserved for table definitions, while the <span class="monospaced">db</span> namespace
houses the functions dealing with the application model.</p></div>
<div class="paragraph"><p>The application can be packaged as a standalone JAR file using <strong><span class="monospaced">lein ring uberjar</span></strong> or as a WAR file using <strong><span class="monospaced">lein ring uberwar</span></strong>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_143">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://www.luminusweb.net/">Luminus project page</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_deployment_and_distribution">Performance and Production</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_8">Introduction</h3>
<div class="paragraph"><p>You&#8217;ve spent all of this time developing your next big thing: what&#8217;s
next but to ship it to the wild? Whether it is a product, internal
service, or library, the last (and most important) step is
delivering the fruits of your labor to your audience.</p></div>
<div class="paragraph"><p>It&#8217;s easy for developers to forget that code-complete is only the
beginning of an actual application&#8217;s life cycle. A successful project
will spend much more time in production than it will in development,
and stability and maintainability are premium features.</p></div>
<div class="paragraph"><p>This is a chapter all about really finishing your work and building
something that will run as painlessly as possible for years to
come. Be the task performance, logging, release, or long-term
maintenance, it&#8217;s all important in shipping something that is truly
excellent. There is certainly a lot to worry about when your baby
finally leaves home; we hope these recipes help you get it right.</p></div>
</div>
<div class="sect2">
<h3 id="sec_aot_compilation">AOT Compilation</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_145">Problem</h4>
<div class="paragraph"><p>You want to deliver your code as precompiled JVM bytecode in <em>.class</em>
files, rather than as Clojure source code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_143">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">:aot</span> (ahead of time) compilation key in your project&#8217;s
<em>project.clj</em> file to specify which namespaces should be compiled to
<em>.class</em> files. The value of the <span class="monospaced">:aot</span> key is a vector of either
symbols indicating specific namespaces to be compiled, or regular
expression literals specifying that any namespace with a matching name
should be compiled. Alternatively, instead of a vector, you can use the keyword <span class="monospaced">:all</span> as
a value, which will AOT-compile every namespace in the project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>aot <span style="color: #990000">[</span>foo<span style="color: #990000">.</span>bar foo<span style="color: #990000">.</span>baz<span style="color: #990000">]</span>

<span style="font-style: italic"><span style="color: #9A1900">;; or...</span></span>
<span style="color: #990000">:</span>aot <span style="color: #990000">[</span>#<span style="color: #FF0000">"foo</span><span style="color: #CC33CC">\.</span><span style="color: #FF0000">b.+"</span><span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">; Compile all namespaces starting with "foo.b"</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; or...</span></span>
<span style="color: #990000">:</span>aot <span style="color: #990000">:</span>all</tt></pre></div></div>
<div class="paragraph"><p>Note that if your project has specified a <span class="monospaced">:main</span> namespace, Leiningen
will AOT-compile it by default, regardless of whether it is present in an <span class="monospaced">:aot</span>
directive.</p></div>
<div class="paragraph"><p>Once your project is configured for AOT compilation, you can compile it
by invoking <strong><span class="monospaced">lein compile</span></strong> at the command line. All emitted classes
will be placed in the <em>target/classes</em> directory, unless you&#8217;ve
overridden the output directory with the <span class="monospaced">:target-path</span> or
<span class="monospaced">:compile-path</span> options.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_145">Discussion</h4>
<div class="paragraph"><p>It&#8217;s important to understand that AOT compilation does <em>not</em> change
how the code actually runs. It&#8217;s no faster or different. All Clojure
code is compiled to the same bytecode before execution; AOT
compilation merely means that it happens at a singular, defined point
in time instead of on demand as the program loads and runs.</p></div>
<div class="paragraph"><p>However, although it isn&#8217;t any faster, it can be a great tool in the
following situations:</p></div>
<div class="ulist"><ul>
<li>
<p>
You want to deliver the application binary, but you don&#8217;t want to
  include the original source code with it.
</p>
</li>
<li>
<p>
To marginally speed up an application&#8217;s start time (since the
  Clojure code won&#8217;t have to be compiled on the fly).
</p>
</li>
<li>
<p>
You need to generate classes loadable directly from Java for interop
  purposes.
</p>
</li>
<li>
<p>
For platforms (such as Android) that do not support custom
  class loaders for running new bytecode at runtime.
</p>
</li>
</ul></div>
<div class="paragraph"><p>You may observe that there is more than one emitted class file for
each AOT-compiled namespace. In fact, there will be separate Java
classes for each function, the namespace itself, and any additional
<span class="monospaced">gen-class</span>, <span class="monospaced">deftype</span>, or <span class="monospaced">defrecord</span> forms. This is actually not
dissimilar from Java itself; it has always been the case that inner
classes are compiled to separate class files, and Clojure functions
are effectively anonymous inner classes from the JVM&#8217;s point of view.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_144">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Clojure&#8217;s official documentation on
  <a href="http://clojure.org/compilation">AOT compilation</a>
</p>
</li>
<li>
<p>
<a href="#sec_packaging_jars">[sec_packaging_jars]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_packaging_jars">Packaging a Project into a JAR File</h3>
<div class="paragraph byline"><p>by Alan Busby</p></div>
<div class="sect3">
<h4 id="_problem_146">Problem</h4>
<div class="paragraph"><p>You want to package a project into an executable JAR.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_144">Solution</h4>
<div class="paragraph"><p>Use the Leiningen build tool to package your application as an
<em>uberjar</em>, a JAR file that includes an application and all of its
dependencies.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a new Leiningen project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new foo</tt></pre></div></div>
<div class="paragraph"><p>Configure the project to be executable by adding <span class="monospaced">:main</span> and <span class="monospaced">:aot</span>
parameters to the project&#8217;s <em>project.clj</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> foo <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]]</span>
  <span style="color: #990000">:</span>main foo<span style="color: #990000">.</span>core
  <span style="color: #990000">:</span>aot <span style="color: #990000">:</span>all<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To finish making the project executable, add a <span class="monospaced">-main</span> function and
<span class="monospaced">:gen-class</span> declaration to <em>src/foo/core.clj</em>. Remove the existing
<span class="monospaced">foo</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> foo<span style="color: #990000">.</span>core
  <span style="color: #990000">(:</span>gen<span style="color: #990000">-</span>class<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main  <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="color: #990000">(-&gt;&gt;</span> args
       <span style="font-weight: bold"><span style="color: #000000">(interpose</span></span> <span style="color: #FF0000">" "</span><span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str<span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Executed with the following args: "</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Run the application using the <strong><span class="monospaced">lein run</span></strong> command to verify it is
functioning correctly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span></tt></pre></div></div>
<div class="paragraph"><p>To package the application with all of its dependencies included,
invoke <strong><span class="monospaced">lein uberjar</span></strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein uberjar
Created /tmp/foo/target/uberjar/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar
Created /tmp/foo/target/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT-standalone<span style="color: #990000">.</span>jar</tt></pre></div></div>
<div class="paragraph"><p>Execute the generated <em>target/foo-0.1.0-SNAPSHOT-standalone.jar</em> file by
passing it as the <span class="monospaced">-jar</span> option to the <span class="monospaced">java</span> executable:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -jar target/foo-<span style="color: #993399">1.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-standalone<span style="color: #990000">.</span>jar <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span>
Executed with the following args<span style="color: #990000">:</span>  <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_146">Discussion</h4>
<div class="paragraph"><p>Executable JAR files provide an excellent method to package a program
so it can be provided to users, called by cron jobs, combined with
other Unix tools, or used in any other scenario where command-line
invocation is useful.</p></div>
<div class="paragraph"><p>Under the hood, an executable JAR is like any other JAR file in that
it contains a collection of program resources such as class files,
Clojure source files, and classpath resources. Additionally,
an executable JAR contains metadata indicating which class contains the
<span class="monospaced">main</span> method as a <span class="monospaced">Main-Class</span> tag in its internal manifest file.</p></div>
<div class="paragraph"><p>A Leiningen uberjar is a JAR file that contains not only your program,
but all the dependencies bundled in as well. When Leiningen builds an
uberjar, it can detect from the <span class="monospaced">:main</span> entry in <em>project.clj</em> that
your program supplies a <span class="monospaced">-main</span> function and writes an appropriate
manifest that will ensure that the emitted JAR file is executable.</p></div>
<div class="paragraph"><p>The <span class="monospaced">:gen-class</span> in your namespace and the <span class="monospaced">:aot</span> Leiningen option
are required to precompile your Clojure source file into a JVM class
file, since the "Main-Class" manifest entry doesn&#8217;t know how to
reference or compile Clojure source files.</p></div>
<div class="sect4">
<h5 id="_packaging_jars_without_their_dependencies">Packaging JARs Without Their Dependencies</h5>
<div class="paragraph"><p>Not only does Leiningen make it possible to package a project <em>with</em>
its dependencies, it also makes it possible to package it <em>without</em> its
dependencies.</p></div>
<div class="paragraph"><p>The <span class="monospaced">jar</span> command packages a project&#8217;s code without any of its
upstream dependencies. Not even Clojure itself is included in the JAR
file&#8212;you&#8217;ll need to BYOC.<span class="footnote"><br>[Bring your own Clojure!]<br></span></p></div>
<div class="paragraph"><p>By invoking the command <strong><span class="monospaced">lein jar</span></strong> in the <span class="monospaced">foo</span> project, you&#8217;ll
generate <em>target/foo-0.1.0-SNAPSHOT.jar</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein jar
Created /tmp/foo/target/jar/target/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar</tt></pre></div></div>
<div class="paragraph"><p>Listing the contents of the JAR file using the <strong><span class="monospaced">unzip</span></strong> command,<span class="footnote"><br>[Available on most Unix-based systems.]<br></span> you can see that very
little is packaged&#8212;just a Maven <em>.pom</em> file, generated JVM class files,
and the project&#8217;s miscellany:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ unzip -l target/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar
Archive<span style="color: #990000">:</span>  target/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar
  Length     Date   Time    Name
 --------    ----   ----    ----
      <span style="color: #993399">113</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/MANIFEST<span style="color: #990000">.</span>MF
     <span style="color: #993399">2595</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/maven/foo/foo/pom<span style="color: #990000">.</span>xml
       <span style="color: #993399">91</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/maven/foo/foo/pom<span style="color: #990000">.</span>properties
      <span style="color: #993399">292</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/leiningen/foo/foo/project<span style="color: #990000">.</span>clj
      <span style="color: #993399">292</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   project<span style="color: #990000">.</span>clj
      <span style="color: #993399">229</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/leiningen/foo/foo/README<span style="color: #990000">.</span>md
    <span style="color: #993399">11220</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   META-INF/leiningen/foo/foo/LICENSE
        <span style="color: #993399">0</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo<span style="color: #990000">/</span>
     <span style="color: #993399">1210</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo/core<span style="color: #009900">$_main</span><span style="color: #990000">.</span>class
     <span style="color: #993399">1304</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo/core<span style="color: #009900">$fn__16</span><span style="color: #990000">.</span>class
     <span style="color: #993399">1492</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo/core<span style="color: #009900">$loading__4910__auto__</span><span style="color: #990000">.</span>class
     <span style="color: #993399">1755</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo/core<span style="color: #990000">.</span>class
     <span style="color: #993399">2814</span>  <span style="color: #993399">12</span>-<span style="color: #993399">06</span>-<span style="color: #993399">13</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">26</span>   foo/core__init<span style="color: #990000">.</span>class
      <span style="color: #993399">162</span>  <span style="color: #993399">12</span>-<span style="color: #993399">04</span>-<span style="color: #993399">13</span> <span style="color: #993399">14</span><span style="color: #990000">:</span><span style="color: #993399">54</span>   foo/core<span style="color: #990000">.</span>clj
 --------                   -------
    <span style="color: #993399">23569</span>                   <span style="color: #993399">14</span> files</tt></pre></div></div>
<div class="paragraph"><p>The <em>target/foo-0.1.0-SNAPSHOT-standalone.jar</em> listing, on the other
hand, includes over 3,000 files.<span class="footnote"><br>[All of which we won&#8217;t be
committing to print. Take a look for yourself with the command <strong><span class="monospaced">lein
uberjar &amp;&amp; unzip -l target/foo-0.1.0-SNAPSHOT-standalone.jar</span></strong>.]<br></span></p></div>
<div class="paragraph"><p>Since the packaged <em>pom.xml</em> file includes a listing of the project&#8217;s
dependencies, build tools like Leiningen or Maven can resolve these
dependencies on their own. This allows for efficient packaging of
libraries. Can you imagine if each and every Clojure library
included the entirety of its dependencies? It would be a bandwidth
nightmare.</p></div>
<div class="paragraph"><p>Because of this property, lean JAR files such as this are what is
deployed to remote repositories when you use the <span class="monospaced">lein deploy</span>
command.<span class="footnote"><br>[See <a href="#sec_deploy_clojars">[sec_deploy_clojars]</a>, for more information on
releasing libraries.]<br></span></p></div>
<div class="paragraph"><p>Without its dependencies included&#8212;namely, Clojure&#8212;you&#8217;ll need to do a bit more
work to run the <em>foo</em> application. First, download <a href="http://clojure.org/downloads">Clojure 1.5.1</a>. Then invoke <span class="monospaced">foo.core</span>  via the <span class="monospaced">java</span>
command, including <em>clojure-1.5.1.jar</em> and <em>foo-0.1.0-SNAPSHOT.jar</em> on the
classpath (via the <span class="monospaced">-cp</span> option):</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Download Clojure</span></span>
$ wget <span style="color: #990000">\</span>
  http<span style="color: #990000">:</span>//repo<span style="color: #993399">1</span><span style="color: #990000">.</span>maven<span style="color: #990000">.</span>org/maven<span style="color: #993399">2</span>/org/clojure/clojure<span style="color: #990000">/</span><span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/clojure-<span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>zip
$ unzip clojure-<span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>zip

<span style="font-style: italic"><span style="color: #9A1900"># Execute the application</span></span>
$ java -cp target/foo-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar<span style="color: #990000">:</span>clojure-<span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/clojure-<span style="color: #993399">1.5</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>jar <span style="color: #990000">\</span>
       foo<span style="color: #990000">.</span>core <span style="color: #990000">\</span>
       <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span>
Executed with the following args<span style="color: #990000">:</span>  <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_145">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_command_line_applications">[sec_command_line_applications]</a>, to learn about running Clojure programs from Leiningen
</p>
</li>
<li>
<p>
<a href="#sec_aot_compilation">[sec_aot_compilation]</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/Raynes/lein-bin"><span class="monospaced">lein-bin</span></a>, a Leiningen plug-in for
  producing standalone console executables that work on OS X, Linux, and
  Windows
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_war_file">Creating a WAR File</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_147">Problem</h4>
<div class="paragraph"><p>You want to deploy a Clojure web application built using Ring as a
standard web archive (WAR) file in a commonly used Java EE container
such as Tomcat, JBoss, or WebLogic.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_145">Solution</h4>
<div class="paragraph"><p>Assuming you are using Ring or a framework based on Ring (such as
Compojure), the easiest way to structure your project to build as a
WAR file is to use the <span class="monospaced">lein-ring</span> plug-in for Leiningen. Say that your project has a Ring handler function defined in a
namespace called <span class="monospaced">warsample.core</span>,<span class="footnote"><br>[If you don&#8217;t happen to already have a similarly named project, and you want to follow along, create a new one with <strong><span class="monospaced">lein new warsample</span></strong>.]<br></span> like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> warsample<span style="color: #990000">.</span>core<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handler <span style="color: #990000">[</span>request<span style="color: #990000">]</span>
  {<span style="color: #990000">:</span>status <span style="color: #993399">200</span>
   <span style="color: #990000">:</span>headers {<span style="color: #FF0000">"content-type"</span> <span style="color: #FF0000">"text/html"</span>}
   <span style="color: #990000">:</span>body <span style="color: #FF0000">"&lt;h1&gt;Hello, world!&lt;/h1&gt;"</span>}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To configure the project with <span class="monospaced">lein-ring</span>, add the following key/value
pairs to your Leiningen <em>project.clj</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>plugins <span style="color: #990000">[[</span>lein<span style="color: #990000">-</span>ring <span style="color: #FF0000">"0.8.8"</span><span style="color: #990000">]]</span>
<span style="color: #990000">:</span>ring {<span style="color: #990000">:</span>handler warsample<span style="color: #990000">.</span>core<span style="color: #990000">/</span>handler}</tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll also need to make sure that your application declares a
dependency on the <span class="monospaced">javax.servlet/servlet-api</span> library. Most web app libraries
do include a transitive dependency, which you can verify by running
<strong><span class="monospaced">lein deps :tree</span></strong>. If no other library you&#8217;re using includes it, you
can include it yourself by adding <span class="monospaced">[javax.servlet/servlet-api "2.5"]</span>
to the <span class="monospaced">:dependencies</span> key in <em>project.clj</em>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">:plugins</span> key specifies that the project uses the <span class="monospaced">lein-ring</span>
plug-in, and the map under the <span class="monospaced">:ring</span> key specifies configuration
options specific to <span class="monospaced">lein-ring</span>. The only required option is
<span class="monospaced">:handler</span>, which indicates the var name of the application&#8217;s primary
Ring handler function.</p></div>
<div class="paragraph"><p><span class="monospaced">lein-ring</span> provides a handy way to run your application locally, for
development and testing. At the command line, simply type:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein ring server</tt></pre></div></div>
<div class="paragraph"><p>An embedded Jetty server will be started, serving your Ring
application (on port 3000 by default, though you can change this in
the <span class="monospaced">lein-ring</span> options). It will also open your operating system&#8217;s
default browser to that page.</p></div>
<div class="paragraph"><p>Once you think the application is running correctly, you can build a
WAR file using the <strong><span class="monospaced">lein ring war</span></strong> or <strong><span class="monospaced">lein ring uberwar</span></strong>
commands. Both take the name of the WAR file to emit:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein ring war warsample<span style="color: #990000">.</span>war</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein ring uberwar warsample-with-deps<span style="color: #990000">.</span>war</tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">lein ring war</span> builds a WAR file containing only your application
code, not any transitive dependencies, whereas <span class="monospaced">lein ring uberwar</span> will build a WAR file containing bundled JAR files for every
dependency as well.</p></div>
<div class="paragraph"><p>Both these commands will generate all the necessary configuration and
wiring (such as a <em>WEB-INF</em> directory and a <em>web.xml</em> file) before
building the WAR. See the discussion section for some options you can
pass to <span class="monospaced">lein ring</span> that will influence how these artifacts are
generated.</p></div>
<div class="paragraph"><p>After issuing the WAR build command, you will find the WAR file you
created in your project&#8217;s <em>target</em> directory. This is a perfectly
normal WAR file that you can deploy just as if it were a standard J2EE
WAR. Every application server is different, so check the documentation
for your preferred system to see how to deploy a WAR file. If you have
an operations team responsible for production deployments, you will
definitely want to check with them to make sure you adhere to their
processes and best practices.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_147">Discussion</h4>
<div class="paragraph"><p>It is crucial to understand the difference between a bare WAR file
generated using <span class="monospaced">lein ring war</span> and an "uberwar" generated by <span class="monospaced">lein
ring uberwar</span>, and when to use each.</p></div>
<div class="paragraph"><p>A bare WAR file does not contain any of your project&#8217;s dependencies; it contains
only the application code itself. This means that your program will
<em>not work</em> unless you make sure that each and every JAR file your
program depends on, <em>including Clojure itself</em>, is present on your web
application&#8217;s shared library path. Exactly how to do this depends on
the application server you&#8217;re using&#8212;you&#8217;ll have to refer to your
system&#8217;s documentation to determine how to make them available.</p></div>
<div class="paragraph"><p>An "uberwar," on the other hand, includes all the JARs your program
depends on in the WAR archive as a <em>bundled library</em> under the
<em>WEB-INF/lib</em> subfolder. Compliant application servers are capable of
running each application (each deployed WAR file) in its own
class loader context and will make the bundled JARs available only to
their applications.</p></div>
<div class="paragraph"><p>Typically, an uberwar is a safer choice. It spares you from much of
the effort of manually curating your libraries, and better reflects
how your application&#8217;s classpath probably looked in development.</p></div>
<div class="paragraph"><p>The cost of an uberwar, however, is that a single library may be
loaded multiple times if it is bundled by multiple applications. If
you are running 10 applications, all of which use (say) Compojure,
the server will actually load the Compojure code into the JVM&#8217;s
class space 10 times, once for each application. Some organizations
running resource-constrained or high-performance deployments prefer to
ensure that there is minimal redundancy in application
dependencies. If this is the case, then you may have to fall back to
using a non-uber WAR file and managing your dependencies in your
application server&#8217;s shared library pool by hand.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Dependency Collisions</div>
<div class="paragraph"><p>Although modern J2EE application servers do a pretty good job of
keeping the classpaths and bundled libraries of different applications
isolated from one another, you do have to be careful of the scenario
where your application depends on a library that is part of the core
J2EE <em>platform</em>, such as JDBC, the Servlet API, various XML libraries
like <phrase role='keep-together'>JAX-*</phrase>, StAX, JMS, etc.</p></div>
<div class="paragraph"><p>These classes are usually provided by the application container
itself, and if your application refers to them, those references will resolve to the
instance provided by the container rather than the version your
application has bundled. If they are exactly the same, well and good;
but if there is a version mismatch that includes breaking changes in
the class API, you may encounter cryptic errors as your application
tries to call into classes that are different than the ones it was
built against.</p></div>
<div class="paragraph"><p>In this scenario, you will need to reconcile the dependency versions
used by your application container and your application to make sure
they are compatible.</p></div>
</div></div>
<div class="sect4">
<h5 id="_other_lein_ring_options">Other lein-ring options</h5>
<div class="paragraph"><p><span class="monospaced">lein-ring</span> provides some additional options you can set in the
<span class="monospaced">:ring</span> configuration map in <em>project.clj</em> to fine-tune how WAR files
are generated. For an exhaustive description, see the <span class="monospaced">lein-ring</span>
<a href="https://github.com/weavejester/lein-ring">project page</a>.</p></div>
<div class="paragraph"><p>A few of the more useful ones are shown in <a href="#table8-1">[table8-1]</a>.</p></div>
<table class="tableblock frame-all grid-all" id="table8-1"
style="
width:100%;
">
<caption class="title">Table 3. <em>lein-ring</em> WAR options</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Key</th>
<th class="tableblock halign-left valign-top" >Description</th>
<th class="tableblock halign-left valign-top" >Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:war-exclusions</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A sequence of regexes of files to exclude from the target WAR</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">All hidden files</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:servlet-class</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The name of the generated <span class="monospaced">Servlet</span> class</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:servlet-name</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The name of the servlet in <em>web.xml</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The name of the handler function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:url-pattern</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The URL of the servlet mapping in <em>web.xml</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">/*</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:web-xml</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A specific <em>web.xml</em> file to use instead of the generated one</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_building_war_files_from_scratch">Building WAR files from scratch</h5>
<div class="paragraph"><p>If you aren&#8217;t using Ring, or if you have a good reason not to use the
<span class="monospaced">lein-ring</span> plug-in, you can still create a WAR file, but the process
is much more hands-on. Fortunately, a WAR file is essentially a JAR
file with a different extension and some additional internal structure
and configuration files, so you can use the standard <span class="monospaced">lein jar</span> tool
to generate one&#8212;provided you add the following files at the
appropriate locations in the archive.</p></div>
<div class="paragraph"><p>You&#8217;ll also need to define some AOT classes implementing
<span class="monospaced">javax.servlet.Servlet</span> yourself, and have these call into your
Clojure application. Then you&#8217;ll need to wire them up to the
application server using a deployment descriptor (<em>web.xml</em>).</p></div>
<div class="paragraph"><p>The structure of a WAR file is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&lt;war root&gt;
|-- &lt;static resources&gt;
|-- WEB-INF
    |-- web.xml
    |-- &lt;app-server-specific deployment descriptors&gt;
    |-- lib
    |   |-- &lt;bundled JAR libraries&gt;
    |-- classes
        |-- &lt;AOT compiled .class files for servlets, etc.&gt;
        |-- &lt;.clj source files&gt;</pre>
</div></div>
<div class="paragraph"><p>A full explanation of all of these elements is beyond the scope of
this recipe. For more information, see Oracle&#8217;s J2EE
<a href="http://bit.ly/java-wars">tutorial</a>
on packaging web archives.</p></div>
<div class="paragraph"><p>Other web server libraries (for example, Pedestal Server) that include
tooling for Leiningen will also often have a utility for building WAR
files&#8212;check the documentation of the library you&#8217;re using.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_146">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_aot_compilation">[sec_aot_compilation]</a>
</p>
</li>
<li>
<p>
<a href="#sec_packaging_jars">[sec_packaging_jars]</a>
</p>
</li>
<li>
<p>
<span class="monospaced">lein-ring</span>'s <a href="https://github.com/weavejester/lein-ring">project page</a>
</p>
</li>
<li>
<p>
Oracle&#8217;s J2EE <a href="http://bit.ly/javaee-tut">tutorial</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_daemons">Running an Application as a Daemon</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_148">Problem</h4>
<div class="paragraph"><p>You want to run a Clojure application as a daemon (i.e., you want your application to run in the background) in another system process.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_146">Solution</h4>
<div class="paragraph"><p>Use the Apache Commons Daemon library to write applications that can
be executed in a background process. Daemon consists of two parts: the
<span class="monospaced">Daemon</span> interface, which your application must implement, and a
system application<span class="footnote"><br>[<span class="monospaced">jsvc</span> on Unix systems; <span class="monospaced">procrun</span> on
Windows.]<br></span> that runs <span class="monospaced">Daemon</span>-compliant applications as
daemons.</p></div>
<div class="paragraph"><p>Begin by adding the Daemon dependency to your project&#8217;s <em>project.clj</em>
file. If you don&#8217;t have an existing project, create a new one with the
command <strong><span class="monospaced">lein new my-daemon</span></strong>. Since Daemon is a Java-based system,
enable AOT compilation so that class files are generated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> my<span style="color: #990000">-</span>daemon <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>commons<span style="color: #990000">/</span>commons<span style="color: #990000">-</span>daemon <span style="color: #FF0000">"1.0.9"</span><span style="color: #990000">]]</span>
  <span style="color: #990000">:</span>main my<span style="color: #990000">-</span>daemon<span style="color: #990000">.</span>core
  <span style="color: #990000">:</span>aot <span style="color: #990000">:</span>all<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To implement the <span class="monospaced">org.apache.commons.daemon.Daemon</span> interface, add the
appropriate <span class="monospaced">:gen-class</span> declaration and interface functions to one of
your project&#8217;s namespaces. For a minimally functional daemon,
implement <span class="monospaced">-init</span>, <span class="monospaced">-start</span>, and <span class="monospaced">-stop</span>. For best results, provide a
<span class="monospaced">-main</span> function to enable smoke testing of your application without
touching the <span class="monospaced">Daemon</span> interface:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> my<span style="color: #990000">-</span>daemon<span style="color: #990000">.</span>core
  <span style="color: #990000">(:</span>import <span style="color: #990000">[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>commons<span style="color: #990000">.</span>daemon Daemon DaemonContext<span style="color: #990000">])</span>
  <span style="color: #990000">(:</span>gen<span style="color: #990000">-</span>class
    <span style="color: #990000">:</span>implements <span style="color: #990000">[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>commons<span style="color: #990000">.</span>daemon<span style="color: #990000">.</span>Daemon<span style="color: #990000">]))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; A crude approximation of your application's state</span></span>
<span style="font-weight: bold"><span style="color: #000000">(def</span></span> state <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> {}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> init <span style="color: #990000">[</span>args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> state assoc <span style="color: #990000">:</span>running true<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> start <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(while</span></span> <span style="color: #990000">(:</span>running @state<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"tick"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(Thread</span></span><span style="color: #990000">/</span>sleep <span style="color: #993399">2000</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> stop <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> state assoc <span style="color: #990000">:</span>running false<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Daemon implementation</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>init <span style="color: #990000">[</span>this <span style="color: #990000">^</span>DaemonContext context<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(init</span></span> <span style="color: #990000">(.</span>getArguments context<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>start <span style="color: #990000">[</span>this<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(future</span></span> <span style="font-weight: bold"><span style="color: #000000">(start</span></span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>stop <span style="color: #990000">[</span>this<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(stop</span></span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>destroy <span style="color: #990000">[</span>this<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Enable command-line invocation</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(init</span></span> args<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(start</span></span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Package all of the necessary dependencies and generated classes by
invoking the Leiningen <span class="monospaced">uberjar</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein uberjar
Compiling my-daemon<span style="color: #990000">.</span>core
Created /tmp/my-daemon/target/my-daemon-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar
Created /tmp/my-daemon/target/my-daemon-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT-standalone<span style="color: #990000">.</span>jar</tt></pre></div></div>
<div class="paragraph"><p>Before proceeding, test your application by running it with <span class="monospaced">java</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -jar target/my-daemon-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT-standalone<span style="color: #990000">.</span>jar
tick
tick
tick
<span style="font-style: italic"><span style="color: #9A1900"># ... Type Ctrl-C to stop the madness</span></span></tt></pre></div></div>
<div class="paragraph"><p>Once you&#8217;ve verified your application works correctly, install <span class="monospaced">jsvc</span>.<span class="footnote"><br>[On OS X we suggest using <a href="http://brew.sh/">Homebrew</a> to
<span class="monospaced">brew install jsvc</span>. If you&#8217;re using Linux, you&#8217;ll likely find a
<span class="monospaced">jsvc</span> package in your favorite package manager. Windows users will
need to install and use
<a href="http://bit.ly/daemons-procrun"><span class="monospaced">procrun</span></a>.]<br></span>
Finally, the moment of truth. Run your application as a daemon by
invoking <span class="monospaced">jsvc</span> with all of the requisite parameters&#8212;the absolute
path of your Java home directory, the uberjar, the output log file, and the
namespace where your <span class="monospaced">Daemon</span> implementation resides:<span class="footnote"><br>[Don&#8217;t
worry, we&#8217;ll capture all this in a shell script soon.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ sudo jsvc -java-home <span style="color: #FF0000">"$JAVA_HOME"</span> <span style="color: #990000">\</span>
            -cp <span style="color: #FF0000">"$(pwd)/target/my-daemon-0.1.0-SNAPSHOT-standalone.jar"</span> <span style="color: #990000">\</span>
            -outfile <span style="color: #FF0000">"$(pwd)/out.txt"</span> <span style="color: #990000">\</span>
            my_daemon<span style="color: #990000">.</span>core
<span style="font-style: italic"><span style="color: #9A1900"># Nothing!</span></span>

$ sudo tail -f out<span style="color: #990000">.</span>txt
tick
tick
tick
<span style="font-style: italic"><span style="color: #9A1900"># ... Ctrl-C to exit</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Quit the daemonized process by adding the -stop flag</span></span>
$ sudo jsvc -java-home <span style="color: #FF0000">"$JAVA_HOME"</span> <span style="color: #990000">\</span>
            -cp <span style="color: #FF0000">"$(pwd)/target/my-daemon-0.1.0-SNAPSHOT-standalone.jar"</span> <span style="color: #990000">\</span>
            -stop <span style="color: #990000">\</span>
            my_daemon<span style="color: #990000">.</span>core</tt></pre></div></div>
<div class="paragraph"><p>If all is well, <em>out.txt</em> should now contain a couple of ticks.
Congratulations! Daemon can be a little hard to get set up, but once
you have it running, it works fantastically. If you encounter any
problems launching a daemon using <span class="monospaced">jsvc</span>, use the <span class="monospaced">-debug</span> flag to
output more detailed diagnostic information.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>You&#8217;ll find a full working copy of the <span class="monospaced">my-daemon</span> project at <a href="https://github.com/clojure-cookbook/my-daemon">https://github.com/clojure-cookbook/my-daemon</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_148">Discussion</h4>
<div class="paragraph"><p>Have no illusions, daemonizing Java-based services is <em>hard</em>; yet, for
over 10 years, Java developers have been using Apache Commons Daemon
to this end. Why reinvent the wheel with a separate Clojure tool? One
of Clojure&#8217;s core strengths is its ability to breathe new life into old
tunes, and Daemon is one such "old tune."</p></div>
<div class="paragraph"><p>Not all tunes are created equal, however. Where some Java libraries
require a little Java interop, Daemon requires a lot. Daemonizing an
application with Apache Commons Daemon requires getting two parts
<em>just right</em>. The first part is creating a class that implements the <span class="monospaced">Daemon</span>
interface and packaging it as a JAR file. The <span class="monospaced">Daemon</span> interface
consists of four methods, called at different points in an daemonized
application&#8217;s life cycle:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">init(DaemonContext context)</span>
</dt>
<dd>
<p>
Invoked as your application is
  initializing. This is where you should set up any initial state for
  your application.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">start()</span>
</dt>
<dd>
<p>
Invoked after <span class="monospaced">init</span>. This is where you should begin
  performing work. <span class="monospaced">jsvc</span> expects <span class="monospaced">start()</span> to complete quickly, so
  you should kick-off work in a <span class="monospaced">future</span> or Java <span class="monospaced">Thread</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">stop()</span>
</dt>
<dd>
<p>
Invoked when a daemon has been instructed to stop. This
  is where you should halt whatever processing you began in <span class="monospaced">start</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">destroy()</span>
</dt>
<dd>
<p>
Invoked after <span class="monospaced">stop</span>, but before the JVM process
  exits. In a traditional Java program, this is where you would free
  any resources you had acquired. You may be able to skip this method in
  Clojure applications if you&#8217;ve properly structured your application. It
  doesn&#8217;t hurt to include an empty function to prevent <span class="monospaced">jsvc</span> from complaining.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>It&#8217;s easy enough to create a record (with <span class="monospaced">defrecord</span>) that implements
the <span class="monospaced">Daemon</span> interface&#8212;but that isn&#8217;t enough. <span class="monospaced">jsvc</span> expects
a <span class="monospaced">Daemon</span>-implementing <em>class</em> to exist on the classpath. To provide
this, you must do two things: first, you need to enable ahead-of-time
(AOT) compilation for your project&#8212;setting <span class="monospaced">:aot :all</span> in your
<em>project.clj</em> will accomplish this. Second, you need to commandeer a
namespace to produce a class via the <span class="monospaced">:gen-class</span> namespace directive.
More specifically, you need to generate a class that implements the
<span class="monospaced">Daemon</span> interface. This is accomplished easily enough using
<span class="monospaced">:gen-class</span> in conjunction with the <span class="monospaced">:implements</span> directive:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> my<span style="color: #990000">-</span>daemon<span style="color: #990000">.</span>core
  <span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
  <span style="color: #990000">(:</span>gen<span style="color: #990000">-</span>class
    <span style="color: #990000">:</span>implements <span style="color: #990000">[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>commons<span style="color: #990000">.</span>daemon<span style="color: #990000">.</span>Daemon<span style="color: #990000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>Having set up <span class="monospaced">my-daemon.core</span> to generate a <span class="monospaced">Daemon</span>-implementing
class upon compilation, the only thing left is to implement the
methods themselves. Prefacing a function with a dash (e.g., <span class="monospaced">-start</span>)
indicates to the Clojure compiler that a function is in fact a Java
method. Further, since the <span class="monospaced">Daemon</span> methods are <em>instance</em> methods,
each function includes one additional argument, the present <span class="monospaced">Daemon</span>
instance. This argument is traditionally denoted with the name <span class="monospaced">this</span>.</p></div>
<div class="paragraph"><p>In our simple <span class="monospaced">my-daemon</span> example, most of the method implementations
are rather plain, taking no arguments other than <span class="monospaced">this</span> and delegating
work to regular Clojure functions. <span class="monospaced">-init</span> deserves a bit more
attention, though:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>init <span style="color: #990000">[</span>this <span style="color: #990000">^</span>DaemonContext context<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(init</span></span> <span style="color: #990000">(.</span>getArguments context<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">-init</span> method takes an additional argument: a <span class="monospaced">DaemonContext</span>.
This argument captures the command-line arguments the daemon was
started with in its <span class="monospaced">.getArguments</span> property. As implemented, <span class="monospaced">-init</span>
invokes the <span class="monospaced">.getArguments</span> method on <span class="monospaced">context</span>, passing its return value
along to the regular Clojure function <span class="monospaced">init</span>.</p></div>
<div class="paragraph"><p>On that topic, why delegate every <span class="monospaced">Daemon</span> implementation to a
separate Clojure function? By separating participation in the <span class="monospaced">Daemon</span>
interface from the inner workings of your application, you retain the
ability to invoke it in other ways. With this separation of concerns,
it becomes much easier to test your application, via either integration tests or direct invocation. The <span class="monospaced">-main</span> function utilizes
these Clojure functions to allow you to verify that your application
behaves correctly in isolation of daemonization.</p></div>
<div class="paragraph"><p>With all of the groundwork for a Daemon-compliant application laid,
the only remaining step is packaging the application.
Leiningen&#8217;s <span class="monospaced">uberjar</span> command completes all of the necessary
preparations for running your application as a daemon: compiling
<span class="monospaced">my-daemon.core</span> to a class, gathering dependencies, and packaging them
all into a standalone JAR file.</p></div>
<div class="paragraph"><p>Last but not least, you need to run the darn thing. Since JVM
processes don&#8217;t generally play nicely with low-level system calls,
Daemon provides system applications, <span class="monospaced">jsvc</span> and <span class="monospaced">procrun</span>, that
act as intermediaries between the JVM and your computer&#8217;s operating
system. These applications, generally written in C, are capable of
invoking the appropriate system calls to fork and execute your
application in a background process. For simplicity, we&#8217;ll limit our
discussion to the <span class="monospaced">jsvc</span> tool for the remainder of the recipe.</p></div>
<div class="paragraph"><p>Both of these tools have a dizzying number of configuration options,
but only a handful of them are actually necessary for getting the ball
rolling. At a minimum, you must provide the location of your
standalone JAR (<span class="monospaced">-cp</span>), your Java installation (<span class="monospaced">-java-home</span>), and the
desired class to execute (the final argument). Other relevant options
include <span class="monospaced">-pidfile</span>, <span class="monospaced">-outfile</span>, and <span class="monospaced">-errfile</span>; these specify where the
process&#8217;s ID, <span class="monospaced">STDOUT</span>, and <span class="monospaced">STDERR</span> output will be written to,
respectively. Any arguments following the name of the class to invoke
will be passed into <span class="monospaced">-init</span> as a <span class="monospaced">DaemonContext</span>.</p></div>
<div class="listingblock">
<div class="title">A more complete example:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ sudo jsvc -java-home <span style="color: #FF0000">"$JAVA_HOME"</span> <span style="color: #990000">\</span>
            -cp <span style="color: #FF0000">"$(pwd)/target/my-daemon-0.1.0-SNAPSHOT-standalone.jar"</span> <span style="color: #990000">\</span>
            -pidfile /var/run/my-daemon<span style="color: #990000">.</span>pid <span style="color: #990000">\</span>
            -outfile <span style="color: #FF0000">"/var/log/my-daemon.out"</span> <span style="color: #990000">\</span>
            -errfile <span style="color: #FF0000">"/var/log/my-daemon.err"</span> <span style="color: #990000">\</span>
            my_daemon<span style="color: #990000">.</span>core <span style="color: #990000">\</span>
            <span style="color: #FF0000">"arguments"</span> <span style="color: #FF0000">"to"</span> <span style="color: #FF0000">"my-daemon.core"</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Once you&#8217;ve started a daemon with <span class="monospaced">jsvc</span>, you can halt it by
re-running <span class="monospaced">jsvc</span> with the <span class="monospaced">-stop</span> option included.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Since <span class="monospaced">jsvc</span> <em>relaunches</em> your application in a completely new
process, it carries none of its original execution context. This means
no environment variables, no current working directory, nothing; the
process may not even be running as the same user. Because of this, it
is extremely important to specify arguments to <span class="monospaced">jsvc</span> with their
absolute paths and correct permissions in place.</p></div>
<div class="paragraph"><p>For our sample, we&#8217;ve opted to use <span class="monospaced">sudo</span> to make this a less
painful experience, but in production you should set up a separate
user with more limited permissions. The running user should have write
access to the <em>.pid</em>, <em>.out</em>, and <em>.err</em> files, and read access to Java and the
classpath.</p></div>
<div class="paragraph"><p><span class="monospaced">jsvc</span> and its ilk can be fickle beasts&#8212;the slightest
misconfiguration will cause your daemon to fail silently, without
warning. We highly suggest using the <span class="monospaced">-debug</span> and <span class="monospaced">-nodetach</span> flags
while developing and configuring your daemon until you&#8217;re <em>sure</em>
things work correctly.</p></div>
<div class="paragraph"><p>Once you&#8217;ve nailed an appropriate configuration, the final step is to
automate the management of your daemon by writing a <em>daemon script</em>. A
good daemon script captures configuration parameters, file paths, and
common operations, exposing them in a clean, noise-free skin. Instead
of the long <span class="monospaced">jsvc</span> commands you executed before, you would simply
invoke <strong><span class="monospaced">my-daemon start</span></strong> or <strong><span class="monospaced">my-daemon stop</span></strong>. In fact, many Linux
distributions use similar scripts to manage system daemons. To
implement your own <span class="monospaced">jsvc</span> daemon script, we suggest reading Sheldon
Neilson&#8217;s <a href="http://www.neilson.co.za/?p=253">"Creating a Java Daemon (System Service) for Debian using Apache Commons Jsvc"</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_147">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">Daemon</span>
  <a href="http://bit.ly/commons-api">documentation</a>
</p>
</li>
<li>
<p>
The contents of the <span class="monospaced">jsvc</span> manpage, accessible via <strong><span class="monospaced">jsvc
  -help</span></strong>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/daemons-procrun"><span class="monospaced">procrun</span></a>, a Daemon runner for Windows
</p>
</li>
<li>
<p>
<a href="https://github.com/arohner/lein-daemon"><span class="monospaced">lein-daemon</span></a>, a Leiningen
  plug-in for creating daemons that can be managed via a <span class="monospaced">lein
  daemon</span> command inside your project
</p>
</li>
<li>
<p>
<a href="#sec_aot_compilation">[sec_aot_compilation]</a>, for more information on AOT compilation
</p>
</li>
<li>
<p>
<a href="#sec_packaging_jars">[sec_packaging_jars]</a>, for more information on packaging JAR files
</p>
</li>
<li>
<p>
Meikel Brandmeyer&#8217;s blog post <a href="http://bit.ly/gen-class-post">"gen-class&#8212;how it works and how to use it"</a>
</p>
</li>
<li>
<p>
Stuart Sierra&#8217;s <a href="https://github.com/stuartsierra/component">Component</a>
  library, a tiny framework for managing the life cycle of software
  components
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_primitives_math_type_hinting">Alleviating Performance Problems with Type Hinting</h3>
<div class="paragraph byline"><p>by Ryan Neufeld</p></div>
<div class="sect3">
<h4 id="_problem_149">Problem</h4>
<div class="paragraph"><p>You have functions that get called very often, and you want to optimize performance for those methods.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_147">Solution</h4>
<div class="paragraph"><p>One of the easiest ways to increase performance for a given function
is to eliminate Java reflection. Enable <span class="monospaced">warn-on-reflection</span> to
diagnose excessive reflection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> column<span style="color: #990000">-</span>idx
  <span style="color: #FF0000">"Return the index number of a column in a CSV header row"</span>
  <span style="color: #990000">[</span>header<span style="color: #990000">-</span>cols col<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>indexOf <span style="font-weight: bold"><span style="color: #000000">(vec</span></span> header<span style="color: #990000">-</span>cols<span style="color: #990000">)</span> col<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> headers <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>string<span style="color: #990000">/</span>split <span style="color: #FF0000">"A,B,C"</span> #<span style="color: #FF0000">","</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">(column</span></span><span style="color: #990000">-</span>idx headers <span style="color: #FF0000">"B"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 1</span></span>

<span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">!</span> <span style="color: #990000">*</span>warn<span style="color: #990000">-</span>on<span style="color: #990000">-</span>reflection<span style="color: #990000">*</span> true<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> column<span style="color: #990000">-</span>idx
  <span style="color: #FF0000">"Return the index number of a column in a CSV header row"</span>
  <span style="color: #990000">[</span>header<span style="color: #990000">-</span>cols col<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>indexOf <span style="font-weight: bold"><span style="color: #000000">(vec</span></span> header<span style="color: #990000">-</span>cols<span style="color: #990000">)</span> col<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; Reflection warning, NO_SOURCE_PATH:1:1 - call to indexOf can't be resolved.</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; 100,000 non-hinted executions...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(time</span></span> <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">100000</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(column</span></span><span style="color: #990000">-</span>idx headers <span style="color: #FF0000">"B"</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; "Elapsed time: 329.258 msecs"</span></span></tt></pre></div></div>
<div class="paragraph"><p>Once you&#8217;ve identified reflection, add type hints to your argument
list preceding each argument in the form <span class="monospaced">&lt;^Type&gt; &lt;arg&gt;</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> column<span style="color: #990000">-</span>idx
  <span style="color: #FF0000">"Return the index number of a column in a CSV header row"</span>
  <span style="color: #990000">[^</span>java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>List header<span style="color: #990000">-</span>cols col<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>indexOf header<span style="color: #990000">-</span>cols col<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; 100,000 properly hinted executions</span></span>
<span style="font-weight: bold"><span style="color: #000000">(time</span></span> <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">100000</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(column</span></span><span style="color: #990000">-</span>idx headers <span style="color: #FF0000">"B"</span><span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; "Elapsed time: 27.779 msecs"</span></span></tt></pre></div></div>
<div class="paragraph"><p>When you have groups of functions that interact together, you may see
reflection warnings in spite of your properly hinted arguments.
Add type hints to the argument list itself to hint the types of the
functions' return values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; As a simple example, imagine you want to compare the result</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; of two function calls</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> some<span style="color: #990000">-</span>calculation <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> same<span style="color: #990000">-</span>calc<span style="color: #990000">?</span> <span style="color: #990000">[</span>x y<span style="color: #990000">]</span> <span style="color: #990000">(.</span>equals <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>calculation x<span style="color: #990000">)</span>
                                <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>calculation y<span style="color: #990000">)))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; Reflection warning, NO_SOURCE_PATH:1:24 - call to equals can't be resolved.</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Now type-hint the return value of some-calculation</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> some<span style="color: #990000">-</span>calculation <span style="color: #990000">^</span>Integer <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> same<span style="color: #990000">-</span>calc<span style="color: #990000">?</span> <span style="color: #990000">[</span>x y<span style="color: #990000">]</span> <span style="color: #990000">(.</span>equals <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>calculation x<span style="color: #990000">)</span>
                                <span style="font-weight: bold"><span style="color: #000000">(some</span></span><span style="color: #990000">-</span>calculation y<span style="color: #990000">)))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Look Ma, no reflection warnings!</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_149">Discussion</h4>
<div class="paragraph"><p>In highly performant code, it is often the case that you&#8217;ll choose to
fall back to Java for increased performance. There is an impedance
mismatch between Clojure and Java, however; Java is strongly typed,
whereas Clojure is not. Because of this, (almost) every time you
invoke a Java function in Clojure, it needs to reflect on the type of
the provided arguments in order to select the appropriate Java method
to invoke. For seldom-invoked methods, this isn&#8217;t too big of a deal,
but for methods executed frequently, the cost of reflection can pile up
quickly.</p></div>
<div class="paragraph"><p>Type hinting short-circuits this reflection. If you&#8217;ve hinted <em>all</em> of
the arguments to a Java function, the Clojure compiler will no longer
perform reflection. Instead, the function application will directly
invoke the appropriate Java function. Of course, if you&#8217;ve gotten your
types wrong, your methods may not work properly; improperly hinted
functions may throw a type-cast exception.</p></div>
<div class="paragraph"><p><?dbhtml orphans="4"?>What about when you have a sequence of values, all of a uniform type? Clojure
provides a number of special hints for these cases, namely <span class="monospaced">^</span><span class="monospaced">ints</span>, <span class="monospaced">^</span><span class="monospaced">floats</span>,
<span class="monospaced">^</span><span class="monospaced">longs</span>, and <span class="monospaced">^</span><span class="monospaced">doubles</span>. Hinting these types will allow you to pass
whole arrays as arguments to Java functions and not provoke reflection
for sequences.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Unchecked Math</div>
<div class="paragraph"><p>You may have noticed Clojure puts training wheels on all of its
numeric types too, upgrading types liberally to avoid overflows. This
isn&#8217;t without a cost, of course, as Clojure needs to check on every
operation to make sure you aren&#8217;t overflowing containers. If you need
even more to-the-metal performance and happen to have nerves of steel
yourself, then you may want to look at <em>unchecked math</em>.<span class="footnote"><br>[To
accurately measure performance improvements from <span class="monospaced">unchecked-math</span>, we
suggest using a tool like
<a href="https://github.com/hugoduncan/criterium">Criterium</a>. Benchmarking
code with <span class="monospaced">time</span> can be tricky and often yields misleading results (or none
at all).]<br></span></p></div>
<div class="paragraph"><p>Setting <span class="monospaced">unchecked-math</span> to <span class="monospaced">true</span> will disable this safety, causing
addition, subtraction, multiplication, division, and <span class="monospaced">inc</span>/<span class="monospaced">dec</span> to
occur without overflow checks. This in effect reverts numeric behavior
to a C-like state where it is possible to overflow a positive integer
to a negative one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; With checked math, you cannot overflow an integer</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inc</span></span> Long<span style="color: #990000">/</span>MAX_VALUE<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; ArithmeticException integer overflow  ...</span></span>

<span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">!</span> <span style="color: #990000">*</span>unchecked<span style="color: #990000">-</span>math<span style="color: #990000">*</span> true<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Now integers are free to overflow</span></span>
<span style="font-weight: bold"><span style="color: #000000">(inc</span></span> Long<span style="color: #990000">/</span>MAX_VALUE<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; -9223372036854775808</span></span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">unchecked-math</span> isn&#8217;t absolute, however; it is possible for boxed
types to sneak into your operation, forcing checked math to occur.
Combine <span class="monospaced">unchecked-math</span> with type hinting to ensure your math is
truly unchecked&#8212;at your own risk, of course!</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_148">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#ch_primitive_data">[ch_primitive_data]</a>
</p>
</li>
<li>
<p>
<a href="#sec_deployment_primitive_arrays">[sec_deployment_primitive_arrays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_deployment_primitive_arrays">Fast Math with Primitive Java Arrays</h3>
<div class="paragraph byline"><p>by Jason Wolfe</p></div>
<div class="sect3">
<h4 id="_problem_150">Problem</h4>
<div class="paragraph"><p>You need to perform fast numerical operations over significant amounts
of data.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_148">Solution</h4>
<div class="paragraph"><p>Primitive Java arrays are the canonical way to store large collections
of numbers compactly and do math over them quickly (often 100 times faster
than Clojure sequences). The <a href="https://github.com/Prismatic/hiphip"><span class="monospaced">hiphip</span> (array)</a> library is a
quick and easy way to manipulate primitive arrays of <span class="monospaced">double</span>, <span class="monospaced">long</span>, <span class="monospaced">float</span>, or
<span class="monospaced">int</span> members.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[prismatic/hiphip "0.1.0"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try prismatic/hiphip</tt></pre></div></div>
<div class="paragraph"><p>Use one of <span class="monospaced">hiphip</span>'s <span class="monospaced">amap</span> macros to perform fast math on typed
arrays. <span class="monospaced">amap</span> uses a parallel binding syntax similar to <span class="monospaced">doseq</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'hiphip<span style="color: #990000">.</span><span style="color: #009900">double</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>sqrt <span style="color: #990000">[</span>xs<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(hiphip</span></span><span style="color: #990000">.</span><span style="color: #009900">double</span><span style="color: #990000">/</span>amap <span style="color: #990000">[</span>x xs<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>sqrt x<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">-</span>sqrt <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">5</span><span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (0.0 1.0 1.4142135623730951 1.7320508075688772 2.0)</span></span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> pointwise<span style="color: #990000">-</span>product
  <span style="color: #FF0000">"Produce a new double array with the product of corresponding elements of</span>
<span style="color: #FF0000">  xs and ys"</span>
  <span style="color: #990000">[</span>xs ys<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(hiphip</span></span><span style="color: #990000">.</span><span style="color: #009900">double</span><span style="color: #990000">/</span>amap <span style="color: #990000">[</span>x xs y ys<span style="color: #990000">]</span> <span style="color: #990000">(*</span> x y<span style="color: #990000">)))</span>
<span style="font-weight: bold"><span style="color: #000000">(seq</span></span> <span style="font-weight: bold"><span style="color: #000000">(pointwise</span></span><span style="color: #990000">-</span>product <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">1.0</span> <span style="color: #993399">2.0</span> <span style="color: #993399">3.0</span><span style="color: #990000">])</span>
                        <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">2.0</span> <span style="color: #993399">3.0</span> <span style="color: #993399">4.0</span><span style="color: #990000">])))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (2.0 6.0 12.0)</span></span></tt></pre></div></div>
<div class="paragraph"><p>To modify an array in place, use one of <span class="monospaced">hiphip</span>'s <span class="monospaced">afill!</span> macros:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add<span style="color: #990000">-</span>in<span style="color: #990000">-</span>place<span style="color: #990000">!</span>
  <span style="color: #FF0000">"Modify xs, incrementing each element by the corresponding element of ys"</span>
  <span style="color: #990000">[</span>xs ys<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(hiphip</span></span><span style="color: #990000">.</span><span style="color: #009900">double</span><span style="color: #990000">/</span>afill<span style="color: #990000">!</span> <span style="color: #990000">[</span>x xs y ys<span style="color: #990000">]</span> <span style="color: #990000">(+</span> x y<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>xs <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">1.0</span> <span style="color: #993399">2.0</span> <span style="color: #993399">3.0</span><span style="color: #990000">])]</span>
  <span style="font-weight: bold"><span style="color: #000000">(add</span></span><span style="color: #990000">-</span>in<span style="color: #990000">-</span>place<span style="color: #990000">!</span> xs <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">0.0</span> <span style="color: #993399">1.0</span> <span style="color: #993399">2.0</span><span style="color: #990000">]))</span>
  <span style="font-weight: bold"><span style="color: #000000">(seq</span></span> xs<span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1.0 3.0 5.0)</span></span></tt></pre></div></div>
<div class="paragraph"><p>For faster <span class="monospaced">reduce</span>-like operations, use one of <span class="monospaced">hiphip</span>'s <span class="monospaced">areduce</span> and
<span class="monospaced">asum</span> macros:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> dot<span style="color: #990000">-</span>product <span style="color: #990000">[</span>ws xs<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(hiphip</span></span><span style="color: #990000">.</span><span style="color: #009900">double</span><span style="color: #990000">/</span>asum <span style="color: #990000">[</span>x xs w ws<span style="color: #990000">]</span> <span style="color: #990000">(*</span> x w<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(dot</span></span><span style="color: #990000">-</span>product <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">1.0</span> <span style="color: #993399">2.0</span> <span style="color: #993399">3.0</span><span style="color: #990000">])</span>
             <span style="font-weight: bold"><span style="color: #000000">(double</span></span><span style="color: #990000">-</span>array <span style="color: #990000">[</span><span style="color: #993399">2.0</span> <span style="color: #993399">3.0</span> <span style="color: #993399">4.0</span><span style="color: #990000">]))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 20.0</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We&#8217;d love to throw in a quick <span class="monospaced">time</span> benchmark to demonstrate the
gains, but the JVM is a fickle beast when it comes to optimizations.
We suggest using <a href="https://github.com/hugoduncan/criterium">Criterium</a>
when benchmarking to avoid common pitfalls.</p></div>
<div class="paragraph"><p>To see Criterium benchmarks of <span class="monospaced">hiphip</span>, see
<a href="http://bit.ly/hiphip-bench">w01fe&#8217;s <em>bench.clj</em> gist</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_150">Discussion</h4>
<div class="paragraph"><p>Most of the time, Clojure&#8217;s sequence abstraction is all you need to
get the job done. The preceding <span class="monospaced">dot-product</span> can be written succinctly in
ordinary Clojure, and this is generally what you should try first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> dot<span style="color: #990000">-</span>product <span style="color: #990000">[</span>ws xs<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="color: #990000">*</span> ws xs<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Once you identify a bottleneck in your mathematical operations,
however, primitive arrays may be the only way to go. The preceding
<span class="monospaced">dot-product</span> implementation can be made more than 100 times faster by
using <span class="monospaced">asum</span>, primarily because <span class="monospaced">map</span> produces sequences of
<em>boxed</em> Java <span class="monospaced">Double</span> objects. In addition to the cost of constructing
an intermediate sequence, all arithmetic operations on boxed numbers
are significantly slower than on their primitive counterparts.</p></div>
<div class="paragraph"><p><span class="monospaced">hiphip</span>'s <span class="monospaced">amap</span>, <span class="monospaced">afill!</span>, <span class="monospaced">areduce</span>, and <span class="monospaced">asum</span> macros (among others)
are available for <span class="monospaced">int</span>, <span class="monospaced">long</span>, <span class="monospaced">float</span>, and <span class="monospaced">double</span> types. If you
wanted to use <span class="monospaced">reduce</span> over an array of floats, for example, you would
use <span class="monospaced">hiphip.float/areduce</span>. These macros define the appropriate
type hints and optimizations per type.</p></div>
<div class="paragraph"><p>Clojure also comes with
<a href="http://clojure.org/java_interop#Java%20Interop-Arrays">built-in
functions</a> for operating on arrays, although greater care must be
taken to ensure maximal performance (via appropriate type hints and
use of <span class="monospaced">*unchecked-math*</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(set</span></span><span style="color: #990000">!</span> <span style="color: #990000">*</span>unchecked<span style="color: #990000">-</span>math<span style="color: #990000">*</span> true<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> map<span style="color: #990000">-</span>inc <span style="color: #990000">[^</span>doubles xs<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(amap</span></span> xs i ret <span style="font-weight: bold"><span style="color: #000000">(aset</span></span> ret i <span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="font-weight: bold"><span style="color: #000000">(aget</span></span> xs i<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>Working with primitive arrays in Clojure isn&#8217;t for the faint of heart:
if you don&#8217;t get <em>everything</em> right, you can easily end up with code
that&#8217;s both much uglier and no faster (or even slower) than the
straightforward sequence version. The biggest issue to watch out for
is reflection, which can easily bring you from 100 times faster to 10 times
slower with one small typo or missing type hint.</p></div>
<div class="paragraph"><p>If you&#8217;re up to the challenge, you should keep these tips in mind:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use <span class="monospaced">*warn-on-reflection*</span> religiously, but be aware that it won&#8217;t
  warn you about many of the ways your code can be slow.
</p>
</li>
<li>
<p>
A solid profiler, or at least a comprehensive benchmark suite, is a
  must; otherwise you won&#8217;t know which function is using 99% of your
  runtime.
</p>
</li>
<li>
<p>
Especially if you&#8217;re not using <span class="monospaced">hiphip</span>, experiment with
  <span class="monospaced">*unchecked-math*</span>; it almost always makes your code faster, if
  you&#8217;re willing to give up the safety of overflow checks.
</p>
</li>
<li>
<p>
If you want your array code to go
  <a href="http://bit.ly/lein-tiered-compilation">fast
  under Leiningen</a>, you probably want to add the following to your
  <em>project.clj</em>: <span class="monospaced">:jvm-opts ^:replace []</span>.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_149">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">hiphip</span> comes with a
  <a href="http://bit.ly/hiphip-tests">comprehensive
  suite of benchmarks</a> of its and Clojure&#8217;s array operations for the
  main primitive types, including performance comparisons with
  handcoded Java alternatives.
</p>
</li>
<li>
<p>
<a href="https://github.com/ztellman/vertigo">Vertigo</a> goes beyond simple
  arrays of primitives to full C-style structs, which may be a good
  choice if you need to manipulate structured data (i.e., not just
  sequences of <span class="monospaced">double</span>s) with maximal performance.
</p>
</li>
<li>
<p>
<a href="#sec_primitives_math_type_hinting">[sec_primitives_math_type_hinting]</a>, to learn more about
  type hinting and unchecked math.
</p>
</li>
<li>
<p>
<a href="#sec_profiling_timbre">[sec_profiling_timbre]</a>, to learn about using Timbre to output
  profiling statistics from your code.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_profiling_timbre">Simple Profiling with Timbre</h3>
<div class="paragraph byline"><p>by Ambrose Bonnaire-Sergeant</p></div>
<div class="sect3">
<h4 id="_problem_151">Problem</h4>
<div class="paragraph"><p>You want fine-grained statistics on the running time and invocation
counts of your code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_149">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/ptaoussanis/timbre">Timbre</a> to insert
profiling macros into your code that won&#8217;t incur a performance penalty
in production.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.taoensso/timbre "2.6.3"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>taoensso/timbre</tt></pre></div></div>
<div class="paragraph"><p>Use the macros in the <span class="monospaced">taoensso.timbre.profiling</span> namespace to collect benchmarking metrics in development:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>taoensso<span style="color: #990000">.</span>timbre<span style="color: #990000">.</span>profiling <span style="color: #990000">:</span>as p<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> bench<span style="color: #990000">-</span>me <span style="color: #990000">[</span>f<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>bench<span style="color: #990000">-</span>me
    <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>_ <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>sleep
              <span style="font-weight: bold"><span style="color: #000000">(Thread</span></span><span style="color: #990000">/</span>sleep <span style="color: #993399">10</span><span style="color: #990000">))</span>
          n <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>call<span style="color: #990000">-</span>f<span style="color: #990000">-</span>once
              <span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">))</span>
          _ <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>call<span style="color: #990000">-</span>f<span style="color: #990000">-</span><span style="color: #993399">10</span><span style="color: #990000">-</span>times<span style="color: #990000">-</span>outer
              <span style="font-weight: bold"><span style="color: #000000">(dotimes</span></span> <span style="color: #990000">[</span>_ <span style="color: #993399">10</span><span style="color: #990000">]</span>
                <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>call<span style="color: #990000">-</span>f<span style="color: #990000">-</span><span style="color: #993399">10</span><span style="color: #990000">-</span>times<span style="color: #990000">-</span>inner
                  <span style="font-weight: bold"><span style="color: #000000">(f</span></span><span style="color: #990000">))))]</span>
      <span style="font-weight: bold"><span style="color: #000000">(iterate</span></span> f n<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>profile <span style="color: #990000">:</span>info <span style="color: #990000">:</span>Bench<span style="color: #990000">-</span>f
  <span style="font-weight: bold"><span style="color: #000000">(bench</span></span><span style="color: #990000">-</span>me
    <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">([]</span> <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>no<span style="color: #990000">-</span>arg<span style="color: #990000">-</span>f<span style="color: #990000">)</span> <span style="color: #993399">100</span><span style="color: #990000">)</span>
        <span style="color: #990000">([</span>a<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(p</span></span><span style="color: #990000">/</span>p <span style="color: #990000">:</span>bench<span style="color: #990000">/</span>one<span style="color: #990000">-</span>arg<span style="color: #990000">-</span>f<span style="color: #990000">)</span> <span style="color: #990000">+))))</span></tt></pre></div></div>
<div class="paragraph"><p>Here we define a Clojure function <span class="monospaced">bench-me</span>, which is called with a
higher-order function <span class="monospaced">f</span> that takes zero or one argument.</p></div>
<div class="paragraph"><p>Timbre outputs rich profiling information in a convenient table:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">2013</span>-Aug-<span style="color: #993399">25</span> <span style="color: #990000">...</span> Profiling <span style="color: #990000">:</span>taoensso<span style="color: #990000">.</span>timbre<span style="color: #990000">.</span>profiling/Bench-f
                        Name  Calls    Min    Max   MAD   Mean Time<span style="color: #990000">%</span>   Time
             <span style="color: #990000">:</span>bench/bench-me      <span style="color: #993399">1</span>   13ms   13ms   0ns   13ms    <span style="color: #993399">95</span>   13ms
                <span style="color: #990000">:</span>bench/sleep      <span style="color: #993399">1</span>   11ms   11ms   0ns   11ms    <span style="color: #993399">76</span>   11ms
<span style="color: #990000">:</span>bench/call-f-<span style="color: #993399">10</span>-times-outer      <span style="color: #993399">1</span>  <span style="color: #993399">970</span>μs  <span style="color: #993399">970</span>μs   0ns  <span style="color: #993399">970</span>μs     <span style="color: #993399">7</span>  <span style="color: #993399">970</span>μs
          <span style="color: #990000">:</span>bench/call-f-once      <span style="color: #993399">1</span>  <span style="color: #993399">610</span>μs  <span style="color: #993399">610</span>μs   0ns  <span style="color: #993399">610</span>μs     <span style="color: #993399">4</span>  <span style="color: #993399">610</span>μs
<span style="color: #990000">:</span>bench/call-f-<span style="color: #993399">10</span>-times-inner     <span style="color: #993399">10</span>   <span style="color: #993399">20</span>μs  <span style="color: #993399">214</span>μs  <span style="color: #993399">35</span>μs   <span style="color: #993399">39</span>μs     <span style="color: #993399">3</span>  <span style="color: #993399">394</span>μs
             <span style="color: #990000">:</span>bench/no-arg-f     <span style="color: #993399">11</span>    <span style="color: #993399">5</span>μs  <span style="color: #993399">163</span>μs  <span style="color: #993399">26</span>μs   <span style="color: #993399">20</span>μs     <span style="color: #993399">2</span>  <span style="color: #993399">215</span>μs
                <span style="color: #990000">[</span>Clock<span style="color: #990000">]</span> Time                                     <span style="color: #993399">100</span>   14ms
              Accounted Time                                     <span style="color: #993399">186</span>   26ms</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_151">Discussion</h4>
<div class="paragraph"><p>Profiling with Timbre is a great solution for Clojure-only profiling.
Standard JVM profiling tools like YourKit and JVisualVM provide more
comprehensive information on Java methods but come with a greater
performance penalty.</p></div>
<div class="paragraph"><p>Timbre&#8217;s profiling is most useful when profiling a specific area of
code, rather than using profiling as an exploratory tool for tuning
performance. As profiling markers are just macros, they are flexible.
For example, you could record how many times a particular <span class="monospaced">if</span> branch
was taken, all without leaving Clojure or suffering from mangled
Clojure function names via YourKit or JVisualVM.</p></div>
<div class="paragraph"><p>If profiling is deemed useful enough to keep in your code base, it is
good practice to use the profiling macros via a namespace alias. <span class="monospaced">p</span>,
while conveniently named, is prone to being shadowed by local bindings
if used without an explicit namespace. In the solution we used the
alias <span class="monospaced">p</span>, so each call to <span class="monospaced">p</span> becomes <span class="monospaced">p/p</span>.</p></div>
<div class="paragraph"><p>Remember, you should not be hesitant to add profiling statements:
there is no performance penalty for code involving
<span class="monospaced">taoensso.timbre.profiling/p</span> if tracing is not enabled. This means
you can leave tracing code in production, which is useful if you want
to profile the same code later, or if the profiling comments make your
code clearer.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_150">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://bit.ly/timbre-profiling">Profiling with Timbre</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_with_timbre">Logging with Timbre</h3>
<div class="paragraph byline"><p>by Alex Miller</p></div>
<div class="sect3">
<h4 id="_problem_152">Problem</h4>
<div class="paragraph"><p>You want to add logging to your application code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_150">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/ptaoussanis/timbre">Timbre</a> to configure your
logger and add logging messages to your code.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[com.taoensso/timbre "2.7.1"]</span> to your project&#8217;s
dependencies or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try com<span style="color: #990000">.</span>taoensso/timbre</tt></pre></div></div>
<div class="paragraph"><p>To write a function that writes log messages, use the Timbre
functions <span class="monospaced">info</span>, <span class="monospaced">error</span>, etc:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>taoensso<span style="color: #990000">.</span>timbre <span style="color: #990000">:</span>as log<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> div<span style="color: #990000">-</span><span style="color: #993399">4</span> <span style="color: #990000">[</span>n<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>info <span style="color: #FF0000">"Starting"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(try</span></span>
    <span style="color: #990000">(/</span> <span style="color: #993399">4</span> n<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(catch</span></span> Throwable t
      <span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>error t <span style="color: #FF0000">"oh no!"</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(finally</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>info <span style="color: #FF0000">"Ending"</span><span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">div-4</span> function takes a single argument and returns 4/n.</p></div>
<div class="paragraph"><p>The <span class="monospaced">log/info</span> calls will create a log message output at the "info"
level. Similarly, the <span class="monospaced">log/error</span> call will create a log message at the
"error" output level. Passing an exception as the first argument will
cause the stack trace to be printed as well.</p></div>
<div class="paragraph"><p>If you call <span class="monospaced">div-4</span> with values that will succeed or throw an error, you
will see output like the following in your REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(div</span></span><span style="color: #990000">-</span><span style="color: #993399">4</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2013-Nov-22 10:34:11 -0500 laptop INFO [user] - Starting</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2013-Nov-22 10:34:11 -0500 laptop INFO [user] - Ending</span></span>

<span style="font-weight: bold"><span style="color: #000000">(div</span></span><span style="color: #990000">-</span><span style="color: #993399">4</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2013-Nov-22 10:34:47 -0500 laptop ERROR [user] -</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;      oh no! java.lang.ArithmeticException: Divide by zero</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; nil</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2013-Nov-22 10:34:21 -0500 laptop INFO [user] - Starting</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2013-Nov-22 10:34:21 -0500 laptop ERROR [user] -</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   oh no! java.lang.ArithmeticException: Divide by zero</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ... Exception stacktrace</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 2013-Nov-22 10:34:21 -0500 laptop INFO [user] - Ending</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_152">Discussion</h4>
<div class="paragraph"><p>Timbre is a great way to get started with logging in your code. Using a log
library allows you to specify later where the output will go, possibly to
more than one location or filtered by namespace.</p></div>
<div class="paragraph"><p>Timbre writes logs to any number of configured "appenders" (output
destinations). By default, a single appender is configured to write to
standard out.</p></div>
<div class="paragraph"><p>For example, to add a second appender for a file, you can dynamically modify
the configuration by enabling the preconfigured <span class="monospaced">spit</span> appender:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Turn it on</span></span>
<span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>config<span style="color: #990000">!</span> <span style="color: #990000">[:</span>appenders <span style="color: #990000">:</span>spit <span style="color: #990000">:</span>enabled<span style="color: #990000">?]</span> true<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; Set the log file location</span></span>
<span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>config<span style="color: #990000">!</span> <span style="color: #990000">[:</span>shared<span style="color: #990000">-</span>appender<span style="color: #990000">-</span>config <span style="color: #990000">:</span>spit<span style="color: #990000">-</span>filename<span style="color: #990000">]</span> <span style="color: #FF0000">"out.log"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the output file&#8217;s directory must exist and the user must be able
to write to the file.  Once this configuration has been completed, any log
messages will be written to both the console and the file.</p></div>
<div class="paragraph"><p>The available logging levels are <span class="monospaced">:trace</span>, <span class="monospaced">:debug</span>, <span class="monospaced">:info</span>, <span class="monospaced">:warn</span>,
<span class="monospaced">:error</span>, and <span class="monospaced">:fatal</span>. The default log level is set to <span class="monospaced">:debug</span>, so all
logging levels greater than or equal to <span class="monospaced">:debug</span> will be recorded
(everything but <span class="monospaced">:trace</span>).</p></div>
<div class="paragraph"><p>To change the logging level at runtime, change the configuration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(log</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>level<span style="color: #990000">!</span> <span style="color: #990000">:</span>warn<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>While Timbre is an excellent library for simple logging in your
Clojure app, it may not be sufficient if you are integrating with many
Java libraries. There are a variety of popular Java logging frameworks
and logging facades. If you wish to leverage the existing Java logging
infrastructure, you might find the <span class="monospaced">tools.logging</span> framework more
suitable.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_151">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://bit.ly/clj-timbre">Timbre Readme</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/clj-tools-logging">Logging with <span class="monospaced">tools.logging</span></a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_deploy_clojars">Releasing a Library to Clojars</h3>
<div class="paragraph byline"><p>by Ryan Neufeld; originally submitted by Simon Mosciatti</p></div>
<div class="sect3">
<h4 id="_problem_153">Problem</h4>
<div class="paragraph"><p>You&#8217;ve built a library in Clojure, and you want to release it to the world.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_151">Solution</h4>
<div class="paragraph"><p>One of the easiest places to release libraries to is <a href="https://clojars.org">Clojars</a>, a community repository for open source
libraries. To get started, <a href="https://clojars.org/register">sign up for an account</a>. If you don&#8217;t already have an SSH key,
the GitHub guide
<a href="http://bit.ly/ssh-keys">"Generating SSH
Keys"</a> is an excellent resource.</p></div>
<div class="paragraph"><p>Once you have an account set up, you&#8217;re ready to publish any
Leiningen-based project. If you don&#8217;t have a project to publish,
generate one with the command <strong><span class="monospaced">lein new
my-first-project-&lt;firstname&gt;-&lt;lastname&gt;</span></strong>, replacing <span class="monospaced">&lt;firstname&gt;</span> and
<span class="monospaced">&lt;lastname&gt;</span> with your own name.</p></div>
<div class="paragraph"><p>You can now use the command <strong><span class="monospaced">lein deploy clojars</span></strong> to release your
library to Clojars:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein deploy clojars
WARNING<span style="color: #990000">:</span> please <span style="font-weight: bold"><span style="color: #0000FF">set</span></span> <span style="color: #990000">:</span>description <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> project<span style="color: #990000">.</span>clj<span style="color: #990000">.</span>
WARNING<span style="color: #990000">:</span> please <span style="font-weight: bold"><span style="color: #0000FF">set</span></span> <span style="color: #990000">:</span>url <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> project<span style="color: #990000">.</span>clj<span style="color: #990000">.</span>
No credentials found <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> clojars <span style="color: #990000">(</span>did you mean `lein deploy clojars`<span style="color: #990000">?)</span>
See `lein <span style="font-weight: bold"><span style="color: #0000FF">help</span></span> deploy` <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> how to configure credentials<span style="color: #990000">.</span>
Username<span style="color: #990000">:</span> <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>
Password<span style="color: #990000">:</span> <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;2&gt;</b></span></span>
Wrote <span style="color: #990000">...</span>/my-first-project-ryan-neufeld/pom<span style="color: #990000">.</span>xml
Created <span style="color: #990000">...</span>/my-first-project-ryan-neufeld-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT<span style="color: #990000">.</span>jar
Could not find metadata my-first-project-ryan-neufeld<span style="color: #990000">:</span>
    <span style="color: #990000">.../</span><span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT/maven-metadata<span style="color: #990000">.</span>xml <span style="color: #990000">\</span>
    <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> clojars <span style="color: #990000">(</span>https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/)</span>
Sending <span style="color: #990000">...</span>/my-first-project-ryan-neufeld-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-<span style="color: #993399">20131113.123334</span>-<span style="color: #993399">1</span><span style="color: #990000">.</span>pom <span style="color: #990000">(</span>3k<span style="color: #990000">)</span>
    to https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/</span>
Sending <span style="color: #990000">...</span>/my-first-project-ryan-neufeld-<span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-<span style="color: #993399">20131113.123334</span>-<span style="color: #993399">1</span><span style="color: #990000">.</span>jar <span style="color: #990000">(</span>8k<span style="color: #990000">)</span>
    to https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/</span>
Could not find metadata my-first-project-ryan-neufeld<span style="color: #990000">:...</span>/maven-metadata<span style="color: #990000">.</span>xml <span style="color: #990000">\</span>
    <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> clojars <span style="color: #990000">(</span>https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/)</span>
Sending my-first-project-ryan-neufeld<span style="color: #990000">/.../</span><span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-SNAPSHOT/maven-metadata<span style="color: #990000">.</span>xml <span style="color: #990000">(</span>1k<span style="color: #990000">)</span>
    to https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/</span>
Sending my-first-project-ryan-neufeld<span style="color: #990000">/...</span>/maven-metadata<span style="color: #990000">.</span>xml <span style="color: #990000">(</span>1k<span style="color: #990000">)</span>
    to https<span style="color: #990000">:</span>//clojars<span style="color: #990000">.</span>org/repo<span style="color: #990000">/</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Enter your Clojars username, then press Return.
</p>
</li>
<li>
<p>
Enter your Clojars password, then press Return.
</p>
</li>
</ol></div>
<div class="paragraph"><p>After this command has completed, your library will be available both
on the Web (<a href="https://clojars.org/my-first-project-ryan-neufeld">https://clojars.org/my-first-project-ryan-neufeld</a>) and
as a Leiningen dependency (<span class="monospaced">[my-first-project-ryan-neufeld
"0.1.0-SNAPSHOT"]</span>).</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_153">Discussion</h4>
<div class="paragraph"><p>Releasing a library doesn&#8217;t get much easier than this; just create an
account and press the Big Red Button. Together, Leiningen and Clojars
make it trivially easy for members of the Clojure community such as
yourself to release their libraries to the masses.</p></div>
<div class="paragraph"><p>In this example, you released a simple, uniquely named library with
little care for versioning, release strategies, or adequate metadata.
In a real project, you should pay attention to these matters to be a
good open source citizen.</p></div>
<div class="paragraph"><p>The easiest change is adding appropriate metadata and a website. In your
<em>project.clj</em> file, add an accurate <span class="monospaced">:description</span> and <span class="monospaced">:url</span>. If you
don&#8217;t have a website for your project, consider linking to your
project&#8217;s GitHub page (or other public SCM "landing page").</p></div>
<div class="paragraph"><p>Less easy is having consistent version numbers for your project. We
suggest a scheme called <a href="http://semver.org">Semantic Versioning</a>, or
"semver." The semver scheme prescribes a version number of three
parts, <em>major</em>, <em>minor</em>, and <em>patch</em>, joined with periods. This ends up
looking like "0.1.0" or "1.4.2". Each version position indicates a
certain level of stability and consistency across releases. Releases
sharing a major version should be API-compatible; bumping the major
version says, "I have fundamentally changed the API of this library."
The minor version indicates when new, backward-compatible
functionality has been added. Finally, the patch version indicates
when bug fixes have been made.</p></div>
<div class="paragraph"><p>It certainly takes discipline to follow Semantic Versioning, but when
you do, you make it easier for your fellow developers to understand your library versions and trust them to behave in a way they expect.</p></div>
<div class="paragraph"><p>Code signing is another important concern in the deployment process.
Signing the artifacts you release lets your users know the artifacts
were created by someone they trust (you) and contain exactly what you
intended (i.e., they have not be tampered with). Leiningen includes
the facilities to sign release artifacts using GPG and include the
relevant <em>.asc</em> signature files in <span class="monospaced">lein deploy</span> publications.
Enabling code signing is described in the GNU Privacy Guard (GPG) section of Leiningen&#8217;s
<a href="http://bit.ly/lein-deploy-gpg">deploying
libraries guide</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_152">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://bit.ly/clojars-wiki">Clojars wiki</a>, a
  bountiful source of information on releasing libraries to Clojars
</p>
</li>
<li>
<p>
Leiningen&#8217;s own
  <a href="http://bit.ly/lein-deploy">deploying
  libraries guide</a>, which covers code signing and how to deploy to
  repositories other than Clojars
</p>
</li>
<li>
<p>
The output of the <span class="monospaced">lein help deploy</span> command
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_macros_to_simplify_api_deprecations">Using Macros to Simplify API Deprecations</h3>
<div class="paragraph byline"><p>by Michael Fogus</p></div>
<div class="sect3">
<h4 id="_problem_154">Problem</h4>
<div class="paragraph"><p>You want to use Clojure macros to deprecate API functions and report existing deprecations.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_152">Solution</h4>
<div class="paragraph"><p>When maintaining a library that other programmers rely on to get their work done, it behooves you to be thoughtful when making changes.  In the process of fixing bugs and making improvements to your library, you will eventually wish to change its public interface.  Making changes to a public-facing portion of your library is no small matter, but assuming that you&#8217;ve determined its necessity, then you&#8217;ll want to <em>deprecate</em> the functions that are obsolete. The term "deprecate" basically means that a given function should be avoided in favor of some other, newer function. </p></div>
<div class="paragraph"><p>For an example, take the case of the Clojure contrib library <a href="https://github.com/clojure/core.memoize"><span class="monospaced">core.memoize</span></a>.  Without going into detail about what <span class="monospaced">core.memoize</span> does, it&#8217;s fine to know that at one point a segment of its public-facing API was a function named <span class="monospaced">memo-fifo</span> that looked like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> memo<span style="color: #990000">-</span>fifo
  <span style="color: #990000">([</span>f<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">)</span>
  <span style="color: #990000">([</span>f limit<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">)</span>
  <span style="color: #990000">([</span>f limit base<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Obviously, the implementation has been elided to highlight only the parts that were planned for change in a later version&#8212;namely, the function&#8217;s name and its available argument vectors.  The details of the new API are not important, but they were different enough to cause potential confusion to the users.  In a case like this, simply making the change without due notice in a new version would have been bad form and genuine cause for bitterness.</p></div>
<div class="paragraph"><p>Therefore, the question arises: what can you do in the case where a feature is planned for deprecation that not only supports existing code in the interim, but also provides fair warning to the users of your library of a future breaking change?  In this section, we&#8217;ll discuss using macros to provide a nice mechanism for deprecating library functions and macros with minimal fuss.</p></div>
<div class="paragraph"><p>In the case of the planned deprecation of <span class="monospaced">memo-fifo</span>, the new function, named simply <span class="monospaced">fifo</span>, was changed not only in name but also in its provided arities.  When deprecating portions of a library, it&#8217;s often a good idea to print warning messages that point to the new, preferred function to use instead.  Therefore, to start on the way to deprecating <span class="monospaced">memo-fifo</span>, the following function, <span class="monospaced">!!</span>, was created to print a warning:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">^:</span>private <span style="color: #990000">!!</span> <span style="color: #990000">[</span>c<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"WARNING - Deprecated construction method for"</span>
           c
           <span style="color: #FF0000">"cache; preferred way is:"</span>
           <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"(clojure.core.memoize/"</span> c
                <span style="color: #FF0000">" function &lt;base&gt; &lt;:"</span>
                c <span style="color: #FF0000">"/threshold num&gt;)"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>When passed a symbol, the <span class="monospaced">!!</span> function prints a message like this one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(!!</span> 'fifo<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; WARNING - Deprecated construction method for fifo cache;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; preferred way is:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (clojure.core.memoize/fifo function &lt;base&gt; &lt;:fifo/threshold num&gt;)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Not only does the deprecation message indicate that the function called is deprecated, but it also points to the function that should be used instead.  As far as deprecation messages go, this one is solid, although your own purposes may call for something different.  In any case, to insert this warning on every call to <span class="monospaced">memo-fifo</span>, we can create a simple macro to inject the call to <span class="monospaced">!!</span> into the body of the function&#8217;s definition, as shown here:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmacro</span></span> defn<span style="color: #990000">-</span>deprecated <span style="color: #990000">[</span>nom _ alt ds <span style="color: #990000">&amp;</span> arities<span style="color: #990000">]</span>
  `<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">~</span>nom <span style="color: #990000">~</span>ds                                    <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
     <span style="color: #990000">~</span>@<span style="font-weight: bold"><span style="color: #000000">(for</span></span> <span style="color: #990000">[[</span>args body<span style="color: #990000">]</span> arities<span style="color: #990000">]</span>                    <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
         <span style="font-weight: bold"><span style="color: #000000">(list</span></span> args `<span style="color: #990000">(!!</span> <span style="font-weight: bold"><span style="color: #000000">(quote</span></span> <span style="color: #990000">~</span>alt<span style="color: #990000">))</span> body<span style="color: #990000">))))</span>      <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create a <span class="monospaced">defn</span> call with the given name and docstring.
</p>
</li>
<li>
<p>
Loop through the given function arities.
</p>
</li>
<li>
<p>
Insert a call to <span class="monospaced">!!</span> as the first part of the body.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We&#8217;ll talk a bit about the goals of the <span class="monospaced">defn-deprecated</span> macro in the following discussion section, but for now, you can see how it works:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span>deprecated memo<span style="color: #990000">-</span>fifo <span style="color: #990000">:</span>as fifo
  <span style="color: #FF0000">"DEPRECATED: Please use clojure.core.memoize/fifo instead."</span>
  <span style="color: #990000">([</span>f<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">)</span>
  <span style="color: #990000">([</span>f limit<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">)</span>
  <span style="color: #990000">([</span>f limit base<span style="color: #990000">]</span> <span style="color: #990000">...</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The only changes to the definition of <span class="monospaced">memo-fifo</span> are the use of the <span class="monospaced">defn-deprecated</span> macro instead of <span class="monospaced">defn</span> directly, the use of the <span class="monospaced">:as fifo</span> directive, and the addition (or change) of the docstring to describe the deprecation.  The <span class="monospaced">defn-deprecated</span> macro takes care of assembling the parts in the macro body to print the warning on use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> f <span style="font-weight: bold"><span style="color: #000000">(memo</span></span><span style="color: #990000">-</span>fifo identity <span style="color: #993399">32</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; WARNING - Deprecated construction method for fifo cache;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; preferred way is:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (clojure.core.memoize/fifo function &lt;base&gt; &lt;:fifo/threshold num&gt;)</span></span></tt></pre></div></div>
<div class="paragraph"><p>The warning message will only display once for every call to <span class="monospaced">memo-fifo</span>, and due to the nature of that function, that should be sufficient.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_154">Discussion</h4>
<div class="paragraph"><p>There are different ways to handle the same situation besides using macros.  For example, the <span class="monospaced">!!</span> function could have taken a function and a symbol and wrapped the function, inserting a deprecation warning in passing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> depr <span style="color: #990000">[</span>fun alt<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[&amp;</span> args<span style="color: #990000">]</span>                                        <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
    <span style="font-weight: bold"><span style="color: #000000">(println</span></span>
      <span style="color: #FF0000">"WARNING - Deprecated construction method for"</span>
      alt
      <span style="color: #FF0000">"cache; preferred way is:"</span>
      <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"(clojure.core.memoize/"</span> alt
           <span style="color: #FF0000">" function &lt;base&gt; &lt;:"</span>
           alt <span style="color: #FF0000">"/threshold num&gt;)"</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> fun args<span style="color: #990000">)))</span>                                <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Return a function that prints the deprecation message before calling the deprecated function.
</p>
</li>
<li>
<p>
Call the deprecated function.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This new implementation of <span class="monospaced">!!</span> would work in the following way:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> memo<span style="color: #990000">-</span>fifo <span style="font-weight: bold"><span style="color: #000000">(depr</span></span> old<span style="color: #990000">-</span>memo<span style="color: #990000">-</span>fifo 'fifo<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Thereafter, calling the <span class="monospaced">memo-fifo</span> function will print the deprecation message.  Using a higher-order function like this is a reasonable way to avoid the potential complexities of using a macro.  However, we chose the macro version for a number of reasons, explained in the following sections.</p></div>
<div class="sect4">
<h5 id="_preserving_stack_traces">Preserving stack traces</h5>
<div class="paragraph"><p>Let&#8217;s be honest: the exception stack traces that Clojure can produce can at times be painful to deal with.  If you decide to use a higher-order function like <span class="monospaced">depr</span>, be aware that if an exception occurs in its execution, another layer of stack trace will be added.  By using a macro like <span class="monospaced">!!</span> that delegates its operation directly to <span class="monospaced">defn</span>, you are ensured that the stack trace will remain unadulterated (so to speak).</p></div>
</div>
<div class="sect4">
<h5 id="_metadata">Metadata</h5>
<div class="paragraph"><p>Using a near 1-for-1 replacement macro like <span class="monospaced">defn-deprecated</span> allows you to preserve the metadata on a function.  Observe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span>deprecated <span style="color: #990000">^:</span>private memo<span style="color: #990000">-</span>foo <span style="color: #990000">:</span>as bar
  <span style="color: #FF0000">"Does something."</span>
  <span style="color: #990000">([]</span> <span style="color: #993399">42</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(memo</span></span><span style="color: #990000">-</span>foo<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; WARNING - Deprecated construction method for bar cache;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; preferred way is:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (clojure.core.memoize/bar function &lt;base&gt; &lt;:bar/threshold num&gt;)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; 42</span></span></tt></pre></div></div>
<div class="paragraph"><p>Because <span class="monospaced">defn-deprecated</span> defers the bulk of its behavior to <span class="monospaced">defn</span>, any metadata attached to its elements automatically gets forwarded on and attached as expected:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(meta</span></span> #'memo<span style="color: #990000">-</span>foo<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; {:arglists ([]), :ns #&lt;Namespace user&gt;,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    :name memo-foo, :private true, :doc "Does something.",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using the higher-order approach does not automatically preserve metadata:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> baz <span style="font-weight: bold"><span style="color: #000000">(depr</span></span> foo 'bar<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(meta</span></span> #'baz<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; {:ns #&lt;Namespace user&gt;, :name baz, ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Of course, you could copy over the metadata if so desired, but why do so when the macro approach takes cares of it for you?</p></div>
</div>
<div class="sect4">
<h5 id="_faster_call_site">Faster call site</h5>
<div class="paragraph"><p>The <span class="monospaced">depr</span> function, because it&#8217;s required to handle any function that you give it, needed to use <span class="monospaced">apply</span> at its core.  While in the case of the <span class="monospaced">core.memoize</span> functions this was not a problem, it may become so in the case of functions requiring higher performance.  In reality, though, the use of <span class="monospaced">println</span> will likely overwhelm the cost of the <span class="monospaced">apply</span>, so if you really need to deprecate a high-performance function, then you might want to consider the following approach instead.</p></div>
</div>
<div class="sect4">
<h5 id="_compile_time_warnings">Compile-time warnings</h5>
<div class="paragraph"><p>The operation of <span class="monospaced">defn-deprecated</span> is such that the deprecation warning is printed every time the function is called.  This could be problematic if the function requires high speed.</p></div>
<div class="paragraph"><p>Very few things slow a function down like a console print.  Therefore, we can change <span class="monospaced">defn-deprecate</span> slightly to report its warning at compile time rather than runtime:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmacro</span></span> defn<span style="color: #990000">-</span>deprecated <span style="color: #990000">[</span>nom _ alt ds <span style="color: #990000">&amp;</span> arities<span style="color: #990000">]</span>
  <span style="color: #990000">(!!</span> alt<span style="color: #990000">)</span>                     <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
  `<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">~</span>nom <span style="color: #990000">~</span>ds <span style="color: #990000">~</span>@arities<span style="color: #990000">))</span>  <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Print the warning when the macro is accessed.
</p>
</li>
<li>
<p>
Delegate function definition to <span class="monospaced">defn</span> without adulteration.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Observe the compile-time warning:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span><span style="color: #990000">-</span>deprecated <span style="color: #990000">^:</span>private memo<span style="color: #990000">-</span>foo <span style="color: #990000">:</span>as bar
  <span style="color: #FF0000">"Does something."</span>
  <span style="color: #990000">([]</span> <span style="color: #993399">42</span><span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; WARNING - Deprecated construction method for bar cache;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; preferred way is:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (clojure.core.memoize/bar function &lt;base&gt; &lt;:bar/threshold num&gt;)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;=&gt; #'user/memo-foo</span></span>

<span style="font-weight: bold"><span style="color: #000000">(memo</span></span><span style="color: #990000">-</span>foo<span style="color: #990000">)</span>
<span style="color: #993399">42</span></tt></pre></div></div>
<div class="paragraph"><p>This approach will work well if you distribute libraries as source code rather than as compiled programs.</p></div>
</div>
<div class="sect4">
<h5 id="_turning_it_off">Turning it off</h5>
<div class="paragraph"><p>The real beauty of macros is not that they allow you to change the semantics of your programs, but that they allow you to avoid doing so whenever it&#8217;s not appropriate.  For example, when using macros, you can run any code available to Clojure at compile time.  Thankfully, the full Clojure language is available at compile time.  Therefore, we can check a Boolean flag attached to a namespace as metadata to decide whether to report a compile-time deprecation warning.  We can change the newest <span class="monospaced">defn-deprecated</span> to illustrate this technique:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmacro</span></span> defn<span style="color: #990000">-</span>deprecated
  <span style="color: #990000">[</span>nom _ alt ds <span style="color: #990000">&amp;</span> arities<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>silence<span style="color: #990000">?</span> <span style="color: #990000">(:</span>silence<span style="color: #990000">-</span>deprecations <span style="font-weight: bold"><span style="color: #000000">(meta</span></span> clojure<span style="color: #990000">.</span>core<span style="color: #990000">/*</span>ns<span style="color: #990000">*))]</span> <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;1&gt;</b></span></span>
    <span style="font-weight: bold"><span style="color: #000000">(when</span></span><span style="color: #990000">-</span>not silence<span style="color: #990000">?</span>  <span style="font-style: italic"><span style="color: #9A1900">; <b>&lt;2&gt;</b></span></span>
     <span style="color: #990000">(!!</span> alt<span style="color: #990000">)))</span>
  `<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">~</span>nom <span style="color: #990000">~</span>ds <span style="color: #990000">~</span>@arities<span style="color: #990000">))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Look up the metadata on the current namespace.
</p>
</li>
<li>
<p>
Only report the deprecation warning if the flag is not set to silence mode.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">defn-deprecated</span> macro checks the status of the <span class="monospaced">:silence-deprecations</span> metadata property on the current namespace and reports (or not) the deprecation warning based on it.  If you wind up using this approach, then you can turn off the deprecation warning on a per-namespace basis by adding the following to your <span class="monospaced">ns</span> declaration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> <span style="color: #990000">^:</span>silence<span style="color: #990000">-</span>deprecations my<span style="color: #990000">.</span>awesome<span style="color: #990000">.</span>lib<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now, any use of <span class="monospaced">defn-deprecated</span> in that namespace will not print the warning.  Future versions of Clojure will provide a cleaner way of creating and managing compile-time flags, but for now this is a decent compromise.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_153">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The official <a href="http://clojure.org/macros">macro documentation</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_distributed">Distributed Computation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_9">Introduction</h3>
<div class="paragraph"><p>With the advent of cheaper and cheaper storage, we&#8217;re inclined to
store more and more data. As this data grows larger and larger, it
becomes increasingly difficult to utilize to its full potential. In response, numerous new techniques have emerged in the last decade or
so for dealing with such quantities of data.</p></div>
<div class="paragraph"><p>The primary focus of this chapter is one such technique,
<a href="http://bit.ly/mapreduce-paper">MapReduce</a>,
developed at Google in the early 2000s. Functional even in name, this
technique uses <span class="monospaced">map</span> and <span class="monospaced">reduce</span> in parallel across multiple machines at
tremendous scale to process data at phenomenal speeds. In this chapter,
we&#8217;ll be covering <a href="http://cascalog.org/">Cascalog</a>, a data-processing
library built on top of <a href="http://hadoop.apache.org/">Hadoop</a>, which is an open source MapReduce
implementation.</p></div>
<div class="paragraph"><p>We&#8217;ll also briefly cover <a href="http://storm.apache.org/">Storm</a>, a
real-time stream-processing library in use at several tech giants
such as Twitter, Groupon, and Yahoo!.</p></div>
<div class="sect3">
<h4 id="_cascalog">Cascalog</h4>
<div class="paragraph"><p>Cascalog defines a DSL based on Datalog, the same query language that
backs <a href="http://www.datomic.com/">Datomic</a>. It might seem strange at first, but you will be
thinking in Datalog in no time. Once you&#8217;ve wet your feet with these
recipes, visit the <a href="http://bit.ly/cascalog-wiki">Cascalog
wiki</a> for more information on writing your own queries.</p></div>
<div class="paragraph"><p>Cascalog provides a concise syntax for describing data-processing
jobs. Transformations and aggregates are easy to express in
Cascalog. Joins are particularly simple. You might like the Cascalog
syntax so much that you use it even for local jobs.</p></div>
<div class="paragraph"><p>You can run your Cascalog jobs in a number of different ways. The
easiest way is to run jobs locally. When running jobs locally, Cascalog
uses Hadoop&#8217;s local mode, completing the entire job on your own
computer. You get the benefit of parallelism, without the hassle of
setting up a cluster.</p></div>
<div class="paragraph"><p>Once your jobs outgrow local mode, you&#8217;ll need to start running them
on a Hadoop cluster. Having your own cluster is a lot of fun, but it
can take a fair amount of work (and money!) to set up and maintain. If
you don&#8217;t need a cluster very often, you might consider running your
job on link to <a href="http://aws.amazon.com/elasticmapreduce/">Amazon Elastic MapReduce</a> (EMR). EMR provides on-demand Hadoop
clusters the same way EC2 provides on-demand servers. You&#8217;ll need an
Amazon Web Services account to run the job, but it isn&#8217;t difficult.
You can read exactly how to do it later, in <a href="#sec_cascalog_emr">[sec_cascalog_emr]</a>.
Whether you run your job on EMR or on your own cluster, you will
package up your code into an uberjar (see <a href="#sec_packaging_jars">[sec_packaging_jars]</a>), then send it to Hadoop for
execution. It is surprisingly simple to get hundreds of computers
working on your task.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_building_an_activity_feed_system_with_storm">Building an Activity Feed System with Storm</h3>
<div class="paragraph byline"><p>by Travis Vachon</p></div>
<div class="sect3">
<h4 id="_problem_155">Problem</h4>
<div class="paragraph"><p>You want to build an activity stream processing system to filter and aggregate the raw event data generated by the users of your application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_153">Solution</h4>
<div class="paragraph"><p>Streams are a dominant metaphor for presenting information to users of
the modern Internet. Used on sites like Facebook and Twitter and mobile
apps like Instagram and Tinder, streams are an elegant tool for giving
users a window into the deluge of information generated by the
applications they use every day.</p></div>
<div class="paragraph"><p>As a developer of these applications, you want tools to process the
firehose of raw event data generated by user actions. They must offer
powerful capabilities for filtering and aggregating data and must be
arbitrarily scalable to serve ever-growing user bases. Ideally
they should provide high-level abstractions that help you organize and
grow the complexity of your stream-processing logic to accommodate new
features and a complex world.</p></div>
<div class="paragraph"><p>Clojure offers just such a tool in <a href="http://storm.apache.org/">Storm</a>, a
distributed real-time computation system that aims to be for real-time
computation what Hadoop is for batch computation. In this section,
you&#8217;ll build a simple activity stream processing system that can be
easily extended to solve real-world problems.</p></div>
<div class="paragraph"><p>First, create a new <a href="http://storm.apache.org/">Storm project</a> using its Leiningen template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new cookbook-storm-project feeds</tt></pre></div></div>
<div class="paragraph"><p>In the project directory, run the default Storm topology (which the
<span class="monospaced">lein</span> template has generated for you):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ cd feeds
$ lein run -m feeds<span style="color: #990000">.</span>topology/run<span style="color: #990000">!</span>
Compiling feeds<span style="color: #990000">.</span>TopologySubmitter
<span style="color: #990000">...</span>
Emitting<span style="color: #990000">:</span> spout default <span style="color: #990000">[:</span>bizarro<span style="color: #990000">]</span>
Processing received message <span style="font-weight: bold"><span style="color: #0000FF">source</span></span><span style="color: #990000">:</span> spout<span style="color: #990000">:</span><span style="color: #993399">4</span><span style="color: #990000">,</span> stream<span style="color: #990000">:</span> default<span style="color: #990000">,</span> id<span style="color: #990000">:</span> {}<span style="color: #990000">,</span> <span style="color: #990000">[:</span>bizarro<span style="color: #990000">]</span>
Emitting<span style="color: #990000">:</span> stormy-bolt default <span style="color: #990000">[</span><span style="color: #FF0000">"I'm bizarro Stormy!"</span><span style="color: #990000">]</span>
Processing received message <span style="font-weight: bold"><span style="color: #0000FF">source</span></span><span style="color: #990000">:</span> stormy-bolt<span style="color: #990000">:</span><span style="color: #993399">5</span><span style="color: #990000">,</span>
  stream<span style="color: #990000">:</span> default<span style="color: #990000">,</span> id<span style="color: #990000">:</span> {}<span style="color: #990000">,</span> <span style="color: #990000">[</span>I<span style="color: #FF0000">'m bizarro Stormy!]</span>
<span style="color: #FF0000">Emitting: feeds-bolt default ["feeds produced: I'</span>m bizarro Stormy<span style="color: #990000">!</span><span style="color: #FF0000">"]</span></tt></pre></div></div>
<div class="paragraph"><p>This generated example topology just babbles example messages
incoherently, which probably isn&#8217;t what you want, so begin by
modifying the "spout" to produce realistic events.</p></div>
<div class="paragraph"><p>In Storm parlance,
the "spout" is the component that inserts data into the processing system
and creates a data stream. Open <em>src/feeds/spouts.clj</em> and replace the
<span class="monospaced">defspout</span> form with a new spout that will periodically produce random
user events such as one might see in an online marketplace (in a real
application, of course, you&#8217;d hook this up to some source of real
data rather than a random data generator):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defspout</span></span> event<span style="color: #990000">-</span>spout <span style="color: #990000">[</span><span style="color: #FF0000">"event"</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span>conf context collector<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>events <span style="color: #990000">[</span>{<span style="color: #990000">:</span>action <span style="color: #990000">:</span>commented<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>travis<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>red<span style="color: #990000">-</span>shoes}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>jim<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>red<span style="color: #990000">-</span>shoes}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>karen<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>rob<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>commented<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>emma<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}<span style="color: #990000">]]</span>
    <span style="font-weight: bold"><span style="color: #000000">(spout</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(nextTuple</span></span> <span style="color: #990000">[]</span>
       <span style="font-weight: bold"><span style="color: #000000">(Thread</span></span><span style="color: #990000">/</span>sleep <span style="color: #993399">1000</span><span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>spout<span style="color: #990000">!</span> collector <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span>nth events<span style="color: #990000">)])))))</span></tt></pre></div></div>
<div class="paragraph"><p>Next, open <em>src/feeds/bolts.clj</em>. Add a bolt that accepts a user and
an event and produces a tuple of <span class="monospaced">(user, event)</span> for each user in the
system. A bolt consumes a stream, does some processing, and emits a
new stream:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defbolt</span></span> active<span style="color: #990000">-</span>user<span style="color: #990000">-</span>bolt <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span>{event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple} collector<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>user <span style="color: #990000">[:</span>jim <span style="color: #990000">:</span>rob <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>travis<span style="color: #990000">]]</span>
    <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>bolt<span style="color: #990000">!</span> collector <span style="color: #990000">[</span>user event<span style="color: #990000">]))</span>
  <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Now add a bolt that accepts a user and an event and emits a tuple if
and only if the user is following the user who triggered the event:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defbolt</span></span> follow<span style="color: #990000">-</span>bolt <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>prepare true}
  <span style="color: #990000">[</span>conf context collector<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>follows {<span style="color: #990000">:</span>jim #{<span style="color: #990000">:</span>rob <span style="color: #990000">:</span>emma}
                 <span style="color: #990000">:</span>rob #{<span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>jim}
                 <span style="color: #990000">:</span>karen #{<span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma}
                 <span style="color: #990000">:</span>kaitlyn #{<span style="color: #990000">:</span>jim <span style="color: #990000">:</span>rob <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>travis}
                 <span style="color: #990000">:</span>emma #{<span style="color: #990000">:</span>karen}
                 <span style="color: #990000">:</span>travis #{<span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>rob}}<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(execute</span></span> <span style="color: #990000">[</span>{user <span style="color: #FF0000">"user"</span> event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple}<span style="color: #990000">]</span>
              <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(follows</span></span> user<span style="color: #990000">)</span> <span style="color: #990000">(:</span>user event<span style="color: #990000">))</span>
                <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>bolt<span style="color: #990000">!</span> collector <span style="color: #990000">[</span>user event<span style="color: #990000">]))</span>
              <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, add a bolt that accepts a user and an event and stores the event
in a hash of sets like <span class="monospaced">{:user1 #{event1 event2} :user2 #{event1 event2}}</span>&#x2014;these are the activity streams you&#8217;ll present to users:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defbolt</span></span> feed<span style="color: #990000">-</span>bolt <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>prepare true}
  <span style="color: #990000">[</span>conf context collector<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>feeds <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> {}<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(execute</span></span> <span style="color: #990000">[</span>{user <span style="color: #FF0000">"user"</span> event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple}<span style="color: #990000">]</span>
              <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> feeds #<span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in <span style="color: #990000">%</span> <span style="color: #990000">[</span>user<span style="color: #990000">]</span> conj event<span style="color: #990000">))</span>
              <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Current feeds:"</span><span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>pprint<span style="color: #990000">/</span>pprint @feeds<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>This gives you all the pieces you&#8217;ll need, but you&#8217;ll still need
to assemble them into a computational topology. Open up
<em>src/feeds/topology.clj</em> and use the topology DSL to wire the spouts
and bolts together:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> storm<span style="color: #990000">-</span>topology <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(topology</span></span>
   {<span style="color: #FF0000">"events"</span> <span style="font-weight: bold"><span style="color: #000000">(spout</span></span><span style="color: #990000">-</span>spec event<span style="color: #990000">-</span>spout<span style="color: #990000">)</span>}

   {<span style="color: #FF0000">"active users"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"events"</span> <span style="color: #990000">:</span>shuffle} active<span style="color: #990000">-</span>user<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">"follows"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"active users"</span> <span style="color: #990000">:</span>shuffle} follow<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">"feeds"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"follows"</span> <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span><span style="color: #990000">]</span>} feed<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span>}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll also need to update the <span class="monospaced">:require</span> statement in that file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>feeds
             <span style="color: #990000">[</span>spouts <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>event<span style="color: #990000">-</span>spout<span style="color: #990000">]]</span>
             <span style="color: #990000">[</span>bolts <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>active<span style="color: #990000">-</span>user<span style="color: #990000">-</span>bolt follow<span style="color: #990000">-</span>bolt feed<span style="color: #990000">-</span>bolt<span style="color: #990000">]]]</span>
            <span style="color: #990000">[</span>backtype<span style="color: #990000">.</span>storm <span style="color: #990000">[</span>clojure <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>topology spout<span style="color: #990000">-</span>spec bolt<span style="color: #990000">-</span>spec<span style="color: #990000">]]</span>
                            <span style="color: #990000">[</span>config <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]])</span></tt></pre></div></div>
<div class="paragraph"><p>Run the topology again. Feeds will be printed to the console by the
final bolts in the topology:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run -m feeds<span style="color: #990000">.</span>topology/run<span style="color: #990000">!</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_155">Discussion</h4>
<div class="paragraph"><p>Storm&#8217;s Clojure DSL doesn&#8217;t look like standard Clojure. Instead, it
uses Clojure&#8217;s macros to extend the language to the domain of stream
processing. Storm&#8217;s stream processing abstraction consists of four core
primitives:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Tuples
</dt>
<dd>
<p>
Allow programmers to provide names for values. Tuples are dynamically typed lists of values.
</p>
</dd>
<dt class="hdlist1">
Spouts
</dt>
<dd>
<p>
Produce tuples, often by reading from a distributed
   queue.
</p>
</dd>
<dt class="hdlist1">
Bolts
</dt>
<dd>
<p>
Accept tuples as input and produce new tuples&#8212;these
   are the core computational units of a Storm topology.
</p>
</dd>
<dt class="hdlist1">
Streams
</dt>
<dd>
<p>
Used to wire spouts to bolts and bolts to other bolts,
   creating a computational topology. Streams can be configured with
   rules for routing certain types of tuples to specific instances of
   bolts.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The following subsections review the components of our system to give a
better picture of how these primitives work together.</p></div>
<div class="sect4">
<h5 id="_event_spout">event-spout</h5>
<div class="paragraph"><p><span class="monospaced">defspout</span> looks much like Clojure&#8217;s standard <span class="monospaced">defn</span>, with one
difference&#8212;the second argument to <span class="monospaced">defspout</span> is a list of names that
will be assigned to elements of each tuple this spout produces. This
lets you use tuples like vectors or maps interchangeably. The third
argument to <span class="monospaced">defspout</span> is a list of arguments that will be bound
various components of Storm&#8217;s operational infrastructure.</p></div>
<div class="paragraph"><p>In the case of the <span class="monospaced">event-spout</span> spout, only <span class="monospaced">collector</span> is used:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defspout</span></span> event<span style="color: #990000">-</span>spout <span style="color: #990000">[</span><span style="color: #FF0000">"event"</span><span style="color: #990000">]</span>
  <span style="color: #990000">[</span>conf context collector<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">defspout</span>'s body will be evaluated once, when the spout instance is
created, which gives you an opportunity to create in-memory state. Usually this will be a connection to a database or distributed queue, but in this case you&#8217;ll create a list of events this spout will produce:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>events <span style="color: #990000">[</span>{<span style="color: #990000">:</span>action <span style="color: #990000">:</span>commented<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>travis<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>red<span style="color: #990000">-</span>shoes}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>jim<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>red<span style="color: #990000">-</span>shoes}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>karen<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>liked<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>rob<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}
                {<span style="color: #990000">:</span>action <span style="color: #990000">:</span>commented<span style="color: #990000">,</span> <span style="color: #990000">:</span>user <span style="color: #990000">:</span>emma<span style="color: #990000">,</span> <span style="color: #990000">:</span>listing <span style="color: #990000">:</span>green<span style="color: #990000">-</span>hat}<span style="color: #990000">]]</span></tt></pre></div></div>
<div class="paragraph"><p>This call to <span class="monospaced">spout</span> creates an instance of a spout with the given
implementation of <span class="monospaced">nextTuple</span>. This implementation simply sleeps for
one second and then uses <span class="monospaced">emit-spout!</span> to emit a one-element tuple
consisting of a random event from the preceding list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #000000">(spout</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(nextTuple</span></span> <span style="color: #990000">[]</span>
       <span style="font-weight: bold"><span style="color: #000000">(Thread</span></span><span style="color: #990000">/</span>sleep <span style="color: #993399">1000</span><span style="color: #990000">)</span>
       <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>spout<span style="color: #990000">!</span> collector <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(rand</span></span><span style="color: #990000">-</span>nth events<span style="color: #990000">)])))))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">nextTuple</span> will be
called repeatedly in a tight loop, so if you create a spout that polls
an external resource, you may need to provide your own backoff
algorithm to avoid excess load on that resource.</p></div>
<div class="paragraph"><p>You can also implement the spout&#8217;s <span class="monospaced">ack</span> method to implement a
"reliable" spout that will provide message-processing guarantees. For
more information on reliable spouts, see Storm&#8217;s spout implementation
for the Kestrel queueing system, <a href="https://github.com/nathanmarz/storm-kestrel"><span class="monospaced">storm-kestrel</span></a>.</p></div>
</div>
<div class="sect4">
<h5 id="_active_user_bolt">active-user-bolt</h5>
<div class="paragraph"><p>Every time a user takes an action in this system, the system needs to determine
whether each other user in the system will be interested in it. Given
a simple interest system like Twitter, where users express interest in
a single way (i.e., user follows), you could simply look at the
follower list of the user who took the action and update feeds
accordingly. In a more complex system, however, interest might be
expressed by having liked the item the action was taken against,
following a collection that the item has been added to, or following
the seller of the item. In this world, you need to consider a variety
of factors for each user in the system for every event and determine
whether the event should be added to that user&#8217;s feed.</p></div>
<div class="paragraph"><p>The first bolt starts this process by generating a tuple of <span class="monospaced">(user,
event)</span> for each user in the system every time an event is generated
by the <span class="monospaced">event-spout</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defbolt</span></span> active<span style="color: #990000">-</span>user<span style="color: #990000">-</span>bolt <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">]</span> <span style="color: #990000">[</span>{event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple} collector<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>user <span style="color: #990000">[:</span>jim <span style="color: #990000">:</span>rob <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>travis<span style="color: #990000">]]</span>
    <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>bolt<span style="color: #990000">!</span> collector <span style="color: #990000">[</span>user event<span style="color: #990000">]))</span>
  <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">defbolt</span>'s signature looks very similar to <span class="monospaced">defspout</span>. The second
argument is a list of names that will be assigned to tuples generated
by this bolt, and the third argument is a list of parameters. The
first parameter will be bound to the input tuple, and may be
destructured as a map or a vector.</p></div>
<div class="paragraph"><p>The body of this bolt iterates through a list of users in the system
and emits a tuple for each of them. The last line of the body calls <span class="monospaced">ack!</span>
on this tuple, which allows Storm to track message processing and restart
processing when appropriate.</p></div>
</div>
<div class="sect4">
<h5 id="_follow_bolt">follow-bolt</h5>
<div class="paragraph"><p>The next bolt is a <em>prepared bolt</em>; that is, one that maintains
in-memory state. In many cases, this would mean maintaining a
connection to a database or a queue, or a data structure aggregating
some aspect of the tuples it processes, but this example maintains a
complete list of the followers in the system in memory.</p></div>
<div class="paragraph"><p>This bolt looks more like the spout definition. The second argument
is a list of names, the third argument is a map of bolt configuration
options (importantly, these set <span class="monospaced">:prepare</span> to <span class="monospaced">true</span>), and the fourth
argument is the same set of operational arguments received in
<span class="monospaced">defspout</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defbolt</span></span> follow<span style="color: #990000">-</span>bolt <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">]</span> {<span style="color: #990000">:</span>prepare true}
  <span style="color: #990000">[</span>conf context collector<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The body of the bolt first defines the list of followers, and then
provides the actual bolt definition inside a call to <span class="monospaced">bolt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>follows {<span style="color: #990000">:</span>jim #{<span style="color: #990000">:</span>rob <span style="color: #990000">:</span>emma}
                 <span style="color: #990000">:</span>rob #{<span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>jim}
                 <span style="color: #990000">:</span>karen #{<span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma}
                 <span style="color: #990000">:</span>kaitlyn #{<span style="color: #990000">:</span>jim <span style="color: #990000">:</span>rob <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>travis}
                 <span style="color: #990000">:</span>emma #{<span style="color: #990000">:</span>karen}
                 <span style="color: #990000">:</span>travis #{<span style="color: #990000">:</span>kaitlyn <span style="color: #990000">:</span>emma <span style="color: #990000">:</span>karen <span style="color: #990000">:</span>rob}}<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(execute</span></span> <span style="color: #990000">[</span>{user <span style="color: #FF0000">"user"</span> event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple}<span style="color: #990000">]</span>
              <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(follows</span></span> user<span style="color: #990000">)</span> <span style="color: #990000">(:</span>user event<span style="color: #990000">))</span>
                <span style="font-weight: bold"><span style="color: #000000">(emit</span></span><span style="color: #990000">-</span>bolt<span style="color: #990000">!</span> collector <span style="color: #990000">[</span>user event<span style="color: #990000">]))</span>
              <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">)))))</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the tuple argument is inside the bolt&#8217;s definition of
<span class="monospaced">execute</span> in this case and may be destructured as usual. In cases
where the event&#8217;s user is not following the user in the tuple, it does
not emit a new tuple and simply acknowledges that it received the
input.</p></div>
<div class="paragraph"><p>As noted earlier, this particular system could be implemented much
more simply by querying whatever datastore tracks follows and simply
adding a story to the feed of each follower. Anticipating a more
complicated system, however, provides a massively extensible
architecture. This bolt could easily be expanded to a collection of
scoring bolts, each of which would evaluate a user/event pair based on
its own criteria and emit a tuple of (<span class="monospaced">user</span>, <span class="monospaced">event</span>, <span class="monospaced">score</span>). A
score aggregation bolt would receive scores from each scoring bolt and
choose to emit a tuple once it received scores from each type of
scoring bolt in the system. In this world, adjusting the factors
determining the makeup of a user&#8217;s feed and their relative weights
would be trivial&#8212;indeed, production experience with just such a
system was, in the opinion of the authors, delightful (see the
<a href="https://github.com/utahstreetlabs/risingtide">Rising Tide project page</a> on GitHub).</p></div>
</div>
<div class="sect4">
<h5 id="_feed_bolt">feed-bolt</h5>
<div class="paragraph"><p>The final bolt aggregates events into feeds. Since it only receives
(<span class="monospaced">user</span>, <span class="monospaced">event</span>) tuples that the "scoring system" has approved, it
needs only add the event to the existing list of events it has
received for the given user:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>feeds <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> {}<span style="color: #990000">)]</span>
    <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span>
     <span style="font-weight: bold"><span style="color: #000000">(execute</span></span> <span style="color: #990000">[</span>{user <span style="color: #FF0000">"user"</span> event <span style="color: #FF0000">"event"</span> <span style="color: #990000">:</span>as tuple}<span style="color: #990000">]</span>
              <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> feeds #<span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in <span style="color: #990000">%</span> <span style="color: #990000">[</span>user<span style="color: #990000">]</span> conj event<span style="color: #990000">))</span>
              <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="color: #FF0000">"Current feeds:"</span><span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>pprint<span style="color: #990000">/</span>pprint @feeds<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(ack</span></span><span style="color: #990000">!</span> collector tuple<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>This toy topology simply prints the current feeds every time it
receives a new event, but in the real world it would persist feeds to
a durable datastore or a cache that could efficiently serve the feeds
to users.</p></div>
<div class="paragraph"><p>Note that this design can be easily extended to support event
digesting; rather than storing each event separately, it could
aggregate an incoming event with other similar events for the user&#8217;s
convenience.</p></div>
<div class="paragraph"><p>As described, this system has one enormous flaw: by default,
Storm tuples are delivered to exactly one instance of each bolt, and
the number of instances in existence is not defined in the bolt
implementation. If the topology operator adds more than one
<span class="monospaced">feed-bolt</span>, we may have events for the same user delivered to
different bolt instances, giving each bolt a different feed for the
same user.</p></div>
<div class="paragraph"><p>Happily, this flaw is addressed by Storm&#8217;s support for <em>stream
grouping</em>, which is defined in the Storm topology definition.</p></div>
</div>
<div class="sect4">
<h5 id="_topology">Topology</h5>
<div class="paragraph"><p>The topology definition is where the rubber meets the road. Spouts are
wired to bolts, which are wired to other bolts, and the flow of tuples
between them can be configured to give useful properties to the
computation.</p></div>
<div class="paragraph"><p>This is also where you define the component-level
parallelism of the topology, which provides a rough sketch of the true
operational parallelism of the system.</p></div>
<div class="paragraph"><p>A topology definition consists of spout specifications and bolt
specifications, each of which is a map from names to specifications.</p></div>
<div class="paragraph"><p>Spout specifications simply give a name to a spout implementation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   {<span style="color: #FF0000">"events"</span> <span style="font-weight: bold"><span style="color: #000000">(spout</span></span><span style="color: #990000">-</span>spec event<span style="color: #990000">-</span>spout<span style="color: #990000">)</span>}</tt></pre></div></div>
<div class="paragraph"><p>Multiple spouts can be configured, and the specification may define
the parallelism of the spout:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   {
     <span style="color: #FF0000">"events"</span> <span style="font-weight: bold"><span style="color: #000000">(spout</span></span><span style="color: #990000">-</span>spec event<span style="color: #990000">-</span>spout<span style="color: #990000">)</span>
     <span style="color: #FF0000">"parallel-spout"</span> <span style="font-weight: bold"><span style="color: #000000">(spout</span></span><span style="color: #990000">-</span>spec a<span style="color: #990000">-</span>different<span style="color: #990000">-</span>more<span style="color: #990000">-</span>parallel<span style="color: #990000">-</span>spout <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span>
   }</tt></pre></div></div>
<div class="paragraph"><p>This definition means the topology will have one instance of
<span class="monospaced">event-spout</span> and two instances of <span class="monospaced">a-different-more-parallel-spout</span>.</p></div>
<div class="paragraph"><p>Bolt definitions get a bit more complicated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #FF0000">"active users"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"events"</span> <span style="color: #990000">:</span>shuffle} active<span style="color: #990000">-</span>user<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">"follows"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"active users"</span> <span style="color: #990000">:</span>shuffle} follow<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>As with the spout spec, you must provide a name for the bolt and
specify its parallelism. In addition, bolts require specifying a
<em>stream grouping</em>, which defines (a) from which component the bolt
receives tuples and (b) how the system chooses which in-memory
instance of the bolt to send tuples to. Both of these cases specify
<span class="monospaced">:shuffle</span>, which means tuples from "events" will be sent to a random
instance of <span class="monospaced">active-user-bolt</span>, and tuples from "active users" will be
sent to a random instance of <span class="monospaced">follow-bolt</span>.</p></div>
<div class="paragraph"><p>As noted, <span class="monospaced">feed-bolt</span> needs to be more careful:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #FF0000">"feeds"</span> <span style="font-weight: bold"><span style="color: #000000">(bolt</span></span><span style="color: #990000">-</span>spec {<span style="color: #FF0000">"follows"</span> <span style="color: #990000">[</span><span style="color: #FF0000">"user"</span><span style="color: #990000">]</span>} feed<span style="color: #990000">-</span>bolt <span style="color: #990000">:</span>p <span style="color: #993399">2</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This bolt spec specifies a <em>fields grouping</em> on "user". This means
that all tuples with the same "user" value will be sent to the
same instance of <span class="monospaced">feed-bolt</span>. This stream grouping is configured with
a list of field names, so field groupings may consider the equality
of multiple field values when determining which bolt instance should
process a given tuple.</p></div>
<div class="paragraph"><p>Storm also supports stream groupings that send tuples to all instances
and groupings that let the bolt producing a tuple determine where to
send it. Combined with the groupings already seen, these provide an
enormous amount of flexibility in determining how data flows through
your topology.</p></div>
<div class="paragraph"><p>Each of these component specifications supports a parallelism option.
Because the topology does not specify the physical hardware upon which
it will run, these hints cannot be used to determine the true
parallelism of the system, but they are used by the cluster to
determine how many in-memory instances of the specified components to
create.</p></div>
</div>
<div class="sect4">
<h5 id="_deployment">Deployment</h5>
<div class="paragraph"><p>The real magic of Storm comes out in deployment. Storm gives you the
tools to build small, independent components that make no
assumptions about how many identical instances are running in the same
topology. This means that the topology itself is essentially
infinitely scalable. The edges of the system, which receive data
from and send data to external components like queues and databases, are
not necessarily as scalable, but in many cases, strategies for scaling
these services are well understood.</p></div>
<div class="paragraph"><p>A simple deployment strategy is built into the Storm library:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #000000">(doto</span></span> <span style="font-weight: bold"><span style="color: #000000">(LocalCluster</span></span><span style="color: #990000">.)</span>
    <span style="color: #990000">(.</span>submitTopology <span style="color: #FF0000">"my first topology"</span>
                     {TOPOLOGY<span style="color: #990000">-</span>DEBUG <span style="font-weight: bold"><span style="color: #000000">(Boolean</span></span><span style="color: #990000">/</span>parseBoolean debug<span style="color: #990000">)</span>
                      TOPOLOGY<span style="color: #990000">-</span>WORKERS <span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>parseInt workers<span style="color: #990000">)</span>}
                     <span style="font-weight: bold"><span style="color: #000000">(storm</span></span><span style="color: #990000">-</span>topology<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">LocalCluster</span> is an in-memory implementation of a Storm cluster. You can
specify the number of <em>workers</em> it will use to execute the
components of your topology and submit the topology itself, at which
point it begins polling the <span class="monospaced">nextTuple</span> methods of the topology&#8217;s
spouts. As spouts emit tuples, they are propagated through the system
to complete the topology&#8217;s computation.</p></div>
<div class="paragraph"><p>Submitting the topology to a configured cluster is nearly as simple,
as you can see in <em>src/feeds/TopologySubmitter.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> <span style="color: #990000">-</span>main <span style="color: #990000">[&amp;</span> {debug <span style="color: #FF0000">"debug"</span> workers <span style="color: #FF0000">"workers"</span> <span style="color: #990000">:</span>or {debug <span style="color: #FF0000">"false"</span> workers <span style="color: #FF0000">"4"</span>}}<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(StormSubmitter</span></span><span style="color: #990000">/</span>submitTopology
   <span style="color: #FF0000">"feeds topology"</span>
   {TOPOLOGY<span style="color: #990000">-</span>DEBUG <span style="font-weight: bold"><span style="color: #000000">(Boolean</span></span><span style="color: #990000">/</span>parseBoolean debug<span style="color: #990000">)</span>
    TOPOLOGY<span style="color: #990000">-</span>WORKERS <span style="font-weight: bold"><span style="color: #000000">(Integer</span></span><span style="color: #990000">/</span>parseInt workers<span style="color: #990000">)</span>}
   <span style="font-weight: bold"><span style="color: #000000">(storm</span></span><span style="color: #990000">-</span>topology<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>This file uses Clojure&#8217;s Java interop to generate a Java class with a
<span class="monospaced">main</span> method. Because the <em>project.clj</em> file specifies that this file
should be ahead-of-time compiled, when you use <span class="monospaced">lein uberjar</span> to build
a JAR suitable for submission to the cluster, this file will be
compiled to look like a normal Java class file. You can upload this JAR
to the machine running Storm&#8217;s <em>Nimbus</em> daemon and submit it for
execution using the <span class="monospaced">storm</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ storm jar path/to/thejariuploaded<span style="color: #990000">.</span>jar feeds<span style="color: #990000">.</span>TopologySubmitter <span style="color: #FF0000">"workers"</span> <span style="color: #993399">5</span></tt></pre></div></div>
<div class="paragraph"><p>This command will tell the cluster to allocate five dedicated workers for
this topology and begin polling <span class="monospaced">nextTuple</span> on all of its spouts, as
it did when you used <span class="monospaced">LocalCluster</span>. A cluster may run any number of
topologies simultaneously&#8212;each worker is a physical JVM and may end
up running instances of many different bolts and spouts.</p></div>
<div class="paragraph"><p>The full details of setting up and running a Storm cluster are out of
the scope of this recipe, but they are documented extensively on
Storm&#8217;s wiki.</p></div>
</div>
<div class="sect4">
<h5 id="_conclusion">Conclusion</h5>
<div class="paragraph"><p>We&#8217;ve only touched on a fraction of the functionality Storm has to
offer. Built-in distributed remote procedure calls allow users to
harness the power of a Storm cluster to make synchronous requests
that trigger a flurry of activity across hundreds or thousands of
machines. Guaranteed data-processing semantics allow users to build
extremely robust systems. Trident, a higher-level abstraction over
Storm&#8217;s primitives, provides breathtakingly simple solutions to
complicated real-time computing problems. A detailed runtime console
provides crucial insight into the runtime characteristics of a fully
operational Storm cluster. The power provided by this system is truly
remarkable.</p></div>
<div class="paragraph"><p>Storm is also a fantastic example of Clojure&#8217;s ability to be extended
to a problem domain. Its constructs idiomatically extend Clojure
syntax and allow the programmer to stay within the domain of real-time
processing, without needing to deal with low-level language
formalities. This allows Storm to truly get out of the way. The
majority of the code in a well-written Storm topology&#8217;s code base is
focused on the problem at hand. The result is concise, maintainable
code and happy programmers.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_154">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://storm.apache.org/">Storm&#8217;s website</a>
</p>
</li>
<li>
<p>
The Storm <a href="http://bit.ly/storm-template">project template</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/nathanmarz/storm-deploy"><span class="monospaced">storm-deploy</span></a>, a tool for easy Storm deployment
</p>
</li>
<li>
<p>
<a href="https://github.com/utahstreetlabs/risingtide">Rising Tide</a>, the feed
  generation service on which this recipe is based
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_cascalog_etl">Processing Data with an Extract Transform Load (ETL) Pipeline</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_156">Problem</h4>
<div class="paragraph"><p>You need to change the format of large amounts of data from JSON lists
to CSV for later processing. For example, you want to turn this input:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"name": "<span style="color: #FF0000">Clojure Programming</span>"<span style="color: #990000">,</span> "authors": <span style="color: #990000">[</span>"Chas Emerick"<span style="color: #990000">,</span>
                                            "Brian Carper"<span style="color: #990000">,</span>
                                            "Christophe Grand"<span style="color: #990000">]}</span>
<span style="color: #990000">{</span>"name": "<span style="color: #FF0000">The Joy of Clojure</span>"<span style="color: #990000">,</span> "authors": <span style="color: #990000">[</span>"Michael Fogus"<span style="color: #990000">,</span> "Chris Houser"<span style="color: #990000">]}</span></tt></pre></div></div>
<div class="paragraph"><p>into this output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Chas Emerick,Brian Carper,Christophe Grand
Michael Fogus,Chris Houser</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_solution_154">Solution</h4>
<div class="paragraph"><p>Cascalog allows you to write distributed processing jobs that can run
locally for small jobs or on a Hadoop cluster for larger jobs.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a new Leiningen project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new cookbook</tt></pre></div></div>
<div class="paragraph"><p>Modify your new project&#8217;s <em>project.clj</em> file by adding the <span class="monospaced">cascalog</span>
dependency, setting up the <span class="monospaced">:dev</span> profile, and enabling
AOT compilation for the <span class="monospaced">cookbook.etl</span> namespace. Your <em>project.clj</em>
file should now look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> cookbook <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>cascalog <span style="color: #FF0000">"1.10.2"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>data<span style="color: #990000">.</span>json <span style="color: #FF0000">"0.2.2"</span><span style="color: #990000">]]</span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>hadoop<span style="color: #990000">/</span>hadoop<span style="color: #990000">-</span>core <span style="color: #FF0000">"1.1.2"</span><span style="color: #990000">]]</span>}}
  <span style="color: #990000">:</span>aot <span style="color: #990000">[</span>cookbook<span style="color: #990000">.</span>etl<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Create the file <em>src/cookbook/etl.clj</em> and add a query to it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>etl
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>data<span style="color: #990000">.</span>json <span style="color: #990000">:</span>as json<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> get<span style="color: #990000">-</span>vec
  <span style="color: #FF0000">"Wrap the result in a vector for Cascalog to consume."</span>
  <span style="color: #990000">[</span>m k<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(vector</span></span>
   <span style="font-weight: bold"><span style="color: #000000">(get</span></span> m k<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> vec<span style="color: #990000">-&gt;</span>csv
  <span style="color: #FF0000">"Turn a vector into a CSV string. (Not production quality)."</span>
  <span style="color: #990000">[</span>v<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> str <span style="font-weight: bold"><span style="color: #000000">(interpose</span></span> <span style="color: #FF0000">","</span> v<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defmain</span></span> Main <span style="color: #990000">[</span>in out <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span>
  <span style="color: #990000">(?&lt;-</span>
    <span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline out <span style="color: #990000">:</span>sinkmode <span style="color: #990000">:</span>replace<span style="color: #990000">)</span>
    <span style="color: #990000">[?</span>out<span style="color: #990000">-</span>csv<span style="color: #990000">]</span>
    <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline in<span style="color: #990000">)</span> <span style="color: #990000">?</span>in<span style="color: #990000">-</span>json<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>str <span style="color: #990000">?</span>in<span style="color: #990000">-</span>json <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>book<span style="color: #990000">-</span>map<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>vec <span style="color: #990000">?</span>book<span style="color: #990000">-</span>map <span style="color: #FF0000">"authors"</span> <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>authors<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(vec</span></span><span style="color: #990000">-&gt;</span>csv <span style="color: #990000">?</span>authors <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>out<span style="color: #990000">-</span>csv<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Create a file with input data in <em>samples/books/books.json</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"name": "<span style="color: #FF0000">Clojure Cookbook</span>"<span style="color: #990000">,</span> "authors": <span style="color: #990000">[</span>"Ryan"<span style="color: #990000">,</span> "Luke"<span style="color: #990000">]}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The full contents of this solution are available on GitHub in the
<a href="http://bit.ly/cc-cascalog-samples">Cascalog samples</a>
repository.</p></div>
<div class="paragraph"><p>To retrieve a copy of the working project, clone the project from
GitHub and check out the <span class="monospaced">etl-sample</span> branch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git clone https<span style="color: #990000">:</span>//github<span style="color: #990000">.</span>com/clojure-cookbook/cascalog-samples<span style="color: #990000">.</span>git
$ cd cascalog-samples
$ git checkout etl-sample</tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can now execute the job locally with <strong><span class="monospaced">lein run</span></strong>, providing an
input and output file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run -m cookbook<span style="color: #990000">.</span>etl<span style="color: #990000">.</span>Main samples/books/books<span style="color: #990000">.</span>json samples/books/output

<span style="font-style: italic"><span style="color: #9A1900"># Or, on a Hadoop cluster</span></span>
$ lein uberjar
$ hadoop jar target/cookbook-standalone<span style="color: #990000">.</span>jar cookbook<span style="color: #990000">.</span>etl<span style="color: #990000">.</span>Main <span style="color: #990000">\</span>
  books<span style="color: #990000">.</span>json books<span style="color: #990000">.</span>csv</tt></pre></div></div>
<div class="paragraph"><p>The results in <em>samples/books/output/part-00000</em> are as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Ryan,Luke</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_156">Discussion</h4>
<div class="paragraph"><p>While it would be easy to write a script that converted JSON to CSV,
it would be a lot of work to convert the script to run across many
computers. Writing the transform script using Cascalog allows it to
run in local mode or distributed mode with almost no modification.</p></div>
<div class="paragraph"><p>There are a lot of new concepts and syntax in the preceding small example,
so let&#8217;s break it down piece by piece.</p></div>
<div class="paragraph"><p>In this recipe, the data flows through the functions roughly in order.
The first line uses the <span class="monospaced">defmain</span> macro (from Cascalog)
to define a class with a <span class="monospaced">-main</span> function that lets you run the query
over Hadoop. In this case, the class with a <span class="monospaced">-main</span> function is called
<span class="monospaced">Main</span>, but that is not required. <span class="monospaced">defmain</span> allows you to create
several Hadoop-enabled queries in the same file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmain</span></span> Main <span style="color: #990000">[</span>in out <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Inside the <span class="monospaced">Main</span> function is a Cascalog operator, <literal>?&#x003C;-</literal>,<span class="footnote"><br>[While queries <em>look</em> like regular Clojure, they are in fact a DSL. If you&#8217;re not familiar with Cascalog queries, learn more in Nathan Marz&#8217;s <a href="http://bit.ly/cascalog-intro-post">"Introducing Cascalog" article</a>.]<br></span> that defines and executes a query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(?&lt;-</span></tt></pre></div></div>
<div class="paragraph"><p>This operator takes an output location (called a "tap" in Cascalog), a result vector,
and a series of logic predicates. The next line is the destination, the place the output will be written to. The same functions are used to create input and output taps:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline out <span style="color: #990000">:</span>sinkmode <span style="color: #990000">:</span>replace<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This example uses
<span class="monospaced">hfs-textline</span>, but many other taps exist. You can even write your
own.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Use <span class="monospaced">:sinkmode :replace</span> in your output tap, and Cascalog will replace
any existing output. This helps while you are rerunning the query to
debug it. Otherwise, you will have to remove the output file every time
you want to rerun.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This is a list of all the logic variables that should be returned from
this query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[?</span>out<span style="color: #990000">-</span>csv<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>In this case, these are the logic variables that will be
dumped into the output location. Cascalog knows these are special
logic variables because their names begin with a <span class="monospaced">?</span> or a <span class="monospaced">!</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>When thinking about logic variables, it helps to think of them as
containing all possible valid values. As you add predicates, you either
introduce new logic variables that are (hopefully) linked to existing
variables, or you add constraints to existing logic variables.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The next line defines the input tap. The JSON data structures will be read
in one line at a time from the location specified by <span class="monospaced">in</span>. Each line
will be stored into the <span class="monospaced">?in-json</span> logic var, which will flow through
the rest of the logic predicates:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline in<span style="color: #990000">)</span> <span style="color: #990000">?</span>in<span style="color: #990000">-</span>json<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">read-str</span> parses the JSON string found in <span class="monospaced">?in-json</span> into a hash map,
which is stored into <span class="monospaced">?book-map</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(json</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>str <span style="color: #990000">?</span>in<span style="color: #990000">-</span>json <span style="color: #990000">?</span>book<span style="color: #990000">-</span>map<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now you pull the authors out of the map and store the vector into its
own logic variable. Cascalog assumes vector output means binding
multiple logic vars. To outsmart Cascalog, wrap the output in an extra
vector for Cascalog to consume:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>vec <span style="color: #990000">?</span>book<span style="color: #990000">-</span>map <span style="color: #FF0000">"authors"</span> <span style="color: #990000">?</span>authors<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, you convert the vector of authors into valid CSV using the
<span class="monospaced">vec-&gt;csv</span> function. Since this line produces values for the
<span class="monospaced">?out-csv</span> logic variable, which is named in the output line earlier,
the query will produce the output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(vec</span></span><span style="color: #990000">-&gt;</span>csv <span style="color: #990000">?</span>authors <span style="color: #990000">?</span>out<span style="color: #990000">-</span>csv<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Cascalog is a great tool for building an extract transform load (ETL)
pipeline. It allows you to spend more time thinking about your data
and less time thinking about the mechanics of reading files,
distributing work, or managing dependencies. When writing your own ETL
pipelines, it might help to follow this process:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Finalize the input format(s).
</p>
</li>
<li>
<p>
Finalize the output format(s).
</p>
</li>
<li>
<p>
Start working from the input format, keeping track of the current
  format for each step.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_see_also_155">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Ian Rumford&#8217;s blog post <a href="http://bit.ly/cascalog-etl-post">"Using Cascalog for Extract Transform and Load"</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/clojure/core.logic"><span class="monospaced">core.logic</span></a>, a logic
  programming library for Clojure
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_aggregating_large_files">Aggregating Large Files</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_157">Problem</h4>
<div class="paragraph"><p>You need to generate aggregate statistics from terabytes of log files.
For example, for a simple input log file (<span class="monospaced">&lt;date&gt;,&lt;URL&gt;,&lt;USER-ID&gt;</span>):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>20130512020202,/,11
20130512020412,/,23
20130512030143,/post/clojure,11
20130512040256,/post/datomic,23
20130512050910,/post/clojure,11
20130512051012,/post/clojure,14</pre>
</div></div>
<div class="paragraph"><p>you want to output aggregate statistics like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{
"URL"  {"/"              2
        "/post/datomic"  1
        "/post/clojure"  3}
"User" {"23" 2
        "11" 3
        "14" 1}
"Day"  {"20130512" 6}
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_solution_155">Solution</h4>
<div class="paragraph"><p>Cascalog allows you to write distributed processing jobs that run
locally or on a Hadoop cluster.</p></div>
<div class="paragraph"><p>To follow along with this recipe, clone the
<a href="http://bit.ly/cc-cascalog-samples">Cascalog samples
GitHub repository</a> and check out the <span class="monospaced">aggregation-begin</span> branch. This
will give you a basic Cascalog project as created in
<a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git clone https<span style="color: #990000">:</span>//github<span style="color: #990000">.</span>com/clojure-cookbook/cascalog-samples<span style="color: #990000">.</span>git
$ cd cascalog-samples
$ git checkout aggregation-begin</tt></pre></div></div>
<div class="paragraph"><p>Now add <span class="monospaced">[cascalog/cascalog-more-taps "2.0.0"]</span> to the project&#8217;s
dependencies and set the <span class="monospaced">cookbook.aggregation</span> namespace to be
AOT-compiled. <em>project.clj</em> should look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> cookbook <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>description <span style="color: #FF0000">"FIXME: write description"</span>
  <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://example.com/FIXME"</span>
  <span style="color: #990000">:</span>license {<span style="color: #990000">:</span>name <span style="color: #FF0000">"Eclipse Public License"</span>
            <span style="color: #990000">:</span>url <span style="color: #FF0000">"http://www.eclipse.org/legal/epl-v10.html"</span>}
  <span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>clojure <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>cascalog <span style="color: #FF0000">"2.0.0"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>cascalog<span style="color: #990000">/</span>cascalog<span style="color: #990000">-</span>more<span style="color: #990000">-</span>taps <span style="color: #FF0000">"2.0.0"</span><span style="color: #990000">]</span>
                 <span style="color: #990000">[</span>org<span style="color: #990000">.</span>clojure<span style="color: #990000">/</span>data<span style="color: #990000">.</span>json <span style="color: #FF0000">"0.2.2"</span><span style="color: #990000">]]</span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>hadoop<span style="color: #990000">/</span>hadoop<span style="color: #990000">-</span>core <span style="color: #FF0000">"1.1.2"</span><span style="color: #990000">]]</span>}}
  <span style="color: #990000">:</span>aot <span style="color: #990000">[</span>cookbook<span style="color: #990000">.</span>etl
        cookbook<span style="color: #990000">.</span>aggregation<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Create the file <em>src/cookbook/aggregation.clj</em> and add an aggregation query to it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>aggregation
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>more<span style="color: #990000">-</span>taps <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>hfs<span style="color: #990000">-</span>delimited<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> init<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats <span style="color: #990000">[</span>date url user<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>day <span style="color: #990000">(.</span>substring date <span style="color: #993399">0</span> <span style="color: #993399">8</span><span style="color: #990000">)]</span>
    {<span style="color: #FF0000">"URL"</span>  {url <span style="color: #993399">1</span>}
     <span style="color: #FF0000">"User"</span> {user <span style="color: #993399">1</span>}
     <span style="color: #FF0000">"Day"</span>  {date <span style="color: #993399">1</span>}}<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> combine<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats
  <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> merge<span style="color: #990000">-</span>with <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> merge<span style="color: #990000">-</span>with <span style="color: #990000">+)))</span>

<span style="font-weight: bold"><span style="color: #000000">(defparallelagg</span></span> aggregate<span style="color: #990000">-</span>stats
  <span style="color: #990000">:</span>init<span style="color: #990000">-</span>var    #'init<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats
  <span style="color: #990000">:</span>combine<span style="color: #990000">-</span>var #'combine<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defmain</span></span> Main <span style="color: #990000">[</span>in out <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span>
  <span style="color: #990000">(?&lt;-</span>
    <span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline out <span style="color: #990000">:</span>sinkmode <span style="color: #990000">:</span>replace<span style="color: #990000">)</span>
    <span style="color: #990000">[?</span>out<span style="color: #990000">]</span>
    <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>delimited in <span style="color: #990000">:</span>delimiter <span style="color: #FF0000">","</span><span style="color: #990000">)</span> <span style="color: #990000">?</span>date <span style="color: #990000">?</span>url <span style="color: #990000">?</span>user<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(aggregate</span></span><span style="color: #990000">-</span>stats <span style="color: #990000">?</span>date <span style="color: #990000">?</span>url <span style="color: #990000">?</span>user <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>out<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Add some sample data to the file <em>samples/posts/posts.csv</em>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>20130512020202,/,11
20130512020412,/,23
20130512030143,/post/clojure,11
20130512040256,/post/datomic,23
20130512050910,/post/clojure,11
20130512051012,/post/clojure,14</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The full contents of this solution are available in the
<span class="monospaced">aggregation-complete</span> branch of the
<a href="http://bit.ly/cc-cascalog-samples">Cascalog samples</a>
repository.</p></div>
<div class="paragraph"><p>Check out that branch to retrieve a full working copy with sample data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git checkout aggregation-complete</tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can now execute the job locally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run -m cookbook<span style="color: #990000">.</span>aggregation<span style="color: #990000">.</span>Main <span style="color: #990000">\</span>
  samples/posts/posts<span style="color: #990000">.</span>csv samples/posts/output

<span style="font-style: italic"><span style="color: #9A1900"># Or, on a Hadoop cluster</span></span>
$ lein uberjar
$ hadoop jar target/cookbook-standalone<span style="color: #990000">.</span>jar <span style="color: #990000">\</span>
             cookbook<span style="color: #990000">.</span>aggregation<span style="color: #990000">.</span>Main <span style="color: #990000">\</span>
             samples/posts/posts<span style="color: #990000">.</span>csv samples/posts/output</tt></pre></div></div>
<div class="paragraph"><p>The results in <em>samples/posts/output/part-00000</em>, formatted for
readability, are as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{
"URL"  {"/"              2
        "/post/datomic"  1
        "/post/clojure"  3}
"User" {"23" 2
        "11" 3
        "14" 1}
"Day"  {"20130512" 6}
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_157">Discussion</h4>
<div class="paragraph"><p>Cascalog makes it easy to quickly generate aggregate
statistics. Aggregate statistics can be tricky on some MapReduce
frameworks. In general, the map phase of a MapReduce job is well
distributed across the cluster. The reduce phase is often less well
distributed. For instance, a naive implementation of the aggregation
algorithm would end up doing all of the aggregation work on a single
reducer. A 2,000-computer cluster would be as slow as a 1-computer
cluster during the reduce phase if all the aggregation happened on one
node.</p></div>
<div class="paragraph"><p>Before you start writing your own aggregator, check through the source
of <span class="monospaced">cascalog.logic.ops</span>. This namespace has many useful functions and
probably already does what you want to do.</p></div>
<div class="paragraph"><p>In our example, the goal is to count occurrences of each URL. To
create the final map, all of the URLs need to end up in one reducer. A
naive MapReduce program implementation would use an aggregation over
all the tuples. That means you&#8217;d be doing all the work on only one
node, with the computation taking just as long as it would on a single
computer.</p></div>
<div class="paragraph"><p>The solution is to use Hadoop&#8217;s <em>combiner</em> function. Combiners run on
the result of the map phase, before the output is sent to the
reducers. Most importantly, the combiner runs on the mapper
nodes. That means combiner work is spread across the entire cluster,
like map work. When the majority of the work is done during the map
and combiner phases, the reduce phase can run almost
instantly. Cascalog makes this very easy. Many of the built-in
Cascalog functions use combiners under the covers, so you&#8217;ll be
writing highly optimized queries without even trying. You can even
write your own functions to use combiners using the <span class="monospaced">defparallelagg</span>
macro.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Cascalog often works with vars instead of the values of those
vars. For example, the call to <span class="monospaced">defparallelagg</span> takes quoted
arguments. The <span class="monospaced">#'</span> syntax means that the var is being passed, not the
value that the var refers to. Cascalog passes the vars around instead
of values so that it doesn&#8217;t have to serialize functions to pass them
to the mappers and reducers. It just passes the name of the var, which
is looked up in the remote execution environment. This means you won&#8217;t
be able to dynamically construct functions for some parts of the
Cascalog workflow. Most functions need to be bound to a var.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><span class="monospaced">defparallelagg</span> is kind of confusing at first, but the power to write
queries that leverage combiners makes it worth learning. You need to
provide two vars that point to functions to the <span class="monospaced">defparallelagg</span>
call: <span class="monospaced">init-var</span> and <span class="monospaced">combine-var</span>. Note that both arguments are being
passed as vars, not function values, so you need to prepend a <span class="monospaced">#'</span> to
the names. The <span class="monospaced">init-var</span> function needs to take the input data and
change it into a format that can be easily processed by the
<span class="monospaced">combine-var</span> function. In this case, the recipe changes the data into
a map of maps that can easily be merged. Merging maps is an easy way
to write parallel aggregators. The <span class="monospaced">combine-var</span> function needs to be
commutative and associative. The function is called with two instances
of the output of the <span class="monospaced">init-var</span> function. The return value will be
passed as an argument to later invocations of the <span class="monospaced">combine-var</span>
function. Pairs of output will be combined until there is only one
output left, which is the final output.</p></div>
<div class="paragraph"><p>What follows is an explanation of the query, bit by bit.</p></div>
<div class="paragraph"><p>First, require the Cascalog functions you&#8217;ll need:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>aggregation
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>more<span style="color: #990000">-</span>taps <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>hfs<span style="color: #990000">-</span>delimited<span style="color: #990000">]]))</span></tt></pre></div></div>
<div class="paragraph"><p>Then define a function, <span class="monospaced">init-aggregate-stats</span>, that takes a date, URL, and
user and returns a map of maps. The second level of maps has keys that
correspond to the observed values. This is the <span class="monospaced">init</span> function, which
takes each row and prepares it for aggregation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> init<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats <span style="color: #990000">[</span>date url user<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>day <span style="color: #990000">(.</span>substring date <span style="color: #993399">0</span> <span style="color: #993399">8</span><span style="color: #990000">)]</span>
    {<span style="color: #FF0000">"URL"</span>  {url <span style="color: #993399">1</span>}
     <span style="color: #FF0000">"User"</span> {user <span style="color: #993399">1</span>}
     <span style="color: #FF0000">"Day"</span>  {date <span style="color: #993399">1</span>}}<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">combine-aggregate-stats</span> function takes the output of invoking
the <span class="monospaced">init-aggregate-stats</span> function on all the inputs and combines
it. This function will be called over and over, combining the output
of <span class="monospaced">init-aggregate-stats</span> function calls and the output of other
invocations of itself. Its output should be of the same form as its
input, since this function will be called on pairs of output until
there is only one piece of data left. This function merges the nested
maps, adding the values together when they are in the same key:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> combine<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats
  <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> merge<span style="color: #990000">-</span>with <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> merge<span style="color: #990000">-</span>with <span style="color: #990000">+)))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">aggregate-stats</span> takes the two previous functions and turns them into
a Cascalog parallel-aggregation operation. Note that you pass the
vars, not the functions themselves:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defparallelagg</span></span> aggregate<span style="color: #990000">-</span>stats
  <span style="color: #990000">:</span>init<span style="color: #990000">-</span>var    #'init<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats
  <span style="color: #990000">:</span>combine<span style="color: #990000">-</span>var #'combine<span style="color: #990000">-</span>aggregate<span style="color: #990000">-</span>stats<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, set up <span class="monospaced">Main</span> to define and execute a query that invokes the
<span class="monospaced">aggregate-stats</span> operation across input from <span class="monospaced">in</span>, writing it to
<span class="monospaced">out</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defmain</span></span> Main <span style="color: #990000">[</span>in out <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; This defines and executes a Cascalog query.</span></span>
  <span style="color: #990000">(?&lt;-</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Set up the output path.</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline out <span style="color: #990000">:</span>sinkmode <span style="color: #990000">:</span>replace<span style="color: #990000">)</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Define which logic variables will be output.</span></span>
    <span style="color: #990000">[?</span>out<span style="color: #990000">]</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Set up the input path, and define the logic vars to bind to input.</span></span>
    <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>delimited in<span style="color: #990000">)</span> <span style="color: #990000">?</span>date <span style="color: #990000">?</span>url <span style="color: #990000">?</span>user<span style="color: #990000">)</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Run the aggregation operation.</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(aggregate</span></span><span style="color: #990000">-</span>stats <span style="color: #990000">?</span>date <span style="color: #990000">?</span>url <span style="color: #990000">?</span>user <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>out<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>If the aggregate you want to calculate can&#8217;t be defined using
<span class="monospaced">defparallelagg</span>, Cascalog provides some other options for defining
aggregates. However, many of them don&#8217;t use combiners and could leave
you with almost all the computation happening in a small number of
reducers. The computation will probably finish, but you are losing a
lot of the benefit of distributed computation. Check out the source
of <span class="monospaced">cascalog.logic.ops</span> to see what the different options are and how you
can use them.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_156">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The source of
  <a href="http://bit.ly/cascalog-ops"><span class="monospaced">cascalog.logic.ops</span></a>,
  a namespace with many predefined operations (including
  aggregators)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_cascalog_workflows">Testing Cascalog Workflows</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_158">Problem</h4>
<div class="paragraph"><p>You love testing your code. You love writing Cascalog jobs. You hate
trying to test your Cascalog jobs.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_156">Solution</h4>
<div class="paragraph"><p><a href="http://bit.ly/midje-cascalog">Midje-Cascalog</a> provides a small amount of extra functionality that
makes writing tests for Cascalog jobs quite easy. To follow along with this recipe, clone the
<a href="http://bit.ly/cc-cascalog-samples">Cascalog samples
GitHub repository</a> and check out the <span class="monospaced">testing-begin</span> branch. This will
give you a basic Cascalog project as created in <a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>.</p></div>
<div class="paragraph"><p>Now add the Midje plug-in and Midje-Cascalog dependency to the <span class="monospaced">:dev</span>
profile in your <em>project.clj</em>. The <span class="monospaced">:profiles</span> key should now look
like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> cookbook <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>org<span style="color: #990000">.</span>apache<span style="color: #990000">.</span>hadoop<span style="color: #990000">/</span>hadoop<span style="color: #990000">-</span>core <span style="color: #FF0000">"1.1.2"</span><span style="color: #990000">]</span>
                                  <span style="color: #990000">[</span>cascalog<span style="color: #990000">/</span>midje<span style="color: #990000">-</span>cascalog <span style="color: #FF0000">"2.0.0"</span><span style="color: #990000">]]</span>
                   <span style="color: #990000">:</span>plugins <span style="color: #990000">[[</span>lein<span style="color: #990000">-</span>midje <span style="color: #FF0000">"3.1.1"</span><span style="color: #990000">]]</span>}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Create a simple query in <em>src/cookbook/test_me.clj</em> to write a test
against:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>test<span style="color: #990000">-</span>me
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> capitalize <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>toUpperCase s<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> capitalize<span style="color: #990000">-</span>authors<span style="color: #990000">-</span>query <span style="color: #990000">[</span>author<span style="color: #990000">-</span>path<span style="color: #990000">]</span>
  <span style="color: #990000">(&lt;-</span> <span style="color: #990000">[?</span>capitalized<span style="color: #990000">-</span>author<span style="color: #990000">]</span>
    <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline author<span style="color: #990000">-</span>path<span style="color: #990000">)</span> <span style="color: #990000">?</span>author<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(capitalize</span></span> <span style="color: #990000">?</span>author <span style="color: #990000">:&gt;</span> <span style="color: #990000">?</span>capitalized<span style="color: #990000">-</span>author<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>You can now write a test for this query in
<em>test/cookbook/test_me_test.clj</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>test<span style="color: #990000">-</span>me<span style="color: #990000">-</span>test
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cookbook<span style="color: #990000">.</span>midje<span style="color: #990000">-</span>cascalog <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>midje
              <span style="color: #990000">[</span>sweet <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
              <span style="color: #990000">[</span>cascalog <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(fact</span></span> <span style="color: #FF0000">"Query should return capitalized versions of the input names."</span>
  <span style="font-weight: bold"><span style="color: #000000">(capitalize</span></span><span style="color: #990000">-</span>authors<span style="color: #990000">-</span>query <span style="color: #990000">:</span>author<span style="color: #990000">-</span>path<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(produces</span></span> <span style="color: #990000">[[</span><span style="color: #FF0000">"LUKE VANDERHART"</span><span style="color: #990000">]</span>
                                                        <span style="color: #990000">[</span><span style="color: #FF0000">"RYAN NEUFELD"</span><span style="color: #990000">]])</span>
  <span style="font-weight: bold"><span style="color: #000000">(provided</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(hfs</span></span><span style="color: #990000">-</span>textline <span style="color: #990000">:</span>author<span style="color: #990000">-</span>path<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">[[</span><span style="color: #FF0000">"Luke Vanderhart"</span><span style="color: #990000">]</span>
                                    <span style="color: #990000">[</span><span style="color: #FF0000">"Ryan Neufeld"</span><span style="color: #990000">]]))</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The full contents of this solution are available in the
<span class="monospaced">testing-complete</span> branch of the
<a href="http://bit.ly/cc-cascalog-samples">Cascalog samples
repository</a>.</p></div>
<div class="paragraph"><p>Check out that branch to retrieve a full working copy with sample data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git checkout testing-complete</tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Finally, run the tests with <strong><span class="monospaced">lein midje</span></strong>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein midje
<span style="color: #993399">2013</span>-<span style="color: #993399">11</span>-<span style="color: #993399">09</span> <span style="color: #993399">12</span><span style="color: #990000">:</span><span style="color: #993399">19</span><span style="color: #990000">:</span><span style="color: #993399">27.844</span> java<span style="color: #990000">[</span><span style="color: #993399">3620</span><span style="color: #990000">:</span><span style="color: #993399">1703</span><span style="color: #990000">]</span> Unable to load realm info from
  SCDynamicStore
All checks <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span> succeeded<span style="color: #990000">.</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_158">Discussion</h4>
<div class="paragraph"><p>Unit testing is an important aspect of software craftsmanship.
However, unit testing Hadoop workflows is difficult, to say the least.
Most distributed computing development is done using trial and error,
with only limited manual testing happening before the workflow is
considered "good enough" and put into production use. You shouldn&#8217;t let your code
quality slip, but testing distributed code can be difficult.
Midje-Cascalog makes it easy to test different parts of your Cascalog
workflow by making it dead simple to mock out the results of
subqueries.</p></div>
<div class="paragraph"><p>In the solution outlined, you are testing a simple query. It
reads lines from the input path, capitalizes them, and outputs them.
Normally, you&#8217;d need to make sure part of the test wrote some test
data into a file, reference that file in the test, then clean up
and delete the file. Instead, using Midje-Cascalog, you mock the
<span class="monospaced">hfs-textline</span> call.</p></div>
<div class="paragraph"><p><span class="monospaced">fact</span> is provided by the Midje library, which is well worth
learning on its own. It is an alternative to <span class="monospaced">deftest</span> from
<span class="monospaced">clojure.test</span>. Here, you state the test as a call, followed by an arrow and then
the <span class="monospaced">produces</span> function. <span class="monospaced">produces</span> lets you write out the results of
a query as a vector of vectors. Having established the test, you use
<span class="monospaced">provided</span> to outline the functions you want to mock. This lets you
test only the function in question, and not the functions it depends
on. Testing your Cascalog workflows is as important as testing any other
part of your application. With Midje-Cascalog, this is actually
possible.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_157">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_midje">[sec_midje]</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/midje-cascalog">Midje-Cascalog documentation</a> on GitHub
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_checkpointing_cascalog_jobs">Checkpointing Cascalog Jobs</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_159">Problem</h4>
<div class="paragraph"><p>Your long-running Cascalog jobs throw errors, then need to be
completely restarted. You waste time waiting for steps to rerun when
the problem was later in the workflow.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_157">Solution</h4>
<div class="paragraph"><p><a href="http://bit.ly/cascalog-checkpoint">Cascalog
Checkpoint</a> is an excellent library that provides the ability to add
checkpoints to your Cascalog job. If a step fails, the job is
restarted at that step, instead of restarting from the beginning.</p></div>
<div class="paragraph"><p>In an existing Cascalog project, such as the one generated by
<a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>, add <span class="monospaced">[cascalog/cascalog-checkpoint "1.10.2"]</span> to
your project&#8217;s dependencies and set the <span class="monospaced">cookbook.checkpoint</span>
namespace to be AOT-compiled.</p></div>
<div class="paragraph"><p>Then use Cascalog Checkpoint&#8217;s <span class="monospaced">workflow</span> macro to set up your job. A
hypothetical four-step job would look something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> cookbook<span style="color: #990000">.</span>checkpoint
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>checkpoint <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>workflow<span style="color: #990000">]]))</span>

<span style="font-weight: bold"><span style="color: #000000">(defmain</span></span> Main <span style="color: #990000">[</span>in<span style="color: #990000">-</span>path out<span style="color: #990000">-</span>path <span style="color: #990000">&amp;</span> args<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(workflow</span></span> <span style="color: #990000">[</span><span style="color: #FF0000">"/tmp/log-parsing"</span><span style="color: #990000">]</span>
    step<span style="color: #990000">-</span><span style="color: #993399">1</span> <span style="color: #990000">([:</span>temp<span style="color: #990000">-</span>dirs parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path<span style="color: #990000">]</span>
            <span style="font-weight: bold"><span style="color: #000000">(parse</span></span><span style="color: #990000">-</span>logs in<span style="color: #990000">-</span>path parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path<span style="color: #990000">))</span>
    step<span style="color: #990000">-</span><span style="color: #993399">2</span> <span style="color: #990000">([:</span>temp<span style="color: #990000">-</span>dirs <span style="color: #990000">[</span>min<span style="color: #990000">-</span>path max<span style="color: #990000">-</span>path<span style="color: #990000">]]</span>
            <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>min parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path min<span style="color: #990000">-</span>path<span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #000000">(get</span></span><span style="color: #990000">-</span>max parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path max<span style="color: #990000">-</span>path<span style="color: #990000">))</span>
    step<span style="color: #990000">-</span><span style="color: #993399">3</span> <span style="color: #990000">([:</span>deps step<span style="color: #990000">-</span><span style="color: #993399">1</span> <span style="color: #990000">:</span>temp<span style="color: #990000">-</span>dirs log<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path<span style="color: #990000">]</span>
            <span style="font-weight: bold"><span style="color: #000000">(sample</span></span><span style="color: #990000">-</span>logs parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path log<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path<span style="color: #990000">))</span>
    step<span style="color: #990000">-</span><span style="color: #993399">4</span> <span style="color: #990000">([:</span>deps <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="font-weight: bold"><span style="color: #000000">(summary</span></span> parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path
                     min<span style="color: #990000">-</span>path
                     max<span style="color: #990000">-</span>path
                     log<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path
                     out<span style="color: #990000">-</span>path<span style="color: #990000">))))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_159">Discussion</h4>
<div class="paragraph"><p>Cascalog jobs often take hours to run. There are few things more
frustrating than a typo in the last step breaking a job that has been
running all weekend. Cascalog Checkpoint provides the <span class="monospaced">workflow</span>
macro, which allows you to restart a job from the last step that
successfully completed.</p></div>
<div class="paragraph"><p>The <span class="monospaced">workflow</span> macro expects its first argument, <span class="monospaced">checkpoint-dir</span>, to
be a vector with a path for temporary files.  The output of each step
is temporarily stored in folders inside this path, along with some
files to keep track of what steps have successfully completed.</p></div>
<div class="paragraph"><p>After the first argument, <span class="monospaced">workflow</span> expects pairs of step names and
step definitions. A step definitions is a vector of options, followed
by as many Cascalog queries as desired for that step. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>step<span style="color: #990000">-</span><span style="color: #993399">3</span> <span style="color: #990000">([:</span>deps step<span style="color: #990000">-</span><span style="color: #993399">1</span> <span style="color: #990000">:</span>temp<span style="color: #990000">-</span>dirs <span style="color: #990000">[</span>log<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path log<span style="color: #990000">-</span>other<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path<span style="color: #990000">]]</span>
        <span style="font-weight: bold"><span style="color: #000000">(sample</span></span><span style="color: #990000">-</span>logs parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path log<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">(other</span></span><span style="color: #990000">-</span>sample<span style="color: #990000">-</span>logs parsed<span style="color: #990000">-</span>logs<span style="color: #990000">-</span>path log<span style="color: #990000">-</span>other<span style="color: #990000">-</span>sample<span style="color: #990000">-</span>path<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>This step definition defines <span class="monospaced">step-3</span>. It depends on <span class="monospaced">step-1</span>, so it
won&#8217;t run until <span class="monospaced">step-1</span> has completed. This step creates two temporary
directories for its queries. Both <span class="monospaced">:deps</span> and <span class="monospaced">:temp-dirs</span> can be
either a symbol or a vector of symbols, or can be omitted. After the
options vector, you can include one or many Cascalog queries; in this
case, there are two queries.</p></div>
<div class="paragraph"><p><span class="monospaced">:deps</span> can take several different values. <span class="monospaced">:last</span>, which is
the default value, makes the step depend on the step before
it. <span class="monospaced">:all</span> makes the step depend on all previously defined steps. Providing a
symbol, or vector of symbols, makes that step depend on that particular step or steps. A step won&#8217;t run until everything it depends upon has
completed. If several steps have their dependencies met, they will all
run in parallel.</p></div>
<div class="paragraph"><p>Every symbol provided to <span class="monospaced">:temp-dirs</span> is turned into a directory
within the temp directory. Later steps can use these directories to
read data output by earlier steps. These directories are cleaned up
once the workflow successfully runs all the way through. Until then,
these directories hold the output from the different steps so the
workflow can resume from the last incomplete step.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you want to restart a step that successfully completed, delete the
file at <em>&lt;checkpoint-dir&gt;/&lt;step-name&gt;</em>. The <span class="monospaced">:temp-dirs</span> from the step
definitions can be found in <em>&lt;checkpoint-dir&gt;/data/&lt;temp-dir&gt;</em>, in case
you need to delete or modify the data there.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Another method for dealing with errors is providing error taps for
your Cascalog queries. Cascalog will put the input tuples that cause
errors in a query into the error tap (for different processing or to dump for
manual inspection). With error taps in place, a couple of malformed
inputs won&#8217;t bring down your entire workflow.</p></div>
<div class="paragraph"><p>Checkpointing your Cascalog jobs is a little bit of extra work
initially, but it&#8217;ll save you a lot of time.  Things will go
wrong. The cluster will go down. You&#8217;ll discover typos and edge
cases. It is wonderful to be able to restart your job from the last
step that worked, instead of waiting for the entire thing to rerun
every time.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_158">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The
  <a href="http://bit.ly/cascalog-checkpoint"><span class="monospaced">cascalog.checkpoint</span>
  project page</a> on <phrase role='keep-together'>GitHub</phrase>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_explaining_a_cascalog_query">Explaining a Cascalog Query</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_160">Problem</h4>
<div class="paragraph"><p>Your Cascalog job runs very slowly and you aren&#8217;t sure why.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_158">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">cascalog.api/explain</span> function to print out a DOT file of
your query. You can follow along by launching a REPL in an existing
project, like that created in <a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>cascalog<span style="color: #990000">.</span>api <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>explain <span style="color: #990000">&lt;-]])</span>

<span style="font-weight: bold"><span style="color: #000000">(explain</span></span> <span style="color: #FF0000">"slow-query.dot"</span> <span style="color: #990000">(&lt;-</span> <span style="color: #990000">[?</span>a <span style="color: #990000">?</span>b<span style="color: #990000">]</span> <span style="color: #990000">([[</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #990000">]]</span> <span style="color: #990000">?</span>a <span style="color: #990000">?</span>b<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Next, you&#8217;ll want to view the DOT file. There are many ways to do that,
but the easiest is probably by using <span class="monospaced">dot</span>, one of the Graphviz tools,
to convert a DOT file to a PNG or GIF:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ dot -Tpng -oslow-query<span style="color: #990000">.</span>png slow-query<span style="color: #990000">.</span>dot</tt></pre></div></div>
<div class="paragraph"><p>Now open <em>slow-query.png</em> (shown in <a href="#fig9-1">[fig9-1]</a>) to see a diagram of your query.</p></div>
<div class="imageblock" id="fig9-1" style="float:true;">
<div class="content">
<img src="images/clcb_0901.png" alt="images/clcb_0901.png">
</div>
<div class="title">Figure 6. <em>slow-query.png</em></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_160">Discussion</h4>
<div class="paragraph"><p>Cascalog workflows compile into Cascading workflows. <a href="http://www.cascading.org/">Cascading</a> is a
Java library that wraps Hadoop, providing a flow-based plumbing
abstraction. The query graph in the DOT file will have different
Cascading elements as nodes.</p></div>
<div class="paragraph"><p>The <span class="monospaced">explain</span> function here is analogous to the EXPLAIN command in
many SQL implementations. <span class="monospaced">explain</span> causes Cascalog to print out the
query plan. And as with the output from an SQL EXPLAIN, you might have
to work to understand exactly what you are seeing.</p></div>
<div class="paragraph"><p>The biggest thing to look for is that the basic flow of the query is
what you expected. Make sure that you aren&#8217;t rerunning some parts of
your query. Cascalog makes it easy to reuse queries, but often you
want to run the query, save the results, then reference the saved
results from other queries instead of running it once for every time
its output is used.</p></div>
<div class="paragraph"><p>You can also work to match up the phases from your query plan to a job
as it is running. This is tricky, because the phases won&#8217;t correspond
exactly to your output map. However, when you succeed, you&#8217;ll be able
be able to track down the slow phases.</p></div>
<div class="paragraph"><p>In general, to keep your Cascalog queries fast, make sure you are
using all of the nodes in your cluster. That means keeping the work in
small, evenly sized units. If one map input takes 1,000 times as long
to run as the other 40 inputs, your whole job will wait on the one
mapper to finish. Working to split the long map job into 1,000 smaller
jobs would make the job run much faster, since it could be
distributed across the entire cluster instead of running on a single
node. It is particularly easy to accidentally have nearly the entire
job end up in one reducer. This is easy to see happening in the Hadoop
job tracker, when nearly all the reducers are done and the job is
waiting on one or two reducers to finish. To fix this, do as much
reduce work as possible during the map phase using aggregators, and
then make sure that the remaining reduce work isn&#8217;t all piling up into
a small number of reducers.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_159">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_aggregating_large_files">[sec_aggregating_large_files]</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/cascalog-flow-vis">"Cascading
  Flow Visualization"</a> on Cascalog <phrase role='keep-together'>wiki</phrase>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_cascalog_emr">Running a Cascalog Job on Elastic MapReduce</h3>
<div class="paragraph byline"><p>by Alex Robbins</p></div>
<div class="sect3">
<h4 id="_problem_161">Problem</h4>
<div class="paragraph"><p>You have a large amount of data to process, but you don&#8217;t have a
Hadoop cluster.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_159">Solution</h4>
<div class="paragraph"><p>Amazon&#8217;s <a href="http://aws.amazon.com/elasticmapreduce/">Elastic MapReduce</a> (EMR) provides on-demand Hadoop clusters.
You&#8217;ll need <a href="http://aws.amazon.com/">an Amazon Web Services account</a> to use EMR.</p></div>
<div class="paragraph"><p>First, write a Cascalog job as you normally would. There are a number
of recipes in this chapter that can help you create a complete
Cascalog job. If you don&#8217;t have your own, you can clone
<a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git clone https<span style="color: #990000">:</span>//github<span style="color: #990000">.</span>com/clojure-cookbook/cascalog-samples<span style="color: #990000">.</span>git
$ cd cascalog-samples
$ git checkout etl-sample</tt></pre></div></div>
<div class="paragraph"><p>Once you have a Cascalog project, package it into an uberjar:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein compile
$ lein uberjar</tt></pre></div></div>
<div class="paragraph"><p>Next, upload the generated JAR
(<em>target/cookbook-0.1.0-SNAPSHOT-standalone.jar</em> if you&#8217;re
following along with the ETL sample) to S3. If you
haven&#8217;t ever uploaded a file to S3, follow the S3 documentation to
<a href="http://bit.ly/create-bucket">"Create
a Bucket"</a> and for
<a href="http://bit.ly/add-object-bucket">"Adding
an Object to a Bucket"</a>. Repeat this process to upload your input data.
Take note of the path to the JAR and the input data location.</p></div>
<div class="paragraph"><p>To create your MapReduce job, visit
<a href="https://console.aws.amazon.com/elasticmapreduce/">https://console.aws.amazon.com/elasticmapreduce/</a> and select "Create
New Job Flow" (<a href="#fig9-2">[fig9-2]</a>). Once you&#8217;re in the new job flow wizard, choose the
"Custom JAR" job type. Select "Continue" and enter your JAR&#8217;s location and arguments. "JAR
Location" is the S3 path you noted earlier. "JAR Arguments" are
all of the arguments you would normally pass when executing your JAR.
For example, using the Cascalog samples repository, the arguments
would be the fully qualified class name to execute,
<span class="monospaced">cookbook.etl.Main</span>, an <em>s3n://</em> URI for input data, and an <em>s3n://</em>
URI for the output.</p></div>
<div class="paragraph"><p>The next few wizard windows allow you to specify additional
configuration options for the job. Select "Continue" until you reach
the review phase and start your job.</p></div>
<div class="paragraph"><p>After your job has run, you should be able to retrieve the results
from S3. Elastic MapReduce also allows you to set up a logging path to
help with debugging if your job doesn&#8217;t complete like you expect.</p></div>
<div class="imageblock" id="fig9-2">
<div class="content">
<img src="images/clcb_0902.png" alt="images/clcb_0902.png">
</div>
<div class="title">Figure 7. Specifying parameters in the new job flow wizard</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_161">Discussion</h4>
<div class="paragraph"><p>Amazon&#8217;s EMR is a great solution if you have big Cascalog jobs but
you don&#8217;t have to run them very often. Maintaining your own Hadoop cluster
can take a fair amount of time and money. If you can keep the cluster
busy, it is a great investment. If you only need it a couple of times a
month, you might be better off using EMR for on-demand Hadoop
clusters.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_160">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_cascalog_etl">[sec_cascalog_etl]</a>, to learn about building a simple Cascalog job
</p>
</li>
<li>
<p>
Amazon&#8217;s
  <a href="http://bit.ly/emr-jar-cluster">"Launch
  a Custom JAR Cluster"</a> documentation
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ch_testing">Testing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_10">Introduction</h3>
<div class="paragraph"><p>It&#8217;s one thing to trust your code is correct today, but how will you
feel about it in a week? A month? A year? When you&#8217;re long gone?
For this kind of trust, we write tests for our code. A well-written
suite of tests is a statement to yourself and to anyone that comes after
you: "This is how this application works, now and so long as this test
passes."</p></div>
<div class="paragraph"><p>In addition to tests, several other tools have recently sprung up in
the Clojure space aimed at improving program reliability. Often, these
focus on validating that data looks as expected to guard programs
from receiving input they don&#8217;t know how to handle. These solutions
range from optional static typing with algebraic types analyzed at
compile time, down to simple preconditions.</p></div>
<div class="paragraph"><p>Admittedly, testing is a bit of a hot-button topic in the Clojure
community right now. People are starting to question whether these tests are worthwhile, or if there&#8217;s a better way to think about program verification. In recent years, techniques such as REPL-driven
development, property-based testing, and optional typing have all
popped up to fill perceived voids in the testing landscape.</p></div>
<div class="paragraph"><p>This chapter covers all of the above. As much as we&#8217;d love to push the
envelope, nothing beats a good old-fashioned unit test suite from
time to time. At the same time, as we build more and more gargantuan
applications, it is clear that simple unit tests are not always
sufficient. We hope that regardless of your skill level or focus, you&#8217;ll find new
tools to add to your testing arsenal in this chapter.</p></div>
<?hard-pagebreak?>
</div>
<div class="sect2">
<h3 id="sec_unit_testing">Unit Testing</h3>
<div class="paragraph byline"><p>by Daniel Gregoire</p></div>
<div class="sect3">
<h4 id="_problem_162">Problem</h4>
<div class="paragraph"><p>You want to test individual units of Clojure code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_160">Solution</h4>
<div class="paragraph"><p>Clojure includes a unit-testing framework in its <span class="monospaced">clojure.test</span>
namespace. It provides ways to name and group tests, make assertions,
report results, and orchestrate test suites.</p></div>
<div class="paragraph"><p>For demonstration, imagine you had a <span class="monospaced">capitalize-entries</span> function
that capitalized values in a map. To test this function, define a test
using <span class="monospaced">clojure.test/deftest</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; A function in namespace com.example.core</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> capitalize<span style="color: #990000">-</span>entries
  <span style="color: #FF0000">"Returns a new map with values for keys 'ks' in the map 'm' capitalized."</span>
  <span style="color: #990000">[</span>m <span style="color: #990000">&amp;</span> ks<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>m k<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(update</span></span><span style="color: #990000">-</span>in m <span style="color: #990000">[</span>k<span style="color: #990000">]</span> clojure<span style="color: #990000">.</span>string<span style="color: #990000">/</span>capitalize<span style="color: #990000">))</span> m ks<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; The corresponding test in namespace com.example.core-test</span></span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>test <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">;; In a real test namespace, you would also :refer all of the target namespace</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; (require '[com.example.core :refer :all])</span></span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> test<span style="color: #990000">-</span>capitalize<span style="color: #990000">-</span>entries
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>employee {<span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"smith"</span>
                  <span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #FF0000">"engineer"</span>
                  <span style="color: #990000">:</span>level <span style="color: #993399">5</span>
                  <span style="color: #990000">:</span>office <span style="color: #FF0000">"seattle"</span>}<span style="color: #990000">]</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Passes</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(capitalize</span></span><span style="color: #990000">-</span>entries employee <span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name<span style="color: #990000">)</span>
           {<span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #FF0000">"Engineer"</span>
            <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Smith"</span>
            <span style="color: #990000">:</span>office <span style="color: #FF0000">"seattle"</span>
            <span style="color: #990000">:</span>level <span style="color: #993399">5</span>}<span style="color: #990000">))</span>
    <span style="font-style: italic"><span style="color: #9A1900">;; Fails</span></span>
    <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(capitalize</span></span><span style="color: #990000">-</span>entries employee <span style="color: #990000">:</span>office<span style="color: #990000">)</span>
           {}<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>Run the test with the <span class="monospaced">clojure.test/run-tests</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(run</span></span><span style="color: #990000">-</span>tests<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:type :summary, :pass 1, :test 1, :error 0, :fail 1}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Testing user</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; FAIL in (test-capitalize-entries) (NO_SOURCE_FILE:13)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; expected: (= (capitalize-entries employee :office) {})</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   actual: (not (= {:last-name "smith", :office "Seattle",</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;                    :level 5, :job-title "engineer"} {}))</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; Ran 1 tests containing 2 assertions.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; 1 failures, 0 errors.</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_162">Discussion</h4>
<div class="paragraph"><p>The preceding example only scratches the surface of what <span class="monospaced">clojure.test</span>
provides for unit testing. Let&#8217;s take a bottom-up look at its other
features.</p></div>
<div class="paragraph"><p>First, you can improve reporting when an assertion fails by providing
a second argument that explains what the assertion is intended to
test. When you run this test, you will see an extended description of
how the code was expected to behave:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(capitalize</span></span><span style="color: #990000">-</span>entries {<span style="color: #990000">:</span>office <span style="color: #FF0000">"space"</span>} <span style="color: #990000">:</span>office<span style="color: #990000">)</span> {}<span style="color: #990000">)</span>
    <span style="color: #FF0000">"The employee's office entry should be capitalized."</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; false</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; * out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; FAIL in clojure.lang.PersistentList$EmptyList@1 (NO_SOURCE_FILE:1)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; The employee's office entry should be capitalized.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; expected: (= (capitalize-entries {:office "space"} :office) {})</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   actual: (not (= {:office "Space"} {}))</span></span></tt></pre></div></div>
<div class="paragraph"><p>For testing a function like <span class="monospaced">capitalize-entries</span> thoroughly, several
use cases need to be considered. To more concisely test numerous
similar cases, use the <span class="monospaced">clojure.test/are</span> macro:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> test<span style="color: #990000">-</span>capitalize<span style="color: #990000">-</span>entries
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>employee {<span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"smith"</span>
                  <span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #FF0000">"engineer"</span>
                  <span style="color: #990000">:</span>level <span style="color: #993399">5</span>
                  <span style="color: #990000">:</span>office <span style="color: #FF0000">"seattle"</span>}<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(are</span></span> <span style="color: #990000">[</span>ks m<span style="color: #990000">]</span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(apply</span></span> capitalize<span style="color: #990000">-</span>entries employee ks<span style="color: #990000">)</span> m<span style="color: #990000">)</span>
         <span style="color: #990000">[]</span> employee
         <span style="color: #990000">[:</span>not<span style="color: #990000">-</span>a<span style="color: #990000">-</span>key<span style="color: #990000">]</span> employee
         <span style="color: #990000">[:</span>job<span style="color: #990000">-</span>title<span style="color: #990000">]</span> {<span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #FF0000">"Engineer"</span>
                       <span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"smith"</span>
                       <span style="color: #990000">:</span>level <span style="color: #993399">5</span>
                       <span style="color: #990000">:</span>office <span style="color: #FF0000">"seattle"</span>}
         <span style="color: #990000">[:</span>last<span style="color: #990000">-</span>name <span style="color: #990000">:</span>office<span style="color: #990000">]</span> {<span style="color: #990000">:</span>last<span style="color: #990000">-</span>name <span style="color: #FF0000">"Smith"</span>
                               <span style="color: #990000">:</span>office <span style="color: #FF0000">"Seattle"</span>
                               <span style="color: #990000">:</span>level <span style="color: #993399">5</span>
                               <span style="color: #990000">:</span>job<span style="color: #990000">-</span>title <span style="color: #FF0000">"engineer"</span>}<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>The first two parameters to <span class="monospaced">are</span> set up a testing pattern: given a
sequence of keys <span class="monospaced">ks</span> and a map <span class="monospaced">m</span>, call <span class="monospaced">capitalize-entries</span> for
those keys on the original <span class="monospaced">employee</span> map and assert that the return
value equals <span class="monospaced">m</span>.</p></div>
<div class="paragraph"><p>Writing out multiple use cases in a declarative
syntax makes it easier to catch errors and untreated edge cases, such
as the <span class="monospaced">NullPointerException</span> that will be thrown for the
<span class="monospaced">[:not-a-key] employee</span> assertion pair in the preceding test.</p></div>
<div class="paragraph"><p>Unlike testing frameworks for other popular dynamic languages,
Clojure&#8217;s built-in assertions are minimal and simple. The <span class="monospaced">is</span> and
<span class="monospaced">are</span> macros check test expressions for "truthiness" (i.e., that those
expressions return neither <span class="monospaced">false</span> nor <span class="monospaced">nil</span>, in which case they pass).
Beyond this, you can also check for <span class="monospaced">thrown?</span> or <span class="monospaced">thrown-with-msg?</span> to
test that a certain <span class="monospaced">java.lang.Throwable</span> (error or exception) is
expected:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="font-weight: bold"><span style="color: #000000">(thrown</span></span><span style="color: #990000">?</span> IndexOutOfBoundsException <span style="font-weight: bold"><span style="color: #000000">(nth</span></span> <span style="color: #990000">[]</span> <span style="color: #993399">1</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Above the level of individual assertions, <span class="monospaced">clojure.test</span> also provides
facilities for calling functions before or after tests run. In the
<span class="monospaced">test-capitalize-entries</span> test, we defined an ad hoc <span class="monospaced">employee</span> map for
testing, but you could also read in external data to be shared across
multiple tests by registering a data-loading function as a "fixture."
The <span class="monospaced">clojure.test/use-fixtures</span> multimethod allows registering Clojure
functions to be called either before or after each test, or before or
after an entire namespace&#8217;s test suite. The following example defines
and registers three fixture functions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>edn <span style="color: #990000">:</span>as edn<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> test<span style="color: #990000">-</span>data <span style="font-weight: bold"><span style="color: #000000">(atom</span></span> nil<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Assuming you have a test-data.edn file...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> load<span style="color: #990000">-</span>data <span style="color: #FF0000">"Read a Clojure map from test data in a file."</span>
  <span style="color: #990000">[</span>test<span style="color: #990000">-</span>fn<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reset</span></span><span style="color: #990000">!</span> test<span style="color: #990000">-</span>data <span style="font-weight: bold"><span style="color: #000000">(edn</span></span><span style="color: #990000">/</span>read<span style="color: #990000">-</span>string <span style="font-weight: bold"><span style="color: #000000">(slurp</span></span> <span style="color: #FF0000">"test-data.edn"</span><span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #000000">(test</span></span><span style="color: #990000">-</span>fn<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add<span style="color: #990000">-</span>test<span style="color: #990000">-</span>id <span style="color: #FF0000">"Add a unique id to the data before each test."</span>
  <span style="color: #990000">[</span>test<span style="color: #990000">-</span>fn<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> test<span style="color: #990000">-</span>data assoc <span style="color: #990000">:</span>id <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>util<span style="color: #990000">.</span>UUID<span style="color: #990000">/</span>randomUUID<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(test</span></span><span style="color: #990000">-</span>fn<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> inc<span style="color: #990000">-</span>count <span style="color: #FF0000">"Increment a counter in the data after each test runs."</span>
  <span style="color: #990000">[</span>test<span style="color: #990000">-</span>fn<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(test</span></span><span style="color: #990000">-</span>fn<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(swap</span></span><span style="color: #990000">!</span> test<span style="color: #990000">-</span>data update<span style="color: #990000">-</span>in <span style="color: #990000">[:</span>count<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(fnil</span></span> inc <span style="color: #993399">0</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(use</span></span><span style="color: #990000">-</span>fixtures <span style="color: #990000">:</span>once load<span style="color: #990000">-</span>data<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(use</span></span><span style="color: #990000">-</span>fixtures <span style="color: #990000">:</span>each add<span style="color: #990000">-</span>test<span style="color: #990000">-</span>id inc<span style="color: #990000">-</span>count<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Tests...</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can think about fixture functions as forming a pipeline through
which each test is passed as a parameter, which we called <span class="monospaced">test-fn</span> in
the preceding example. Take <span class="monospaced">inc-count</span>, for example. It is the job of this
fixture to invoke the <span class="monospaced">test-fn</span> function, continuing the pipeline, and
afterward, to increment a count (i.e., "do some work"). Each fixture
decides whether to invoke <span class="monospaced">test-fn</span> before or after its own work
(compare the <span class="monospaced">add-test-id</span> function with the <span class="monospaced">inc-count</span> function),
while the <span class="monospaced">clojure.test/use-fixtures</span> multimethod controls whether
each registered fixture function is run only once for all tests in a
namespace or once for each test.</p></div>
<div class="paragraph"><p>Finally, with a firm understanding of how to develop individual
Clojure test suites, it is important to consider how you organize and
run those suites as part of your project&#8217;s build. Although Clojure
allows defining tests for functions anywhere in your code base, you
should keep your testing code in a separate directory that is only
added to the JVM classpath when needed (e.g., during development and
testing). It is conventional to name your test namespaces after the
namespaces they test, so that a file located at
<em>&lt;project-root&gt;/src/com/example/core.clj</em> with namespace
<span class="monospaced">com.example.core</span> has a corresponding test file at
<em>&lt;project-root&gt;/test/com/example/core_test.clj</em> with namespace
<span class="monospaced">com.example.core-test</span>. To control the location of your source and
test directories and their inclusion on the JVM classpath, you should
use a build tool like <a href="http://leiningen.org/">Leiningen</a> or
<a href="http://maven.apache.org/">Maven</a> to organize your project.</p></div>
<div class="paragraph"><p>In Leiningen, the default directory for your tests is a top-level
<em>&lt;project-root&gt;/test</em> folder, and you can run your project&#8217;s tests with
<span class="monospaced">lein test</span> at the command line. Without any additional arguments, the
<span class="monospaced">lein test</span> command will execute all of the tests in a project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span>

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>core-test
lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>util-test

Ran <span style="color: #993399">10</span> tests containing <span style="color: #993399">20</span> assertions<span style="color: #990000">.</span>
<span style="color: #993399">0</span> failures<span style="color: #990000">,</span> <span style="color: #993399">0</span> errors<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>To limit the scope of tests Leiningen runs, use the <span class="monospaced">:only</span> option,
followed by a fully qualified namespace or function name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># To run an entire namespace</span></span>
$ lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>only com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>core-test

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>core-test

Ran <span style="color: #993399">5</span> tests containing <span style="color: #993399">10</span> assertions<span style="color: #990000">.</span>
<span style="color: #993399">0</span> failures<span style="color: #990000">,</span> <span style="color: #993399">0</span> errors<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900"># To run one specific test</span></span>
$ lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>only com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>core-test/test-capitalize-entries

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>core-test

Ran <span style="color: #993399">1</span> tests containing <span style="color: #993399">2</span> assertions<span style="color: #990000">.</span>
<span style="color: #993399">0</span> failures<span style="color: #990000">,</span> <span style="color: #993399">0</span> errors<span style="color: #990000">.</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_161">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clojure.test</span> <a href="http://bit.ly/clj-test-api">API documentation</a> contains full information on the unit-testing framework.
</p>
</li>
<li>
<p>
If you are instead using Maven, use   <a href="https://github.com/talios/clojure-maven-plugin"><span class="monospaced">clojure-maven-plugin</span></a>
  to run Clojure tests. This plug-in will incorporate your Clojure
  tests located in the Maven standard <em>src/test/clojure</em> directory as
  part of the <span class="monospaced">test</span> phase in the Maven build life cycle. You can
  optionally use the plug-in&#8217;s <span class="monospaced">clojure:test-with-junit</span> goal to
  produce JUnit-style reporting output for your Clojure test runs.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_midje">Testing with Midje</h3>
<div class="paragraph byline"><p>by Joseph Wilk</p></div>
<div class="sect3">
<h4 id="_problem_163">Problem</h4>
<div class="paragraph"><p>You want to unit-test a function that integrates with external
dependencies such as HTTP services or databases.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_161">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/marick/Midje">Midje</a>, a testing framework that
provides ways to mock functions and return fakes.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try midje clj-http</tt></pre></div></div>
<div class="paragraph"><p>Here is an example function that makes an HTTP request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; A function in namespace com.example.core</span></span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>http<span style="color: #990000">.</span>client <span style="color: #990000">:</span>as http<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> github<span style="color: #990000">-</span>profile <span style="color: #990000">[</span>username<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(let</span></span> <span style="color: #990000">[</span>response <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"https://api.github.com/users/"</span> username<span style="color: #990000">))]</span>
    <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="color: #990000">(=</span> <span style="color: #990000">(:</span>status response<span style="color: #990000">)</span> <span style="color: #993399">200</span><span style="color: #990000">)</span>
      <span style="color: #990000">(:</span>body response<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(github</span></span><span style="color: #990000">-</span>profile <span style="color: #FF0000">"clojure-cookbook"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "{\"login\":\"clojure-cookbook\",\"id\":4176246, ...}"</span></span></tt></pre></div></div>
<div class="paragraph"><p>To test the <span class="monospaced">github-profile</span> function, define a test using
 <span class="monospaced">midje.sweet/facts</span> and <span class="monospaced">midje.sweet/fact</span> in the corresponding test
 namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; In the com.example.core-test namespace...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>midje<span style="color: #990000">.</span>sweet <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(facts</span></span> <span style="color: #FF0000">"about successful requests"</span>
  <span style="font-weight: bold"><span style="color: #000000">(fact</span></span> <span style="color: #FF0000">"returns the response body"</span>
    <span style="font-weight: bold"><span style="color: #000000">(github</span></span><span style="color: #990000">-</span>profile <span style="color: #FF0000">"clojure-cookbook"</span><span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">..</span>body<span style="color: #990000">..</span>
    <span style="font-weight: bold"><span style="color: #000000">(provided</span></span>
      <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get #<span style="color: #FF0000">"/users/clojure-cookbook"</span><span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span>
        {<span style="color: #990000">:</span>status <span style="color: #993399">200</span> <span style="color: #990000">:</span>body <span style="color: #990000">..</span>body<span style="color: #990000">..</span>}<span style="color: #990000">)))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_163">Discussion</h4>
<div class="paragraph"><p>In Midje, <span class="monospaced">facts</span> associates a description with a group of tests, while
<span class="monospaced">fact</span> maps to your test. Assertions in your <span class="monospaced">fact</span> take the form of:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; actual =&gt; expected</span></span>

<span style="color: #993399">10</span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">10</span> <span style="font-style: italic"><span style="color: #9A1900">; This will pass</span></span>
<span style="color: #993399">10</span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">11</span> <span style="font-style: italic"><span style="color: #9A1900">; This will fail</span></span></tt></pre></div></div>
<div class="paragraph"><p>Assertions behave a little differently than most testing frameworks.
Within a <span class="monospaced">fact</span> body, every single assertion is checked, irrespective of
whether a previous one failed.</p></div>
<div class="paragraph"><p>Midje only provides mocks, not stubs. All functions specified in the
<span class="monospaced">provided</span> body have to be called for the test to pass. Mocks use the
same syntax as assertions, but with a slightly different meaning:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; &lt;function call &amp; arguments to match&gt; =&gt; &lt;return value of function&gt;</span></span>

<span style="font-weight: bold"><span style="color: #000000">(provided</span></span> <span style="color: #990000">(+</span> <span style="color: #993399">10</span> <span style="color: #993399">10</span><span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>It is important to note you are not calling the <span class="monospaced">(+ 10 10)</span> function
here&#8212;you are setting up a pattern. Every function call occurring in
the test is checked to see if it matches this pattern. If it does match, Midje will not call the function, but will instead return <span class="monospaced">0</span>. When defining mocks with
<span class="monospaced">provided</span>, there is a lot of flexibility in terms of how to match mock functions
against real calls. In the preceding solution, for example, regular
expressions are used. This expression instructs Midje to mock calls to
<span class="monospaced">http/get</span> whose URLs end in <em>/users/clojure-cookbook</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; The expectation</span></span>
<span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get #<span style="color: #FF0000">"/users/clojure-cookbook$"</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Would match</span></span>
<span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"http://localhost:4001/users/clojure-cookbook"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; or</span></span>
<span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="color: #FF0000">"https://api.github.com/users/clojure-cookbook"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Midje provides a lot of match-shaping functions that you can use to match
against the arguments of a mock:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">;; Match an argument list that contains 1</span></span>
<span style="font-weight: bold"><span style="color: #000000">(provided</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="font-weight: bold"><span style="color: #000000">(contains</span></span> <span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]))</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>result<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Match against a custom fn that must return true</span></span>
<span style="font-weight: bold"><span style="color: #000000">(provided</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get <span style="font-weight: bold"><span style="color: #000000">(as</span></span><span style="color: #990000">-</span>checker <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(x</span></span> <span style="color: #990000">==</span> <span style="color: #993399">10</span><span style="color: #990000">))))</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>result<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">;; Match against a single argument of any value</span></span>
<span style="font-weight: bold"><span style="color: #000000">(provided</span></span>
  <span style="font-weight: bold"><span style="color: #000000">(http</span></span><span style="color: #990000">/</span>get anything<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>result<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>From within a REPL, you can investigate all of Midje&#8217;s checkers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> 'midje<span style="color: #990000">.</span>repl<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(doc</span></span> midje<span style="color: #990000">-</span>checkers<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; -------------------------</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; midje.sweet/midje-checkers</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;  (facts "about checkers"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; truthy</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; falsey</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; irrelevant ; or `anything`</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (exactly odd?) ; when you expect a particular function</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (roughly 10 0.1)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (throws SomeException #"with message")</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (contains [1 2 3]) ; works with strings, maps, etc.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (contains [1 2 3] :in-any-order :gaps-ok)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (just [1 2 3])</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (has every? odd?)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (nine-of odd?) ; must be exactly 9 odd values.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (every-checker odd? (roughly 9)) ; both must be true</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    (f) =&gt; (some-checker odd? (roughly 9))) ; one must be true</span></span></tt></pre></div></div>
<div class="paragraph"><p>You may have noticed in the solution that we used <span class="monospaced">..body..</span> instead of an
actual response. This is something Midje refers to as a <em>metaconstant</em>.</p></div>
<div class="paragraph"><p>A metaconstant is any name that starts and ends with two dots. It has
no properties other than identity. Think of it as a fake or
placeholder, where we do not care about the actual value or might be
referencing something that does not exist yet. In our example, we don&#8217;t
really care what <span class="monospaced">..body..</span> is; we just care that it is the thing
returned.</p></div>
<div class="paragraph"><p>To add Midje to an existing project, add <span class="monospaced">[midje "1.5.1"]</span> to your
development dependencies and <span class="monospaced">[lein-midje "3.1.2"]</span> to your
development plug-ins. Your <em>project.clj</em> should look something like
this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> example <span style="color: #FF0000">"1.0.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>midje <span style="color: #FF0000">"1.5.1"</span><span style="color: #990000">]]</span>
                   <span style="color: #990000">:</span>plugins <span style="color: #990000">[[</span>lein<span style="color: #990000">-</span>midje <span style="color: #FF0000">"3.1.2"</span><span style="color: #990000">]</span>}}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Midje provides two ways to run tests: through a REPL, as you may have
been doing, or through Leiningen. Midje actually encourages you to
run all your tests through the REPL, as you develop them. One very useful
way to run your tests is with the <span class="monospaced">midje.repl/autotest</span> function. This
continuously polls the filesystem looking for changes in your project. When it detects these changes, it will automatically rerun the relevant
tests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>midje<span style="color: #990000">.</span>repl <span style="color: #990000">:</span>as midje<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(midje</span></span><span style="color: #990000">/</span>autotest<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">; Start auto-testing</span></span>

<span style="font-style: italic"><span style="color: #9A1900">;; Other options are...</span></span>
<span style="font-weight: bold"><span style="color: #000000">(midje</span></span><span style="color: #990000">/</span>autotest <span style="color: #990000">:</span>pause<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(midje</span></span><span style="color: #990000">/</span>autotest <span style="color: #990000">:</span>resume<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(midje</span></span><span style="color: #990000">/</span>autotest <span style="color: #990000">:</span>stop<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>There are many more things you can do from the REPL with Midje. To
find out more, read the docstring of <span class="monospaced">midje-repl</span> by running <strong><span class="monospaced">(doc
midje-repl)</span></strong> in a REPL.</p></div>
<div class="paragraph"><p>You can also run Midje tests through the Leiningen plug-in <span class="monospaced">lein-midje</span>
(add as noted in <em>project.clj</em>). <span class="monospaced">lein-midje</span> allows you run tests
at a number of granularities&#8212;all of your tests, all the tests in a
group, or all the tests in a single namespace:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre># Run all your tests
$ lein midje

# Run a group of namespaces
$ lein midje com.example.*

# Run a specific namespace
$ lein midje com.example.t-core</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_162">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_unit_testing">[sec_unit_testing]</a>, for information on more basic unit testing
  in Clojure
</p>
</li>
<li>
<p>
The Midje <a href="https://github.com/marick/Midje">GitHub repository</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_testing_generative">Thoroughly Testing by Randomizing Inputs</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_164">Problem</h4>
<div class="paragraph"><p>You want to test a function using randomly generated inputs to ensure
that it works in all possible scenarios.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_162">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">test.generative</span> library to specify a function&#8217;s inputs, and
test it across randomly generated values.</p></div>
<div class="paragraph"><p>To follow along with this recipe, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/test<span style="color: #990000">.</span>generative <span style="color: #FF0000">"0.5.0"</span></tt></pre></div></div>
<div class="paragraph"><p>Say you are trying to test the following function, which calculates
the arithmetic mean of all the numbers in a sequence:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mean
  <span style="color: #FF0000">"Calculate the mean of the numbers in a sequence"</span>
  <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> s<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> s<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>The following <span class="monospaced">test.generative</span> code defines a <em>specification</em> for
the <span class="monospaced">mean</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>test<span style="color: #990000">.</span>generative <span style="color: #990000">:</span>as t<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>test<span style="color: #990000">.</span>generative<span style="color: #990000">.</span>runner <span style="color: #990000">:</span>as r<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>data<span style="color: #990000">.</span>generators <span style="color: #990000">:</span>as gen<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> number
  <span style="color: #FF0000">"Return a random number, of a random type"</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>one<span style="color: #990000">-</span>of gen<span style="color: #990000">/</span><span style="color: #009900">byte</span>
              gen<span style="color: #990000">/</span><span style="color: #009900">short</span>
              gen<span style="color: #990000">/</span><span style="color: #009900">int</span>
              gen<span style="color: #990000">/</span><span style="color: #009900">long</span>
              gen<span style="color: #990000">/</span><span style="color: #009900">float</span>
              gen<span style="color: #990000">/</span><span style="color: #009900">double</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> seq<span style="color: #990000">-</span>of<span style="color: #990000">-</span>numbers
  <span style="color: #FF0000">"Return a list, seq, or set of numbers"</span>
  <span style="color: #990000">[]</span>
  <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>one<span style="color: #990000">-</span>of <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>list number<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>set number<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>vec number<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>defspec mean<span style="color: #990000">-</span>spec
  mean
  <span style="color: #990000">[^</span>example<span style="color: #990000">.</span>generative<span style="color: #990000">-</span>tests<span style="color: #990000">/</span>seq<span style="color: #990000">-</span>of<span style="color: #990000">-</span>numbers arg<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(assert</span></span> <span style="font-weight: bold"><span style="color: #000000">(number</span></span><span style="color: #990000">?</span> <span style="color: #990000">%)))</span></tt></pre></div></div>
<div class="paragraph"><p>To run the <span class="monospaced">mean-spec</span> specification, invoke the <span class="monospaced">run</span> function in the
<span class="monospaced">clojure.test.generative.runner</span> namespace, passing in the number of
threads upon which to run the simulation, the number of milliseconds
to run, and the var referring to a spec.</p></div>
<div class="paragraph"><p>Here&#8217;s what happens when we run the previous example at the REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(r</span></span><span style="color: #990000">/</span>run <span style="color: #993399">2</span> <span style="color: #993399">5000</span> #'example<span style="color: #990000">.</span>generative<span style="color: #990000">-</span>tests<span style="color: #990000">/</span>mean<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; clojure.lang.ExceptionInfo: Generative test failed</span></span></tt></pre></div></div>
<div class="paragraph"><p>This shows the behavior when the generative test fails. The exact
details of the failure are returned as the data of a Clojure
information-bearing exception; you must retrieve an
instance of the exception itself and call <span class="monospaced">ex-data</span> on it to return
the data map.</p></div>
<div class="paragraph"><p>In the REPL, if you didn&#8217;t explicitly catch the exception, you can use
the special <span class="monospaced">*e</span> symbol to retrieve the most recent exception. Calling
<span class="monospaced">ex-data</span> on it returns information on the test case that provoked the
error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ex</span></span><span style="color: #990000">-</span>data <span style="color: #990000">*</span>e<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:exception #&lt;ArithmeticException java.lang.ArithmeticException:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     Divide by zero&gt;, :iter 7, :seed -875080314,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;     :example.generative-tests/mean-spec, :input [#{}]}</span></span></tt></pre></div></div>
<div class="paragraph"><p>This states that after only seven iterations, using the random number
seed &#x2013;875080314, the function under test was passed <span class="monospaced">#{}</span> as input and threw a divide by zero error.</p></div>
<div class="paragraph"><p>Once highlighted in this way, the problem is easy to see; the <span class="monospaced">mean</span>
function will divide by zero if <span class="monospaced">(count s)</span> is zero. Fix the bug by
rewriting the <span class="monospaced">mean</span> function to handle that case:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> mean
  <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(zero</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> s<span style="color: #990000">))</span>
    <span style="color: #993399">0</span>
    <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="color: #993399">1.0</span> s<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(count</span></span> s<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>Rerunning now shows a passing test:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(r</span></span><span style="color: #990000">/</span>run <span style="color: #993399">2</span> <span style="color: #993399">5000</span> #'example<span style="color: #990000">.</span>generative<span style="color: #990000">-</span>tests<span style="color: #990000">/</span>mean<span style="color: #990000">-</span>spec<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:iter 3931, :seed -1495229764, :test testgen-test.core/mean-spec}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;    {:iter 3909, :seed -1154113663, :test testgen-test.core/mean-spec}</span></span></tt></pre></div></div>
<div class="paragraph"><p>This output indicates that over the allotted 5 seconds, two threads
ran about 3,900 iterations of the test each and did not encounter any
errors or assertion failures.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_164">Discussion</h4>
<div class="paragraph"><p>There are two key parts to the preceding test definition: the <span class="monospaced">defspec</span>
form itself, which defines the generative test, and the functions used to
generate random data. In this case, the data generator functions are
built from primitive data generation functions found in the
<span class="monospaced">clojure.data.generators</span> namespace.</p></div>
<div class="paragraph"><p>Generator functions take no arguments and return random
values. Different functions produce different types of data. The
<span class="monospaced">clojure.data.generators</span> namespace contains generator functions for
all of Clojure&#8217;s primitive types, as well as collections. It also
contains functions for randomly choosing from a set of options; the
<span class="monospaced">one-of</span> function used previously, for example, takes a number of generator
functions and chooses a value from one at random.</p></div>
<div class="paragraph"><p>The <span class="monospaced">defspec</span> macro takes three types of forms: a <em>function</em> to put
under test, an <em>argument specification</em>, and a <em>body</em> containing one or
more assertion forms.</p></div>
<div class="paragraph"><p>The function under test is simply the function to call. Over the
course of the generative test, it will be called many times, each time
with different values.</p></div>
<div class="paragraph"><p>The argument specification is a vector of argument names and should
match the signature of the function under test. Each argument should
have <em>metadata</em> attached. Specifically, it should have a <span class="monospaced">:tag</span>
metadata key, mapped to the fully qualified name of a generator
function. Each time the test driver calls the function, it will use a
random value for each argument pulled from its corresponding generator
function.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Why :tag?</div>
<div class="paragraph"><p>You may find the use of <span class="monospaced">:tag</span> metadata a bit
confusing. Normally, <span class="monospaced">:tag</span> is a type hint and returns a JVM
<em>class</em>. In <span class="monospaced">test.generative</span>, it should be a <em>function</em> that can return
any type of value you want to pass to the function under test.</p></div>
<div class="paragraph"><p>The motivation for reusing <span class="monospaced">:tag</span> in this way is mostly
historical. <span class="monospaced">test.generative</span> is largely inspired by a library called
QuickCheck, which is written in Haskell. Because Haskell is strongly
and statically typed, QuickCheck truly can use the type signature as
sufficient information on how to generate input data.</p></div>
<div class="paragraph"><p>The link isn&#8217;t quite as strong in Clojure, and arguably is more
confusing than helpful. Just remember that, in the context of
<span class="monospaced">test.generative</span>, <span class="monospaced">:tag</span> refers not to the actual system type, but to a
function that returns an object of the type(s) you want to pass to the
function to test.</p></div>
</div></div>
<div class="paragraph"><p>The body of a <span class="monospaced">defspec</span> simply contains expressions that may throw an
exception if some condition is not met. It is executed on each
iteration of the test, with the instantiated arguments available, and
with the return value of the function under test bound to <span class="monospaced">%</span>. This
example merely has a single assertion that the result is a number, for
brevity, but you can have any number of assertions executing arbitrary
checks.</p></div>
<div class="paragraph"><p>An interesting difference between <span class="monospaced">test.generative</span> and traditional
unit tests is that rather than specifying what tests to run and
having them take as long as they do, in <span class="monospaced">test.generative</span> you specify
how long to run, and the system will run as many random permutations
of the test as it can fit into that time. This has the property of
keeping test runtimes deterministic, while allowing you to trade off
speed and comprehensiveness depending on the situation. For example,
you might have tests run for five seconds in development, but thoroughly
hammer the system for an hour every night on the continuous integration server, allowing
you to find that (literally) one-in-a-million bug.</p></div>
<div class="sect4">
<h5 id="_running_generative_tests">Running generative tests</h5>
<div class="paragraph"><p>While developing tests, running from the REPL is usually the most
convenient. However, there are many other scenarios (such as testing commit
hooks or on a CI) where running tests from the
command line is required. For this purpose, <span class="monospaced">test.generative</span> provides a
<span class="monospaced">-main</span> function in the <span class="monospaced">clojure.test.generative.runner</span> namespace
that takes as a command-line argument one or more directories where
generative tests can be found. It searches all the Clojure namespaces
in those locations for generative testing specifications and executes
them.</p></div>
<div class="paragraph"><p>For example, if you&#8217;ve placed your generative tests in a
<em>tests/generative</em> directory inside a Leiningen project, you could
execute tests by running the following at the shell, from your
project&#8217;s root directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein run -m clojure<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">test</span></span><span style="color: #990000">.</span>generative<span style="color: #990000">.</span>runner tests/generative</tt></pre></div></div>
<div class="paragraph"><p>If you want to control the intensity of the test run, you can adjust
the number of concurrent threads and the length of the run using the
<span class="monospaced">clojure.test.generative.threads</span> and <span class="monospaced">clojure.test.generative.msec</span>
JVM system properties. Using Leiningen, you must set these options in
the <span class="monospaced">:jvm-opts</span> key in <em>project.clj</em> like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">:</span>jvm<span style="color: #990000">-</span>opts <span style="color: #990000">[</span><span style="color: #FF0000">"-Dclojure.test.generative.threads=32"</span>
           <span style="color: #FF0000">"-Dclojure.test.generative.msec=10000"</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">clojure.test.generative.runner/-main</span> will pick up any parameters
provided in this way, and run accordingly.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_163">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/clojure/test.generative"><span class="monospaced">test.generative</span></a> page on GitHub
</p>
</li>
<li>
<p>
The <a href="http://hackage.haskell.org/package/QuickCheck">QuickCheck Haskell library</a>
</p>
</li>
<li>
<p>
<a href="#sec_simplecheck">[sec_simplecheck]</a>, on SimpleCheck, a property-based testing library for Clojure with some overlap with <span class="monospaced">test.generative</span> and unique features
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_simplecheck">Finding Values That Cause Failure</h3>
<div class="paragraph byline"><p>by Luke VanderHart</p></div>
<div class="sect3">
<h4 id="_problem_165">Problem</h4>
<div class="paragraph"><p>You want to specify properties of a function that should hold true for
all inputs, and find input values that violate those properties.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_163">Solution</h4>
<div class="paragraph"><p>Use <a href="https://github.com/reiddraper/simple-check"><span class="monospaced">simple-check</span></a>. This is a property-specification library for Clojure that
is capable of "shrinking" the input case to find the minimal failing
input.<span class="footnote"><br>[It is important to note that <span class="monospaced">simple-check</span> finds a
<em>local</em> minimum, not the <em>global</em> minimum.]<br></span></p></div>
<div class="paragraph"><p>To follow along with this recipe, add <span class="monospaced">[reiddraper/simple-check "0.5.3"]</span> to your project&#8217;s dependencies, or start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try reiddraper/simple-check</tt></pre></div></div>
<div class="paragraph"><p>Then, find a function to test. This example uses a contrived function
that calculates the sum of the reciprocals of a sequence of numbers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> reciprocal<span style="color: #990000">-</span>sum <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">/</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> s<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Here&#8217;s the test code itself:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>simple<span style="color: #990000">-</span>check<span style="color: #990000">.</span>core <span style="color: #990000">:</span>as sc<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>simple<span style="color: #990000">-</span>check<span style="color: #990000">.</span>generators <span style="color: #990000">:</span>as gen<span style="color: #990000">]</span>
         '<span style="color: #990000">[</span>simple<span style="color: #990000">-</span>check<span style="color: #990000">.</span>properties <span style="color: #990000">:</span>as prop<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> seq<span style="color: #990000">-</span>of<span style="color: #990000">-</span>numbers <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>one<span style="color: #990000">-</span>of <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>vector gen<span style="color: #990000">/</span><span style="color: #009900">int</span><span style="color: #990000">)</span>
                                 <span style="font-weight: bold"><span style="color: #000000">(gen</span></span><span style="color: #990000">/</span>list gen<span style="color: #990000">/</span><span style="color: #009900">int</span><span style="color: #990000">)]))</span>

<span style="font-weight: bold"><span style="color: #000000">(def</span></span> reciprocal<span style="color: #990000">-</span>sum<span style="color: #990000">-</span>check
  <span style="font-weight: bold"><span style="color: #000000">(prop</span></span><span style="color: #990000">/</span>for<span style="color: #990000">-</span>all <span style="color: #990000">[</span>s seq<span style="color: #990000">-</span>of<span style="color: #990000">-</span>numbers<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(number</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(reciprocal</span></span><span style="color: #990000">-</span>sum s<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">seq-of-numbers</span> is a data generator composed of primitive
generators found in the <span class="monospaced">simple-check.generators</span> namespace.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Unlike with <span class="monospaced">test.generative</span>, <span class="monospaced">simple-check</span> generators are more complicated
than a single function that returns a value. Instead, they are data
structures that define not only how random values are sampled, but how
they converge on the "simplest" possible failing case.</p></div>
<div class="paragraph"><p>A full discussion of creating custom <span class="monospaced">simple-check</span> generators (other
than simple compositions of primitive generators) is beyond the scope
of this recipe, but full documentation is available on the
<span class="monospaced">simple-check</span> <a href="https://github.com/reiddraper/simple-check">GitHub page</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The actual test is defined using the <span class="monospaced">simple-check.properties/for-all</span>
macro, which emits a property definition. It takes a binding form
(similar to <span class="monospaced">let</span> or <span class="monospaced">for</span>) that specifies the possible values to
bind to one or more symbols, and a body. The body is what actually
specifies the properties that must hold, and must return <span class="monospaced">true</span> if and
only if the test passes for a particular set of values.</p></div>
<div class="paragraph"><p>To run the test, invoke the <span class="monospaced">simple-check.core/quick-check</span> function,
passing it the defined property:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sc</span></span><span style="color: #990000">/</span>quick<span style="color: #990000">-</span>check <span style="color: #993399">100</span> reciprocal<span style="color: #990000">-</span>sum<span style="color: #990000">-</span>check<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">quick-check</span> takes the number of samples to execute, and the property
definition to execute. The body of the property definition will be
sampled repeatedly, with randomized values bound to the symbols
specified in the binding form.</p></div>
<div class="paragraph"><p>As you may have already observed, the <span class="monospaced">reciprocal-sum</span> function has a
problem: it will throw a "divide by zero" error if a zero is present
in the input sequence. The <span class="monospaced">quick-check</span> function returns a data
structure showcasing the problem:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #990000">:</span>result
 #<span style="color: #990000">&lt;</span>ArithmeticException java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>ArithmeticException<span style="color: #990000">:</span> Divide by zero<span style="color: #990000">&gt;,</span>
 <span style="color: #990000">:</span>failing<span style="color: #990000">-</span>size <span style="color: #993399">8</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>num<span style="color: #990000">-</span>tests <span style="color: #993399">9</span><span style="color: #990000">,</span>
 <span style="color: #990000">:</span>fail <span style="color: #990000">[(</span><span style="color: #993399">5</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #990000">-</span><span style="color: #993399">8</span> <span style="color: #993399">1</span> <span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)],</span>
 <span style="color: #990000">:</span>shrunk
 {<span style="color: #990000">:</span>total<span style="color: #990000">-</span>nodes<span style="color: #990000">-</span>visited <span style="color: #993399">10</span><span style="color: #990000">,</span>
  <span style="color: #990000">:</span>depth <span style="color: #993399">5</span><span style="color: #990000">,</span>
  <span style="color: #990000">:</span>result
  #<span style="color: #990000">&lt;</span>ArithmeticException java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>ArithmeticException<span style="color: #990000">:</span> Divide by zero<span style="color: #990000">&gt;,</span>
  <span style="color: #990000">:</span>smallest <span style="color: #990000">[(</span><span style="color: #993399">0</span><span style="color: #990000">)]</span>}}</tt></pre></div></div>
<div class="paragraph"><p>Fix the function by eliminating zero values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> reciprocal<span style="color: #990000">-</span>sum <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(reduce</span></span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span> <span style="font-weight: bold"><span style="color: #000000">(partial</span></span> <span style="color: #990000">/</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
                 <span style="font-weight: bold"><span style="color: #000000">(filter</span></span> <span style="font-weight: bold"><span style="color: #000000">(complement</span></span> zero<span style="color: #990000">?)</span> s<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>Rerunning the test now indicates success:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(sc</span></span><span style="color: #990000">/</span>quick<span style="color: #990000">-</span>check <span style="color: #993399">100</span> reciprocal<span style="color: #990000">-</span>sum<span style="color: #990000">-</span>check<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; {:result true, :num-tests 100, :seed 1384622907885}</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_165">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">simple-check</span> has the very useful property of not only returning
<em>a</em> failing sample input to a test, but returning the <em>minimal</em>
failing sample. In the preceding example program, for instance, any time a
zero occurs in the input sequence, it causes an error. However, merely
from looking at the sequence <span class="monospaced">(5 0 0 -8 1 -2)</span>, it might not be
apparent that zeros are the problem. Not knowing anything else about
the function under test, the problem might be, for example, the
negative numbers, or the value <span class="monospaced">5</span>. <span class="monospaced">simple-check</span> returns not just any
arbitrary failing input, but <em>the specific input</em> that will
consistently cause the program to fail. As useful as it is to know
that there is an input that will provoke failure, it&#8217;s even more
useful to know the specific problematic value. And, the larger and
more complex the inputs to the function are, the more useful it is to be
able to reduce the failing case.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">test.generative and simple-check</div>
<div class="paragraph"><p><?dbhtml orphans="4"?>You may have observed that <span class="monospaced">test.generative</span> (discussed in <a href="#sec_testing_generative">[sec_testing_generative]</a>) and <span class="monospaced">simple-check</span> cover a
lot of the same ground. They both generate a randomized distribution
of inputs, and they both specify "success" conditions in terms of
properties or qualities that must hold across all inputs and outputs,
rather than specific examples.</p></div>
<div class="paragraph"><p>However, there are a few key differences. <span class="monospaced">simple-check</span> minimizes the
failing input before returning, whereas <span class="monospaced">test.generative</span> bails the first time
it sees a failure. However, the data generators of <span class="monospaced">test.generative</span> are
simple functions, without any additionally specified behavior, which
makes them much more flexible and easy to extend.</p></div>
<div class="paragraph"><p><span class="monospaced">test.generative</span> also provides the ability to specify not only how many
iterations of the test to run, but how long to test for, running as
many tests as it can fit into the allotted time frame across multiple threads.</p></div>
<div class="paragraph"><p>Ultimately, both are valuable approaches that you should seriously
consider when you want to really thoroughly test something. The
decision between them should be mediated by your own specific needs:
how large or complicated the inputs are, how much control you want
over the running time, and how likely you are to need to extend the set of
generated primitives.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_164">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#sec_unit_testing">[sec_unit_testing]</a>
</p>
</li>
<li>
<p>
<a href="#sec_testing_generative">[sec_testing_generative]</a>
</p>
</li>
<li>
<p>
The <a href="https://github.com/reiddraper/simple-check"><span class="monospaced">simple-check</span> project page</a>
</p>
</li>
<li>
<p>
<a href="http://bit.ly/quickcheck-intro">"Introduction to QuickCheck"</a> for information on the Haskell library that inspired <span class="monospaced">simple-check</span>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_running_browser_based_tests">Running Browser-Based Tests</h3>
<div class="paragraph byline"><p>by Matthew Maravillas</p></div>
<div class="sect3">
<h4 id="_problem_166">Problem</h4>
<div class="paragraph"><p>You want to run browser-based tests.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_164">Solution</h4>
<div class="paragraph"><p>Use Selenium WebDriver via the <a href="https://github.com/semperos/clj-webdriver"><span class="monospaced">clj-webdriver</span> library</a>. This will
allow you to use <span class="monospaced">clojure.test</span> to test your application&#8217;s behavior in
actual browser environments.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a new Leiningen project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein new browser-testing
Generating a project called browser-testing based on the <span style="color: #FF0000">'default'</span> template<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Modify the new project&#8217;s <em>project.clj</em> file to match the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> browser<span style="color: #990000">-</span>testing <span style="color: #FF0000">"0.1.0-SNAPSHOT"</span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>clj<span style="color: #990000">-</span>webdriver <span style="color: #FF0000">"0.6.0"</span><span style="color: #990000">]]</span>}}
  <span style="color: #990000">:</span>test<span style="color: #990000">-</span>selectors {<span style="color: #990000">:</span>default <span style="font-weight: bold"><span style="color: #000000">(complement</span></span> <span style="color: #990000">:</span>browser<span style="color: #990000">)</span>
                   <span style="color: #990000">:</span>browser <span style="color: #990000">:</span>browser}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Next, add a simple Selenium test to
<em>test/browser_testing/core_test.clj</em>, overwriting its content:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> browser<span style="color: #990000">-</span>testing<span style="color: #990000">.</span>core<span style="color: #990000">-</span>test
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>test <span style="color: #990000">:</span>refer <span style="color: #990000">:</span>all<span style="color: #990000">]</span>
            <span style="color: #990000">[</span>clj<span style="color: #990000">-</span>webdriver<span style="color: #990000">.</span>taxi <span style="color: #990000">:</span>as t<span style="color: #990000">]))</span>

<span style="font-style: italic"><span style="color: #9A1900">;; A simple fixture that sets up a test driver</span></span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> selenium<span style="color: #990000">-</span>fixture
  <span style="color: #990000">[&amp;</span> browsers<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>test<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>browser browsers<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(println</span></span> <span style="font-weight: bold"><span style="color: #000000">(str</span></span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">[ Testing "</span> browser <span style="color: #FF0000">" ]"</span><span style="color: #990000">))</span>
      <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>driver<span style="color: #990000">!</span> {<span style="color: #990000">:</span>browser browser}<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(test</span></span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>quit<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(use</span></span><span style="color: #990000">-</span>fixtures <span style="color: #990000">:</span>once <span style="font-weight: bold"><span style="color: #000000">(selenium</span></span><span style="color: #990000">-</span>fixture <span style="color: #990000">:</span>firefox<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> <span style="color: #990000">^:</span>browser test<span style="color: #990000">-</span>clojure
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to <span style="color: #FF0000">"http://clojure.org"</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>title<span style="color: #990000">)</span> <span style="color: #FF0000">"Clojure - home"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> <span style="color: #990000">^:</span>browser test<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>download
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to <span style="color: #FF0000">"http://clojure.org"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>click {<span style="color: #990000">:</span>xpath <span style="color: #FF0000">"//div[@class='menu']/*/a[text()='Download']"</span>}<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>title<span style="color: #990000">)</span> <span style="color: #FF0000">"Clojure - downloads"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://clojure.org/downloads"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>find #<span style="color: #FF0000">"Rich Hickey"</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>text {<span style="color: #990000">:</span>id <span style="color: #FF0000">"foot"</span>}<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>A complete version of this repository is available <a href="https://github.com/clojure-cookbook/browser-testing">on GitHub</a>. Check out a copy locally to catch up:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git clone https<span style="color: #990000">:</span>//github<span style="color: #990000">.</span>com/clojure-cookbook/browser-testing
$ cd browser-testing</tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Run the tests on the command line:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>browser

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> browser-testing<span style="color: #990000">.</span>core-test

<span style="color: #990000">[</span> Testing <span style="color: #990000">:</span>firefox <span style="color: #990000">]</span>

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>only browser-testing<span style="color: #990000">.</span>core-test/test-clojure

FAIL <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">(</span>test-clojure<span style="color: #990000">)</span> <span style="color: #990000">(</span>core_test<span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">20</span><span style="color: #990000">)</span>
expected<span style="color: #990000">:</span> <span style="color: #990000">(=</span> <span style="color: #990000">(</span>t/current-url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">)</span>
  actual<span style="color: #990000">:</span> <span style="color: #990000">(</span>not <span style="color: #990000">(=</span> <span style="color: #FF0000">"http://clojure.org/"</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">))</span>

Ran <span style="color: #993399">2</span> tests containing <span style="color: #993399">5</span> assertions<span style="color: #990000">.</span>
<span style="color: #993399">1</span> failures<span style="color: #990000">,</span> <span style="color: #993399">0</span> errors<span style="color: #990000">.</span>
Tests failed<span style="color: #990000">.</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_166">Discussion</h4>
<div class="paragraph"><p>Browser tests verify that your application behaves as expected in your
targeted browsers. They test the appearance and behavior of your
application as rendered in the browser itself.</p></div>
<div class="paragraph"><p>Manually testing applications in a browser is a tedious and repetitive
task. The amount of time and effort required for a complete test run
can be unmanageable for even a moderately sized project. Automating
browser tests ensures they are run consistently and relatively
quickly, resulting in reproducible errors and more frequent test runs.
However, automated tests lack the visual inspection by a human
inherent to manual tests. For example, a manual test could easily
catch a positioning error that an automated test would likely miss if
it were not explicitly tested for.</p></div>
<div class="paragraph"><p>To write browser tests in Clojure, use the <span class="monospaced">clj-webdriver</span> library with
your preferred test framework, such as <span class="monospaced">clojure.test</span>. <span class="monospaced">clj-webdriver</span>
provides a clean Clojure interface to Selenium WebDriver, a tool used
to control and automate browser actions.</p></div>
<div class="paragraph"><p>Some additional configuration may be required to use Selenium
WebDriver or <span class="monospaced">clj-webdriver</span> with your browsers of choice. See the
<a href="http://bit.ly/cc-selenium">Selenium WebDriver documentation</a>
and the <a href="http://bit.ly/clj-webdriver-wiki"><span class="monospaced">clj-webdriver</span> wiki</a>.</p></div>
<?hard-pagebreak?>
<div class="paragraph"><p>Before you dive into testing, you can experiment with <span class="monospaced">clj-webdriver</span> at
a REPL. Start up a REPL with <span class="monospaced">clj-webdriver</span> using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try clj-webdriver <span style="color: #FF0000">"0.6.0"</span></tt></pre></div></div>
<div class="paragraph"><p>Use the <span class="monospaced">clj-webdriver.taxi/set-driver!</span> function, selecting the Firefox
WebDriver implementation (other options include <span class="monospaced">:chrome</span> or <span class="monospaced">:ie</span>, but these may
require more setup):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clj<span style="color: #990000">-</span>webdriver<span style="color: #990000">.</span>taxi <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>driver<span style="color: #990000">!</span> {<span style="color: #990000">:</span>browser <span style="color: #990000">:</span>firefox}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; #clj_webdriver.driver.Driver{:webdriver ...}</span></span></tt></pre></div></div>
<div class="paragraph"><p>This will open the browser you picked, ready to receive commands. Try a few
functions from the <span class="monospaced">clj-webdriver.taxi</span> namespace:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to <span style="color: #FF0000">"http://clojure.org/"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "http://clojure.org/"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>title<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Clojure - home"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>click {<span style="color: #990000">:</span>xpath <span style="color: #FF0000">"//div[@class='menu']/*/a[text()='Download']"</span>}<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "http://clojure.org/downloads"</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>text {<span style="color: #990000">:</span>id <span style="color: #FF0000">"foot"</span>}<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; "Copyright 2008-2012 Rich Hickey"</span></span></tt></pre></div></div>
<div class="paragraph"><p>When you&#8217;re finished, close the browser from the REPL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>quit<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Your tests will use these functions to start up and run against the browser. To
save yourself some work, you should set up the browser startup and teardown
using a <span class="monospaced">clojure.test</span> fixture.</p></div>
<div class="paragraph"><p><span class="monospaced">clojure.test/use-fixtures</span> allows you to run functions around each individual
test, or once around the namespace&#8217;s test run as a whole. Use the latter, as
restarting the browser for each test will be far too slow.</p></div>
<div class="paragraph"><p>The <span class="monospaced">selenium-fixture</span> function uses <span class="monospaced">clj-webdriver</span>'s <span class="monospaced">set-driver!</span> and <span class="monospaced">quit</span>
functions to start up a browser for each of the keywords it&#8217;s provided and run
the namespace&#8217;s tests inside that browser:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> selenium<span style="color: #990000">-</span>fixture
  <span style="color: #990000">[&amp;</span> browsers<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span> <span style="color: #990000">[</span>test<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(doseq</span></span> <span style="color: #990000">[</span>browser browsers<span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>set<span style="color: #990000">-</span>driver<span style="color: #990000">!</span> {<span style="color: #990000">:</span>browser browser}<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(test</span></span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>quit<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #000000">(use</span></span><span style="color: #990000">-</span>fixtures <span style="color: #990000">:</span>once <span style="font-weight: bold"><span style="color: #000000">(selenium</span></span><span style="color: #990000">-</span>fixture <span style="color: #990000">:</span>firefox<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>It&#8217;s important to note that using a <span class="monospaced">:once</span> fixture means the state of the
browser will persist between tests. Depending on your particular application&#8217;s
behavior, you may need to guard against this when you write your tests by
beginning from a common browser state for each test. For example, you might
delete all cookies or return to a certain top-level page. If this is necessary,
you may find it useful to write this common reset behavior as an <span class="monospaced">:each</span>
fixture.</p></div>
<div class="paragraph"><p>To begin writing tests, modify your project&#8217;s <em>project.clj</em> file to include the
<span class="monospaced">clj-webdriver</span> dependency in the <span class="monospaced">:dev</span> profile and <span class="monospaced">:test-selectors</span> for
<span class="monospaced">:default</span> and <span class="monospaced">browser</span> convenience:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defproject</span></span> my<span style="color: #990000">-</span>project <span style="color: #FF0000">"1.0.0-SNAPSHOT"</span>
  <span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
  <span style="color: #990000">:</span>profiles {<span style="color: #990000">:</span>dev {<span style="color: #990000">:</span>dependencies <span style="color: #990000">[[</span>clj<span style="color: #990000">-</span>webdriver <span style="color: #FF0000">"0.6.0"</span><span style="color: #990000">]]</span>}}
  <span style="color: #990000">:</span>test<span style="color: #990000">-</span>selectors {<span style="color: #990000">:</span>default <span style="font-weight: bold"><span style="color: #000000">(complement</span></span> <span style="color: #990000">:</span>browser<span style="color: #990000">)</span>
                   <span style="color: #990000">:</span>browser <span style="color: #990000">:</span>browser}<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Test selectors let you run groups of tests independently. This prevents slower
browser tests from impacting the faster, more frequently run unit and lower-level integration tests.</p></div>
<div class="paragraph"><p>In this case, you&#8217;ve added a new selector and modified the default. The new
<span class="monospaced">:browser</span> selector will only match tests that have been annotated with a
<span class="monospaced">:browser</span> metadata key. The default selector will now exclude any tests with
this annotation.</p></div>
<div class="paragraph"><p>With the fixture and test selectors in place, you can begin writing your tests.
Start with something simple:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> <span style="color: #990000">^:</span>browser test<span style="color: #990000">-</span>clojure
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to <span style="color: #FF0000">"http://clojure.org/"</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>title<span style="color: #990000">)</span> <span style="color: #FF0000">"Clojure - home"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Note the <span class="monospaced">^:browser</span> metadata attached to the test. This test is annotated as a
browser test, and will only run when that test selector is chosen.</p></div>
<div class="paragraph"><p>In this test, as in the REPL experiment, you navigate to a URL and check its
title and URL. Run this test at the command line, passing the additional test
selector argument to <span class="monospaced">lein test</span>:</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>browser

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> browser-testing<span style="color: #990000">.</span>core-test

<span style="color: #990000">[</span> Testing <span style="color: #990000">:</span>firefox <span style="color: #990000">]</span>

lein <span style="font-weight: bold"><span style="color: #0000FF">test</span></span> <span style="color: #990000">:</span>only browser-testing<span style="color: #990000">.</span>core-test/test-clojure

FAIL <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">(</span>test-clojure<span style="color: #990000">)</span> <span style="color: #990000">(</span>core_test<span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">20</span><span style="color: #990000">)</span>
expected<span style="color: #990000">:</span> <span style="color: #990000">(=</span> <span style="color: #990000">(</span>t/current-url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">)</span>
  actual<span style="color: #990000">:</span> <span style="color: #990000">(</span>not <span style="color: #990000">(=</span> <span style="color: #FF0000">"http://clojure.org/"</span> <span style="color: #FF0000">"http://example.com/"</span><span style="color: #990000">))</span>

Ran <span style="color: #993399">2</span> tests containing <span style="color: #993399">5</span> assertions<span style="color: #990000">.</span>
<span style="color: #993399">1</span> failures<span style="color: #990000">,</span> <span style="color: #993399">0</span> errors<span style="color: #990000">.</span>
Tests failed<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Clearly, this test was bound to fail&#8212;replace <span class="monospaced">http://example.com/</span> with
<span class="monospaced">http://clojure.org/</span> and it will pass.</p></div>
<div class="paragraph"><p>This test is very basic. In most real tests, you&#8217;ll load a URL, interact with
the page, and verify that the application behaved as expected. Write another
test that interacts with the page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(deftest</span></span> <span style="color: #990000">^:</span>browser test<span style="color: #990000">-</span>clojure<span style="color: #990000">-</span>download
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>to <span style="color: #FF0000">"http://clojure.org"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>click {<span style="color: #990000">:</span>xpath <span style="color: #FF0000">"//div[@class='menu']/*/a[text()='Download']"</span>}<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>title<span style="color: #990000">)</span> <span style="color: #FF0000">"Clojure - downloads"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="color: #990000">(=</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>current<span style="color: #990000">-</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">"http://clojure.org/downloads"</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">(is</span></span> <span style="font-weight: bold"><span style="color: #000000">(re</span></span><span style="color: #990000">-</span>find #<span style="color: #FF0000">"Rich Hickey"</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>text {<span style="color: #990000">:</span>id <span style="color: #FF0000">"foot"</span>}<span style="color: #990000">))))</span></tt></pre></div></div>
<div class="paragraph"><p>In this test, after loading the URL, the browser is directed to click on an
anchor located with an XPath selector. To verify that the expected page has
loaded, the test compares the title and URL, as in the first test. Lastly, it
finds the text content of the <span class="monospaced">#foot</span> element containing the copyright and
verifies that the text includes the expected name.</p></div>
<div class="paragraph"><p><span class="monospaced">clj-webdriver</span> provides many other capabilities for interacting with your
application. For more information, see the
<a href="http://bit.ly/clj-webdriver-wiki"><span class="monospaced">clj-webdriver</span> wiki</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_165">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">clj-webdriver</span> <a href="https://github.com/semperos/clj-webdriver">GitHub
  repository</a> and <a href="http://bit.ly/clj-webdriver-wiki">wiki</a>
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/selenium-project">Selenium project page</a>
</p>
</li>
<li>
<p>
<a href="#sec_unit_testing">[sec_unit_testing]</a>, to learn more about unit testing in Clojure
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_tracing_code_execution">Tracing Code Execution</h3>
<div class="paragraph byline"><p>by Stefan Karlsson</p></div>
<div class="sect3">
<h4 id="_problem_167">Problem</h4>
<div class="paragraph"><p>You want to trace the execution of your code, in order to see what it
is doing.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_165">Solution</h4>
<div class="paragraph"><p>Use the <a href="https://github.com/clojure/tools.trace"><span class="monospaced">tools.trace</span></a>
library&#8217;s bevy of "trace" functions and macros to examine your
code as it runs.</p></div>
<div class="paragraph"><p>Before starting, add <span class="monospaced">[org.clojure/tools.trace "0.7.6"]</span> to your
project&#8217;s dependencies under the <span class="monospaced">:development</span> profile (in the vector
at the <span class="monospaced">:profiles {:dev {:dependencies [...]}}</span> path instead of the
<span class="monospaced">:dependencies [...]</span> path). Alternatively, start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lein try org<span style="color: #990000">.</span>clojure/tools<span style="color: #990000">.</span>trace</tt></pre></div></div>
<div class="paragraph"><p>To examine a single value at execution, wrap that value in an
invocation of <span class="monospaced">clojure.tools.trace/trace</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>tools<span style="color: #990000">.</span>trace <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #000000">(map</span></span> #<span style="font-weight: bold"><span style="color: #000000">(inc</span></span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace <span style="color: #990000">%))</span>
     <span style="font-weight: bold"><span style="color: #000000">(range</span></span> <span style="color: #993399">3</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; (1 2 3)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE: 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE: 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE: 2</span></span></tt></pre></div></div>
<div class="paragraph"><p>To examine multiple values without losing context of which trace is
which, supply a descriptive name string as the first argument to
<span class="monospaced">trace</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> divide
  <span style="color: #990000">[</span>n d<span style="color: #990000">]</span>
  <span style="color: #990000">(/</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace <span style="color: #FF0000">"numerator"</span> n<span style="color: #990000">)</span>
     <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace <span style="color: #FF0000">"denominator"</span> d<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(divide</span></span> <span style="color: #993399">4</span> <span style="color: #993399">6</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 2/3</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE numerator: 4</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE denominator: 6</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_167">Discussion</h4>
<div class="paragraph"><p>At its core, the <span class="monospaced">tools.trace</span> library is all about introspecting upon
the execution of a body of code. The <span class="monospaced">trace</span> function is the simplest
and most low-level tracing operation. Wrapping a value in an
invocation of <span class="monospaced">trace</span> does two things: it logs a tracer message to
<span class="monospaced">STDOUT</span> and, most importantly, returns the original value unadulterated.
<span class="monospaced">tools.trace</span> provides a number of other granularities for tracing
execution.</p></div>
<div class="paragraph"><p>Stepping up a level from simple values, you can define functions with
<span class="monospaced">clojure.tools.trace/deftrace</span> instead of <span class="monospaced">defn</span> to trace the input to
and output from the function you define:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>deftrace pow <span style="color: #990000">[</span>x n<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(Math</span></span><span style="color: #990000">/</span>pow x n<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(pow</span></span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 8.0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t815: (pow 2 3)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t815: =&gt; 8.0</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph"><p>It is not advisable to deploy production code with tracing in place.
Tracing is most suited to development and debugging, particularly from
the REPL. Include <span class="monospaced">tools.trace</span> in your <em>project.clj</em>'s <span class="monospaced">:dev</span> profile
to make tracing available only to development tasks.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>If you&#8217;re trying to diagnose a difficult-to-understand exception, use
the <span class="monospaced">clojure.tools.trace/trace-forms</span> macro to wrap an expression and
pinpoint the origin of the exception. When no exception occurs,
<span class="monospaced">trace-forms</span> prints no output and returns normally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace<span style="color: #990000">-</span>forms <span style="color: #990000">(*</span> <span style="font-weight: bold"><span style="color: #000000">(pow</span></span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
                  <span style="font-weight: bold"><span style="color: #000000">(divide</span></span> <span style="color: #993399">1</span> <span style="color: #990000">(-</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #990000">))))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ...</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; ArithmeticException Divide by zero</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   Form failed: (divide 1 (- 1 1))</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   Form failed: (* (pow 2 3) (divide 1 (- 1 1)))</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;;   clojure.lang.Numbers.divide (Numbers.java:156)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Apart from explicitly tracing values or functions, <span class="monospaced">tools.trace</span> also
allows you to dynamically trace vars or entire namespaces. To add a
trace function to a var, use <span class="monospaced">clojure.tools.trace/trace-vars</span>. To
remove such a trace, use <span class="monospaced">clojure.tools.trace/untrace-vars</span>:</p></div>
<?hard-pagebreak?>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(defn</span></span> add <span style="color: #990000">[</span>x y<span style="color: #990000">]</span> <span style="color: #990000">(+</span> x y<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace<span style="color: #990000">-</span>vars add<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(add</span></span> <span style="color: #993399">2</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 4</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; *out*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1309: (user/add 2 2)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1309: =&gt; 4</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>untrace<span style="color: #990000">-</span>vars add<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">(add</span></span> <span style="color: #993399">2</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 4</span></span></tt></pre></div></div>
<div class="paragraph"><p>To trace or untrace an entire namespace, use
<span class="monospaced">clojure.tools.trace/trace-ns</span> and <span class="monospaced">clojure.tools.trace/untrace-ns</span>,
respectively. This will dynamically add tracing to or remove it from all
functions and vars in a namespace. Even things defined <em>after</em>
<span class="monospaced">trace-ns</span> is invoked will be traced:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(def</span></span> my<span style="color: #990000">-</span>inc inc<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>trace<span style="color: #990000">-</span>ns 'user<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> my<span style="color: #990000">-</span>dec <span style="color: #990000">[</span>n<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #000000">(dec</span></span> n<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>inc <span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>dec <span style="color: #993399">0</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1217: (user/my-dec 0)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1218: | (user/my-dec 0)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1218: | =&gt; -1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1217: =&gt; -1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1219: (user/my-inc -1)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1220: | (user/my-inc -1)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1220: | =&gt; 0</span></span>
<span style="font-style: italic"><span style="color: #9A1900">;; TRACE t1219: =&gt; 0</span></span>

<span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>untrace<span style="color: #990000">-</span>ns 'user<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>inc <span style="font-weight: bold"><span style="color: #000000">(my</span></span><span style="color: #990000">-</span>dec <span style="color: #993399">0</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">;; -&gt; 0</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_166">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">tools.trace</span> <a href="https://github.com/clojure/tools.trace">GitHub
  repository</a> for a full list of trace functions/macros
</p>
</li>
</ul></div>
<?hard-pagebreak?>
</div>
</div>
<div class="sect2">
<h3 id="sec_avoid_null">Avoiding Null-Pointer Exceptions with core.typed</h3>
<div class="paragraph byline"><p>by Ambrose Bonnaire-Sergeant</p></div>
<div class="sect3">
<h4 id="_problem_168">Problem</h4>
<div class="paragraph"><p>You want to verify that your code handles <span class="monospaced">nil</span> correctly, eliminating
potential null-pointer exceptions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_166">Solution</h4>
<div class="paragraph"><p>Use  <a href="https://github.com/clojure/core.typed"><span class="monospaced">core.typed</span></a>, an optional type system for Clojure, to annotate and
check a namespace for misuses of <span class="monospaced">nil</span>.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a file <em>core_typed_samples.clj</em>
and start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ touch core_typed_samples<span style="color: #990000">.</span>clj
$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>typed</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is a little different than others because <span class="monospaced">core.typed</span> uses
on-disk files to check namespaces.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Consider, for example, that you are writing a function <span class="monospaced">handle-number</span>
to process numbers. To verify that <span class="monospaced">handle-number</span> handles <span class="monospaced">nil</span> correctly,
annotate it with <span class="monospaced">clojure.core.typed/ann</span> to accept the union (<span class="monospaced">U</span>) of the <span class="monospaced">nil</span> and
<span class="monospaced">Number</span> types, returning a <span class="monospaced">Number</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> handle<span style="color: #990000">-</span>number <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(U</span></span> nil Number<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> Number<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handle<span style="color: #990000">-</span>number <span style="color: #990000">[</span>a<span style="color: #990000">]</span>
  <span style="color: #990000">(+</span> a <span style="color: #993399">20</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Verify the function&#8217;s correctness at the REPL using <span class="monospaced">clojure.core.typed/check-ns</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>check<span style="color: #990000">-</span>ns 'core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">)</span>
# <span style="color: #990000">...</span>
Type Error <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">:</span><span style="color: #993399">6</span><span style="color: #990000">:</span><span style="color: #993399">3</span><span style="color: #990000">)</span> Static method clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Numbers<span style="color: #990000">/</span>add
could not be applied to arguments<span style="color: #990000">:</span>

Domains<span style="color: #990000">:</span>
        t<span style="color: #990000">/</span>AnyInteger t<span style="color: #990000">/</span>AnyInteger
        java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number

Arguments<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #000000">(U</span></span> nil java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">(Value</span></span> <span style="color: #993399">20</span><span style="color: #990000">)</span>

Ranges<span style="color: #990000">:</span>
        t<span style="color: #990000">/</span>AnyInteger
        java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number

with expected type<span style="color: #990000">:</span>
        java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number

in<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Numbers<span style="color: #990000">/</span>add a <span style="color: #993399">20</span><span style="color: #990000">)</span>
in<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">(clojure</span></span><span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Numbers<span style="color: #990000">/</span>add a <span style="color: #993399">20</span><span style="color: #990000">)</span>

ExceptionInfo Type Checker<span style="color: #990000">:</span> Found <span style="color: #993399">1</span> error  clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>ex<span style="color: #990000">-</span>info <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">4327</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The current definition is unsafe. <span class="monospaced">check-ns</span> recognizes that <span class="monospaced">+</span> can
only handle numbers, while the <span class="monospaced">handle-number</span> function accepts
numbers <em>or</em> <span class="monospaced">nil</span>.</p></div>
<div class="paragraph"><p>Protect the call to <span class="monospaced">+</span> by wrapping it in an <span class="monospaced">if</span> statement, returning
<span class="monospaced">0</span> in the absence of <span class="monospaced">a</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> handle<span style="color: #990000">-</span>number <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(U</span></span> nil Number<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> Number<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> handle<span style="color: #990000">-</span>number <span style="color: #990000">[</span>a<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> a
    <span style="color: #990000">(+</span> a <span style="color: #993399">20</span><span style="color: #990000">)</span>
    <span style="color: #993399">0</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Check the namespace with <span class="monospaced">check-ns</span> again:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>check<span style="color: #990000">-</span>ns 'core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">)</span>
# <span style="color: #990000">...</span>
<span style="color: #990000">:</span>ok</tt></pre></div></div>
<div class="paragraph"><p>Now that there is no way <span class="monospaced">nil</span> could accidentally be passed to <span class="monospaced">+</span> by this
code, a null-pointer exception is impossible.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_168">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">core.typed</span> is designed to avoid all misuses of <span class="monospaced">nil</span> or <span class="monospaced">null</span> in
typed code. To achieve this, the concepts of the null pointer and
reference types are separated. This is unlike in Java, where a type like
<span class="monospaced">java.lang.Number</span> implies a "nullable" type.</p></div>
<div class="paragraph"><p>In <span class="monospaced">core.typed</span>, reference types are implicitly non-nullable. To express
a nullable type (such as in the preceding example), construct a <em>union
type</em> of the desired type and <span class="monospaced">nil</span>. For example, a <span class="monospaced">java.lang.Number</span>
in <span class="monospaced">core.typed</span> syntax is non-nullable; the union type <span class="monospaced">(U nil
java.lang.Number)</span> expresses the equivalent to a nullable
<span class="monospaced">java.lang.Number</span> (the latter is closest to what <span class="monospaced">java.lang.Number</span>
implies in Java type syntax).</p></div>
<div class="paragraph"><p>This separation of concepts allows <span class="monospaced">core.typed</span> to throw a <em>type error</em>
on any potential misuse of <span class="monospaced">nil</span>. The preceding solution threw a type
error when type checking the equivalent expression: <span class="monospaced">(+ nil 20)</span>.</p></div>
<div class="paragraph"><p>To better understand <span class="monospaced">core.typed</span> type errors, it is useful to note that
some functions have <em>inline</em> definitions. <span class="monospaced">core.typed</span> fully expands all
code before type checking, so it is common to see calls to the Java
method <span class="monospaced">clojure.lang.Numbers/add</span> in type errors when user code
invokes <span class="monospaced">clojure.core/+</span>.</p></div>
<div class="paragraph"><p>It is also common to see <em>ordered intersection function types</em> in type
errors. Our first type error claims that the arguments <span class="monospaced">(U Number
nil)</span> and <span class="monospaced">(Value 20)</span> are not under either of the ordered
intersection function domains, listed under "Domains." Notice two
"Ranges" are provided, which correspond to the listed domains.</p></div>
<div class="paragraph"><p>The full type of <span class="monospaced">clojure.lang.Numbers/add</span> is:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>t<span style="color: #990000">/</span>AnyInteger t<span style="color: #990000">/</span>AnyInteger <span style="color: #990000">-&gt;</span> t<span style="color: #990000">/</span>AnyInteger<span style="color: #990000">]</span>
    <span style="color: #990000">[</span>Number Number <span style="color: #990000">-&gt;</span> Number<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Briefly, the function is "ordered" because it tries to match the
argument types with each arity until one matches.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_167">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/clojure/core.typed"><span class="monospaced">core.typed</span> Home</a> on GitHub.
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/core-typed-doc"><span class="monospaced">core.typed</span> API reference</a> (particularly the list of core-type aliases&#8212;for example, the entry for <a href="http://bit.ly/anyinteger-doc">clojure.core.typed/AnyInteger</a>)
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/core-typed-types">Types wiki page</a>, which documents valid types
</p>
</li>
<li>
<p>
<a href="#sec_verify_java">[sec_verify_java]</a>, and <a href="#sec_verify_hof">[sec_verify_hof]</a>, for further
  examples of how to use <span class="monospaced">core.typed</span>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_verify_java">Verifying Java Interop Using core.typed</h3>
<div class="paragraph byline"><p>by Ambrose Bonnaire-Sergeant</p></div>
<div class="sect3">
<h4 id="_problem_169">Problem</h4>
<div class="paragraph"><p>You want to verify that you are using Java libraries safely and
unambiguously.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_167">Solution</h4>
<div class="paragraph"><p>Java provides a vast ecosystem that is a major draw for Clojure
developers; however, it can be often be complex to use large,
cumbersome Java APIs from Clojure.</p></div>
<div class="paragraph"><p>To type-check Java interop calls, use <span class="monospaced">core.typed</span>.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a file <em>core_typed_samples.clj</em>
and start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ touch core_typed_samples<span style="color: #990000">.</span>clj
$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>typed</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is a little different than others because <span class="monospaced">core.typed</span> uses
on-disk files to check namespaces.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To demonstrate, choose a standard Java API function such as the
<span class="monospaced">java.io.File</span> constructor.</p></div>
<div class="paragraph"><p>Using the dot constructor to create new files can be annoying&#8212;wrap it
in a Clojure function that takes a string <span class="monospaced">new-file</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
  <span style="color: #990000">(:</span>import <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io File<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[</span>String <span style="color: #990000">-&gt;</span> File<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> s<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Setting <span class="monospaced">*warn-on-reflection*</span> when compiling this namespace will tell
us that there is a reflective call to the <span class="monospaced">java.io.File</span> constructor.
Checking this namespace at the REPL with <span class="monospaced">clojure.core.typed/check-ns</span> will
report the same information, albeit in the form of a type error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>check<span style="color: #990000">-</span>ns 'core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">)</span>
# <span style="color: #990000">...</span>
ExceptionInfo Internal Error <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">:</span><span style="color: #993399">6</span><span style="color: #990000">)</span>
  Unresolved constructor invocation java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File<span style="color: #990000">.</span>

Hint<span style="color: #990000">:</span> add type hints<span style="color: #990000">.</span>

in<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">(new</span></span> java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File s<span style="color: #990000">)</span>  clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>ex<span style="color: #990000">-</span>info <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">4327</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Add a type hint to call the <a href="http://bit.ly/javadoc-file-constructor"><span class="monospaced">public File(String pathname)</span></a> constructor:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
  <span style="color: #990000">(:</span>import <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io File<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[</span>String <span style="color: #990000">-&gt;</span> File<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[^</span>String s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> s<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Checking again, <span class="monospaced">core.typed</span> is satisfied:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>t/check-ns <span style="color: #FF0000">'core-typed-samples)</span>
<span style="color: #FF0000"># ...</span>
<span style="color: #FF0000">:ok</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">File</span> has a second single-argument constructor: <span class="monospaced">public File(URI
uri)</span>. Enhance <span class="monospaced">new-file</span> to support <span class="monospaced">URI</span> or <span class="monospaced">String</span> filenames:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
  <span style="color: #990000">(:</span>import <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io File<span style="color: #990000">)</span>
           <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>net URI<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">(U</span></span> URI String<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> File<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> new<span style="color: #990000">-</span>file <span style="color: #990000">[</span>s<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">(if</span></span> <span style="font-weight: bold"><span style="color: #000000">(string</span></span><span style="color: #990000">?</span> s<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> <span style="color: #990000">^</span>String s<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">(File</span></span><span style="color: #990000">.</span> <span style="color: #990000">^</span>URI s<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>Even after relaxing the input type to <span class="monospaced">(U URI String)</span>, <span class="monospaced">core.typed</span> is
able to infer that each branch has the correct type by following the
<span class="monospaced">string?</span> predicate.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_169">Discussion</h4>
<div class="paragraph"><p>While <span class="monospaced">java.io.File</span> is a relatively small API, careful inspection of
Java types <em>and</em> documentation is needed to confidently use foreign
Java code correctly.</p></div>
<div class="paragraph"><p>Though the <span class="monospaced">File</span> constructor is fairly innocuous, consider writing
<span class="monospaced">file-parent</span>, a thin wrapper over the <span class="monospaced">getParent</span> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann<span style="color: #990000">]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
  <span style="color: #990000">(:</span>import <span style="font-weight: bold"><span style="color: #000000">(java</span></span><span style="color: #990000">.</span>io File<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> file<span style="color: #990000">-</span>parent <span style="color: #990000">[</span>File <span style="color: #990000">-&gt;</span> String<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> file<span style="color: #990000">-</span>parent <span style="color: #990000">[^</span>File f<span style="color: #990000">]</span>
  <span style="color: #990000">(.</span>getParent f<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The preceding implementation is free from reflective calls, so&#8230; all
good? No. Checking this function with <span class="monospaced">core.typed</span> tells another story;
Java&#8217;s return types are <em>nullable</em> and <span class="monospaced">core.typed</span> knows it. It is
possible that <span class="monospaced">getParent</span> will return <span class="monospaced">nil</span> instead of a <span class="monospaced">String</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>check<span style="color: #990000">-</span>ns 'core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">)</span>
# <span style="color: #990000">...</span>
Type Error <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">:</span><span style="color: #993399">7</span><span style="color: #990000">:</span><span style="color: #993399">3</span><span style="color: #990000">)</span> Return type of instance method
java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File<span style="color: #990000">/</span>getParent is <span style="font-weight: bold"><span style="color: #000000">(U</span></span> java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>String nil<span style="color: #990000">),</span> expected
java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>String<span style="color: #990000">.</span>

Hint<span style="color: #990000">:</span> Use `non<span style="color: #990000">-</span>nil<span style="color: #990000">-</span>return` and `nilable<span style="color: #990000">-</span>param` to configure where
`nil` is allowed in a Java method call<span style="color: #990000">.</span> `method<span style="color: #990000">-</span>type` prints the
current type of a method<span style="color: #990000">.</span>
in<span style="color: #990000">:</span> <span style="color: #990000">(.</span>getParent f<span style="color: #990000">)</span>

Type Error <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">:</span><span style="color: #993399">6</span><span style="color: #990000">)</span> Type mismatch<span style="color: #990000">:</span>

Expected<span style="color: #990000">:</span>       java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>String

Actual<span style="color: #990000">:</span>         <span style="font-weight: bold"><span style="color: #000000">(U</span></span> String nil<span style="color: #990000">)</span>
in<span style="color: #990000">:</span> <span style="color: #990000">(.</span>getParent f<span style="color: #990000">)</span>

Type Error <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">:</span><span style="color: #993399">6</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">)</span> Type mismatch<span style="color: #990000">:</span>

Expected<span style="color: #990000">:</span>       <span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File <span style="color: #990000">-&gt;</span> java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>String<span style="color: #990000">])</span>

Actual<span style="color: #990000">:</span>         <span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(U</span></span> String nil<span style="color: #990000">)])</span>
in<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">(def</span></span> file<span style="color: #990000">-</span>parent <span style="font-weight: bold"><span style="color: #000000">(fn</span></span><span style="color: #990000">*</span> <span style="color: #990000">([</span>f<span style="color: #990000">]</span> <span style="color: #990000">(.</span>getParent f<span style="color: #990000">))))</span>

ExceptionInfo Type Checker<span style="color: #990000">:</span> Found <span style="color: #993399">3</span> errors clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>ex<span style="color: #990000">-</span>info <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">core.typed</span> assumes all methods return nullable types, so it is a type
error to annotate <span class="monospaced">parent</span> as <span class="monospaced">[File -&gt; String]</span>. Each preceding type error reiterates that the annotation tried to claim a <span class="monospaced">(U nil String)</span>
was a <span class="monospaced">String</span>, with the most specific (and useful) error being the
first.</p></div>
<div class="paragraph"><p><span class="monospaced">core.typed</span> is designed to be pessimistic about Java code, while being
accurate enough to avoid adding arbitrary code to "please" the type checker.
For example, <span class="monospaced">core.typed</span> distrusts Java methods enough to assume all method
parameters are non-nullable and the return type is nullable by default.
On the other hand, <span class="monospaced">core.typed</span> knows Java constructors never return <span class="monospaced">null</span>.</p></div>
<div class="paragraph"><p>If <span class="monospaced">core.typed</span> is too pessimistic for you with its nullable return
types, you can override particular methods with
<span class="monospaced">clojure.core.typed/non-nil-return</span>. Adding the following to the preceding
code would result in a successful type check (check omitted for
brevity):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>non<span style="color: #990000">-</span>nil<span style="color: #990000">-</span>return java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>File<span style="color: #990000">/</span>getName <span style="color: #990000">:</span>all<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>As of this writing, <span class="monospaced">core.typed</span> does not enforce static type overrides
at runtime, so use <span class="monospaced">non-nil-return</span> and similar features with caution.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Sometimes the type checker might seem overly picky; in the solution,
two type-hinted constructors were necessary. It might seem normal in a
dynamically typed language to simply call <span class="monospaced">(File. s)</span> and allow
reflection to resolve any ambiguity. By conforming to what <span class="monospaced">core.typed</span>
expects, however, all ambiguity is eliminated from the constructors,
and the type hints inserted enable the Clojure compiler to
generate efficient bytecode.</p></div>
<div class="paragraph"><p>It is valid to wonder why both type hints <em>and</em> <span class="monospaced">core.typed</span> annotations
are needed to type-check ambiguous Java calls. A type hint is a
directive to the compiler, while type annotations are merely for
<span class="monospaced">core.typed</span> to consume during type checking. <span class="monospaced">core.typed</span> does not have
influence over resolving reflection calls at compile time, so it
chooses to assume all reflective calls are ambiguous instead of
trying to guess what the reflection might resolve to at runtime. This
simple rule usually results in faster, more explicit code, often
desirable in larger code bases.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_168">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/clojure/core.typed"><span class="monospaced">core.typed</span> Home</a> on GitHub
</p>
</li>
<li>
<p>
The <a href="http://bit.ly/core-typed-doc"><span class="monospaced">core.typed</span> API reference</a>&#x2014;particularly the documentation for <span class="monospaced">non-nil-return</span> and <span class="monospaced">nilable-param</span>
</p>
</li>
<li>
<p>
<a href="#sec_avoid_null">[sec_avoid_null]</a>, and <a href="#sec_verify_hof">[sec_verify_hof]</a>, for further
  examples of how to use <span class="monospaced">core.typed</span>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="sec_verify_hof">Type Checking Higher-Order Functions with core.typed</h3>
<div class="paragraph byline"><p>by Ambrose Bonnaire-Sergeant</p></div>
<div class="sect3">
<h4 id="_problem_170">Problem</h4>
<div class="paragraph"><p>Clojure strongly encourages higher-order functions, but tools for
verifying their use focus on runtime verification. You want earlier
feedback, preferably at compile time.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_168">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">core.typed</span> to type-check higher-order functions.</p></div>
<div class="paragraph"><p>To follow along with this recipe, create a file <em>core_typed_samples.clj</em>
and start a REPL using <span class="monospaced">lein-try</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ touch core_typed_samples<span style="color: #990000">.</span>clj
$ lein try org<span style="color: #990000">.</span>clojure/core<span style="color: #990000">.</span>typed</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is a little different than others because <span class="monospaced">core.typed</span> uses
on-disk files to check namespaces.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To demonstrate <span class="monospaced">core.typed</span>'s abilities, define a typed higher-order
function <span class="monospaced">hash-of?</span>, which accepts two predicates and returns a new
predicate.</p></div>
<div class="paragraph"><p>Use <span class="monospaced">clojure.core.typed/fn&gt;</span> to return an anonymous
function with type annotations attached:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">(ns</span></span> core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples
  <span style="color: #990000">(:</span>require <span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>ann fn<span style="color: #990000">&gt;]</span> <span style="color: #990000">:</span>as t<span style="color: #990000">]))</span>

<span style="font-weight: bold"><span style="color: #000000">(ann</span></span> hash<span style="color: #990000">-</span>of<span style="color: #990000">?</span> <span style="color: #990000">[[</span>Any <span style="color: #990000">-&gt;</span> Any<span style="color: #990000">]</span> <span style="color: #990000">[</span>Any <span style="color: #990000">-&gt;</span> Any<span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">[</span>Any <span style="color: #990000">-&gt;</span> Any<span style="color: #990000">]])</span>
<span style="font-weight: bold"><span style="color: #000000">(defn</span></span> hash<span style="color: #990000">-</span>of<span style="color: #990000">?</span> <span style="color: #990000">[</span>ks<span style="color: #990000">?</span> vs<span style="color: #990000">?]</span>
  <span style="font-weight: bold"><span style="color: #000000">(fn</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">[</span>m <span style="color: #990000">:-</span> Any<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">(when</span></span> <span style="font-weight: bold"><span style="color: #000000">(map</span></span><span style="color: #990000">?</span> m<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">(and</span></span> <span style="font-weight: bold"><span style="color: #000000">(every</span></span><span style="color: #990000">?</span> ks<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(keys</span></span> m<span style="color: #990000">))</span>
           <span style="font-weight: bold"><span style="color: #000000">(every</span></span><span style="color: #990000">?</span> vs<span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #000000">(vals</span></span> m<span style="color: #990000">))))))</span></tt></pre></div></div>
<div class="paragraph"><p>Each argument to <span class="monospaced">hash-of?</span> has type <span class="monospaced">[Any -&gt; Any]</span>: a single argument
function taking anything and returning anything.</p></div>
<div class="paragraph"><p>Verifying <span class="monospaced">hash-of?</span> confirms that the preceding type annotations are correct:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>clojure<span style="color: #990000">.</span>core<span style="color: #990000">.</span>typed <span style="color: #990000">:</span>as t<span style="color: #990000">])</span>
user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>check<span style="color: #990000">-</span>ns 'core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples<span style="color: #990000">)</span>
# <span style="color: #990000">...</span>
<span style="color: #990000">:</span>ok</tt></pre></div></div>
<div class="paragraph"><p>Using the <span class="monospaced">clojure.core.typed/cf</span> macro, you can type-check individual
forms at the REPL (or under test). Invoking <span class="monospaced">hash-of?</span> with two
predicates verifies as expected, outputting the resulting type:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(require</span></span> '<span style="color: #990000">[</span>core<span style="color: #990000">-</span>typed<span style="color: #990000">-</span>samples <span style="color: #990000">:</span>refer <span style="color: #990000">[</span>hash<span style="color: #990000">-</span>of<span style="color: #990000">?]])</span>
user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>cf <span style="font-weight: bold"><span style="color: #000000">(hash</span></span><span style="color: #990000">-</span>of<span style="color: #990000">?</span> number<span style="color: #990000">?</span> number<span style="color: #990000">?))</span>
<span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>Any <span style="color: #990000">-&gt;</span> Any<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Passing <span class="monospaced">+</span> as a predicate, however, is a type error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user<span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #000000">(t</span></span><span style="color: #990000">/</span>cf <span style="font-weight: bold"><span style="color: #000000">(hash</span></span><span style="color: #990000">-</span>of<span style="color: #990000">?</span> <span style="color: #990000">+</span> number<span style="color: #990000">?))</span>
Type Error <span style="font-weight: bold"><span style="color: #000000">(user</span></span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">:</span><span style="color: #993399">7</span><span style="color: #990000">)</span> Type mismatch<span style="color: #990000">:</span>

Expected<span style="color: #990000">:</span>       <span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>Any <span style="color: #990000">-&gt;</span> Any<span style="color: #990000">])</span>

Actual<span style="color: #990000">:</span>         <span style="font-weight: bold"><span style="color: #000000">(Fn</span></span> <span style="color: #990000">[</span>t<span style="color: #990000">/</span>AnyInteger <span style="color: #990000">*</span> <span style="color: #990000">-&gt;</span> t<span style="color: #990000">/</span>AnyInteger<span style="color: #990000">]</span>
                    <span style="color: #990000">[</span>java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number <span style="color: #990000">*</span> <span style="color: #990000">-&gt;</span> java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number<span style="color: #990000">])</span>

ExceptionInfo Type Checker<span style="color: #990000">:</span> Found <span style="color: #993399">1</span> error  clojure<span style="color: #990000">.</span>core<span style="color: #990000">/</span>ex<span style="color: #990000">-</span>info <span style="font-weight: bold"><span style="color: #000000">(core</span></span><span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">4327</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This is because <span class="monospaced">hash-of?</span> takes a function with an <span class="monospaced">Any</span> parameter and <span class="monospaced">+</span>
takes at most a <span class="monospaced">Number</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_170">Discussion</h4>
<div class="paragraph"><p>While Clojure&#8217;s built-in pre/post conditions are useful for defining
anonymous functions that fail fast, these checks only provide feedback
at runtime. Why not type-check our higher-order functions as well?
<span class="monospaced">core.typed</span>'s type-checking abilities aren&#8217;t limited to only data
types&#8212;it can also type-check functions as types themselves.</p></div>
<div class="paragraph"><p>By returning anonymous functions created with the
<span class="monospaced">clojure.core.typed/fn&gt;</span> form instead of <span class="monospaced">fn</span>, it is possible to
annotate function objects with <span class="monospaced">core.typed</span>'s rich type-checking system.
When defining functions with <span class="monospaced">fn&gt;</span>, annotate types to its arguments
with the <span class="monospaced">:-</span> operator. For example, <span class="monospaced">(t/fn&gt; [m :- Map]</span> <literal>...)</literal> would
indicate an anonymous function that accepted a <span class="monospaced">Map</span> as its sole
argument.</p></div>
<div class="paragraph"><p>Beyond definition, it can also be useful to check the types of forms
at the REPL. The <span class="monospaced">clojure.core.typed/cf</span> macro is a versatile
REPL-oriented tool for on-demand type checking. It proves useful not
only for checking your code, but also for investigating built-in functions.
Invoking <span class="monospaced">cf</span> on any of Clojure&#8217;s higher-order functions reveals their
type signatures:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>t/cf iterate<span style="color: #990000">)</span>
<span style="color: #990000">(</span>All <span style="color: #990000">[</span>x<span style="color: #990000">]</span>
  <span style="color: #990000">(</span>Fn <span style="color: #990000">[(</span>Fn <span style="color: #990000">[</span>x -<span style="color: #990000">&gt;</span> x<span style="color: #990000">])</span> x -<span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>clojure<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>LazySeq x<span style="color: #990000">)]))</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">All</span> around <span class="monospaced">iterate</span>'s type indicates that it is <em>polymorphic</em>
in <span class="monospaced">x</span>. It reads, "for all types <span class="monospaced">x</span>, takes a function that accepts an <span class="monospaced">x</span>
and returns an <span class="monospaced">x</span>, and takes an <span class="monospaced">x</span>, and returns a lazy sequence of <span class="monospaced">x</span>."</p></div>
<div class="paragraph"><p>The <span class="monospaced">cf</span> macro can also detect when the wrong number of arguments are
being passed to a function returned by another function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">user</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">(</span>t/cf <span style="color: #990000">(</span>fn <span style="color: #990000">[]</span> <span style="color: #990000">((</span>hash-of<span style="color: #990000">?</span> <span style="color: #990000">+</span> number<span style="color: #990000">?))))</span>
Type Error <span style="color: #990000">(</span>user<span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">:</span><span style="color: #993399">15</span><span style="color: #990000">)</span> Type mismatch<span style="color: #990000">:</span>

Expected<span style="color: #990000">:</span>       <span style="color: #990000">(</span>Fn <span style="color: #990000">[</span>Any -<span style="color: #990000">&gt;</span> Any<span style="color: #990000">])</span>

Actual<span style="color: #990000">:</span>         <span style="color: #990000">(</span>Fn <span style="color: #990000">[</span>t/AnyInteger <span style="color: #990000">*</span> -<span style="color: #990000">&gt;</span> t/AnyInteger<span style="color: #990000">]</span>
                    <span style="color: #990000">[</span>java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number <span style="color: #990000">*</span> -<span style="color: #990000">&gt;</span> java<span style="color: #990000">.</span>lang<span style="color: #990000">.</span>Number<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #0000FF">in</span></span><span style="color: #990000">:</span> <span style="color: #990000">((</span>core-typed-samples/hash-of<span style="color: #990000">?</span> clojure<span style="color: #990000">.</span>core<span style="color: #990000">/+</span> clojure<span style="color: #990000">.</span>core/number<span style="color: #990000">?))</span>

Type Error <span style="color: #990000">(</span>user<span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">:</span><span style="color: #993399">14</span><span style="color: #990000">)</span> Wrong number of arguments<span style="color: #990000">,</span> expected <span style="color: #993399">1</span> fixed
parameters<span style="color: #990000">,</span> and got <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> function <span style="color: #990000">[</span>Any -<span style="color: #990000">&gt;</span> Any<span style="color: #990000">]</span> and arguments <span style="color: #990000">[]</span>
<span style="font-weight: bold"><span style="color: #0000FF">in</span></span><span style="color: #990000">:</span> <span style="color: #990000">((</span>core-typed-samples/hash-of<span style="color: #990000">?</span> clojure<span style="color: #990000">.</span>core<span style="color: #990000">/+</span> clojure<span style="color: #990000">.</span>core/number<span style="color: #990000">?))</span>

ExceptionInfo Type Checker<span style="color: #990000">:</span> Found <span style="color: #993399">2</span> errors  clojure<span style="color: #990000">.</span>core/ex-info <span style="color: #990000">(</span>core<span style="color: #990000">.</span>clj<span style="color: #990000">:</span><span style="color: #993399">4327</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>In this experiment, the faulty invocation of <span class="monospaced">hash-of?</span> is wrapped in
an anonymous function. At the time of this writing, <span class="monospaced">core.typed</span>
evaluates code before it type-checks it.</p></div>
<div class="paragraph"><p>Without this, the raw invocation <span class="monospaced">((hash-of? + number?))</span> would return
a regular Clojure <span class="monospaced">ArityException</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_169">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/clojure/core.typed"><span class="monospaced">core.typed</span> repository</a> on GitHub
</p>
</li>
<li>
<p>
The <a href="https://github.com/clojure/core.typed/wiki/User-Guide"><span class="monospaced">core.typed</span> user guide</a>, in particular its sections on polymorphism and function annotations
</p>
</li>
<li>
<p>
<a href="#sec_avoid_null">[sec_avoid_null]</a>, and <a href="#sec_verify_java">[sec_verify_java]</a>, for further
  examples of how to use <span class="monospaced">core.typed</span>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_index">Index</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_colophon">Colophon</h2>
<div class="sectionbody">
<div class="paragraph"><p>The animal on the cover of <em>Clojure Cookbook</em> is an aardwolf (<em>Proteles cristata</em>), a small mammal with two separate populations in the plains of Eastern and Southern Africa. Though its name means "earth wolf" in the Afrikaans language, it is part of the hyena family. The aardwolf generally doesn&#8217;t eat carrion like its larger cousins do&#8212;its diet mainly consists of insects (especially termites), which it catches with a long, sticky tongue.</p></div>
<div class="paragraph"><p>Aardwolves have thick yellow or brown fur with dark stripes, with bushy tails and long manes that run along their necks and backs. The mane is used to make the aardwolves appear bigger and intimidate predators, since they are neither fast runners nor especially good fighters. They do have strong jaws, but their teeth have evolved for eating insects rather than attacking larger animals. They average 22&#x2013;31 inches long, and weigh 15&#x2013;22 pounds.</p></div>
<div class="paragraph"><p>The aardwolf is nocturnal, and sleeps in underground burrows during the day. These animals are very territorial, and use scent glands to mark the area containing their dens (a mating pair may claim and rotate through multiple burrows, using only one or two at a time). The breeding season occurs in late June/early July, with a litter of 2&#x2013;5 cubs born 90 days later.</p></div>
<div class="paragraph"><p>Aardwolves are occasionally mistaken for hyenas and killed to protect livestock. However, many African farmers recognize the benefit of the animals in controlling the termite population and thus protecting crops. A single aardwolf can eat 200,000&#x2013;300,000 termites per night.</p></div>
<div class="paragraph"><p>The cover image is from Wood&#8217;s <em>Animate Creation</em>. The cover fonts are URW Typewriter and Guardian Sans. The text font is Adobe Minion Pro; the heading font is Adobe Myriad Condensed; and the code font is Dalton Maag&#8217;s Ubuntu Mono.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2016-06-25 23:12:21 PDT
</div>
</div>
</body>
</html>
